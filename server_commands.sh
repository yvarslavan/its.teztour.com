#!/bin/bash
# –≠–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
# –í—ã–ø–æ–ª–Ω—è—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ubuntu@10.7.74.252

echo "üö® –≠–ö–°–¢–†–ï–ù–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–ê–í –î–û–°–¢–£–ü–ê"
echo "======================================"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∞
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö –ø—Ä–∞–≤..."
ls -la /var/www/flask_helpdesk/ | head -10
echo "–í–ª–∞–¥–µ–ª–µ—Ü –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
stat -c '%U:%G' /var/www/flask_helpdesk 2>/dev/null || echo "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å
echo "üîÑ –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl stop flask-helpdesk 2>/dev/null || echo "–°–µ—Ä–≤–∏—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω"

# –ò–∑–º–µ–Ω–∏—Ç—å –≤–ª–∞–¥–µ–ª—å—Ü–∞ (–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
echo "üë§ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞..."
sudo chown -R $(whoami):$(whoami) /var/www/flask_helpdesk

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞
echo "üîê –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
sudo chmod -R 755 /var/www/flask_helpdesk

# –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Ñ–∞–π–ª—ã
echo "üßπ –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
sudo rm -rf /var/www/flask_helpdesk/flask_session/* 2>/dev/null || true
sudo rm -rf /var/www/flask_helpdesk/__pycache__ 2>/dev/null || true
sudo find /var/www/flask_helpdesk -name "*.pyc" -delete 2>/dev/null || true
sudo rm -rf /var/www/flask_helpdesk/venv 2>/dev/null || true

# –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø—É—Å—Ç—ã–µ —Å–ª—É–∂–µ–±–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
echo "üìÅ –ü–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
sudo mkdir -p /var/www/flask_helpdesk/flask_session
sudo mkdir -p /var/www/flask_helpdesk/logs

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–ª—è –≤—Å–µ—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
echo "üîê –§–∏–Ω–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤..."
sudo chown -R $(whoami):$(whoami) /var/www/flask_helpdesk
sudo chmod -R 755 /var/www/flask_helpdesk

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å –æ–±—Ä–∞—Ç–Ω–æ
echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl start flask-helpdesk

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞..."
ls -la /var/www/flask_helpdesk/ | head -5
echo "–í–ª–∞–¥–µ–ª–µ—Ü –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
stat -c '%U:%G' /var/www/flask_helpdesk

# –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏
echo "üìù –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏..."
if touch /var/www/flask_helpdesk/test_write 2>/dev/null; then
    rm /var/www/flask_helpdesk/test_write
    echo "‚úÖ –ó–∞–ø–∏—Å—å —Ä–∞–±–æ—Ç–∞–µ—Ç!"
else
    echo "‚ùå –ü—Ä–æ–±–ª–µ–º—ã —Å –∑–∞–ø–∏—Å—å—é –æ—Å—Ç–∞–ª–∏—Å—å"
fi

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl status flask-helpdesk --no-pager -l

echo "======================================"
echo "‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
echo "–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å GitLab CI/CD pipeline"
