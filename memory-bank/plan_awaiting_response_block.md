# План реализации блока "Ожидают ответа" для страницы "Мои заявки"

## Описание задачи
Добавить новый карточный блок в панель статусов дашборда страницы "Мои заявки" (/my-issues) для отображения заявок, требующих действия со стороны пользователя или согласующих лиц.

## Требования

### Функциональные требования
1. **Заголовок блока**: "Ожидают ответа"
2. **Статусы для включения** (из таблицы u_statuses):
   - ID 9: "Запрошено уточнение"
   - ID 15: "На согласовании"
   - ID 13: "Протестирована"
3. **Отображение**: Общее количество заявок в указанных статусах
4. **Поведение**: При клике раскрывается детализация по статусам (аналогично другим блокам)
5. **Фильтрация**: При клике на статус в детализации - фильтрация таблицы

### Технические требования
1. Использовать существующую структуру stat-card
2. Интегрироваться с текущей системой загрузки статистики
3. Поддерживать темную и светлую темы
4. Адаптивный дизайн для мобильных устройств

## Компоненты для изменения

### 1. Backend (Python/Flask)
**Файл**: `blog/main/routes.py` или соответствующий файл с роутами для заявок

**Изменения**:
- Добавить логику подсчета заявок со статусами 9, 13, 15
- Обновить API endpoint для статистики (добавить поле `awaiting_response`)
- Добавить детализацию по каждому из трех статусов

### 2. Frontend (HTML)
**Файл**: `blog/templates/issues.html`

**Изменения**:
- Добавить новый блок stat-card после блока "В работе" или "Закрытые"
- Структура аналогична существующим блокам
- ID элементов: `awaitingResponseIssues`, `awaitingResponseDetails`

### 3. Frontend (JavaScript)
**Файл**: `blog/templates/issues.html` (встроенный JS)

**Изменения**:
- Обновить функцию загрузки статистики для обработки нового поля
- Добавить анимацию для нового счетчика
- Добавить обработку клика для фильтрации по статусам 9, 13, 15

### 4. Стили (CSS)
**Файл**: Встроенные стили в `blog/templates/issues.html` или отдельный CSS файл

**Изменения**:
- Добавить класс для иконки нового блока (если нужен уникальный цвет)
- Убедиться в корректном отображении в обеих темах

## Детальный план задач

### Задача 1: Backend - Обновление API статистики
**Файлы**: `blog/main/routes.py` (или аналогичный)

**Подзадачи**:
1.1. Найти функцию/endpoint, возвращающий статистику заявок
1.2. Добавить SQL запрос для подсчета заявок со статусами 9, 13, 15:
```python
awaiting_response_count = db.execute(
    "SELECT COUNT(*) FROM issues WHERE status_id IN (9, 13, 15) AND user_id = ?"
).fetchone()[0]
```
1.3. Добавить детализацию по каждому статусу:
```python
awaiting_response_details = {
    'clarification_requested': count_by_status(9),  # Запрошено уточнение
    'on_approval': count_by_status(15),              # На согласовании
    'tested': count_by_status(13)                    # Протестирована
}
```
1.4. Обновить JSON ответ, добавив поля:
```python
{
    ...
    'awaiting_response': awaiting_response_count,
    'awaiting_response_details': awaiting_response_details
}
```

**Требования**: 
- Запрос должен учитывать только заявки текущего пользователя
- Использовать существующую логику подключения к БД

---

### Задача 2: Frontend HTML - Добавление блока в дашборд
**Файл**: `blog/templates/issues.html`

**Подзадачи**:
2.1. Найти секцию `<section class="stats-dashboard">` и `<div class="stats-grid">`
2.2. Добавить новый блок после блока "В работе" (progress):
```html
<div class="stat-card awaiting expandable" data-category="awaiting">
  <div class="stat-header">
    <div class="stat-icon">
      <i class="fas fa-hourglass-half"></i>
    </div>
    <div class="stat-content">
      <span class="stat-value" id="awaitingResponseIssues">-</span>
      <span class="stat-label">Ожидают ответа</span>
    </div>
    <div class="expand-arrow">
      <i class="fas fa-chevron-down"></i>
    </div>
  </div>
  <div class="stat-details" id="awaitingResponseDetails">
    <!-- Детализация заполняется JS -->
  </div>
</div>
```

**Требования**:
- Использовать класс `awaiting` для стилизации
- ID элементов должны быть уникальными
- Структура должна соответствовать существующим блокам

---

### Задача 3: Frontend JavaScript - Обработка данных статистики
**Файл**: `blog/templates/issues.html` (встроенный JavaScript)

**Подзадачи**:
3.1. Найти функцию, обрабатывающую статистику (где используется `stats.total`, `stats.open`)
3.2. Добавить обновление счетчика для нового блока:
```javascript
animateNumber($("#awaitingResponseIssues"), stats.awaiting_response || 0);
```
3.3. Добавить заполнение детализации:
```javascript
if (stats.awaiting_response_details) {
  const details = stats.awaiting_response_details;
  let detailsHtml = '<div class="status-breakdown">';
  
  if (details.clarification_requested > 0) {
    detailsHtml += `
      <div class="status-item" data-status-id="9">
        <span class="status-name">Запрошено уточнение</span>
        <span class="status-count">${details.clarification_requested}</span>
      </div>`;
  }
  
  if (details.on_approval > 0) {
    detailsHtml += `
      <div class="status-item" data-status-id="15">
        <span class="status-name">На согласовании</span>
        <span class="status-count">${details.on_approval}</span>
      </div>`;
  }
  
  if (details.tested > 0) {
    detailsHtml += `
      <div class="status-item" data-status-id="13">
        <span class="status-name">Протестирована</span>
        <span class="status-count">${details.tested}</span>
      </div>`;
  }
  
  detailsHtml += '</div>';
  $('#awaitingResponseDetails').html(detailsHtml);
}
```

**Требования**:
- Использовать существующую функцию `animateNumber`
- Структура детализации должна соответствовать другим блокам
- Обработать случай, когда данных нет (0 заявок)

---

### Задача 4: Frontend JavaScript - Обработка кликов и фильтрация
**Файл**: `blog/templates/issues.html` (встроенный JavaScript)

**Подзадачи**:
4.1. Найти обработчик кликов для существующих stat-item элементов
4.2. Убедиться, что обработчик работает с `data-status-id` атрибутом
4.3. Если нужно, добавить обработку для статусов 9, 13, 15:
```javascript
$(document).on('click', '.status-item[data-status-id]', function() {
  const statusId = $(this).data('status-id');
  // Фильтрация таблицы по statusId
  filterTableByStatus(statusId);
});
```

**Требования**:
- Использовать существующую логику фильтрации
- Поддерживать множественную фильтрацию (если реализовано)

---

### Задача 5: Стили CSS - Оформление нового блока
**Файл**: `blog/templates/issues.html` (встроенные стили) или отдельный CSS файл

**Подзадачи**:
5.1. Добавить стили для класса `.stat-card.awaiting`:
```css
.stat-card.awaiting .stat-icon {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
  color: white;
}

.stat-card.awaiting .stat-value {
  color: #f59e0b;
}

/* Темная тема */
body.dark-theme .stat-card.awaiting .stat-icon {
  background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
}

body.dark-theme .stat-card.awaiting .stat-value {
  color: #fbbf24;
}
```

**Требования**:
- Цветовая схема должна отличаться от других блоков
- Поддержка светлой и темной темы
- Адаптивность для мобильных устройств

---

### Задача 6: Тестирование
**Подзадачи**:
6.1. Создать тестовые данные с заявками в статусах 9, 13, 15
6.2. Проверить корректность подсчета в новом блоке
6.3. Проверить раскрытие детализации при клике
6.4. Проверить фильтрацию таблицы при клике на статус
6.5. Проверить отображение в светлой и темной теме
6.6. Проверить адаптивность на мобильных устройствах
6.7. Проверить работу при отсутствии заявок (0 заявок)

**Требования**:
- Все функции должны работать аналогично существующим блокам
- Нет ошибок в консоли браузера

---

## Порядок выполнения

1. **Backend** (Задача 1) - Обновление API
2. **Frontend HTML** (Задача 2) - Добавление блока
3. **Frontend JS - Статистика** (Задача 3) - Обработка данных
4. **Frontend JS - Фильтрация** (Задача 4) - Обработка кликов
5. **Стили** (Задача 5) - Оформление
6. **Тестирование** (Задача 6) - Проверка функциональности

## Файлы для изменения

1. `blog/main/routes.py` (или аналогичный) - Backend API
2. `blog/templates/issues.html` - HTML структура, JavaScript, CSS
3. Возможно отдельный CSS файл, если стили вынесены

## Зависимости

- Доступ к таблице `u_statuses` в БД
- Существующая функция загрузки статистики
- Существующая система фильтрации таблицы
- Функция `animateNumber` для анимации счетчиков

## Ожидаемый результат

После реализации на странице "Мои заявки" появится новый блок "Ожидают ответа", который:
- Отображает общее количество заявок со статусами 9, 13, 15
- При клике раскрывает детализацию по каждому статусу
- При клике на статус в детализации фильтрует таблицу
- Корректно отображается в обеих темах
- Адаптивен для мобильных устройств

## Справочная информация

### Статусы заявок (u_statuses)
```
1  — Новая
2  — В работе
5  — Закрыта
6  — Отклонена
7  — Выполнена
9  — Запрошено уточнение ✓ (включить)
10 — Приостановлена
13 — Протестирована ✓ (включить)
14 — Перенаправлена
15 — На согласовании ✓ (включить)
16 — Заморожена
17 — Открыта
18 — На тестировании
19 — В очереди
```

### Цветовая схема (рекомендация)
- **Иконка**: Оранжевый градиент (#f59e0b → #d97706)
- **Счетчик**: Оранжевый (#f59e0b)
- **Иконка FontAwesome**: `fa-hourglass-half` (песочные часы)
