# üö® –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º —Å –¥–µ–ø–ª–æ–µ–º

## üìã –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–π –æ—à–∏–±–∫–∏

### –ü—Ä–æ–±–ª–µ–º–∞
```
‚ùå Port 22 is not accessible
üîç Testing server connectivity...
Server host: vpn-130.msk.tez-tour.com
SSH port: 22
‚ö†Ô∏è Server doesn't respond to ping (may be blocked by firewall)
```

### üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã

1. **–°–µ—Ä–≤–µ—Ä –∑–∞ VPN** - Hostname —Å–æ–¥–µ—Ä–∂–∏—Ç `vpn-130`, —á—Ç–æ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é —Å–µ—Ç—å
2. **–ù–µ—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π SSH –ø–æ—Ä—Ç** - –í–æ–∑–º–æ–∂–Ω–æ SSH —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ –Ω–∞ –ø–æ—Ä—Ç—É 22
3. **Firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç GitHub Actions** - –í–Ω–µ—à–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã
4. **SSH —Å–ª—É–∂–±–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞** - –°–µ—Ä–≤–∏—Å –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

## üõ†Ô∏è –ú–µ—Ç–æ–¥—ã —Ä–µ—à–µ–Ω–∏—è

### 1Ô∏è‚É£ **–ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –ø–æ—Ä—Ç–∞ (–ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ)**

#### –ü—Ä–æ–≤–µ—Ä—å—Ç–µ GitHub Secrets:
```bash
# –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è -> Settings -> Secrets and variables -> Actions
SSH_HOST=vpn-130.msk.tez-tour.com
SSH_PORT=22  # ‚Üê –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å
SSH_USER=–≤–∞—à_–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
SSH_PRIVATE_KEY=–≤–∞—à_–ø—Ä–∏–≤–∞—Ç–Ω—ã–π_–∫–ª—é—á
```

#### –†–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω—ã–µ SSH –ø–æ—Ä—Ç—ã:
- `22` (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π)
- `2222` (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π)
- `2022`, `22022`, `22222`
- `2020`, `2021`, `2023`

### 2Ô∏è‚É£ **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**

#### –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π workflow:
1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Actions** ‚Üí **SSH Connection Test**
2. –ù–∞–∂–º–∏—Ç–µ **Run workflow**
3. –í–∫–ª—é—á–∏—Ç–µ –æ–ø—Ü–∏—é **"Test all common SSH ports"**
4. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### 3Ô∏è‚É£ **–†–µ—à–µ–Ω–∏—è –¥–ª—è VPN-—Å–µ—Ä–≤–µ—Ä–∞**

#### –ê) GitHub Self-Hosted Runner (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
```yaml
# .github/workflows/deploy.yml
jobs:
  deploy:
    runs-on: self-hosted  # –í–º–µ—Å—Ç–æ ubuntu-latest
    # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```

**–£—Å—Ç–∞–Ω–æ–≤–∫–∞ runner –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏:**
1. Settings ‚Üí Actions ‚Üí Runners ‚Üí New self-hosted runner
2. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
3. Runner –±—É–¥–µ—Ç –∏–º–µ—Ç—å –¥–æ—Å—Ç—É–ø –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–µ—Ç–∏

#### –ë) VPN-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ workflow
```yaml
- name: Connect to VPN
  uses: "kota65535/github-openvpn-connect-action@v2"
  with:
    config_file: ${{ secrets.OPENVPN_CONFIG }}
    username: ${{ secrets.OPENVPN_USERNAME }}
    password: ${{ secrets.OPENVPN_PASSWORD }}
```

#### –í) SSH —á–µ—Ä–µ–∑ Bastion Host
```yaml
- name: Deploy via bastion
  run: |
    ssh -o StrictHostKeyChecking=no \
        -o ProxyCommand="ssh -W %h:%p bastion-host" \
        user@internal-server 'deployment-script.sh'
```

### 4Ô∏è‚É£ **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Firewall**

#### –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (Ubuntu/Debian):
```bash
# –†–∞–∑—Ä–µ—à–∏—Ç—å SSH —Å GitHub Actions IP ranges
sudo ufw allow from 140.82.112.0/20 to any port 22
sudo ufw allow from 143.55.64.0/20 to any port 22
sudo ufw allow from 185.199.108.0/22 to any port 22
sudo ufw allow from 192.30.252.0/22 to any port 22

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å SSH
sudo systemctl status ssh
sudo systemctl restart ssh
```

#### –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:
```bash
# /etc/ssh/sshd_config
Port 22                    # ‚Üê –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –ø–æ—Ä—Ç–∞
PermitRootLogin no         # –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
PasswordAuthentication no  # –¢–æ–ª—å–∫–æ –∫–ª—é—á–∏
PubkeyAuthentication yes
```

### 5Ô∏è‚É£ **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–µ–ø–ª–æ—è**

#### –ê) Webhook-based –¥–µ–ø–ª–æ–π
```python
# webhook_deploy.py –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
from flask import Flask, request
import subprocess
import hmac
import hashlib

app = Flask(__name__)

@app.route('/deploy', methods=['POST'])
def deploy():
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ GitHub webhook signature
    signature = request.headers.get('X-Hub-Signature-256')
    if verify_signature(request.data, signature):
        subprocess.run(['./deploy.sh'])
        return 'Deployed successfully'
    return 'Unauthorized', 403
```

#### –ë) Pull-based –¥–µ–ø–ª–æ–π (cron)
```bash
# –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ: crontab -e
*/5 * * * * cd /var/www/flask_helpdesk && git pull origin main && ./auto-deploy.sh
```

## üîß –ù–µ–º–µ–¥–ª–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ SSH –ø–æ—Ä—Ç
```bash
# –° –≤–∞—à–µ–≥–æ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–º–ø—å—é—Ç–µ—Ä–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ç–∏):
ssh -p 22 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å@vpn-130.msk.tez-tour.com
ssh -p 2222 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å@vpn-130.msk.tez-tour.com  # –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Ä–∞–∑–Ω—ã–µ –ø–æ—Ä—Ç—ã
```

### 2. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Å–∏—Å—Ç–µ–º–Ω–æ–º—É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
**–í–æ–ø—Ä–æ—Å—ã –¥–ª—è –∞–¥–º–∏–Ω–∞:**
- –ù–∞ –∫–∞–∫–æ–º –ø–æ—Ä—Ç—É —Ä–∞–±–æ—Ç–∞–µ—Ç SSH?
- –ú–æ–∂–Ω–æ –ª–∏ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –¥–æ—Å—Ç—É–ø —Å GitHub Actions IP?
- –ï—Å—Ç—å –ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å self-hosted runner?
- –ö–∞–∫–∞—è —Å–µ—Ç–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è?

### 3. –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
–ü–æ–∫–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∞–≤—Ç–æ–¥–µ–ø–ª–æ–π, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π:
```bash
# –õ–æ–∫–∞–ª—å–Ω–æ –ø–æ—Å–ª–µ push –≤ main:
ssh –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å@—Å–µ—Ä–≤–µ—Ä "cd /var/www/flask_helpdesk && git pull && systemctl restart app"
```

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è —Ä–µ—à–µ–Ω–∏—è

1. **IT –æ—Ç–¥–µ–ª** - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–µ—Ç–∏ –∏ firewall
2. **DevOps** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ CI/CD –∏ runner'–æ–≤
3. **–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä** - SSH –∏ —Å–µ—Ä–≤–∏—Å—ã

## üéØ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ —Ä–µ—à–µ–Ω–∏–µ

**–î–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–π —Å—Ä–µ–¥—ã –ª—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç:**
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å **GitHub Self-Hosted Runner** –Ω–∞ —Å–µ—Ä–≤–µ—Ä –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –µ–≥–æ –∫–∞–∫ —Å–µ—Ä–≤–∏—Å
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –¥–ª—è –¥–µ–ø–ª–æ—è

–≠—Ç–æ —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å VPN, firewall –∏ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.

# –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è Flask Helpdesk

## –û–±–∑–æ—Ä –ø—Ä–æ–±–ª–µ–º

–ü—Ä–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–∏ —á–µ—Ä–µ–∑ GitLab CI/CD –≤–æ–∑–Ω–∏–∫–∞—é—Ç —Å–ª–µ–¥—É—é—â–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞** - —Ñ–∞–π–ª—ã flask_session –∏ __pycache__ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç www-data
2. **–ü—Ä–æ–±–ª–µ–º—ã —Å sudo** - CI/CD –Ω–µ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—ã sudo –±–µ–∑ –ø–∞—Ä–æ–ª—è
3. **–ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏—Å–∫–∞** - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –±—ç–∫–∞–ø—ã –∑–∞–Ω–∏–º–∞—é—Ç –≤—Å–µ –º–µ—Å—Ç–æ
4. **SSH –∫–ª—é—á–∏ –≤ after_script** - –∫–ª—é—á–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Å–µ–∫—Ü–∏–∏ after_script

## –†–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º

### 1. –ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞

#### –ü—Ä–æ–±–ª–µ–º–∞
```
cp: cannot open 'flask_helpdesk/flask_session/xxx' for reading: Permission denied
rm: cannot remove '/var/www/flask_helpdesk/flask_session/xxx': Permission denied
```

#### –ü—Ä–∏—á–∏–Ω–∞
–§–∞–π–ª—ã —Å–µ—Å—Å–∏–π —Å–æ–∑–¥–∞—é—Ç—Å—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–æ–º (www-data), –∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è yvarslavan.

#### –†–µ—à–µ–Ω–∏—è

**A. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–µ—à–µ–Ω–∏–µ –≤ CI/CD:**
```yaml
# –í .gitlab-ci.yml –¥–æ–±–∞–≤–ª–µ–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
- echo "Safely cleaning up old deployment files..."
- ssh $DEPLOY_USER@$DEPLOY_HOST "find /var/www/flask_helpdesk/flask_session -type f -delete 2>/dev/null || echo 'Some flask_session files could not be removed'"
```

**B. –†—É—á–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
```bash
# –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –æ—á–∏—Å—Ç–∫–∏
cd /var/www/flask_helpdesk
python3 scripts/server_cleanup.py sessions

# –ò–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (—Ç—Ä–µ–±—É–µ—Ç sudo)
sudo chown -R yvarslavan:yvarslavan /var/www/flask_helpdesk/flask_session
sudo chmod -R u+w /var/www/flask_helpdesk/flask_session
```

### 2. –ü—Ä–æ–±–ª–µ–º—ã —Å sudo

#### –ü—Ä–æ–±–ª–µ–º–∞
```
sudo: a terminal is required to read the password; either use the -S option to read from standard input or configure an askpass helper
```

#### –ü—Ä–∏—á–∏–Ω–∞
CI/CD –ø—ã—Ç–∞–µ—Ç—Å—è –≤—ã–ø–æ–ª–Ω–∏—Ç—å sudo –∫–æ–º–∞–Ω–¥—ã, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å.

#### –†–µ—à–µ–Ω–∏–µ
–£–±—Ä–∞–Ω—ã –≤—Å–µ sudo –∫–æ–º–∞–Ω–¥—ã –∏–∑ CI/CD. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ:
- –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –±–µ–∑ sudo (—Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫)
- –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è sudo –∫–æ–º–∞–Ω–¥ –ø–æ—Å–ª–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è

```yaml
# –í–º–µ—Å—Ç–æ sudo rm -rf –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
- ssh $DEPLOY_USER@$DEPLOY_HOST "rm -rf /tmp/flask* || true"

# –ò –≤—ã–≤–æ–¥—è—Ç—Å—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- echo "‚ö†Ô∏è  MANUAL ACTION REQUIRED:"
- echo "   sudo systemctl restart flask-helpdesk"
- echo "   sudo chown -R www-data:www-data /var/www/flask_helpdesk/flask_session"
```

### 3. –ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ –¥–∏—Å–∫–∞

#### –ü—Ä–æ–±–ª–µ–º–∞
–î–∏—Å–∫ 25GB –∑–∞–ø–æ–ª–Ω–µ–Ω –Ω–∞ 100% –∏–∑-–∑–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –±—ç–∫–∞–ø–æ–≤.

#### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
```bash
df -h                                    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ
du -sh /var/www/flask_helpdesk_backup_*  # –†–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–æ–≤
```

#### –†–µ—à–µ–Ω–∏–µ
```bash
# –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤
sudo rm -rf /var/www/flask_helpdesk_backup_*

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –æ—á–∏—Å—Ç–∫–∏
cd /var/www/flask_helpdesk
python3 scripts/server_cleanup.py disk
```

### 4. SSH –∫–ª—é—á–∏ –≤ after_script

#### –ü—Ä–æ–±–ª–µ–º–∞
```
Permission denied (publickey,password)
```

#### –ü—Ä–∏—á–∏–Ω–∞
SSH –∫–ª—é—á–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Å–µ–∫—Ü–∏–∏ after_script.

#### –†–µ—à–µ–Ω–∏–µ
–î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è SSH –≤ after_script:

```yaml
after_script:
  - echo "Running after_script cleanup..."
  - eval $(ssh-agent -s) || true
  - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - || true
  - |
    if [ "$CI_JOB_STATUS" == "failed" ]; then
      # ... rollback logic
    fi
```

## –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º

### 1. –°–∫—Ä–∏–ø—Ç –æ—á–∏—Å—Ç–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞

–°–æ–∑–¥–∞–Ω `scripts/server_cleanup.py` –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞:

```bash
# –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
python3 scripts/server_cleanup.py

# –û—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
python3 scripts/server_cleanup.py check      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
python3 scripts/server_cleanup.py sessions  # –û—á–∏—Å—Ç–∫–∞ flask_session
python3 scripts/server_cleanup.py cache     # –û—á–∏—Å—Ç–∫–∞ __pycache__
python3 scripts/server_cleanup.py disk      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å–∫–∞
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π CI/CD pipeline

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π `.gitlab-ci.yml`:
- –£–±—Ä–∞–Ω—ã –∫–æ–º–∞–Ω–¥—ã sudo
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω after_script —Å SSH –∫–ª—é—á–∞–º–∏
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–∏—Å–∫–∞

## –ü–æ—à–∞–≥–æ–≤–æ–µ —Ä–µ—à–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –ø—Ä–æ–±–ª–µ–º

### –®–∞–≥ 1: –û—á–∏—Å—Ç–∫–∞ –¥–∏—Å–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh yvarslavan@10.7.74.252

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Å—Ç–∞
df -h

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (–í–ù–ò–ú–ê–ù–ò–ï: —ç—Ç–æ —É–¥–∞–ª–∏—Ç –≤—Å–µ –±—ç–∫–∞–ø—ã!)
sudo rm -rf /var/www/flask_helpdesk_backup_*

# –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
rm -rf /tmp/flask*

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
df -h
```

### –®–∞–≥ 2: –û—á–∏—Å—Ç–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
```bash
# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
cd /var/www/flask_helpdesk

# –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –æ—á–∏—Å—Ç–∫–∏
python3 scripts/server_cleanup.py

# –ò–ª–∏ —Ä—É—á–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
sudo rm -rf flask_session/*
sudo rm -rf __pycache__/
find . -name "*.pyc" -delete
```

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
```bash
# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
mkdir -p flask_session logs
chmod 755 flask_session logs

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞
sudo chown -R www-data:www-data flask_session logs
```

### –®–∞–≥ 4: –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—É—Å–∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
–ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –¥–∏—Å–∫–∞ –º–æ–∂–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ GitLab CI/CD.

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### 1. –†–µ–≥—É–ª—è—Ä–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞
```bash
# –î–æ–±–∞–≤–∏—Ç—å –≤ cron –¥–ª—è –µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏
0 2 * * 0 cd /var/www/flask_helpdesk && python3 scripts/server_cleanup.py
```

### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–∏—Å–∫–∞
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–µ—Å—Ç–∞ –Ω–∞ –¥–∏—Å–∫–µ
df -h | grep -E "(Filesystem|/dev/mapper)"

# –ü–æ–∏—Å–∫ –±–æ–ª—å—à–∏—Ö —Ñ–∞–π–ª–æ–≤
du -sh /var/www/* | sort -hr | head -10
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
journalctl -u flask-helpdesk -f

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
tail -f /var/www/flask_helpdesk/logs/app.log
```

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø–µ—Ä–µ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º

- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å >2GB)
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è –≤ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ flask_session
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è –≤ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ SSH –∫–ª—é—á–µ–π
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å systemd —Å–µ—Ä–≤–∏—Å–∞

## –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ

–ï—Å–ª–∏ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–ª–æ–º–∞–ª–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–∏—Å
sudo systemctl stop flask-helpdesk

# 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –±—ç–∫–∞–ø–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
cd /var/www
sudo mv flask_helpdesk flask_helpdesk_broken
sudo mv flask_helpdesk_backup flask_helpdesk

# 3. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å
sudo systemctl start flask-helpdesk

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
sudo systemctl status flask-helpdesk
```

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ GitLab CI/CD
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞: `journalctl -u flask-helpdesk -f`
3. –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É: `python3 scripts/server_cleanup.py check`
4. –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
