<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç API –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #0056b3; }
        .result { margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; white-space: pre-wrap; }
        input, select { padding: 8px; margin: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .error { background: #f8d7da; color: #721c24; }
        .success { background: #d4edda; color: #155724; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ –¢–µ—Å—Ç API –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á</h1>

        <!-- –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤ -->
        <div class="section">
            <h3>1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤</h3>
            <p>–í–≤–µ–¥–∏—Ç–µ ID –∑–∞–¥–∞—á–∏ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤:</p>
            <input type="number" id="taskIdForStatuses" placeholder="ID –∑–∞–¥–∞—á–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 258367)" value="258367">
            <button onclick="getTaskStatuses()">–ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã</button>
            <div id="statusesResult" class="result"></div>
        </div>

        <!-- –¢–µ—Å—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ -->
        <div class="section">
            <h3>2. –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏</h3>
            <p>–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:</p>
            <input type="number" id="taskIdForUpdate" placeholder="ID –∑–∞–¥–∞—á–∏" value="258367">
            <select id="newStatusId">
                <option value="">–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç–∞—Ç—É—Å—ã –≤—ã—à–µ</option>
            </select>
            <textarea id="statusComment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" rows="3" style="width: 100%; margin-top: 10px;"></textarea>
            <br>
            <button onclick="updateTaskStatus()">–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
            <div id="updateResult" class="result"></div>
        </div>

        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ -->
        <div class="section">
            <h3>3. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏</h3>
            <button onclick="checkAuth()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é</button>
            <div id="authResult" class="result"></div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
        async function getTaskStatuses() {
            const taskId = document.getElementById('taskIdForStatuses').value;
            const resultDiv = document.getElementById('statusesResult');

            if (!taskId) {
                resultDiv.textContent = '–í–≤–µ–¥–∏—Ç–µ ID –∑–∞–¥–∞—á–∏';
                resultDiv.className = 'result error';
                return;
            }

            try {
                resultDiv.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
                resultDiv.className = 'result';

                const response = await fetch(`/tasks/api/task/${taskId}/statuses`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = JSON.stringify(data, null, 2);

                    // –ó–∞–ø–æ–ª–Ω—è–µ–º select –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
                    const select = document.getElementById('newStatusId');
                    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å</option>';

                    data.available_statuses.forEach(status => {
                        const option = document.createElement('option');
                        option.value = status.id;
                        option.textContent = `${status.name} (ID: ${status.id})`;
                        select.appendChild(option);
                    });

                    // –ó–∞–ø–æ–ª–Ω—è–µ–º ID –∑–∞–¥–∞—á–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                    document.getElementById('taskIdForUpdate').value = taskId;

                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `–û—à–∏–±–∫–∞: ${data.error}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
        async function updateTaskStatus() {
            const taskId = document.getElementById('taskIdForUpdate').value;
            const newStatusId = document.getElementById('newStatusId').value;
            const comment = document.getElementById('statusComment').value;
            const resultDiv = document.getElementById('updateResult');

            if (!taskId || !newStatusId) {
                resultDiv.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ ID –∑–∞–¥–∞—á–∏ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å';
                resultDiv.className = 'result error';
                return;
            }

            // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
            if (!confirm(`–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏ ${taskId} –Ω–∞ —Å—Ç–∞—Ç—É—Å ${newStatusId}?`)) {
                return;
            }

            try {
                resultDiv.textContent = '–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞...';
                resultDiv.className = 'result';

                const response = await fetch(`/tasks/api/task/${taskId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        status_id: parseInt(newStatusId),
                        comment: comment.trim()
                    })
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = JSON.stringify(data, null, 2);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `–û—à–∏–±–∫–∞: ${data.error}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function checkAuth() {
            const resultDiv = document.getElementById('authResult');

            try {
                resultDiv.textContent = '–ü—Ä–æ–≤–µ—Ä–∫–∞...';
                resultDiv.className = 'result';

                // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å—ã –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –∑–∞–¥–∞—á–∏, —á—Ç–æ–±—ã –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
                const response = await fetch('/tasks/api/task/1/statuses', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                const text = await response.text();

                if (response.status === 403) {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ API (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∏–ª–∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º Redmine)';
                } else if (response.status === 200 || response.status === 500) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è OK. API –¥–æ—Å—Ç—É–ø–µ–Ω.';
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `HTTP ${response.status}: ${text}`;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${error.message}`;
            }
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            checkAuth();
        };
    </script>
</body>
</html>
