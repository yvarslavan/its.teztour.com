#!/bin/bash

# =======================================================
# –°–ö–†–ò–ü–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–†–ê–í –î–û–°–¢–£–ü–ê –î–õ–Ø FLASK HELPDESK
# –í–µ—Ä—Å–∏—è: 2.0 - –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è deploy
# –î–∞—Ç–∞: 2024-12-27
# =======================================================

set -e

echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –¥–ª—è Flask Helpdesk (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å deploy)"
echo "=================================================================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ sudo
if [[ $EUID -eq 0 ]]; then
    echo "‚úÖ –°–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
else
    echo "‚ùå –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω —Å sudo"
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: sudo bash fix_permissions.sh"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è deploy
if ! id "deploy" &>/dev/null; then
    echo "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 'deploy' –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!"
    echo "–°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–æ–º–∞–Ω–¥–æ–π: sudo adduser deploy"
    exit 1
else
    echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 'deploy' –Ω–∞–π–¥–µ–Ω"
fi

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
DEPLOY_USER="deploy"
WEB_GROUP="www-data"
APP_PATH="/var/www/flask_helpdesk"
BACKUP_PATH="/var/backups/flask_helpdesk"
LOG_PATH="/var/log/flask_helpdesk"

echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."

# –°–æ–∑–¥–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
mkdir -p "$APP_PATH"
mkdir -p "$BACKUP_PATH"
mkdir -p "$LOG_PATH"

echo "‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã"

echo "üë§ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≥—Ä—É–ø–ø..."

# –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è deploy –≤ –≥—Ä—É–ø–ø—É www-data
usermod -a -G "$WEB_GROUP" "$DEPLOY_USER"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
echo "üìã –ì—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $DEPLOY_USER:"
groups "$DEPLOY_USER"

echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∏ –ø—Ä–∞–≤–∞ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
chown -R "$DEPLOY_USER:$WEB_GROUP" "$APP_PATH"
chmod -R 755 "$APP_PATH"
chmod -R g+w "$APP_PATH"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±—ç–∫–∞–ø–æ–≤
chown -R "$DEPLOY_USER:$WEB_GROUP" "$BACKUP_PATH"
chmod -R 755 "$BACKUP_PATH"
chmod -R g+w "$BACKUP_PATH"

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–ª—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤
chown -R "$DEPLOY_USER:$WEB_GROUP" "$LOG_PATH"
chmod -R 755 "$LOG_PATH"
chmod -R g+w "$LOG_PATH"

echo "üîí –ù–∞—Å—Ç—Ä–æ–π–∫–∞ ACL (—Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã—Ö –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞)..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É ACL
if command -v setfacl &> /dev/null; then
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º ACL –¥–ª—è –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
    setfacl -R -m u:"$DEPLOY_USER":rwx "$APP_PATH"
    setfacl -R -m g:"$WEB_GROUP":rwx "$APP_PATH"
    setfacl -R -d -m u:"$DEPLOY_USER":rwx "$APP_PATH"
    setfacl -R -d -m g:"$WEB_GROUP":rwx "$APP_PATH"

    setfacl -R -m u:"$DEPLOY_USER":rwx "$BACKUP_PATH"
    setfacl -R -m g:"$WEB_GROUP":rwx "$BACKUP_PATH"

    setfacl -R -m u:"$DEPLOY_USER":rwx "$LOG_PATH"
    setfacl -R -m g:"$WEB_GROUP":rwx "$LOG_PATH"

    echo "‚úÖ ACL –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
else
    echo "‚ö†Ô∏è ACL –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –ø—Ä–∞–≤–∞"
fi

echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."

# –¢–µ—Å—Ç–∏—Ä—É–µ–º –∑–∞–ø–∏—Å—å –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è deploy
TEST_FILE="$APP_PATH/test_deploy_access.tmp"

# –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª –æ—Ç –∏–º–µ–Ω–∏ deploy
if sudo -u "$DEPLOY_USER" touch "$TEST_FILE" 2>/dev/null; then
    echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $DEPLOY_USER –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ñ–∞–π–ª—ã –≤ $APP_PATH"
    # –£–¥–∞–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª
    rm -f "$TEST_FILE"
else
    echo "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å $DEPLOY_USER –ù–ï –º–æ–∂–µ—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ñ–∞–π–ª—ã –≤ $APP_PATH"
    echo "üîß –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."

    # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤
    chmod 775 "$APP_PATH"
    chown "$DEPLOY_USER:$WEB_GROUP" "$APP_PATH"

    # –ü–æ–≤—Ç–æ—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    if sudo -u "$DEPLOY_USER" touch "$TEST_FILE" 2>/dev/null; then
        echo "‚úÖ –ü—Ä–∞–≤–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
        rm -f "$TEST_FILE"
    else
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏"
        echo "–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞"
        exit 1
    fi
fi

echo "üìä –ò—Ç–æ–≥–æ–≤—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞:"
echo "========================="
ls -la "$APP_PATH" | head -5
echo ""
ls -ld "$APP_PATH" "$BACKUP_PATH" "$LOG_PATH"

echo ""
echo "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üìã –†–µ–∑—É–ª—å—Ç–∞—Ç:"
echo "  ‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $DEPLOY_USER"
echo "  ‚Ä¢ –ì—Ä—É–ø–ø–∞: $WEB_GROUP"
echo "  ‚Ä¢ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: $APP_PATH"
echo "  ‚Ä¢ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±—ç–∫–∞–ø–æ–≤: $BACKUP_PATH"
echo "  ‚Ä¢ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ª–æ–≥–æ–≤: $LOG_PATH"
echo "  ‚Ä¢ –ü—Ä–∞–≤–∞: 755 (rwxr-xr-x) —Å –≥—Ä—É–ø–ø–æ–≤–æ–π –∑–∞–ø–∏—Å—å—é"
echo ""
echo "üöÄ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∑–∞–ø—É—Å–∫–∞—Ç—å GitLab CI/CD pipeline!"
