# Решение проблемы с подключением к базе данных

## Описание проблемы

В логах сервера наблюдались постоянные ошибки подключения к базе данных `quality.teztour.com`:

```
2025-04-18 09:55:20,208 - blog.main.routes - ERROR - Ошибка при получении уведомлений: (mysql.connector.errors.DatabaseError) 2005 (HY000): Unknown MySQL server host 'quality.teztour.com' (11004)
2025-04-18 09:56:07,434 - blog.main.routes - ERROR - Ошибка при получении уведомлений: (mysql.connector.errors.DatabaseError) 2003 (HY000): Can't connect to MySQL server on 'quality.teztour.com:3306' (10061)
```

Основные типы ошибок:
- **2005 (HY000)**: Unknown MySQL server host - DNS не может разрешить имя хоста
- **2003 (HY000)**: Can't connect to MySQL server - сервер недоступен или отклоняет соединения
- **OperationalError**: MySQL Connection not available - пул соединений исчерпан

## Реализованное решение

### 1. Улучшенный менеджер подключений (`mysql_db.py`)

Создан класс `DatabaseConnectionManager` с функциональностью:

- **Повторные попытки**: До 3 попыток подключения с экспоненциальной задержкой
- **Логирование**: Детальное логирование всех попыток и ошибок
- **Статистика**: Отслеживание количества ошибок по операциям
- **Graceful degradation**: Возврат `None` вместо исключений

```python
class DatabaseConnectionManager:
    def __init__(self, max_retries=3, retry_delay=1.0, backoff_factor=2.0):
        self.max_retries = max_retries
        self.retry_delay = retry_delay
        self.backoff_factor = backoff_factor
        self._connection_errors = {}
```

### 2. Улучшенная конфигурация пула соединений

Добавлены параметры для повышения надежности:

```python
engine = create_engine(
    DATABASE_URL,
    pool_size=10,
    max_overflow=20,
    pool_pre_ping=True,      # Проверка соединений перед использованием
    pool_recycle=3600,       # Переподключение каждый час
    connect_args={
        'connect_timeout': 10,
        'autocommit': True
    }
)
```

### 3. Безопасные функции выполнения запросов

Созданы функции-обертки для безопасного выполнения запросов:

```python
def execute_quality_query_safe(query_func, operation_name="quality query"):
    return db_manager.execute_with_retry(
        query_func,
        QualitySession,
        operation_name
    )
```

### 4. Обновленные маршруты

Все критические маршруты обновлены для использования новой системы:

- `/comment-notifications` - получение уведомлений о комментариях
- `/get-new-issues-list` - получение списка новых обращений
- `/get-new-issues-count` - получение количества новых обращений
- `/get-total-issues-count` - получение общего количества обращений

### 5. Система мониторинга соединений

Создан модуль `blog/utils/connection_monitor.py` с функциональностью:

- **Проверка состояния**: Регулярная проверка доступности баз данных
- **Отчеты о здоровье**: Детальная информация о состоянии соединений
- **Время безотказной работы**: Отслеживание uptime для каждой базы

### 6. Административная панель

Создана страница `/admin/db-status` для мониторинга состояния баз данных:

- Визуальные индикаторы состояния
- Статистика ошибок
- Кнопки для тестирования соединений
- Автообновление статуса

## Преимущества решения

### 1. Устойчивость к сбоям
- Автоматические повторные попытки при временных сбоях
- Graceful degradation - приложение продолжает работать даже при проблемах с БД
- Возврат пустых результатов вместо ошибок 500

### 2. Улучшенное логирование
- Детальная информация о каждой попытке подключения
- Статистика ошибок по операциям
- Предупреждения вместо критических ошибок

### 3. Мониторинг и диагностика
- Реальное время мониторинга состояния БД
- Административная панель для диагностики
- API для проверки состояния соединений

### 4. Производительность
- Оптимизированные настройки пула соединений
- Предварительная проверка соединений (pool_pre_ping)
- Автоматическое переподключение

## Использование

### Тестирование системы

Запустите тестовый скрипт:

```bash
python test_db_connection.py
```

### Мониторинг в реальном времени

1. Откройте административную панель: `/admin/db-status`
2. Используйте API для проверки: `/check-connection`

### Логирование

Все операции логируются с уровнем WARNING/ERROR:

```python
logger.warning(f"Попытка {attempt + 1}/{max_retries + 1} для {operation_name} неудачна")
logger.error(f"Все попытки исчерпаны. Последняя ошибка: {str(e)}")
```

## Конфигурация

### Настройка повторных попыток

```python
# В mysql_db.py
db_manager = DatabaseConnectionManager(
    max_retries=3,        # Количество повторных попыток
    retry_delay=1.0,      # Начальная задержка в секундах
    backoff_factor=2.0    # Множитель для увеличения задержки
)
```

### Настройка пула соединений

```python
# Размер пула соединений
pool_size=10,
max_overflow=20,

# Таймауты
connect_args={
    'connect_timeout': 10,
    'autocommit': True
}
```

## Мониторинг и алерты

### Ключевые метрики для мониторинга

1. **Общее количество ошибок**: `db_manager.get_connection_status()['total_errors']`
2. **Статус соединений**: `check_database_connections()`
3. **Время последнего успешного подключения**: В отчете здоровья
4. **Частота ошибок по операциям**: В детальной статистике

### Рекомендуемые алерты

- Более 10 ошибок подключения за 5 минут
- Отсутствие успешных подключений более 10 минут
- Статус базы данных "failed" более 5 минут

## Дальнейшие улучшения

1. **Circuit Breaker Pattern**: Временное отключение проблемных соединений
2. **Метрики Prometheus**: Экспорт метрик для внешнего мониторинга
3. **Автоматическое восстановление**: Перезапуск пула соединений при критических ошибках
4. **Кэширование**: Кэширование результатов запросов при недоступности БД
5. **Уведомления**: Email/Slack уведомления при критических проблемах

## Заключение

Реализованное решение значительно повышает устойчивость приложения к проблемам с подключением к базе данных. Система автоматически обрабатывает временные сбои, предоставляет детальную диагностику и позволяет приложению продолжать работу даже при проблемах с БД.

Ключевые результаты:
- ✅ Устранены критические ошибки 500 при недоступности БД
- ✅ Добавлено автоматическое восстановление соединений
- ✅ Реализован мониторинг состояния в реальном времени
- ✅ Улучшено логирование и диагностика проблем
