<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Контакт-центр Москва - Tez Tour</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/finesse.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(to right, #00b09b, #96c93d);
            color: white;
            padding: 15px 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Новый стиль для группы логотипа и заголовка */
        .header-main-content {
            display: flex;
            align-items: center;
            flex-shrink: 1; /* Разрешить блоку сжиматься */
            min-width: 0;   /* Позволить сжиматься меньше содержимого по умолчанию */
            margin-right: 15px; /* Небольшой отступ от блока действий */
        }

        .header-logo { /* Новый стиль для логотипа */
            height: 70px; /* Уменьшим немного логотип для баланса */
            margin-right: 20px; /* Увеличим отступ */
        }

        .header-title {
            font-size: 26px; /* Немного увеличим */
            font-weight: 700;
            margin: 0;
            line-height: 1.2;
        }

        .header-subtitle {
            font-size: 15px; /* Немного увеличим */
            opacity: 0.85;
            margin-top: 5px;
            word-break: break-word; /* Разрешить перенос длинных слов */
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px; /* Отступ между элементами в actions */
            flex-shrink: 0; /* Запретить этому блоку сжиматься */
        }

        .current-date-container {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 8px;
            word-break: break-word; /* Разрешить перенос для этого элемента тоже */
        }

        .current-date-container .date-icon {
            margin-right: 8px;
            font-size: 1.1em;
        }

        .login-btn {
            background-color: #fff; /* Белый фон для контраста */
            color: #007bff; /* Синий текст, можно использовать цвет из градиента */
            border: none;
            padding: 10px 18px;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.2s ease-in-out;
        }

        .login-btn:hover {
            background-color: #f0f0f0; /* Легкое потемнение при наведении */
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-1px);
        }

        .login-btn i {
            font-size: 1.1em;
        }

        .calls-panel {
            margin-top: 20px;
        }

        /* Стили для журнала звонков */
        .calls-list {
            padding: 20px;
        }

        .call-card {
            background: white;
            border-radius: 8px;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            padding: 15px;
            transition: transform 0.2s ease;
        }

        .call-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .call-info {
            display: flex;
            flex-wrap: wrap;
        }

        .call-property {
            flex: 1;
            min-width: 200px;
            padding: 8px;
        }

        .property-label {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .property-value {
            font-weight: 500;
        }

        .empty-message {
            text-align: center;
            padding: 40px;
            color: #6c757d;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .status-message {
            padding: 10px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 14px;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-loading {
            background-color: #f8f9fa;
            color: #6c757d;
            border: 1px solid #e9ecef;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .call-property {
                min-width: 100%;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
        }

        .header-actions {
                margin-top: 10px;
            }
        }

        .finesse-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .finesse-modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 8px;
            position: relative;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
            animation: slideInModal 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .finesse-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .finesse-modal-title {
            margin: 0;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            color: #333;
        }

        .finesse-modal-title i {
            margin-right: 10px;
            color: #007bff;
            font-size: 1.1em;
        }

        .finesse-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 5px;
        }

        .finesse-modal-body {
            /* max-height: 400px; */
            /* overflow-y: auto; */ /* <<< Меняем это >>> */
            overflow-y: scroll; /* <<< На это (всегда показывать скролл) >>> */
        }

        .loading-spinner {
            text-align: center;
            padding: 20px;
        }

        .error-message {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }

        .client-info-row {
            display: flex;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .client-info-label {
            font-weight: bold;
            width: 150px;
            color: #666;
        }

        .agency-info {
            padding: 15px;
        }

        .agency-info-row {
            display: flex;
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .agency-info-label {
            font-weight: bold;
            width: 150px;
            color: #666;
        }

        .agency-info-value {
            flex: 1;
            padding-left: 10px;
        }

        /* Новые стили для карточки обзвона */
        .agency-info-card {
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            /* <<< НАЧАЛО ИЗМЕНЕНИЯ: Управляем высотой и скроллом здесь, добавляем flex >>> */
            display: block; /* Убедимся, что это блок */
            max-height: 80vh; /* Ограничиваем высоту */
            overflow-y: auto; /* Добавляем скролл при необходимости */
            flex: 1; /* Позволяем элементу растягиваться/сжиматься */
            /* <<< КОНЕЦ ИЗМЕНЕНИЯ >>> */
        }

        .agency-info-card .info-row {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .agency-info-card .info-row:last-child {
            border-bottom: none;
        }

        .agency-info-card .info-icon {
            font-size: 1.1em;
            margin-right: 15px;
            color: #555;
            width: 25px; /* Фиксированная ширина для выравнивания */
            text-align: center;
        }

        .agency-info-card .info-label {
            font-weight: 500;
            color: #333;
            width: 130px; /* Фиксированная ширина метки */
        }

        .agency-info-card .info-value {
            flex: 1;
            color: #555;
        }

        /* Цвета для иконок */
        .info-icon.agency { color: #007bff; } /* Синий */
        .info-icon.result-success { color: #28a745; } /* Зеленый */
        .info-icon.result-fail { color: #dc3545; } /* Красный */
        .info-icon.result-neutral { color: #6c757d; } /* Серый */
        .info-icon.country { color: #ffc107; } /* Желтый */
        .info-icon.metro { color: #fd7e14; } /* Оранжевый */
        .info-icon.manager { color: #6f42c1; } /* Фиолетовый */
        .info-icon.datetime { color: #17a2b8; } /* Бирюзовый */
        .info-icon.operator { color: #e83e8c; } /* Розовый */
        .info-icon.client { color: #20c997; } /* Тиловый */
        /* Добавляем цвета для карточки клиента */
        .info-icon.phone { color: #17a2b8; } /* Бирюзовый (как дата) */
        .info-icon.email { color: #6610f2; } /* Индиго */
        .info-icon.city { color: #fd7e14; } /* Оранжевый (как метро) */
        .info-icon.ad { color: #e83e8c; } /* Розовый (как оператор) */

         /* Стили для кнопки информации об обзвоне */
        .agency-info-btn {
            background: none;
            border: none;
            color: #007bff;
            cursor: pointer;
            padding: 0 5px;
            font-size: 0.9em;
            margin-left: 8px;
            vertical-align: middle;
            transition: color 0.2s ease;
        }
        .agency-info-btn:hover {
            color: #0056b3;
        }

        /* Новые стили для таблицы журнала звонков */
        .calls-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-radius: 6px;
            overflow: hidden; /* Для скругления углов */
        }

        .calls-table th,
        .calls-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle; /* Выравнивание по вертикали */
            font-size: 0.9rem;
            color: #444;
        }

        .calls-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
            white-space: nowrap; /* Заголовки не переносятся */
        }

        .calls-table tbody tr:nth-child(even) {
            background-color: #fdfdfd;
        }

        .calls-table tbody tr:hover {
            background-color: #f1f8ff;
            cursor: default; /* Или pointer, если вся строка кликабельна */
        }

        /* Иконки в таблице */
        .calls-table .icon {
            margin-right: 8px;
            color: #6c757d; /* Серый цвет иконок по умолчанию */
            width: 16px; /* Для выравнивания */
            display: inline-block;
            text-align: center;
        }
        .calls-table .phone-icon { color: #17a2b8; } /* Бирюзовый */
        .calls-table .operator-icon { color: #6f42c1; } /* Фиолетовый */
        .calls-table .time-icon { color: #fd7e14; } /* Оранжевый */
        .calls-table .result-icon { color: #20c997; } /* Тиловый */
        .calls-table .type-icon { color: #ff6b6b; } /* Коралловый (пример) */

         /* Стиль для значков результата звонка */
        .call-result-badge {
            display: inline-block;
            padding: 4px 10px;
            font-size: 0.8em;
            font-weight: 600;
            border-radius: 12px; /* Скругленные края */
            text-align: center;
            min-width: 80px; /* Минимальная ширина для консистентности */
        }
        /* Успешный результат */
        .result-success {
            background-color: #d1e7dd; /* Светло-зеленый */
            color: #0a3622;
        }
        /* Неуспешный/Сорвался результат */
        .result-failed {
            background-color: #f8d7da; /* Светло-красный */
            color: #58151c;
        }
         /* Клиент положил трубку */
        .result-dropped {
             background-color: #fff3cd; /* Светло-желтый */
             color: #664d03;
        }
         /* Нет интернета */
        .result-no-internet {
             background-color: #cfe2ff; /* Светло-синий */
             color: #052c65;
        }
         /* Неизвестный результат */
        .result-unknown {
            background-color: #e9ecef; /* Светло-серый */
            color: #495057;
        }

         /* Стиль для кнопок в таблице */
        .calls-table .action-btn {
            background-color: #e9ecef;
            color: #495057;
            border: none;
            padding: 5px 10px;
            font-size: 0.8rem;
            border-radius: 15px; /* Сильное скругление */
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex; /* Для выравнивания иконки и текста */
            align-items: center;
            margin-right: 5px; /* Отступ между кнопками */
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .calls-table .action-btn i {
            margin-right: 5px;
        }
        .calls-table .action-btn:hover {
            background-color: #ced4da;
            color: #343a40;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        /* Выделяем кнопку карты клиента */
        .calls-table .client-card-btn {
            background-color: #d1e7dd; /* Светло-зеленый */
            color: #0f5132;
        }
        .calls-table .client-card-btn:hover {
            background-color: #badbcc;
            color: #0a3622;
        }
        .calls-table .agency-info-btn {
             /* Оставляем стили по умолчанию (серые) или добавляем свои */
        }

        /* Стили для заголовка аккордеона */
        .accordion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background:rgb(17, 130, 223); /* Устанавливаем фон, перекрывая внешний стиль */
            color: white; /* Делаем текст белым */
            cursor: pointer;
            border-radius: 6px 6px 0 0; /* Скругление только верхних углов */
            border-bottom: 1px solid #bee5eb; /* Добавим границу для разделения */
        }
        .accordion-header span {
            font-weight: 600;
        }
        .accordion-header .header-date {
            font-size: 0.9em;
            opacity: 0.9;
            margin-left: 15px; /* Отступ от заголовка */
        }
        .accordion-header .controls {
             display: flex;
             align-items: center;
        }
        .accordion-header .refresh-calls-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            margin-left: 15px;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        .accordion-header .refresh-calls-btn:hover {
            opacity: 1;
        }
        .accordion-icon {
             margin-left: 10px;
             transition: transform 0.3s ease; /* Анимация поворота иконки */
        }
        /* Поворот иконки при активном аккордеоне */
        .accordion-panel.active .accordion-icon {
            transform: rotate(180deg);
        }

        /* Стили для контента аккордеона */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding-top 0.3s ease-out, padding-bottom 0.3s ease-out;
            padding-top: 0;
            padding-bottom: 0;
            border-top: none; /* Убираем границу сверху */
            background-color: #fff; /* Добавляем фон, если его нет */
             border-radius: 0 0 6px 6px; /* Скругление нижних углов */
        }
        /* Стили для активного (открытого) аккордеона */
        .accordion-panel.active .accordion-content {
            max-height: 5000px; /* Устанавливаем очень большое значение вместо 'none' */
                                /* Это может помочь браузеру лучше пересчитывать высоту */
            overflow-y: auto;   /* Используем auto, чтобы скролл появлялся только при необходимости */
                                /* Раньше было: overflow: visible; */
             padding-top: 15px; /* Восстанавливаем отступы при открытии */
             padding-bottom: 15px;
             border-top: 1px solid #dee2e6; /* Добавляем границу сверху при открытии */
        }

        /* Стили для фильтров */
        .calls-filter-bar {
            padding: 15px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            gap: 15px; /* Отступы между элементами */
            align-items: center;
            flex-wrap: wrap; /* Перенос на новую строку при нехватке места */
        }
        .calls-filter-bar .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .calls-filter-bar label {
            font-size: 0.9rem;
            color: #495057;
            margin-bottom: 0; /* Убираем нижний отступ у метки */
        }
        .calls-filter-bar input[type="text"],
        .calls-filter-bar input[type="date"] {
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        /* Стили для поля даты в заголовке (если будем добавлять) */
        .header-date-input {
             padding: 2px 6px;
             margin-left: 8px;
             border: 1px solid rgba(255,255,255,0.3);
             border-radius: 4px;
             background-color: rgba(255,255,255,0.1);
             color: white;
             font-size: 0.85em;
        }

        /* Стиль для отображения количества звонков */
        .call-count-display {
            font-size: 0.9rem;
            color: #555;
            background-color: #e9ecef;
            padding: 6px 12px;
            border-radius: 4px;
        }
        .call-count-display i {
            margin-right: 6px;
            color: #6c757d;
        }

        /* Адаптивность */
        @media (max-width: 768px) {
            .calls-filter-bar {
                flex-direction: column; /* Фильтры в столбик */
                align-items: stretch; /* Растягиваем по ширине */
            }
            .calls-filter-bar .filter-group {
                 width: 100%; /* Фильтры на всю ширину */
            }
            .calls-filter-bar input[type="text"] {
                 width: 100%; /* Поля ввода на всю ширину */
                 box-sizing: border-box; /* Учитываем padding и border в ширине */
            }

            .calls-table {
                display: block; /* Позволяет таблице прокручиваться */
                overflow-x: auto; /* Добавляем горизонтальную прокрутку */
                white-space: nowrap; /* Предотвращаем перенос текста в ячейках */
                border-radius: 0; /* Убираем скругление для блока */
                box-shadow: none; /* Убираем тень */
            }
            .calls-table thead, .calls-table tbody, .calls-table tr {
                display: block;
            }
            .calls-table th,
            .calls-table td {
                 white-space: normal; /* Разрешаем перенос текста в ячейках */
                 /* Можно настроить ширину колонок или скрыть некоторые */
                 padding: 8px 10px; /* Уменьшаем отступы */
            }
            .calls-table td:first-child,
            .calls-table th:first-child {
                 padding-left: 15px;
            }
             .calls-table td:last-child,
            .calls-table th:last-child {
                 padding-right: 15px;
            }
            .accordion-header {
                flex-direction: column; /* Заголовок в столбик */
                align-items: flex-start;
            }
            .accordion-header .controls {
                margin-top: 10px;
            }
        }

        /* Стили для карточки клиента из старой версии */
        .client-card {
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .client-info h3 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.1em;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }
        .client-phone {
            font-weight: bold;
            margin-bottom: 15px;
            color: #555;
        }
        .client-details p {
            margin: 5px 0;
            font-size: 0.9em;
            color: #666;
            line-height: 1.4;
        }
        .client-details p strong {
            display: inline-block;
            width: 100px; /* Выравнивание меток */
            color: #444;
        }
        /* Конец стилей для карточки клиента */

        /* Стили для кнопки очистки фильтра */
        .filter-input-wrapper {
            position: relative; /* Для позиционирования крестика */
            display: flex; /* Выравниваем иконку, инпут и крестик */
            align-items: center;
        }
        .clear-filter-btn {
            position: absolute;
            right: 8px; /* Отступ справа */
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #aaa;
            font-size: 1.2em;
            line-height: 1;
            font-weight: bold;
        }
        .clear-filter-btn:hover {
            color: #555;
        }
        /* Отображаем крестик только если инпут не пустой - можно через JS */

        /* <<< НАЧАЛО ИЗМЕНЕНИЯ: СТАБИЛИЗИРУЕМ ПОЛОЖЕНИЕ МОДАЛЬНОГО ОКНА >>> */
        #agencyInfoModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1050;
            display: none;
            /* Используем flex для центрирования - это стабилизирует положение */
            justify-content: center;
            align-items: center;
            /* Добавляем плавное появление/исчезновение */
            opacity: 1;
            transition: opacity 0.2s ease;
        }

        #agencyInfoModal .finesse-modal-content {
            /* Убираем абсолютное позиционирование и transform */
            position: relative;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            min-height: 300px; /* Добавляем минимальную высоту */
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            /* Добавляем анимации для плавного появления и стабилизации */
            transform: translateY(0); /* Стабильное положение */
            animation: modalContentAppear 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes modalContentAppear {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        #agencyInfoModal .finesse-modal-header {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #007bff; /* Возвращаем голубой цвет фона */
            color: white; /* Белый цвет текста для контраста */
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        #agencyInfoModal .finesse-modal-body {
            padding: 15px;
            overflow-y: auto;
            flex: 1;
        }

        #agencyInfoModal .finesse-modal-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin: 0;
            color: white; /* Убеждаемся, что текст заголовка белый */
        }

        #agencyInfoModal .finesse-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            color: white; /* Меняем цвет кнопки закрытия на белый */
        }

        /* Новые стили для карточки обзвона - УПРОЩЕННЫЕ */
        .agency-info-card {
            width: 100%;
            height: auto;
            background-color: #fff;
            padding: 15px;
        }
        /* <<< КОНЕЦ ИЗМЕНЕНИЯ >>> */

        /* <<< НАЧАЛО ИЗМЕНЕНИЯ: ДОБАВЛЯЕМ СТИЛИ ДЛЯ ССЫЛКИ НА КАРТУ >>> */
        .map-link {
            color: #0d6efd;
            text-decoration: none;
            border-bottom: 1px dashed #0d6efd;
            position: relative;
            transition: all 0.2s ease;
            padding-right: 22px; /* Место для иконки */
            display: inline-block;
        }

        .map-link:hover {
            color: #0a58ca;
            border-bottom: 1px solid #0a58ca;
        }

        .map-link-icon {
            font-size: 0.85em;
            position: absolute;
            right: 0;
            top: 2px;
            opacity: 0.7;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        .map-link:hover .map-link-icon {
            opacity: 1;
            transform: translateX(2px);
        }

        /* Добавляем тултип при наведении */
        .map-link::after {
            content: "Открыть на Яндекс Картах";
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
            z-index: 1060;
        }

        .map-link:hover::after {
            opacity: 1;
            visibility: visible;
        }
        /* <<< КОНЕЦ ИЗМЕНЕНИЯ >>> */

        /* Стили для панели аналитики */
        .analytics-panel .accordion-content {
            background-color: #f8f9fa; /* Немного другой фон для отличия */
        }

        #analyticsReportContainer {
            padding: 15px;
        }

        .report-section {
            background-color: #fff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .report-section h4 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* Стили для таблиц в отчете (можно расширить) */
        .analytics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9rem;
        }
        .analytics-table th,
        .analytics-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }
        .analytics-table th {
            background-color: #e9ecef;
            font-weight: 600;
            color: #495057;
        }
        .analytics-table tbody tr:nth-child(even) {
            background-color: #fdfdfd;
        }
        .analytics-table .percentage-bar-container {
            width: 100px; /* Ширина для прогресс-бара */
            background-color: #e9ecef;
            border-radius: 4px;
            height: 12px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
        }
        .analytics-table .percentage-bar {
            height: 100%;
            background-color: #007bff; /* Синий по умолчанию */
            border-radius: 4px 0 0 4px;
            transition: width 0.5s ease-in-out;
        }
        .analytics-table .percentage-text {
            margin-left: 5px;
            font-size: 0.85em;
            vertical-align: middle;
        }
         /* Цвета для прогресс-баров результативности */
        .analytics-table .percentage-bar.success { background-color: #28a745; } /* Зеленый */
        .analytics-table .percentage-bar.failed { background-color: #dc3545; } /* Красный */
        .analytics-table .percentage-bar.dropped { background-color: #ffc107; } /* Желтый */

        /* Стили для общей статистики */
        #dailySummaryStats ul {
            list-style-type: none;
            padding-left: 0;
        }
        #dailySummaryStats li {
            padding: 6px 0;
            border-bottom: 1px dashed #eee;
            display: flex;
            justify-content: space-between;
        }
        #dailySummaryStats li:last-child {
            border-bottom: none;
        }
        #dailySummaryStats li strong {
            color: #007bff; /* Акцент на цифрах */
        }

        /* Стили для модального окна детальной информации об агентстве (#agencyDetailModal) */
        #agencyDetailModal .info-icon.fa-phone-alt { color: #555; } /* Основной цвет для номеров телефонов в списке */

        /* Конец стилей для #agencyDetailModal */

        /* Стили для таблицы Справочника Агентств */
        .agencies-table th {
            /* background-color: #e9ecef; /* Чуть другой фон для заголовков агентств, если нужно */
            /* color: #0056b3;       /* Более темный синий для текста заголовков */
        }

        /* Раскрашиваем иконки в заголовках таблицы агентств */
        .agencies-table th .fa-building { color: #007bff; } /* Название - синий */
        .agencies-table th .fa-map-marker-alt { color: #dc3545; } /* Адрес - красный */
        .agencies-table th .fa-city { color: #fd7e14; } /* Город - оранжевый */
        .agencies-table th .fa-subway { color: #6f42c1; } /* Метро - фиолетовый */
        .agencies-table th .fa-phone-alt { color: #17a2b8; } /* Телефоны - бирюзовый */
        .agencies-table th .fa-map-signs { color: #20c997; } /* Район - тиловый */
        .agencies-table th .fa-info-circle { color: #6c757d; } /* Действия - серый */

        /* Цвет иконки для названия агентства в строках таблицы */
        .agencies-table td .fa-building {
            color: #007bff; /* Синий, как в заголовке */
            margin-right: 8px; /* Добавим отступ, если его нет */
        }

        /* === Styles for Agency Detail Modal === */
        #agencyDetailModal .finesse-modal-content {
            position: relative;
            margin: auto; /* Center in parent if parent is flex and align/justify center */
            width: 90%;
            max-width: 950px; /* Made wider */
            min-height: 400px;
            max-height: 90vh; /* Limit height of the modal box */
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column; /* Stack header and body */
            animation: modalContentAppear 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Smooth appearance */
        }

        /* Consistent header styling with agencyInfoModal */
        #agencyDetailModal .finesse-modal-header {
            padding: 12px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #007bff; /* Consistent blue header */
            color: white;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            flex-shrink: 0; /* Header should not shrink */
        }

        #agencyDetailModal .finesse-modal-header .finesse-modal-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin: 0;
            color: white;
        }

        #agencyDetailModal .finesse-modal-header .finesse-modal-title i {
            margin-right: 10px;
            /* color: white; Ensure icon color if needed */
        }

        #agencyDetailModal .finesse-modal-header .finesse-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            color: white;
        }

        /* Styles for the body of agencyDetailModal (which is #agencyDetailContent) */
        #agencyDetailModal .finesse-modal-body {
            padding: 20px;
            overflow-y: auto; /* KEY for scrolling the content within the body */
            flex: 1;          /* Body takes up available vertical space */
            min-height: 0;    /* Crucial for scrollable flex children */
        }
        /* Ensure the inner card defers scrolling to the modal body */
        #agencyDetailModal .finesse-modal-body .agency-info-card {
            max-height: none;
            overflow-y: visible;
            /* Retain its own padding as it structures the info-rows */
        }

        /* === Styles for Agency Detail Modal (Attempt 2) === */
        #agencyDetailModal .finesse-modal-content {
            position: relative;
            margin: auto;
            width: 90%;
            max-width: 950px;
            min-height: 400px;
            max-height: 90vh;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            animation: modalContentAppear 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #agencyDetailModal .finesse-modal-header {
            padding: 12px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #007bff;
            color: white;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            flex-shrink: 0;
        }

        #agencyDetailModal .finesse-modal-header .finesse-modal-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin: 0;
            color: white;
        }

        #agencyDetailModal .finesse-modal-header .finesse-modal-title i {
            margin-right: 10px;
        }

        #agencyDetailModal .finesse-modal-header .finesse-close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            color: white;
        }

        #agencyDetailModal .finesse-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        #agencyDetailModal .finesse-modal-body .agency-info-card {
            max-height: none;
            overflow-y: visible;
        }
        /* === End of Styles for Agency Detail Modal (Attempt 2) === */

        /* Цветные иконки для карточки агентства */
        #agencyDetailModal .info-icon.agency         { color: #007bff; }  /* Синий */
        #agencyDetailModal .info-icon.globe          { color: #20c997; }  /* Тиловый */
        #agencyDetailModal .info-icon.city           { color: #fd7e14; }  /* Оранжевый */
        #agencyDetailModal .info-icon.metro          { color: #6f42c1; }  /* Фиолетовый */
        #agencyDetailModal .info-icon.map-marker-alt { color: #dc3545; }  /* Красный */
        #agencyDetailModal .info-icon.map-signs      { color: #20c997; }  /* Тиловый */
        #agencyDetailModal .info-icon.map            { color: #0d6efd; }  /* Синий */
        #agencyDetailModal .info-icon.clock          { color: #17a2b8; }  /* Бирюзовый */
        #agencyDetailModal .info-icon.calendar-alt   { color: #ffc107; }  /* Желтый */
        #agencyDetailModal .info-icon.user-check     { color: #198754; }  /* Зеленый */
        #agencyDetailModal .info-icon.ticket-alt     { color: #fd7e14; }  /* Оранжевый */
        #agencyDetailModal .info-icon.ban            { color: #6c757d; }  /* Серый */
        #agencyDetailModal .info-icon.random         { color: #6610f2; }  /* Индиго */
        #agencyDetailModal .info-icon.credit-card    { color: #20c997; }  /* Тиловый */
        #agencyDetailModal .info-icon.plane-departure{ color: #007bff; }  /* Синий */
        #agencyDetailModal .info-icon.skiing         { color: #6f42c1; }  /* Фиолетовый */
        #agencyDetailModal .info-icon.directions     { color: #198754; }  /* Зеленый */
        #agencyDetailModal .info-icon.phone-alt      { color: #17a2b8; }  /* Бирюзовый */
        #agencyDetailModal .info-icon.phone-square-alt { color: #0d6efd; }/* Синий */
        #agencyDetailModal .info-icon.phone-slash    { color: #dc3545; }  /* Красный */
        #agencyDetailModal .info-icon.hashtag        { color: #6c757d; }  /* Серый */
        #agencyDetailModal .info-icon { opacity: 0.95; }

        #agencyDetailModal .finesse-modal-header {
            background: linear-gradient(90deg, #007bff 0%, #20c997 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-bottom: 3px solid #20c997;
            font-size: 1.35rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        #agencyDetailModal .finesse-modal-title {
            display: flex;
            align-items: center;
            font-size: 1.35rem;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }
        #agencyDetailModal .finesse-modal-title i {
            margin-right: 12px;
            font-size: 1.3em;
        }

        /* Стили для кнопки обновления Справочника Агентств, чтобы она выглядела как refresh-calls-btn */
        .accordion-header .refresh-agencies-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.1em;
            cursor: pointer;
            margin-left: 15px; /* Или другой отступ, если требуется для выравнивания */
            opacity: 0.8;
            transition: opacity 0.2s ease;
        }
        .accordion-header .refresh-agencies-btn:hover {
            opacity: 1;
        }
        /* Если иконка внутри кнопки не наследует цвет автоматически */
        .accordion-header .refresh-agencies-btn i {
            color: white; /* Убедимся, что иконка белая */
        }

        /* Более специфичное правило для иконки заголовка, чтобы гарантировать отображение */
        #agencyDetailModal .finesse-modal-header .finesse-modal-title i.header-icon.fa-building {
            display: inline-block !important;
            font-family: "Font Awesome 5 Free" !important; /* Явно указываем шрифт */
            font-weight: 900 !important; /* Для solid иконок */
            font-style: normal !important;
            font-variant: normal !important;
            text-rendering: auto !important;
            -webkit-font-smoothing: antialiased !important;
            margin-right: 12px !important;
            font-size: 1.3em !important; /* Или ваше значение */
            color: white !important;
            /* Временный фон для отладки, если иконка есть, но не видна */
            /* background-color: deeppink; */
            /* border: 1px solid lime; */
        }

        /* Стили для иконки в заголовке #agencyInfoModal (аналогично #agencyDetailModal) */
        #agencyInfoModal .finesse-modal-header {
            /* Если нужны общие стили для хедера этого модального окна, можно добавить здесь */
            /* Например, background, color, box-shadow, border-bottom, font-size, etc. */
            /* Мы уже имеем стили для #agencyInfoModal .finesse-modal-header, так что это для специфичных переопределений */
        }
        #agencyInfoModal .finesse-modal-title {
            display: flex; /* Для выравнивания иконки и текста */
            align-items: center;
            /* font-size и font-weight должны наследоваться или быть установлены в #agencyInfoModal .finesse-modal-header */
        }
        #agencyInfoModal .finesse-modal-header .finesse-modal-title i.header-icon {
            display: inline-block !important;
            font-family: "Font Awesome 5 Free" !important;
            font-weight: 900 !important;
            font-style: normal !important;
            font-variant: normal !important;
            text-rendering: auto !important;
            -webkit-font-smoothing: antialiased !important;
            margin-right: 12px !important;
            font-size: 1.3em !important; /* Или ваше значение */
            color: white !important; /* Убедимся, что цвет белый */
        }

        /* Цветные иконки для карточки агентства (из Журнала) - agencyInfoModal */
        /* Общие иконки агентства */
        #agencyInfoModal .info-icon.hashtag        { color: #6c757d; }  /* Серый (ID Агентства) */
        #agencyInfoModal .info-icon.agency         { color: #007bff; }  /* Синий (Название) */
        #agencyInfoModal .info-icon.globe          { color: #20c997; }  /* Тиловый (Название англ.) */
        #agencyInfoModal .info-icon.map-marker-alt { color: #dc3545; }  /* Красный (Адрес) */
        #agencyInfoModal .info-icon.city           { color: #fd7e14; }  /* Оранжевый (Город) */
        #agencyInfoModal .info-icon.metro          { color: #6f42c1; }  /* Фиолетовый (Метро) */
        #agencyInfoModal .info-icon.map-signs      { color: #20c997; }  /* Тиловый (Район города) */
        #agencyInfoModal .info-icon.map            { color: #0d6efd; }  /* Синий (Зона, Регион) */
        #agencyInfoModal .info-icon.clock          { color: #17a2b8; }  /* Бирюзовый (Часовой пояс) */
        #agencyInfoModal .info-icon.user-check     { color: #198754; }  /* Зеленый (Англ. туристы) */
        #agencyInfoModal .info-icon.ticket-alt     { color: #fd7e14; }  /* Оранжевый (Продажа билетов) */
        #agencyInfoModal .info-icon.ban            { color: #6c757d; }  /* Серый ("Станция не задана") */
        #agencyInfoModal .info-icon.random         { color: #6610f2; }  /* Индиго ("Перекл. на Мск") */
        #agencyInfoModal .info-icon.credit-card    { color: #20c997; }  /* Тиловый (Прием банк. карт) */
        #agencyInfoModal .info-icon.plane-departure{ color: #007bff; }  /* Синий (Туры в Стамбул) */
        #agencyInfoModal .info-icon.skiing         { color: #6f42c1; }  /* Фиолетовый (Туры в Австрию) */
        #agencyInfoModal .info-icon.directions     { color: #198754; }  /* Зеленый (Как пройти) */

        /* Телефоны в agencyInfoModal */
        /* Основная иконка fa-phone-square-alt для "Телефоны:" (имеет класс .operator) */
        #agencyInfoModal .info-icon.fa-phone-square-alt.operator { color: #0d6efd; } /* Синий */
        /* Иконки fa-phone-alt для отдельных номеров (без доп. класса от formatAgencyData кроме result-*) */
        #agencyInfoModal .info-icon.fa-phone-alt { color: #17a2b8; } /* Бирюзовый */

        /* Информация о звонке в agencyInfoModal */
        /* Результат звонка (fa-phone-alt с классами result-*) - эти должны переопределить .fa-phone-alt выше */
        #agencyInfoModal .info-icon.result-success { color: #28a745 !important; } /* Зеленый */
        #agencyInfoModal .info-icon.result-fail    { color: #dc3545 !important; } /* Красный */
        #agencyInfoModal .info-icon.result-neutral { color: #6c757d !important; } /* Серый */

        #agencyInfoModal .info-icon.client         { color: #20c997; }  /* Тиловый (Клиент - fa-user-tie) */
        #agencyInfoModal .info-icon.country        { color: #ffc107; }  /* Желтый (Страна - fa-globe-americas) */
        /* .metro для "Метро (из обзвона)" уже покрыто правилом выше */
        #agencyInfoModal .info-icon.manager        { color: #6f42c1; }  /* Фиолетовый (Менеджер - fa-user-tag) */
        /* Оператор (звонка) - fa-headset с классом .operator */
        #agencyInfoModal .info-icon.fa-headset.operator { color: #e83e8c; }  /* Розовый */
        #agencyInfoModal .info-icon.datetime       { color: #17a2b8; }  /* Бирюзовый (Дата и время звонка - fa-calendar-alt) */

        /* Общее правило для иконок в agencyInfoModal, чтобы соответствовать agencyDetailModal */
        #agencyInfoModal .info-icon { opacity: 0.95; }

        .finesse-status-indicator {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.9);
            background-color: rgba(0, 0, 0, 0.2);
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            margin-top: 8px;
        }

        .finesse-status-indicator i {
            margin-right: 5px;
        }

        .finesse-status-dot {
            height: 8px;
            width: 8px;
            background-color: #4CAF50; /* Green for connected */
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            transition: background-color 0.3s ease;
        }

        .finesse-status-dot.disconnected {
            background-color: #F44336; /* Red for disconnected */
        }
        .finesse-status-dot.connecting {
            background-color: #FFC107; /* Yellow for connecting */
        }

        .user-session-controls {
            display: flex;
            align-items: center;
            background-color: #00897b; /* Примерный цвет из скриншота (темный бирюзовый) */
            padding: 8px 15px;
            border-radius: 6px;
            color: white;
        }

        .username-text {
            font-weight: 600;
            margin-right: 12px;
            font-size: 15px;
        }

        .logout-btn {
            background-color: transparent;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.6);
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: white;
        }

        /* Стили для иконок в заголовках аккордеона */
        .accordion-header .panel-icon {
            margin-right: 10px; /* Отступ иконки от текста */
            font-size: 1em; /* Размер иконки */
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <!-- Сообщение об ошибке подключения к базе данных -->
    {% if connection_error %}
    <div class="alert alert-warning">
        <strong>Внимание:</strong> {{ connection_error }}
        <p>Проверьте подключение к VPN и доступ к корпоративной сети.</p>
    </div>
    {% endif %}

    <div class="container">
        <header>
            <div class="header-content">
                <!-- Группа для логотипа и заголовка -->
                <div class="header-main-content">
                    <img src="{{ url_for('static', filename='img/tez-tour-mini-logo.png') }}" alt="Tez Tour Logo" class="header-logo">
                    <div>
                        <h1 class="header-title">TEZ Контакт-центр | Москва</h1>
                        <div class="header-subtitle">Мониторинг и аналитика контакт-центра: поддержка и контроль качества</div>
                        <div class="finesse-status-indicator" style="display: none;">
                            <i class="fas fa-headset"></i> <span class="finesse-status-dot disconnected"></span> Cisco Finesse: <span id="finesseConnectionStatus">Не подключено</span>
                        </div>
                    </div>
                </div>

                <div class="header-actions">
                    <div class="current-date-container">
                        <i class="fas fa-calendar-alt date-icon"></i>
                        <span id="headerCurrentDate"></span> <!-- Дата будет вставлена JS -->
                    </div>
                    <!-- Кнопка "Войти" для неавторизованного состояния -->
                    <button class="login-btn">
                        <i class="fas fa-sign-in-alt"></i> Войти
                    </button>
                    <!-- Блок для авторизованного пользователя (скрыт по умолчанию) -->
                    <div class="user-session-controls" style="display: none;">
                        <span id="usernameDisplay" class="username-text"></span> <!-- Имя пользователя будет вставлено JS -->
                        <button class="logout-btn">
                            Выход
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Панель журнала звонков -->
        <div class="calls-panel accordion-panel">
            <div class="accordion-header">
                <div> <!-- Обертка для заголовка и даты -->
                    <i class="fas fa-phone-alt panel-icon"></i><span>Журнал звонков</span>
                    <span class="header-date" id="currentCallLogDate"></span>
                    <!-- <input type="date" class="header-date-input" id="callLogDatePicker"> --> <!-- Закомментировано: для будущего календаря -->
                </div>
                <div class="controls"> <!-- Обертка для кнопки и иконки -->
                    <button class="refresh-calls-btn" title="Обновить журнал звонков">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
            </div>
            <div class="accordion-content">
                <!-- Панель фильтров -->
                <div class="calls-filter-bar">
                    <div class="filter-group filter-input-wrapper">
                        <label for="phoneSearch"><i class="fas fa-search"></i></label>
                        <input type="text" id="phoneSearch" placeholder="Поиск по номеру">
                        <span class="clear-filter-btn" id="clearPhoneSearch" style="display: none;">&times;</span>
                    </div>
                    <div class="filter-group filter-input-wrapper">
                         <label for="operatorSelect"><i class="fas fa-user-headset"></i></label>
                         <select id="operatorSelect" style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 0.9rem; flex-grow: 1;">
                             <option value="">Все операторы</option>
                             <!-- Опции будут добавлены динамически -->
                         </select>
                         <span class="clear-filter-btn" id="clearOperatorFilter" style="display: none; right: 25px;">&times;</span>

                     </div>
                    <div class="filter-group">
                        <label for="callLogDatePicker"><i class="fas fa-calendar-alt"></i></label>
                        <input type="date" id="callLogDatePicker">
                    </div>
                    <div class="filter-group call-count-display" id="callsCountDisplay" style="margin-left: auto;">
                         <i class="fas fa-list-ol"></i>
                         <span>Звонков: {{ calls_count if calls_count is defined else 0 }}</span>
                    </div>
                    <div class="filter-group operator-stats-display" id="operatorStatsContainer" style="margin-left: 15px;">
                        <i class="fas fa-spinner fa-spin"></i> Загрузка статистики...
                    </div>
                </div>
                <div class="calls-status-bar" id="callsStatusBar" style="display: none;">
                    <i class="fas fa-spinner fa-spin status-icon"></i>
                    <span class="status-message">Загрузка журнала звонков...</span>
                </div>
                <div class="calls-list">
                    <table class="calls-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-phone-alt icon phone-icon"></i>Номер телефона</th>
                                <th><i class="fas fa-clock icon time-icon"></i>Время</th>
                                <th><i class="fas fa-user icon operator-icon"></i>Оператор</th>
                                <th><i class="fas fa-poll-h icon result-icon"></i>Результат</th>
                                <th><i class="fas fa-tag icon type-icon"></i>Тип звонка</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if calls %}
                                {% for call in calls %}
                                    <tr>
                                        <td>
                                            <span class="phone-number {% if call.is_unknown or not call.phone_number or call.phone_number == 'None' %}unknown-number{% endif %}">
                                                {% if call.phone_number and call.phone_number != 'None' %}
                                                    {{ call.phone_number }}
                                                {% else %}
                                                    <span style="color: #999; font-style: italic;">Телефон не определен</span>
                                                {% endif %}
                                            </span>
                                            <div>
                                                {% if call.has_client_card %}
                                                <button class="action-btn client-card-btn"
                                                        data-call-id="{{ call.id }}"
                                                        onclick="showClientCard(this)">
                                                    <i class="fas fa-id-card"></i>Карта клиента
                                                </button>
                                                {% endif %}
                                                {% if call.pp_id %}
                                                <button class="action-btn agency-info-btn" title="Информация об обзвоне" onclick="showAgencyInfo({{ call.pp_id }})">
                                                    <i class="fas fa-info-circle"></i>Инфо
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td>{{ call.call_time }}</td>
                                        <td>{{ call.operator_name }}</td>
                                        <td>
                                            {% set result_class = 'result-unknown' %}
                                            {% if call.result == 0 %}
                                                {% set result_class = 'result-failed' %}
                                            {% elif call.result == 1 %}
                                                {% set result_class = 'result-success' %}
                                            {% elif call.result == 2 %}
                                                {% set result_class = 'result-dropped' %}
                                            {% elif call.result == 3 %}
                                                {% set result_class = 'result-no-internet' %}
                                            {% elif call.result == 4 or call.result == 5 or call.result == 6 %}
                                                {% set result_class = 'result-failed' %}
                                            {% endif %}
                                            <span class="call-result-badge {{ result_class }}">
                                                {{ call.call_result_text or '-' }}
                                            </span>
                                        </td>
                                        <td>{{ call.call_type_text or '-' }}</td>
                                    </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="5" class="no-calls-message">
                                        <i class="fas fa-phone-slash"></i>
                                        <p>Журнал звонков пуст</p>
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Панель Аналитики звонков -->
        <div class="analytics-panel accordion-panel" id="analyticsPanel">
            <div class="accordion-header">
                <div>
                    <i class="fas fa-chart-line panel-icon"></i><span>Аналитика звонков за день</span>
                    <span class="header-date" id="analyticsReportDate"></span>
                </div>
                <div class="controls">
                    <input type="date" id="analyticsDatePicker" class="header-date-input" style="margin-right: 10px;">
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
            </div>
            <div class="accordion-content">
                <div id="analyticsReportContainer">
                    <!-- Раздел 1: Общая статистика -->
                    <div class="report-section" id="generalAnalyticsSection">
                        <h4>Общая статистика</h4>
                        <div id="dailySummaryStats">
                            <p><i class="fas fa-spinner fa-spin"></i> Загрузка общей статистики...</p>
                        </div>
                    </div>

                    <!-- Раздел 2: Детализация по операторам -->
                    <div class="report-section" id="operatorAnalyticsSection">
                        <h4>Детализация по операторам</h4>
                        <div id="operatorDetailsTableContainer">
                            <p><i class="fas fa-spinner fa-spin"></i> Загрузка статистики по операторам...</p>
                        </div>
                    </div>

                    <!-- Раздел 3: Анализ результативности по типам звонков -->
                    <div class="report-section" id="callTypeAnalyticsSection">
                        <h4>Анализ результативности по типам звонков</h4>
                        <div id="callTypeAnalysisTableContainer">
                            <p><i class="fas fa-spinner fa-spin"></i> Загрузка анализа по типам звонков...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Конец Панели Аналитики звонков -->

        <!-- Панель Справочник Агентств -->
        <div class="agency-directory-panel accordion-panel" id="agencyDirectoryPanel">
            <div class="accordion-header">
                <div>
                    <i class="fas fa-book panel-icon"></i><span>Справочник агентств</span>
                    <span class="header-date" id="agencyDirectoryInfoSpan"></span>
                </div>
                <div class="controls">
                    <button class="refresh-agencies-btn" id="refreshAgenciesBtn" title="Обновить справочник агентств">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
            </div>
            <div class="accordion-content">
                <!-- Панель фильтров для агентств -->
                <div class="agencies-filter-bar calls-filter-bar">
                    <div class="filter-group filter-input-wrapper">
                        <label for="agencySearchInput"><i class="fas fa-search"></i></label>
                        <input type="text" id="agencySearchInput" placeholder="Поиск по названию агента, городу, району, метро, адресу, телефону..." style="width: 500px;">
                        <span class="clear-filter-btn" id="clearAgencySearch" style="display: none;">&times;</span>
                    </div>
                    <div class="filter-group agency-count-display" id="agenciesCountDisplay" style="margin-left: auto;">
                         <i class="fas fa-list-ol"></i>
                         <span>Найдено: 0</span>
                    </div>
                </div>
                <div class="agencies-status-bar" id="agenciesStatusBar" style="display: none; text-align: center; padding: 10px;">
                    <i class="fas fa-spinner fa-spin status-icon"></i>
                    <span class="status-message">Загрузка справочника агентств...</span>
                </div>
                <div class="agencies-list" style="overflow-x: auto;">
                    <table class="agencies-table calls-table">
                        <thead>
                            <tr>
                                <th><i class="fas fa-building icon"></i>Название</th>
                                <th><i class="fas fa-map-marker-alt icon"></i>Адрес</th>
                                <th><i class="fas fa-city icon"></i>Город</th>
                                <th><i class="fas fa-subway icon"></i>Метро</th>
                                <th><i class="fas fa-phone-alt icon"></i>Телефоны</th>
                                <th><i class="fas fa-map-signs icon"></i>Район</th>
                                <th><i class="fas fa-info-circle icon"></i>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="agenciesTableBody">
                            <tr>
                                <td colspan="7" class="no-agencies-message" style="text-align:center; padding: 20px;">
                                    <i class="fas fa-book-open" style="font-size: 1.5em; margin-bottom: 10px;"></i>
                                    <p>Справочник агентств. Начните поиск или обновите данные.</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <!-- Конец Панели Справочник Агентств -->

        <!-- Панель Динамики звонков по месяцам (Новый аккордеон) -->
        <div class="monthly-dynamics-panel accordion-panel" id="monthlyDynamicsPanel">
            <div class="accordion-header">
                <div>
                    <i class="fas fa-calendar-alt panel-icon"></i><span>Динамика звонков по месяцам</span>
                    <span class="header-date" id="monthlyDynamicsInfoSpan"></span> <!-- Для информации типа "Данные за весь период" -->
                </div>
                <div class="controls">
                    <i class="fas fa-chevron-down accordion-icon"></i>
                </div>
            </div>
            <div class="accordion-content" style="background-color: #f8f9fa;"> <!-- Фон как у аналитики для консистентности -->
                <!-- Содержимое перенесено сюда -->
                <div id="monthlyCallsChartContainer" style="position: relative; height:40vh; /* width:100%; убран */ overflow-x: auto; margin-top: 15px; background-color: #fff; padding:15px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                     <canvas id="monthlyCallsChart"></canvas>
                </div>
                 <div id="chartLoadingStatus" style="text-align: center; padding: 20px;">
                     <i class="fas fa-spinner fa-spin"></i> Загрузка данных для диаграммы...
                 </div>
                <div id="chartStatsSummary" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; background-color: #fff; padding:15px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                    <!-- Статистика будет вставлена сюда -->
                </div>
                <div id="yearlyMonthlyStatsTableContainer" style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; background-color: #fff; padding:15px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                    <h4>Статистика звонков по годам и месяцам</h4>
                    <div id="yearlyMonthlyStatsTable"></div>
                </div>
            </div>
        </div>
        <!-- Конец Панели Динамики звонков по месяцам -->

    </div>

    <!-- Предупреждение о проблеме с подключением к Cisco Finesse -->
    <div id="vpnNotification" class="finesse-notification" style="display: none;">
        <div class="notification-content">
            <div class="notification-header">
                <span class="notification-title">
                    <i class="fas fa-exclamation-triangle"></i> Внимание: Проблема с подключением
                </span>
                <button class="notification-close" onclick="hideVpnNotification()">&times;</button>
            </div>
            <div class="notification-body">
                <p>Невозможно подключиться к серверу Cisco Finesse. Пожалуйста, проверьте:</p>
                <ul>
                    <li>VPN Cisco AnyConnect активен и подключен</li>
                    <li>У вас есть доступ к корпоративной сети</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- <script src="{{ url_for('static', filename='js/call_history.js') }}"></script> --> <!-- Снова комментируем -->
    <!-- <script src="{{ url_for('static', filename='js/call_history.js') }}"></script> --> <!-- Раскомментировано -->

    <!-- Модальное окно для карточки клиента -->
    <div id="clientCardModal" class="finesse-modal">
        <div class="finesse-modal-content">
            <div class="finesse-modal-header">
                <h2 class="finesse-modal-title">
                    <i class="fas fa-address-card"></i>
                    Карточка клиента
                </h2>
                <button class="finesse-close-btn" onclick="closeClientCard()">&times;</button>
            </div>
            <div id="clientCardContent" class="finesse-modal-body">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Загрузка данных...
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для информации об обзвоне -->
    <div id="agencyInfoModal" class="finesse-modal">
        <div class="finesse-modal-content">
            <div class="finesse-modal-header">
                <h2 class="finesse-modal-title">
                    <i class="fas fa-building header-icon"></i> <!-- Добавлена иконка -->
                    Информация об агентстве (из Журнала)
                </h2>
                <button class="finesse-close-btn" onclick="closeAgencyInfo()">&times;</button>
            </div>
            <div id="agencyInfoContent" class="finesse-modal-body">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Загрузка данных...
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для подробной информации об агентстве -->
    <div id="agencyDetailModal" class="finesse-modal">
        <div class="finesse-modal-content">
            <div class="finesse-modal-header">
                <h2 class="finesse-modal-title">
                    <i class="fas fa-building header-icon"></i>
                    Информация об агентстве
                </h2>
                <button class="finesse-close-btn" onclick="closeAgencyDetailModal()">&times;</button>
            </div>
            <div id="agencyDetailContent" class="finesse-modal-body">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i> Загрузка данных...
                </div>
            </div>
        </div>
    </div>

    <script>
        // Функции для работы с модальными окнами
        function showClientCard(buttonElement) {
            console.log('Button element:', buttonElement);
            const callId = buttonElement.dataset.callId;
            const modal = document.getElementById('clientCardModal');
            const contentDiv = document.getElementById('clientCardContent');

            // Показываем спиннер загрузки
            contentDiv.innerHTML = '<div class="finesse-loading">Загрузка данных...</div>';
            modal.style.display = 'flex';

            // Добавляем логирование ID звонка
            console.log('Запрос карточки клиента для Call ID из data-атрибута:', callId);

            // Запрос данных с сервера
            fetch(`/api/client-card/call/${callId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Ошибка HTTP: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && data.success && data.client_data) {
                        // Формируем содержимое карточки клиента, используя data.client_data
                        const clientData = data.client_data;
                        let html = `
                            <div class="client-card">
                                <div class="client-info">
                                    <h3>${clientData.client_name || 'Имя не указано'}</h3>
                                    <div class="client-phone">${clientData.phone || 'Телефон не указан'}</div>
                                    <div class="client-details">
                                        <p><strong>Email:</strong> ${clientData.email || 'Не указан'}</p>
                                        <p><strong>Город:</strong> ${clientData.client_city || 'Не указан'}</p>
                                        <p><strong>Менеджер:</strong> ${clientData.manager_name || 'Не указан'}</p>
                                        <p><strong>Метро:</strong> ${clientData.metro_name || 'Не указано'}</p>
                                        <p><strong>Страна:</strong> ${clientData.country_name || 'Не указана'}</p>
                                        <p><strong>Реклама:</strong> ${clientData.ad_name || 'Не указана'}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        contentDiv.innerHTML = html;
                    } else {
                        // Если данные не найдены или success: false
                        contentDiv.innerHTML = `
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                <p>Информация о клиенте не найдена</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    // В случае ошибки
                    contentDiv.innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Ошибка при загрузке данных: ${error.message}</p>
                        </div>
                    `;
                    console.error('Ошибка при загрузке карточки клиента:', error);
                });
        }

        function closeClientCard() {
            const modal = document.getElementById('clientCardModal');
            modal.style.display = 'none';
        }

        function closeAgencyInfo() {
            const modal = document.getElementById('agencyInfoModal');
            // Плавно скрываем модальное окно с анимацией затухания
            modal.style.opacity = '0';
            setTimeout(() => {
                modal.style.display = 'none';
                // Сбрасываем прозрачность для следующего открытия
                modal.style.opacity = '';
            }, 200); // Соответствует времени анимации в CSS
        }

        function hideVpnNotification() {
            const notification = document.getElementById('vpnNotification');
            notification.style.display = 'none';
        }

        // Обработчики событий
        document.addEventListener('DOMContentLoaded', function() {
            // Установка текущей даты в заголовке журнала звонков
            const dateSpan = document.getElementById('currentCallLogDate');
            if (dateSpan) {
                const today = new Date();
                const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
                dateSpan.textContent = `Сегодня: ${today.toLocaleDateString('ru-RU', options)}`;
            }

            // Установка текущей даты в главном хедере
            const headerDateSpan = document.getElementById('headerCurrentDate');
            if (headerDateSpan) {
                const today = new Date();
                // Формат: "Сегодня: 15 мая 2025"
                const options = { day: 'numeric', month: 'long', year: 'numeric' };
                headerDateSpan.textContent = `Сегодня: ${today.toLocaleDateString('ru-RU', options)}`;
            }

            // Инициализация аккордеона
            const accordionHeaders = document.querySelectorAll('.accordion-header');
            accordionHeaders.forEach(header => {
                 // --- Ищем родительский panel для текущего header ---
                 const panel = header.closest('.accordion-panel');
                 if (!panel) return; // Пропускаем, если не нашли панель

                 // --- Находим контент и иконку внутри этой панели ---
                 const content = panel.querySelector('.accordion-content');
                 const icon = header.querySelector('.accordion-icon');

                 if (!content || !icon) return; // Пропускаем, если нет контента или иконки

                header.addEventListener('click', function() {
                    // Переключаем класс 'active' на родительской панели
                    panel.classList.toggle('active');

                    // Убираем прямое управление max-height и overflow
                    /*
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    }
                    */
                });
            });

            // Открываем панель журнала звонков по умолчанию
            const callsPanel = document.querySelector('.calls-panel');
            if (callsPanel) {
                 callsPanel.classList.add('active');
                 // Стиль max-height теперь управляется CSS через класс 'active'
                 // const content = callsPanel.querySelector('.accordion-content');
                 // const icon = callsPanel.querySelector('.accordion-header .accordion-icon');
                 // if(content) content.style.maxHeight = content.scrollHeight + "px";
                 // if(icon) {
                 //    icon.classList.remove('fa-chevron-down');
                 //    icon.classList.add('fa-chevron-up');
                 // }
            }
            // Закрываем панель аналитики по умолчанию
            const analyticsPanel = document.getElementById('analyticsPanel');
            if (analyticsPanel) {
                analyticsPanel.classList.remove('active');
            }

            // Скрываем статус-бар после начальной загрузки страницы
            const statusBar = document.getElementById('callsStatusBar');
            if (statusBar) {
                statusBar.style.display = 'none'; // Скрываем по умолчанию
            }

            // Привязываем кнопку обновления
            const refreshBtn = document.querySelector('.refresh-calls-btn');

            if (refreshBtn) {
                refreshBtn.addEventListener('click', function(e) {
                    e.stopPropagation(); // Предотвращаем срабатывание клика по аккордеону

                    // Получаем текущую выбранную дату
                    const selectedDate = document.getElementById('callLogDatePicker').value;

                    // Показываем анимацию вращения на кнопке
                    const icon = this.querySelector('i');
                    if (icon) icon.classList.add('fa-spin');

                    // Вызываем функцию обновления таблицы с текущей датой
                    updateTableForDate(selectedDate);
                    // Также обновляем статистику операторов для этой даты
                    fetchOperatorStats(selectedDate);

                    // Убираем анимацию вращения через некоторое время (например, 1 секунду)
                    // Это нужно, так как updateTableForDate асинхронная
                    setTimeout(() => {
                        if (icon) icon.classList.remove('fa-spin');
                    }, 1000);
                });
            }

            // Проверяем наличие функции обновления уведомлений
            if (typeof updateNotificationCount === 'function') {
                // Проверяем, авторизован ли пользователь
                const isLoggedIn = document.querySelector('.user-logged-in') !== null;
                if (isLoggedIn) {
                    // Вызываем функцию только если пользователь авторизован
                    updateNotificationCount();
                }
            }

            // Добавляем логику фильтрации журнала звонков СЮДА
            const phoneSearchInput = document.getElementById('phoneSearch');
            const operatorFilterInput = document.getElementById('operatorSelect'); // <<< ИЗМЕНЕНО: Используем ID select'а
            const callsTableBody = document.querySelector('.calls-table tbody');
            const noCallsRow = callsTableBody.querySelector('.no-calls-message') ? callsTableBody.querySelector('.no-calls-message').closest('tr') : null;
            // <<< ДОБАВЛЕНО: Находим кнопку очистки оператора >>>
            const clearOperatorBtn = document.getElementById('clearOperatorFilter');

            // <<< ДОБАВЛЕНО: Функция для заполнения выпадающего списка операторов >>>
            function populateOperatorFilter(rows) {
                const operators = new Set();
                rows.forEach(row => {
                    if (row === noCallsRow || !row.cells[2]) return; // Пропускаем строку "нет звонков" и проверяем наличие ячейки
                    const operatorName = row.cells[2].textContent.trim();
                    if (operatorName && operatorName !== '-') { // Добавляем только если имя не пустое и не '-'
                        operators.add(operatorName);
                    }
                });

                // Сохраняем текущее выбранное значение
                const currentSelectedValue = operatorFilterInput.value;

                // Очищаем текущие опции (кроме первой "Все операторы")
                while (operatorFilterInput.options.length > 1) {
                    operatorFilterInput.remove(1);
                }

                // Сортируем имена операторов
                const sortedOperators = Array.from(operators).sort();

                // Добавляем новые опции
                sortedOperators.forEach(opName => {
                    const option = document.createElement('option');
                    option.value = opName;
                    option.textContent = opName;
                    operatorFilterInput.appendChild(option);
                });

                // Восстанавливаем ранее выбранное значение, если оно все еще есть в списке
                if (Array.from(operatorFilterInput.options).some(opt => opt.value === currentSelectedValue)) {
                    operatorFilterInput.value = currentSelectedValue;
                } else {
                    operatorFilterInput.value = ""; // Сбрасываем на "Все операторы" если старого значения нет
                }
                 // Показываем/скрываем кнопку очистки в зависимости от выбора
                 clearOperatorBtn.style.display = operatorFilterInput.value ? 'inline' : 'none';
            }

            function filterCalls() {
                const phoneFilter = phoneSearchInput.value.toLowerCase().trim();
                const operatorFilter = operatorFilterInput.value; // <<< ИЗМЕНЕНО: Получаем value из select'а
                let visibleRows = 0;
                const rows = Array.from(callsTableBody.querySelectorAll('tr')); // Преобразуем в массив для populateOperatorFilter

                rows.forEach(row => {
                    if (row === noCallsRow) return;
                    const phoneCell = row.cells[0];
                    const operatorCell = row.cells[2];
                    // <<< ИЗМЕНЕНО: Убедимся что ячейки существуют перед доступом к ним >>>
                    if (!phoneCell || !operatorCell) {
                        row.style.display = 'none'; // Скрыть строку, если структура нарушена
                        return;
                    }
                    const phoneNumber = phoneCell.querySelector('.phone-number') ? phoneCell.querySelector('.phone-number').textContent.toLowerCase().trim() : '';
                    const operatorName = operatorCell.textContent.trim(); // <<< ИЗМЕНЕНО: Убираем toLowerCase() для точного сравнения со значением select'а

                    const phoneMatch = phoneNumber.includes(phoneFilter);
                    // <<< ИЗМЕНЕНО: Сравниваем с выбранным оператором или показываем, если фильтр пуст ("Все операторы") >>>
                    const operatorMatch = !operatorFilter || operatorName === operatorFilter;

                    if (phoneMatch && operatorMatch) {
                        row.style.display = '';
                        visibleRows++;
                    } else {
                        row.style.display = 'none';
                    }
                });
                if (noCallsRow) {
                     noCallsRow.style.display = visibleRows === 0 ? '' : 'none';
                }

                // <<< УДАЛЕНО: populateOperatorFilter теперь вызывается после загрузки данных >>>
                // populateOperatorFilter(rows); // Обновляем список операторов после каждой фильтрации
            }

            if (phoneSearchInput && operatorFilterInput && callsTableBody && clearOperatorBtn) {
                phoneSearchInput.addEventListener('input', filterCalls);
                operatorFilterInput.addEventListener('change', () => { // <<< ИЗМЕНЕНО: Слушаем 'change' для select'а
                    filterCalls();
                    // Показываем/скрываем кнопку очистки при изменении select'а
                    clearOperatorBtn.style.display = operatorFilterInput.value ? 'inline' : 'none';
                });
            } else {
                 console.error("Элементы для фильтрации звонков (select, clear button) не найдены!");
            }

            // --- Логика для кнопок очистки фильтров ---
            function setupClearButton(inputId, clearBtnId) {
                const input = document.getElementById(inputId); // Может быть input или select
                const clearBtn = document.getElementById(clearBtnId);

                if (!input || !clearBtn) return;

                // Показать/скрыть кнопку при вводе (для text input)
                if (input.tagName.toLowerCase() === 'input') {
                    input.addEventListener('input', () => {
                        clearBtn.style.display = input.value ? 'inline' : 'none';
                    });
                }
                // Для select, показ/скрытие управляется в 'change' и populateOperatorFilter

                // Очистка поля при клике на кнопку
                clearBtn.addEventListener('click', () => {
                    if (input.tagName.toLowerCase() === 'select') {
                         input.value = ''; // Сброс select на "Все операторы"
                    } else {
                         input.value = ''; // Очистка input
                    }
                    clearBtn.style.display = 'none';
                    // Генерируем событие input или change, чтобы обновить фильтрацию
                    const eventType = input.tagName.toLowerCase() === 'select' ? 'change' : 'input';
                    input.dispatchEvent(new Event(eventType, { bubbles: true }));
                });
            }

            setupClearButton('phoneSearch', 'clearPhoneSearch');
            setupClearButton('operatorSelect', 'clearOperatorFilter'); // <<< ИЗМЕНЕНО: Используем ID select'а
            // --- Конец логики для кнопок очистки ---

            // --- Логика для выбора даты ---
            const datePicker = document.getElementById('callLogDatePicker');
            const dateDisplaySpan = document.getElementById('currentCallLogDate');
            const callsCountSpan = document.getElementById('callsCountDisplay')?.querySelector('span'); // Получаем span внутри div
            const operatorStatsContainer = document.getElementById('operatorStatsContainer'); // Получаем контейнер статистики
            const analyticsReportDateDisplay = document.getElementById('analyticsReportDate'); // Переименовываем для ясности
            const analyticsDatePicker = document.getElementById('analyticsDatePicker'); // Новый календарь для аналитики

            // Устанавливаем сегодняшнюю дату по умолчанию
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Месяцы 0-11
            const dd = String(today.getDate()).padStart(2, '0');
            const todayString = `${yyyy}-${mm}-${dd}`;
            if (datePicker) {
                datePicker.value = todayString;
            }

            function updateTableForDate(dateString) {
                console.log('[updateTableForDate] LOG 1: Function called with dateString:', dateString);
                if (!callsTableBody) {
                    console.error('[updateTableForDate] LOG ERROR: callsTableBody element not found. Main log will not load.');
                    return;
                }
                console.log('[updateTableForDate] LOG 2: callsTableBody found:', callsTableBody);

                // Показываем загрузку ТОЛЬКО для основного журнала
                callsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Загрузка основного журнала...</td></tr>';
                console.log('[updateTableForDate] LOG 3: Loading spinner set for main log.');

                const apiUrl = `/api/moscow-calls?date=${dateString}`;
                console.log(`[updateTableForDate] LOG 4: Preparing to fetch from URL: ${apiUrl}`);

                fetch(apiUrl)
                    .then(response => {
                        console.log('[updateTableForDate] LOG 5: Fetch response received. Status:', response.status, 'Ok:', response.ok);
                        if (!response.ok) {
                            // Попытка получить текст ошибки из тела ответа
                            return response.text().then(text => {
                                console.error(`[updateTableForDate] LOG ERROR: Network response was not ok. Status: ${response.status}, Response text: ${text}`);
                                throw new Error(`Ошибка сети: ${response.status}. Детали: ${text || 'Нет деталей'}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('[updateTableForDate] LOG 6: JSON data parsed successfully:', data);
                        callsTableBody.innerHTML = ''; // Очищаем tbody
                        let callCount = 0;

                        if (data && data.success && data.calls && data.calls.length > 0) {
                            console.log('[updateTableForDate] LOG 7A: Data is successful and calls exist. Count:', data.calls.length);
                            callCount = data.calls.length;
                            // ... (код для заполнения таблицы звонков) ...
                            data.calls.forEach(call => {
                                const row = document.createElement('tr');
                                const phoneCell = document.createElement('td');
                                const phoneSpan = document.createElement('span');
                                phoneSpan.className = `phone-number ${!call.phone_number || call.phone_number === 'None' ? 'unknown-number' : ''}`;
                                if (call.phone_number && call.phone_number !== 'None') {
                                    phoneSpan.textContent = call.phone_number;
                                } else {
                                    phoneSpan.innerHTML = '<span style="color: #999; font-style: italic;">Телефон не определен</span>';
                                }
                                phoneCell.appendChild(phoneSpan);
                                const buttonsDiv = document.createElement('div');
                                if (call.has_client_card) {
                                    const clientBtn = document.createElement('button');
                                    clientBtn.className = 'action-btn client-card-btn';
                                    clientBtn.innerHTML = '<i class="fas fa-id-card"></i>Карта клиента';
                                    clientBtn.dataset.callId = call.id;
                                    clientBtn.onclick = () => showClientCard(clientBtn);
                                    buttonsDiv.appendChild(clientBtn);
                                }
                                if (call.pp_id) {
                                    const infoBtn = document.createElement('button');
                                    infoBtn.className = 'action-btn agency-info-btn';
                                    infoBtn.title = 'Информация об обзвоне';
                                    infoBtn.innerHTML = '<i class="fas fa-info-circle"></i>Инфо';
                                    infoBtn.onclick = () => showAgencyInfo(call.pp_id);
                                    buttonsDiv.appendChild(infoBtn);
                                }
                                phoneCell.appendChild(buttonsDiv);
                                row.appendChild(phoneCell);
                                const timeCell = document.createElement('td');
                                timeCell.textContent = call.time || '-';
                                row.appendChild(timeCell);
                                const operatorCell = document.createElement('td');
                                operatorCell.textContent = call.operator || '-';
                                row.appendChild(operatorCell);
                                const resultCell = document.createElement('td');
                                const resultSpan = document.createElement('span');
                                resultSpan.className = 'call-result-badge';
                                switch (call.result) {
                                    case 0: resultSpan.classList.add('result-failed'); break;
                                    case 1: resultSpan.classList.add('result-success'); break;
                                    case 2: resultSpan.classList.add('result-dropped'); break;
                                    case 3: resultSpan.classList.add('result-no-internet'); break;
                                    case 4: case 5: case 6: resultSpan.classList.add('result-failed'); break;
                                    default: resultSpan.classList.add('result-unknown');
                                }
                                resultSpan.textContent = call.call_result_text || '-';
                                resultCell.appendChild(resultSpan);
                                row.appendChild(resultCell);
                                const typeCell = document.createElement('td');
                                typeCell.textContent = call.call_type_text || '-';
                                row.appendChild(typeCell);
                                callsTableBody.appendChild(row);
                            });

                            const allRows = Array.from(callsTableBody.querySelectorAll('tr'));
                            populateOperatorFilter(allRows);
                            console.log('[updateTableForDate] LOG 7B: Attempting to render analytics. Calls data:', data.calls, 'Selected date:', dateString);
                            if (typeof renderDailyAnalyticsReport === 'function') {
                                renderDailyAnalyticsReport(data.calls, dateString);
                            }
                            filterCalls();
                        } else {
                            console.log('[updateTableForDate] LOG 8: No calls data or success:false for main log. Selected date:', dateString, 'Data received:', data);
                            const emptyRow = document.createElement('tr');
                            emptyRow.innerHTML = `<td colspan="5" class="no-calls-message"><i class="fas fa-phone-slash"></i><p>Журнал звонков пуст за ${new Date(dateString + 'T00:00:00').toLocaleDateString('ru-RU')}</p></td>`;
                            callsTableBody.appendChild(emptyRow);
                            // ОТСЮДА УБРАН ВЫЗОВ clearAnalyticsReport
                        }

                        if (callsCountSpan) callsCountSpan.textContent = `Звонков: ${callCount}`;
                        if (dateDisplaySpan) {
                             const selectedDateObj = new Date(dateString + 'T00:00:00');
                             const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
                             dateDisplaySpan.textContent = selectedDateObj.toLocaleDateString('ru-RU', options);
                        }
                        // ОТСЮДА УБРАНО ОБНОВЛЕНИЕ analyticsReportDateSpan
                    })
                    .catch(error => {
                        console.error('[updateTableForDate] LOG 9: Error during fetch promise chain for main log:', error.message, error);
                        callsTableBody.innerHTML = `<tr><td colspan="5" class="error-message"><i class="fas fa-exclamation-triangle"></i> Ошибка загрузки: ${error.message}</td></tr>`;
                        if (callsCountSpan) callsCountSpan.textContent = 'Звонков: Ошибка';
                        if (dateDisplaySpan) dateDisplaySpan.textContent = 'Ошибка загрузки даты';
                        // ОТСЮДА УБРАНО ОБНОВЛЕНИЕ analyticsReportDateSpan И ВЫЗОВ showErrorInAnalyticsReport
                    });
            }

            // --- Новая функция для загрузки статистики операторов ---
            function fetchOperatorStats(dateString) {
                if (!operatorStatsContainer) return;

                // Показываем загрузку
                operatorStatsContainer.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка статистики...';

                fetch(`/api/moscow-operator-stats?date=${dateString}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Ошибка сети: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        operatorStatsContainer.innerHTML = ''; // Очищаем контейнер
                        if (data.success && data.stats && data.stats.length > 0) {
                             const statsList = document.createElement('span'); // Используем span или div
                             statsList.style.display = 'flex'; // Для расположения в ряд
                             statsList.style.gap = '10px'; // Отступы между элементами
                             statsList.style.flexWrap = 'wrap'; // Перенос на новую строку

                             data.stats.forEach(stat => {
                                 const statItem = document.createElement('span');
                                 statItem.style.fontSize = '0.85em';
                                 statItem.style.backgroundColor = '#e9ecef';
                                 statItem.style.padding = '3px 8px';
                                 statItem.style.borderRadius = '4px';
                                 statItem.innerHTML = `<i class="fas fa-user-headset" style="margin-right: 4px; color: #6c757d;"></i>${stat.operator_name}: <strong>${stat.call_count}</strong>`;
                                 statsList.appendChild(statItem);
                             });
                             operatorStatsContainer.appendChild(statsList);
                        } else if (data.success) {
                             operatorStatsContainer.innerHTML = '<span style="font-size: 0.85em; color: #6c757d;">Статистики за день нет</span>';
                        } else {
                            throw new Error(data.error || 'Неизвестная ошибка при получении статистики');
                        }
                    })
                    .catch(error => {
                        console.error('Ошибка загрузки статистики операторов:', error);
                        operatorStatsContainer.innerHTML = `<span style="font-size: 0.85em; color: #dc3545;" title="${error.message}"><i class="fas fa-exclamation-triangle"></i> Ошибка</span>`;
                    });
            }

            // --- Новая функция для загрузки и отображения АНАЛИТИКИ ---
            function fetchAndRenderAnalytics(dateString) {
                console.log('[fetchAndRenderAnalytics] Called for date:', dateString);
                if (!document.getElementById('dailySummaryStats') || !document.getElementById('operatorDetailsTableContainer') || !document.getElementById('callTypeAnalysisTableContainer')) {
                    console.error('[fetchAndRenderAnalytics] Analytics container elements not found.');
                    return;
                }

                // Показываем спиннеры в секциях аналитики
                document.getElementById('dailySummaryStats').innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Загрузка общей статистики...</p>';
                document.getElementById('operatorDetailsTableContainer').innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Загрузка статистики по операторам...</p>';
                document.getElementById('callTypeAnalysisTableContainer').innerHTML = '<p><i class="fas fa-spinner fa-spin"></i> Загрузка анализа по типам звонков...</p>';

                if (analyticsReportDateDisplay) {
                    const dateObj = new Date(dateString + 'T00:00:00');
                    const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
                    analyticsReportDateDisplay.textContent = dateObj.toLocaleDateString('ru-RU', options);
                } else {
                    console.warn('[fetchAndRenderAnalytics] analyticsReportDateDisplay element not found.');
                }

                const apiUrl = `/api/moscow-calls?date=${dateString}`;
                console.log(`[fetchAndRenderAnalytics] Fetching analytics data from: ${apiUrl}`);

                fetch(apiUrl)
                    .then(response => {
                        console.log('[fetchAndRenderAnalytics] Fetch response status:', response.status);
                        if (!response.ok) {
                            return response.text().then(text => {
                                throw new Error(`Ошибка сети при загрузке аналитики: ${response.status}. ${text}`);
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('[fetchAndRenderAnalytics] Data received:', data);
                        if (data && data.success && data.calls) {
                            renderDailyAnalyticsReport(data.calls, dateString);
                        } else {
                            console.warn('[fetchAndRenderAnalytics] No calls data or success:false. Clearing analytics.');
                            clearAnalyticsReport(dateString);
                        }
                    })
                    .catch(error => {
                        console.error('[fetchAndRenderAnalytics] Error:', error.message);
                        showErrorInAnalyticsReport(error.message);
                        if (analyticsReportDateDisplay) {
                            analyticsReportDateDisplay.textContent = 'Ошибка!';
                        }
                    });
            }

            // Загружаем статистику операторов для сегодняшней даты при загрузке страницы
            fetchOperatorStats(todayString);
            // Вызываем первоначальное обновление таблицы основного журнала для сегодняшней даты
            console.log('[DOMContentLoaded] LOG_INIT: About to call updateTableForDate for todayString:', todayString);
            updateTableForDate(todayString);

            // Инициализация и первоначальная загрузка для КАЛЕНДАРЯ АНАЛИТИКИ
            if (analyticsDatePicker) {
                analyticsDatePicker.value = todayString;
                console.log('[DOMContentLoaded] LOG_INIT_ANALYTICS: About to call fetchAndRenderAnalytics for todayString:', todayString);
                fetchAndRenderAnalytics(todayString); // Первоначальная загрузка аналитики

                analyticsDatePicker.addEventListener('change', function() {
                    console.log('[analyticsDatePicker] Date changed to:', this.value);
                    fetchAndRenderAnalytics(this.value);
                });

                // Предотвращаем сворачивание аккордеона при клике на календарь
                analyticsDatePicker.addEventListener('click', function(event) {
                    event.stopPropagation();
                });
            } else {
                console.warn('[DOMContentLoaded] analyticsDatePicker element not found!');
            }

            if (datePicker) {
                 datePicker.addEventListener('change', function() {
                     updateTableForDate(this.value);
                     fetchOperatorStats(this.value); // Вызываем загрузку статистики при смене даты
                 });
            }

            // <<< ДОБАВЛЕНО: Вызов populateOperatorFilter при начальной загрузке страницы >>>
             const initialRows = Array.from(callsTableBody.querySelectorAll('tr'));
             populateOperatorFilter(initialRows);

        }); // Конец основного DOMContentLoaded
        console.log('[DOMContentLoaded] LOG_END: All event listeners and initial calls set up.');
    </script>

    <script>
    console.log('ANALYTICS SCRIPT BLOCK - VERSION_CHECK_001 LOADED'); // TEST LOG
    // Глобальная переменная для хранения данных для аналитики, чтобы не передавать их везде
    let callsDataForAnalytics = [];

    // Добавляем функцию для перенаправления на Яндекс Карты
    function openInYandexMaps(address) {
        if (!address || address === '-') return;

        // Кодируем адрес для URL
        const encodedAddress = encodeURIComponent(address);

        // Формируем URL для Яндекс Карт
        const yandexMapsUrl = `https://yandex.ru/maps/?text=${encodedAddress}`;

        // Открываем в новой вкладке
        window.open(yandexMapsUrl, '_blank');
    }

    // <<< НАЧАЛО ИЗМЕНЕНИЯ: Возвращаем функцию formatAgencyData >>>
    function formatAgencyData(agencyDataArray) { // Переименован параметр для ясности
        if (!agencyDataArray || agencyDataArray.length === 0) {
            return '<div class="error-message"><i class="fas fa-exclamation-circle"></i><p>Информация об обзвоне не найдена</p></div>';
        }

        const agencyData = agencyDataArray[0]; // Берем первую запись, как и раньше

        // Логика отображения, почти полностью взятая из showAgencyDetails
        let html = '<div class="agency-info-card" style="text-align: left;">';

        const displayValue = (value, defaultValue = '-') => value !== null && value !== undefined && value !== '' ? value : defaultValue;
        const displayBool = (value) => value ? 'Да' : 'Нет';

        // ID и Названия
        html += `<div class="info-row"><i class="fas fa-hashtag info-icon hashtag"></i><span class="info-label">ID Агентства:</span><span class="info-value">${displayValue(agencyData.agency_db_id)}</span></div>`;
        html += `<div class="info-row"><i class="fas fa-building info-icon agency"></i><span class="info-label">Название:</span><span class="info-value"><strong>${displayValue(agencyData.agency_name_ru)}</strong></span></div>`;
        html += `<div class="info-row"><i class="fas fa-language info-icon globe"></i><span class="info-label">Название (англ.):</span><span class="info-value"><strong>${displayValue(agencyData.agency_name_en)}</strong></span></div>`;

        // Адрес (кликабельный)
        const address = displayValue(agencyData.agency_address);
        if (address !== '-') {
            html += `<div class="info-row">
                        <i class="fas fa-map-marker-alt info-icon map-marker-alt"></i>
                        <span class="info-label">Адрес:</span>
                        <span class="info-value">
                            <a href="javascript:void(0)"
                               class="map-link"
                               onclick="openInYandexMaps('${address.replace(/'/g, "\\'")}')">
                                ${address}
                                <i class="fas fa-external-link-alt map-link-icon"></i>
                            </a>
                        </span>
                     </div>`;
        } else {
            html += `<div class="info-row"><i class="fas fa-map-marker-alt info-icon map-marker-alt"></i><span class="info-label">Адрес:</span><span class="info-value">-</span></div>`;
        }

        // Город, Метро, Район, Зона, Регион
        html += `<div class="info-row"><i class="fas fa-city info-icon city"></i><span class="info-label">Город:</span><span class="info-value">${displayValue(agencyData.city_name)}</span></div>`;
        html += `<div class="info-row"><i class="fas fa-subway info-icon metro"></i><span class="info-label">Метро:</span><span class="info-value">${displayValue(agencyData.agency_metro_name)}</span></div>`; // Используем agency_metro_name
        html += `<div class="info-row"><i class="fas fa-map-signs info-icon map-signs"></i><span class="info-label">Район города:</span><span class="info-value">${displayValue(agencyData.district_name)}</span></div>`;
        html += `<div class="info-row"><i class="fas fa-map info-icon map"></i><span class="info-label">Зона:</span><span class="info-value">${displayValue(agencyData.area_name)}</span></div>`;
        html += `<div class="info-row"><i class="fas fa-globe-europe info-icon map"></i><span class="info-label">Регион:</span><span class="info-value">${displayValue(agencyData.region_name_from_db)}</span></div>`;

        // Информация о времени и режиме
        html += `<div class="info-row"><i class="fas fa-clock info-icon clock"></i><span class="info-label">Часовой пояс (смещение от Мск):</span><span class="info-value">${displayValue(agencyData.time_zone)}</span></div>`;
        // html += `<div class="info-row"><i class="far fa-calendar-alt info-icon calendar-alt"></i><span class="info-label">Режим работы ID:</span><span class="info-value">${displayValue(agencyData.time_rezhim_id)}</span></div>`; // Закомментировано

        // Булевы флаги
        html += `<div class="info-row"><i class="fas fa-user-check info-icon user-check"></i><span class="info-label">Англ. туристы:</span><span class="info-value">${displayBool(agencyData.english)}</span></div>`;
        html += `<div class="info-row"><i class="fas fa-ticket-alt info-icon ticket-alt"></i><span class="info-label">Продажа билетов:</span><span class="info-value">${displayBool(agencyData.tickets)}</span></div>`;
        html += `<div class="info-row"><i class="fas fa-ban info-icon ban"></i><span class="info-label">"Станция не задана":</span><span class="info-value">${displayBool(agencyData.station_not_set)}</span></div>`;
        html += `<div class="info-row"><i class="fas fa-random info-icon random"></i><span class="info-label">"Перекл. на Мск":</span><span class="info-value">${displayBool(agencyData.switch_msk_agency)}</span></div>`;
        html += `<div class="info-row"><i class="fas fa-credit-card info-icon credit-card"></i><span class="info-label">Прием банк. карт:</span><span class="info-value">${displayBool(agencyData.bank_card)}</span></div>`;
        html += `<div class="info-row"><i class="fas fa-plane-departure info-icon plane-departure"></i><span class="info-label">Туры в Стамбул:</span><span class="info-value">${displayBool(agencyData.stambul)}</span></div>`;
        html += `<div class="info-row"><i class="fas fa-skiing info-icon skiing"></i><span class="info-label">Туры в Австрию:</span><span class="info-value">${displayBool(agencyData.austria)}</span></div>`;

        // Комментарий (Как пройти)
        const commentText = displayValue(agencyData.agency_comment);
        const trimmedComment = commentText !== '-' ? commentText.trim() : '-';
        if (trimmedComment && trimmedComment !== '-') {
            html += `<div class="info-row">
                        <i class="fas fa-directions info-icon directions"></i>
                        <span class="info-label">Как пройти:</span>
                        <span class="info-value">
                            <div style="max-height: 150px; overflow-y: auto; white-space: pre-line; word-break: break-word; padding-right: 5px;">
                                ${trimmedComment}
                            </div>
                        </span>
                     </div>`;
        } else {
             html += `<div class="info-row"><i class="fas fa-directions info-icon"></i><span class="info-label">Как пройти:</span><span class="info-value">-</span></div>`;
        }

        // Телефоны (детализированные)
        if (agencyData.telephones_detailed && agencyData.telephones_detailed.length > 0) {
            let phonesHtml = agencyData.telephones_detailed.map(tel => {
                let phoneEntry = `<i class="fas fa-phone-alt info-icon" style="margin-right: 5px; font-size: 0.9em;"></i>${displayValue(tel.number)}`;
                if (tel.comment && tel.comment !== "NULL") {
                    phoneEntry += ` <small style="color: #555;">(${displayValue(tel.comment)})</small>`;
                }
                // Добавляем отображение режима работы для телефона
                if (tel.work_schedule) {
                    phoneEntry += '<div style="font-size: 0.8em; margin-left: 25px; color: #666;">';
                    const schedule = tel.work_schedule;
                    // Простая группировка для Пн-Пт, если время совпадает
                    let weekdaysSchedule = '';
                    if (schedule.monday && schedule.monday === schedule.tuesday && schedule.monday === schedule.wednesday && schedule.monday === schedule.thursday && schedule.monday === schedule.friday) {
                        weekdaysSchedule = `Пн-Пт: ${schedule.monday}`;
                        phoneEntry += `${weekdaysSchedule}<br>`;
                    } else {
                        if(schedule.monday) phoneEntry += `Пн: ${schedule.monday}<br>`;
                        if(schedule.tuesday) phoneEntry += `Вт: ${schedule.tuesday}<br>`;
                        if(schedule.wednesday) phoneEntry += `Ср: ${schedule.wednesday}<br>`;
                        if(schedule.thursday) phoneEntry += `Чт: ${schedule.thursday}<br>`;
                        if(schedule.friday) phoneEntry += `Пт: ${schedule.friday}<br>`;
                    }
                    if (schedule.saturday) {
                        phoneEntry += `Сб: ${schedule.saturday}<br>`;
                    }
                    if (schedule.sunday) {
                        phoneEntry += `Вс: ${schedule.sunday}`;
                    }
                    // Убираем последний <br> если он есть и за ним ничего нет
                    if (phoneEntry.endsWith('<br>')) {
                        phoneEntry = phoneEntry.slice(0, -4);
                    }
                    phoneEntry += '</div>';
                }
                return phoneEntry;
            }).join('<br style="margin-bottom: 8px; margin-top: 3px;">'); // Увеличим немного отступ между записями о телефонах
            html += `<div class="info-row"><i class="fas fa-phone-square-alt info-icon operator"></i><span class="info-label">Телефоны:</span><span class="info-value">${phonesHtml}</span></div>`;
        } else {
            html += `<div class="info-row"><i class="fas fa-phone-slash info-icon"></i><span class="info-label">Телефоны:</span><span class="info-value">-</span></div>`;
        }

        // Информация о звонке (специфична для formatAgencyData)
        let resultIconClass = 'result-neutral';
        if (agencyData.result === 0) resultIconClass = 'result-success'; // Дозвон
        else if ([ -1, 1, 4, 5].includes(agencyData.result)) resultIconClass = 'result-fail'; // Ошибка, занято, бросили, тишина

        html += `<hr style="margin: 15px 0;">
                 <div class="info-row">
                    <i class="fas fa-phone-alt info-icon ${resultIconClass}"></i>
                    <span class="info-label">Результат звонка:</span>
                    <span class="info-value">${agencyData.call_result_text || '-'}</span>
                </div>
                 <div class="info-row">
                    <i class="fas fa-user-tie info-icon client"></i>
                    <span class="info-label">Клиент (из обзвона):</span>
                    <span class="info-value">${agencyData.client_name || '-'}</span>
                </div>
                <div class="info-row">
                    <i class="fas fa-globe-americas info-icon country"></i>
                    <span class="info-label">Страна (из обзвона):</span>
                    <span class="info-value">${agencyData.client_country || '-'}</span>
                </div>
                <div class="info-row">
                    <i class="fas fa-subway info-icon metro"></i>
                    <span class="info-label">Метро (из обзвона):</span>
                    <span class="info-value">${agencyData.client_metro || '-'}</span>
                </div>
                <div class="info-row">
                    <i class="fas fa-user-tag info-icon manager"></i>
                    <span class="info-label">Менеджер (из обзвона):</span>
                    <span class="info-value">${agencyData.client_manager || '-'}</span>
                </div>
                 <div class="info-row">
                    <i class="fas fa-headset info-icon operator"></i>
                    <span class="info-label">Оператор (звонка):</span>
                    <span class="info-value">${agencyData.call_operator_name || '-'}</span>
                </div>
                 <div class="info-row">
                    <i class="far fa-calendar-alt info-icon datetime"></i>
                    <span class="info-label">Дата и время звонка:</span>
                    <span class="info-value">${agencyData.call_datetime || '-'}</span>
                </div>`;

        html += '</div>'; // Закрываем .agency-info-card
        return html;
    }
    // <<< КОНЕЦ ИЗМЕНЕНИЯ >>>

    // Функция для отображения информации об агентстве (из Журнала звонков)
    function showAgencyInfo(ppId) {
        const modal = document.getElementById('agencyInfoModal');
        const contentDiv = document.getElementById('agencyInfoContent');
        const titleSpan = modal.querySelector('.finesse-modal-title');

        // Обновляем заголовок модального окна, используя иконку
        titleSpan.innerHTML = '<i class="fas fa-building header-icon"></i> Информация об агентстве (из Журнала)';

        contentDiv.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Загрузка данных...</div>';
        // Плавно показываем модальное окно
        modal.style.display = 'flex'; // Используем flex для центрирования
        setTimeout(() => {
             modal.style.opacity = '1';
        }, 10); // Небольшая задержка для срабатывания transition

        fetch(`/api/call-agency-data/${ppId}`)
            .then(response => {
                if (!response.ok) {
                    // Попытаемся прочитать текст ошибки, если это не JSON
                    return response.text().then(text => {
                        throw new Error(`Ошибка сервера: ${response.status} - ${text || 'Без дополнительной информации'}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.agency_data) {
                    // Используем новую функцию для форматирования
                    contentDiv.innerHTML = formatAgencyData(data.agency_data);
                    // Обновляем заголовок модального окна с названием агентства, если оно есть
                    const agencyName = data.agency_data[0]?.agency_name_ru;
                    if (agencyName) {
                         titleSpan.innerHTML = `<i class="fas fa-building header-icon"></i> ${agencyName}`;
                    }
                } else {
                    contentDiv.innerHTML = `<div class="error-message">${data.error || 'Информация не найдена'}</div>`;
                    titleSpan.innerHTML = '<i class="fas fa-exclamation-triangle header-icon"></i> Ошибка загрузки';
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке информации об агентстве:', error);
                contentDiv.innerHTML = `<div class="error-message">Ошибка: ${error.message}</div>`;
                titleSpan.innerHTML = '<i class="fas fa-exclamation-triangle header-icon"></i> Ошибка загрузки';
            });
    }

    // --- Функции для Справочника Агентств ---
    const agencySearchInput = document.getElementById('agencySearchInput');
    const agenciesTableBody = document.getElementById('agenciesTableBody');
    const agenciesCountDisplay = document.getElementById('agenciesCountDisplay').querySelector('span');
    const agenciesStatusBar = document.getElementById('agenciesStatusBar');
    const clearAgencySearchBtn = document.getElementById('clearAgencySearch');
    const refreshAgenciesBtn = document.getElementById('refreshAgenciesBtn');
    const agencyDirectoryInfoSpan = document.getElementById('agencyDirectoryInfoSpan');
    let agencyDataCache = []; // Кэш для данных справочника
    let isCacheHoldingFullList = false; // <--- НОВЫЙ ФЛАГ
    let fetchAgenciesController = null; // Для отмены предыдущего запроса

    function showLoadingAgencies(message = "Загрузка справочника агентств...") {
        agenciesStatusBar.style.display = 'block';
        agenciesStatusBar.innerHTML = `<i class="fas fa-spinner fa-spin status-icon"></i><span class="status-message">${message}</span>`;
        agenciesTableBody.innerHTML = ''; // Очищаем таблицу на время загрузки
        agenciesCountDisplay.textContent = 'Найдено: 0';
    }

    function hideLoadingAgencies() {
        agenciesStatusBar.style.display = 'none';
    }

    function renderAgenciesTable(agencies) {
        agenciesTableBody.innerHTML = ''; // Очищаем перед рендерингом
        if (agencies.length === 0) {
            const noResultsRow = `<tr><td colspan="7" style="text-align:center; padding: 20px;"><i class="fas fa-search-minus" style="font-size: 1.5em; margin-bottom: 10px;"></i><p>Агентства не найдены по вашему запросу.</p></td></tr>`;
            agenciesTableBody.innerHTML = noResultsRow;
            agenciesCountDisplay.textContent = 'Найдено: 0';
            return;
        }

        agencies.forEach(agency => {
            const row = document.createElement('tr');

            // Ячейка для Названия (RU + EN)
            const nameCell = row.insertCell();
            let nameHtml = '';
            if (agency.NAME_RU) {
                nameHtml += `<strong>${agency.NAME_RU}</strong>`;
            } else {
                nameHtml += '<strong>-</strong>'; // Если нет русского названия
            }
            if (agency.NAME_EN) {
                nameHtml += `<br><small style="color: #555;">${agency.NAME_EN}</small>`;
            }
            nameCell.innerHTML = nameHtml; // Убрана иконка fas fa-building

            // Ячейка для Адреса
            row.insertCell().textContent = agency.ADDRESS || '-';
            // Ячейка для Города
            row.insertCell().textContent = agency.CITY_NAME || '-';
            // Ячейка для Метро
            row.insertCell().textContent = agency.METRO_STATION_NAME || '-';

            // Ячейка для Телефонов
            const phonesCell = row.insertCell();
            let phonesDisplay = '-';
            // Эндпоинт /api/agencies сейчас возвращает telephone_1_number
            // Поэтому TELEPHONES_DETAILED не будет доступно здесь без доработки Python кода
            if (agency.telephone_1_number) {
                phonesDisplay = agency.telephone_1_number;
            }
            phonesCell.innerHTML = phonesDisplay;

            // Ячейка для Района
            row.insertCell().textContent = agency.DISTRICT_NAME || '-';

            // Ячейка для Действий
            const actionsCell = row.insertCell();
            actionsCell.innerHTML = `
                <button class="action-btn agency-detail-btn" title="Подробная информация об агентстве" onclick="showAgencyDetails(${agency.ID_TR})" style="background-color: #e0f2ff; color: #004085; border-color: #b8daff;">
                    <i class="fas fa-eye"></i>Подробнее...
                </button>
            `;

            agenciesTableBody.appendChild(row);
        });
        agenciesCountDisplay.textContent = `Найдено: ${agencies.length}`;
    }

    function filterAgencies() {
        const query = agencySearchInput.value.toLowerCase().trim();
        clearAgencySearchBtn.style.display = query ? 'inline' : 'none';

        if (!query) {
            renderAgenciesTable(agencyDataCache); // Показываем все из кэша, если запрос пуст
            return;
        }

        const filteredAgencies = agencyDataCache.filter(agency => {
            const queryLower = query.toLowerCase(); // Кэшируем значение в нижнем регистре
            return (agency.NAME_RU && agency.NAME_RU.toLowerCase().includes(queryLower)) ||
                   (agency.NAME_EN && agency.NAME_EN.toLowerCase().includes(queryLower)) || // Добавлен поиск по NAME_EN
                   (agency.ADDRESS && agency.ADDRESS.toLowerCase().includes(queryLower)) ||
                   (agency.CITY_NAME && agency.CITY_NAME.toLowerCase().includes(queryLower)) ||
                   (agency.METRO_STATION_NAME && agency.METRO_STATION_NAME.toLowerCase().includes(queryLower)) ||
                   (agency.DISTRICT_NAME && agency.DISTRICT_NAME.toLowerCase().includes(queryLower)) ||
                   (agency.ALL_TELEPHONES_CONCAT && agency.ALL_TELEPHONES_CONCAT.toLowerCase().includes(queryLower)); // Поиск по всем конкатенированным телефонам
        });
        renderAgenciesTable(filteredAgencies);
    }

    function fetchAgencies(forceRefresh = false, searchTerm = '') {
        console.log(`[fetchAgencies] Called. forceRefresh: ${forceRefresh}, searchTerm: '${searchTerm}', isCacheHoldingFullList: ${isCacheHoldingFullList}`);
        if (fetchAgenciesController) {
            fetchAgenciesController.abort();
        }
        fetchAgenciesController = new AbortController();
        const signal = fetchAgenciesController.signal;

        // Используем кэш только если он содержит ПОЛНЫЙ список, не требуется принудительное обновление и нет поискового запроса
        if (isCacheHoldingFullList && !forceRefresh && !searchTerm) {
            console.log('[fetchAgencies] Using FULL LIST cache. Cache size:', agencyDataCache.length);
            renderAgenciesTable(agencyDataCache);
            const cachedTimestamp = localStorage.getItem('agencyCacheTimestamp');
            agencyDirectoryInfoSpan.textContent = cachedTimestamp ? `Данные от ${cachedTimestamp}` : 'Данные из кэша (полный список)';
            return;
        }

        showLoadingAgencies(searchTerm ? "Поиск агентств..." : (forceRefresh ? "Принудительное обновление..." : "Загрузка справочника..."));

        let apiUrl = '/api/agencies';
        if (searchTerm) {
            apiUrl += `?search=${encodeURIComponent(searchTerm)}`;
        }

        fetch(apiUrl, { signal })
            .then(response => {
                console.log(`[fetchAgencies] API response status for ${apiUrl}: ${response.status}`);
                if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                return response.json();
            })
            .then(data => {
                fetchAgenciesController = null;
                hideLoadingAgencies();
                if (data.success && data.agencies) {
                    console.log('[fetchAgencies] Data received from API. Count:', data.agencies.length);
                    agencyDataCache = data.agencies;
                    if (!searchTerm) { // Это был запрос на полный список
                        isCacheHoldingFullList = true;
                        const timestamp = new Date().toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        localStorage.setItem('agencyCacheTimestamp', timestamp);
                        agencyDirectoryInfoSpan.textContent = `Данные обновлены: ${timestamp}`;
                    } else { // Это был запрос с фильтром
                        isCacheHoldingFullList = false;
                        agencyDirectoryInfoSpan.textContent = 'Результаты поиска';
                    }
                    renderAgenciesTable(agencyDataCache);
                } else {
                    agenciesTableBody.innerHTML = `<tr><td colspan="7" class="error-message">${data.error || 'Не удалось загрузить справочник'}</td></tr>`;
                    agencyDirectoryInfoSpan.textContent = 'Ошибка загрузки';
                    isCacheHoldingFullList = false; // Сбрасываем флаг при ошибке данных
                }
            })
            .catch(error => {
                fetchAgenciesController = null;
                if (error.name === 'AbortError') {
                    console.log('Fetch agencies aborted');
                    return;
                }
                hideLoadingAgencies();
                console.error('Ошибка при загрузке справочника агентств:', error);
                agenciesTableBody.innerHTML = `<tr><td colspan="7" class="error-message">Ошибка: ${error.message}</td></tr>`;
                agencyDirectoryInfoSpan.textContent = 'Ошибка загрузки';
                isCacheHoldingFullList = false; // Сбрасываем флаг при ошибке сети/обработки
            });
    }

    function showAgencyDetails(agencyId) {
        const modal = document.getElementById('agencyDetailModal');
        const contentDiv = document.getElementById('agencyDetailContent');
        const titleSpan = modal.querySelector('.finesse-modal-title');

        // Reset title and show loading spinner
        titleSpan.innerHTML = '<i class="fas fa-building header-icon"></i> Информация об агентстве';
        contentDiv.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Загрузка детальной информации...</div>';
        modal.style.display = 'flex';
        setTimeout(() => { modal.style.opacity = '1'; }, 10); // For smooth appearance

        fetch(`/api/agency-details/${agencyId}`)
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || `Ошибка HTTP: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success && data.agency_details) {
                    contentDiv.innerHTML = formatDetailedAgencyData(data.agency_details);
                    // Используем data.agency_details.name (или NAME_RU если сервер его так отдает после всех преобразований)
                    // По текущей структуре get_agency_details отдает 'name' для русского названия
                    const agencyName = data.agency_details.name || data.agency_details.NAME_RU;
                    if (agencyName) {
                        titleSpan.innerHTML = `<i class="fas fa-building header-icon"></i> ${agencyName}`;
                    } else {
                        titleSpan.innerHTML = '<i class="fas fa-building header-icon"></i> Детали агентства';
                    }
                } else {
                    contentDiv.innerHTML = `<div class="error-message">${data.error || 'Не удалось загрузить детали агентства.'}</div>`;
                    titleSpan.innerHTML = '<i class="fas fa-exclamation-triangle header-icon"></i> Ошибка данных';
                }
            })
            .catch(error => {
                console.error('Ошибка при загрузке деталей агентства:', error);
                contentDiv.innerHTML = `<div class="error-message">Ошибка при загрузке: ${error.message}</div>`;
                titleSpan.innerHTML = '<i class="fas fa-exclamation-triangle header-icon"></i> Ошибка загрузки';
            });
    }

    function formatDetailedAgencyData(agency) {
        let html = '<div class="agency-info-card" style="text-align: left;">';
        const displayValue = (value, defaultValue = '-') => value !== null && value !== undefined && value !== '' ? value : defaultValue;
        const displayBool = (value) => value ? 'Да' : 'Нет';

        html += `<div class="info-row"><i class="fas fa-hashtag info-icon hashtag"></i><span class="info-label">ID (ID_TR):</span><span class="info-value">${displayValue(agency.id)}</span></div>`; // Было agency.ID_TR
        html += `<div class="info-row"><i class="fas fa-building info-icon agency"></i><span class="info-label">Название (RU):</span><span class="info-value"><strong>${displayValue(agency.name)}</strong></span></div>`; // Было agency.NAME_RU
        html += `<div class="info-row"><i class="fas fa-language info-icon globe"></i><span class="info-label">Название (EN):</span><span class="info-value"><strong>${displayValue(agency.english_name)}</strong></span></div>`; // Было agency.NAME_EN

        const address = displayValue(agency.adres); // Было agency.ADDRESS
        if (address !== '-') {
             html += `<div class="info-row">
                        <i class="fas fa-map-marker-alt info-icon map-marker-alt"></i>
                        <span class="info-label">Адрес:</span>
                        <span class="info-value">
                            <a href="javascript:void(0)"
                               class="map-link"
                               onclick="openInYandexMaps('${address.replace(/'/g, "\\'")}')">
                                ${address}
                                <i class="fas fa-external-link-alt map-link-icon"></i>
                            </a>
                        </span>
                     </div>`;
        } else {
            html += `<div class="info-row"><i class="fas fa-map-marker-alt info-icon map-marker-alt"></i><span class="info-label">Адрес:</span><span class="info-value">-</span></div>`;
        }

        html += `<div class="info-row"><i class="fas fa-city info-icon city"></i><span class="info-label">Город:</span><span class="info-value">${displayValue(agency.city_name)}</span></div>`; // Было agency.CITY_NAME
        html += `<div class="info-row"><i class="fas fa-subway info-icon metro"></i><span class="info-label">Метро:</span><span class="info-value">${displayValue(agency.metro_name)}</span></div>`; // Было agency.METRO_STATION_NAME
        html += `<div class="info-row"><i class="fas fa-map-signs info-icon map-signs"></i><span class="info-label">Район города:</span><span class="info-value">${displayValue(agency.district_name)}</span></div>`; // Было agency.DISTRICT_NAME
        html += `<div class="info-row"><i class="fas fa-map info-icon map"></i><span class="info-label">Зона:</span><span class="info-value">${displayValue(agency.area_name)}</span></div>`; // Было agency.AREA_NAME
        html += `<div class="info-row"><i class="fas fa-globe-europe info-icon map"></i><span class="info-label">Регион:</span><span class="info-value">${displayValue(agency.region_name_from_db || agency.region_name)}</span></div>`;

        html += `<div class="info-row"><i class="fas fa-clock info-icon clock"></i><span class="info-label">Часовой пояс (смещение):</span><span class="info-value">${displayValue(agency.time_zone)}</span></div>`; // Было agency.TIME_ZONE

        html += `<div class="info-row"><i class="fas fa-user-check info-icon user-check"></i><span class="info-label">Англ. туристы:</span><span class="info-value">${displayBool(agency.english)}</span></div>`; // Было agency.ENGLISH
        html += `<div class="info-row"><i class="fas fa-ticket-alt info-icon ticket-alt"></i><span class="info-label">Продажа билетов:</span><span class="info-value">${displayBool(agency.tickets)}</span></div>`; // Было agency.TICKETS
        html += `<div class="info-row"><i class="fas fa-ban info-icon ban"></i><span class="info-label">"Станция не задана":</span><span class="info-value">${displayBool(agency.station_not_set)}</span></div>`; // Было agency.STATION_NOT_SET
        html += `<div class="info-row"><i class="fas fa-random info-icon random"></i><span class="info-label">"Перекл. на Мск":</span><span class="info-value">${displayBool(agency.switch_msk_agency)}</span></div>`; // Было agency.SWITCH_MSK_AGENCY
        html += `<div class="info-row"><i class="fas fa-credit-card info-icon credit-card"></i><span class="info-label">Прием банк. карт:</span><span class="info-value">${displayBool(agency.bank_card)}</span></div>`; // Было agency.BANK_CARD
        html += `<div class="info-row"><i class="fas fa-plane-departure info-icon plane-departure"></i><span class="info-label">Туры в Стамбул:</span><span class="info-value">${displayBool(agency.stambul)}</span></div>`; // Было agency.STAMBUL
        html += `<div class="info-row"><i class="fas fa-skiing info-icon skiing"></i><span class="info-label">Туры в Австрию:</span><span class="info-value">${displayBool(agency.austria)}</span></div>`; // Было agency.AUSTRIA

        const commentText = displayValue(agency.comment); // Уже исправлено
        const trimmedComment = commentText !== '-' ? commentText.trim() : '-';
        if (trimmedComment && trimmedComment !== '-') {
             html += `<div class="info-row">
                        <i class="fas fa-directions info-icon directions"></i>
                        <span class="info-label">Как пройти:</span>
                        <span class="info-value">
                            <div style="max-height: 150px; overflow-y: auto; white-space: pre-line; word-break: break-word; padding-right: 5px;">
                                ${trimmedComment}
                            </div>
                        </span>
                     </div>`;
        } else {
             html += `<div class="info-row"><i class="fas fa-directions info-icon"></i><span class="info-label">Как пройти:</span><span class="info-value">-</span></div>`;
        }


        if (agency.telephones && agency.telephones.length > 0) { // Исправлено с agency.TELEPHONES_DETAILED
            let phonesHtml = agency.telephones.map(tel => {
                let phoneEntry = `<i class="fas fa-phone-alt info-icon" style="margin-right: 5px; font-size: 0.9em;"></i>${displayValue(tel.number)}`;
                if (tel.comment && tel.comment !== "NULL") {
                    phoneEntry += ` <small style="color: #555;">(${displayValue(tel.comment)})</small>`;
                }
                // Добавляем отображение режима работы для телефона
                if (tel.work_schedule) {
                    phoneEntry += '<div style="font-size: 0.8em; margin-left: 25px; color: #666;">';
                    const schedule = tel.work_schedule;
                    // Простая группировка для Пн-Пт, если время совпадает
                    let weekdaysSchedule = '';
                    if (schedule.monday && schedule.monday === schedule.tuesday && schedule.monday === schedule.wednesday && schedule.monday === schedule.thursday && schedule.monday === schedule.friday) {
                        weekdaysSchedule = `Пн-Пт: ${schedule.monday}`;
                        phoneEntry += `${weekdaysSchedule}<br>`;
                    } else {
                        if(schedule.monday) phoneEntry += `Пн: ${schedule.monday}<br>`;
                        if(schedule.tuesday) phoneEntry += `Вт: ${schedule.tuesday}<br>`;
                        if(schedule.wednesday) phoneEntry += `Ср: ${schedule.wednesday}<br>`;
                        if(schedule.thursday) phoneEntry += `Чт: ${schedule.thursday}<br>`;
                        if(schedule.friday) phoneEntry += `Пт: ${schedule.friday}<br>`;
                    }
                    if (schedule.saturday) {
                        phoneEntry += `Сб: ${schedule.saturday}<br>`;
                    }
                    if (schedule.sunday) {
                        phoneEntry += `Вс: ${schedule.sunday}`;
                    }
                    // Убираем последний <br> если он есть и за ним ничего нет
                    if (phoneEntry.endsWith('<br>')) {
                        phoneEntry = phoneEntry.slice(0, -4);
                    }
                    phoneEntry += '</div>';
                }
                return phoneEntry;
            }).join('<br style="margin-bottom: 8px; margin-top: 3px;">');
            html += `<div class="info-row"><i class="fas fa-phone-square-alt info-icon operator"></i><span class="info-label">Телефоны:</span><span class="info-value">${phonesHtml}</span></div>`;
        } else {
            html += `<div class="info-row"><i class="fas fa-phone-slash info-icon"></i><span class="info-label">Телефоны:</span><span class="info-value">-</span></div>`;
        }

        html += '</div>'; // Закрываем .agency-info-card
        return html;
    }


    function closeAgencyDetailModal() {
        const modal = document.getElementById('agencyDetailModal');
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.style.display = 'none';
            modal.style.opacity = '';
        }, 200);
    }


    // Инициализация справочника при загрузке DOM
    document.addEventListener('DOMContentLoaded', function() {
        // Загрузка справочника (использует кэш или фетчит)
        fetchAgencies(); // Первоначальная загрузка без поискового запроса

        if (agencySearchInput) {
            agencySearchInput.addEventListener('input', function() {
                const query = this.value.trim();
                console.log(`[Input Event] Query: '${query}'`); // DEBUG
                clearAgencySearchBtn.style.display = query ? 'inline' : 'none';
                // Вызываем fetchAgencies с поисковым запросом (даже если он пустой,
                // fetchAgencies теперь корректно обработает это и загрузит полный список или из кэша)
                fetchAgencies(false, query); // Вызываем fetchAgencies с поисковым запросом
            });
        }
        if (clearAgencySearchBtn) {
            clearAgencySearchBtn.addEventListener('click', () => {
                agencySearchInput.value = '';
                clearAgencySearchBtn.style.display = 'none';
                fetchAgencies(false, ''); // Изменено с filterAgencies()
            });
        }
        if (refreshAgenciesBtn) {
            refreshAgenciesBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const icon = refreshAgenciesBtn.querySelector('i');
                if (icon) icon.classList.add('fa-spin');
                fetchAgencies(true); // Принудительное обновление
                setTimeout(() => {
                    if (icon) icon.classList.remove('fa-spin');
                }, 1500); // Даем время на загрузку
            });
        }
    });
     // --- Конец функций для Справочника Агентств ---

    // --- Начало Аналитики звонков ---
    function renderDailyAnalyticsReport(calls, dateString) {
        console.log('[renderDailyAnalyticsReport] Called with calls:', calls, 'and date:', dateString);
        callsDataForAnalytics = calls; // Сохраняем данные глобально для этой функции

        const generalStatsContainer = document.getElementById('dailySummaryStats');
        const operatorDetailsContainer = document.getElementById('operatorDetailsTableContainer');
        const callTypeAnalysisContainer = document.getElementById('callTypeAnalysisTableContainer');

        if (!generalStatsContainer || !operatorDetailsContainer || !callTypeAnalysisContainer) {
            console.error('Один или несколько контейнеров для аналитики не найдены!');
            return;
        }

        // Обновляем дату в заголовке панели аналитики
        const analyticsReportDateDisplay = document.getElementById('analyticsReportDate');
        if (analyticsReportDateDisplay) {
            const dateObj = new Date(dateString + 'T00:00:00'); // Гарантируем правильный парсинг даты
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            analyticsReportDateDisplay.textContent = dateObj.toLocaleDateString('ru-RU', options);
        }


        if (!calls || calls.length === 0) {
            const noDataMessage = `<p style="text-align:center; color:#6c757d;"><i class="fas fa-info-circle"></i> Нет данных для анализа за выбранный день.</p>`;
            generalStatsContainer.innerHTML = noDataMessage;
            operatorDetailsContainer.innerHTML = noDataMessage;
            callTypeAnalysisContainer.innerHTML = noDataMessage;
            return;
        }

        // 1. Общая статистика
        renderGeneralStats(calls, generalStatsContainer);

        // 2. Детализация по операторам
        renderOperatorDetails(calls, operatorDetailsContainer);

        // 3. Анализ результативности по типам звонков
        renderCallTypeAnalysis(calls, callTypeAnalysisContainer);
    }

    function clearAnalyticsReport(dateString) {
        const generalStatsContainer = document.getElementById('dailySummaryStats');
        const operatorDetailsContainer = document.getElementById('operatorDetailsTableContainer');
        const callTypeAnalysisContainer = document.getElementById('callTypeAnalysisTableContainer');
        const analyticsReportDateDisplay = document.getElementById('analyticsReportDate');

        const dateObj = new Date(dateString + 'T00:00:00');
        const formattedDate = dateObj.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const noDataMessage = `<p style="text-align:center; color:#6c757d;"><i class="fas fa-info-circle"></i> Нет данных для анализа за ${formattedDate}.</p>`;

        if (generalStatsContainer) generalStatsContainer.innerHTML = noDataMessage;
        if (operatorDetailsContainer) operatorDetailsContainer.innerHTML = noDataMessage;
        if (callTypeAnalysisContainer) callTypeAnalysisContainer.innerHTML = noDataMessage;
        if (analyticsReportDateDisplay) analyticsReportDateDisplay.textContent = formattedDate;
    }

    function showErrorInAnalyticsReport(errorMessage) {
        const generalStatsContainer = document.getElementById('dailySummaryStats');
        const operatorDetailsContainer = document.getElementById('operatorDetailsTableContainer');
        const callTypeAnalysisContainer = document.getElementById('callTypeAnalysisTableContainer');
        const analyticsReportDateDisplay = document.getElementById('analyticsReportDate');

        const errorHtml = `<p style="text-align:center; color:#dc3545;"><i class="fas fa-exclamation-triangle"></i> Ошибка загрузки аналитики: ${errorMessage}</p>`;

        if (generalStatsContainer) generalStatsContainer.innerHTML = errorHtml;
        if (operatorDetailsContainer) operatorDetailsContainer.innerHTML = errorHtml;
        if (callTypeAnalysisContainer) callTypeAnalysisContainer.innerHTML = errorHtml;
        if (analyticsReportDateDisplay) analyticsReportDateDisplay.textContent = 'Ошибка!';
    }


    function renderGeneralStats(calls, container) {
        const totalCalls = calls.length;
        const successfulCalls = calls.filter(call => call.result === 1).length; // Успешный результат = 1
        const failedCalls = calls.filter(call => call.result === 0 || call.result === 4 || call.result === 5 || call.result === 6).length; // Неуспешный результат (добавим разные коды)
        const droppedCalls = calls.filter(call => call.result === 2).length; // Клиент положил трубку = 2
        const noInternetCalls = calls.filter(call => call.result === 3).length; // Нет интернета = 3

        let html = '<ul>';
        html += `<li>Общее количество звонков: <strong>${totalCalls}</strong></li>`;
        html += `<li>Успешных звонков (дозвон): <strong>${successfulCalls}</strong> (${((successfulCalls / totalCalls) * 100 || 0).toFixed(1)}%)</li>`;
        html += `<li>Неуспешных звонков (недозвон/занято/тишина): <strong>${failedCalls}</strong> (${((failedCalls / totalCalls) * 100 || 0).toFixed(1)}%)</li>`;
        html += `<li>Клиент положил трубку: <strong>${droppedCalls}</strong> (${((droppedCalls / totalCalls) * 100 || 0).toFixed(1)}%)</li>`;
        if (noInternetCalls > 0) { // Показываем только если были такие звонки
             html += `<li>"Нет интернета": <strong>${noInternetCalls}</strong> (${((noInternetCalls / totalCalls) * 100 || 0).toFixed(1)}%)</li>`;
        }
        html += '</ul>';
        container.innerHTML = html;
    }

    function renderOperatorDetails(calls, container) {
        const operatorStats = {};
        calls.forEach(call => {
            const operator = call.operator || 'Неизвестный оператор';
            if (!operatorStats[operator]) {
                operatorStats[operator] = { total: 0, successful: 0, failed: 0, dropped: 0, noInternet: 0 };
            }
            operatorStats[operator].total++;
            if (call.result === 1) operatorStats[operator].successful++;
            else if (call.result === 0 || call.result === 4 || call.result === 5 || call.result === 6) operatorStats[operator].failed++;
            else if (call.result === 2) operatorStats[operator].dropped++;
            else if (call.result === 3) operatorStats[operator].noInternet++;
        });

        let tableHtml = '<table class="analytics-table">';
        tableHtml += '<thead><tr><th>Оператор</th><th>Всего звонков</th><th>Успешных</th><th>Неуспешных</th><th>Сброшено клиентом</th><th>"Нет интернета"</th><th>% Успеха</th></tr></thead><tbody>';

        for (const operator in operatorStats) {
            const stats = operatorStats[operator];
            const successRate = ((stats.successful / stats.total) * 100 || 0).toFixed(1);
            tableHtml += `<tr>
                <td>${operator}</td>
                <td>${stats.total}</td>
                <td>${stats.successful}</td>
                <td>${stats.failed}</td>
                <td>${stats.dropped}</td>
                <td>${stats.noInternet > 0 ? stats.noInternet : '-'}</td>
                <td>
                    <div class="percentage-bar-container" title="${successRate}%">
                        <div class="percentage-bar success" style="width: ${successRate}%;"></div>
                    </div>
                    <span class="percentage-text">${successRate}%</span>
                </td>
            </tr>`;
        }
        tableHtml += '</tbody></table>';
        container.innerHTML = tableHtml;
    }

    function renderCallTypeAnalysis(calls, container) {
        const callTypeStats = {};
        calls.forEach(call => {
            const type = call.call_type_text || 'Неизвестный тип';
            if (!callTypeStats[type]) {
                callTypeStats[type] = { total: 0, successful: 0, failed: 0, dropped: 0, noInternet: 0 };
            }
            callTypeStats[type].total++;
            if (call.result === 1) callTypeStats[type].successful++;
            else if (call.result === 0 || call.result === 4 || call.result === 5 || call.result === 6) callTypeStats[type].failed++;
            else if (call.result === 2) callTypeStats[type].dropped++;
            else if (call.result === 3) callTypeStats[type].noInternet++;
        });

        let tableHtml = '<table class="analytics-table">';
        tableHtml += '<thead><tr><th>Тип звонка</th><th>Всего</th><th>Успешных</th><th>Неуспешных</th><th>Сброшено</th><th>"Нет интернета"</th><th>% Успеха</th></tr></thead><tbody>';

        for (const type in callTypeStats) {
            const stats = callTypeStats[type];
            const successRate = ((stats.successful / stats.total) * 100 || 0).toFixed(1);
             // Определяем класс для прогресс-бара в зависимости от успешности
            let barClass = 'success'; // Зеленый по умолчанию
            if (successRate < 30) barClass = 'failed'; // Красный, если < 30%
            else if (successRate < 60) barClass = 'dropped'; // Желтый, если < 60%

            tableHtml += `<tr>
                <td>${type}</td>
                <td>${stats.total}</td>
                <td>${stats.successful}</td>
                <td>${stats.failed}</td>
                <td>${stats.dropped}</td>
                <td>${stats.noInternet > 0 ? stats.noInternet : '-'}</td>
                <td>
                     <div class="percentage-bar-container" title="${successRate}%">
                        <div class="percentage-bar ${barClass}" style="width: ${successRate}%;"></div>
                    </div>
                    <span class="percentage-text">${successRate}%</span>
                </td>
            </tr>`;
        }
        tableHtml += '</tbody></table>';
        container.innerHTML = tableHtml;
    }
    // --- Конец Аналитики звонков ---

    // --- Начало Динамики звонков по месяцам (Chart.js) ---
    let monthlyCallsChartInstance = null; // Для хранения экземпляра диаграммы

    // Вспомогательная функция для получения названия месяца
    function getMonthName(monthNumber, type = 'short') {
        const date = new Date();
        date.setMonth(monthNumber - 1); // месяцы в JS 0-индексированные
        const locale = 'ru-RU';
        if (type === 'full') {
            return date.toLocaleString(locale, { month: 'long' });
        }
        return date.toLocaleString(locale, { month: 'short' });
    }

    function renderMonthlyCallsChart(data) {
        const chartContainer = document.getElementById('monthlyCallsChartContainer');
        const chartLoadingStatus = document.getElementById('chartLoadingStatus');
        const chartStatsSummaryContainer = document.getElementById('chartStatsSummary');
        const yearlyMonthlyStatsTableContainer = document.getElementById('yearlyMonthlyStatsTable');

        if (!chartContainer || !chartLoadingStatus || !chartStatsSummaryContainer || !yearlyMonthlyStatsTableContainer) {
            console.error("Элементы для диаграммы или статистики по месяцам не найдены.");
            if(chartLoadingStatus) chartLoadingStatus.innerHTML = '<p style="color:red;">Ошибка: Не найдены все необходимые HTML элементы для диаграммы.</p>';
            return;
        }

        if (!data || data.length === 0) {
            chartLoadingStatus.innerHTML = '<p style="color:#6c757d;"><i class="fas fa-info-circle"></i> Нет данных для построения диаграммы.</p>';
            chartContainer.style.display = 'none';
            chartStatsSummaryContainer.innerHTML = '';
            yearlyMonthlyStatsTableContainer.innerHTML = '';
            return;
        }

        chartContainer.style.display = 'block';
        chartLoadingStatus.style.display = 'none';

        // Используем getMonthName и item.count
        const labels = data.map(item => `${getMonthName(item.month, 'short')} ${item.year}`);
        const totalCalls = data.map(item => item.count); // Используем item.count

        const canvas = document.getElementById('monthlyCallsChart');
        // Рассчитываем минимальную ширину для канваса, чтобы столбцы не были слишком узкими
        const minBarWidth = 45; // Увеличено с 30 до 45
        const calculatedWidth = labels.length * minBarWidth;
        canvas.style.width = `${calculatedWidth}px`;
        // Высота задается через родительский контейнер (40vh), Chart.js подстроится
        // canvas.style.height = '300px'; // или фиксированная высота если vh не подходит

        const ctx = canvas.getContext('2d');

        if (monthlyCallsChartInstance) {
            monthlyCallsChartInstance.destroy();
        }

        monthlyCallsChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Всего звонков',
                    data: totalCalls,
                    backgroundColor: 'rgba(144, 238, 144, 0.6)', // Мягкий светло-зеленый
                    borderColor: 'rgba(34, 139, 34, 0.8)', // Темно-зеленый для контура
                    borderWidth: 1,
                    borderRadius: 5, // Скругление углов
                    borderSkipped: false // Применяем скругление ко всем углам
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Количество звонков'
                        }
                    },
                    x: {
                         title: {
                            display: true,
                            text: 'Месяц и Год'
                        }
                        // Убираем объект ticks, чтобы Chart.js использовал autoSkip по умолчанию
                        // ticks: {
                        //     autoSkip: false,
                        //     maxRotation: 60,
                        //     minRotation: 60,
                        // }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Динамика общего количества звонков по месяцам' // Обновлен заголовок
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                    }
                },
                onClick: (event, elements) => {
                    if (elements.length > 0) {
                        const chartElement = elements[0];
                        const index = chartElement.index;
                        const year = data[index].year;
                        const month = data[index].month;
                        console.log(`Клик по: ${getMonthName(data[index].month, 'short')} ${year} (Месяц: ${month})`);
                    }
                }
            }
        });

        // Прокрутка к текущему году
        const currentYear = new Date().getFullYear();
        let currentYearIndex = -1;
        for(let i = 0; i < data.length; i++) {
            if(data[i].year === currentYear) {
                currentYearIndex = i;
                break;
            }
        }
        if (currentYearIndex !== -1) {
            // Примерная позиция для прокрутки. Точное позиционирование может потребовать chart.scales.x.getPixelForValue
            // Это более простой подход, который должен работать для большинства случаев
            const scrollPosition = currentYearIndex * minBarWidth - (chartContainer.clientWidth / 2) + (minBarWidth / 2);
            chartContainer.scrollLeft = Math.max(0, scrollPosition);
        }

        renderChartStatsSummary(data, chartStatsSummaryContainer);
        renderYearlyMonthlyTable(data, yearlyMonthlyStatsTableContainer);
    }

    function renderChartStatsSummary(data, container) {
        if (!data || data.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#6c757d;"><i class="fas fa-info-circle"></i> Нет данных для сводной статистики.</p>';
            return;
        }

        let minYear = Infinity, maxYear = -Infinity;
        let minMonthInMinYear = 12, maxMonthInMaxYear = 1;
        let totalCalls = 0;
        let peakCalls = -1, peakYear = 0, peakMonth = 0;
        let minCalls = Infinity, minYearA = 0, minMonthA = 0;
        const callsByYearMonth = {}; // Для подсчета за последние 12 мес

        data.forEach(item => {
            const year = parseInt(item.year, 10);
            const month = parseInt(item.month, 10);
            const count = parseInt(item.count, 10);

            totalCalls += count;

            if (year < minYear) {
                minYear = year;
                minMonthInMinYear = month;
            } else if (year === minYear && month < minMonthInMinYear) {
                minMonthInMinYear = month;
            }

            if (year > maxYear) {
                maxYear = year;
                maxMonthInMaxYear = month;
            } else if (year === maxYear && month > maxMonthInMaxYear) {
                maxMonthInMaxYear = month;
            }

            if (count > peakCalls) {
                peakCalls = count;
                peakYear = year;
                peakMonth = month;
            }
            // Для минимальной активности, учитываем только если были звонки
            if (count > 0 && count < minCalls) {
                minCalls = count;
                minYearA = year;
                minMonthA = month;
            }

            if (!callsByYearMonth[year]) callsByYearMonth[year] = {};
            callsByYearMonth[year][month] = count;
        });

        const numberOfMonthsWithData = data.length;
        const averageCallsPerMonth = numberOfMonthsWithData > 0 ? (totalCalls / numberOfMonthsWithData).toFixed(0) : 0;

        // Звонки за последние 12 месяцев
        let callsLast12Months = 0;
        const currentDate = new Date();
        let currentScanYear = currentDate.getFullYear();
        let currentScanMonth = currentDate.getMonth() + 1; // JS month is 0-indexed

        for (let i = 0; i < 12; i++) {
            if (callsByYearMonth[currentScanYear] && callsByYearMonth[currentScanYear][currentScanMonth]) {
                callsLast12Months += callsByYearMonth[currentScanYear][currentScanMonth];
            }
            currentScanMonth--;
            if (currentScanMonth === 0) {
                currentScanMonth = 12;
                currentScanYear--;
            }
        }

        const analysisPeriodStart = `${getMonthName(minMonthInMinYear, 'short')} ${minYear} г.`;
        const analysisPeriodEnd = `${getMonthName(maxMonthInMaxYear, 'short')} ${maxYear} г.`;
        const peakActivity = `${getMonthName(peakMonth, 'full')} ${peakYear} г. (${peakCalls} звонков)`;
        const minActivity = minCalls !== Infinity ? `${getMonthName(minMonthA, 'full')} ${minYearA} г. (${minCalls} звонков)` : '-';

        let html = `<ul style="list-style-type: none; padding-left: 0; font-size: 0.9em;">
                        <li><strong>Период анализа:</strong> ${analysisPeriodStart} - ${analysisPeriodEnd}</li>
                        <li><strong>Общее количество звонков:</strong> ${totalCalls.toLocaleString('ru-RU')}</li>
                        <li><strong>Среднее количество звонков в месяц:</strong> ${parseFloat(averageCallsPerMonth).toLocaleString('ru-RU')}</li>
                        <li><strong>Месяц пиковой активности:</strong> ${peakActivity}</li>
                        <li><strong>Месяц минимальной активности:</strong> ${minActivity}</li>
                        <li><strong>Звонков за последние 12 месяцев:</strong> ${callsLast12Months.toLocaleString('ru-RU')}</li>
                    </ul>`;
        container.innerHTML = html;
    }

    function renderYearlyMonthlyTable(data, container) {
        if (!data || data.length === 0) {
            container.innerHTML = '<p style="text-align:center; color:#6c757d;"><i class="fas fa-info-circle"></i> Нет данных для таблицы по годам и месяцам.</p>';
            return;
        }

        // 1. Подготовка данных
        const statsByYear = {};
        let minYear = Infinity;
        let maxYear = -Infinity;

        data.forEach(item => {
            const year = parseInt(item.year, 10);
            const month = parseInt(item.month, 10);
            const count = parseInt(item.count, 10);

            minYear = Math.min(minYear, year);
            maxYear = Math.max(maxYear, year);

            if (!statsByYear[year]) {
                statsByYear[year] = { total: 0 }; // Инициализируем общую сумму за год
                for (let m = 1; m <= 12; m++) {
                    statsByYear[year][m] = 0; // Инициализируем все месяцы нулями
                }
            }
            statsByYear[year][month] = count;
            statsByYear[year].total += count;
        });

        // 2. Создание заголовка таблицы
        const monthHeaders = ['Янв', 'Фев', 'Мар', 'Апр', 'Май', 'Июн', 'Июл', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'];
        let tableHtml = '<table class="analytics-table calls-table" style="margin-top:10px;">'; // Добавил класс calls-table для консистентности
        tableHtml += '<thead><tr><th>Год</th>';
        monthHeaders.forEach(mh => tableHtml += `<th>${mh}</th>`);
        tableHtml += '<th>Итого за год</th></tr></thead><tbody>';

        // 3. Формирование строк таблицы (от самого нового года к старому)
        const sortedYears = Object.keys(statsByYear).sort((a, b) => b - a); // Сортировка годов по убыванию

        sortedYears.forEach(year => {
            tableHtml += `<tr><td style="font-weight: bold;">${year}</td>`;
            for (let m = 1; m <= 12; m++) {
                const countForMonth = statsByYear[year][m];
                tableHtml += `<td>${countForMonth > 0 ? countForMonth : '-'}</td>`;
            }
            tableHtml += `<td style="font-weight: bold;">${statsByYear[year].total > 0 ? statsByYear[year].total : '-'}</td></tr>`;
        });

        tableHtml += '</tbody></table>';
        container.innerHTML = tableHtml;
    }


    function fetchMonthlyCallDynamics() {
        const chartLoadingStatus = document.getElementById('chartLoadingStatus');
        if (chartLoadingStatus) {
            chartLoadingStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка данных для диаграммы...';
            chartLoadingStatus.style.display = 'block'; // Показываем при начале загрузки
        }
        const chartContainer = document.getElementById('monthlyCallsChartContainer');
        if(chartContainer) chartContainer.style.display = 'none'; // Скрываем контейнер на время загрузки


        fetch('/api/moscow-calls-monthly-stats')
            .then(response => {
                if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                return response.json();
            })
            .then(data => {
                if (data.success && data.stats) { // Изменено data.dynamics на data.stats
                    renderMonthlyCallsChart(data.stats); // Изменено data.dynamics на data.stats
                } else {
                    console.error("Ошибка при получении данных для диаграммы:", data.error);
                    if(chartLoadingStatus) chartLoadingStatus.innerHTML = `<p style="color:red;">Ошибка: ${data.error || 'Не удалось загрузить данные'}</p>`;
                    if(chartContainer) chartContainer.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Критическая ошибка при загрузке данных для диаграммы:', error);
                if(chartLoadingStatus) chartLoadingStatus.innerHTML = `<p style="color:red;">Критическая ошибка: ${error.message}</p>`;
                if(chartContainer) chartContainer.style.display = 'none';
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Находим панель "Динамика звонков по месяцам"
        const monthlyDynamicsPanel = document.getElementById('monthlyDynamicsPanel');
        let chartDataLoaded = false; // Флаг, чтобы избежать повторной загрузки

        if (monthlyDynamicsPanel) {
            const header = monthlyDynamicsPanel.querySelector('.accordion-header');
            if (header) {
                header.addEventListener('click', function() {
                    // Панель будет переключать класс 'active' сама по себе
                    // Загружаем данные только если панель стала активной И данные еще не загружены
                    if (monthlyDynamicsPanel.classList.contains('active') && !chartDataLoaded) {
                        fetchMonthlyCallDynamics();
                        chartDataLoaded = true; // Устанавливаем флаг, что данные (попытка) загружены
                    }
                });
            }

            // Если панель изначально активна (например, если убрать data-collapsed), загружаем данные сразу
            // В текущей конфигурации, она закрыта по умолчанию, так что это не сработает.
            // if (monthlyDynamicsPanel.classList.contains('active') && !chartDataLoaded) {
            //     fetchMonthlyCallDynamics();
            //     chartDataLoaded = true;
            // }
        }
    });
    // --- Конец Динамики звонков по месяцам ---
    </script>
    <!-- Подключение скриптов Finesse -->
    <script src="{{ url_for('static', filename='js/finesse_profile.js') }}"></script>
    <script src="{{ url_for('static', filename='js/finesse_agents.js') }}"></script>
    <script src="{{ url_for('static', filename='js/persistent_user_info.js') }}"></script>
    <!-- Подключаем Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
