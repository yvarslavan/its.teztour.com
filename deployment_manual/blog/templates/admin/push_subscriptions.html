{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-bell me-2"></i>
                        Управление пуш-подписками
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Статистика -->
                    <div class="row mb-4" id="stats-container">
                        <div class="col-md-3">
                            <div class="card border-left-primary">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                Всего подписок
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-subscriptions">
                                                <i class="fas fa-spinner fa-spin"></i>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-bell fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-left-success">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                                Активные
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="active-subscriptions">
                                                <i class="fas fa-spinner fa-spin"></i>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-check-circle fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-left-warning">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                Неактивные
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="inactive-subscriptions">
                                                <i class="fas fa-spinner fa-spin"></i>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-times-circle fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card border-left-danger">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">
                                                С ошибками
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="error-subscriptions">
                                                <i class="fas fa-spinner fa-spin"></i>
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Детальная статистика -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="m-0 font-weight-bold text-primary">Распределение по типам</h6>
                                </div>
                                <div class="card-body">
                                    <canvas id="typeChart" width="400" height="200"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="m-0 font-weight-bold text-primary">Проблемные подписки</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="text-center">
                                                <div class="h4 mb-0 font-weight-bold text-danger" id="error-count">-</div>
                                                <div class="text-xs text-muted">С ошибками данных</div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-center">
                                                <div class="h4 mb-0 font-weight-bold text-warning" id="old-count">-</div>
                                                <div class="text-xs text-muted">Старые (>30 дней)</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Управление -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="m-0 font-weight-bold text-primary">Действия</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <button type="button" class="btn btn-warning btn-block" onclick="cleanupSubscriptions()">
                                                <i class="fas fa-broom"></i> Очистить неактивные подписки
                                            </button>
                                        </div>
                                        <div class="col-md-6">
                                            <button type="button" class="btn btn-info btn-block" onclick="refreshStats()">
                                                <i class="fas fa-sync-alt"></i> Обновить статистику
                                            </button>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="cleanup-days">Удалить подписки неактивные более (дней):</label>
                                                <input type="number" class="form-control" id="cleanup-days" value="7" min="1" max="365">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Результаты очистки -->
                    <div class="row mt-4" id="cleanup-results" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="m-0 font-weight-bold text-success">Результаты очистки</h6>
                                </div>
                                <div class="card-body" id="cleanup-results-body">
                                    <!-- Результаты будут добавлены динамически -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let typeChart = null;

// Загрузка статистики при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
});

function loadStats() {
    fetch('/admin/push-subscriptions-stats')
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            updateStatsDisplay(data);
            updateChart(data);
        })
        .catch(error => {
            console.error('Ошибка загрузки статистики:', error);
            Swal.fire({
                icon: 'error',
                title: 'Ошибка',
                text: 'Не удалось загрузить статистику: ' + error.message
            });
        });
}

function updateStatsDisplay(data) {
    document.getElementById('total-subscriptions').textContent = data.total;
    document.getElementById('active-subscriptions').textContent = data.active;
    document.getElementById('inactive-subscriptions').textContent = data.inactive;
    document.getElementById('error-subscriptions').textContent = data.problematic.with_errors;
    document.getElementById('error-count').textContent = data.problematic.with_errors;
    document.getElementById('old-count').textContent = data.problematic.old_unused;
}

function updateChart(data) {
    const ctx = document.getElementById('typeChart').getContext('2d');

    if (typeChart) {
        typeChart.destroy();
    }

    typeChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['FCM (Google)', 'Mozilla', 'Другие'],
            datasets: [{
                data: [data.by_type.fcm, data.by_type.mozilla, data.by_type.other],
                backgroundColor: [
                    '#4285f4',
                    '#ff9500',
                    '#6c757d'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function refreshStats() {
    const btn = event.target;
    const originalText = btn.innerHTML;

    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Обновление...';
    btn.disabled = true;

    loadStats();

    setTimeout(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }, 1000);
}

function cleanupSubscriptions() {
    const days = document.getElementById('cleanup-days').value;

    Swal.fire({
        title: 'Подтверждение очистки',
        text: `Будут удалены все неактивные подписки старше ${days} дней и подписки с ошибками. Продолжить?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Да, очистить',
        cancelButtonText: 'Отмена'
    }).then((result) => {
        if (result.isConfirmed) {
            performCleanup(days);
        }
    });
}

function performCleanup(days) {
    const btn = event.target;
    const originalText = btn.innerHTML;

    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Очистка...';
    btn.disabled = true;

    fetch('/admin/cleanup-push-subscriptions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || ''
        },
        body: JSON.stringify({
            days: parseInt(days)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }

        showCleanupResults(data);
        loadStats(); // Обновляем статистику

        Swal.fire({
            icon: 'success',
            title: 'Очистка завершена',
            text: `Удалено ${data.statistics.deleted} подписок`,
            timer: 3000
        });
    })
    .catch(error => {
        console.error('Ошибка очистки:', error);
        Swal.fire({
            icon: 'error',
            title: 'Ошибка очистки',
            text: error.message
        });
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function showCleanupResults(data) {
    const resultsContainer = document.getElementById('cleanup-results');
    const resultsBody = document.getElementById('cleanup-results-body');

    const stats = data.statistics;

    resultsBody.innerHTML = `
        <div class="row">
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h4 mb-0 font-weight-bold text-primary">${stats.total_before}</div>
                    <div class="text-xs text-muted">До очистки</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h4 mb-0 font-weight-bold text-success">${stats.total_after}</div>
                    <div class="text-xs text-muted">После очистки</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h4 mb-0 font-weight-bold text-danger">${stats.deleted}</div>
                    <div class="text-xs text-muted">Удалено всего</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="text-center">
                    <div class="h4 mb-0 font-weight-bold text-warning">${stats.inactive_deleted}</div>
                    <div class="text-xs text-muted">Неактивных</div>
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-info">
                    <strong>Детали:</strong>
                    <ul class="mb-0">
                        <li>Удалено неактивных подписок: ${stats.inactive_deleted}</li>
                        <li>Удалено подписок с ошибками: ${stats.error_deleted}</li>
                        <li>Общее количество до очистки: ${stats.total_before}</li>
                        <li>Общее количество после очистки: ${stats.total_after}</li>
                    </ul>
                </div>
            </div>
        </div>
    `;

    resultsContainer.style.display = 'block';
}
</script>
{% endblock %}

{% block styles %}
<style>
.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}

.border-left-danger {
    border-left: 0.25rem solid #e74a3b !important;
}

.text-xs {
    font-size: 0.7rem;
}

.text-gray-800 {
    color: #5a5c69 !important;
}

.text-gray-300 {
    color: #dddfeb !important;
}

.card {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
    border: 1px solid #e3e6f0 !important;
}

#typeChart {
    max-height: 200px;
}
</style>
{% endblock %}
