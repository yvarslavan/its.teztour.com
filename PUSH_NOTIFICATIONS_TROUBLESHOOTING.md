# Руководство по устранению неполадок с браузерными пуш-уведомлениями

## Проблема в Edge: Разрешения заблокированы

### Симптомы
- Сообщение: "Notifications permission has been blocked as the user has ignored the permission prompt several times"
- Статус разрешения: `denied`
- Кнопка "Включить" не работает

### Решение для Edge

1. **Сброс разрешений через настройки сайта:**
   - Нажмите на иконку замка/информации слева от адресной строки
   - Выберите "Разрешения для этого сайта" или "Настройки сайта"
   - Найдите "Уведомления" и измените на "Разрешить"

2. **Альтернативный способ:**
   - Откройте `edge://settings/content/notifications`
   - Найдите `localhost:5000` в списке заблокированных
   - Переместите в список разрешенных

3. **Полный сброс:**
   - Откройте `edge://settings/clearBrowserData`
   - Выберите "Дополнительно"
   - Отметьте "Разрешения сайтов"
   - Нажмите "Удалить данные"

## Проблема в Opera: Уведомления не приходят

### Симптомы
- Статус показывает "Включены"
- Подписка создана успешно
- Тестовые уведомления не отображаются

### Диагностика

1. **Проверьте консоль браузера при нажатии "Тест":**
   ```
   F12 → Console → Нажмите кнопку "Тест"
   ```

2. **Ожидаемые логи в консоли:**
   ```
   [Account] Нажата кнопка тестового уведомления
   [Account] CSRF токен: найден
   [Account] Отправка запроса на /api/push/test...
   [Account] Ответ сервера: 200 OK
   [Account] Данные ответа: {success: true, message: "..."}
   [Account] Тестовое уведомление отправлено успешно
   ```

3. **Проверьте логи сервера:**
   - Откройте терминал с запущенным Flask приложением
   - Нажмите кнопку "Тест" в браузере
   - Ищите логи с префиксом `[PUSH_TEST]` и `[PUSH_SERVICE]`

### Возможные причины

1. **Отсутствуют VAPID ключи на сервере**
2. **Ошибка в подписке пользователя**
3. **Проблемы с pywebpush библиотекой**
4. **Неправильная конфигурация Service Worker**

## Пошаговое тестирование

### Шаг 1: Проверка API
```bash
# Проверьте VAPID ключ
curl http://localhost:5000/api/vapid-public-key

# Ожидаемый ответ:
{"publicKey":"BEl62iUYgUivxIkv69yViEuiBIa40HI80NM9f8HnRG-ATXBdPdk-y1x-SoPGH6RpgAuSPiMtXVBNWBuUjb3C_XY"}
```

### Шаг 2: Проверка подписки (требует авторизации)
1. Авторизуйтесь в системе
2. Откройте консоль разработчика (F12)
3. Выполните:
```javascript
fetch('/api/push/status')
  .then(r => r.json())
  .then(console.log);
```

### Шаг 3: Тестовое уведомление
1. Убедитесь, что статус показывает "Включены"
2. Нажмите кнопку "Тест"
3. Проверьте консоль браузера и логи сервера

## Логи для анализа

### Успешная отправка (ожидаемые логи сервера):
```
[PUSH_TEST] Запрос тестового уведомления от пользователя X
[PUSH_TEST] Создано тестовое уведомление: NotificationData(...)
[PUSH_TEST] Найдено активных подписок: 1
[PUSH_TEST] Отправка через notification_service...
[PUSH_SERVICE] Начало отправки пуш-уведомления для пользователя X
[PUSH_SERVICE] Найдено 1 подписок для пользователя X
[PUSH_SERVICE] Отправка подписке 1/1 (ID: Y)
[PUSH_SEND] Начало отправки подписке Y
[PUSH_SEND] Пуш-уведомление отправлено: Тестовое уведомление, статус: 201
[PUSH_SERVICE] Отправлено 1 пуш-уведомлений для пользователя X
[PUSH_TEST] Тестовое уведомление отправлено успешно
```

### Проблемы с VAPID ключами:
```
[PUSH_SEND] VAPID ключи не настроены, пропускаем отправку пуш-уведомления
```

### Проблемы с подписками:
```
[PUSH_TEST] У пользователя X нет активных подписок
```

## Решение проблем

### 1. Если нет активных подписок
- Отключите и снова включите уведомления
- Проверьте, что браузер поддерживает пуш-уведомления
- Убедитесь, что разрешения предоставлены

### 2. Если VAPID ключи не настроены
- Проверьте файл `blog/settings.py`
- Убедитесь, что ключи присутствуют в конфигурации
- Перезапустите приложение

### 3. Если уведомления не отображаются
- Проверьте настройки уведомлений в браузере
- Убедитесь, что сайт не в режиме "Не беспокоить"
- Проверьте, что Service Worker активен

## Команды для диагностики

### Проверка Service Worker в консоли браузера:
```javascript
// Проверка регистрации
navigator.serviceWorker.getRegistrations().then(console.log);

// Проверка подписки
navigator.serviceWorker.ready.then(reg =>
  reg.pushManager.getSubscription().then(console.log)
);

// Проверка разрешений
console.log('Notification permission:', Notification.permission);
```

### Тестовый запрос к серверу:
```javascript
// Тест VAPID ключа
fetch('/api/vapid-public-key').then(r => r.json()).then(console.log);

// Тест статуса (требует авторизации)
fetch('/api/push/status').then(r => r.json()).then(console.log);

// Тест уведомления (требует авторизации)
fetch('/api/push/test', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'X-CSRFToken': document.querySelector('meta[name=csrf-token]').content
  }
}).then(r => r.json()).then(console.log);
```

## Контакты для поддержки

Если проблема не решается:
1. Соберите логи браузера и сервера
2. Укажите версию браузера и операционной системы
3. Опишите точную последовательность действий
4. Приложите скриншоты ошибок
