name: SSH Connection Test

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  ssh-test:
    runs-on: ubuntu-latest
    steps:
      - name: Test SSH connection
        env:
          DEPLOY_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          DEPLOY_HOST: ${{ secrets.SSH_HOST }}
          DEPLOY_USER: ${{ secrets.SSH_USER }}
          DEPLOY_PORT: ${{ secrets.SSH_PORT || 22 }}
        run: |
          mkdir -p ~/.ssh
          echo "$DEPLOY_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -p $DEPLOY_PORT -H $DEPLOY_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
          
          echo "üîç Testing SSH connection..."
          ssh -i ~/.ssh/deploy_key -p $DEPLOY_PORT $DEPLOY_USER@$DEPLOY_HOST "echo '‚úÖ SSH connection successful!'; whoami; pwd"
        echo "üîç Attempting to grab SSH banner:"

        timeout 10 bash -c "
          exec 3<>/dev/tcp/${{ secrets.SSH_HOST }}/$SSH_PORT
          cat <&3 &
          sleep 3
          kill %1 2>/dev/null
          exec 3<&-
          exec 3>&-
        " 2>/dev/null || echo "‚ùå Could not connect to SSH service"
        echo ""

        # GitHub Actions IP ranges info
        echo "5Ô∏è‚É£ GITHUB ACTIONS INFO"
        echo "----------------------------------------"
        echo "üìã Current GitHub Actions runner info:"
        echo "   Public IP: $(curl -s https://ifconfig.me || echo 'Unknown')"
        echo "   User Agent: GitHub Actions Runner"
        echo ""
        echo "üí° If server is behind firewall, consider whitelisting GitHub Actions IP ranges:"
        echo "   https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners#ip-addresses"
        echo ""

        # Final recommendations
        echo "6Ô∏è‚É£ RECOMMENDATIONS"
        echo "----------------------------------------"
        echo "Based on the hostname 'vpn-130.msk.tez-tour.com':"
        echo ""
        echo "üîß Most Likely Issues:"
        echo "   1. Server is behind corporate VPN/firewall"
        echo "   2. SSH service uses non-standard port"
        echo "   3. External SSH access is disabled"
        echo ""
        echo "üöÄ Recommended Solutions:"
        echo "   1. Use GitHub Self-Hosted Runner inside your network"
        echo "   2. Configure VPN connection in workflow"
        echo "   3. Setup SSH port forwarding/bastion host"
        echo "   4. Use webhook-based deployment instead"
        echo "   5. Enable SSH access from GitHub Actions IP ranges"
        echo ""
        echo "üìû Contact your system administrator to:"
        echo "   - Verify SSH service configuration"
        echo "   - Check firewall rules"
        echo "   - Consider network architecture changes"

    - name: Test SSH Key Format
      run: |
        echo ""
        echo "7Ô∏è‚É£ SSH KEY VALIDATION"
        echo "----------------------------------------"

        # We can't see the actual key, but we can validate its format
        echo "üîç SSH Key validation (format check only):"
        echo "   - Key type: Should be RSA, Ed25519, or ECDSA"
        echo "   - Format: Should be OpenSSH private key format"
        echo "   - Permissions: GitHub Secrets are automatically secure"
        echo ""
        echo "üí° If deployment continues to fail after fixing connectivity:"
        echo "   1. Regenerate SSH key pair"
        echo "   2. Ensure public key is in ~/.ssh/authorized_keys on server"
        echo "   3. Check SSH key permissions on server"
        echo "   4. Verify SSH user has necessary permissions"
