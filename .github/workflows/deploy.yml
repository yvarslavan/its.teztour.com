name: Deploy Flask App

on:
  push:
    branches:
      - main # Запускать при push в ветку main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        script: |
          set -e
          echo ">>> Connecting to server..."

          PROJECT_DIR="/var/www/flask_helpdesk"
          GIT_REPO_URL_WITH_TOKEN='https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git'

          echo ">>> DEBUG: GIT_REPO_URL_WITH_TOKEN (check if token is embedded):"
          echo "$GIT_REPO_URL_WITH_TOKEN"

          echo ">>> Removing old project directory (if exists): $PROJECT_DIR"
          sudo rm -rf "$PROJECT_DIR"

          echo ">>> Creating project directory and setting permissions: $PROJECT_DIR"
          sudo mkdir -p "$PROJECT_DIR"
          sudo chown ${{ secrets.SSH_USER }}:${{ secrets.SSH_USER }} "$PROJECT_DIR"
          cd "$PROJECT_DIR"

          echo ">>> Cloning repository: ${{ github.repository }} (branch: main)"
          git clone --branch main --single-branch "$GIT_REPO_URL_WITH_TOKEN" .

          echo ">>> Verifying current commit in cloned repository"
          git log -n 1

          echo ">>> Activating virtual environment"
          VENV_PATH="/home/${{ secrets.SSH_USER }}/flask_venv/bin/activate"
          if [ ! -f "$VENV_PATH" ]; then
              echo "Ошибка: Файл активации виртуального окружения не найден: $VENV_PATH" >&2
              exit 1
          fi
          source "$VENV_PATH"
          echo "Virtual environment activated."

          echo ">>> Upgrading pip and installing dependencies from requirements.txt"
          pip install --upgrade pip
          pip install -r requirements.txt

          echo ">>> Restarting application: flask_helpdesk"
          sudo systemctl restart flask_helpdesk

          echo ">>> Deployment successfully finished!"
