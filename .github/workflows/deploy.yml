name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest  # ğŸ”§ Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾: Ğ¿ĞµÑ€ĞµÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ self-hosted runner
    name: Test Dependencies & Application

    steps:
    - uses: actions/checkout@v4

    - name: Check disk space and run monitoring
      run: |
        echo "ğŸ” Checking disk space after cleanup..."
        df -h
        echo ""

        # Run disk monitoring script
        if [ -f /home/yvarslavan/disk_monitoring.sh ]; then
          echo "ğŸ“Š Running disk monitoring..."
          bash /home/yvarslavan/disk_monitoring.sh
        fi

        # Check if we have at least 2GB free (increased threshold)
        AVAILABLE=$(df / --output=avail | tail -n1)
        if [ "$AVAILABLE" -lt 2097152 ]; then
          echo "ğŸš¨ CRITICAL: Less than 2GB free space available"
          echo "Current free space: $(df -h / | tail -1 | awk '{print $4}')"

          # Emergency cleanup
          rm -rf /home/github-actions/actions-runner/_work/* 2>/dev/null || true
          rm -rf /home/github-actions/.cache/* 2>/dev/null || true

          # Check Flask logs
          FLASK_LOG_SIZE=$(du -m /var/www/flask_helpdesk/app_err.log 2>/dev/null | cut -f1 || echo "0")
          if [ "$FLASK_LOG_SIZE" -gt 100 ]; then
            echo "âš ï¸ Flask log is ${FLASK_LOG_SIZE}MB - truncating..."
            sudo truncate -s 10M /var/www/flask_helpdesk/app_err.log 2>/dev/null || true
          fi

          echo "After emergency cleanup:"
          df -h

          # Still not enough? Stop runner
          AVAILABLE_AFTER=$(df / --output=avail | tail -n1)
          if [ "$AVAILABLE_AFTER" -lt 1048576 ]; then
            echo "ğŸ›‘ Still less than 1GB free - stopping runner for safety"
            exit 1
          fi
        else
          echo "âœ… Sufficient disk space available: $(df -h / | tail -1 | awk '{print $4}')"
        fi

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Create virtual environment
      run: |
        python -m venv venv
        source venv/bin/activate
        echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
        echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH

    - name: Upgrade pip and install build tools
      run: |
        python -m pip install --upgrade pip setuptools wheel

    - name: Test dependency resolution
      run: |
        echo "ğŸ” Testing dependency resolution..."
        python -m pip install --dry-run -r requirements.txt
        echo "âœ… Dependencies are compatible"

    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        python -m pip install -r requirements.txt
        echo "âœ… Dependencies installed successfully"

    - name: Test Flask import
      run: |
        echo "ğŸ§ª Testing Flask application..."
        python -c "
        import flask
        import werkzeug
        from blog import create_app

        print(f'Flask version: {flask.__version__}')
        print(f'Werkzeug version: {werkzeug.__version__}')

        app = create_app()
        print('âœ… Flask app created successfully')
        "

    - name: Run application tests
      run: |
        echo "ğŸ§ª Running application tests..."
        python -c "
        from blog import create_app
        import os

        # Test app creation
        app = create_app()

        # Test app configuration
        with app.app_context():
            print('âœ… App context works')

        # Test basic route (if exists)
        with app.test_client() as client:
            try:
                response = client.get('/')
                print(f'âœ… Basic route test: Status {response.status_code}')
            except Exception as e:
                print(f'âš ï¸ Route test skipped: {e}')

        print('ğŸ‰ All tests passed!')
        "

  deploy:
    needs: test
    runs-on: ubuntu-latest  # ğŸ”§ Ğ’Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾: Ğ¿ĞµÑ€ĞµÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ self-hosted runner
    # ğŸ¯ Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ push Ğ² main (Ğ½Ğµ Ğ¿Ñ€Ğ¸ PR)
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    name: Deploy to Production

    steps:
    - uses: actions/checkout@v4

    - name: Test server connectivity
      run: |
        echo "ğŸ” Testing server connectivity from self-hosted runner..."
        echo "Runner info: $(hostname) - $(whoami)"
        echo "Server host: ${{ secrets.SSH_HOST }}"
        echo "SSH port: ${{ secrets.SSH_PORT || '22' }}"

        # Test DNS resolution
        if nslookup ${{ secrets.SSH_HOST }}; then
          echo "âœ… DNS resolution successful"
        else
          echo "âŒ DNS resolution failed"
          exit 1
        fi

        # Test ping (may fail due to firewall, but worth trying)
        if ping -c 3 ${{ secrets.SSH_HOST }}; then
          echo "âœ… Server is reachable via ping"
        else
          echo "âš ï¸ Server doesn't respond to ping (may be blocked by firewall - ÑÑ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾)"
        fi

        # Test SSH port connectivity with enhanced diagnosis
        SSH_PORT=${{ secrets.SSH_PORT || '22' }}
        echo "ğŸ”Œ Testing SSH connectivity on port $SSH_PORT..."

        if timeout 10 bash -c "</dev/tcp/${{ secrets.SSH_HOST }}/$SSH_PORT"; then
          echo "âœ… Port $SSH_PORT is accessible"
        else
          echo "âŒ Port $SSH_PORT is not accessible"
          echo ""
          echo "ğŸ” Trying to diagnose the issue..."

          # Try common SSH ports
          echo "ğŸ” Testing common SSH ports:"
          for port in 22 2222 2022 22022 22222; do
            if timeout 5 bash -c "</dev/tcp/${{ secrets.SSH_HOST }}/$port" 2>/dev/null; then
              echo "âœ… Found SSH service on port $port"
              if [ "$port" != "$SSH_PORT" ]; then
                echo "ğŸ’¡ Consider updating SSH_PORT secret to $port"
              fi
            else
              echo "âŒ Port $port not accessible"
            fi
          done

          echo ""
          echo "ğŸš¨ SSH Connection Failed - Possible Causes & Solutions:"
          echo ""
          echo "ğŸ“‹ Server Name Analysis:"
          echo "   Host: vpn-130.msk.tez-tour.com"
          echo "   â†³ 'vpn-' prefix suggests internal network access required"
          echo ""
          echo "ğŸ”§ Possible Solutions:"
          echo ""
          echo "1. ğŸ”‘ Check SSH Port Configuration:"
          echo "   - Current port: $SSH_PORT"
          echo "   - Common SSH ports: 22, 2222, 2022, 22022"
          echo "   - Update GitHub Secret 'SSH_PORT' if needed"
          echo ""
          echo "2. ğŸŒ VPN/Network Access:"
          echo "   - Server may be behind corporate VPN"
          echo "   - Consider using GitHub self-hosted runner inside network"
          echo "   - Or setup VPN connection in workflow"
          echo ""
          echo "3. ğŸ›¡ï¸ Firewall Configuration:"
          echo "   - Allow GitHub Actions IP ranges"
          echo "   - Configure port forwarding on router/firewall"
          echo "   - Check iptables/UFW rules on server"
          echo ""
          echo "4. ğŸ”§ SSH Service Check:"
          echo "   - Verify SSH daemon is running: systemctl status ssh"
          echo "   - Check SSH config: /etc/ssh/sshd_config"
          echo "   - Restart SSH service if needed: systemctl restart ssh"
          echo ""
          echo "5. ğŸ” Alternative Solutions:"
          echo "   - Setup webhook deployment endpoint"
          echo "   - Use SSH tunneling through bastion host"
          echo ""
          echo "âœ… Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ÑÑ self-hosted runner - Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ Ğº ÑĞµÑ€Ğ²ĞµÑ€Ñƒ"

          # Don't exit immediately - let's try to connect anyway
          echo "âš ï¸ Proceeding with deployment attempt (self-hosted runner may have direct access)..."
        fi

    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || '22' }}
        timeout: 60s
        command_timeout: 10m
        debug: true
        script: |
          echo "ğŸš€ Starting deployment..."
          echo "Connected to: $(hostname -I | awk '{print $1}')"

          # Navigate to project directory
          cd /var/www/flask_helpdesk

          # Pull latest changes
          echo "ğŸ“¥ Pulling latest changes..."
          git pull origin main

          # Activate virtual environment
          echo "ğŸ”§ Activating virtual environment..."
          source venv/bin/activate

          # Upgrade pip and install/upgrade dependencies
          echo "ğŸ“¦ Updating dependencies..."
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt --upgrade

          # Run database migrations if needed
          echo "ğŸ—„ï¸ Running database migrations..."
          python -m flask db upgrade || echo "No migrations to run"

          # Check application health
          echo "ğŸ¥ Checking application health..."
          python -c "
          from blog import create_app
          app = create_app()
          print('âœ… Application health check passed')
          " || exit 1

          # Restart application services
          echo "ğŸ”„ Restarting services..."

          # Stop existing processes
          pkill -f "python.*app.py" || echo "No existing processes found"
          pkill -f "gunicorn.*wsgi:app" || echo "No gunicorn processes found"

          # Start application in background
          echo "â–¶ï¸ Starting application..."
          nohup python app.py > app.log 2>&1 &

          # Wait a moment for startup
          sleep 5

          # Check if application started successfully
          if pgrep -f "python.*app.py" > /dev/null; then
            echo "âœ… Application started successfully"
            echo "ğŸ“Š Process info:"
            ps aux | grep -E "(python.*app.py|gunicorn)" | grep -v grep
          else
            echo "âŒ Application failed to start"
            echo "ğŸ“‹ Recent logs:"
            tail -20 app.log
            exit 1
          fi

          echo "ğŸ‰ Deployment completed successfully!"
