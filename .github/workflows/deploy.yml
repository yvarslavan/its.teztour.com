name: Deploy Flask Helpdesk

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test-dependencies:
    runs-on: ubuntu-latest
    name: Test Dependencies Compatibility

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Create virtual environment
      run: |
        python -m venv venv
        source venv/bin/activate
        echo "VIRTUAL_ENV=$VIRTUAL_ENV" >> $GITHUB_ENV
        echo "$VIRTUAL_ENV/bin" >> $GITHUB_PATH

    - name: Upgrade pip and install build tools
      run: |
        python -m pip install --upgrade pip setuptools wheel

    - name: Test dependency resolution
      run: |
        echo "ğŸ” Testing dependency resolution..."
        python -m pip install --dry-run -r requirements.txt
        echo "âœ… Dependencies are compatible"

    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        python -m pip install -r requirements.txt
        echo "âœ… Dependencies installed successfully"

    - name: Test Flask import
      run: |
        echo "ğŸ§ª Testing Flask application..."
        python -c "
        import flask
        import werkzeug
        from blog import create_app

        print(f'Flask version: {flask.__version__}')
        print(f'Werkzeug version: {werkzeug.__version__}')

        app = create_app()
        print('âœ… Flask app created successfully')
        "

  # Deploy job Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½ Ğ´Ğ¾ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑĞµĞºÑ€ĞµÑ‚Ğ¾Ğ²
  # Ğ Ğ°ÑĞºĞ¾Ğ¼Ğ¼ĞµĞ½Ñ‚Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ¿Ğ¾ÑĞ»Ğµ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ HOST, USERNAME, KEY, PORT Ğ² GitHub Secrets
  #
  # deploy:
  #   needs: test-dependencies
  #   runs-on: ubuntu-latest
  #   if: github.ref == 'refs/heads/main'
  #   name: Deploy to Production
  #
  #   steps:
  #   - uses: actions/checkout@v4
  #
  #   - name: Deploy to server
  #     uses: appleboy/ssh-action@v1.0.3
  #     with:
  #       host: ${{ secrets.HOST }}
  #       username: ${{ secrets.USERNAME }}
  #       key: ${{ secrets.KEY }}
  #       port: ${{ secrets.PORT }}
  #       script: |
  #         echo "ğŸš€ Starting deployment..."
  #
  #         # Navigate to project directory
  #         cd /var/www/flask_helpdesk
  #
  #         # Pull latest changes
  #         echo "ğŸ“¥ Pulling latest changes..."
  #         git pull origin main
  #
  #         # Activate virtual environment
  #         echo "ğŸ”§ Activating virtual environment..."
  #         source venv/bin/activate
  #
  #         # Upgrade pip and install/upgrade dependencies
  #         echo "ğŸ“¦ Updating dependencies..."
  #         python -m pip install --upgrade pip
  #         python -m pip install -r requirements.txt --upgrade
  #
  #         # Run database migrations if needed
  #         echo "ğŸ—„ï¸ Running database migrations..."
  #         python -m flask db upgrade || echo "No migrations to run"
  #
  #         # Check application health
  #         echo "ğŸ¥ Checking application health..."
  #         python -c "
  #         from blog import create_app
  #         app = create_app()
  #         print('âœ… Application health check passed')
  #         " || exit 1
  #
  #         # Restart application services
  #         echo "ğŸ”„ Restarting services..."
  #
  #         # Stop existing processes
  #         pkill -f "python.*app.py" || echo "No existing processes found"
  #         pkill -f "gunicorn.*wsgi:app" || echo "No gunicorn processes found"
  #
  #         # Start application in background
  #         echo "â–¶ï¸ Starting application..."
  #         nohup python app.py > app.log 2>&1 &
  #
  #         # Wait a moment for startup
  #         sleep 5
  #
  #         # Check if application started successfully
  #         if pgrep -f "python.*app.py" > /dev/null; then
  #           echo "âœ… Application started successfully"
  #           echo "ğŸ“Š Process info:"
  #           ps aux | grep -E "(python.*app.py|gunicorn)" | grep -v grep
  #         else
  #           echo "âŒ Application failed to start"
  #           echo "ğŸ“‹ Recent logs:"
  #           tail -20 app.log
  #           exit 1
  #         fi
  #
  #         echo "ğŸ‰ Deployment completed successfully!"
