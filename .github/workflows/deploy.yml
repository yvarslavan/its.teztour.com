name: Deploy Flask App

on:
  push:
    branches:
      - main  # Запускать при пуше в main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # Настраиваем SSH‑ключ и known_hosts для git clone по SSH
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          # Добавляем приватный ключ в id_rsa
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # Добавляем GitHub в known_hosts, чтобы git clone не падал на проверке хоста
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e

            echo ">>> Определяем пути"
            PROJECT_DIR_NAME="flask_helpdesk"
            BASE_PROJECT_PATH="/var/www"
            PROJECT_FULL_PATH="${BASE_PROJECT_PATH}/${PROJECT_DIR_NAME}"
            GIT_REPO_SSH="git@github.com:${{ github.repository }}.git"

            echo ">>> Удаляем старую директорию"
            if [ -d "${PROJECT_FULL_PATH}" ]; then
              sudo rm -rf "${PROJECT_FULL_PATH}"
            fi

            echo ">>> Создаём директорию и задаём права"
            sudo mkdir -p "${PROJECT_FULL_PATH}"
            sudo chown ${{ secrets.SSH_USER }}:${{ secrets.SSH_USER }} "${PROJECT_FULL_PATH}"

            cd "${PROJECT_FULL_PATH}"
            echo ">>> Клонируем репозиторий по SSH"
            git clone --branch main --single-branch "${GIT_REPO_SSH}" .

            echo ">>> Текущий коммит:"
            git log -1 --oneline

            echo ">>> Активируем виртуальное окружение"
            source /home/${{ secrets.SSH_USER }}/flask_venv/bin/activate

            echo ">>> Устанавливаем зависимости"
            pip install --upgrade pip
            pip install -r requirements.txt

            echo ">>> Перезапускаем сервис"
            sudo systemctl restart flask_helpdesk

            echo ">>> Готово!"
