name: Deploy Flask Helpdesk

on:
  push:
    branches: [ main, master ]
  # Ğ£Ğ±Ğ¸Ñ€Ğ°ĞµĞ¼ pull_request Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ´ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ğ» Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ push

jobs:
  deploy:
    runs-on: self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run tests (if any)
      run: |
        # python -m pytest tests/ || echo "No tests found"
        echo "Tests placeholder"

    - name: Stop existing application
      run: |
        echo "Stopping existing Flask application..."
        # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑÑ‹ Flask ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ñ‹
        pkill -f "python.*app.py" || echo "No Flask processes found"
        pkill -f "gunicorn.*wsgi" || echo "No Gunicorn processes found"
        sleep 2

    - name: Copy files to production directory
      run: |
        echo "Copying files to production directory..."
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ² Ñ€Ğ°Ğ±Ğ¾Ñ‡ÑƒÑ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
        rsync -av --exclude='.git' --exclude='venv' --exclude='__pycache__' --exclude='*.pyc' \
              $GITHUB_WORKSPACE/ /var/www/flask_helpdesk/

        # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
        sudo chown -R $USER:$USER /var/www/flask_helpdesk/
        chmod +x /var/www/flask_helpdesk/app.py
        chmod +x /var/www/flask_helpdesk/wsgi.py

    - name: Install/Update dependencies
      run: |
        echo "Installing/updating Python dependencies..."
        cd /var/www/flask_helpdesk

        # ĞĞºÑ‚Ğ¸Ğ²Ğ¸Ñ€ÑƒĞµĞ¼ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ Ğ¸Ğ»Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ½Ğ¾Ğ²Ğ¾Ğµ
        if [ ! -d "venv" ]; then
          python3 -m venv venv
        fi

        source venv/bin/activate
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Database migrations (if needed)
      run: |
        echo "Running database migrations..."
        cd /var/www/flask_helpdesk
        source venv/bin/activate

        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¸ ĞµÑÑ‚ÑŒ
        if [ -f "migrations/env.py" ]; then
          flask db upgrade || echo "No migrations to run"
        fi

        - name: Start application
      run: |
        echo "Starting Flask Helpdesk application..."
        cd /var/www/flask_helpdesk

        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ»Ğ¾Ğ³Ğ¾Ğ² ĞµÑĞ»Ğ¸ ĞµÑ‘ Ğ½ĞµÑ‚
        mkdir -p logs

        # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ Ğ² Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ñ€ĞµĞ¶Ğ¸Ğ¼Ğµ
        nohup /var/www/flask_helpdesk/venv/bin/python app.py > /var/www/flask_helpdesk/logs/app.log 2>&1 &

        # Ğ–Ğ´ĞµĞ¼ Ğ½ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°
        sleep 5

    - name: Health check
      run: |
        echo "Performing health check..."

        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½
        if pgrep -f "python.*app.py"; then
          echo "âœ… Flask process is running"
        else
          echo "âŒ Flask process not found"
          exit 1
        fi

        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ HTTP Ğ¾Ñ‚Ğ²ĞµÑ‚
        for i in {1..5}; do
          if curl -f -s http://localhost:5000 > /dev/null; then
            echo "âœ… Application is responding on port 5000"
            break
          else
            echo "â³ Attempt $i: Application not ready, waiting..."
            sleep 3
          fi

          if [ $i -eq 5 ]; then
            echo "âŒ Application failed to respond after 5 attempts"
            exit 1
          fi
        done

        echo "ğŸš€ Deployment completed successfully!"
