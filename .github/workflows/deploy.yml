name: Deploy Flask App

on:
  push:
    branches:
      - main  # Запускать при пуше в main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Подготовка known_hosts
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      - name: Добавить github.com в known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            set -e

            echo ">>> Определяем пути"
            PROJECT_DIR_NAME="flask_helpdesk"
            BASE_PROJECT_PATH="/var/www"
            PROJECT_FULL_PATH="${BASE_PROJECT_PATH}/${PROJECT_DIR_NAME}"
            GIT_REPO_SSH="git@github.com:${{ github.repository }}.git"

            echo ">>> Удаляем старую директорию"
            if [ -d "${PROJECT_FULL_PATH}" ]; then
              sudo rm -rf "${PROJECT_FULL_PATH}"
            fi

            echo ">>> Создаём директорию и задаём права"
            sudo mkdir -p "${PROJECT_FULL_PATH}"
            sudo chown ${{ secrets.SSH_USER }}:${{ secrets.SSH_USER }} "${PROJECT_FULL_PATH}"

            cd "${PROJECT_FULL_PATH}"
            echo ">>> Клонируем репозиторий по SSH"
            git clone --branch main --single-branch "${GIT_REPO_SSH}" .

            echo ">>> Текущий коммит:"
            git log -1 --oneline

            echo ">>> Активируем виртуальное окружение"
            # Предполагаем, что ВО уже создано и находится вне PROJECT_FULL_PATH
            source /home/${{ secrets.SSH_USER }}/flask_venv/bin/activate

            echo ">>> Устанавливаем зависимости"
            pip install --upgrade pip
            pip install -r requirements.txt

            echo ">>> Перезапускаем сервис"
            sudo systemctl restart flask_helpdesk

            echo ">>> Готово!"
