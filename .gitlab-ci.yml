default:
  image: python:3.12-slim
  tags:
    - linux
    - docker

stages:
  - test
  - build
  - deploy

variables:
  DEPLOY_PATH: "/opt/www/its.teztour.com"
  SERVICE_NAME: "flask-helpdesk"
  DEPLOY_DOMAIN: "its.tez-tour.com"

test_application:
  stage: test
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
  before_script:
    - python --version
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π..."
    - python -m py_compile app.py wsgi.py secure_config.py config.py
    - python -c "import wsgi; print('WSGI –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è')"
    - echo "‚úÖ –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã"

build_application:
  stage: build
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
  script:
    - echo "üì¶ –°–±–æ—Ä–∫–∞ deployment –ø–∞–∫–µ—Ç–∞..."
    - mkdir -p deployment_package
    - cp -r blog/ deployment_package/ 2>/dev/null || echo "‚ÑπÔ∏è blog/ –Ω–µ—Ç"
    - cp -r migrations/ deployment_package/ 2>/dev/null || echo "‚ÑπÔ∏è migrations/ –Ω–µ—Ç"
    - cp app.py wsgi.py requirements.txt secure_config.py config.py logging_config.py deployment_package/ 2>/dev/null || true
    - mkdir -p deployment_package/static deployment_package/templates
    - cp -r blog/static/* deployment_package/static/ 2>/dev/null || true
    - cp -r blog/templates/* deployment_package/templates/ 2>/dev/null || true
    - tar -czf deployment.tar.gz -C deployment_package .
    - ls -lh deployment.tar.gz
  artifacts:
    when: always
    paths:
      - deployment.tar.gz
      - deployment_package/
    expire_in: 1 day

deploy_to_server:
  stage: deploy
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
  before_script:
    - apt-get update -y && apt-get install -y openssh-client
    - |
      if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$DEPLOY_SERVER" ] || [ -z "$DEPLOY_USER" ]; then
        echo "‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–µ–ø–ª–æ—è –Ω–µ –∑–∞–¥–∞–Ω—ã. –¢—Ä–µ–±—É—é—Ç—Å—è: SSH_PRIVATE_KEY, DEPLOY_SERVER, DEPLOY_USER"; exit 0;
      fi
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh && chmod 700 ~/.ssh
    - ssh-keyscan -H "$DEPLOY_SERVER" >> ~/.ssh/known_hosts
  script:
    - |
      echo "üì§ –ü–µ—Ä–µ–¥–∞—á–∞ –∏ –¥–µ–ø–ª–æ–π..."
      test -f deployment.tar.gz || { echo "‚ùå –ù–µ—Ç deployment.tar.gz"; exit 1; }
      scp -o StrictHostKeyChecking=no deployment.tar.gz "$DEPLOY_USER@$DEPLOY_SERVER:/tmp/deployment.tar.gz"
      ssh -o StrictHostKeyChecking=no "$DEPLOY_USER@$DEPLOY_SERVER" "
        set -e
        mkdir -p /tmp/flask-deploy && cd /tmp/flask-deploy
        tar -xzf /tmp/deployment.tar.gz
        sudo mkdir -p $DEPLOY_PATH
        sudo rsync -a --delete ./ $DEPLOY_PATH/
        python3 -m venv $DEPLOY_PATH/venv || true
        . $DEPLOY_PATH/venv/bin/activate
        pip install --upgrade pip
        pip install -r $DEPLOY_PATH/requirements.txt
        sudo systemctl daemon-reload || true
        sudo systemctl restart $SERVICE_NAME || true
      "
    - echo "ÔøΩÔøΩ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω"
