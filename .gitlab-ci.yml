stages:
  - validate
  - test
  - build
  - pre-deploy
  - deploy
  - post-deploy
  - rollback

variables:
  DEPLOY_PATH: "/var/www/flask_helpdesk"
  SERVICE_NAME: "flask-helpdesk"
  BACKUP_PATH: "/var/backups/flask_helpdesk"
  SOCKET_PATH: "/run/gunicorn/gunicorn.sock"
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  AFTER_SCRIPT_IGNORE_ERRORS: false

cache:
  paths:
    - .cache/pip/

# ============ –≠–¢–ê–ü 1: –í–ê–õ–ò–î–ê–¶–ò–Ø ============
validate_syntax:
  stage: validate
  image: python:3.9-slim
  script:
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Python..."
    - python -m py_compile app.py
    - echo "‚úÖ –°–∏–Ω—Ç–∞–∫—Å–∏—Å –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_REF_NAME == "main"'

# ============ –≠–¢–ê–ü 2: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï ============
run_tests:
  stage: test
  image: python:3.9-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq git
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤..."
    - python -m pytest tests/ -v || echo "‚ö†Ô∏è –¢–µ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –∏–ª–∏ –∑–∞–≤–µ—Ä—à–∏–ª–∏—Å—å —Å –æ—à–∏–±–∫–∞–º–∏"
    - echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_REF_NAME == "main"'
  allow_failure: true

# ============ –≠–¢–ê–ü 3: –°–ë–û–†–ö–ê ============
build_deployment_package:
  stage: build
  image: alpine:latest
  before_script:
    - apk add --no-cache tar gzip
  script:
    - echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ –¥–ª—è –¥–µ–ø–ª–æ—è..."
    - mkdir -p deployment_package
    - cp -r blog/ deployment_package/ || echo "‚ö†Ô∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è blog –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    - cp -r static/ deployment_package/ || echo "‚ö†Ô∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è static –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    - cp -r templates/ deployment_package/ || echo "‚ö†Ô∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è templates –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    - cp -r migrations/ deployment_package/ || echo "‚ö†Ô∏è –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è migrations –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    - cp app.py deployment_package/ || echo "‚ö†Ô∏è –§–∞–π–ª app.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - cp requirements.txt deployment_package/ || echo "‚ö†Ô∏è –§–∞–π–ª requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - cp flask-helpdesk.service deployment_package/ || echo "‚ö†Ô∏è –§–∞–π–ª flask-helpdesk.service –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - cp flask-helpdesk.nginx.conf deployment_package/ || echo "‚ö†Ô∏è –§–∞–π–ª flask-helpdesk.nginx.conf –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - cp config.ini deployment_package/ || echo "‚ö†Ô∏è –§–∞–π–ª config.ini –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - cp *.py deployment_package/ || echo "‚ö†Ô∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ .py —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    - cd deployment_package && tar -czf ../deployment_package.tar.gz . && cd ..
    - echo "üì¶ –ü–æ–ª–Ω–æ–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞—Ä—Ö–∏–≤–∞ deployment_package.tar.gz:"
    - tar -tvf deployment_package.tar.gz
    - echo "‚úÖ –ü–∞–∫–µ—Ç –¥–ª—è –¥–µ–ø–ª–æ—è —Å–æ–∑–¥–∞–Ω deployment_package.tar.gz"
    - echo "üìè –†–∞–∑–º–µ—Ä –ø–∞–∫–µ—Ç–∞ $(du -h deployment_package.tar.gz | cut -f1)"
  artifacts:
    paths:
      - deployment_package.tar.gz
      - deployment_package/
    expire_in: 1 day
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'

# ============ –≠–¢–ê–ü 4: –ü–†–ï–î–í–ê–†–ò–¢–ï–õ–¨–ù–´–ï –ü–†–û–í–ï–†–ö–ò ============
pre_deploy_checks:
  stage: pre-deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
  script:
    - |
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
      echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
      if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$DEPLOY_SERVER" ] || [ -z "$DEPLOY_USER" ]; then
        echo "‚ÑπÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–µ–ø–ª–æ—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫–∏"
        echo "‚úÖ –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–±–∞–≤—å—Ç–µ SSH_PRIVATE_KEY, DEPLOY_SERVER, DEPLOY_USER –≤ GitLab CI/CD Settings"
        exit 0
      fi

      echo "‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–µ–ø–ª–æ—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

      # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
      eval $(ssh-agent -s)

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞
      echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏..."
      if [ -f "$SSH_PRIVATE_KEY" ]; then
        echo "üìÅ SSH_PRIVATE_KEY —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É: $SSH_PRIVATE_KEY"

        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
        echo "üîç –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ –∫–ª—é—á–∞:"
        echo "   –†–∞–∑–º–µ—Ä: $(wc -c < "$SSH_PRIVATE_KEY") –±–∞–π—Ç"
        echo "   –°—Ç—Ä–æ–∫: $(wc -l < "$SSH_PRIVATE_KEY")"
        echo "   –ü–µ—Ä–≤—ã–µ 2 —Å—Ç—Ä–æ–∫–∏:"
        head -n 2 "$SSH_PRIVATE_KEY" | cat -A
        echo "   –ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Å—Ç—Ä–æ–∫–∏:"
        tail -n 2 "$SSH_PRIVATE_KEY" | cat -A

        # –°–æ–∑–¥–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –∫–ª—é—á–∞
        echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ SSH –∫–ª—é—á–∞..."
        SSH_KEY_CONTENT=$(mktemp)

        # –ë–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∫–ª—é—á–∞
        cat "$SSH_PRIVATE_KEY" | \
          sed 's/\$$//g' | \
          sed 's/\r//g' | \
          sed 's/[[:space:]]*$//' | \
          sed '/^$/d' | \
          awk '/^-----BEGIN/{p=1} p{print} /^-----END/{p=0}' > "$SSH_KEY_CONTENT"

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
        chmod 600 "$SSH_KEY_CONTENT"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∫–ª—é—á–∞
        if ssh-keygen -l -f "$SSH_KEY_CONTENT" >/dev/null 2>&1; then
          echo "‚úÖ SSH –∫–ª—é—á –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –≤–∞–ª–∏–¥–µ–Ω"
        else
          echo "‚ùå SSH –∫–ª—é—á –≤—Å–µ –µ—â–µ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω, –ø—Ä–æ–±—É–µ–º base64 –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ..."
          if cat "$SSH_PRIVATE_KEY" | base64 -d > "$SSH_KEY_CONTENT" 2>/dev/null; then
            chmod 600 "$SSH_KEY_CONTENT"
            if ssh-keygen -l -f "$SSH_KEY_CONTENT" >/dev/null 2>&1; then
              echo "‚úÖ SSH –∫–ª—é—á —É—Å–ø–µ—à–Ω–æ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω –∏–∑ base64"
            else
              echo "‚ùå –ö–ª—é—á –Ω–µ–≤–∞–ª–∏–¥–µ–Ω –¥–∞–∂–µ –ø–æ—Å–ª–µ base64 –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è"
              exit 1
            fi
          else
            echo "‚ùå Base64 –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å"
            exit 1
          fi
        fi
      else
        echo "üìù SSH_PRIVATE_KEY —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–ª—é—á–∞"
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è SSH –∫–ª—é—á–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
        SSH_KEY_CONTENT=$(mktemp)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ —Å -----BEGIN (–æ–±—ã—á–Ω—ã–π –∫–ª—é—á) –∏–ª–∏ —ç—Ç–æ base64
        if echo "$SSH_PRIVATE_KEY" | head -c 10 | grep -q "^-----BEGIN"; then
          echo "üîë –û–±—ã—á–Ω—ã–π SSH –∫–ª—é—á"
          printf '%s\n' "$SSH_PRIVATE_KEY" > "$SSH_KEY_CONTENT"
        else
          echo "üîê Base64 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SSH –∫–ª—é—á, –¥–µ–∫–æ–¥–∏—Ä—É–µ–º"
          echo "$SSH_PRIVATE_KEY" | base64 -d > "$SSH_KEY_CONTENT"
        fi

        chmod 600 "$SSH_KEY_CONTENT"
      fi

      # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á –≤ SSH –∞–≥–µ–Ω—Ç
      if ! ssh-add "$SSH_KEY_CONTENT"; then
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å SSH –∫–ª—é—á –≤ –∞–≥–µ–Ω—Ç"
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –µ–≥–æ —Å–æ–∑–¥–∞–ª–∏
        if [ "$SSH_KEY_CONTENT" != "$SSH_PRIVATE_KEY" ]; then
          rm -f "$SSH_KEY_CONTENT"
        fi
        exit 1
      fi

      # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –µ–≥–æ —Å–æ–∑–¥–∞–ª–∏)
      if [ "$SSH_KEY_CONTENT" != "$SSH_PRIVATE_KEY" ]; then
        rm -f "$SSH_KEY_CONTENT"
      fi

      mkdir -p ~/.ssh
      chmod 700 ~/.ssh
      ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts

      echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."

      echo "üîç –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞..."

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      if ! ssh $DEPLOY_USER@$DEPLOY_SERVER "echo 'SSH —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ OK'"; then
        echo "‚ùå –û—à–∏–±–∫–∞ SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
        exit 1
      fi

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –∏ –æ—á–∏—Å—Ç–∫–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
      echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞..."
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        df -h ${DEPLOY_PATH:-/var/www/flask_helpdesk}
        AVAILABLE_SPACE=\$(df ${DEPLOY_PATH:-/var/www/flask_helpdesk} | awk 'NR==2 {print \$4}')
        echo \"–î–æ—Å—Ç—É–ø–Ω–æ: \$((\$AVAILABLE_SPACE / 1024)) MB\"

        if [ \"\$AVAILABLE_SPACE\" -lt 512000 ]; then
          echo '‚ö†Ô∏è –ú–∞–ª–æ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞, –≤—ã–ø–æ–ª–Ω—è–µ–º –æ—á–∏—Å—Ç–∫—É...'

          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ª–æ–≥–∏
          sudo journalctl --vacuum-time=7d

          # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã (–æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3)
          if [ -d '/var/backups/flask_helpdesk' ]; then
            cd /var/backups/flask_helpdesk
            sudo ls -t backup_* 2>/dev/null | tail -n +4 | sudo xargs rm -rf
            echo '–°—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã –æ—á–∏—â–µ–Ω—ã'
          fi

          # –û—á–∏—â–∞–µ–º –∫–µ—à apt
          sudo apt-get clean

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–µ—Å—Ç–æ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
          AVAILABLE_SPACE_AFTER=\$(df ${DEPLOY_PATH:-/var/www/flask_helpdesk} | awk 'NR==2 {print \$4}')
          echo \"–ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ: \$((\$AVAILABLE_SPACE_AFTER / 1024)) MB\"

          if [ \"\$AVAILABLE_SPACE_AFTER\" -lt 256000 ]; then
            echo '‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –º–∞–ª–æ –º–µ—Å—Ç–∞ –¥–∞–∂–µ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏'
            df -h
            exit 1
          fi
        fi

        echo '‚úÖ –°–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ'
      "

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        DEPLOY_PATH_CHECK=\${DEPLOY_PATH:-/var/www/flask_helpdesk}

        if [ ! -w \"\$DEPLOY_PATH_CHECK\" ]; then
          echo '‚ùå –ù–µ—Ç –ø—Ä–∞–≤ –∑–∞–ø–∏—Å–∏ –≤ \$DEPLOY_PATH_CHECK'
          echo 'üîß –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤...'

          # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          sudo mkdir -p \$DEPLOY_PATH_CHECK

          # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
          sudo chown -R www-data:www-data \$DEPLOY_PATH_CHECK
          sudo chmod -R 755 \$DEPLOY_PATH_CHECK
          sudo chmod g+w \$DEPLOY_PATH_CHECK
          sudo usermod -aG www-data $DEPLOY_USER

          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –¥–µ–ø–ª–æ—è
          sudo chmod 775 \$DEPLOY_PATH_CHECK
          sudo chown $DEPLOY_USER:www-data \$DEPLOY_PATH_CHECK

          # –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
          if [ ! -w \"\$DEPLOY_PATH_CHECK\" ]; then
            echo '‚ùå –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ –ø–æ–º–æ–≥–ª–æ'
            echo 'üìã –í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:'
            echo '   sudo chmod 775 \$DEPLOY_PATH_CHECK'
            echo '   sudo chown $DEPLOY_USER:www-data \$DEPLOY_PATH_CHECK'
            exit 1
          else
            echo '‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏'
          fi
        else
          echo '‚úÖ –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã'
        fi
      "

      echo "‚úÖ –í—Å–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: always

# ============ –≠–¢–ê–ü 5: –î–ï–ü–õ–û–ô ============
deploy_to_server:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client rsync
  script:
    - |
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
      echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –¥–µ–ø–ª–æ—è..."
      if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$DEPLOY_SERVER" ] || [ -z "$DEPLOY_USER" ]; then
        echo "‚ÑπÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–µ–ø–ª–æ—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–µ–ø–ª–æ–π"
        echo "‚úÖ –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–±–∞–≤—å—Ç–µ SSH_PRIVATE_KEY, DEPLOY_SERVER, DEPLOY_USER –≤ GitLab CI/CD Settings"
        exit 0
      fi

      echo "‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–µ–ø–ª–æ—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

      # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
      eval $(ssh-agent -s)

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞
      echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏..."
      if [ -f "$SSH_PRIVATE_KEY" ]; then
        echo "üìÅ SSH_PRIVATE_KEY —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É: $SSH_PRIVATE_KEY"

        # –°–æ–∑–¥–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –∫–ª—é—á–∞
        echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ SSH –∫–ª—é—á–∞..."
        SSH_KEY_CONTENT=$(mktemp)

        # –£–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª—ã $ –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫ –∏ –¥—Ä—É–≥–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        cat "$SSH_PRIVATE_KEY" | sed 's/\$$//g' | tr -d '\r' | sed '/^$/d' > "$SSH_KEY_CONTENT"

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
        chmod 600 "$SSH_KEY_CONTENT"

        echo "‚úÖ SSH –∫–ª—é—á –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"
      else
        echo "üìù SSH_PRIVATE_KEY —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–ª—é—á–∞"
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è SSH –∫–ª—é—á–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
        SSH_KEY_CONTENT=$(mktemp)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ —Å -----BEGIN (–æ–±—ã—á–Ω—ã–π –∫–ª—é—á) –∏–ª–∏ —ç—Ç–æ base64
        if echo "$SSH_PRIVATE_KEY" | head -c 10 | grep -q "^-----BEGIN"; then
          echo "üîë –û–±—ã—á–Ω—ã–π SSH –∫–ª—é—á"
          printf '%s\n' "$SSH_PRIVATE_KEY" > "$SSH_KEY_CONTENT"
        else
          echo "üîê Base64 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SSH –∫–ª—é—á, –¥–µ–∫–æ–¥–∏—Ä—É–µ–º"
          echo "$SSH_PRIVATE_KEY" | base64 -d > "$SSH_KEY_CONTENT"
        fi

        chmod 600 "$SSH_KEY_CONTENT"
      fi

      # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á –≤ SSH –∞–≥–µ–Ω—Ç
      if ! ssh-add "$SSH_KEY_CONTENT"; then
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å SSH –∫–ª—é—á –≤ –∞–≥–µ–Ω—Ç"
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –µ–≥–æ —Å–æ–∑–¥–∞–ª–∏
        if [ "$SSH_KEY_CONTENT" != "$SSH_PRIVATE_KEY" ]; then
          rm -f "$SSH_KEY_CONTENT"
        fi
        exit 1
      fi

      # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –µ–≥–æ —Å–æ–∑–¥–∞–ª–∏)
      if [ "$SSH_KEY_CONTENT" != "$SSH_PRIVATE_KEY" ]; then
        rm -f "$SSH_KEY_CONTENT"
      fi

      mkdir -p ~/.ssh
      chmod 700 ~/.ssh
      ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts

      echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."

      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      DEPLOY_PATH=${DEPLOY_PATH:-/var/www/flask_helpdesk}
      BACKUP_PATH=${BACKUP_PATH:-/var/backups/flask_helpdesk}
      SERVICE_NAME=${SERVICE_NAME:-flask-helpdesk}

      # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        echo 'üíæ –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø...'
        if [ -d '$DEPLOY_PATH' ]; then
          sudo mkdir -p $BACKUP_PATH
          sudo cp -r $DEPLOY_PATH $BACKUP_PATH/backup_\$(date +%Y%m%d_%H%M%S)
          echo '‚úÖ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω'
        fi
      "

      # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        echo '‚èπÔ∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å...'
        if sudo systemctl is-active --quiet $SERVICE_NAME; then
          sudo systemctl stop $SERVICE_NAME
          echo '‚úÖ –°–µ—Ä–≤–∏—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'
        else
          echo '‚ÑπÔ∏è –°–µ—Ä–≤–∏—Å —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'
        fi
      "

      # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        echo 'üîß –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π...'
        sudo mkdir -p $DEPLOY_PATH
        sudo chown -R www-data:www-data $DEPLOY_PATH
        sudo chmod -R 755 $DEPLOY_PATH
      "

      # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
      echo 'üìÅ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã...'
      if [ -f "deployment_package.tar.gz" ]; then
        echo 'üóúÔ∏è –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∂–∞—Ç—ã–π –∞—Ä—Ö–∏–≤ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏'
        scp deployment_package.tar.gz $DEPLOY_USER@$DEPLOY_SERVER:/tmp/
        ssh $DEPLOY_USER@$DEPLOY_SERVER "
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏
          RELEASE_DIR=\$(mktemp -d)

          # –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –∞—Ä—Ö–∏–≤ –≤ —ç—Ç—É –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
          echo "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –≤ \$RELEASE_DIR..."
          sudo tar -xzf /tmp/deployment_package.tar.gz -C \$RELEASE_DIR

          # –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é, –ò–°–ö–õ–Æ–ß–ê–Ø –ë–ê–ó–£ –î–ê–ù–ù–´–•
          # –ö–ª—é—á --delete —É–¥–∞–ª—è–µ—Ç —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–∏
          echo '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º blog/db...'
          sudo rsync -av --exclude 'blog/db' --delete \$RELEASE_DIR/ $DEPLOY_PATH/

          # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
          echo '–û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤...'
          sudo rm -rf \$RELEASE_DIR
          sudo rm -f /tmp/deployment_package.tar.gz

          echo '‚úÖ –ê—Ä—Ö–∏–≤ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω –∏ —Ñ–∞–π–ª—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ë–î'
        "
        # >>> –ù–û–í–´–ô –ë–õ–û–ö –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò <<<
        ssh $DEPLOY_USER@$DEPLOY_SERVER "
          echo '---'
          echo 'üîç –ü–†–û–í–ï–†–ö–ê –§–ê–ô–õ–û–í –ù–ê –°–ï–†–í–ï–†–ï –ü–û–°–õ–ï –†–ê–°–ü–ê–ö–û–í–ö–ò'
          echo '---'
          cd $DEPLOY_PATH
          echo '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:'
          sudo ls -la
          echo '---'
          echo '–ù–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞ mysql_db.py (–ø–µ—Ä–≤—ã–µ 40 —Å—Ç—Ä–æ–∫):'
          sudo head -n 40 mysql_db.py
          echo '---'
          echo '–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ config.ini:'
          sudo cat config.ini
          echo '---'
        "
        # >>> –ö–û–ù–ï–¶ –ë–õ–û–ö–ê –î–ò–ê–ì–ù–û–°–¢–ò–ö–ò <<<
      else
        echo 'üìÅ –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—ã—á–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é'
        rsync -avz --delete deployment_package/ $DEPLOY_USER@$DEPLOY_SERVER:$DEPLOY_PATH/
      fi

      # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –ø–æ—Å–ª–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        echo 'üîß –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞...'
        sudo chown -R www-data:www-data $DEPLOY_PATH
        sudo find $DEPLOY_PATH -type d -exec chmod 755 {} \;
        sudo find $DEPLOY_PATH -type f -exec chmod 644 {} \;
        sudo chmod +x $DEPLOY_PATH/app.py
      "

      # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        echo '‚öôÔ∏è –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞...'
        cd $DEPLOY_PATH
        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π —Ñ–∞–π–ª, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–≤–µ–∂—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
        sudo rm -f .env.production

        echo '# –î–ª—è Linux –ø—Ä–æ–¥–∞–∫—à–Ω' | sudo tee .env.production > /dev/null
        echo 'FLASK_ENV=production' | sudo tee -a .env.production > /dev/null
        echo 'FLASK_APP=wsgi.py' | sudo tee -a .env.production > /dev/null
        echo 'ORACLE_CLIENT_PATH=/opt/oracle/instantclient' | sudo tee -a .env.production > /dev/null
        echo 'SQLALCHEMY_DATABASE_URI=sqlite:///blog/db/blog.db?timeout=30' | sudo tee -a .env.production > /dev/null
        echo 'SQLALCHEMY_TRACK_MODIFICATIONS=True' | sudo tee -a .env.production > /dev/null

        # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏—è Oracle
        echo 'SQLALCHEMY_DATABASE_URI_ORACLE_CRM=oracle+oracledb://crm:sunzHa@10.7.23.4:1521/ENIS' | sudo tee -a .env.production > /dev/null
        echo 'SQLALCHEMY_SALES_SCHEMA_URI_ORACLE_SALES=oracle+oracledb://sales:sunzHa1@10.7.23.4:1521/ENIS' | sudo tee -a .env.production > /dev/null

        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è MySQL –¥–ª—è Redmine
        echo 'MYSQL_HOST=helpdesk.teztour.com' | sudo tee -a .env.production > /dev/null
        echo 'MYSQL_DATABASE=redmine' | sudo tee -a .env.production > /dev/null
        echo 'MYSQL_USER=easyredmine' | sudo tee -a .env.production > /dev/null
        echo 'MYSQL_PASSWORD=QhAKtwCLGW' | sudo tee -a .env.production > /dev/null

        # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è MySQL –¥–ª—è Quality
        echo 'MYSQL_QUALITY_HOST=quality.teztour.com' | sudo tee -a .env.production > /dev/null
        echo 'MYSQL_QUALITY_DATABASE=redmine' | sudo tee -a .env.production > /dev/null
        echo 'MYSQL_QUALITY_USER=easyredmine' | sudo tee -a .env.production > /dev/null
        echo 'MYSQL_QUALITY_PASSWORD=QhAKtwCLGW' | sudo tee -a .env.production > /dev/null

        sudo chown www-data:www-data .env.production
        sudo chmod 600 .env.production
        echo '‚úÖ –§–∞–π–ª .env.production —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω'

        # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
        sudo mkdir -p $DEPLOY_PATH/blog/db
        sudo chown -R www-data:www-data $DEPLOY_PATH/blog/db
        sudo chmod -R 755 $DEPLOY_PATH/blog/db
        echo '‚úÖ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞'
      "

      # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        echo 'üóÑÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...'
        cd $DEPLOY_PATH
        if [ ! -f 'blog/db/blog.db' ]; then
          echo '–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...'
          sudo -u www-data $DEPLOY_PATH/venv/bin/python -c 'from blog import create_app; from blog.models import db; app = create_app(); app.app_context().push(); db.create_all(); print(\"–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ\")' || echo '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–≤–æ–∑–º–æ–∂–Ω–æ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)'
          echo '‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞'
        else
          echo '‚ÑπÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç'
        fi
      "

      # –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        echo 'üêç –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Python –æ–∫—Ä—É–∂–µ–Ω–∏–µ...'
        cd $DEPLOY_PATH

        # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ venv –µ—Å–ª–∏ –µ—Å—Ç—å
        if [ -d 'venv' ]; then
          sudo rm -rf venv
        fi

        # –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ venv
        sudo python3 -m venv venv --prompt flask_helpdesk
        sudo chown -R www-data:www-data venv/

        # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        sudo -u www-data venv/bin/pip install --upgrade pip
        sudo -u www-data venv/bin/pip install -r requirements.txt

        echo '‚úÖ Python –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ'
      "

      # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º systemd —Å–µ—Ä–≤–∏—Å
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        echo '‚öôÔ∏è –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º systemd —Å–µ—Ä–≤–∏—Å...'

        # –ö–æ–ø–∏—Ä—É–µ–º service —Ñ–∞–π–ª
        sudo cp $DEPLOY_PATH/flask-helpdesk.service /etc/systemd/system/
        sudo systemctl daemon-reload
        sudo systemctl enable $SERVICE_NAME

        # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥ Nginx –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π SOCKET_PATH
        if [ -f "$DEPLOY_PATH/flask-helpdesk.nginx.conf" ]; then
          echo 'üåê –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥ Nginx...'
          sudo cp $DEPLOY_PATH/flask-helpdesk.nginx.conf /etc/nginx/vhosts.d/flask-helpdesk.conf
          # –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é SOCKET_PATH, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è
          sudo sed -i "s#proxy_pass .*;#proxy_pass http://unix:${SOCKET_PATH};#" /etc/nginx/vhosts.d/flask-helpdesk.conf
          sudo nginx -t && sudo systemctl reload nginx
          echo '‚úÖ Nginx –∫–æ–Ω—Ñ–∏–≥ –ø—Ä–∏–º–µ–Ω—ë–Ω'
        else
          echo '‚ö†Ô∏è Nginx –∫–æ–Ω—Ñ–∏–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–µ–ø–ª–æ–π –ø–∞–∫–µ—Ç–µ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º'
        fi

        echo '‚úÖ Systemd —Å–µ—Ä–≤–∏—Å –Ω–∞—Å—Ç—Ä–æ–µ–Ω'
      "

      # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        echo '‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å...'
        sudo systemctl start $SERVICE_NAME

        # –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
        sleep 5

        if sudo systemctl is-active --quiet $SERVICE_NAME; then
          echo '‚úÖ –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ'
        else
          echo '‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞'
          echo 'üìã –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞:'
          sudo systemctl status $SERVICE_NAME --no-pager
          echo 'üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞:'
          sudo journalctl -u $SERVICE_NAME -n 20 --no-pager
          echo 'üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ wsgi.py:'
          if [ -f '$DEPLOY_PATH/wsgi.py' ]; then
            echo '‚úÖ wsgi.py –Ω–∞–π–¥–µ–Ω'
            head -10 '$DEPLOY_PATH/wsgi.py'
          else
            echo '‚ùå wsgi.py –Ω–µ –Ω–∞–π–¥–µ–Ω'
            echo 'üìÅ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:'
            ls -la '$DEPLOY_PATH/'
          fi
          echo 'üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ config.ini:'
          if [ -f '$DEPLOY_PATH/config.ini' ]; then
            echo '‚úÖ config.ini –Ω–∞–π–¥–µ–Ω'
            echo '–°–µ–∫—Ü–∏–∏ –≤ config.ini:'
            grep '^\[' '$DEPLOY_PATH/config.ini'
          else
            echo '‚ùå config.ini –Ω–µ –Ω–∞–π–¥–µ–Ω'
          fi
          echo 'üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è:'
          if [ -f '$DEPLOY_PATH/venv/bin/python' ]; then
            echo '‚úÖ Python –≤ venv –Ω–∞–π–¥–µ–Ω'
            sudo -u www-data '$DEPLOY_PATH/venv/bin/python' --version
          else
            echo '‚ùå Python –≤ venv –Ω–µ –Ω–∞–π–¥–µ–Ω'
          fi
          echo 'üìã –ü–æ–ø—ã—Ç–∫–∞ —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:'
          cd '$DEPLOY_PATH'
          sudo -u www-data timeout 10s '$DEPLOY_PATH/venv/bin/python' wsgi.py || echo '–†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π'
          exit 1
        fi
      "

      echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: always

# ============ –≠–¢–ê–ü 6: –ü–û–°–¢-–î–ï–ü–õ–û–ô –ü–†–û–í–ï–†–ö–ò ============
post_deploy_verification:
  stage: post-deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client curl
  script:
    - |
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
      echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏..."
      if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$DEPLOY_SERVER" ] || [ -z "$DEPLOY_USER" ]; then
        echo "‚ÑπÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–µ–ø–ª–æ—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é"
        echo "‚úÖ –î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–æ–±–∞–≤—å—Ç–µ SSH_PRIVATE_KEY, DEPLOY_SERVER, DEPLOY_USER –≤ GitLab CI/CD Settings"
        exit 0
      fi

      echo "‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

      # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
      eval $(ssh-agent -s)

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞
      echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏..."
      if [ -f "$SSH_PRIVATE_KEY" ]; then
        echo "üìÅ SSH_PRIVATE_KEY —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É: $SSH_PRIVATE_KEY"

        # –°–æ–∑–¥–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –∫–ª—é—á–∞
        echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ SSH –∫–ª—é—á–∞..."
        SSH_KEY_CONTENT=$(mktemp)

        # –£–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª—ã $ –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫ –∏ –¥—Ä—É–≥–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        cat "$SSH_PRIVATE_KEY" | sed 's/\$$//g' | tr -d '\r' | sed '/^$/d' > "$SSH_KEY_CONTENT"

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
        chmod 600 "$SSH_KEY_CONTENT"

        echo "‚úÖ SSH –∫–ª—é—á –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"
      else
        echo "üìù SSH_PRIVATE_KEY —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–ª—é—á–∞"
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è SSH –∫–ª—é—á–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
        SSH_KEY_CONTENT=$(mktemp)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ —Å -----BEGIN (–æ–±—ã—á–Ω—ã–π –∫–ª—é—á) –∏–ª–∏ —ç—Ç–æ base64
        if echo "$SSH_PRIVATE_KEY" | head -c 10 | grep -q "^-----BEGIN"; then
          echo "üîë –û–±—ã—á–Ω—ã–π SSH –∫–ª—é—á"
          printf '%s\n' "$SSH_PRIVATE_KEY" > "$SSH_KEY_CONTENT"
        else
          echo "üîê Base64 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SSH –∫–ª—é—á, –¥–µ–∫–æ–¥–∏—Ä—É–µ–º"
          echo "$SSH_PRIVATE_KEY" | base64 -d > "$SSH_KEY_CONTENT"
        fi

        chmod 600 "$SSH_KEY_CONTENT"
      fi

      # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á –≤ SSH –∞–≥–µ–Ω—Ç
      if ! ssh-add "$SSH_KEY_CONTENT"; then
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å SSH –∫–ª—é—á –≤ –∞–≥–µ–Ω—Ç"
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –µ–≥–æ —Å–æ–∑–¥–∞–ª–∏
        if [ "$SSH_KEY_CONTENT" != "$SSH_PRIVATE_KEY" ]; then
          rm -f "$SSH_KEY_CONTENT"
        fi
        exit 1
      fi

      # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –µ–≥–æ —Å–æ–∑–¥–∞–ª–∏)
      if [ "$SSH_KEY_CONTENT" != "$SSH_PRIVATE_KEY" ]; then
        rm -f "$SSH_KEY_CONTENT"
      fi

      mkdir -p ~/.ssh
      chmod 700 ~/.ssh
      ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts

      echo "üîç –ü–æ—Å—Ç-–¥–µ–ø–ª–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è..."

      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      DEPLOY_PATH=${DEPLOY_PATH:-/var/www/flask_helpdesk}
      SERVICE_NAME=${SERVICE_NAME:-flask-helpdesk}

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        echo 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞...'
        if sudo systemctl is-active --quiet $SERVICE_NAME; then
          echo '‚úÖ –°–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç'
          sudo systemctl status $SERVICE_NAME --no-pager
        else
          echo '‚ùå –°–µ—Ä–≤–∏—Å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç'
          sudo systemctl status $SERVICE_NAME --no-pager
          exit 1
        fi
      "

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        echo 'üìÅ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–µ–ø–ª–æ—è...'
        if [ -f '$DEPLOY_PATH/app.py' ]; then
          echo '‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞–π–¥–µ–Ω'
        else
          echo '‚ùå –û—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω'
          exit 1
        fi

        if [ -d '$DEPLOY_PATH/venv' ]; then
          echo '‚úÖ –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ'
        else
          echo '‚ùå –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'
          exit 1
        fi
      "

      # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω –ø–æ—Ä—Ç)
      if [ -n "$APP_PORT" ]; then
        echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –ø–æ—Ä—Ç—É $APP_PORT..."
        if curl -f -s "http://$DEPLOY_SERVER:$APP_PORT" >/dev/null; then
          echo "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ"
        else
          echo "‚ö†Ô∏è –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –∏–ª–∏ –µ—â–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è"
        fi
      fi

      echo 'üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∫–µ—Ç–∞ –∏ HTTP health-—á–µ–∫–∞...'
      if [ -S "${SOCKET_PATH}" ]; then
        echo '‚úÖ Socket –Ω–∞–π–¥–µ–Ω: ${SOCKET_PATH}'
      else
        echo '‚ùå Socket –Ω–µ –Ω–∞–π–¥–µ–Ω: ${SOCKET_PATH}'
        exit 1
      fi

      if curl -sf http://127.0.0.1/ >/dev/null; then
        echo '‚úÖ HTTP endpoint / –æ—Ç–≤–µ—Ç–∏–ª 200'
      else
        echo '‚ùå HTTP endpoint / –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç'
        exit 1
      fi

      echo "üéâ –ü–æ—Å—Ç-–¥–µ–ø–ª–æ–π –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: always

# ============ –≠–¢–ê–ü 7: –û–¢–ö–ê–¢ (–†–£–ß–ù–û–ô) ============
rollback_deployment:
  stage: rollback
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client
  script:
    - |
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
      echo "üîÑ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –æ—Ç–∫–∞—Ç—É –¥–µ–ø–ª–æ—è..."
      if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$DEPLOY_SERVER" ] || [ -z "$DEPLOY_USER" ]; then
        echo "‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–µ–ø–ª–æ—è –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
        exit 1
      fi

      # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º SSH —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
      eval $(ssh-agent -s)

      # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞
      echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH –∫–ª—é—á–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏..."
      if [ -f "$SSH_PRIVATE_KEY" ]; then
        echo "üìÅ SSH_PRIVATE_KEY —Å–æ–¥–µ—Ä–∂–∏—Ç –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É: $SSH_PRIVATE_KEY"

        # –°–æ–∑–¥–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –∫–ª—é—á–∞
        echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ–æ—Ä–º–∞—Ç–∞ SSH –∫–ª—é—á–∞..."
        SSH_KEY_CONTENT=$(mktemp)

        # –£–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª—ã $ –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫ –∏ –¥—Ä—É–≥–∏–µ –ø—Ä–æ–±–ª–µ–º—ã —Å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
        cat "$SSH_PRIVATE_KEY" | sed 's/\$$//g' | tr -d '\r' | sed '/^$/d' > "$SSH_KEY_CONTENT"

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
        chmod 600 "$SSH_KEY_CONTENT"

        echo "‚úÖ SSH –∫–ª—é—á –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é"
      else
        echo "üìù SSH_PRIVATE_KEY —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–ª—é—á–∞"
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è SSH –∫–ª—é—á–∞ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø—Ä–∞–≤–∞–º–∏
        SSH_KEY_CONTENT=$(mktemp)

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ —Å -----BEGIN (–æ–±—ã—á–Ω—ã–π –∫–ª—é—á) –∏–ª–∏ —ç—Ç–æ base64
        if echo "$SSH_PRIVATE_KEY" | head -c 10 | grep -q "^-----BEGIN"; then
          echo "üîë –û–±—ã—á–Ω—ã–π SSH –∫–ª—é—á"
          printf '%s\n' "$SSH_PRIVATE_KEY" > "$SSH_KEY_CONTENT"
        else
          echo "üîê Base64 –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SSH –∫–ª—é—á, –¥–µ–∫–æ–¥–∏—Ä—É–µ–º"
          echo "$SSH_PRIVATE_KEY" | base64 -d > "$SSH_KEY_CONTENT"
        fi

        chmod 600 "$SSH_KEY_CONTENT"
      fi

      # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á –≤ SSH –∞–≥–µ–Ω—Ç
      if ! ssh-add "$SSH_KEY_CONTENT"; then
        echo "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å SSH –∫–ª—é—á –≤ –∞–≥–µ–Ω—Ç"
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –µ–≥–æ —Å–æ–∑–¥–∞–ª–∏
        if [ "$SSH_KEY_CONTENT" != "$SSH_PRIVATE_KEY" ]; then
          rm -f "$SSH_KEY_CONTENT"
        fi
        exit 1
      fi

      # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –µ–≥–æ —Å–æ–∑–¥–∞–ª–∏)
      if [ "$SSH_KEY_CONTENT" != "$SSH_PRIVATE_KEY" ]; then
        rm -f "$SSH_KEY_CONTENT"
      fi

      mkdir -p ~/.ssh
      chmod 700 ~/.ssh
      ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts

      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      DEPLOY_PATH=${DEPLOY_PATH:-/var/www/flask_helpdesk}
      BACKUP_PATH=${BACKUP_PATH:-/var/backups/flask_helpdesk}
      SERVICE_NAME=${SERVICE_NAME:-flask-helpdesk}

      echo "üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º –æ—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏..."

      # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        echo '‚èπÔ∏è –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å...'
        sudo systemctl stop $SERVICE_NAME
      "

      # –ò—â–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –±—ç–∫–∞–ø –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        echo 'üîç –ü–æ–∏—Å–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±—ç–∫–∞–ø–∞...'
        LATEST_BACKUP=\$(ls -t $BACKUP_PATH/backup_* 2>/dev/null | head -1)

        if [ -z \"\$LATEST_BACKUP\" ]; then
          echo '‚ùå –ë—ç–∫–∞–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'
          exit 1
        fi

        echo \"üì¶ –ù–∞–π–¥–µ–Ω –±—ç–∫–∞–ø: \$LATEST_BACKUP\"
        echo 'üîÑ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ –±—ç–∫–∞–ø–∞...'

        sudo rm -rf $DEPLOY_PATH/*
        sudo cp -r \$LATEST_BACKUP/* $DEPLOY_PATH/
        sudo chown -R www-data:www-data $DEPLOY_PATH

        echo '‚úÖ –§–∞–π–ª—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã'
      "

      # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
      ssh $DEPLOY_USER@$DEPLOY_SERVER "
        echo '‚ñ∂Ô∏è –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å...'
        sudo systemctl start $SERVICE_NAME

        sleep 5

        if sudo systemctl is-active --quiet $SERVICE_NAME; then
          echo '‚úÖ –û—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ'
        else
          echo '‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø–æ—Å–ª–µ –æ—Ç–∫–∞—Ç–∞'
          sudo systemctl status $SERVICE_NAME
          exit 1
        fi
      "

      echo "üéâ –û—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: manual
      allow_failure: false
