stages:
  - validate
  - test
  - build

variables:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip/

validate_project:
  stage: validate
  image: python:3.11-slim
  script:
    - echo "Validating project structure"
    - ls -la
    - find . -name "*.py" | wc -l | xargs echo "Python files:"
    - find . -name "*.html" | wc -l | xargs echo "HTML templates:"
  only:
    - main
    - merge_requests

test_dependencies:
  stage: test
  image: python:3.11-slim
  before_script:
    - apt-get update -qy
    - apt-get install -y gcc g++ libffi-dev libssl-dev default-libmysqlclient-dev pkg-config
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
  script:
    - source venv/bin/activate
    - echo "Installing dependencies..."
    - pip install -r requirements.txt
    - echo "Testing Flask application import..."
    - python -c "from blog import create_app; app = create_app(); print('Flask app created successfully')"
    - echo "Basic application tests completed"
  only:
    - main
    - merge_requests

build_application:
  stage: build
  image: python:3.11-slim
  script:
    - echo "Building Flask application..."
    - echo "Creating lightweight deployment package..."
    - mkdir -p /tmp/deploy
    - mkdir -p /tmp/archive
    - cp -r blog /tmp/deploy/
    - cp -r migrations /tmp/deploy/ || echo "No migrations directory"
    - cp -r static /tmp/deploy/ || echo "No static directory"
    - cp -r templates /tmp/deploy/ || echo "No templates directory"
    - cp requirements.txt /tmp/deploy/
    - cp wsgi.py /tmp/deploy/ || echo "No wsgi.py"
    - cp config.py /tmp/deploy/ || echo "No config.py"
    - cp *.py /tmp/deploy/ || echo "No additional Python files"
    - echo "Creating archive..."
    - cd /tmp/archive
    - tar -czf flask-helpdesk-${CI_COMMIT_SHA}.tar.gz -C /tmp/deploy .
    - mv flask-helpdesk-${CI_COMMIT_SHA}.tar.gz ${CI_PROJECT_DIR}/
    - cd ${CI_PROJECT_DIR}
    - echo "Build completed successfully"
    - ls -lah flask-helpdesk-${CI_COMMIT_SHA}.tar.gz
  artifacts:
    paths:
      - flask-helpdesk-${CI_COMMIT_SHA}.tar.gz
    expire_in: 1 week
  only:
    - main
