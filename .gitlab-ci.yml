stages:
  - validate
  - test
  - build
  - deploy

variables:
  PYTHON_VERSION: "3.11"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  AFTER_SCRIPT_IGNORE_ERRORS: false

cache:
  paths:
    - .cache/pip/

validate_project:
  stage: validate
  image: python:3.11-slim
  script:
    - echo "Validating project structure"
    - ls -la
    - find . -name "*.py" | wc -l | xargs echo "Python files:"
    - find . -name "*.html" | wc -l | xargs echo "HTML templates:"
  only:
    - main
    - merge_requests

test_dependencies:
  stage: test
  image: python:3.11-slim
  before_script:
    - apt-get update -qy
    - apt-get install -y gcc g++ libffi-dev libssl-dev default-libmysqlclient-dev pkg-config
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
  script:
    - source venv/bin/activate
    - echo "Installing dependencies..."
    - pip install -r requirements.txt
    - echo "Testing Flask application import..."
    - python -c "from blog import create_app; app = create_app(); print('Flask app created successfully')"
    - echo "Basic application tests completed"
  only:
    - main
    - merge_requests

build_application:
  stage: build
  image: python:3.11-slim
  script:
    - echo "Building Flask application..."
    - echo "Creating COMPLETE deployment package..."
    - mkdir -p /tmp/deploy
    - mkdir -p /tmp/archive
    - echo "Copying ALL project files including hidden files..."
    - cp -r . /tmp/deploy/
    - rm -rf /tmp/deploy/.git
    - rm -rf /tmp/deploy/.cache
    - rm -rf /tmp/deploy/venv
    - ls -la /tmp/deploy/
    - echo "Creating archive..."
    - cd /tmp/archive
    - tar -czf flask-helpdesk-${CI_COMMIT_SHA}.tar.gz -C /tmp/deploy .
    - mv flask-helpdesk-${CI_COMMIT_SHA}.tar.gz ${CI_PROJECT_DIR}/
    - cd ${CI_PROJECT_DIR}
    - echo "Build completed successfully"
    - ls -lah flask-helpdesk-${CI_COMMIT_SHA}.tar.gz
  artifacts:
    paths:
      - flask-helpdesk-${CI_COMMIT_SHA}.tar.gz
    expire_in: 1 week
  only:
    - main

deploy_to_server:
  stage: deploy
  image: alpine:latest
  resource_group: production
  before_script:
    - echo "Preparing deployment environment..."
    - apk add --no-cache openssh-client rsync
    - eval $(ssh-agent -s)
    - echo "SSH_PRIVATE_KEY length:" $(echo "$SSH_PRIVATE_KEY" | wc -c)
    - echo "SSH_PRIVATE_KEY first line:" $(echo "$SSH_PRIVATE_KEY" | head -1)
    - echo "SSH_PRIVATE_KEY last line:" $(echo "$SSH_PRIVATE_KEY" | tail -1)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - || echo "SSH key loading failed, trying alternative method"
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "Adding known hosts..."
    - ssh-keyscan -H -p ${DEPLOY_PORT:-22} $DEPLOY_HOST >> ~/.ssh/known_hosts || echo "ssh-keyscan failed, using StrictHostKeyChecking=no"
    - echo "Host $DEPLOY_HOST" >> ~/.ssh/config
    - echo "  StrictHostKeyChecking no" >> ~/.ssh/config
    - echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
    - echo "  ServerAliveInterval 60" >> ~/.ssh/config
    - echo "  ServerAliveCountMax 5" >> ~/.ssh/config
    - chmod 600 ~/.ssh/config
    - echo "SSH connection prepared"
  script:
    - echo "Testing SSH connection..."
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "echo 'SSH connection successful' && whoami && pwd" || (echo "SSH connection failed" && exit 1)
    - echo "Starting deployment to $DEPLOY_HOST..."
    - echo "Archive to deploy flask-helpdesk-${CI_COMMIT_SHA}.tar.gz"
    - ls -lah flask-helpdesk-${CI_COMMIT_SHA}.tar.gz

    - echo "Verifying archive integrity..."
    - tar -tzf flask-helpdesk-${CI_COMMIT_SHA}.tar.gz > /dev/null || (echo "Archive is corrupted" && exit 1)

    - echo "Uploading archive to server..."
    - scp -o ConnectTimeout=10 -P ${DEPLOY_PORT:-22} flask-helpdesk-${CI_COMMIT_SHA}.tar.gz $DEPLOY_USER@$DEPLOY_HOST:/tmp/ || (echo "Archive upload failed" && exit 1)

    - echo "Verifying archive upload..."
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "ls -lah /tmp/flask-helpdesk-${CI_COMMIT_SHA}.tar.gz" || (echo "Archive not found on server" && exit 1)

    - echo "Creating backup of current deployment..."
    - BACKUP_NAME="flask_helpdesk_backup_$(date +%Y%m%d-%H%M%S)"
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "cd /var/www && [ -d flask_helpdesk ] && cp -r flask_helpdesk $BACKUP_NAME || echo 'No current deployment to backup'"

    - echo "Extracting new deployment..."
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "cd /tmp && rm -rf flask_helpdesk_temp && mkdir -p flask_helpdesk_temp"
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "cd /tmp && tar -xzf flask-helpdesk-${CI_COMMIT_SHA}.tar.gz -C flask_helpdesk_temp --no-same-owner" || (echo "Archive extraction failed" && exit 1)

    - echo "Verifying extraction..."
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "[ -f /tmp/flask_helpdesk_temp/blog.py ] || (echo 'Main application file not found after extraction' && exit 1)"
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "[ -f /tmp/flask_helpdesk_temp/requirements.txt ] || (echo 'Requirements file not found after extraction' && exit 1)"

    - echo "Syncing to Flask working directory..."
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "rsync -av --delete --progress /tmp/flask_helpdesk_temp/ /var/www/flask_helpdesk/" || (echo "Rsync failed" && exit 1)

    - echo "Verifying deployment files..."
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "[ -f /var/www/flask_helpdesk/blog.py ] || (echo 'Main application file not found in deployment directory' && exit 1)"
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "[ -f /var/www/flask_helpdesk/requirements.txt ] || (echo 'Requirements file not found in deployment directory' && exit 1)"

    - echo "Setting file permissions..."
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "sudo chown -R www-data:www-data /var/www/flask_helpdesk/" || echo 'Permission setting failed - continuing without changing ownership'

    - echo "Installing Python dependencies on server..."
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "cd /var/www/flask_helpdesk && python3 -m venv venv" || (echo "Virtual environment creation failed" && exit 1)
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "cd /var/www/flask_helpdesk && source venv/bin/activate && pip install --upgrade pip && pip install -r requirements.txt" || (echo "Dependencies installation failed" && exit 1)

    - echo "Setting up application configuration..."
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "cd /var/www/flask_helpdesk && [ -f ../config_production.py ] && cp ../config_production.py . || echo 'No production config found'"

    - echo "Testing application import..."
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "cd /var/www/flask_helpdesk && source venv/bin/activate && python -c 'from blog import create_app; app = create_app(); print(\"Application loads successfully\")'" || (echo "Application test failed, rolling back..." && ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "cd /var/www && [ -d $BACKUP_NAME ] && rm -rf flask_helpdesk && mv $BACKUP_NAME flask_helpdesk" && exit 1)

    - echo "Restarting application service..."
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "sudo systemctl restart flask-helpdesk" || (echo "Service restart failed - manual intervention required" && exit 1)

    - echo "Verifying service status..."
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "sudo systemctl is-active flask-helpdesk" || (echo "Service is not running after restart" && exit 1)

    - echo "Cleaning up old files..."
    - ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "rm -f /tmp/flask-helpdesk-${CI_COMMIT_SHA}.tar.gz && rm -rf /tmp/flask_helpdesk_temp && find /var/www/flask_helpdesk_backup_* -maxdepth 0 -mtime +7 -exec rm -rf {} + 2>/dev/null || echo 'Cleanup completed'"
    - echo "Deployment completed successfully!"
    - echo "Application should be available at https://its.tez-tour.com"
  environment:
    name: production
    url: https://its.tez-tour.com
  when: manual
  only:
    - main
  after_script:
    - |
      if [ "$CI_JOB_STATUS" == "failed" ]; then
        echo "Deployment failed, checking for backup to rollback..."
        ssh -o ConnectTimeout=10 -p ${DEPLOY_PORT:-22} $DEPLOY_USER@$DEPLOY_HOST "cd /var/www && LATEST_BACKUP=\$(ls -t flask_helpdesk_backup_* 2>/dev/null | head -1) && [ -n \"\$LATEST_BACKUP\" ] && echo \"Rolling back to \$LATEST_BACKUP\" && rm -rf flask_helpdesk && mv \"\$LATEST_BACKUP\" flask_helpdesk && sudo systemctl restart flask-helpdesk || echo 'No backup found for rollback'"
      fi
