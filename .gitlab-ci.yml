stages:
  - test
  - build
  - deploy

variables:
  DEPLOY_PATH: "/opt/www/its.teztour.com"
  SERVICE_NAME: "flask-helpdesk"
  DEPLOY_DOMAIN: "its.tez-tour.com"
  PYTHON_VERSION: "3.12"

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
test_application:
  stage: test
  image: python:3.12-slim
  before_script:
    - echo "üß™ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é..."
    - python --version
    - pip install --upgrade pip
    - pip install -r requirements.txt
  script:
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ Python —Ñ–∞–π–ª–æ–≤..."
    - python -m py_compile app.py
    - python -m py_compile wsgi.py
    - python -m py_compile secure_config.py
    - python -m py_compile config.py

    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–æ–≤..."
    - python -c "import app; print('‚úÖ app.py –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ')"
    - python -c "import wsgi; print('‚úÖ wsgi.py –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ')"
    - python -c "from secure_config import get_config; print('‚úÖ secure_config.py –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ')"

    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
    - python -c "from secure_config import get_config; config = get_config(); print('‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è')"

    - echo "‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
  allow_failure: false

# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
build_application:
  stage: build
  image: python:3.12-slim
  before_script:
    - echo "üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Å–±–æ—Ä–∫–µ..."
    - python --version
  script:
    - echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è –¥–µ–ø–ª–æ—è..."
    - mkdir -p deployment_package

    # –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    - echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤..."
    - cp app.py deployment_package/
    - cp wsgi.py deployment_package/
    - cp requirements.txt deployment_package/
    - cp secure_config.py deployment_package/
    - cp config.py deployment_package/
    - cp logging_config.py deployment_package/

    # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
    - echo "üìÅ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
    - cp -r blog/ deployment_package/
    - cp -r migrations/ deployment_package/

    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
    - mkdir -p deployment_package/static
    - mkdir -p deployment_package/templates

    # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
    - echo "üé® –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤..."
    - cp -r blog/static/* deployment_package/static/ 2>/dev/null || echo "‚ÑπÔ∏è –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –∏–∑ blog/static –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    - cp -r blog/templates/* deployment_package/templates/ 2>/dev/null || echo "‚ÑπÔ∏è –®–∞–±–ª–æ–Ω—ã –∏–∑ blog/templates –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

    # –°–æ–∑–¥–∞–Ω–∏–µ production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    - echo "‚öôÔ∏è –°–æ–∑–¥–∞–Ω–∏–µ production –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
    - cat > deployment_package/.env.production << EOF
FLASK_ENV=production
FLASK_DEBUG=False
WTF_CSRF_ENABLED=True
SECRET_KEY=\$(python -c 'import secrets; print(secrets.token_hex(32))')
LOG_LEVEL=INFO
LOG_PATH=/opt/www/its.teztour.com/logs/app.log
DB_PATH=/opt/www/its.teztour.com/blog/db/blog.db
EOF

    # –°–æ–∑–¥–∞–Ω–∏–µ systemd service —Ñ–∞–π–ª–∞
    - echo "üîß –°–æ–∑–¥–∞–Ω–∏–µ systemd service —Ñ–∞–π–ª–∞..."
    - cat > deployment_package/flask-helpdesk.service << EOF
[Unit]
Description=Flask Helpdesk Application
After=network.target

[Service]
Type=exec
User=deploy
Group=deploy
WorkingDirectory=$DEPLOY_PATH
Environment=PATH=$DEPLOY_PATH/venv/bin
Environment=FLASK_ENV=production
Environment=PYTHONPATH=$DEPLOY_PATH
ExecStart=$DEPLOY_PATH/venv/bin/gunicorn \\
          --workers 3 --threads 2 --timeout 120 \\
          --bind unix:/run/gunicorn/gunicorn.sock \\
          wsgi:app
ExecReload=/bin/kill -s HUP \$MAINPID
Restart=always
RestartSec=3
StandardOutput=journal
StandardError=journal

RuntimeDirectory=gunicorn
RuntimeDirectoryMode=0755

[Install]
WantedBy=multi-user.target
EOF

    # –°–æ–∑–¥–∞–Ω–∏–µ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    - echo "üåê –°–æ–∑–¥–∞–Ω–∏–µ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
    - cat > deployment_package/flask-helpdesk.nginx.conf << EOF
server {
    listen 80;
    server_name $DEPLOY_DOMAIN;
    return 301 https://\$server_name\$request_uri;
}

server {
    listen 443 ssl http2;
    server_name $DEPLOY_DOMAIN;

    ssl_certificate /etc/letsencrypt/live/$DEPLOY_DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DEPLOY_DOMAIN/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 1d;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    client_max_body_size 20M;
    keepalive_timeout 65;

    access_log /var/log/nginx/flask-helpdesk-access.log;
    error_log /var/log/nginx/flask-helpdesk-error.log;

    location / {
        proxy_pass http://unix:/run/gunicorn/gunicorn.sock;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        proxy_set_header X-Forwarded-Host \$server_name;

        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_buffering off;
    }

    location /static/ {
        alias $DEPLOY_PATH/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;

        gzip on;
        gzip_vary on;
        gzip_min_length 1024;
        gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
    }

    location = /favicon.ico {
        alias $DEPLOY_PATH/static/favicon.ico;
        expires 1y;
        access_log off;
    }

    location ~ /\\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ \\.(py|pyc|pyo|pyd|db)\$ {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ ^/(venv|migrations|instance|__pycache__)/ {
        deny all;
        access_log off;
        log_not_found off;
    }
}
EOF

    # –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–µ–ø–ª–æ—è
    - echo "üìú –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–µ–ø–ª–æ—è..."
    - cat > deployment_package/deploy.sh << 'EOF'
#!/bin/bash
set -e

DEPLOY_PATH="/opt/www/its.teztour.com"
SERVICE_NAME="flask-helpdesk"
DEPLOY_USER="deploy"

echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è Flask Helpdesk..."

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
sudo mkdir -p $DEPLOY_PATH
sudo chown $DEPLOY_USER:$DEPLOY_USER $DEPLOY_PATH

# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
echo "üêç –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
cd $DEPLOY_PATH
python3 -m venv venv
source venv/bin/activate

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
pip install --upgrade pip
pip install -r requirements.txt

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π..."
mkdir -p logs
mkdir -p blog/db
mkdir -p static
mkdir -p templates

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
chown -R $DEPLOY_USER:$DEPLOY_USER $DEPLOY_PATH
chmod -R 755 $DEPLOY_PATH
chmod 600 .env.production 2>/dev/null || echo "‚ÑπÔ∏è .env.production –Ω–µ –Ω–∞–π–¥–µ–Ω"

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ systemd service —Ñ–∞–π–ª–∞
echo "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ systemd service..."
sudo cp flask-helpdesk.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable $SERVICE_NAME

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
echo "üåê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ nginx..."
sudo cp flask-helpdesk.nginx.conf /etc/nginx/sites-available/$SERVICE_NAME
sudo ln -sf /etc/nginx/sites-available/$SERVICE_NAME /etc/nginx/sites-enabled/
sudo nginx -t && sudo systemctl reload nginx

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞..."
sudo systemctl restart $SERVICE_NAME
sudo systemctl status $SERVICE_NAME --no-pager

echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É: https://its.tez-tour.com"
EOF

    - chmod +x deployment_package/deploy.sh

    # –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞
    - echo "üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞..."
    - cd deployment_package
    - tar -czf ../deployment.tar.gz .
    - cd ..
    - ls -lh deployment.tar.gz

    - echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
  artifacts:
    paths:
      - deployment.tar.gz
      - deployment_package/
    expire_in: 1 day
    when: always
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'

# –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
deploy_to_server:
  stage: deploy
  before_script:
    - echo "üöÄ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –¥–µ–ø–ª–æ—é..."
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
    - |
      if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$DEPLOY_SERVER" ] || [ -z "$DEPLOY_USER" ]; then
        echo ""
        echo "‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–µ–ø–ª–æ—è –ù–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
        echo ""
        echo "üìã –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –¥–æ–±–∞–≤—å—Ç–µ –≤ GitLab:"
        echo "   Settings ‚Üí CI/CD ‚Üí Variables:"
        echo ""
        echo "   üîë SSH_PRIVATE_KEY"
        echo "      Value: (—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ ~/.ssh/flask_helpdesk_deploy)"
        echo ""
        echo "   üåê DEPLOY_SERVER"
        echo "      Value: its.tez-tour.com"
        echo ""
        echo "   üë§ DEPLOY_USER"
        echo "      Value: yvarslavan"
        echo ""
        echo "üì¶ –ü–∞–∫–µ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä—É—á–Ω–æ–º—É –¥–µ–ø–ª–æ—é"
        exit 0
      fi
    - echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–µ–ø–ª–æ—è –Ω–∞–π–¥–µ–Ω—ã"
    - echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH..."
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts
    - echo "üîë SSH –∫–ª—é—á –Ω–∞—Å—Ç—Ä–æ–µ–Ω"
  script:
    - echo "üì§ –ü–µ—Ä–µ–¥–∞—á–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
    - |
      if [ -f "deployment.tar.gz" ]; then
        echo "üì¶ –ü–µ—Ä–µ–¥–∞—á–∞ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
        cat deployment.tar.gz | ssh -o ConnectTimeout=30 $DEPLOY_USER@$DEPLOY_SERVER "
          echo 'üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏...'
          mkdir -p /tmp/flask-deploy
          cd /tmp/flask-deploy

          echo 'üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞...'
          tar -xzf - && echo '‚úÖ –ê—Ä—Ö–∏–≤ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω' || echo '‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∏'

          echo 'üöÄ –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ –¥–µ–ø–ª–æ—è...'
          chmod +x deploy.sh
          ./deploy.sh

          echo 'üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤...'
          cd /
          rm -rf /tmp/flask-deploy

          echo '‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!'
        "
      else
        echo "‚ùå deployment.tar.gz –Ω–µ –Ω–∞–π–¥–µ–Ω"
        exit 1
      fi
    - echo ""
    - echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
    - echo ""
    - echo "üîß –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
    - echo "   ssh $DEPLOY_USER@$DEPLOY_SERVER"
    - echo "   sudo systemctl status flask-helpdesk"
    - echo "   curl -I https://$DEPLOY_DOMAIN"
    - echo ""
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
  allow_failure: false
