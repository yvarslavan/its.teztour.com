stages:
  - build
  - deploy

variables:
  DEPLOY_PATH: "/opt/www"
  SERVICE_NAME: "flask-helpdesk"
  DEPLOY_DOMAIN: "its.tez-tour.com"

# –ü—Ä–æ—Å—Ç–∞—è —Å–±–æ—Ä–∫–∞ –±–µ–∑ Docker
simple_build:
  stage: build
  script:
    - echo "üì¶ –ü—Ä–æ—Å—Ç–∞—è —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
    - echo "üìÅ –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è $(pwd)"
    - echo "üìã –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø—Ä–æ–µ–∫—Ç–∞:"
    - ls -la
    - mkdir -p deployment_package
    - echo "üìã –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞:"

    # –ö–æ–ø–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ–∞–π–ª—ã
    - cp app.py deployment_package/ 2>/dev/null && echo "‚úÖ app.py" || echo "‚ö†Ô∏è app.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - cp requirements.txt deployment_package/ 2>/dev/null && echo "‚úÖ requirements.txt" || echo "‚ö†Ô∏è requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - cp config.ini deployment_package/ 2>/dev/null && echo "‚úÖ config.ini" || echo "‚ö†Ô∏è config.ini –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - cp *.py deployment_package/ 2>/dev/null && echo "‚úÖ Python —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã" || echo "‚ÑπÔ∏è –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ .py —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

    # –ö–æ–ø–∏—Ä—É–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
    - cp -r blog/ deployment_package/ 2>/dev/null && echo "‚úÖ blog/" || echo "‚ÑπÔ∏è blog/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    - cp -r static/ deployment_package/ 2>/dev/null && echo "‚úÖ static/" || echo "‚ÑπÔ∏è static/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    - cp -r templates/ deployment_package/ 2>/dev/null && echo "‚úÖ templates/" || echo "‚ÑπÔ∏è templates/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    - cp -r migrations/ deployment_package/ 2>/dev/null && echo "‚úÖ migrations/" || echo "‚ÑπÔ∏è migrations/ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"

    # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
    - cp flask-helpdesk.service.redhat deployment_package/flask-helpdesk.service 2>/dev/null && echo "‚úÖ service —Ñ–∞–π–ª" || echo "‚ÑπÔ∏è service —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - cp flask-helpdesk.nginx.conf deployment_package/ 2>/dev/null && echo "‚úÖ nginx –∫–æ–Ω—Ñ–∏–≥" || echo "‚ÑπÔ∏è nginx –∫–æ–Ω—Ñ–∏–≥ –Ω–µ –Ω–∞–π–¥–µ–Ω"

    # –°–æ–∑–¥–∞–µ–º –∞—Ä—Ö–∏–≤ (–µ—Å–ª–∏ –µ—Å—Ç—å tar)
    - |
      if command -v tar >/dev/null 2>&1; then
        cd deployment_package
        tar -czf ../deployment_simple.tar.gz .
        cd ..
        echo "‚úÖ –ê—Ä—Ö–∏–≤ —Å–æ–∑–¥–∞–Ω:"
        ls -lh deployment_simple.tar.gz 2>/dev/null || echo "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –∞—Ä—Ö–∏–≤–æ–º"
      else
        echo "‚ö†Ô∏è tar –Ω–µ –Ω–∞–π–¥–µ–Ω, –∞—Ä—Ö–∏–≤ –Ω–µ —Å–æ–∑–¥–∞–Ω"
      fi

    - echo "üì¶ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ deployment_package:"
    - ls -la deployment_package/ 2>/dev/null || echo "‚ö†Ô∏è deployment_package –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
    - echo "‚úÖ –ü—Ä–æ—Å—Ç–∞—è —Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
  artifacts:
    paths:
      - deployment_simple.tar.gz
      - deployment_package/
    expire_in: 1 day
    when: always
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'

# –ü—Ä–æ—Å—Ç–æ–π –¥–µ–ø–ª–æ–π –±–µ–∑ Docker
simple_deploy:
  stage: deploy
  script:
    - echo "üöÄ –ü—Ä–æ—Å—Ç–æ–π –¥–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
    - |
      if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$DEPLOY_SERVER" ] || [ -z "$DEPLOY_USER" ]; then
        echo ""
        echo "‚ÑπÔ∏è –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–µ–ø–ª–æ—è –ù–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
        echo ""
        echo "üìã –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –¥–æ–±–∞–≤—å—Ç–µ –≤ GitLab:"
        echo "   Settings ‚Üí CI/CD ‚Üí Variables:"
        echo ""
        echo "   üîë SSH_PRIVATE_KEY"
        echo "      Value: (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å -----BEGIN)"
        echo ""
        echo "   üåê DEPLOY_SERVER"
        echo "      Value: 10.7.74.252"
        echo ""
        echo "   üë§ DEPLOY_USER"
        echo "      Value: deploy"
        echo ""
        echo "üì¶ –ü–∞–∫–µ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä—É—á–Ω–æ–º—É –¥–µ–ø–ª–æ—é"
        echo ""
        echo "üîß –†—É—á–Ω–æ–π –¥–µ–ø–ª–æ–π:"
        echo "   1. –°–∫–∞—á–∞–π—Ç–µ artifacts –∏–∑ —ç—Ç–æ–≥–æ pipeline"
        echo "   2. scp deployment_simple.tar.gz deploy@10.7.74.252:/tmp/"
        echo "   3. ssh deploy@10.7.74.252"
        echo "   4. cd /opt/www && sudo tar -xzf /tmp/deployment_simple.tar.gz"
        echo "   5. sudo systemctl restart flask-helpdesk"
        echo ""
        exit 0
      fi

    - echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–µ–ø–ª–æ—è –Ω–∞–π–¥–µ–Ω—ã"
    - echo "üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH..."

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º SSH —É—Ç–∏–ª–∏—Ç—ã
    - command -v ssh >/dev/null 2>&1 || echo "‚ö†Ô∏è ssh –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - command -v ssh-agent >/dev/null 2>&1 || echo "‚ö†Ô∏è ssh-agent –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - command -v ssh-add >/dev/null 2>&1 || echo "‚ö†Ô∏è ssh-add –Ω–µ –Ω–∞–π–¥–µ–Ω"

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH
    - eval $(ssh-agent -s) 2>/dev/null || echo "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å ssh-agent"
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - 2>/dev/null || echo "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å SSH –∫–ª—é—á–æ–º"
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H $DEPLOY_SERVER >> ~/.ssh/known_hosts 2>/dev/null || echo "‚ö†Ô∏è ssh-keyscan –ø—Ä–æ–±–ª–µ–º–∞"

    - echo "üîç –¢–µ—Å—Ç SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
    - ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_SERVER "echo 'SSH OK'" 2>/dev/null || echo "‚ö†Ô∏è SSH —Ç–µ—Å—Ç –Ω–µ –ø—Ä–æ—à–µ–ª"

    - echo "üìÅ –î–µ–ø–ª–æ–π —Ñ–∞–π–ª–æ–≤..."
    - |
      if [ -f "deployment_simple.tar.gz" ]; then
        echo "üì§ –ü–µ—Ä–µ–¥–∞–µ–º –∞—Ä—Ö–∏–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
        cat deployment_simple.tar.gz | ssh -o ConnectTimeout=30 $DEPLOY_USER@$DEPLOY_SERVER "
          sudo mkdir -p /opt/www 2>/dev/null
          cd /opt/www
          sudo tar -xzf - 2>/dev/null && echo '‚úÖ –ê—Ä—Ö–∏–≤ —Ä–∞—Å–ø–∞–∫–æ–≤–∞–Ω –≤ /opt/www' || echo '‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ä–∞—Å–ø–∞–∫–æ–≤–∫–æ–π'
          echo 'üìã –§–∞–π–ª—ã –≤ /opt/www:'
          sudo ls -la /opt/www/ 2>/dev/null | head -10
        " 2>/dev/null || echo "‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–µ—Ä–µ–¥–∞—á–µ–π —Ñ–∞–π–ª–æ–≤"
      else
        echo "‚ùå deployment_simple.tar.gz –Ω–µ –Ω–∞–π–¥–µ–Ω"
        echo "üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ–∞–π–ª—ã:"
        ls -la . 2>/dev/null || echo "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–∞–π–ª—ã"
      fi

    - echo ""
    - echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
    - echo ""
    - echo "üîß –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:"
    - echo "   ssh deploy@10.7.74.252"
    - echo "   sudo systemctl restart flask-helpdesk"
    - echo "   sudo systemctl status flask-helpdesk"
    - echo "   curl -I http://its.tez-tour.com"
    - echo ""
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
  allow_failure: false
