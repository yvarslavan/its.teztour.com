stages:
  - test
  - build
  - deploy

variables:
  DEPLOY_PATH: "/opt/www/its.teztour.com"
  SERVICE_NAME: "flask-helpdesk"
  DEPLOY_DOMAIN: "its.tez-tour.com"

# –ü—Ä–æ—Å—Ç–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
test_application:
  stage: test
  image: python:3.12-slim
  script:
    - echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    - python --version
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - echo "‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'

# –ü—Ä–æ—Å—Ç–∞—è —Å–±–æ—Ä–∫–∞
build_application:
  stage: build
  image: python:3.12-slim
  script:
    - echo "üì¶ –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    - mkdir -p deployment_package
    - cp app.py deployment_package/ 2>/dev/null || echo "app.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - cp wsgi.py deployment_package/ 2>/dev/null || echo "wsgi.py –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - cp requirements.txt deployment_package/ 2>/dev/null || echo "requirements.txt –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - cp -r blog/ deployment_package/ 2>/dev/null || echo "blog/ –Ω–µ –Ω–∞–π–¥–µ–Ω"
    - echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
  artifacts:
    paths:
      - deployment_package/
    expire_in: 1 day
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'

# –ü—Ä–æ—Å—Ç–æ–π –¥–µ–ø–ª–æ–π
deploy_to_server:
  stage: deploy
  script:
    - echo "üöÄ –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è..."
    - echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
    - |
      if [ -z "$SSH_PRIVATE_KEY" ] || [ -z "$DEPLOY_SERVER" ] || [ -z "$DEPLOY_USER" ]; then
        echo ""
        echo "‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–µ–ø–ª–æ—è –ù–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"
        echo ""
        echo "üìã –î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–ø–ª–æ—è –¥–æ–±–∞–≤—å—Ç–µ –≤ GitLab:"
        echo "   Settings ‚Üí CI/CD ‚Üí Variables:"
        echo ""
        echo "   üîë SSH_PRIVATE_KEY"
        echo "      Value: (—Å–æ–¥–µ—Ä–∂–∏–º–æ–µ ~/.ssh/flask_helpdesk_deploy)"
        echo ""
        echo "   üåê DEPLOY_SERVER"
        echo "      Value: its.tez-tour.com"
        echo ""
        echo "   üë§ DEPLOY_USER"
        echo "      Value: yvarslavan"
        echo ""
        echo "üì¶ –ü–∞–∫–µ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä—É—á–Ω–æ–º—É –¥–µ–ø–ª–æ—é"
        exit 0
      fi
    - echo "‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–µ–ø–ª–æ—è –Ω–∞–π–¥–µ–Ω—ã"
    - echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
  rules:
    - if: '$CI_COMMIT_REF_NAME == "main"'
