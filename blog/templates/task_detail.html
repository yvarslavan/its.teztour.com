{% extends 'layout.html' %}

{% block main_page %}

<!-- CSS для функционала изменения статуса -->
<style>
/* Контейнер для изменения статуса */
.task-status-changer {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
}

/* Отображение текущего статуса */
.current-status {
    margin-bottom: 15px;
}

.current-status .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: block;
}

/* Улучшенные бейджи статусов */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    line-height: 1.4;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    color: #495057;
    border: 1px solid rgba(206, 212, 218, 0.5);
    box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.status-badge::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.5s ease;
}

.status-badge:hover::before {
    left: 100%;
}

.status-badge:hover {
    transform: translateY(-1px);
    box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

/* Цветные стили для разных статусов */
.status-badge.status-1,
.status-badge.status-7,
.status-badge.status-13,
.status-badge.status-17 {
    background: linear-gradient(135deg, #d1ecf1 0%, #b8daff 100%);
    color: #0c5460;
    border-color: rgba(190, 229, 235, 0.6);
    box-shadow:
        0 2px 8px rgba(12, 84, 96, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.status-badge.status-2,
.status-badge.status-8,
.status-badge.status-15,
.status-badge.status-18 {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    color: #856404;
    border-color: rgba(255, 234, 167, 0.6);
    box-shadow:
        0 2px 8px rgba(133, 100, 4, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.status-badge.status-3 {
    background: linear-gradient(135deg, #cce5ff 0%, #b8daff 100%);
    color: #004085;
    border-color: rgba(184, 218, 255, 0.6);
    box-shadow:
        0 2px 8px rgba(0, 64, 133, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.status-badge.status-4,
.status-badge.status-14 {
    background: linear-gradient(135deg, #f8d7da 0%, #ffcdd2 100%);
    color: #721c24;
    border-color: rgba(245, 198, 203, 0.6);
    box-shadow:
        0 2px 8px rgba(114, 28, 36, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.status-badge.status-5,
.status-badge.status-16 {
    background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
    color: #00695c;
    border-color: rgba(178, 223, 219, 0.6);
    box-shadow:
        0 2px 8px rgba(0, 105, 92, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.status-badge.status-6 {
    background: linear-gradient(135deg, #e2e3e5 0%, #d6d8db 100%);
    color: #383d41;
    border-color: rgba(214, 216, 219, 0.6);
    box-shadow:
        0 2px 8px rgba(56, 61, 65, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.status-badge.status-9 {
    background: linear-gradient(135deg, #ffccbc 0%, #ff8a65 100%);
    color: #d84315;
    border-color: rgba(255, 138, 101, 0.6);
    box-shadow:
        0 2px 8px rgba(216, 67, 21, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.status-badge.status-10,
.status-badge.status-19 {
    background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
    color: #7b1fa2;
    border-color: rgba(225, 190, 231, 0.6);
    box-shadow:
        0 2px 8px rgba(123, 31, 162, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

/* Добавляем иконку для статуса */
.status-badge::after {
    content: '';
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    opacity: 0.7;
    animation: statusPulse 2s infinite ease-in-out;
}

@keyframes statusPulse {
    0%, 100% { opacity: 0.7; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.1); }
}

/* Улучшения для темной темы */
[data-theme="dark"] .status-badge {
    background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
    color: #f3f4f6;
    border-color: rgba(75, 85, 99, 0.5);
    box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

/* Форма изменения статуса */
.status-change-form {
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
}

.status-change-form .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: block;
}

/* Селект для выбора статуса */
#new-status-select {
    border-radius: 6px;
    border: 1px solid #ced4da;
    padding: 8px 12px;
    font-size: 0.875rem;
    width: 100%;
    margin-bottom: 10px;
}

/* Кнопка изменения статуса */
#change-status-btn {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
}

#change-status-btn:hover:not(:disabled) {
    background-color: #0056b3;
}

#change-status-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background-color: #6c757d;
}

/* Стили для управления приоритетом */
.task-priority-changer {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
}

/* Отображение текущего приоритета */
.current-priority {
    margin-bottom: 15px;
}

.current-priority .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: block;
}

/* Бейджи приоритетов */
.priority-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    line-height: 1.4;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    color: #495057;
    border: 1px solid rgba(206, 212, 218, 0.5);
    box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.priority-badge::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.5s ease;
}

.priority-badge:hover::before {
    left: 100%;
}

.priority-badge:hover {
    transform: translateY(-1px);
    box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

/* Цветные стили для разных приоритетов */
.priority-badge.priority-1,
.priority-badge.priority-2 {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    color: #856404;
    border-color: rgba(255, 193, 7, 0.6);
    box-shadow:
        0 2px 8px rgba(255, 193, 7, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.priority-badge.priority-3,
.priority-badge.priority-4 {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24;
    border-color: rgba(220, 53, 69, 0.6);
    box-shadow:
        0 2px 8px rgba(220, 53, 69, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.priority-badge.priority-5,
.priority-badge.priority-6 {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    color: #0c5460;
    border-color: rgba(23, 162, 184, 0.6);
    box-shadow:
        0 2px 8px rgba(23, 162, 184, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.priority-badge.priority-none {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    color: #6c757d;
    border-color: rgba(108, 117, 125, 0.6);
    box-shadow:
        0 2px 8px rgba(108, 117, 125, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

/* Форма изменения приоритета */
.priority-change-form {
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
}

.priority-change-form .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: block;
}

/* Селект для выбора приоритета */
#new-priority-select {
    border-radius: 6px;
    border: 1px solid #ced4da;
    padding: 8px 12px;
    font-size: 0.875rem;
    width: 100%;
    margin-bottom: 10px;
}

/* Кнопка изменения приоритета */
#change-priority-btn {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
}

#change-priority-btn:hover:not(:disabled) {
    background-color: #0056b3;
}

#change-priority-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background-color: #6c757d;
}

/* Стили для управления исполнителем */
.task-assignee-changer {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
}

/* Отображение текущего исполнителя */
.current-assignee {
    margin-bottom: 15px;
}

.current-assignee .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: block;
}

/* Аватар пользователя */
.user-avatar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 8px;
}

.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 16px;
    color: white;
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    border: 2px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.avatar-circle.assigned {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.avatar-circle:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.user-name {
    font-weight: 500;
    color: #495057;
    font-size: 0.95rem;
}

/* Форма изменения исполнителя */
.assignee-change-form {
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
}

.assignee-change-form .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: block;
}

/* Селект для выбора исполнителя */
#new-assignee-select {
    border-radius: 6px;
    border: 1px solid #ced4da;
    padding: 8px 12px;
    font-size: 0.875rem;
    width: 100%;
    margin-bottom: 10px;
}

/* Кнопка изменения исполнителя */
#change-assignee-btn {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
}

#change-assignee-btn:hover:not(:disabled) {
    background-color: #0056b3;
}

#change-assignee-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background-color: #6c757d;
}

/* Поле комментария */
#status-comment {
    border-radius: 6px;
    border: 1px solid #ced4da;
    padding: 8px 12px;
    font-size: 0.875rem;
    width: 100%;
    min-height: 80px;
    resize: vertical;
}

/* Анимация загрузки */
.fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Уведомления */
.alert {
    border-radius: 6px;
    margin-bottom: 15px;
    padding: 12px 16px;
    font-size: 0.875rem;
}

.alert-success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.alert-danger {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

/* Адаптивность */
@media (max-width: 768px) {
    .task-status-changer {
        padding: 10px;
    }

    #change-status-btn {
        width: 100%;
        margin-top: 10px;
    }
}

.loading-placeholder {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #6c757d;
    font-size: 0.875rem;
}

.section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 15px;
}

.status-management {
    display: block;
}

.status-management .detail-content {
    width: 100%;
}

.comment-actions-trigger i.fas.fa-ellipsis-v {
  color: #6366f1 !important;
  font-size: 1.2rem;
}
</style>

<div class="modern-task-detail">
  <!-- Floating Action Button -->
  <div class="fab-container">
    <button class="fab theme-toggle" onclick="toggleTheme()" title="Переключить тему">
      <i class="fas fa-moon" id="theme-icon"></i>
    </button>
  </div>

  <!-- Hero Section -->
  <div class="hero-section">
    <div class="hero-content">
      <div class="breadcrumb">
        <a href="/my-tasks" class="breadcrumb-link">
          <i class="fas fa-tasks"></i>
          <span>Мои задачи</span>
        </a>
        <i class="fas fa-chevron-right breadcrumb-separator"></i>
        <span class="breadcrumb-current">Задача #{{task.id}}</span>
        <button class="action-btn back-btn" id="go-back-btn" data-task-id="{{ task.id }}">
          <i class="fas fa-arrow-left"></i>
          <span>Назад к списку</span>
        </button>
      </div>

      <div class="hero-main">
        <div class="task-status-large">
          {% set status_class = 'status-default' %}
          {% set status_icon = 'fas fa-question-circle' %}
          {% set status_color = '#6c757d' %}
          {% set status_name = status_mapping.get(task.status.id, task.status.name) if task.status else 'Неизвестно' %}

          {% if status_name in ['Новая', 'New', 'Открыта', 'Open'] %}
            {% set status_class = 'status-open' %}
            {% set status_icon = 'fas fa-folder-open' %}
            {% set status_color = '#007bff' %}
          {% elif status_name in ['В работе', 'In Progress', 'На тестировании', 'В очереди'] %}
            {% set status_class = 'status-progress' %}
            {% set status_icon = 'fas fa-clock' %}
            {% set status_color = '#ffc107' %}
          {% elif status_name in ['Закрыта', 'Closed', 'Выполнена', 'Resolved', 'Протестирована'] %}
            {% set status_class = 'status-closed' %}
            {% set status_icon = 'fas fa-check-circle' %}
            {% set status_color = '#28a745' %}
          {% elif status_name in ['Отклонена', 'Rejected', 'Заморожена'] %}
            {% set status_class = 'status-rejected' %}
            {% set status_icon = 'fas fa-times-circle' %}
            {% set status_color = '#dc3545' %}
          {% elif status_name in ['Запрошено уточнение', 'Приостановлена', 'На согласовании'] %}
            {% set status_class = 'status-pending' %}
            {% set status_icon = 'fas fa-pause-circle' %}
            {% set status_color = '#6f42c1' %}
          {% elif status_name in ['Перенаправлена'] %}
            {% set status_class = 'status-registered' %}
            {% set status_icon = 'fas fa-file-check' %}
            {% set status_color = '#17a2b8' %}
          {% endif %}

          <div class="status-indicator {{ status_class }}" style="--status-color: {{ status_color }}">
            <i class="{{ status_icon }}"></i>
          </div>
        </div>

        <div class="hero-text">
          <h1 class="hero-title">{{task.subject}}</h1>
          <p class="hero-subtitle">Задача #{{task.id}} • {{ status_name }}</p>
        </div>
      </div>

      <div class="hero-actions">
        <button class="action-btn primary" onclick="window.print()">
          <i class="fas fa-print"></i>
          <span>Печать</span>
        </button>
        <button class="action-btn secondary" onclick="copyTaskLink()">
          <i class="fas fa-link"></i>
          <span>Копировать ссылку</span>
        </button>
        <a href="https://helpdesk.teztour.com/issues/{{ task.id }}" class="action-btn secondary" target="_blank" rel="noopener noreferrer">
          <i class="fas fa-external-link-alt"></i>
          <span>Открыть в Redmine</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="content-grid">

    <!-- Task Details Card -->
    <div class="card main-card">
      <div class="card-header collapsible" onclick="toggleCard('details')">
        <div class="card-title">
          <i class="fas fa-info-circle"></i>
          <h2>Сведения о задаче</h2>
        </div>
        <i class="fas fa-chevron-up toggle-icon" id="details-toggle"></i>
      </div>

      <div class="card-content" id="details-content">
        <div class="details-grid">
          <!-- Primary Info -->
          <div class="detail-section">
            <h3 class="section-title">Основное</h3>
            <div class="detail-items">
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Приоритет</span>
                  <div class="detail-value priority-badge">
                    {% if task.priority and task.priority.id %}
                      {% set pos = task.priority.position if task.priority.position is defined else None %}
                      {% if pos is not none and (pos|int) >= 7 %}
                        <span class="badge high">{{ task.priority.name }}</span>
                      {% elif pos is not none and (pos|int) <= 3 %}
                        <span class="badge low">{{ task.priority.name }}</span>
                      {% else %}
                        <span class="badge normal">{{ task.priority.name }}</span>
                      {% endif %}
                    {% else %}
                      <span class="badge">{{ task.priority.name if task.priority else 'Не указан' }}</span>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-folder"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Проект</span>
                  <span class="detail-value">{{ task.project.name if task.project else 'Без проекта' }}</span>
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-tags"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Трекер</span>
                  <span class="detail-value">{{ task.tracker.name if task.tracker else 'Не указан' }}</span>
                </div>
              </div>

              {% if task.done_ratio is defined %}
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-percentage"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Прогресс</span>
                  <div class="progress-container">
                    <div class="progress-bar">
                      <div class="progress-fill" id="progress-fill" data-done-ratio="{{ task.done_ratio or 0 }}"></div>
                    </div>
                    <span class="progress-text">{{task.done_ratio}}%</span>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Status and Priority Management Section -->
          <div class="detail-section">
            <h3 class="section-title">
              <i class="fas fa-sync-alt"></i>
              Управление статусом и приоритетом
            </h3>
            <div class="detail-items">
              <div class="detail-item status-management">
                <div class="detail-icon">
                  <i class="fas fa-flag"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Статус задачи</span>
                  <div id="task-status-container">
                    <!-- Здесь будет вставлен функционал изменения статуса через JavaScript -->
                    <div class="loading-placeholder">
                      <i class="fas fa-spinner fa-spin"></i>
                      <span>Загрузка...</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="detail-item priority-management">
                <div class="detail-icon">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Приоритет задачи</span>
                  <div id="task-priority-container">
                    <!-- Здесь будет вставлен функционал изменения приоритета через JavaScript -->
                    <div class="loading-placeholder">
                      <i class="fas fa-spinner fa-spin"></i>
                      <span>Загрузка...</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- People -->
          <div class="detail-section">
            <h3 class="section-title">Участники</h3>
            <div class="detail-items">
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-user-edit"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Автор</span>
                  {% if task.author %}
                    <div class="user-avatar">
                      <div class="avatar-circle">{{ task.author.name[0] if task.author.name else 'U' }}</div>
                      <span class="user-name">{{ task.author.name }}</span>
                    </div>
                  {% else %}
                    <span class="detail-value no-data">Нет данных</span>
                  {% endif %}
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-user-cog"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Исполнитель</span>
                  <div id="task-assignee-container">
                    <!-- Здесь будет вставлен функционал изменения исполнителя через JavaScript -->
                    <div class="loading-placeholder">
                      <i class="fas fa-spinner fa-spin"></i>
                      <span>Загрузка...</span>
                    </div>
                  </div>
                </div>
              </div>

              {% if task.easy_email_to %}
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-envelope"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Email to</span>
                  <a href="mailto:{{ task.easy_email_to }}" class="email-link">{{ task.easy_email_to }}</a>
                </div>
              </div>
              {% endif %}

              {% if task.easy_email_cc %}
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-envelope-square"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Email cc</span>
                  <span class="email-cc">{{ task.easy_email_cc }}</span>
                </div>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Timeline -->
          <div class="detail-section">
            <h3 class="section-title">Временная шкала</h3>
            <div class="timeline-items">
              <div class="timeline-item">
                <div class="timeline-dot created"></div>
                <div class="timeline-content">
                  <span class="timeline-label">Создана</span>
                  <div class="timeline-date">
                    <span class="date-main">{{task.created_on.strftime('%d %B %Y')}}</span>
                    <span class="date-time">{{task.created_on.strftime('%H:%M')}}</span>
                  </div>
                </div>
              </div>

              {% if task.start_date %}
              <div class="timeline-item">
                <div class="timeline-dot started"></div>
                <div class="timeline-content">
                  <span class="timeline-label">Начало</span>
                  <div class="timeline-date">
                    <span class="date-main">{{ task.start_date.strftime('%d %B %Y') }}</span>
                  </div>
                </div>
              </div>
              {% endif %}

              {% if task.due_date %}
              <div class="timeline-item">
                <div class="timeline-dot deadline"></div>
                <div class="timeline-content">
                  <span class="timeline-label">Окончание</span>
                  <div class="timeline-date">
                    <span class="date-main">{{ task.due_date.strftime('%d %B %Y') }}</span>
                  </div>
                </div>
              </div>
              {% endif %}

              {% if task.closed_on %}
              <div class="timeline-item">
                <div class="timeline-dot closed"></div>
                <div class="timeline-content">
                  <span class="timeline-label">Закрыто</span>
                  <div class="timeline-date">
                    <span class="date-main">{{ task.closed_on.strftime('%d %B %Y') }}</span>
                    <span class="date-time">{{ task.closed_on.strftime('%H:%M') }}</span>
                  </div>
                </div>
              </div>
              {% endif %}

              <div class="timeline-item">
                <div class="timeline-dot updated"></div>
                <div class="timeline-content">
                  <span class="timeline-label">Обновлена</span>
                  <div class="timeline-date">
                    <span class="date-main">{{task.updated_on.strftime('%d %B %Y')}}</span>
                    <span class="date-time">{{task.updated_on.strftime('%H:%M')}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Description Card -->
    {% if task.description %}
    <div class="card">
      <div class="card-header collapsible" onclick="toggleCard('description')">
        <div class="card-title">
          <i class="fas fa-align-left"></i>
          <h2>Описание</h2>
        </div>
        <i class="fas fa-chevron-up toggle-icon" id="description-toggle"></i>
      </div>
      <div class="card-content" id="description-content">
        <div class="description-content">
          {{ task.description|safe }}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Attachments Card -->
    {% if task.attachments %}
    <div class="card">
      <div class="card-header collapsible" onclick="toggleCard('attachments')">
        <div class="card-title">
          <i class="fas fa-paperclip"></i>
          <h2>Прикрепленные файлы</h2>
          <span class="count-badge">{{ task.attachments|length }}</span>
        </div>
        <i class="fas fa-chevron-up toggle-icon" id="attachments-toggle"></i>
      </div>
      <div class="card-content" id="attachments-content">
        <div class="attachments-grid">
          {% for attachment in task.attachments %}
          <div class="attachment-item">
            <div class="attachment-icon">
              {% set file_ext = attachment.filename.split('.')[-1].lower() if '.' in attachment.filename else '' %}
              {% if file_ext in ['jpg', 'jpeg', 'png', 'gif'] %}
                <i class="fas fa-image"></i>
              {% elif file_ext in ['pdf'] %}
                <i class="fas fa-file-pdf"></i>
              {% elif file_ext in ['doc', 'docx'] %}
                <i class="fas fa-file-word"></i>
              {% elif file_ext in ['xls', 'xlsx'] %}
                <i class="fas fa-file-excel"></i>
              {% else %}
                <i class="fas fa-file"></i>
              {% endif %}
            </div>
            <div class="attachment-info">
              <span class="attachment-name">{{ attachment.filename }}</span>
              <span class="attachment-size">{{ (attachment.filesize / 1024)|round(1) }} KB</span>
            </div>
            <button class="attachment-download" onclick="downloadAttachment('{{ attachment.id }}')">
              <i class="fas fa-download"></i>
            </button>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- History Card -->
    {% if task.journals %}
    <div class="card history-card">
      <div class="card-header collapsible" onclick="toggleCard('history')">
        <div class="card-title">
          <i class="fas fa-history"></i>
          <h2>История изменений</h2>
          <span class="count-badge">{{ task.journals|length }}</span>
        </div>
        <div class="header-actions">
          <button class="filter-btn" onclick="event.stopPropagation(); toggleHistoryFilters()">
            <i class="fas fa-filter"></i>
            <span>Фильтры</span>
          </button>
          <i class="fas fa-chevron-up toggle-icon" id="history-toggle"></i>
        </div>
      </div>

      <div class="history-filters" id="historyFilters" style="display: none;">
        <div class="filter-chips">
          <button class="filter-chip active" data-filter="all">Все</button>
          <button class="filter-chip" data-filter="comments">Комментарии</button>
          <button class="filter-chip" data-filter="changes">Изменения</button>
          <button class="filter-chip" data-filter="status">Статус</button>
        </div>
      </div>

      <div class="card-content" id="history-content">
        <!-- Форма для добавления комментария -->
        <div class="comment-section">
          <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
            <button class="comment-button" onclick="toggleCommentInput()" style="flex: 1;">
              <i class="fas fa-plus-circle"></i>
              <span>Добавить комментарий</span>
            </button>
            <button class="email-button" onclick="toggleEmailInput()" style="flex: 1;">
              <i class="fas fa-envelope"></i>
              <span>Отправить email</span>
            </button>
          </div>
          <form id="commentForm" action="" method="POST" enctype="multipart/form-data" class="comment-form">
            {{ form.hidden_tag() }}
            <div class="form-group">
              {{ form.comment.label(class="form-label") }}
              {{ form.comment(class="form-control", rows="4", placeholder="Введите ваш комментарий к задаче...") }}
            </div>
            <div class="form-actions">
              <button type="button" onclick="toggleCommentInput()" class="cancel-button">
                <i class="fas fa-times"></i>
                <span>Отмена</span>
              </button>
              <button type="button" onclick="submitCommentAjax(event)" class="submit-button" id="submitBtn">
                <i class="fas fa-paper-plane"></i>
                <span>Отправить</span>
              </button>
            </div>
          </form>
        </div>

        <!-- Форма для отправки email -->
        <div class="email-section">
          <form id="emailForm" class="email-form" style="display: none;">
            {{ email_form.hidden_tag() }}

            <div class="email-form-grid">
              <div class="form-group">
                {{ email_form.sender.label(class="form-label") }}
                {{ email_form.sender(class="form-control", value=support_email) }}
                <!-- DEBUG: support_email = {{ support_email }} -->
              </div>

              <div class="form-group">
                {{ email_form.recipient.label(class="form-label") }}
                {{ email_form.recipient(class="form-control", value=task.easy_email_to or '') }}
              </div>

              <div class="form-group">
                {{ email_form.subject.label(class="form-label") }}
                {{ email_form.subject(class="form-control", value="Задача #" + task.id|string + " - " + task.subject) }}
              </div>

              <div class="form-group">
                {{ email_form.cc.label(class="form-label") }}
                {{ email_form.cc(class="form-control") }}
              </div>

                          <div class="form-group full-width">
                {{ email_form.message.label(class="form-label") }}
                {{ email_form.message(class="form-control", id="emailMessageField", style="display: none;") }}
                <div id="quillEditor" style="margin-top: 10px; margin-bottom: 15px; min-height: 200px; border: 1px solid #ccc; border-radius: 4px;"></div>
            </div>

                          <div class="form-group full-width">
                <div style="margin-bottom: 15px;">
                  <input type="file" id="fileInput" name="attachments" multiple="multiple" style="display: none;">
                </div>
            </div>

            <!-- Отдельная секция файлов вне контейнера сообщений -->
            <div id="fileSection" style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; border: 1px solid #e9ecef;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <div style="flex: 1;">
                    <div id="fileList" style="color: #6c757d; font-size: 14px; margin-bottom: 5px; word-wrap: break-word; word-break: break-word;">Файл не выбран</div>
                  </div>
                  <button type="button" id="fileButton" style="width: 40px; height: 40px; border: 3px solid #ff6b35; border-radius: 50%; background-color: #ff6b35; color: white; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(255,107,53,0.5); transition: all 0.3s ease; font-weight: bold;" onclick="document.getElementById('fileInput').click();" title="Выбрать файлы">
                    📎
                  </button>
                </div>
                <small class="form-text" id="fileSizeText">Максимальный размер файла: 10 МБ. Для выбора нескольких файлов используйте Ctrl+клик или Shift+клик.</small>
            </div>

              <!-- Скрытый переключатель - всегда включен -->
              <div class="form-group checkbox-group" style="display: none;">
                {{ email_form.send_email(class="form-check-input", checked=True) }}
                {{ email_form.send_email.label(class="form-check-label") }}
              </div>
            </div>

            <div class="form-actions">
              <button type="button" onclick="toggleEmailInput()" class="cancel-button">
                <i class="fas fa-times"></i>
                <span>Отмена</span>
              </button>
              <button type="button" onclick="submitEmailAjax(event)" class="submit-button" id="submitEmailBtn">
                <i class="fas fa-envelope"></i>
                <span>Отправить email</span>
              </button>
            </div>
          </form>
        </div>

        <div class="history-timeline">
          {% for journal in task.journals|reverse %}
          <div class="history-item" data-type="{% if journal.notes %}comments{% else %}changes{% endif %}">
            <div class="history-avatar">
              <div class="avatar-circle history">
                {{ journal.user.name[0] if journal.user and journal.user.name else 'U' }}
              </div>
            </div>

            <div class="history-content">
              <div class="history-header">
                <div class="history-user">
                  <span class="user-name">{{ journal.user.name if journal.user else 'Система' }}</span>
                  <span class="history-time">{{ convert_datetime_msk_format(journal.created_on) }}</span>
                </div>
              </div>

              {% if journal.details %}
              <div class="history-changes">
                {% for detail in journal.details %}
                {% set old_value = detail.old_value %}
                {% set new_value = detail.new_value %}
                {% set property_name_html = get_property_name(detail.property if detail.property else 'attr', detail.name, old_value, new_value) %}
                {% if property_name_html %}
                  <div class="change-item">
                    <div class="change-description">
                      <i class="fas fa-arrow-right change-icon"></i>
                      <span>{{ property_name_html | safe }}</span>
                    </div>
                  </div>
                {% else %}
                  <div class="change-item">
                    <div class="change-field">
                      <i class="fas fa-edit change-icon"></i>
                      <span class="field-name">
                        {% if detail.name == 'status_id' %}
                          Статус
                        {% elif detail.name == 'done_ratio' %}
                          Готовность
                        {% elif detail.name == 'assigned_to_id' %}
                          Исполнитель
                        {% elif detail.name == 'priority_id' %}
                          Приоритет
                        {% elif detail.name == 'project_id' %}
                          Проект
                        {% elif detail.name == 'subject' %}
                          Тема
                        {% elif detail.name == 'easy_helpdesk_need_reaction' %}
                          Нужна реакция?
                        {% elif detail.name == '16' %}
                          Что нового
                        {% else %}
                          {{ detail.name }}
                        {% endif %}
                      </span>
                    </div>
                    <div class="change-values">
                      {% if detail.old_value %}
                      <span class="old-value">
                        {% if detail.name == 'status_id' %}
                          {{ status_names.get(detail.old_value|int, detail.old_value) if detail.old_value and detail.old_value.isdigit() else detail.old_value }}
                        {% elif detail.name == 'assigned_to_id' %}
                          {{ user_names.get(detail.old_value|int, detail.old_value) if detail.old_value and detail.old_value.isdigit() else detail.old_value }}
                        {% elif detail.name == 'project_id' %}
                          {{ project_names.get(detail.old_value|int, detail.old_value) if detail.old_value and detail.old_value.isdigit() else detail.old_value }}
                        {% elif detail.name == 'priority_id' %}
                          {{ priority_names.get(detail.old_value|int, detail.old_value) if detail.old_value and detail.old_value.isdigit() else detail.old_value }}
                        {% elif detail.name == 'done_ratio' %}
                          {{ detail.old_value }}%
                        {% elif detail.name == 'easy_helpdesk_need_reaction' %}
                          {% if detail.old_value == '1' %}Да{% else %}Нет{% endif %}
                        {% elif detail.name == '16' %}
                          {% if detail.old_value and detail.old_value != '0' %}Да{% else %}Нет{% endif %}
                        {% else %}
                          {{ detail.old_value }}
                        {% endif %}
                      </span>
                      <i class="fas fa-arrow-right change-arrow"></i>
                      {% endif %}
                      <span class="new-value">
                        {% if detail.name == 'status_id' %}
                          {{ status_names.get(detail.new_value|int, detail.new_value) if detail.new_value and detail.new_value.isdigit() else detail.new_value }}
                        {% elif detail.name == 'assigned_to_id' %}
                          {% if detail.new_value and detail.new_value.isdigit() %}
                            {{ user_names.get(detail.new_value|int, detail.new_value) }}
                          {% else %}
                            Не назначен
                          {% endif %}
                        {% elif detail.name == 'project_id' %}
                          {{ project_names.get(detail.new_value|int, detail.new_value) if detail.new_value and detail.new_value.isdigit() else detail.new_value }}
                        {% elif detail.name == 'priority_id' %}
                          {{ priority_names.get(detail.new_value|int, detail.new_value) if detail.new_value and detail.new_value.isdigit() else detail.new_value }}
                        {% elif detail.name == 'done_ratio' %}
                          {{ detail.new_value }}%
                        {% elif detail.name == 'easy_helpdesk_need_reaction' %}
                          {{ format_boolean_field(detail.new_value, detail.name) }}
                        {% elif detail.name == '16' %}
                          {{ format_boolean_field(detail.new_value, detail.name) }}
                        {% else %}
                          {% if detail.new_value %}
                            {{ detail.new_value }}
                          {% else %}
                            Значение удалено
                          {% endif %}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                {% endif %}
                {% endfor %}
              </div>
              {% endif %}

              {% set user_check = False %}
              {% if task.assigned_to and journal.user %}
                  {% set last_name = current_user.username.split('.')[-1]|lower %}
                  {% if task.assigned_to.name and last_name in task.assigned_to.name|lower
                        and journal.user.name and last_name in journal.user.name|lower %}
                      {% set user_check = True %}
                  {% endif %}
              {% endif %}

              {# Проверяем, что автор комментария совпадает с текущим пользователем #}
              {% set is_comment_author = False %}
              {% if journal.user %}
                {% if journal.user.login and journal.user.login == current_user.username %}
                  {% set is_comment_author = True %}
                {% elif journal.user.name and (journal.user.name == current_user.full_name or journal.user.name|lower == current_user.username|replace('.', ' ')|replace('_', ' ')|lower) %}
                  {% set is_comment_author = True %}
                {% endif %}
              {% endif %}

              {% if is_task_owner and is_comment_author %}
                {% set user_check = True %}
              {% endif %}

              {% if journal.notes %}
                <div class="history-comment" data-journal-id="{{ journal.id }}" style="position: relative;">
                  <div class="comment-content">
                    {{ journal.notes|safe }}
                  </div>

                  {% if user_check %}
                    <div class="comment-actions-dropdown">
                      <div class="comment-actions-trigger" data-journal-id="{{ journal.id }}">
                        <i class="fas fa-ellipsis-v"></i>
                      </div>
                      <div class="comment-actions-menu" id="comment-actions-{{ journal.id }}">
                        <div class="comment-action-item" data-action="edit" data-journal-id="{{ journal.id }}">
                          <i class="fas fa-edit"></i>
                          <span>Редактировать</span>
                        </div>
                        <div class="comment-action-item delete-action" data-action="delete" data-journal-id="{{ journal.id }}">
                          <i class="fas fa-trash"></i>
                          <span>Удалить</span>
                        </div>
                      </div>
                    </div>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<style>
:root {
  --primary-color: #6366f1;
  --secondary-color: #8b5cf6;
  --accent-color: #06d6a0;
  --success-color: #10b981;
  --warning-color: #f59e0b;
  --error-color: #ef4444;
  --info-color: #3b82f6;
  --text-primary: #1f2937;
  --text-secondary: #6b7280;
  --text-muted: #9ca3af;
  --bg-primary: #ffffff;
  --bg-secondary: #f9fafb;
  --bg-tertiary: #f3f4f6;
  --border-color: #e5e7eb;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  --border-radius: 12px;
  --border-radius-lg: 16px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

[data-theme="dark"] {
  --text-primary: #f9fafb;
  --text-secondary: #d1d5db;
  --text-muted: #d1d5db;
  --bg-primary: #111827;
  --bg-secondary: #1f2937;
  --bg-tertiary: #374151;
  --border-color: #4b5563;
  --success-color: #22c55e;
  --error-color: #f87171;
  --warning-color: #fbbf24;
  --primary-color: #818cf8;
  --secondary-color: #a78bfa;
}

.modern-task-detail {
  min-height: 100vh;
  background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  color: var(--text-primary);
  transition: var(--transition);
}

/* FAB */
.fab-container {
  position: fixed;
  bottom: 7rem; /* Точно на 5rem выше кнопки уведомлений (2rem + 5rem = 7rem) */
  right: 2rem; /* Выравниваем по вертикали с кнопкой уведомлений */
  z-index: 1000;
  transition: all 0.3s ease;
}

/* Адаптивность для fab-container */
@media (max-width: 768px) {
  .fab-container {
    right: 2rem;
    bottom: 7rem;
  }
}

@media (max-width: 480px) {
  .fab-container {
    right: 2rem;
    bottom: 7rem;
  }
}

.fab {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  border: none;
  cursor: pointer;
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  transition: var(--transition);
}

.fab:hover {
  transform: none !important;
  box-shadow: var(--shadow-xl);
}

/* Hero Section */
.hero-section {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  padding: 3rem 2rem;
  margin-bottom: 2rem;
}

.hero-content {
  max-width: 1200px;
  margin: 0 auto;
}

.breadcrumb {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 2rem;
  font-size: 0.875rem;
  opacity: 0.9;
}

.breadcrumb-link {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: white;
  text-decoration: none;
  transition: none !important;
}

.breadcrumb-link:hover {
  opacity: 0.8;
}

.breadcrumb-separator {
  opacity: 0.6;
}

.hero-main {
  display: flex;
  align-items: center;
  gap: 2rem;
  margin-bottom: 2rem;
}

.task-status-large {
  flex-shrink: 0;
}

.status-indicator {
  width: 4rem;
  height: 4rem;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: var(--status-color);
  border: 2px solid rgba(255, 255, 255, 0.3);
}

.status-indicator.status-pending {
  animation: pulse 2s infinite;
}

.status-indicator.status-registered {
  animation: bounce 1s ease-in-out;
}

.hero-title {
  font-size: 2.5rem;
  font-weight: 700;
  line-height: 1.2;
  margin: 0 0 0.5rem 0;
}

.hero-subtitle {
  font-size: 1.125rem;
  opacity: 0.9;
  margin: 0;
}

.hero-actions {
  display: flex !important;
  align-items: center !important;
  gap: 1rem !important;
  width: auto !important;
  justify-content: flex-start !important;
  margin-top: 2rem !important;
  flex-wrap: nowrap !important;
}

.button-group {
  display: flex !important;
  align-items: center !important;
  gap: 1rem !important;
  margin: 0 !important;
  flex-wrap: nowrap !important;
}

.action-btn {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 0.5rem !important;
  padding: 0.75rem 1.25rem !important;
  border-radius: 8px !important;
  text-decoration: none !important;
  font-weight: 500 !important;
  transition: all 0.3s ease !important;
  border: none !important;
  cursor: pointer !important;
  white-space: nowrap !important;
  flex-shrink: 0 !important;
  min-width: fit-content !important;
  font-size: 0.9rem !important;
  max-width: none !important;
  flex: 0 0 auto !important;
}

.action-btn.primary {
  background: rgba(255, 255, 255, 0.9) !important;
  color: var(--primary-color) !important;
  backdrop-filter: blur(10px) !important;
  padding: 0.75rem 2rem !important;
}

.action-btn.secondary {
  background: rgba(255, 255, 255, 0.1) !important;
  color: white !important;
  border: 1px solid rgba(255, 255, 255, 0.3) !important;
  padding: 0.75rem 1.5rem !important;
}

.action-btn i {
  font-size: 1rem !important;
  margin-right: 0.5rem !important;
  flex-shrink: 0 !important;
}

.action-btn span {
  display: inline-block !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  flex-shrink: 0 !important;
}

/* Content Grid */
.content-grid {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 2rem 3rem;
  display: grid;
  gap: 2rem;
}

/* Cards */
.card {
  background: var(--bg-primary);
  border-radius: var(--border-radius-lg);
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-color);
  transition: var(--transition);
  overflow: hidden;
}

.card:hover {
  box-shadow: var(--shadow-lg);
  transform: none !important;
}

.card-header {
  padding: 1.5rem 2rem;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-header.collapsible {
  cursor: pointer;
  transition: none !important;
  will-change: auto !important;
  backface-visibility: visible !important;
}

.card-header.collapsible:hover {
  background: var(--bg-secondary);
}

.card-title {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--text-primary);
  flex: 1;
}

.card-title i {
  color: var(--primary-color);
}

.count-badge {
  background: var(--primary-color);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 50px;
  font-size: 0.75rem;
  font-weight: 600;
}

.toggle-icon {
  color: var(--text-secondary);
  transition: none !important;
  font-size: 1rem;
  margin-left: 1rem;
  will-change: auto !important;
  backface-visibility: visible !important;
}

.toggle-icon.rotated {
  transform: rotate(180deg);
}

.card-content {
  padding: 2rem;
  transition: none !important;
  overflow: hidden;
  will-change: auto !important;
  backface-visibility: visible !important;
}

.card-content.collapsed {
  max-height: 0;
  padding: 0 2rem;
  opacity: 0;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 1rem;
}

/* Details Grid */
.details-grid {
  display: grid;
  gap: 3rem;
}

.detail-section {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.section-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
  padding-bottom: 0.75rem;
  border-bottom: 2px solid var(--primary-color);
  display: inline-block;
}

.detail-items {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.detail-item {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  padding: 1rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  transition: var(--transition);
}

.detail-item:hover {
  background: var(--bg-tertiary);
  transform: translateX(4px);
}

.detail-icon {
  width: 2.5rem;
  height: 2.5rem;
  background: var(--primary-color);
  color: white;
  border-radius: var(--border-radius);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.detail-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.detail-label {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.detail-value {
  font-size: 1rem;
  color: var(--text-primary);
  font-weight: 500;
}

/* Badges */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 0.5rem 1rem;
  border-radius: 50px;
  font-size: 0.875rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.badge.high {
  background: rgba(239, 68, 68, 0.1);
  color: var(--error-color);
  border: 1px solid rgba(239, 68, 68, 0.2);
}

.badge.normal {
  background: rgba(99, 102, 241, 0.1);
  color: var(--primary-color);
  border: 1px solid rgba(99, 102, 241, 0.2);
}

/* Progress Bar */
.progress-container {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.progress-bar {
  flex: 1;
  height: 8px;
  background: var(--bg-tertiary);
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
  border-radius: 4px;
  transition: width 0.5s ease;
}

.progress-text {
  font-weight: 600;
  color: var(--primary-color);
  font-size: 0.875rem;
}

/* User Avatars */
.user-avatar {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.avatar-circle {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 1rem;
  flex-shrink: 0;
  text-transform: uppercase;
}

.avatar-circle.assigned {
  background: var(--accent-color);
}

.avatar-circle.history {
  width: 2rem;
  height: 2rem;
  font-size: 0.75rem;
  background: var(--secondary-color);
}

.user-name {
  font-weight: 500;
  color: var(--text-primary);
}

/* Timeline */
.timeline-items {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.timeline-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border-left: 4px solid var(--primary-color);
  transition: none !important;
  will-change: auto !important;
  backface-visibility: visible !important;
  isolation: auto !important;
  contain: none !important;
}

.timeline-item:hover {
  background: var(--bg-tertiary);
  transform: none !important;
}

.timeline-dot {
  width: 1rem;
  height: 1rem;
  border-radius: 50%;
  flex-shrink: 0;
}

.timeline-dot.created { background: var(--primary-color); }
.timeline-dot.started { background: var(--accent-color); }
.timeline-dot.deadline { background: var(--warning-color); }
.timeline-dot.closed { background: var(--success-color); }
.timeline-dot.updated { background: var(--text-muted); }

.timeline-content {
  flex: 1;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.timeline-label {
  font-weight: 500;
  color: var(--text-primary);
}

.timeline-date {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 0.25rem;
}

.date-main {
  font-weight: 600;
  color: var(--text-primary);
}

.date-time {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

/* Email Link */
.email-link {
  color: var(--primary-color);
  text-decoration: none;
  font-weight: 500;
  transition: none !important;
  font-size: 0.875rem;
}

.email-link:hover {
  color: var(--accent-color);
  text-decoration: underline;
}

.email-cc {
  color: var(--text-secondary);
  font-size: 0.875rem;
}

/* Description */
.description-content {
  line-height: 1.7;
  color: var(--text-primary);
}

/* Attachments */
.attachments-grid {
  display: grid;
  gap: 1rem;
}

.attachment-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  transition: none !important;
  will-change: auto !important;
  backface-visibility: visible !important;
}

.attachment-item:hover {
  background: var(--bg-tertiary);
  transform: none !important;
  box-shadow: var(--shadow-md);
}

.attachment-icon {
  width: 2.5rem;
  height: 2.5rem;
  background: var(--primary-color);
  color: white;
  border-radius: var(--border-radius);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.125rem;
}

.attachment-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.attachment-name {
  font-weight: 500;
  color: var(--text-primary);
}

.attachment-size {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.attachment-download {
  width: 2.5rem;
  height: 2.5rem;
  border: none;
  background: var(--accent-color);
  color: white;
  border-radius: var(--border-radius);
  cursor: pointer;
  transition: var(--transition);
}

.attachment-download:hover {
  transform: scale(1.1);
}

.attachment-download:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}

/* History */
.filter-btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  cursor: pointer;
  color: var(--text-primary);
  transition: var(--transition);
}

.filter-btn:hover {
  background: var(--bg-tertiary);
}

.history-filters {
  padding: 1rem 2rem;
  border-bottom: 1px solid var(--border-color);
  background: var(--bg-secondary);
}

.filter-chips {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.filter-chip {
  padding: 0.5rem 1rem;
  border: 1px solid var(--border-color);
  background: var(--bg-primary);
  color: var(--text-secondary);
  border-radius: 50px;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.875rem;
}

.filter-chip.active,
.filter-chip:hover {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

.history-timeline {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.history-item {
  display: flex;
  gap: 1rem;
  padding: 1.5rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  transition: none !important;
  will-change: auto !important;
  backface-visibility: visible !important;
  isolation: auto !important;
  contain: none !important;
}

.history-item:hover {
  background: var(--bg-tertiary);
  box-shadow: none !important;
}

.history-avatar {
  flex-shrink: 0;
}

.history-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.history-user {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.history-time {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.history-changes {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.change-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem;
  background: var(--bg-primary);
  border-radius: var(--border-radius);
  border-left: 3px solid var(--warning-color);
}

.change-field {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  min-width: 8rem;
}

.change-icon {
  color: var(--warning-color);
}

.field-name {
  font-weight: 500;
  color: var(--text-primary);
}

.change-values {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex: 1;
}

.old-value {
  color: var(--error-color);
  text-decoration: line-through;
}

.new-value {
  color: var(--success-color);
  font-weight: 500;
}



[data-theme="dark"] .change-item {
  background: #2d3748 !important;
  border-left-color: #fbbf24 !important;
}

[data-theme="dark"] .history-item {
  background: #1a202c !important;
  border: 1px solid #4a5568 !important;
}

/* Стили для всех span в элементах истории в темной теме */
[data-theme="dark"] .history-item span,
[data-theme="dark"] .change-item span {
  color: #ffffff !important;
}



.change-arrow {
  color: var(--text-muted);
  font-size: 0.75rem;
}

.change-description {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.95rem;
  line-height: 1.5;
  padding: 0.5rem 0;
}

.change-description .change-icon {
  color: var(--primary-color);
  font-size: 0.85rem;
  flex-shrink: 0;
}

.change-description b {
  font-weight: 600;
  color: var(--text-primary);
}

.history-comment {
  padding: 1rem;
  background: #ffffff;
  border-radius: 8px;
  border-left: 3px solid #3b82f6;
  position: relative !important;
  margin-bottom: 1rem;
}

.comment-content {
  line-height: 1.6;
  color: var(--text-primary);
}

/* Comment Form */
.comment-section {
  margin-bottom: 2rem;
  padding: 1.5rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
}

.comment-button {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: var(--border-radius);
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: none !important;
  will-change: auto !important;
  backface-visibility: visible !important;
}

.comment-button:hover {
  background: var(--secondary-color);
  transform: none !important;
  box-shadow: var(--shadow-md);
}

.comment-form {
  display: none;
  margin-top: 1rem;
}

.comment-form .form-group {
  margin-bottom: 1rem;
}

.comment-form .form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: var(--text-primary);
}

.comment-form .form-control {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  font-size: 0.875rem;
  background: var(--bg-primary);
  color: var(--text-primary);
  transition: var(--transition);
  resize: vertical;
  min-height: 100px;
}

.comment-form .form-control:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.form-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
}

.cancel-button,
.submit-button {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: var(--border-radius);
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.cancel-button {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border-color);
}

.cancel-button:hover {
  background: var(--bg-secondary);
  color: var(--text-primary);
}

.submit-button {
  background: var(--success-color);
}

/* Email Form */
.email-section {
  margin-bottom: 2rem;
  padding: 1.5rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
}

.email-button {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  background: var(--info-color);
  color: white;
  border: none;
  border-radius: var(--border-radius);
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.email-button:hover {
  background: var(--secondary-color);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.email-form {
  display: none;
  margin-top: 1rem;
}

.email-form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1rem;
}

.email-form .form-group {
  margin-bottom: 1rem;
}

.email-form .form-group.full-width {
  grid-column: 1 / -1;
}

.email-form .form-group.checkbox-group {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.email-form .form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: var(--text-primary);
}

.email-form .form-control {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  font-size: 0.875rem;
  background: var(--bg-primary);
  color: var(--text-primary);
  transition: var(--transition);
  resize: vertical;
}

.email-form .form-control:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.email-form .form-check-input {
  margin-right: 0.5rem;
}

.email-form .form-check-label {
  font-weight: 500;
  color: var(--text-primary);
}

  .email-form .form-text {
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-top: 0.25rem;
}

.submit-button:hover {
  background: var(--accent-color);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.submit-button:disabled {
  background: var(--text-muted);
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.ajax-button {
  background: var(--accent-color) !important;
  position: relative;
  overflow: hidden;
}

.ajax-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s;
}

.ajax-button:hover::before {
  left: 100%;
}

.ajax-button:hover {
  background: var(--success-color) !important;
}

/* Стили для кнопки удаления комментария */
.comment-actions {
  position: absolute !important;
  top: 8px !important;
  right: 8px !important;
  opacity: 0 !important;
  transition: opacity 0.3s ease, visibility 0.3s ease !important;
  z-index: 999 !important;
  visibility: hidden !important;
}

/* Показ кнопки при наведении на комментарий */
.history-comment:hover .comment-actions {
  opacity: 1 !important;
  visibility: visible !important;
}

/* Альтернативные стили для принудительного показа */
.comment-actions.show {
  opacity: 1 !important;
  visibility: visible !important;
}

/* Стили для мобильных устройств - всегда видны */
@media (max-width: 768px) {
  .comment-actions {
    opacity: 1 !important;
    visibility: visible !important;
  }
}

/* Стили для сенсорных экранов - всегда видны */
@media (hover: none) {
  .comment-actions {
    opacity: 1 !important;
    visibility: visible !important;
  }
}

/* ВРЕМЕННЫЕ СТИЛИ ДЛЯ ОТЛАДКИ - УДАЛИТЬ ПОСЛЕ ТЕСТИРОВАНИЯ */
.comment-actions.debug-visible {
  opacity: 1 !important;
  visibility: visible !important;
  background: rgba(255, 0, 0, 0.1) !important;
  border: 1px solid red !important;
}

/* Альтернативный способ показа при hover */
.history-comment:hover .comment-actions,
.history-comment:focus .comment-actions,
.history-comment:focus-within .comment-actions {
  opacity: 1 !important;
  visibility: visible !important;
}

.delete-comment-btn {
  background: rgba(239, 68, 68, 0.1) !important;
  border: 1px solid rgba(239, 68, 68, 0.2) !important;
  color: var(--error-color) !important;
  padding: 4px 6px !important;
  border-radius: 6px !important;
  font-size: 12px !important;
  cursor: pointer !important;
  transition: all 0.3s ease !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  width: 24px !important;
  height: 24px !important;
  backdrop-filter: blur(8px) !important;
}

.delete-comment-btn:hover {
  background: var(--error-color) !important;
  color: white !important;
  border-color: var(--error-color) !important;
  transform: translateY(-1px) scale(1.1) !important;
  box-shadow: 0 4px 8px rgba(239, 68, 68, 0.3) !important;
}

.delete-comment-btn:active {
  transform: translateY(0) scale(1) !important;
}

.delete-comment-btn i {
  font-size: 10px !important;
}

/* Responsive */
@media (max-width: 768px) {
  .hero-section {
    padding: 2rem 1rem;
  }

  .hero-main {
    flex-direction: column;
    text-align: center;
    gap: 1rem;
  }

  .hero-title {
    font-size: 2rem;
  }

  .hero-actions {
    flex-direction: row !important;
    flex-wrap: wrap !important;
    justify-content: flex-start !important;
    gap: 1rem !important;
  }

  .button-group {
    flex-direction: row !important;
    justify-content: flex-start !important;
    width: auto !important;
    flex-wrap: nowrap !important;
  }

  .action-btn {
    width: auto !important;
    flex: 0 0 auto !important;
  }

  .content-grid {
    padding: 0 1rem 2rem;
  }

  .card-content {
    padding: 1.5rem;
  }

  .details-grid {
    gap: 2rem;
  }

  .detail-item {
    flex-direction: column;
    gap: 0.75rem;
    text-align: center;
  }

  .timeline-item {
    flex-direction: column;
    gap: 0.75rem;
    text-align: center;
  }

  .history-item {
    padding: 1rem;
  }

  .filter-chips {
    justify-content: center;
  }
}

@media (max-width: 480px) {
  .hero-actions {
    flex-direction: column !important;
    align-items: stretch !important;
  }

  .button-group {
    flex-direction: column !important;
    width: 100% !important;
    align-items: stretch !important;
  }

  .action-btn {
    width: 100% !important;
  }
}

/* Animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.8;
    transform: scale(1.05);
  }
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-5px);
  }
  60% {
    transform: translateY(-3px);
  }
}

.card {
  animation: fadeInUp 0.5s ease-out;
}

.card:nth-child(1) { animation-delay: 0.1s; }
.card:nth-child(2) { animation-delay: 0.2s; }
.card:nth-child(3) { animation-delay: 0.3s; }
.card:nth-child(4) { animation-delay: 0.4s; }

/* Print Styles */
@media print {
  .fab-container,
  .hero-actions,
  .filter-btn,
  .history-filters {
    display: none !important;
  }

  .hero-section {
    background: none !important;
    color: black !important;
  }

  .card {
    box-shadow: none !important;
    border: 1px solid #ccc !important;
    margin-bottom: 1rem !important;
  }
}

/* Кнопка «Назад к списку» – всегда видима на любом фоне */
.action-btn.back-btn {
  background: rgba(255, 255, 255, 0.9) !important; /* светлый полупрозрачный */
  color: var(--primary-color) !important;
  border: 1px solid rgba(255, 255, 255, 0.6) !important;
  backdrop-filter: blur(6px) !important;
}

.action-btn.back-btn:hover {
  background: var(--primary-color) !important;
  color: #ffffff !important;
}

[data-theme="dark"] .action-btn.back-btn {
  background: rgba(17, 24, 39, 0.9) !important; /* тёмный стеклянный фон */
  color: var(--primary-color) !important;
  border: 1px solid rgba(255, 255, 255, 0.2) !important;
}

.comment-actions-dropdown {
  position: relative;
  display: inline-block;
}
.comment-actions-trigger {
  position: absolute;
  top: 8px;
  right: 8px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(10px);
  border: 1px solid var(--border-color);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  opacity: 0;
  transform: scale(0.8);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 10;
  box-shadow: var(--shadow-sm);
}
.comment-actions-trigger:hover {
  background: var(--bg-primary);
  transform: scale(1);
  box-shadow: var(--shadow-md);
}
.history-comment:hover .comment-actions-trigger {
  opacity: 1;
  transform: scale(1);
}
.comment-actions-menu {
  position: absolute;
  top: 40px;
  right: 0;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  box-shadow: var(--shadow-lg);
  min-width: 160px;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-10px) scale(0.95);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 1000;
  overflow: hidden;
}
.comment-actions-menu.show {
  opacity: 1;
  visibility: visible;
  transform: translateY(0) scale(1);
}
.comment-action-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  cursor: pointer;
  transition: all 0.2s ease;
  color: var(--text-primary);
  font-size: 0.875rem;
  font-weight: 500;
}
.comment-action-item:hover {
  background: var(--bg-secondary);
  color: var(--primary-color);
}
.comment-action-item.delete-action:hover {
  background: #fef2f2;
  color: var(--error-color);
}
.comment-action-item i {
  font-size: 0.875rem;
  width: 16px;
  text-align: center;
}
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}
.comment-actions-menu.show {
  animation: slideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
@media (max-width: 768px) {
  .comment-actions-trigger {
    width: 28px;
    height: 28px;
    top: 4px;
    right: 4px;
  }
  .comment-actions-menu {
    min-width: 140px;
    right: -8px;
  }
  .comment-action-item {
    padding: 10px 12px;
    font-size: 0.8rem;
  }
}

[data-theme="dark"] .history-comment {
  background: #23272f !important;
  color: #f3f4f6 !important;
}
[data-theme="dark"] .history-comment .comment-content {
  color: #f3f4f6 !important;
}
</style>
<script>
// Email функции
function toggleEmailInput() {
    const emailForm = document.getElementById('emailForm');
    const emailButton = document.querySelector('.email-button');

    if (emailForm.style.display === 'none' || emailForm.style.display === '') {
        emailForm.style.display = 'block';
        emailButton.style.display = 'none';

        // Вставляем HTML подпись в поле сообщения
        insertEmailSignature();

        // Обновляем тему для кнопки файлов
        if (typeof updateEmailFormTheme === 'function') {
            updateEmailFormTheme();
        }

        // Фокус на поле получателя
        const recipientField = emailForm.querySelector('input[name="recipient"]');
        if (recipientField) {
            recipientField.focus();
        }
    } else {
        emailForm.style.display = 'none';
        emailButton.style.display = 'block';
        // Очищаем форму
        emailForm.reset();
    }
}

function insertEmailSignature() {
    // Подпись будет добавлена автоматически при отправке email
    // Функция оставлена для совместимости
    if (typeof window.quillEditor !== 'undefined' && window.quillEditor && typeof window.quillEditor.setText === 'function') {
        // Очищаем редактор при открытии формы
        window.quillEditor.setText('');
    }
}

function disableEmailSubmitButton() {
    const submitBtn = document.getElementById('submitEmailBtn');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Отправка...</span>';
    }
}

async function submitEmailAjax(event) {
    event.preventDefault();

    const form = document.getElementById('emailForm');
    const formData = new FormData(form);

    // Получаем данные из формы
    const recipient = formData.get('recipient')?.trim();
    const subject = formData.get('subject')?.trim();

    // Получаем HTML-контент из Quill.js
    const message = (typeof window.quillEditor !== 'undefined' && window.quillEditor && typeof window.quillEditor.root !== 'undefined') ? window.quillEditor.root.innerHTML : formData.get('message')?.trim();

    const cc = formData.get('cc')?.trim();
    const sendEmail = formData.get('send_email') === 'y';

    // Валидация
    if (!recipient) {
        showNotification('Email получателя обязателен', 'error');
        return;
    }
    if (!subject) {
        showNotification('Тема письма обязательна', 'error');
        return;
    }
    if (!message) {
        showNotification('Текст сообщения обязателен', 'error');
        return;
    }

    // Отключаем кнопку отправки
    disableEmailSubmitButton();

    try {
        const taskId = getTaskIdFromUrl();

        // Получаем CSRF токен из формы
        const csrfToken = form.querySelector('input[name="csrf_token"]')?.value;

        // Создаем FormData для отправки файлов
        const formDataToSend = new FormData();
        const sender = formData.get('sender')?.trim();

        // Добавляем HTML подпись к сообщению
        const signatureHtml = `{{ email_signature_html|safe }}`;
        const messageWithSignature = message + '\n\n' + signatureHtml;

        formDataToSend.append('sender', sender || '');
        formDataToSend.append('recipient', recipient);
        formDataToSend.append('subject', subject);
        formDataToSend.append('message', messageWithSignature);
        formDataToSend.append('cc', cc || '');
        formDataToSend.append('send_email', sendEmail ? 'y' : 'n');

        // Добавляем файлы из формы
        const fileInput = document.getElementById('fileInput');
        if (fileInput && fileInput.files) {
            for (let i = 0; i < fileInput.files.length; i++) {
                formDataToSend.append('attachments', fileInput.files[i]);
            }
        }

        const headers = {
            'X-Requested-With': 'XMLHttpRequest'
        };

        // Добавляем CSRF токен если он есть
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }

        const response = await fetch(`/tasks/api/task/${taskId}/send-email`, {
            method: 'POST',
            headers: headers,
            body: formDataToSend
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();

        if (data.success) {
            showNotification(data.message, 'success');
            // Очищаем форму и скрываем её
            form.reset();
            toggleEmailInput();
        } else {
            showNotification(data.error, 'error');
        }
    } catch (error) {
        console.error('Ошибка при отправке email:', error);
        showNotification('Ошибка при отправке email: ' + error.message, 'error');
    } finally {
        // Восстанавливаем кнопку отправки
        const submitBtn = document.getElementById('submitEmailBtn');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-envelope"></i> <span>Отправить email</span>';
        }
    }
}

function toggleCommentActions(journalId) {
  const menu = document.getElementById(`comment-actions-${journalId}`);
  const allMenus = document.querySelectorAll('.comment-actions-menu');
  allMenus.forEach(m => {
    if (m !== menu) {
      m.classList.remove('show');
    }
  });
  menu.classList.toggle('show');
}
document.addEventListener('click', function(event) {
  const dropdowns = document.querySelectorAll('.comment-actions-dropdown');
  dropdowns.forEach(dropdown => {
    if (!dropdown.contains(event.target)) {
      const menu = dropdown.querySelector('.comment-actions-menu');
      if (menu) {
        menu.classList.remove('show');
      }
    }
  });
});

// Делегирование кликов для back-btn и пунктов меню комментариев
document.addEventListener('click', function(e) {
  const backBtn = e.target.closest('#go-back-btn');
  if (backBtn) {
    const id = backBtn.dataset.taskId;
    if (id) { goBackToTasksList(id); }
    return;
  }

  const trigger = e.target.closest('.comment-actions-trigger');
  if (trigger) {
    toggleCommentActions(trigger.dataset.journalId);
    return;
  }

  const actionItem = e.target.closest('.comment-action-item');
  if (actionItem) {
    const jid = actionItem.dataset.journalId;
    if (actionItem.dataset.action === 'edit') {
      openEditCommentModal(jid);
    } else if (actionItem.dataset.action === 'delete') {
      deleteComment(jid);
    }
  }
});
async function deleteComment(journalId) {
  if (!confirm('Вы уверены, что хотите удалить этот комментарий?')) {
    return;
  }
  try {
    const taskId = getTaskIdFromUrl();
    const response = await fetch(`/tasks/api/task/${taskId}/comment/${journalId}/delete`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        ...(() => {
          const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
          return token ? { 'X-CSRFToken': token } : {};
        })()
      }
    });
    if (!response.ok) {
      const errorText = await response.text();
      showNotification('Ошибка при удалении: ' + errorText, 'error');
      return;
    }
    const data = await response.json();
    if (data.success) {
      showNotification(data.message, 'success');
      const commentElement = document.querySelector(`[data-journal-id="${journalId}"]`);
      if (commentElement) {
        commentElement.closest('.history-item').remove();
      }
    } else {
      showNotification(data.error || 'Ошибка при удалении комментария', 'error');
    }
  } catch (error) {
    showNotification('Произошла ошибка при удалении комментария', 'error');
  }
}
</script>

<script>
// Функция применения стилей для темной темы
function applyDarkThemeStyles() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

  if (!isDark) return;

  const allSpans = document.querySelectorAll('span');

  allSpans.forEach(span => {
    const text = span.textContent.trim();

    // Сброс стилей
    span.style.color = '';
    span.style.backgroundColor = '';
    span.style.padding = '';
    span.style.border = '';
    span.style.borderRadius = '';
    span.style.fontWeight = '';

    // Стили для текста с "изменился" - только в описании изменений
    if (span.closest('.change-description') && (text.includes('изменился') || text.includes('Параметр'))) {
      span.style.color = '#fbbf24';
      span.style.fontWeight = 'bold';
      span.style.backgroundColor = 'rgba(251, 191, 36, 0.2)';
      span.style.padding = '2px 4px';
      span.style.borderRadius = '4px';
    }

    // Стили для значений - только по CSS классам (НЕ для имён пользователей)
    else if ((!span.classList.contains('user-name')) &&
             (span.classList.contains('old-value') || span.classList.contains('new-value'))) {
      span.style.color = '#51cf66';
      span.style.fontWeight = '600';
      span.style.backgroundColor = 'rgba(81, 207, 102, 0.2)';
      span.style.padding = '2px 6px';
      span.style.borderRadius = '4px';
      span.style.border = '1px solid #51cf66';
    }

    // Общие стили для span в истории (исключая пользователей)
    else if ((span.closest('.history-item') || span.closest('.change-item')) &&
             !span.classList.contains('user-name') &&
             !span.closest('.history-user')) {
      span.style.color = '#ffffff';
    }
  });
}

// Theme Toggle
function toggleTheme() {
  const html = document.documentElement;
  const themeIcon = document.getElementById('theme-icon');

  if (html.getAttribute('data-theme') === 'dark') {
    html.removeAttribute('data-theme');
    themeIcon.className = 'fas fa-moon';
    localStorage.setItem('theme', 'light');
  } else {
    html.setAttribute('data-theme', 'dark');
    themeIcon.className = 'fas fa-sun';
    localStorage.setItem('theme', 'dark');
  }

  // Применяем стили после смены темы
  setTimeout(applyDarkThemeStyles, 100);
}

// Initialize theme
document.addEventListener('DOMContentLoaded', function() {
  const savedTheme = localStorage.getItem('theme');
  const themeIcon = document.getElementById('theme-icon');

  if (savedTheme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    themeIcon.className = 'fas fa-sun';
    // Применяем стили для темной темы
    setTimeout(applyDarkThemeStyles, 500);
  }

  // Применяем стили для темной темы при загрузке
  setTimeout(applyDarkThemeStyles, 500);
});

// Copy Task Link
function copyTaskLink() {
  const url = window.location.href;
  navigator.clipboard.writeText(url).then(() => {
    showNotification('Ссылка скопирована в буфер обмена!', 'success');
  });
}

// Show Notification
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check' : 'info'}-circle"></i>
    <span>${message}</span>
  `;

  Object.assign(notification.style, {
    position: 'fixed',
    top: '2rem',
    right: '2rem',
    background: type === 'success' ? 'var(--success-color)' : 'var(--primary-color)',
    color: 'white',
    padding: '1rem 1.5rem',
    borderRadius: 'var(--border-radius)',
    boxShadow: 'var(--shadow-lg)',
    zIndex: '1001',
    display: 'flex',
    alignItems: 'center',
    gap: '0.5rem',
    animation: 'slideInRight 0.3s ease-out'
  });

  document.body.appendChild(notification);

  setTimeout(() => {
    notification.style.animation = 'slideOutRight 0.3s ease-out';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// History Filters
function toggleHistoryFilters() {
  const filters = document.getElementById('historyFilters');
  filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

// Toggle Card Sections
function toggleCard(cardId) {
  const content = document.getElementById(cardId + '-content');
  const toggle = document.getElementById(cardId + '-toggle');

  if (content.classList.contains('collapsed')) {
    content.classList.remove('collapsed');
    toggle.classList.remove('rotated');
  } else {
    content.classList.add('collapsed');
    toggle.classList.add('rotated');
  }
}

// Filter chips
document.addEventListener('DOMContentLoaded', function() {
  const filterChips = document.querySelectorAll('.filter-chip');
  const historyItems = document.querySelectorAll('.history-item');

  filterChips.forEach(chip => {
    chip.addEventListener('click', function() {
      // Remove active class from all chips
      filterChips.forEach(c => c.classList.remove('active'));
      // Add active class to clicked chip
      this.classList.add('active');

      const filter = this.getAttribute('data-filter');

      historyItems.forEach(item => {
        if (filter === 'all') {
          item.style.display = 'flex';
        } else if (filter === 'status') {
          // Показываем только элементы с изменениями статуса
          const itemType = item.getAttribute('data-type');
          if (itemType === 'changes') {
            // Проверяем, есть ли изменения статуса в этом элементе
            // Вариант 1: через класс .field-name (стандартная структура)
            const hasStatusFieldName = item.querySelector('.field-name') &&
                                       item.querySelector('.field-name').textContent.trim() === 'Статус';

            // Вариант 2: через содержимое текста (функция get_property_name)
            const changeDescriptions = item.querySelectorAll('.change-description span');
            let hasStatusInDescription = false;
            changeDescriptions.forEach(span => {
              if (span.textContent.includes('Параметр') && span.textContent.includes('Статус') && span.textContent.includes('изменился')) {
                hasStatusInDescription = true;
              }
            });

            item.style.display = (hasStatusFieldName || hasStatusInDescription) ? 'flex' : 'none';
          } else {
            item.style.display = 'none';
          }
        } else {
          const itemType = item.getAttribute('data-type');
          item.style.display = itemType === filter ? 'flex' : 'none';
        }
      });
    });
  });
});

// Smooth scrolling for internal links
document.addEventListener('DOMContentLoaded', function() {
  const links = document.querySelectorAll('a[href^="#"]');
  links.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({ behavior: 'smooth' });
      }
    });
  });
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(style);

// Helper function to get task ID from URL
function getTaskIdFromUrl() {
  const pathParts = window.location.pathname.split('/');
  const taskIndex = pathParts.indexOf('my-tasks');
  if (taskIndex !== -1 && taskIndex + 1 < pathParts.length) {
    const taskId = pathParts[taskIndex + 1];
    if (!isNaN(taskId)) {
      return taskId;
    }
  }
  return null;
}

// Attachment download function
async function downloadAttachment(attachmentId) {
  const taskId = getTaskIdFromUrl();

  if (!taskId) {
    showNotification('Ошибка: не удалось определить ID задачи', 'error');
    return;
  }

  // Показываем индикатор загрузки
  const downloadBtn = (event && event.target) ? event.target.closest('.attachment-download') : null;
  const originalContent = downloadBtn ? downloadBtn.innerHTML : '';
  if (downloadBtn) {
    downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    downloadBtn.disabled = true;
  }

  try {
    // Создаем URL для скачивания
    const downloadUrl = `/tasks/api/task/${taskId}/attachment/${attachmentId}/download`;

    // Получаем информацию о файле
    const response = await fetch(downloadUrl, {
      method: 'GET',
      credentials: 'same-origin'
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();

    if (data.success && data.download_url) {
      // Открываем URL для скачивания в новом окне
      window.open(data.download_url, '_blank');
      showNotification(`Открывается скачивание файла: ${data.filename}`, 'success');
    } else {
      throw new Error('Не удалось получить URL для скачивания');
    }

  } catch (error) {
    console.error('Ошибка скачивания файла:', error);
    showNotification(`Ошибка скачивания файла: ${error.message}`, 'error');
  } finally {
    // Восстанавливаем кнопку
    setTimeout(() => {
      if (downloadBtn) {
        downloadBtn.innerHTML = originalContent;
        downloadBtn.disabled = false;
      }
    }, 1000);
  }
}

function goBackToTasksList(taskId) {
    // Очищаем сохраненный ID задачи, чтобы не выделять неправильную строку
    sessionStorage.removeItem('return_from_task_id');

    // Получаем сохраненный режим просмотра или используем 'list' по умолчанию
    const savedView = sessionStorage.getItem('return_from_task_view') || 'list';

    console.log(`[goBackToTasksList] 🔄 Возврат к списку задач`);
    console.log(`[goBackToTasksList] 💾 Сохраненный режим просмотра: ${savedView}`);
    console.log(`[goBackToTasksList] 📋 Все sessionStorage:`, Object.fromEntries(Object.entries(sessionStorage)));

    // Переходим обратно с параметром режима
    const returnUrl = `/tasks/my-tasks?view=${savedView}`;
    console.log(`[goBackToTasksList] 🚀 Переход по URL: ${returnUrl}`);

    window.location.href = returnUrl;
}

// Функционал изменения статуса задачи подключен из внешнего файла task_status_change.js

// ===== ФУНКЦИОНАЛ КОММЕНТАРИЕВ =====

/**
 * Переключение видимости формы комментариев
 */
function toggleCommentInput() {
    const commentForm = document.getElementById('commentForm');
    const commentButton = document.querySelector('.comment-button');

    if (commentForm.style.display === 'none' || commentForm.style.display === '') {
        commentForm.style.display = 'block';
        commentButton.style.display = 'none';
        // Фокус на поле ввода
        const textarea = commentForm.querySelector('textarea');
        if (textarea) {
            textarea.focus();
        }
    } else {
        commentForm.style.display = 'none';
        commentButton.style.display = 'block';
        // Очищаем поле ввода
        const textarea = commentForm.querySelector('textarea');
        if (textarea) {
            textarea.value = '';
        }
    }
}

/**
 * Отключение кнопки отправки для предотвращения двойного нажатия
 */
function disableSubmitButton() {
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>Отправка...</span>';
    }
}



/**
 * Отправка комментария через AJAX (альтернативный способ)
 */
async function submitCommentAjax(event) {
    event.preventDefault();

    const form = document.getElementById('commentForm');
    const textarea = form.querySelector('textarea');
    const comment = textarea.value.trim();

    if (!comment) {
        showNotification('Комментарий не может быть пустым', 'error');
        return;
    }

    // Отключаем кнопку отправки
    disableSubmitButton();

    try {
        const taskId = getTaskIdFromUrl();

        // Получаем CSRF токен из формы
        const csrfToken = form.querySelector('input[name="csrf_token"]')?.value;

        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };

        // Добавляем CSRF токен если он есть
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }

        console.log('Отправляем AJAX запрос:', {
            url: `/tasks/api/task/${taskId}/comment`,
            method: 'POST',
            headers: headers,
            body: { comment: comment }
        });

        const response = await fetch(`/tasks/api/task/${taskId}/comment`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
                comment: comment
            })
        });

        console.log('Получен ответ:', response.status, response.statusText);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('Ошибка HTTP:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        console.log('Данные ответа:', data);

        if (data.success) {
            showNotification(data.message, 'success');
            // Очищаем форму и скрываем её
            textarea.value = '';
            toggleCommentInput();
            // Можно перезагрузить страницу для обновления истории
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification(data.error, 'error');
        }
    } catch (error) {
        console.error('Ошибка при отправке комментария:', error);
        showNotification('Ошибка при отправке комментария: ' + error.message, 'error');
    } finally {
        // Восстанавливаем кнопку отправки
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> <span>Отправить</span>';
        }
    }
}



/**
 * Функция для инициализации кнопок удаления комментариев
 */
function initializeDeleteCommentButtons() {
  console.log('Инициализация кнопок удаления комментариев');

  // Убеждаемся, что у всех комментариев есть правильные стили
  document.querySelectorAll('.history-comment').forEach((comment, index) => {
    console.log(`Обрабатываем комментарий ${index + 1}:`, comment);

    const actions = comment.querySelector('.comment-actions');
    console.log(`Найдены actions для комментария ${index + 1}:`, actions);

    if (actions) {
      // Принудительно применяем стили для надежности
      actions.style.position = 'absolute';
      actions.style.top = '8px';
      actions.style.right = '8px';
      actions.style.zIndex = '999';
      actions.style.opacity = '0';
      actions.style.visibility = 'hidden';
      actions.style.transition = 'opacity 0.3s ease, visibility 0.3s ease';

      // Добавляем обработчики событий для показа/скрытия кнопок
      comment.addEventListener('mouseenter', function() {
        console.log('Наведение на комментарий:', this);
        const actions = this.querySelector('.comment-actions');
        if (actions) {
          actions.style.opacity = '1';
          actions.style.visibility = 'visible';
          actions.classList.add('show');
          console.log('Кнопка удаления показана');
        }
      });

      comment.addEventListener('mouseleave', function() {
        console.log('Мышь ушла с комментария:', this);
        const actions = this.querySelector('.comment-actions');
        if (actions) {
          actions.style.opacity = '0';
          actions.style.visibility = 'hidden';
          actions.classList.remove('show');
          console.log('Кнопка удаления скрыта');
        }
      });
    }
  });
}



/**
 * Скрытие формы комментариев при загрузке страницы
 */
document.addEventListener('DOMContentLoaded', function() {
    const commentForm = document.getElementById('commentForm');
    if (commentForm) {
        commentForm.style.display = 'none';
    }

    // Очистка формы после успешной отправки (без Jinja в JS)
    const CLEAR_COMMENT = JSON.parse('{{ (clear_comment|default(false))|tojson }}');
    if (CLEAR_COMMENT) {
        const textarea = document.querySelector('#commentForm textarea');
        if (textarea) {
            textarea.value = '';
        }
    }

    // Инициализируем кнопки удаления комментариев
    initializeDeleteCommentButtons();

    // Простая проверка кнопок удаления
    console.log('Найдено комментариев:', document.querySelectorAll('.history-comment').length);
    console.log('Найдено кнопок удаления:', document.querySelectorAll('.comment-actions').length);

    // ВРЕМЕННЫЙ ОТЛАДОЧНЫЙ КОД - УДАЛИТЬ ПОСЛЕ ТЕСТИРОВАНИЯ
    // Делаем все кнопки видимыми для тестирования
    setTimeout(() => {
  document.querySelectorAll('.comment-actions').forEach((actions, index) => {
        console.log(`Добавляем debug-visible к кнопке ${index + 1}:`, actions);
        actions.classList.add('debug-visible');

        // Также проверим, что кнопка правильно позиционирована
        const computedStyle = window.getComputedStyle(actions);
        console.log(`Стили кнопки ${index + 1}:`, {
          position: computedStyle.position,
          top: computedStyle.top,
          right: computedStyle.right,
          opacity: computedStyle.opacity,
          visibility: computedStyle.visibility,
          zIndex: computedStyle.zIndex
        });
      });
    }, 1000);
});

let editingJournalId = null;

function openEditCommentModal(journalId) {
  editingJournalId = journalId;
  // Получаем текст комментария из DOM
  const commentBlock = document.querySelector(`.history-comment[data-journal-id="${journalId}"] .comment-content`);
  const commentText = commentBlock ? commentBlock.innerText : '';
  document.getElementById('editCommentTextarea').value = commentText;
  document.getElementById('editCommentModal').style.display = 'flex';
}

function closeEditCommentModal() {
  editingJournalId = null;
  document.getElementById('editCommentModal').style.display = 'none';
}


document.addEventListener('DOMContentLoaded', function() {
  // Навешиваем обработчики для модального окна редактирования комментария
  const cancelBtn = document.getElementById('cancelEditCommentBtn');
  const closeBtn = document.getElementById('closeEditCommentModalBtn');
  const saveBtn = document.getElementById('saveEditCommentBtn');

  if (cancelBtn) cancelBtn.onclick = closeEditCommentModal;
  if (closeBtn) closeBtn.onclick = closeEditCommentModal;
  if (saveBtn) saveBtn.onclick = async function() {
    const newText = document.getElementById('editCommentTextarea').value.trim();
    if (!newText) {
      showNotification('Комментарий не может быть пустым', 'error');
      return;
    }
    try {
      const taskId = getTaskIdFromUrl();
      const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      const response = await fetch(`/tasks/api/task/${taskId}/comment/${editingJournalId}/edit`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          ...(token ? { 'X-CSRFToken': token } : {})
        },
        body: JSON.stringify({ comment: newText })
      });
      if (!response.ok) {
        const errorText = await response.text();
        showNotification('Ошибка при сохранении: ' + errorText, 'error');
        return;
      }
      const data = await response.json();
      if (data.success) {
        showNotification('Комментарий обновлён', 'success');
        closeEditCommentModal();
        setTimeout(() => window.location.reload(), 500);
      } else {
        showNotification(data.error || 'Ошибка при сохранении', 'error');
      }
    } catch (e) {
      showNotification('Ошибка при сохранении: ' + e, 'error');
    }
  };
});
</script>

<!-- Модальное окно для редактирования комментария -->
<div id="editCommentModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; align-items:center; justify-content:center; z-index:2000; background:rgba(0,0,0,0.3);">
  <div style="background:#fff; padding:2rem; border-radius:10px; min-width:300px; max-width:90vw; box-shadow:0 8px 32px rgba(0,0,0,0.2); display:flex; flex-direction:column; gap:1rem; position:relative;">
    <button id="closeEditCommentModalBtn" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.5rem; color:#888; cursor:pointer;">×</button>
    <h3 style="margin:0 0 1rem 0;">Редактировать комментарий</h3>
    <textarea id="editCommentTextarea" style="width:100%; min-height:100px; resize:vertical; border-radius:6px; border:1px solid #ccc; padding:0.5rem;"></textarea>
    <div style="display:flex; gap:1rem; justify-content:flex-end;">
      <button id="cancelEditCommentBtn" type="button" style="background:#eee; border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">Отмена</button>
      <button id="saveEditCommentBtn" type="button" style="background:#3b82f6; color:#fff; border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">Сохранить</button>
    </div>
  </div>
</div>

            <!-- Quill.js Rich Text Editor -->
            <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
            <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
            <style>
                .ql-editor {
                    min-height: 200px;
                    font-family: Arial, sans-serif;
                    font-size: 14px;
                }
                .ql-toolbar {
                    border-top: 1px solid #ccc;
                    border-left: 1px solid #ccc;
                    border-right: 1px solid #ccc;
                    background: #f8f9fa;
                }
                .ql-container {
                    border-bottom: 1px solid #ccc;
                    border-left: 1px solid #ccc;
                    border-right: 1px solid #ccc;
                }
                .ql-toolbar button {
                    cursor: pointer !important;
                }
                .ql-toolbar button:hover {
                    color: #007bff !important;
                }
                .ql-toolbar .ql-active {
                    color: #007bff !important;
                }
                .ql-toolbar .ql-picker {
                    cursor: pointer !important;
                }
                .ql-toolbar .ql-picker-label {
                    cursor: pointer !important;
                }
                .ql-toolbar .ql-picker-options {
                    background: white;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }

                /* Стили для формы email */
                .email-form-grid {
                    gap: 15px;
                }
                .email-form .form-group {
                    margin-bottom: 20px;
                }
                .email-form .form-control {
                    margin-bottom: 8px;
                }
                .email-form .form-text {
                    margin-top: 5px;
                    color: #6c757d;
                }
                .email-form input[type="file"] {
                    padding: 8px;
                    border: 1px solid #ced4da;
                    border-radius: 4px;
                    background-color: #fff;
                }
                .email-form input[type="file"]:focus {
                    border-color: #80bdff;
                    outline: 0;
                    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
                }

                /* Дополнительные стили для улучшения отступов */
                .email-form {
                    padding: 20px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    margin-top: 15px;
                }
                .email-form-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 15px;
                }
                .email-form-grid .full-width {
                    grid-column: 1 / -1;
                }
                .form-actions {
                    margin-top: 20px;
                    padding-top: 15px;
                    border-top: 1px solid #dee2e6;
                }

                /* Стили для темной темы */
                [data-theme="dark"] .email-form .form-label,
                [data-theme="dark"] .email-form label {
                    color: #ffffff !important;
                }
                [data-theme="dark"] .email-form .form-text {
                    color: #adb5bd !important;
                }
                [data-theme="dark"] .file-list {
                    color: #adb5bd !important;
                }
                [data-theme="dark"] .email-form {
                    background: #2d3748;
                    border: 1px solid #4a5568;
                }
                [data-theme="dark"] .email-form .form-control {
                    background-color: #4a5568;
                    border-color: #718096;
                    color: #ffffff;
                }
                [data-theme="dark"] .email-form .form-control:focus {
                    background-color: #4a5568;
                    border-color: #63b3ed;
                    color: #ffffff;
                }
                [data-theme="dark"] .file-input-container button {
                    background-color: #4a5568;
                    border-color: #718096;
                    color: #ffffff;
                }
                [data-theme="dark"] .file-input-container button:hover {
                    background-color: #718096;
                    border-color: #a0aec0;
                }
                [data-theme="dark"] .file-input-container {
                    width: 100%;
                }
                [data-theme="dark"] .file-status-container {
                    width: 100%;
                }
                [data-theme="dark"] .file-list {
                    display: block;
                    word-wrap: break-word;
                    word-break: break-word;
                }

                /* Стили для Quill редактора в темной теме */
                [data-theme="dark"] .ql-toolbar {
                    background-color: #4a5568;
                    border-color: #718096;
                }
                [data-theme="dark"] .ql-toolbar button {
                    color: #ffffff;
                }
                [data-theme="dark"] .ql-toolbar button:hover {
                    color: #63b3ed !important;
                }
                [data-theme="dark"] .ql-toolbar .ql-active {
                    color: #63b3ed !important;
                }
                [data-theme="dark"] .ql-container {
                    background-color: #4a5568;
                    border-color: #718096;
                }
                [data-theme="dark"] .ql-editor {
                    color: #ffffff;
                }
                [data-theme="dark"] .ql-editor.ql-blank::before {
                    color: #a0aec0;
                }

                /* Стили для плейсхолдеров в темной теме */
                [data-theme="dark"] .form-control::placeholder {
                    color: #a0aec0 !important;
                }
                [data-theme="dark"] .form-control::-webkit-input-placeholder {
                    color: #a0aec0 !important;
                }
                [data-theme="dark"] .form-control::-moz-placeholder {
                    color: #a0aec0 !important;
                }
                [data-theme="dark"] .form-control:-ms-input-placeholder {
                    color: #a0aec0 !important;
                }

                /* Стили для кастомной кнопки выбора файлов */
                .file-input-container {
                    display: flex;
                    align-items: center;
                    margin-bottom: 8px;
                    width: 100%;
                }
                .file-status-container {
                    margin-bottom: 10px;
                    width: 100%;
                }
                .file-input-container button {
                    padding: 8px 16px;
                    border: 1px solid #ced4da;
                    border-radius: 4px;
                    background-color: #fff;
                    color: #495057;
                    cursor: pointer;
                    transition: all 0.2s;
                    white-space: nowrap;
                }
                .file-input-container button:hover {
                    background-color: #e9ecef;
                    border-color: #adb5bd;
                }
                .file-list {
                    color: #6c757d;
                    font-size: 14px;
                    display: block;
                    word-wrap: break-word;
                    word-break: break-word;
                }
            </style>
            <script>
                // Инициализация Quill.js после полной загрузки DOM
                document.addEventListener('DOMContentLoaded', function() {
                    var quill = new Quill('#quillEditor', {
                    theme: 'snow',
                    modules: {
                        toolbar: {
                            container: [
                                ['bold', 'italic', 'underline'],
                                [{ 'color': [] }, { 'background': [] }],
                                [{ 'align': [] }],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                ['link', 'image'],
                                ['clean']
                            ],
                            handlers: {
                                'link': function() {
                                    var range = quill.getSelection();
                                    if (range) {
                                        var url = prompt('Введите URL:');
                                        if (url) {
                                            quill.format('link', url);
                                        }
                                    }
                                },
                                'image': function() {
                                    var input = document.createElement('input');
                                    input.setAttribute('type', 'file');
                                    input.setAttribute('accept', 'image/*');
                                    input.click();

                                    input.onchange = function() {
                                        var file = input.files[0];
                                        if (file) {
                                            var formData = new FormData();
                                            formData.append('file', file);

                                            fetch('/upload_image', {
                                                method: 'POST',
                                                body: formData
                                            })
                                            .then(response => response.json())
                                            .then(data => {
                                                if (data.location) {
                                                    var range = quill.getSelection();
                                                    quill.insertEmbed(range.index, 'image', data.location);
                                                }
                                            })
                                            .catch(error => console.error('Ошибка загрузки изображения:', error));
                                        }
                                    };
                                }
                            }
                        }
                    },
                    placeholder: 'Введите текст сообщения...'
                });

                // Обработчик вставки изображений
                quill.on('text-change', function() {
                    // Обновляем скрытое поле формы
                    var html = quill.root.innerHTML;
                    var hiddenInput = document.querySelector('#emailMessageField');
                    if (hiddenInput) {
                        hiddenInput.value = html;
                    }
                });

                                // Обработчик вставки изображений из буфера обмена
                quill.clipboard.addMatcher('img', function(node, delta) {
                    var img = node.querySelector('img');
                    if (img && img.src.startsWith('data:')) {
                        // Конвертируем base64 в файл и загружаем
                        fetch(img.src)
                            .then(res => res.blob())
                            .then(blob => {
                                var formData = new FormData();
                                formData.append('file', blob, 'image.png');

                                fetch('/upload_image', {
                                    method: 'POST',
                                    body: formData
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.location) {
                                        // Заменяем base64 на URL
                                        var range = quill.getSelection();
                                        quill.deleteText(range.index, range.length);
                                        quill.insertEmbed(range.index, 'image', data.location);
                                    }
                                })
                                .catch(error => console.error('Ошибка загрузки изображения:', error));
                            });
                    }
                    return delta;
                });

                // Глобальная переменная для доступа к quill
                window.quillEditor = quill;

                // Отладочная информация
                console.log('✅ Quill.js редактор инициализирован');
                console.log('🔧 Доступные кнопки:', document.querySelectorAll('.ql-toolbar button'));

                // Добавляем обработчики для диагностики
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.ql-toolbar')) {
                        console.log('🖱️ Клик по панели инструментов:', e.target.className);
                    }
                });

                // Обработчик выбора файлов
                document.getElementById('fileInput').addEventListener('change', function(e) {
                    var fileList = document.getElementById('fileList');
                    var files = e.target.files;
                    var input = e.target;

                    console.log('🔍 Информация о input:', {
                        multiple: input.multiple,
                        accept: input.accept,
                        filesCount: files.length,
                        inputHTML: input.outerHTML,
                        hasMultiple: input.hasAttribute('multiple')
                    });

                    if (files.length > 0) {
                        var fileNames = Array.from(files).map(file => file.name).join('<br>');
                        fileList.innerHTML = `<strong>Выбрано файлов: ${files.length}</strong><br>${fileNames}`;
                        fileList.style.color = '#28a745';
                        console.log('✅ Выбрано файлов:', files.length);
                        console.log('📁 Имена файлов:', Array.from(files).map(f => f.name));
                    } else {
                        fileList.textContent = 'Файл не выбран';
                        fileList.style.color = '#6c757d';
                    }
                });

                                // Проверяем и устанавливаем multiple атрибут
                setTimeout(function() {
                    var input = document.getElementById('fileInput');
                    if (input) {
                        input.setAttribute('multiple', 'multiple');
                        console.log('🔧 Установлен атрибут multiple для input');
                        console.log('🔍 Проверка input:', {
                            multiple: input.multiple,
                            type: input.type,
                            name: input.name,
                            id: input.id,
                            hasMultiple: input.hasAttribute('multiple'),
                            inputHTML: input.outerHTML
                        });
                    }
                }, 500);

                // Простая защита кнопки от изменения стилей
                var originalButtonStyle = {
                    backgroundColor: '#ff6b35',
                    borderColor: '#ff6b35',
                    color: '#ffffff'
                };

                // Создаем observer для защиты кнопки
                var buttonObserver = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            var button = document.getElementById('fileButton');
                            if (button) {
                                button.style.backgroundColor = originalButtonStyle.backgroundColor;
                                button.style.borderColor = originalButtonStyle.borderColor;
                                button.style.color = originalButtonStyle.color;
                            }
                        }
                    });
                });

                // Запускаем observer через 1 секунду
                setTimeout(function() {
                    var button = document.getElementById('fileButton');
                    if (button) {
                        buttonObserver.observe(button, {
                            attributes: true,
                            attributeFilter: ['style']
                        });
                        console.log('🔧 Observer для защиты кнопки запущен');
                    }
                }, 1000);

                // Тест множественного выбора
                setTimeout(function() {
                    var input = document.getElementById('fileInput');
                    if (input) {
                        console.log('🧪 Тест множественного выбора:');
                        console.log('- multiple атрибут:', input.multiple);
                        console.log('- hasAttribute multiple:', input.hasAttribute('multiple'));
                        console.log('- HTML элемента:', input.outerHTML);

                        // Создаем тестовый input для сравнения
                        var testInput = document.createElement('input');
                        testInput.type = 'file';
                        testInput.multiple = true;
                        console.log('- Тестовый input multiple:', testInput.multiple);
                        console.log('- Тестовый input HTML:', testInput.outerHTML);
                    }
                }, 2000);

                // Простая инициализация
                console.log('✅ Скрипт файлов загружен');

                // Простой тест без интервалов
                console.log('✅ Скрипт файлов загружен - моргание отключено');
            });
            </script>

            <!-- Подключение скрипта для изменения статуса задачи -->
            <script src="{{ url_for('static', filename='js/task_status_change.js') }}"></script>

            <!-- Подключение скрипта для изменения приоритета задачи -->
            <script src="{{ url_for('static', filename='js/task_priority_change.js') }}"></script>

            <!-- Подключение скрипта для изменения исполнителя задачи -->
            <script src="{{ url_for('static', filename='js/task_assignee_change.js') }}"></script>

                        <!-- Восстанавливаем все функции -->
            <script>
                console.log('✅ Все функции восстановлены');
            </script>

            <!-- Стили для предотвращения мерцания -->
            <style>
              /* Отключение проблемных анимаций для timeline элементов */
              .timeline-item,
              .timeline-content,
              .timeline-marker,
              .timeline-header,
              .timeline-user,
              .timeline-date,
              .timeline-changes,
              .timeline-notes,
              .change-item {
                transition: none !important;
                animation: none !important;
                will-change: auto !important;
                backface-visibility: visible !important;
                isolation: auto !important;
                contain: none !important;
                pointer-events: auto !important;
              }

              /* Отключение hover эффектов с сохранением цветов */
              .timeline-item:hover,
              .timeline-marker:hover,
              .timeline-content:hover {
                transform: none !important;
                box-shadow: inherit !important;
                background-color: inherit !important;
                border-color: inherit !important;
                color: inherit !important;
              }

              /* Дополнительная защита для дочерних элементов */
              .timeline-item *,
              .timeline-content *,
              .timeline-marker * {
                transition: none !important;
                animation: none !important;
              }

              .timeline-item *:hover,
              .timeline-content *:hover,
              .timeline-marker *:hover {
                transform: none !important;
                background-color: inherit !important;
                border-color: inherit !important;
                color: inherit !important;
              }

              /* Поддержка prefers-reduced-motion */
              @media (prefers-reduced-motion: reduce) {
                * {
                  transition: none !important;
                  animation: none !important;
                }
              }

              /* Дополнительная защита от мерцания */
              .history-item,
              .history-content,
              .history-header,
              .history-user,
              .history-time,
              .history-changes,
              .change-item,
              .change-description,
              .history-comment,
              .comment-content {
                transition: none !important;
                animation: none !important;
                will-change: auto !important;
                backface-visibility: visible !important;
                isolation: auto !important;
                contain: none !important;
              }

              .history-item:hover,
              .history-content:hover,
              .history-header:hover,
              .history-user:hover,
              .history-time:hover,
              .history-changes:hover,
              .change-item:hover,
              .change-description:hover,
              .history-comment:hover,
              .comment-content:hover {
                transform: none !important;
                box-shadow: inherit !important;
                background-color: inherit !important;
                border-color: inherit !important;
                color: inherit !important;
              }
            </style>

{% endblock %}
