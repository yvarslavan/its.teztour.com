{% extends 'layout.html' %}

{% block main_page %}
<div class="modern-task-detail">
  <!-- Floating Action Button -->
  <div class="fab-container">
    <button class="fab theme-toggle" onclick="toggleTheme()" title="Переключить тему">
      <i class="fas fa-moon" id="theme-icon"></i>
    </button>
  </div>

  <!-- Hero Section -->
  <div class="hero-section">
    <div class="hero-content">
      <div class="breadcrumb">
        <a href="/my-tasks" class="breadcrumb-link">
          <i class="fas fa-tasks"></i>
          <span>Мои задачи</span>
        </a>
        <i class="fas fa-chevron-right breadcrumb-separator"></i>
        <span class="breadcrumb-current">Задача #{{task.id}}</span>
      </div>

      <div class="hero-main">
        <div class="task-status-large">
          {% set status_class = 'status-default' %}
          {% set status_icon = 'fas fa-question-circle' %}
          {% set status_color = '#6c757d' %}
          {% set status_name = status_mapping.get(task.status.id, task.status.name) if task.status else 'Неизвестно' %}

          {% if status_name in ['Новая', 'New', 'Открыта', 'Open'] %}
            {% set status_class = 'status-open' %}
            {% set status_icon = 'fas fa-folder-open' %}
            {% set status_color = '#007bff' %}
          {% elif status_name in ['В работе', 'In Progress', 'На тестировании', 'В очереди'] %}
            {% set status_class = 'status-progress' %}
            {% set status_icon = 'fas fa-clock' %}
            {% set status_color = '#ffc107' %}
          {% elif status_name in ['Закрыта', 'Closed', 'Выполнена', 'Resolved', 'Протестирована'] %}
            {% set status_class = 'status-closed' %}
            {% set status_icon = 'fas fa-check-circle' %}
            {% set status_color = '#28a745' %}
          {% elif status_name in ['Отклонена', 'Rejected', 'Заморожена'] %}
            {% set status_class = 'status-rejected' %}
            {% set status_icon = 'fas fa-times-circle' %}
            {% set status_color = '#dc3545' %}
          {% elif status_name in ['Запрошено уточнение', 'Приостановлена', 'На согласовании'] %}
            {% set status_class = 'status-pending' %}
            {% set status_icon = 'fas fa-pause-circle' %}
            {% set status_color = '#6f42c1' %}
          {% elif status_name in ['Перенаправлена'] %}
            {% set status_class = 'status-registered' %}
            {% set status_icon = 'fas fa-file-check' %}
            {% set status_color = '#17a2b8' %}
          {% endif %}

          <div class="status-indicator {{ status_class }}" style="--status-color: {{ status_color }}">
            <i class="{{ status_icon }}"></i>
          </div>
        </div>

        <div class="hero-text">
          <h1 class="hero-title">{{task.subject}}</h1>
          <p class="hero-subtitle">Задача #{{task.id}} • {{ status_name }}</p>
        </div>
      </div>

      <div class="hero-actions">
        <button class="action-btn primary" onclick="window.print()">
          <i class="fas fa-print"></i>
          <span>Печать</span>
        </button>
        <button class="action-btn secondary" onclick="copyTaskLink()">
          <i class="fas fa-link"></i>
          <span>Копировать ссылку</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="content-grid">

    <!-- Task Details Card -->
    <div class="card main-card">
      <div class="card-header collapsible" onclick="toggleCard('details')">
        <div class="card-title">
          <i class="fas fa-info-circle"></i>
          <h2>Сведения о задаче</h2>
        </div>
        <i class="fas fa-chevron-up toggle-icon" id="details-toggle"></i>
      </div>

      <div class="card-content" id="details-content">
        <div class="details-grid">
          <!-- Primary Info -->
          <div class="detail-section">
            <h3 class="section-title">Основное</h3>
            <div class="detail-items">
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Приоритет</span>
                  <div class="detail-value priority-badge">
                    {% if task.priority and task.priority.name in ['Высокий', 'Срочный', 'Неотложный', 'High', 'Urgent'] %}
                      <span class="badge high">{{ task.priority.name if task.priority else 'Не указан' }}</span>
                    {% else %}
                      <span class="badge normal">{{ task.priority.name if task.priority else 'Обычный' }}</span>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-folder"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Проект</span>
                  <span class="detail-value">{{ task.project.name if task.project else 'Без проекта' }}</span>
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-tags"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Трекер</span>
                  <span class="detail-value">{{ task.tracker.name if task.tracker else 'Не указан' }}</span>
                </div>
              </div>

              {% if task.done_ratio is defined %}
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-percentage"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Прогресс</span>
                  <div class="progress-container">
                    <div class="progress-bar">
                      <div class="progress-fill" style="width: {{task.done_ratio}}%"></div>
                    </div>
                    <span class="progress-text">{{task.done_ratio}}%</span>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- People -->
          <div class="detail-section">
            <h3 class="section-title">Участники</h3>
            <div class="detail-items">
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-user-edit"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Автор</span>
                  {% if task.author %}
                    <div class="user-avatar">
                      <div class="avatar-circle">{{ task.author.name[0] if task.author.name else 'U' }}</div>
                      <span class="user-name">{{ task.author.name }}</span>
                    </div>
                  {% else %}
                    <span class="detail-value no-data">Нет данных</span>
                  {% endif %}
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-user-cog"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Исполнитель</span>
                  {% if task.assigned_to %}
                    <div class="user-avatar">
                      <div class="avatar-circle assigned">{{ task.assigned_to.name[0] if task.assigned_to.name else 'U' }}</div>
                      <span class="user-name">{{ task.assigned_to.name }}</span>
                    </div>
                  {% else %}
                    <span class="detail-value no-data">Не назначен</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <!-- Timeline -->
          <div class="detail-section">
            <h3 class="section-title">Временная шкала</h3>
            <div class="timeline-items">
              <div class="timeline-item">
                <div class="timeline-dot created"></div>
                <div class="timeline-content">
                  <span class="timeline-label">Создана</span>
                  <div class="timeline-date">
                    <span class="date-main">{{task.created_on.strftime('%d %B %Y')}}</span>
                    <span class="date-time">{{task.created_on.strftime('%H:%M')}}</span>
                  </div>
                </div>
              </div>

              {% if task.start_date %}
              <div class="timeline-item">
                <div class="timeline-dot started"></div>
                <div class="timeline-content">
                  <span class="timeline-label">Начало</span>
                  <div class="timeline-date">
                    <span class="date-main">{{ task.start_date.strftime('%d %B %Y') }}</span>
                  </div>
                </div>
              </div>
              {% endif %}

              {% if task.due_date %}
              <div class="timeline-item">
                <div class="timeline-dot deadline"></div>
                <div class="timeline-content">
                  <span class="timeline-label">Крайний срок</span>
                  <div class="timeline-date">
                    <span class="date-main">{{ task.due_date.strftime('%d %B %Y') }}</span>
                  </div>
                </div>
              </div>
              {% endif %}

              <div class="timeline-item">
                <div class="timeline-dot updated"></div>
                <div class="timeline-content">
                  <span class="timeline-label">Обновлена</span>
                  <div class="timeline-date">
                    <span class="date-main">{{task.updated_on.strftime('%d %B %Y')}}</span>
                    <span class="date-time">{{task.updated_on.strftime('%H:%M')}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Description Card -->
    {% if task.description %}
    <div class="card">
      <div class="card-header collapsible" onclick="toggleCard('description')">
        <div class="card-title">
          <i class="fas fa-align-left"></i>
          <h2>Описание</h2>
        </div>
        <i class="fas fa-chevron-up toggle-icon" id="description-toggle"></i>
      </div>
      <div class="card-content" id="description-content">
        <div class="description-content">
          {{ task.description|safe }}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Attachments Card -->
    {% if task.attachments %}
    <div class="card">
      <div class="card-header collapsible" onclick="toggleCard('attachments')">
        <div class="card-title">
          <i class="fas fa-paperclip"></i>
          <h2>Прикрепленные файлы</h2>
          <span class="count-badge">{{ task.attachments|length }}</span>
        </div>
        <i class="fas fa-chevron-up toggle-icon" id="attachments-toggle"></i>
      </div>
      <div class="card-content" id="attachments-content">
        <div class="attachments-grid">
          {% for attachment in task.attachments %}
          <div class="attachment-item">
            <div class="attachment-icon">
              {% set file_ext = attachment.filename.split('.')[-1].lower() if '.' in attachment.filename else '' %}
              {% if file_ext in ['jpg', 'jpeg', 'png', 'gif'] %}
                <i class="fas fa-image"></i>
              {% elif file_ext in ['pdf'] %}
                <i class="fas fa-file-pdf"></i>
              {% elif file_ext in ['doc', 'docx'] %}
                <i class="fas fa-file-word"></i>
              {% elif file_ext in ['xls', 'xlsx'] %}
                <i class="fas fa-file-excel"></i>
              {% else %}
                <i class="fas fa-file"></i>
              {% endif %}
            </div>
            <div class="attachment-info">
              <span class="attachment-name">{{ attachment.filename }}</span>
              <span class="attachment-size">{{ (attachment.filesize / 1024)|round(1) }} KB</span>
            </div>
            <button class="attachment-download" onclick="downloadAttachment('{{ attachment.id }}')">
              <i class="fas fa-download"></i>
            </button>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- History Card -->
    {% if task.journals %}
    <div class="card history-card">
      <div class="card-header collapsible" onclick="toggleCard('history')">
        <div class="card-title">
          <i class="fas fa-history"></i>
          <h2>История изменений</h2>
          <span class="count-badge">{{ task.journals|length }}</span>
        </div>
        <div class="header-actions">
          <button class="filter-btn" onclick="event.stopPropagation(); toggleHistoryFilters()">
            <i class="fas fa-filter"></i>
            <span>Фильтры</span>
          </button>
          <i class="fas fa-chevron-up toggle-icon" id="history-toggle"></i>
        </div>
      </div>

      <div class="history-filters" id="historyFilters" style="display: none;">
        <div class="filter-chips">
          <button class="filter-chip active" data-filter="all">Все</button>
          <button class="filter-chip" data-filter="comments">Комментарии</button>
          <button class="filter-chip" data-filter="changes">Изменения</button>
          <button class="filter-chip" data-filter="status">Статус</button>
        </div>
      </div>

      <div class="card-content" id="history-content">
        <div class="history-timeline">
          {% for journal in task.journals|reverse %}
          <div class="history-item" data-type="{% if journal.notes %}comments{% else %}changes{% endif %}">
            <div class="history-avatar">
              <div class="avatar-circle history">
                {{ journal.user.name[0] if journal.user and journal.user.name else 'U' }}
              </div>
            </div>

            <div class="history-content">
              <div class="history-header">
                <div class="history-user">
                  <span class="user-name">{{ journal.user.name if journal.user else 'Система' }}</span>
                  <span class="history-time">{{ convert_datetime_msk_format(journal.created_on) }}</span>
                </div>
              </div>

              {% if journal.details %}
              <div class="history-changes">
                {% for detail in journal.details %}
                {% set old_value = detail.old_value %}
                {% set new_value = detail.new_value %}
                {% set property_name_html = get_property_name(detail.property if detail.property else 'attr', detail.name, old_value, new_value) %}
                {% if property_name_html %}
                  <div class="change-item">
                    <div class="change-description">
                      <i class="fas fa-arrow-right change-icon"></i>
                      <span>{{ property_name_html | safe }}</span>
                    </div>
                  </div>
                {% else %}
                  <div class="change-item">
                    <div class="change-field">
                      <i class="fas fa-edit change-icon"></i>
                      <span class="field-name">
                        {% if detail.name == 'status_id' %}
                          Статус
                        {% elif detail.name == 'done_ratio' %}
                          Готовность
                        {% elif detail.name == 'assigned_to_id' %}
                          Исполнитель
                        {% elif detail.name == 'priority_id' %}
                          Приоритет
                        {% elif detail.name == 'project_id' %}
                          Проект
                        {% elif detail.name == 'subject' %}
                          Тема
                        {% elif detail.name == 'easy_helpdesk_need_reaction' %}
                          Нужна реакция?
                        {% elif detail.name == '16' %}
                          Что нового
                        {% else %}
                          {{ detail.name }}
                        {% endif %}
                      </span>
                    </div>
                    <div class="change-values">
                      {% if detail.old_value %}
                      <span class="old-value">
                        {% if detail.name == 'status_id' %}
                          {{ get_status_name_from_id(get_connection(db_redmine_host, db_redmine_user_name, db_redmine_password, db_redmine_name), detail.old_value) or detail.old_value }}
                        {% elif detail.name == 'assigned_to_id' %}
                          {{ get_user_full_name_from_id(get_connection(db_redmine_host, db_redmine_user_name, db_redmine_password, db_redmine_name), detail.old_value) or detail.old_value }}
                        {% elif detail.name == 'project_id' %}
                          {{ get_project_name_from_id(get_connection(db_redmine_host, db_redmine_user_name, db_redmine_password, db_redmine_name), detail.old_value) or detail.old_value }}
                        {% elif detail.name == 'priority_id' %}
                          {{ get_priority_name_from_id(get_connection(db_redmine_host, db_redmine_user_name, db_redmine_password, db_redmine_name), detail.old_value) or detail.old_value }}
                        {% elif detail.name == 'done_ratio' %}
                          {{ detail.old_value }}%
                                              {% elif detail.name == 'easy_helpdesk_need_reaction' %}
                        {% if detail.old_value == '1' %}Да{% else %}Нет{% endif %}
                      {% elif detail.name == '16' %}
                        {% if detail.old_value and detail.old_value != '0' %}Да{% else %}Нет{% endif %}
                      {% else %}
                        {{ detail.old_value }}
                      {% endif %}
                      </span>
                      <i class="fas fa-arrow-right change-arrow"></i>
                      {% endif %}
                      <span class="new-value">
                        {% if detail.name == 'status_id' %}
                          {{ get_status_name_safe(detail.new_value) }}
                        {% elif detail.name == 'assigned_to_id' %}
                          {% if detail.new_value %}
                            {{ get_user_name_safe(detail.new_value) }}
                          {% else %}
                            Не назначен
                          {% endif %}
                        {% elif detail.name == 'project_id' %}
                          {{ get_project_name_safe(detail.new_value) }}
                        {% elif detail.name == 'priority_id' %}
                          {{ get_priority_name_safe(detail.new_value) }}
                        {% elif detail.name == 'done_ratio' %}
                          {{ detail.new_value }}%
                        {% elif detail.name == 'easy_helpdesk_need_reaction' %}
                          {{ format_boolean_field(detail.new_value, detail.name) }}
                        {% elif detail.name == '16' %}
                          {{ format_boolean_field(detail.new_value, detail.name) }}
                        {% else %}
                          {% if detail.new_value %}
                            {{ detail.new_value }}
                          {% else %}
                            Значение удалено
                          {% endif %}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                {% endif %}
                {% endfor %}
              </div>
              {% endif %}

              {% if journal.notes %}
              <div class="history-comment">
                <div class="comment-content">
                  {{ journal.notes|safe }}
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<style>
:root {
  --primary-color: #6366f1;
  --secondary-color: #8b5cf6;
  --accent-color: #06d6a0;
  --success-color: #10b981;
  --warning-color: #f59e0b;
  --error-color: #ef4444;
  --text-primary: #1f2937;
  --text-secondary: #6b7280;
  --text-muted: #9ca3af;
  --bg-primary: #ffffff;
  --bg-secondary: #f9fafb;
  --bg-tertiary: #f3f4f6;
  --border-color: #e5e7eb;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  --border-radius: 12px;
  --border-radius-lg: 16px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

[data-theme="dark"] {
  --text-primary: #f9fafb;
  --text-secondary: #d1d5db;
  --text-muted: #d1d5db;
  --bg-primary: #111827;
  --bg-secondary: #1f2937;
  --bg-tertiary: #374151;
  --border-color: #4b5563;
  --success-color: #22c55e;
  --error-color: #f87171;
  --warning-color: #fbbf24;
  --primary-color: #818cf8;
  --secondary-color: #a78bfa;
}

.modern-task-detail {
  min-height: 100vh;
  background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  color: var(--text-primary);
  transition: var(--transition);
}

/* FAB */
.fab-container {
  position: fixed;
  bottom: 2rem;
  right: 2rem;
  z-index: 1000;
}

.fab {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  border: none;
  cursor: pointer;
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  transition: var(--transition);
}

.fab:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-xl);
}

/* Hero Section */
.hero-section {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  padding: 3rem 2rem;
  margin-bottom: 2rem;
}

.hero-content {
  max-width: 1200px;
  margin: 0 auto;
}

.breadcrumb {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 2rem;
  font-size: 0.875rem;
  opacity: 0.9;
}

.breadcrumb-link {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: white;
  text-decoration: none;
  transition: var(--transition);
}

.breadcrumb-link:hover {
  opacity: 0.8;
}

.breadcrumb-separator {
  opacity: 0.6;
}

.hero-main {
  display: flex;
  align-items: center;
  gap: 2rem;
  margin-bottom: 2rem;
}

.task-status-large {
  flex-shrink: 0;
}

.status-indicator {
  width: 4rem;
  height: 4rem;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: var(--status-color);
  border: 2px solid rgba(255, 255, 255, 0.3);
}

.status-indicator.status-pending {
  animation: pulse 2s infinite;
}

.status-indicator.status-registered {
  animation: bounce 1s ease-in-out;
}

.hero-title {
  font-size: 2.5rem;
  font-weight: 700;
  line-height: 1.2;
  margin: 0 0 0.5rem 0;
}

.hero-subtitle {
  font-size: 1.125rem;
  opacity: 0.9;
  margin: 0;
}

.hero-actions {
  display: flex;
  gap: 1rem;
  align-items: center;
  justify-content: center;
}

.action-btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border-radius: var(--border-radius);
  border: none;
  cursor: pointer;
  font-weight: 500;
  transition: var(--transition);
  text-decoration: none;
  white-space: nowrap;
  min-width: 140px;
  justify-content: center;
}

.action-btn.primary {
  background: rgba(255, 255, 255, 0.2);
  color: white;
  backdrop-filter: blur(10px);
}

.action-btn.secondary {
  background: transparent;
  color: white;
  border: 2px solid rgba(255, 255, 255, 0.3);
}

.action-btn:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.action-btn.primary:hover {
  background: rgba(255, 255, 255, 0.3);
}

.action-btn.secondary:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.5);
}

/* Content Grid */
.content-grid {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 2rem 3rem;
  display: grid;
  gap: 2rem;
}

/* Cards */
.card {
  background: var(--bg-primary);
  border-radius: var(--border-radius-lg);
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-color);
  transition: var(--transition);
  overflow: hidden;
}

.card:hover {
  box-shadow: var(--shadow-lg);
  transform: translateY(-2px);
}

.card-header {
  padding: 1.5rem 2rem;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-header.collapsible {
  cursor: pointer;
  transition: var(--transition);
}

.card-header.collapsible:hover {
  background: var(--bg-secondary);
}

.card-title {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--text-primary);
  flex: 1;
}

.card-title i {
  color: var(--primary-color);
}

.count-badge {
  background: var(--primary-color);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 50px;
  font-size: 0.75rem;
  font-weight: 600;
}

.toggle-icon {
  color: var(--text-secondary);
  transition: transform 0.3s ease;
  font-size: 1rem;
  margin-left: 1rem;
}

.toggle-icon.rotated {
  transform: rotate(180deg);
}

.card-content {
  padding: 2rem;
  transition: all 0.3s ease;
  overflow: hidden;
}

.card-content.collapsed {
  max-height: 0;
  padding: 0 2rem;
  opacity: 0;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 1rem;
}

/* Details Grid */
.details-grid {
  display: grid;
  gap: 3rem;
}

.detail-section {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.section-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
  padding-bottom: 0.75rem;
  border-bottom: 2px solid var(--primary-color);
  display: inline-block;
}

.detail-items {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.detail-item {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  padding: 1rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  transition: var(--transition);
}

.detail-item:hover {
  background: var(--bg-tertiary);
  transform: translateX(4px);
}

.detail-icon {
  width: 2.5rem;
  height: 2.5rem;
  background: var(--primary-color);
  color: white;
  border-radius: var(--border-radius);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.detail-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.detail-label {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.detail-value {
  font-size: 1rem;
  color: var(--text-primary);
  font-weight: 500;
}

/* Badges */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 0.5rem 1rem;
  border-radius: 50px;
  font-size: 0.875rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.badge.high {
  background: rgba(239, 68, 68, 0.1);
  color: var(--error-color);
  border: 1px solid rgba(239, 68, 68, 0.2);
}

.badge.normal {
  background: rgba(99, 102, 241, 0.1);
  color: var(--primary-color);
  border: 1px solid rgba(99, 102, 241, 0.2);
}

/* Progress Bar */
.progress-container {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.progress-bar {
  flex: 1;
  height: 8px;
  background: var(--bg-tertiary);
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
  border-radius: 4px;
  transition: width 0.5s ease;
}

.progress-text {
  font-weight: 600;
  color: var(--primary-color);
  font-size: 0.875rem;
}

/* User Avatars */
.user-avatar {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.avatar-circle {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 1rem;
  flex-shrink: 0;
  text-transform: uppercase;
}

.avatar-circle.assigned {
  background: var(--accent-color);
}

.avatar-circle.history {
  width: 2rem;
  height: 2rem;
  font-size: 0.75rem;
  background: var(--secondary-color);
}

.user-name {
  font-weight: 500;
  color: var(--text-primary);
}

/* Timeline */
.timeline-items {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.timeline-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border-left: 4px solid var(--primary-color);
  transition: var(--transition);
}

.timeline-item:hover {
  background: var(--bg-tertiary);
  transform: translateX(4px);
}

.timeline-dot {
  width: 1rem;
  height: 1rem;
  border-radius: 50%;
  flex-shrink: 0;
}

.timeline-dot.created { background: var(--primary-color); }
.timeline-dot.started { background: var(--accent-color); }
.timeline-dot.deadline { background: var(--warning-color); }
.timeline-dot.updated { background: var(--text-muted); }

.timeline-content {
  flex: 1;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.timeline-label {
  font-weight: 500;
  color: var(--text-primary);
}

.timeline-date {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 0.25rem;
}

.date-main {
  font-weight: 600;
  color: var(--text-primary);
}

.date-time {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

/* Description */
.description-content {
  line-height: 1.7;
  color: var(--text-primary);
}

/* Attachments */
.attachments-grid {
  display: grid;
  gap: 1rem;
}

.attachment-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  transition: var(--transition);
}

.attachment-item:hover {
  background: var(--bg-tertiary);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.attachment-icon {
  width: 2.5rem;
  height: 2.5rem;
  background: var(--primary-color);
  color: white;
  border-radius: var(--border-radius);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.125rem;
}

.attachment-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.attachment-name {
  font-weight: 500;
  color: var(--text-primary);
}

.attachment-size {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.attachment-download {
  width: 2.5rem;
  height: 2.5rem;
  border: none;
  background: var(--accent-color);
  color: white;
  border-radius: var(--border-radius);
  cursor: pointer;
  transition: var(--transition);
}

.attachment-download:hover {
  transform: scale(1.1);
}

/* History */
.filter-btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  cursor: pointer;
  color: var(--text-primary);
  transition: var(--transition);
}

.filter-btn:hover {
  background: var(--bg-tertiary);
}

.history-filters {
  padding: 1rem 2rem;
  border-bottom: 1px solid var(--border-color);
  background: var(--bg-secondary);
}

.filter-chips {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.filter-chip {
  padding: 0.5rem 1rem;
  border: 1px solid var(--border-color);
  background: var(--bg-primary);
  color: var(--text-secondary);
  border-radius: 50px;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.875rem;
}

.filter-chip.active,
.filter-chip:hover {
  background: var(--primary-color);
  color: white;
  border-color: var(--primary-color);
}

.history-timeline {
  display: flex;
  flex-direction: column;
  gap: 2rem;
}

.history-item {
  display: flex;
  gap: 1rem;
  padding: 1.5rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  transition: var(--transition);
}

.history-item:hover {
  background: var(--bg-tertiary);
  box-shadow: var(--shadow-md);
}

.history-avatar {
  flex-shrink: 0;
}

.history-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.history-user {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.history-time {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.history-changes {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.change-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem;
  background: var(--bg-primary);
  border-radius: var(--border-radius);
  border-left: 3px solid var(--warning-color);
}

.change-field {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  min-width: 8rem;
}

.change-icon {
  color: var(--warning-color);
}

.field-name {
  font-weight: 500;
  color: var(--text-primary);
}

.change-values {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex: 1;
}

.old-value {
  color: var(--error-color);
  text-decoration: line-through;
}

.new-value {
  color: var(--success-color);
  font-weight: 500;
}



[data-theme="dark"] .change-item {
  background: #2d3748 !important;
  border-left-color: #fbbf24 !important;
}

[data-theme="dark"] .history-item {
  background: #1a202c !important;
  border: 1px solid #4a5568 !important;
}

/* Стили для всех span в элементах истории в темной теме */
[data-theme="dark"] .history-item span,
[data-theme="dark"] .change-item span {
  color: #ffffff !important;
}



.change-arrow {
  color: var(--text-muted);
  font-size: 0.75rem;
}

.change-description {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.95rem;
  line-height: 1.5;
  padding: 0.5rem 0;
}

.change-description .change-icon {
  color: var(--primary-color);
  font-size: 0.85rem;
  flex-shrink: 0;
}

.change-description b {
  font-weight: 600;
  color: var(--text-primary);
}

.history-comment {
  padding: 1rem;
  background: var(--bg-primary);
  border-radius: var(--border-radius);
  border-left: 3px solid var(--primary-color);
}

.comment-content {
  line-height: 1.6;
  color: var(--text-primary);
}

/* Responsive */
@media (max-width: 768px) {
  .hero-section {
    padding: 2rem 1rem;
  }

  .hero-main {
    flex-direction: column;
    text-align: center;
    gap: 1rem;
  }

  .hero-title {
    font-size: 2rem;
  }

  .hero-actions {
    justify-content: center;
    flex-direction: column;
    width: 100%;
  }

  .action-btn {
    width: 100%;
    max-width: 280px;
  }

  .content-grid {
    padding: 0 1rem 2rem;
  }

  .card-content {
    padding: 1.5rem;
  }

  .details-grid {
    gap: 2rem;
  }

  .detail-item {
    flex-direction: column;
    gap: 0.75rem;
    text-align: center;
  }

  .timeline-item {
    flex-direction: column;
    gap: 0.75rem;
    text-align: center;
  }

  .history-item {
    padding: 1rem;
  }

  .filter-chips {
    justify-content: center;
  }
}

/* Animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.8;
    transform: scale(1.05);
  }
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-5px);
  }
  60% {
    transform: translateY(-3px);
  }
}

.card {
  animation: fadeInUp 0.5s ease-out;
}

.card:nth-child(1) { animation-delay: 0.1s; }
.card:nth-child(2) { animation-delay: 0.2s; }
.card:nth-child(3) { animation-delay: 0.3s; }
.card:nth-child(4) { animation-delay: 0.4s; }

/* Print Styles */
@media print {
  .fab-container,
  .hero-actions,
  .filter-btn,
  .history-filters {
    display: none !important;
  }

  .hero-section {
    background: none !important;
    color: black !important;
  }

  .card {
    box-shadow: none !important;
    border: 1px solid #ccc !important;
    margin-bottom: 1rem !important;
  }
}
</style>

<script>
// Функция применения стилей для темной темы
function applyDarkThemeStyles() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

  if (!isDark) return;

  const allSpans = document.querySelectorAll('span');

  allSpans.forEach(span => {
    const text = span.textContent.trim();

    // Сброс стилей
    span.style.color = '';
    span.style.backgroundColor = '';
    span.style.padding = '';
    span.style.border = '';
    span.style.borderRadius = '';
    span.style.fontWeight = '';

    // Стили для текста с "изменился" - только в описании изменений
    if (span.closest('.change-description') && (text.includes('изменился') || text.includes('Параметр'))) {
      span.style.color = '#fbbf24';
      span.style.fontWeight = 'bold';
      span.style.backgroundColor = 'rgba(251, 191, 36, 0.2)';
      span.style.padding = '2px 4px';
      span.style.borderRadius = '4px';
    }

    // Стили для значений - только по CSS классам (НЕ для имён пользователей)
    else if ((!span.classList.contains('user-name')) &&
             (span.classList.contains('old-value') || span.classList.contains('new-value'))) {
      span.style.color = '#51cf66';
      span.style.fontWeight = '600';
      span.style.backgroundColor = 'rgba(81, 207, 102, 0.2)';
      span.style.padding = '2px 6px';
      span.style.borderRadius = '4px';
      span.style.border = '1px solid #51cf66';
    }

    // Общие стили для span в истории (исключая пользователей)
    else if ((span.closest('.history-item') || span.closest('.change-item')) &&
             !span.classList.contains('user-name') &&
             !span.closest('.history-user')) {
      span.style.color = '#ffffff';
    }
  });
}

// Theme Toggle
function toggleTheme() {
  const html = document.documentElement;
  const themeIcon = document.getElementById('theme-icon');

  if (html.getAttribute('data-theme') === 'dark') {
    html.removeAttribute('data-theme');
    themeIcon.className = 'fas fa-moon';
    localStorage.setItem('theme', 'light');
  } else {
    html.setAttribute('data-theme', 'dark');
    themeIcon.className = 'fas fa-sun';
    localStorage.setItem('theme', 'dark');
  }

  // Применяем стили после смены темы
  setTimeout(applyDarkThemeStyles, 100);
}

// Initialize theme
document.addEventListener('DOMContentLoaded', function() {
  const savedTheme = localStorage.getItem('theme');
  const themeIcon = document.getElementById('theme-icon');

  if (savedTheme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    themeIcon.className = 'fas fa-sun';
    // Применяем стили для темной темы
    setTimeout(applyDarkThemeStyles, 500);
  }

    // Применяем стили для темной темы при загрузке
  setTimeout(applyDarkThemeStyles, 500);
});

// Copy Task Link
function copyTaskLink() {
  const url = window.location.href;
  navigator.clipboard.writeText(url).then(() => {
    showNotification('Ссылка скопирована в буфер обмена!', 'success');
  });
}

// Show Notification
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check' : 'info'}-circle"></i>
    <span>${message}</span>
  `;

  Object.assign(notification.style, {
    position: 'fixed',
    top: '2rem',
    right: '2rem',
    background: type === 'success' ? 'var(--success-color)' : 'var(--primary-color)',
    color: 'white',
    padding: '1rem 1.5rem',
    borderRadius: 'var(--border-radius)',
    boxShadow: 'var(--shadow-lg)',
    zIndex: '1001',
    display: 'flex',
    alignItems: 'center',
    gap: '0.5rem',
    animation: 'slideInRight 0.3s ease-out'
  });

  document.body.appendChild(notification);

  setTimeout(() => {
    notification.style.animation = 'slideOutRight 0.3s ease-out';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// History Filters
function toggleHistoryFilters() {
  const filters = document.getElementById('historyFilters');
  filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

// Toggle Card Sections
function toggleCard(cardId) {
  const content = document.getElementById(cardId + '-content');
  const toggle = document.getElementById(cardId + '-toggle');

  if (content.classList.contains('collapsed')) {
    content.classList.remove('collapsed');
    toggle.classList.remove('rotated');
  } else {
    content.classList.add('collapsed');
    toggle.classList.add('rotated');
  }
}

// Filter chips
document.addEventListener('DOMContentLoaded', function() {
  const filterChips = document.querySelectorAll('.filter-chip');
  const historyItems = document.querySelectorAll('.history-item');

  filterChips.forEach(chip => {
    chip.addEventListener('click', function() {
      // Remove active class from all chips
      filterChips.forEach(c => c.classList.remove('active'));
      // Add active class to clicked chip
      this.classList.add('active');

      const filter = this.getAttribute('data-filter');

      historyItems.forEach(item => {
        if (filter === 'all') {
          item.style.display = 'flex';
        } else if (filter === 'status') {
          // Показываем только элементы с изменениями статуса
          const itemType = item.getAttribute('data-type');
          if (itemType === 'changes') {
            // Проверяем, есть ли изменения статуса в этом элементе
            // Вариант 1: через класс .field-name (стандартная структура)
            const hasStatusFieldName = item.querySelector('.field-name') &&
                                       item.querySelector('.field-name').textContent.trim() === 'Статус';

            // Вариант 2: через содержимое текста (функция get_property_name)
            const changeDescriptions = item.querySelectorAll('.change-description span');
            let hasStatusInDescription = false;
            changeDescriptions.forEach(span => {
              if (span.textContent.includes('Параметр') && span.textContent.includes('Статус') && span.textContent.includes('изменился')) {
                hasStatusInDescription = true;
              }
            });

            item.style.display = (hasStatusFieldName || hasStatusInDescription) ? 'flex' : 'none';
          } else {
            item.style.display = 'none';
          }
        } else {
          const itemType = item.getAttribute('data-type');
          item.style.display = itemType === filter ? 'flex' : 'none';
        }
      });
    });
  });
});

// Smooth scrolling for internal links
document.addEventListener('DOMContentLoaded', function() {
  const links = document.querySelectorAll('a[href^="#"]');
  links.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({ behavior: 'smooth' });
      }
    });
  });
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(style);

// Attachment download (placeholder function)
function downloadAttachment(attachmentId) {
  showNotification('Функция загрузки файлов пока не реализована', 'info');
}
</script>
{% endblock %}
