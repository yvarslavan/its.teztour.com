{% extends 'layout.html' %}

{% block styles %}
{{ super() }}
<link rel="stylesheet" href="{{ url_for('static', filename='css/task_detail_controls.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/task_detail_layout.css') }}">
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', filename='css/task_detail_editor.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/task_detail_page_overrides.css') }}">
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script src="{{ url_for('static', filename='js/task_detail_page.js') }}"></script>
<script src="{{ url_for('static', filename='js/task_detail_editor.js') }}"></script>
<script src="{{ url_for('static', filename='js/task_detail_legacy.js') }}"></script>
{% endblock %}

{% block main_page %}

<!-- CSS для функционала изменения статуса -->


<div class="modern-task-detail compact-mode">
  <!-- Compact Mode Toggle Button -->
  <button class="compact-mode-toggle" id="compactModeToggle" title="Переключить компактный режим">
    <i class="fas fa-compress-alt"></i>
  </button>

  <!-- Floating Action Button -->
  <!-- Hero Section -->
  <div class="hero-section">
    <div class="hero-content">
      <div class="breadcrumb">
       <a href="/tasks/my-tasks" class="breadcrumb-link">
          <i class="fas fa-tasks"></i>
          <span>Мои задачи</span>
       </a>
        <i class="fas fa-chevron-right breadcrumb-separator"></i>
        <span class="breadcrumb-current">Задача #{{task.id}}</span>
       <button class="hero-action-btn back-btn" id="go-back-btn" data-task-id="{{ task.id }}">
          <i class="fas fa-arrow-left"></i>
          <span>Назад к списку</span>
        </button>
      </div>

      <div class="hero-main">
        <div class="task-status-large">
          {% set status_class = 'status-default' %}
          {% set status_icon = 'fas fa-question-circle' %}
          {% set status_color = '#6c757d' %}
          {% set status_name = status_mapping.get(task.status.id, task.status.name) if task.status else 'Неизвестно' %}

          {% if status_name in ['Новая', 'New', 'Открыта', 'Open'] %}
            {% set status_class = 'status-open' %}
            {% set status_icon = 'fas fa-folder-open' %}
            {% set status_color = '#007bff' %}
          {% elif status_name in ['В работе', 'In Progress', 'На тестировании', 'В очереди'] %}
            {% set status_class = 'status-progress' %}
            {% set status_icon = 'fas fa-clock' %}
            {% set status_color = '#ffc107' %}
          {% elif status_name in ['Закрыта', 'Closed', 'Выполнена', 'Resolved', 'Протестирована'] %}
            {% set status_class = 'status-closed' %}
            {% set status_icon = 'fas fa-check-circle' %}
            {% set status_color = '#28a745' %}
          {% elif status_name in ['Отклонена', 'Rejected', 'Заморожена'] %}
            {% set status_class = 'status-rejected' %}
            {% set status_icon = 'fas fa-times-circle' %}
            {% set status_color = '#dc3545' %}
          {% elif status_name in ['Запрошено уточнение', 'Приостановлена', 'На согласовании'] %}
            {% set status_class = 'status-pending' %}
            {% set status_icon = 'fas fa-pause-circle' %}
            {% set status_color = '#6f42c1' %}
          {% elif status_name in ['Перенаправлена'] %}
            {% set status_class = 'status-registered' %}
            {% set status_icon = 'fas fa-file-check' %}
            {% set status_color = '#17a2b8' %}
          {% endif %}

          <div class="status-indicator {{ status_class }}" style="--status-color: {{ status_color }}">
            <i class="{{ status_icon }}"></i>
          </div>
        </div>

        <div class="hero-text">
          <h1 class="hero-title">{{task.subject}}</h1>
          <p class="hero-subtitle">Задача #{{task.id}} • {{ status_name }}</p>
        </div>
      </div>

      <div class="hero-actions">
        <button class="hero-action-btn primary" onclick="window.print()">
          <i class="fas fa-print"></i>
          <span>Печать</span>
        </button>
        <button class="hero-action-btn secondary" onclick="copyTaskLink()">
          <i class="fas fa-link"></i>
          <span>Копировать ссылку</span>
        </button>
        <a href="https://helpdesk.teztour.com/issues/{{ task.id }}" class="hero-action-btn secondary" target="_blank" rel="noopener noreferrer">
          <i class="fas fa-external-link-alt"></i>
          <span>Открыть в Redmine</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="content-grid">

    <!-- Task Details Card -->
    <div class="card main-card">
      <div class="card-header collapsible" onclick="toggleCard('details')">
        <div class="card-title">
          <i class="fas fa-info-circle"></i>
          <h2>Сведения о задаче</h2>
        </div>
        <i class="fas fa-chevron-up toggle-icon" id="details-toggle"></i>
      </div>

      <div class="card-content" id="details-content">
        <div class="details-grid">
          <!-- Primary Info -->
          <div class="detail-section">
            <h3 class="section-title">Основное</h3>
            <div class="detail-items">
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Приоритет</span>
                  <div class="detail-value priority-badge">
                    {% if task.priority and task.priority.id %}
                      {% set pos = task.priority.position if task.priority.position is defined else None %}
                      {% if pos is not none and (pos|int) >= 7 %}
                        <span class="badge high">{{ task.priority.name }}</span>
                      {% elif pos is not none and (pos|int) <= 3 %}
                        <span class="badge low">{{ task.priority.name }}</span>
                      {% else %}
                        <span class="badge normal">{{ task.priority.name }}</span>
                      {% endif %}
                    {% else %}
                      <span class="badge">{{ task.priority.name if task.priority else 'Не указан' }}</span>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-folder"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Проект</span>
                  <span class="detail-value">{{ task.project.name if task.project else 'Без проекта' }}</span>
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-tags"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Трекер</span>
                  <span class="detail-value">{{ task.tracker.name if task.tracker else 'Не указан' }}</span>
                </div>
              </div>

              {% if task.done_ratio is defined %}
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-percentage"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Прогресс</span>
                  <div class="progress-container">
                    <div class="progress-bar">
                      <div class="progress-fill" id="progress-fill" data-done-ratio="{{ task.done_ratio or 0 }}"></div>
                    </div>
                    <span class="progress-text">{{task.done_ratio}}%</span>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Status and Priority Management Section -->
          <div class="detail-section">
            <h3 class="section-title">
              <i class="fas fa-sync-alt"></i>
              Управление статусом и приоритетом
            </h3>
            <div class="detail-items">
              <div class="detail-item status-management">
                <div class="detail-icon">
                  <i class="fas fa-flag"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Статус задачи</span>
                  <div id="task-status-container">
                    <!-- Здесь будет вставлен функционал изменения статуса через JavaScript -->
                    <div class="loading-placeholder">
                      <i class="fas fa-spinner fa-spin"></i>
                      <span>Загрузка...</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="detail-item priority-management">
                <div class="detail-icon">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Приоритет задачи</span>
                  <div id="task-priority-container">
                    <!-- Здесь будет вставлен функционал изменения приоритета через JavaScript -->
                    <div class="loading-placeholder">
                      <i class="fas fa-spinner fa-spin"></i>
                      <span>Загрузка...</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- People -->
          <div class="detail-section">
            <h3 class="section-title">Участники</h3>
            <div class="detail-items">
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-user-edit"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Автор</span>
                  {% if task.author %}
                    <div class="user-avatar">
                      <div class="avatar-circle">{{ task.author.name[0] if task.author.name else 'U' }}</div>
                      <span class="user-name">{{ task.author.name }}</span>
                    </div>
                  {% else %}
                    <span class="detail-value no-data">Нет данных</span>
                  {% endif %}
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-user-cog"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Исполнитель</span>
                  <div id="task-assignee-container">
                    <!-- Здесь будет вставлен функционал изменения исполнителя через JavaScript -->
                    <div class="loading-placeholder">
                      <i class="fas fa-spinner fa-spin"></i>
                      <span>Загрузка...</span>
                    </div>
                  </div>
                </div>
              </div>

              {% if task.easy_email_to %}
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-envelope"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Email to</span>
                  <a href="mailto:{{ task.easy_email_to }}" class="email-link">{{ task.easy_email_to }}</a>
                </div>
              </div>
              {% endif %}

              {% if task.easy_email_cc %}
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-envelope-square"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Email cc</span>
                  <span class="email-cc">{{ task.easy_email_cc }}</span>
                </div>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Timeline -->
          <div class="detail-section">
            <h3 class="section-title">Временная шкала</h3>
            <div class="timeline-items">
              <div class="timeline-item">
                <div class="timeline-dot created"></div>
                <div class="timeline-content">
                  <span class="timeline-label">Создана</span>
                  <div class="timeline-date">
                    <span class="date-main">{{task.created_on.strftime('%d %B %Y')}}</span>
                    <span class="date-time">{{task.created_on.strftime('%H:%M')}}</span>
                  </div>
                </div>
              </div>

              {% if task.start_date %}
              <div class="timeline-item">
                <div class="timeline-dot started"></div>
                <div class="timeline-content">
                  <span class="timeline-label">Начало</span>
                  <div class="timeline-date">
                    <span class="date-main">{{ task.start_date.strftime('%d %B %Y') }}</span>
                  </div>
                </div>
              </div>
              {% endif %}

              {% if task.due_date %}
              <div class="timeline-item">
                <div class="timeline-dot deadline"></div>
                <div class="timeline-content">
                  <span class="timeline-label">Окончание</span>
                  <div class="timeline-date">
                    <span class="date-main">{{ task.due_date.strftime('%d %B %Y') }}</span>
                  </div>
                </div>
              </div>
              {% endif %}

              {% if task.closed_on %}
              <div class="timeline-item">
                <div class="timeline-dot closed"></div>
                <div class="timeline-content">
                  <span class="timeline-label">Закрыто</span>
                  <div class="timeline-date">
                    <span class="date-main">{{ task.closed_on.strftime('%d %B %Y') }}</span>
                    <span class="date-time">{{ task.closed_on.strftime('%H:%M') }}</span>
                  </div>
                </div>
              </div>
              {% endif %}

              <div class="timeline-item">
                <div class="timeline-dot updated"></div>
                <div class="timeline-content">
                  <span class="timeline-label">Обновлена</span>
                  <div class="timeline-date">
                    <span class="date-main">{{task.updated_on.strftime('%d %B %Y')}}</span>
                    <span class="date-time">{{task.updated_on.strftime('%H:%M')}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Description Card -->
    {% if task.description %}
    <div class="card">
      <div class="card-header collapsible" onclick="toggleCard('description')">
        <div class="card-title">
          <i class="fas fa-align-left"></i>
          <h2>Описание</h2>
        </div>
        <i class="fas fa-chevron-up toggle-icon" id="description-toggle"></i>
      </div>
      <div class="card-content" id="description-content">
        <div class="description-content">
          {{ task.description|safe }}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Attachments Card -->
    {% if task.attachments %}
    <div class="card">
      <div class="card-header collapsible" onclick="toggleCard('attachments')">
        <div class="card-title">
          <i class="fas fa-paperclip"></i>
          <h2>Прикрепленные файлы</h2>
          <span class="count-badge">{{ task.attachments|length }}</span>
        </div>
        <i class="fas fa-chevron-up toggle-icon" id="attachments-toggle"></i>
      </div>
      <div class="card-content" id="attachments-content">
        <div class="attachments-grid">
          {% for attachment in task.attachments %}
          <div class="attachment-item">
            <div class="attachment-icon">
              {% set file_ext = attachment.filename.split('.')[-1].lower() if '.' in attachment.filename else '' %}
              {% if file_ext in ['jpg', 'jpeg', 'png', 'gif'] %}
                <i class="fas fa-image"></i>
              {% elif file_ext in ['pdf'] %}
                <i class="fas fa-file-pdf"></i>
              {% elif file_ext in ['doc', 'docx'] %}
                <i class="fas fa-file-word"></i>
              {% elif file_ext in ['xls', 'xlsx'] %}
                <i class="fas fa-file-excel"></i>
              {% else %}
                <i class="fas fa-file"></i>
              {% endif %}
            </div>
            <div class="attachment-info">
              <span class="attachment-name">{{ attachment.filename }}</span>
              <span class="attachment-size">{{ (attachment.filesize / 1024)|round(1) }} KB</span>
            </div>
            <button class="attachment-download" onclick="downloadAttachment('{{ attachment.id }}')" title="Скачать {{ attachment.filename }}">
              <i class="fas fa-download" aria-hidden="true"></i>
              <span class="sr-only">Скачать {{ attachment.filename }}</span>
            </button>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- History Card -->
    {% if task.journals %}
    <div class="card history-card">
      <div class="card-header collapsible" onclick="toggleCard('history')">
        <div class="card-title">
          <i class="fas fa-history"></i>
          <h2>История изменений</h2>
          <span class="count-badge">{{ task.journals|length }}</span>
        </div>
        <div class="header-actions">
          <button class="filter-btn" onclick="event.stopPropagation(); toggleHistoryFilters()">
            <i class="fas fa-filter"></i>
            <span>Фильтры</span>
          </button>
          <i class="fas fa-chevron-up toggle-icon" id="history-toggle"></i>
        </div>
      </div>

      <div class="history-filters" id="historyFilters" style="display: none;">
        <div class="filter-chips">
          <button class="filter-chip active" data-filter="all">Все</button>
          <button class="filter-chip" data-filter="comments">Комментарии</button>
          <button class="filter-chip" data-filter="changes">Изменения</button>
          <button class="filter-chip" data-filter="status">Статус</button>
        </div>
      </div>

      <div class="card-content" id="history-content">
        <!-- Форма для добавления комментария -->
        <div class="comment-section">
          <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
            <button class="comment-button" onclick="toggleCommentInput()" style="flex: 1;">
              <i class="fas fa-plus-circle"></i>
              <span>Добавить комментарий</span>
            </button>
            <button class="email-button" onclick="toggleEmailInput()" style="flex: 1;">
              <i class="fas fa-envelope"></i>
              <span>Отправить email</span>
            </button>
          </div>
          <form id="commentForm" action="" method="POST" enctype="multipart/form-data" class="comment-form">
            {{ form.hidden_tag() }}
            <div class="form-group">
              {{ form.comment.label(class="form-label") }}
              {{ form.comment(class="form-control", rows="4", placeholder="Введите ваш комментарий к задаче...") }}
            </div>
            <div class="form-actions">
              <button type="button" onclick="toggleCommentInput()" class="cancel-button">
                <i class="fas fa-times"></i>
                <span>Отмена</span>
              </button>
              <button type="button" onclick="submitCommentAjax(event)" class="submit-button" id="submitBtn">
                <i class="fas fa-paper-plane"></i>
                <span>Отправить</span>
              </button>
            </div>
          </form>
        </div>

        <!-- Форма для отправки email -->
        <div class="email-section">
          <form id="emailForm" class="email-form" style="display: none;">
            {{ email_form.hidden_tag() }}

            <div class="email-form-grid">
              <div class="form-group">
                {{ email_form.sender.label(class="form-label") }}
                {{ email_form.sender(class="form-control", value=support_email) }}
                <!-- DEBUG: support_email = {{ support_email }} -->
              </div>

              <div class="form-group">
                {{ email_form.recipient.label(class="form-label") }}
                {{ email_form.recipient(class="form-control", value=task.easy_email_to or '') }}
              </div>

              <div class="form-group">
                {{ email_form.subject.label(class="form-label") }}
                {{ email_form.subject(class="form-control", value="Задача #" + task.id|string + " - " + task.subject) }}
              </div>

              <div class="form-group">
                {{ email_form.cc.label(class="form-label") }}
                {{ email_form.cc(class="form-control") }}
              </div>

                          <div class="form-group full-width">
                {{ email_form.message.label(class="form-label") }}
                {{ email_form.message(class="form-control", id="emailMessageField", style="display: none;") }}
                <div id="quillEditor" style="margin-top: 10px; margin-bottom: 15px; min-height: 200px; border: 1px solid #ccc; border-radius: 4px;"></div>
            </div>

                          <div class="form-group full-width">
                <div style="margin-bottom: 15px;">
                  <input type="file" id="fileInput" name="attachments" multiple="multiple" style="display: none;">
                </div>
            </div>

            <!-- Отдельная секция файлов вне контейнера сообщений -->
            <div id="fileSection" style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; border: 1px solid #e9ecef;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <div style="flex: 1;">
                    <div id="fileList" style="color: #6c757d; font-size: 14px; margin-bottom: 5px; word-wrap: break-word; word-break: break-word;">Файл не выбран</div>
                  </div>
                  <button type="button" id="fileButton" style="width: 40px; height: 40px; border: 3px solid #ff6b35; border-radius: 50%; background-color: #ff6b35; color: white; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(255,107,53,0.5); transition: all 0.3s ease; font-weight: bold;" onclick="document.getElementById('fileInput').click();" title="Выбрать файлы">
                    📎
                  </button>
                </div>
                <small class="form-text" id="fileSizeText">Максимальный размер файла: 10 МБ. Для выбора нескольких файлов используйте Ctrl+клик или Shift+клик.</small>
            </div>

              <!-- Скрытый переключатель - всегда включен -->
              <div class="form-group checkbox-group" style="display: none;">
                {{ email_form.send_email(class="form-check-input", checked=True) }}
                {{ email_form.send_email.label(class="form-check-label") }}
              </div>
            </div>

            <div class="form-actions">
              <button type="button" onclick="toggleEmailInput()" class="cancel-button">
                <i class="fas fa-times"></i>
                <span>Отмена</span>
              </button>
              <button type="button" onclick="submitEmailAjax(event)" class="submit-button" id="submitEmailBtn">
                <i class="fas fa-envelope"></i>
                <span>Отправить email</span>
              </button>
            </div>
          </form>
        </div>

        <div class="history-timeline">
          {% for journal in task.journals|reverse %}
          <div class="history-item" data-type="{% if journal.notes %}comments{% else %}changes{% endif %}">
            {% set user_check = False %}
            {% if task.assigned_to and journal.user %}
                {% set last_name = current_user.username.split('.')[-1]|lower %}
                {% if task.assigned_to.name and last_name in task.assigned_to.name|lower
                      and journal.user.name and last_name in journal.user.name|lower %}
                  {% set user_check = True %}
                {% endif %}
            {% endif %}

            {# Проверяем, что автор комментария совпадает с текущим пользователем #}
            {% set is_comment_author = False %}
            {% if journal.user %}
              {% if journal.user.login and journal.user.login == current_user.username %}
                {% set is_comment_author = True %}
              {% elif journal.user.name and (journal.user.name == current_user.full_name or journal.user.name|lower == current_user.username|replace('.', ' ')|replace('_', ' ')|lower) %}
                {% set is_comment_author = True %}
              {% endif %}
            {% endif %}

            {% if is_task_owner and is_comment_author %}
              {% set user_check = True %}
            {% endif %}

            <div class="history-avatar">
              <div class="avatar-circle history">
                {% if journal.user and journal.user.name %}
                  {% set name_parts = journal.user.name.split() %}
                  {% if name_parts|length > 1 %}
                    {{ name_parts[-1][0] if name_parts[-1] else name_parts[0][0] }}
                  {% else %}
                    {{ name_parts[0][0] if name_parts[0] else 'U' }}
                  {% endif %}
                {% else %}
                  U
                {% endif %}
              </div>
            </div>

            <div class="history-content">
              <div class="history-header">
                <div class="history-user">
                  <span class="user-name">{{ journal.user.name if journal.user else 'Система' }}</span>
                  <span class="history-time">{{ convert_datetime_msk_format(journal.created_on) }}</span>
                </div>

                {% if user_check and journal.notes %}
                  <div class="action-button-container">
                    <button class="comment-action-btn" data-journal-id="{{ journal.id }}" title="Действия с комментарием" aria-label="Действия с комментарием">
                      <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="action-menu" id="menu-{{ journal.id }}">
                      <div class="menu-item edit-btn" data-action="edit" data-journal-id="{{ journal.id }}">
                        <i class="fas fa-edit"></i>
                        <span>Редактировать</span>
                      </div>
                      <div class="menu-item delete-btn" data-action="delete" data-journal-id="{{ journal.id }}">
                        <i class="fas fa-trash"></i>
                        <span>Удалить</span>
                      </div>
                    </div>
                  </div>
                {% endif %}
              </div>

              {% if journal.details %}
              <div class="history-changes">
                {% for detail in journal.details %}
                {% set old_value = detail.old_value %}
                {% set new_value = detail.new_value %}
                {% set property_name_html = get_property_name(detail.property if detail.property else 'attr', detail.name, old_value, new_value) %}
                {% if property_name_html %}
                  <div class="change-item">
                    <div class="change-description">
                      <i class="fas fa-arrow-right change-icon"></i>
                      <span>{{ property_name_html | safe }}</span>
                    </div>
                  </div>
                {% else %}
                  <div class="change-item">
                    <div class="change-field">
                      <i class="fas fa-edit change-icon"></i>
                      <span class="field-name">
                        {% if detail.name == 'status_id' %}
                          Статус
                        {% elif detail.name == 'done_ratio' %}
                          Готовность
                        {% elif detail.name == 'assigned_to_id' %}
                          Исполнитель
                        {% elif detail.name == 'priority_id' %}
                          Приоритет
                        {% elif detail.name == 'project_id' %}
                          Проект
                        {% elif detail.name == 'subject' %}
                          Тема
                        {% elif detail.name == 'easy_helpdesk_need_reaction' %}
                          Нужна реакция?
                        {% elif detail.name == '16' %}
                          Что нового
                        {% else %}
                          {{ detail.name }}
                        {% endif %}
                      </span>
                    </div>
                    <div class="change-values">
                      {% if detail.old_value %}
                      <span class="old-value">
                        {% if detail.name == 'status_id' %}
                          {{ status_names.get(detail.old_value|int, detail.old_value) if detail.old_value and detail.old_value.isdigit() else detail.old_value }}
                        {% elif detail.name == 'assigned_to_id' %}
                          {{ user_names.get(detail.old_value|int, detail.old_value) if detail.old_value and detail.old_value.isdigit() else detail.old_value }}
                        {% elif detail.name == 'project_id' %}
                          {{ project_names.get(detail.old_value|int, detail.old_value) if detail.old_value and detail.old_value.isdigit() else detail.old_value }}
                        {% elif detail.name == 'priority_id' %}
                          {{ priority_names.get(detail.old_value|int, detail.old_value) if detail.old_value and detail.old_value.isdigit() else detail.old_value }}
                        {% elif detail.name == 'done_ratio' %}
                          {{ detail.old_value }}%
                        {% elif detail.name == 'easy_helpdesk_need_reaction' %}
                          {% if detail.old_value == '1' %}Да{% else %}Нет{% endif %}
                        {% elif detail.name == '16' %}
                          {% if detail.old_value and detail.old_value != '0' %}Да{% else %}Нет{% endif %}
                        {% else %}
                          {{ detail.old_value }}
                        {% endif %}
                      </span>
                      <i class="fas fa-arrow-right change-arrow"></i>
                      {% endif %}
                      <span class="new-value">
                        {% if detail.name == 'status_id' %}
                          {{ status_names.get(detail.new_value|int, detail.new_value) if detail.new_value and detail.new_value.isdigit() else detail.new_value }}
                        {% elif detail.name == 'assigned_to_id' %}
                          {% if detail.new_value and detail.new_value.isdigit() %}
                            {{ user_names.get(detail.new_value|int, detail.new_value) }}
                          {% else %}
                            Не назначен
                          {% endif %}
                        {% elif detail.name == 'project_id' %}
                          {{ project_names.get(detail.new_value|int, detail.new_value) if detail.new_value and detail.new_value.isdigit() else detail.new_value }}
                        {% elif detail.name == 'priority_id' %}
                          {{ priority_names.get(detail.new_value|int, detail.new_value) if detail.new_value and detail.new_value.isdigit() else detail.new_value }}
                        {% elif detail.name == 'done_ratio' %}
                          {{ detail.new_value }}%
                        {% elif detail.name == 'easy_helpdesk_need_reaction' %}
                          {{ format_boolean_field(detail.new_value, detail.name) }}
                        {% elif detail.name == '16' %}
                          {{ format_boolean_field(detail.new_value, detail.name) }}
                        {% else %}
                          {% if detail.new_value %}
                            {{ detail.new_value }}
                          {% else %}
                            Значение удалено
                          {% endif %}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                {% endif %}
                {% endfor %}
              </div>
                            {% endif %}

              {% if journal.notes %}
                <div class="history-comment" data-journal-id="{{ journal.id }}" style="position: relative;">
                  <div class="comment-content">
                    {{ journal.notes|safe }}
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<script>
window.TASK_DETAIL_CONTEXT = Object.assign({}, window.TASK_DETAIL_CONTEXT || {}, {
  clearComment: {{ (clear_comment|default(false))|tojson }},
  emailSignatureHtml: {{ (email_signature_html|safe)|tojson }},
  currentUserData: {
    username: {{ current_user.username|tojson }},
    fullName: {{ (current_user.full_name or current_user.username)|tojson }},
    firstLetter: {{ ((current_user.full_name or current_user.username)[0]|upper)|tojson }}
  }
});
</script>

<!-- Модальное окно для редактирования комментария -->
<div id="editCommentModal" class="edit-comment-modal">
  <div class="edit-comment-modal__dialog">
    <button id="closeEditCommentModalBtn" class="edit-comment-modal__close">×</button>
    <h3 class="edit-comment-modal__title">Редактировать комментарий</h3>
    <textarea id="editCommentTextarea" class="edit-comment-modal__textarea"></textarea>
    <div class="edit-comment-modal__actions">
      <button id="cancelEditCommentBtn" type="button" class="edit-comment-modal__cancel">Отмена</button>
      <button id="saveEditCommentBtn" type="button" class="edit-comment-modal__save">Сохранить</button>
    </div>
  </div>
</div>

            <!-- Подключение скрипта для изменения статуса задачи -->
            <script src="{{ url_for('static', filename='js/task_status_change.js') }}"></script>

            <!-- Подключение скрипта для изменения приоритета задачи -->
            <script src="{{ url_for('static', filename='js/task_priority_change.js') }}"></script>

            <!-- Подключение скрипта для изменения исполнителя задачи -->
            <script src="{{ url_for('static', filename='js/task_assignee_change.js') }}"></script>
{% endblock %}


