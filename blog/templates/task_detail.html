{% extends 'layout.html' %}

{% block main_page %}

<!-- CSS –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ -->
<style>
/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ */
.task-status-changer {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
}

/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ */
.current-status {
    margin-bottom: 15px;
}

.current-status .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: block;
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ –±–µ–π–¥–∂–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ */
.status-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    line-height: 1.4;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    color: #495057;
    border: 1px solid rgba(206, 212, 218, 0.5);
    box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.status-badge::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.5s ease;
}

.status-badge:hover::before {
    left: 100%;
}

.status-badge:hover {
    transform: translateY(-1px);
    box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

/* –¶–≤–µ—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ */
.status-badge.status-1,
.status-badge.status-7,
.status-badge.status-13,
.status-badge.status-17 {
    background: linear-gradient(135deg, #d1ecf1 0%, #b8daff 100%);
    color: #0c5460;
    border-color: rgba(190, 229, 235, 0.6);
    box-shadow:
        0 2px 8px rgba(12, 84, 96, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.status-badge.status-2,
.status-badge.status-8,
.status-badge.status-15,
.status-badge.status-18 {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    color: #856404;
    border-color: rgba(255, 234, 167, 0.6);
    box-shadow:
        0 2px 8px rgba(133, 100, 4, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.status-badge.status-3 {
    background: linear-gradient(135deg, #cce5ff 0%, #b8daff 100%);
    color: #004085;
    border-color: rgba(184, 218, 255, 0.6);
    box-shadow:
        0 2px 8px rgba(0, 64, 133, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.status-badge.status-4,
.status-badge.status-14 {
    background: linear-gradient(135deg, #f8d7da 0%, #ffcdd2 100%);
    color: #721c24;
    border-color: rgba(245, 198, 203, 0.6);
    box-shadow:
        0 2px 8px rgba(114, 28, 36, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.status-badge.status-5,
.status-badge.status-16 {
    background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
    color: #00695c;
    border-color: rgba(178, 223, 219, 0.6);
    box-shadow:
        0 2px 8px rgba(0, 105, 92, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.status-badge.status-6 {
    background: linear-gradient(135deg, #e2e3e5 0%, #d6d8db 100%);
    color: #383d41;
    border-color: rgba(214, 216, 219, 0.6);
    box-shadow:
        0 2px 8px rgba(56, 61, 65, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.status-badge.status-9 {
    background: linear-gradient(135deg, #ffccbc 0%, #ff8a65 100%);
    color: #d84315;
    border-color: rgba(255, 138, 101, 0.6);
    box-shadow:
        0 2px 8px rgba(216, 67, 21, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.status-badge.status-10,
.status-badge.status-19 {
    background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
    color: #7b1fa2;
    border-color: rgba(225, 190, 231, 0.6);
    box-shadow:
        0 2px 8px rgba(123, 31, 162, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

/* –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ */
.status-badge::after {
    content: '';
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
    opacity: 0.7;
    animation: statusPulse 2s infinite ease-in-out;
}

@keyframes statusPulse {
    0%, 100% { opacity: 0.7; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.1); }
}

/* –£–ª—É—á—à–µ–Ω–∏—è –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
[data-theme="dark"] .status-badge {
    background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
    color: #f3f4f6;
    border-color: rgba(75, 85, 99, 0.5);
    box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
}

/* –§–æ—Ä–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ */
.status-change-form {
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
}

.status-change-form .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: block;
}

/* –°–µ–ª–µ–∫—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ —Å—Ç–∞—Ç—É—Å–∞ */
#new-status-select {
    border-radius: 6px;
    border: 1px solid #ced4da;
    padding: 8px 12px;
    font-size: 0.875rem;
    width: 100%;
    margin-bottom: 10px;
}

/* –ö–Ω–æ–ø–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ */
#change-status-btn {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
}

#change-status-btn:hover:not(:disabled) {
    background-color: #0056b3;
}

#change-status-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background-color: #6c757d;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º */
.task-priority-changer {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
}

/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ */
.current-priority {
    margin-bottom: 15px;
}

.current-priority .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: block;
}

/* –ë–µ–π–¥–∂–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ */
.priority-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 0.875rem;
    font-weight: 600;
    text-align: center;
    white-space: nowrap;
    vertical-align: baseline;
    line-height: 1.4;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    color: #495057;
    border: 1px solid rgba(206, 212, 218, 0.5);
    box-shadow:
        0 2px 8px rgba(0, 0, 0, 0.1),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

.priority-badge::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.5s ease;
}

.priority-badge:hover::before {
    left: 100%;
}

.priority-badge:hover {
    transform: translateY(-1px);
    box-shadow:
        0 4px 12px rgba(0, 0, 0, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

/* –¶–≤–µ—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ */
.priority-badge.priority-1,
.priority-badge.priority-2 {
    background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
    color: #856404;
    border-color: rgba(255, 193, 7, 0.6);
    box-shadow:
        0 2px 8px rgba(255, 193, 7, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.priority-badge.priority-3,
.priority-badge.priority-4 {
    background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
    color: #721c24;
    border-color: rgba(220, 53, 69, 0.6);
    box-shadow:
        0 2px 8px rgba(220, 53, 69, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.priority-badge.priority-5,
.priority-badge.priority-6 {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
    color: #0c5460;
    border-color: rgba(23, 162, 184, 0.6);
    box-shadow:
        0 2px 8px rgba(23, 162, 184, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

.priority-badge.priority-none {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    color: #6c757d;
    border-color: rgba(108, 117, 125, 0.6);
    box-shadow:
        0 2px 8px rgba(108, 117, 125, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
}

/* –§–æ—Ä–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ */
.priority-change-form {
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
}

.priority-change-form .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: block;
}

/* –°–µ–ª–µ–∫—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ */
#new-priority-select {
    border-radius: 6px;
    border: 1px solid #ced4da;
    padding: 8px 12px;
    font-size: 0.875rem;
    width: 100%;
    margin-bottom: 10px;
}

/* –ö–Ω–æ–ø–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ */
#change-priority-btn {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
}

#change-priority-btn:hover:not(:disabled) {
    background-color: #0056b3;
}

#change-priority-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background-color: #6c757d;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º */
.task-assignee-changer {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 15px;
    margin-top: 10px;
}

/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è */
.current-assignee {
    margin-bottom: 15px;
}

.current-assignee .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: block;
}

/* –ê–≤–∞—Ç–∞—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
.user-avatar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 8px;
}

.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 16px;
    color: white;
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    border: 2px solid rgba(255, 255, 255, 0.8);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.avatar-circle.assigned {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
}

.avatar-circle:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.user-name {
    font-weight: 500;
    color: #495057;
    font-size: 0.95rem;
}

/* –§–æ—Ä–º–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è */
.assignee-change-form {
    border-top: 1px solid #dee2e6;
    padding-top: 15px;
}

.assignee-change-form .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 8px;
    display: block;
}

/* –°–µ–ª–µ–∫—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è */
#new-assignee-select {
    border-radius: 6px;
    border: 1px solid #ced4da;
    padding: 8px 12px;
    font-size: 0.875rem;
    width: 100%;
    margin-bottom: 10px;
}

/* –ö–Ω–æ–ø–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è */
#change-assignee-btn {
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    padding: 8px 16px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.15s ease-in-out;
}

#change-assignee-btn:hover:not(:disabled) {
    background-color: #0056b3;
}

#change-assignee-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background-color: #6c757d;
}

/* –ü–æ–ª–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è */
#status-comment {
    border-radius: 6px;
    border: 1px solid #ced4da;
    padding: 8px 12px;
    font-size: 0.875rem;
    width: 100%;
    min-height: 80px;
    resize: vertical;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ */
.fa-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
.alert {
    border-radius: 6px;
    margin-bottom: 15px;
    padding: 12px 16px;
    font-size: 0.875rem;
}

.alert-success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.alert-danger {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .task-status-changer {
        padding: 10px;
    }

    #change-status-btn {
        width: 100%;
        margin-top: 10px;
    }
}

.loading-placeholder {
    display: flex;
    align-items: center;
    gap: 10px;
    color: #6c757d;
    font-size: 0.875rem;
}

.section-title {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 15px;
}

.status-management {
    display: block;
}

.status-management .detail-content {
    width: 100%;
}

.comment-actions-trigger i.fas.fa-ellipsis-v {
  color: #6366f1 !important;
  font-size: 0.6rem !important;
  display: block !important;
  visibility: visible !important;
}
</style>

<div class="modern-task-detail compact-mode">
  <!-- Compact Mode Toggle Button -->
  <button class="compact-mode-toggle" id="compactModeToggle" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º">
    <i class="fas fa-compress-alt"></i>
  </button>

  <!-- Floating Action Button -->
  <!-- Hero Section -->
  <div class="hero-section">
    <div class="hero-content">
      <div class="breadcrumb">
       <a href="/tasks/my-tasks" class="breadcrumb-link">
          <i class="fas fa-tasks"></i>
          <span>–ú–æ–∏ –∑–∞–¥–∞—á–∏</span>
       </a>
        <i class="fas fa-chevron-right breadcrumb-separator"></i>
        <span class="breadcrumb-current">–ó–∞–¥–∞—á–∞ #{{task.id}}</span>
       <button class="action-btn back-btn" id="go-back-btn" data-task-id="{{ task.id }}">
          <i class="fas fa-arrow-left"></i>
          <span>–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</span>
        </button>
      </div>

      <div class="hero-main">
        <div class="task-status-large">
          {% set status_class = 'status-default' %}
          {% set status_icon = 'fas fa-question-circle' %}
          {% set status_color = '#6c757d' %}
          {% set status_name = status_mapping.get(task.status.id, task.status.name) if task.status else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' %}

          {% if status_name in ['–ù–æ–≤–∞—è', 'New', '–û—Ç–∫—Ä—ã—Ç–∞', 'Open'] %}
            {% set status_class = 'status-open' %}
            {% set status_icon = 'fas fa-folder-open' %}
            {% set status_color = '#007bff' %}
          {% elif status_name in ['–í —Ä–∞–±–æ—Ç–µ', 'In Progress', '–ù–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏', '–í –æ—á–µ—Ä–µ–¥–∏'] %}
            {% set status_class = 'status-progress' %}
            {% set status_icon = 'fas fa-clock' %}
            {% set status_color = '#ffc107' %}
          {% elif status_name in ['–ó–∞–∫—Ä—ã—Ç–∞', 'Closed', '–í—ã–ø–æ–ª–Ω–µ–Ω–∞', 'Resolved', '–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞'] %}
            {% set status_class = 'status-closed' %}
            {% set status_icon = 'fas fa-check-circle' %}
            {% set status_color = '#28a745' %}
          {% elif status_name in ['–û—Ç–∫–ª–æ–Ω–µ–Ω–∞', 'Rejected', '–ó–∞–º–æ—Ä–æ–∂–µ–Ω–∞'] %}
            {% set status_class = 'status-rejected' %}
            {% set status_icon = 'fas fa-times-circle' %}
            {% set status_color = '#dc3545' %}
          {% elif status_name in ['–ó–∞–ø—Ä–æ—à–µ–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ', '–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞', '–ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏'] %}
            {% set status_class = 'status-pending' %}
            {% set status_icon = 'fas fa-pause-circle' %}
            {% set status_color = '#6f42c1' %}
          {% elif status_name in ['–ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞'] %}
            {% set status_class = 'status-registered' %}
            {% set status_icon = 'fas fa-file-check' %}
            {% set status_color = '#17a2b8' %}
          {% endif %}

          <div class="status-indicator {{ status_class }}" style="--status-color: {{ status_color }}">
            <i class="{{ status_icon }}"></i>
          </div>
        </div>

        <div class="hero-text">
          <h1 class="hero-title">{{task.subject}}</h1>
          <p class="hero-subtitle">–ó–∞–¥–∞—á–∞ #{{task.id}} ‚Ä¢ {{ status_name }}</p>
        </div>
      </div>

      <div class="hero-actions">
        <button class="action-btn primary" onclick="window.print()">
          <i class="fas fa-print"></i>
          <span>–ü–µ—á–∞—Ç—å</span>
        </button>
        <button class="action-btn secondary" onclick="copyTaskLink()">
          <i class="fas fa-link"></i>
          <span>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</span>
        </button>
        <a href="https://helpdesk.teztour.com/issues/{{ task.id }}" class="action-btn secondary" target="_blank" rel="noopener noreferrer">
          <i class="fas fa-external-link-alt"></i>
          <span>–û—Ç–∫—Ä—ã—Ç—å –≤ Redmine</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="content-grid">

    <!-- Task Details Card -->
    <div class="card main-card">
      <div class="card-header collapsible" onclick="toggleCard('details')">
        <div class="card-title">
          <i class="fas fa-info-circle"></i>
          <h2>–°–≤–µ–¥–µ–Ω–∏—è –æ –∑–∞–¥–∞—á–µ</h2>
        </div>
        <i class="fas fa-chevron-up toggle-icon" id="details-toggle"></i>
      </div>

      <div class="card-content" id="details-content">
        <div class="details-grid">
          <!-- Primary Info -->
          <div class="detail-section">
            <h3 class="section-title">–û—Å–Ω–æ–≤–Ω–æ–µ</h3>
            <div class="detail-items">
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</span>
                  <div class="detail-value priority-badge">
                    {% if task.priority and task.priority.id %}
                      {% set pos = task.priority.position if task.priority.position is defined else None %}
                      {% if pos is not none and (pos|int) >= 7 %}
                        <span class="badge high">{{ task.priority.name }}</span>
                      {% elif pos is not none and (pos|int) <= 3 %}
                        <span class="badge low">{{ task.priority.name }}</span>
                      {% else %}
                        <span class="badge normal">{{ task.priority.name }}</span>
                      {% endif %}
                    {% else %}
                      <span class="badge">{{ task.priority.name if task.priority else '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span>
                    {% endif %}
                  </div>
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-folder"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">–ü—Ä–æ–µ–∫—Ç</span>
                  <span class="detail-value">{{ task.project.name if task.project else '–ë–µ–∑ –ø—Ä–æ–µ–∫—Ç–∞' }}</span>
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-tags"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">–¢—Ä–µ–∫–µ—Ä</span>
                  <span class="detail-value">{{ task.tracker.name if task.tracker else '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span>
                </div>
              </div>

              {% if task.done_ratio is defined %}
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-percentage"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
                  <div class="progress-container">
                    <div class="progress-bar">
                      <div class="progress-fill" id="progress-fill" data-done-ratio="{{ task.done_ratio or 0 }}"></div>
                    </div>
                    <span class="progress-text">{{task.done_ratio}}%</span>
                  </div>
                </div>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Status and Priority Management Section -->
          <div class="detail-section">
            <h3 class="section-title">
              <i class="fas fa-sync-alt"></i>
              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–æ–º –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º
            </h3>
            <div class="detail-items">
              <div class="detail-item status-management">
                <div class="detail-icon">
                  <i class="fas fa-flag"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">–°—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏</span>
                  <div id="task-status-container">
                    <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —á–µ—Ä–µ–∑ JavaScript -->
                    <div class="loading-placeholder">
                      <i class="fas fa-spinner fa-spin"></i>
                      <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="detail-item priority-management">
                <div class="detail-icon">
                  <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞–¥–∞—á–∏</span>
                  <div id="task-priority-container">
                    <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ —á–µ—Ä–µ–∑ JavaScript -->
                    <div class="loading-placeholder">
                      <i class="fas fa-spinner fa-spin"></i>
                      <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- People -->
          <div class="detail-section">
            <h3 class="section-title">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
            <div class="detail-items">
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-user-edit"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">–ê–≤—Ç–æ—Ä</span>
                  {% if task.author %}
                    <div class="user-avatar">
                      <div class="avatar-circle">{{ task.author.name[0] if task.author.name else 'U' }}</div>
                      <span class="user-name">{{ task.author.name }}</span>
                    </div>
                  {% else %}
                    <span class="detail-value no-data">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>
                  {% endif %}
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-user-cog"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å</span>
                  <div id="task-assignee-container">
                    <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è —á–µ—Ä–µ–∑ JavaScript -->
                    <div class="loading-placeholder">
                      <i class="fas fa-spinner fa-spin"></i>
                      <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                  </div>
                </div>
              </div>

              {% if task.easy_email_to %}
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-envelope"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Email to</span>
                  <a href="mailto:{{ task.easy_email_to }}" class="email-link">{{ task.easy_email_to }}</a>
                </div>
              </div>
              {% endif %}

              {% if task.easy_email_cc %}
              <div class="detail-item">
                <div class="detail-icon">
                  <i class="fas fa-envelope-square"></i>
                </div>
                <div class="detail-content">
                  <span class="detail-label">Email cc</span>
                  <span class="email-cc">{{ task.easy_email_cc }}</span>
                </div>
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Timeline -->
          <div class="detail-section">
            <h3 class="section-title">–í—Ä–µ–º–µ–Ω–Ω–∞—è —à–∫–∞–ª–∞</h3>
            <div class="timeline-items">
              <div class="timeline-item">
                <div class="timeline-dot created"></div>
                <div class="timeline-content">
                  <span class="timeline-label">–°–æ–∑–¥–∞–Ω–∞</span>
                  <div class="timeline-date">
                    <span class="date-main">{{task.created_on.strftime('%d %B %Y')}}</span>
                    <span class="date-time">{{task.created_on.strftime('%H:%M')}}</span>
                  </div>
                </div>
              </div>

              {% if task.start_date %}
              <div class="timeline-item">
                <div class="timeline-dot started"></div>
                <div class="timeline-content">
                  <span class="timeline-label">–ù–∞—á–∞–ª–æ</span>
                  <div class="timeline-date">
                    <span class="date-main">{{ task.start_date.strftime('%d %B %Y') }}</span>
                  </div>
                </div>
              </div>
              {% endif %}

              {% if task.due_date %}
              <div class="timeline-item">
                <div class="timeline-dot deadline"></div>
                <div class="timeline-content">
                  <span class="timeline-label">–û–∫–æ–Ω—á–∞–Ω–∏–µ</span>
                  <div class="timeline-date">
                    <span class="date-main">{{ task.due_date.strftime('%d %B %Y') }}</span>
                  </div>
                </div>
              </div>
              {% endif %}

              {% if task.closed_on %}
              <div class="timeline-item">
                <div class="timeline-dot closed"></div>
                <div class="timeline-content">
                  <span class="timeline-label">–ó–∞–∫—Ä—ã—Ç–æ</span>
                  <div class="timeline-date">
                    <span class="date-main">{{ task.closed_on.strftime('%d %B %Y') }}</span>
                    <span class="date-time">{{ task.closed_on.strftime('%H:%M') }}</span>
                  </div>
                </div>
              </div>
              {% endif %}

              <div class="timeline-item">
                <div class="timeline-dot updated"></div>
                <div class="timeline-content">
                  <span class="timeline-label">–û–±–Ω–æ–≤–ª–µ–Ω–∞</span>
                  <div class="timeline-date">
                    <span class="date-main">{{task.updated_on.strftime('%d %B %Y')}}</span>
                    <span class="date-time">{{task.updated_on.strftime('%H:%M')}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Description Card -->
    {% if task.description %}
    <div class="card">
      <div class="card-header collapsible" onclick="toggleCard('description')">
        <div class="card-title">
          <i class="fas fa-align-left"></i>
          <h2>–û–ø–∏—Å–∞–Ω–∏–µ</h2>
        </div>
        <i class="fas fa-chevron-up toggle-icon" id="description-toggle"></i>
      </div>
      <div class="card-content" id="description-content">
        <div class="description-content">
          {{ task.description|safe }}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Attachments Card -->
    {% if task.attachments %}
    <div class="card">
      <div class="card-header collapsible" onclick="toggleCard('attachments')">
        <div class="card-title">
          <i class="fas fa-paperclip"></i>
          <h2>–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</h2>
          <span class="count-badge">{{ task.attachments|length }}</span>
        </div>
        <i class="fas fa-chevron-up toggle-icon" id="attachments-toggle"></i>
      </div>
      <div class="card-content" id="attachments-content">
        <div class="attachments-grid">
          {% for attachment in task.attachments %}
          <div class="attachment-item">
            <div class="attachment-icon">
              {% set file_ext = attachment.filename.split('.')[-1].lower() if '.' in attachment.filename else '' %}
              {% if file_ext in ['jpg', 'jpeg', 'png', 'gif'] %}
                <i class="fas fa-image"></i>
              {% elif file_ext in ['pdf'] %}
                <i class="fas fa-file-pdf"></i>
              {% elif file_ext in ['doc', 'docx'] %}
                <i class="fas fa-file-word"></i>
              {% elif file_ext in ['xls', 'xlsx'] %}
                <i class="fas fa-file-excel"></i>
              {% else %}
                <i class="fas fa-file"></i>
              {% endif %}
            </div>
            <div class="attachment-info">
              <span class="attachment-name">{{ attachment.filename }}</span>
              <span class="attachment-size">{{ (attachment.filesize / 1024)|round(1) }} KB</span>
            </div>
            <button class="attachment-download" onclick="downloadAttachment('{{ attachment.id }}')">
              <i class="fas fa-download"></i>
            </button>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}

    <!-- History Card -->
    {% if task.journals %}
    <div class="card history-card">
      <div class="card-header collapsible" onclick="toggleCard('history')">
        <div class="card-title">
          <i class="fas fa-history"></i>
          <h2>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</h2>
          <span class="count-badge">{{ task.journals|length }}</span>
        </div>
        <div class="header-actions">
          <button class="filter-btn" onclick="event.stopPropagation(); toggleHistoryFilters()">
            <i class="fas fa-filter"></i>
            <span>–§–∏–ª—å—Ç—Ä—ã</span>
          </button>
          <i class="fas fa-chevron-up toggle-icon" id="history-toggle"></i>
        </div>
      </div>

      <div class="history-filters" id="historyFilters" style="display: none;">
        <div class="filter-chips">
          <button class="filter-chip active" data-filter="all">–í—Å–µ</button>
          <button class="filter-chip" data-filter="comments">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>
          <button class="filter-chip" data-filter="changes">–ò–∑–º–µ–Ω–µ–Ω–∏—è</button>
          <button class="filter-chip" data-filter="status">–°—Ç–∞—Ç—É—Å</button>
        </div>
      </div>

      <div class="card-content" id="history-content">
        <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
        <div class="comment-section">
          <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
            <button class="comment-button" onclick="toggleCommentInput()" style="flex: 1;">
              <i class="fas fa-plus-circle"></i>
              <span>–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</span>
            </button>
            <button class="email-button" onclick="toggleEmailInput()" style="flex: 1;">
              <i class="fas fa-envelope"></i>
              <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å email</span>
            </button>
          </div>
          <form id="commentForm" action="" method="POST" enctype="multipart/form-data" class="comment-form">
            {{ form.hidden_tag() }}
            <div class="form-group">
              {{ form.comment.label(class="form-label") }}
              {{ form.comment(class="form-control", rows="4", placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –∑–∞–¥–∞—á–µ...") }}
            </div>
            <div class="form-actions">
              <button type="button" onclick="toggleCommentInput()" class="cancel-button">
                <i class="fas fa-times"></i>
                <span>–û—Ç–º–µ–Ω–∞</span>
              </button>
              <button type="button" onclick="submitCommentAjax(event)" class="submit-button" id="submitBtn">
                <i class="fas fa-paper-plane"></i>
                <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
              </button>
            </div>
          </form>
        </div>

        <!-- –§–æ—Ä–º–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ email -->
        <div class="email-section">
          <form id="emailForm" class="email-form" style="display: none;">
            {{ email_form.hidden_tag() }}

            <div class="email-form-grid">
              <div class="form-group">
                {{ email_form.sender.label(class="form-label") }}
                {{ email_form.sender(class="form-control", value=support_email) }}
                <!-- DEBUG: support_email = {{ support_email }} -->
              </div>

              <div class="form-group">
                {{ email_form.recipient.label(class="form-label") }}
                {{ email_form.recipient(class="form-control", value=task.easy_email_to or '') }}
              </div>

              <div class="form-group">
                {{ email_form.subject.label(class="form-label") }}
                {{ email_form.subject(class="form-control", value="–ó–∞–¥–∞—á–∞ #" + task.id|string + " - " + task.subject) }}
              </div>

              <div class="form-group">
                {{ email_form.cc.label(class="form-label") }}
                {{ email_form.cc(class="form-control") }}
              </div>

                          <div class="form-group full-width">
                {{ email_form.message.label(class="form-label") }}
                {{ email_form.message(class="form-control", id="emailMessageField", style="display: none;") }}
                <div id="quillEditor" style="margin-top: 10px; margin-bottom: 15px; min-height: 200px; border: 1px solid #ccc; border-radius: 4px;"></div>
            </div>

                          <div class="form-group full-width">
                <div style="margin-bottom: 15px;">
                  <input type="file" id="fileInput" name="attachments" multiple="multiple" style="display: none;">
                </div>
            </div>

            <!-- –û—Ç–¥–µ–ª—å–Ω–∞—è —Å–µ–∫—Ü–∏—è —Ñ–∞–π–ª–æ–≤ –≤–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div id="fileSection" style="margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; border: 1px solid #e9ecef;">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                  <div style="flex: 1;">
                    <div id="fileList" style="color: #6c757d; font-size: 14px; margin-bottom: 5px; word-wrap: break-word; word-break: break-word;">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</div>
                  </div>
                  <button type="button" id="fileButton" style="width: 40px; height: 40px; border: 3px solid #ff6b35; border-radius: 50%; background-color: #ff6b35; color: white; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(255,107,53,0.5); transition: all 0.3s ease; font-weight: bold;" onclick="document.getElementById('fileInput').click();" title="–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã">
                    üìé
                  </button>
                </div>
                <small class="form-text" id="fileSizeText">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: 10 –ú–ë. –î–ª—è –≤—ã–±–æ—Ä–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Ctrl+–∫–ª–∏–∫ –∏–ª–∏ Shift+–∫–ª–∏–∫.</small>
            </div>

              <!-- –°–∫—Ä—ã—Ç—ã–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å - –≤—Å–µ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω -->
              <div class="form-group checkbox-group" style="display: none;">
                {{ email_form.send_email(class="form-check-input", checked=True) }}
                {{ email_form.send_email.label(class="form-check-label") }}
              </div>
            </div>

            <div class="form-actions">
              <button type="button" onclick="toggleEmailInput()" class="cancel-button">
                <i class="fas fa-times"></i>
                <span>–û—Ç–º–µ–Ω–∞</span>
              </button>
              <button type="button" onclick="submitEmailAjax(event)" class="submit-button" id="submitEmailBtn">
                <i class="fas fa-envelope"></i>
                <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å email</span>
              </button>
            </div>
          </form>
        </div>

        <div class="history-timeline">
          {% for journal in task.journals|reverse %}
          <div class="history-item" data-type="{% if journal.notes %}comments{% else %}changes{% endif %}">
            {% set user_check = False %}
            {% if task.assigned_to and journal.user %}
                {% set last_name = current_user.username.split('.')[-1]|lower %}
                {% if task.assigned_to.name and last_name in task.assigned_to.name|lower
                      and journal.user.name and last_name in journal.user.name|lower %}
                  {% set user_check = True %}
                {% endif %}
            {% endif %}

            {# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∞–≤—Ç–æ—Ä –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ–∫—É—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º #}
            {% set is_comment_author = False %}
            {% if journal.user %}
              {% if journal.user.login and journal.user.login == current_user.username %}
                {% set is_comment_author = True %}
              {% elif journal.user.name and (journal.user.name == current_user.full_name or journal.user.name|lower == current_user.username|replace('.', ' ')|replace('_', ' ')|lower) %}
                {% set is_comment_author = True %}
              {% endif %}
            {% endif %}

            {% if is_task_owner and is_comment_author %}
              {% set user_check = True %}
            {% endif %}

            <div class="history-avatar">
              <div class="avatar-circle history">
                {% if journal.user and journal.user.name %}
                  {% set name_parts = journal.user.name.split() %}
                  {% if name_parts|length > 1 %}
                    {{ name_parts[-1][0] if name_parts[-1] else name_parts[0][0] }}
                  {% else %}
                    {{ name_parts[0][0] if name_parts[0] else 'U' }}
                  {% endif %}
                {% else %}
                  U
                {% endif %}
              </div>
            </div>

            <div class="history-content">
              <div class="history-header">
                <div class="history-user">
                  <span class="user-name">{{ journal.user.name if journal.user else '–°–∏—Å—Ç–µ–º–∞' }}</span>
                  <span class="history-time">{{ convert_datetime_msk_format(journal.created_on) }}</span>
                </div>

                {% if user_check and journal.notes %}
                  <div class="action-button-container">
                    <button class="action-btn" data-journal-id="{{ journal.id }}">
                      <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="action-menu" id="menu-{{ journal.id }}">
                      <div class="menu-item edit-btn" data-action="edit" data-journal-id="{{ journal.id }}">
                        <i class="fas fa-edit"></i>
                        <span>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                      </div>
                      <div class="menu-item delete-btn" data-action="delete" data-journal-id="{{ journal.id }}">
                        <i class="fas fa-trash"></i>
                        <span>–£–¥–∞–ª–∏—Ç—å</span>
                      </div>
                    </div>
                  </div>
                {% endif %}
              </div>

              {% if journal.details %}
              <div class="history-changes">
                {% for detail in journal.details %}
                {% set old_value = detail.old_value %}
                {% set new_value = detail.new_value %}
                {% set property_name_html = get_property_name(detail.property if detail.property else 'attr', detail.name, old_value, new_value) %}
                {% if property_name_html %}
                  <div class="change-item">
                    <div class="change-description">
                      <i class="fas fa-arrow-right change-icon"></i>
                      <span>{{ property_name_html | safe }}</span>
                    </div>
                  </div>
                {% else %}
                  <div class="change-item">
                    <div class="change-field">
                      <i class="fas fa-edit change-icon"></i>
                      <span class="field-name">
                        {% if detail.name == 'status_id' %}
                          –°—Ç–∞—Ç—É—Å
                        {% elif detail.name == 'done_ratio' %}
                          –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å
                        {% elif detail.name == 'assigned_to_id' %}
                          –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
                        {% elif detail.name == 'priority_id' %}
                          –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç
                        {% elif detail.name == 'project_id' %}
                          –ü—Ä–æ–µ–∫—Ç
                        {% elif detail.name == 'subject' %}
                          –¢–µ–º–∞
                        {% elif detail.name == 'easy_helpdesk_need_reaction' %}
                          –ù—É–∂–Ω–∞ —Ä–µ–∞–∫—Ü–∏—è?
                        {% elif detail.name == '16' %}
                          –ß—Ç–æ –Ω–æ–≤–æ–≥–æ
                        {% else %}
                          {{ detail.name }}
                        {% endif %}
                      </span>
                    </div>
                    <div class="change-values">
                      {% if detail.old_value %}
                      <span class="old-value">
                        {% if detail.name == 'status_id' %}
                          {{ status_names.get(detail.old_value|int, detail.old_value) if detail.old_value and detail.old_value.isdigit() else detail.old_value }}
                        {% elif detail.name == 'assigned_to_id' %}
                          {{ user_names.get(detail.old_value|int, detail.old_value) if detail.old_value and detail.old_value.isdigit() else detail.old_value }}
                        {% elif detail.name == 'project_id' %}
                          {{ project_names.get(detail.old_value|int, detail.old_value) if detail.old_value and detail.old_value.isdigit() else detail.old_value }}
                        {% elif detail.name == 'priority_id' %}
                          {{ priority_names.get(detail.old_value|int, detail.old_value) if detail.old_value and detail.old_value.isdigit() else detail.old_value }}
                        {% elif detail.name == 'done_ratio' %}
                          {{ detail.old_value }}%
                        {% elif detail.name == 'easy_helpdesk_need_reaction' %}
                          {% if detail.old_value == '1' %}–î–∞{% else %}–ù–µ—Ç{% endif %}
                        {% elif detail.name == '16' %}
                          {% if detail.old_value and detail.old_value != '0' %}–î–∞{% else %}–ù–µ—Ç{% endif %}
                        {% else %}
                          {{ detail.old_value }}
                        {% endif %}
                      </span>
                      <i class="fas fa-arrow-right change-arrow"></i>
                      {% endif %}
                      <span class="new-value">
                        {% if detail.name == 'status_id' %}
                          {{ status_names.get(detail.new_value|int, detail.new_value) if detail.new_value and detail.new_value.isdigit() else detail.new_value }}
                        {% elif detail.name == 'assigned_to_id' %}
                          {% if detail.new_value and detail.new_value.isdigit() %}
                            {{ user_names.get(detail.new_value|int, detail.new_value) }}
                          {% else %}
                            –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω
                          {% endif %}
                        {% elif detail.name == 'project_id' %}
                          {{ project_names.get(detail.new_value|int, detail.new_value) if detail.new_value and detail.new_value.isdigit() else detail.new_value }}
                        {% elif detail.name == 'priority_id' %}
                          {{ priority_names.get(detail.new_value|int, detail.new_value) if detail.new_value and detail.new_value.isdigit() else detail.new_value }}
                        {% elif detail.name == 'done_ratio' %}
                          {{ detail.new_value }}%
                        {% elif detail.name == 'easy_helpdesk_need_reaction' %}
                          {{ format_boolean_field(detail.new_value, detail.name) }}
                        {% elif detail.name == '16' %}
                          {{ format_boolean_field(detail.new_value, detail.name) }}
                        {% else %}
                          {% if detail.new_value %}
                            {{ detail.new_value }}
                          {% else %}
                            –ó–Ω–∞—á–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ
                          {% endif %}
                        {% endif %}
                      </span>
                    </div>
                  </div>
                {% endif %}
                {% endfor %}
              </div>
                            {% endif %}

              {% if journal.notes %}
                <div class="history-comment" data-journal-id="{{ journal.id }}" style="position: relative;">
                  <div class="comment-content">
                    {{ journal.notes|safe }}
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<style>
:root {
  --primary-color: #6366f1;
  --secondary-color: #8b5cf6;
  --accent-color: #06d6a0;
  --success-color: #10b981;
  --warning-color: #f59e0b;
  --error-color: #ef4444;
  --info-color: #3b82f6;
  --text-primary: #1f2937;
  --text-secondary: #6b7280;
  --text-muted: #9ca3af;
  --bg-primary: #ffffff;
  --bg-secondary: #f9fafb;
  --bg-tertiary: #f3f4f6;
  --border-color: #e5e7eb;
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  --border-radius: 12px;
  --border-radius-lg: 16px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

[data-theme="dark"] {
  --text-primary: #f9fafb;
  --text-secondary: #d1d5db;
  --text-muted: #d1d5db;
  --bg-primary: #111827;
  --bg-secondary: #1f2937;
  --bg-tertiary: #374151;
  --border-color: #4b5563;
  --success-color: #22c55e;
  --error-color: #f87171;
  --warning-color: #fbbf24;
  --primary-color: #818cf8;
  --secondary-color: #a78bfa;
}

.modern-task-detail {
  min-height: 100vh;
  background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  color: var(--text-primary);
  transition: var(--transition);
}

/* FAB */
.fab-container {
  position: fixed;
  bottom: 7rem; /* –¢–æ—á–Ω–æ –Ω–∞ 5rem –≤—ã—à–µ –∫–Ω–æ–ø–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (2rem + 5rem = 7rem) */
  right: 2rem; /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ —Å –∫–Ω–æ–ø–∫–æ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
  z-index: 1000;
  transition: all 0.3s ease;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è fab-container */
@media (max-width: 768px) {
  .fab-container {
    right: 2rem;
    bottom: 7rem;
  }
}

@media (max-width: 480px) {
  .fab-container {
    right: 2rem;
    bottom: 7rem;
  }
}

.fab {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  border: none;
  cursor: pointer;
  box-shadow: var(--shadow-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  transition: var(--transition);
}

.fab:hover {
  transform: none !important;
  box-shadow: none !important;
}

/* Hero Section */
.hero-section {
  background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
  color: white;
  padding: 3rem 2rem;
  margin-bottom: 2rem;
}

.hero-content {
  max-width: 1200px;
  margin: 0 auto;
}

.breadcrumb {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 2rem;
  font-size: 0.875rem;
  opacity: 0.9;
}

.breadcrumb-link {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: white;
  text-decoration: none;
  transition: none !important;
}

.breadcrumb-link:hover {
  opacity: 1 !important;
}

.breadcrumb-separator {
  opacity: 0.6;
}

.hero-main {
  display: flex;
  align-items: center;
  gap: 2rem;
  margin-bottom: 2rem;
}

.task-status-large {
  flex-shrink: 0;
}

.status-indicator {
  width: 4rem;
  height: 4rem;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
  color: var(--status-color);
  border: 2px solid rgba(255, 255, 255, 0.3);
}

.status-indicator.status-pending {
  animation: pulse 2s infinite;
}

.status-indicator.status-registered {
  animation: bounce 1s ease-in-out;
}

.hero-title {
  font-size: 2.5rem;
  font-weight: 700;
  line-height: 1.2;
  margin: 0 0 0.5rem 0;
}

.hero-subtitle {
  font-size: 1.125rem;
  opacity: 0.9;
  margin: 0;
}

.hero-actions {
  display: flex !important;
  align-items: center !important;
  gap: 1rem !important;
  width: auto !important;
  justify-content: flex-start !important;
  margin-top: 2rem !important;
  flex-wrap: nowrap !important;
}

.button-group {
  display: flex !important;
  align-items: center !important;
  gap: 1rem !important;
  margin: 0 !important;
  flex-wrap: nowrap !important;
}

.action-btn {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 0.5rem !important;
  padding: 0.75rem 1.25rem !important;
  border-radius: 8px !important;
  text-decoration: none !important;
  font-weight: 500 !important;
  transition: all 0.3s ease !important;
  border: none !important;
  cursor: pointer !important;
  white-space: nowrap !important;
  flex-shrink: 0 !important;
  min-width: fit-content !important;
  font-size: 0.9rem !important;
  max-width: none !important;
  flex: 0 0 auto !important;
}

.action-btn.primary {
  background: rgba(255, 255, 255, 0.9) !important;
  color: var(--primary-color) !important;
  backdrop-filter: blur(10px) !important;
  padding: 0.75rem 2rem !important;
}

.action-btn.secondary {
  background: rgba(255, 255, 255, 0.1) !important;
  color: white !important;
  border: 1px solid rgba(255, 255, 255, 0.3) !important;
  padding: 0.75rem 1.5rem !important;
}

.action-btn i {
  font-size: 1rem !important;
  margin-right: 0.5rem !important;
  flex-shrink: 0 !important;
}

.action-btn span {
  display: inline-block !important;
  white-space: nowrap !important;
  overflow: hidden !important;
  text-overflow: ellipsis !important;
  flex-shrink: 0 !important;
}

/* Content Grid */
.content-grid {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 2rem 3rem;
  display: grid;
  gap: 2rem;
}

/* Cards */
.card {
  background: var(--bg-primary);
  border-radius: var(--border-radius-lg);
  box-shadow: var(--shadow-md);
  border: 1px solid var(--border-color);
  transition: none !important;
  overflow: hidden;
  margin-bottom: 2rem !important;
  /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–µ—Ä—Ü–∞–Ω–∏—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö */
  pointer-events: auto !important;
  animation: none !important;
  will-change: auto !important;
  backface-visibility: visible !important;
  isolation: auto !important;
  contain: none !important;
}

.card:hover {
  box-shadow: none !important;
  transform: none !important;
}

/* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è history-card - —É–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø —É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
.history-card {
  margin-bottom: 0 !important;
}

.card-header {
  padding: 1.5rem 2rem;
  border-bottom: 1px solid var(--border-color);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.card-header.collapsible {
  cursor: pointer;
  transition: none !important;
  will-change: auto !important;
  backface-visibility: visible !important;
}

.card-header.collapsible:hover {
  background: var(--bg-primary) !important;
}

.card-title {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--text-primary);
  flex: 1;
}

.card-title i {
  color: var(--primary-color);
}

.count-badge {
  background: var(--primary-color);
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 50px;
  font-size: 0.75rem;
  font-weight: 600;
}

.toggle-icon {
  color: var(--text-secondary);
  transition: none !important;
  font-size: 1rem;
  margin-left: 1rem;
  will-change: auto !important;
  backface-visibility: visible !important;
}

.toggle-icon.rotated {
  transform: rotate(180deg);
}

.card-content {
  padding: 2rem;
  transition: none !important;
  overflow: hidden;
  will-change: auto !important;
  backface-visibility: visible !important;
  /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–µ—Ä—Ü–∞–Ω–∏—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö */
  pointer-events: auto !important;
  animation: none !important;
  isolation: auto !important;
  contain: none !important;
}

.card-content.collapsed {
  max-height: 0;
  padding: 0 2rem;
  opacity: 0;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 1rem;
}

/* Details Grid */
.details-grid {
  display: grid;
  gap: 3rem;
}

.detail-section {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.section-title {
  font-size: 1.125rem;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
  padding-bottom: 0.75rem;
  border-bottom: 2px solid var(--primary-color);
  display: inline-block;
}

.detail-items {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.detail-item {
  display: flex;
  align-items: flex-start;
  gap: 1rem;
  padding: 1rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  transition: var(--transition);
}

.detail-item:hover {
  background: var(--bg-tertiary);
  transform: translateX(4px);
}

.detail-icon {
  width: 2.5rem;
  height: 2.5rem;
  background: var(--primary-color);
  color: white;
  border-radius: var(--border-radius);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.detail-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.detail-label {
  font-size: 0.875rem;
  font-weight: 500;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.detail-value {
  font-size: 1rem;
  color: var(--text-primary);
  font-weight: 500;
}

/* Badges */
.badge {
  display: inline-flex;
  align-items: center;
  padding: 0.5rem 1rem;
  border-radius: 50px;
  font-size: 0.875rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.badge.high {
  background: rgba(239, 68, 68, 0.1);
  color: var(--error-color);
  border: 1px solid rgba(239, 68, 68, 0.2);
}

.badge.normal {
  background: rgba(99, 102, 241, 0.1);
  color: var(--primary-color);
  border: 1px solid rgba(99, 102, 241, 0.2);
}

/* Progress Bar */
.progress-container {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.progress-bar {
  flex: 1;
  height: 8px;
  background: var(--bg-tertiary);
  border-radius: 4px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
  border-radius: 4px;
  transition: width 0.5s ease;
}

.progress-text {
  font-weight: 600;
  color: var(--primary-color);
  font-size: 0.875rem;
}

/* User Avatars */
.user-avatar {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.avatar-circle {
  width: 2.5rem;
  height: 2.5rem;
  border-radius: 50%;
  background: var(--primary-color);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  font-size: 1rem;
  flex-shrink: 0;
  text-transform: uppercase;
}

.avatar-circle.assigned {
  background: var(--accent-color);
}

.avatar-circle.history {
  width: 2rem;
  height: 2rem;
  font-size: 0.75rem;
  background: var(--secondary-color);
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
  text-transform: uppercase;
}

.user-avatar-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}

.user-name {
  font-weight: 500;
  color: var(--text-primary);
}

/* Timeline */
.timeline-items {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
}

.timeline-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border-left: 4px solid var(--primary-color);
  transition: none !important;
  will-change: auto !important;
  backface-visibility: visible !important;
  isolation: auto !important;
  contain: none !important;
}

.timeline-item:hover {
  background: var(--bg-secondary) !important;
  transform: none !important;
}

.timeline-dot {
  width: 1rem;
  height: 1rem;
  border-radius: 50%;
  flex-shrink: 0;
}

.timeline-dot.created { background: var(--primary-color); }
.timeline-dot.started { background: var(--accent-color); }
.timeline-dot.deadline { background: var(--warning-color); }
.timeline-dot.closed { background: var(--success-color); }
.timeline-dot.updated { background: var(--text-muted); }

.timeline-content {
  flex: 1;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.timeline-label {
  font-weight: 500;
  color: var(--text-primary);
}

.timeline-date {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 0.25rem;
}

.date-main {
  font-weight: 600;
  color: var(--text-primary);
}

.date-time {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

/* Email Link */
.email-link {
  color: var(--primary-color);
  text-decoration: none;
  font-weight: 500;
  transition: none !important;
  font-size: 0.875rem;
}

.email-link:hover {
  color: var(--primary-color) !important;
  text-decoration: none !important;
}

.email-cc {
  color: var(--text-secondary);
  font-size: 0.875rem;
}

/* Description */
.description-content {
  line-height: 1.7;
  color: var(--text-primary);
}

/* Attachments */
.attachments-grid {
  display: grid;
  gap: 1rem;
  margin-bottom: 2rem !important;
}

.attachment-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  transition: none !important;
  will-change: auto !important;
  backface-visibility: visible !important;
}

.attachment-item:hover {
  background: var(--bg-secondary) !important;
  transform: none !important;
  box-shadow: none !important;
}

.attachment-icon {
  width: 2.5rem;
  height: 2.5rem;
  background: var(--primary-color);
  color: white;
  border-radius: var(--border-radius);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.125rem;
}

.attachment-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.attachment-name {
  font-weight: 500;
  color: var(--text-primary);
}

.attachment-size {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.attachment-download {
  width: 2.5rem;
  height: 2.5rem;
  border: none;
  background: var(--accent-color);
  color: white;
  border-radius: var(--border-radius);
  cursor: pointer;
  transition: var(--transition);
}

.attachment-download:hover {
  transform: none !important;
}

.attachment-download:disabled {
  opacity: 0.7;
  cursor: not-allowed;
  transform: none;
}

/* History */
.filter-btn {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  cursor: pointer;
  color: var(--text-primary);
  transition: var(--transition);
}

.filter-btn:hover {
  background: var(--bg-secondary) !important;
}

.history-filters {
  padding: 1rem 2rem;
  border-bottom: 1px solid var(--border-color);
  background: var(--bg-secondary);
  /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–µ—Ä—Ü–∞–Ω–∏—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö */
  pointer-events: auto !important;
  transition: none !important;
  animation: none !important;
  will-change: auto !important;
  backface-visibility: visible !important;
  isolation: auto !important;
  contain: none !important;
}

.filter-chips {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.filter-chip {
  padding: 0.5rem 1rem;
  border: 1px solid var(--border-color);
  background: var(--bg-primary);
  color: var(--text-secondary);
  border-radius: 50px;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.875rem;
}

.filter-chip.active,
.filter-chip:hover {
  background: var(--bg-secondary) !important;
  color: var(--text-primary) !important;
  border-color: var(--border-color) !important;
}

.history-timeline {
  display: flex;
  flex-direction: column;
  gap: 2rem;
  /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–µ—Ä—Ü–∞–Ω–∏—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö */
  pointer-events: auto !important;
  transition: none !important;
  animation: none !important;
  will-change: auto !important;
  backface-visibility: visible !important;
  isolation: auto !important;
  contain: none !important;
}

.history-item {
  display: flex;
  gap: 1rem;
  padding: 1.5rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  transition: none !important;
  will-change: auto !important;
  backface-visibility: visible !important;
  isolation: auto !important;
  contain: none !important;
}

.history-item:hover {
  background: var(--bg-secondary) !important;
  box-shadow: none !important;
  transform: none !important;
}

.history-avatar {
  flex-shrink: 0 !important;
  display: flex !important;
  align-items: center !important;
  gap: 0.5rem !important;
  position: relative !important;
  min-height: 2rem !important;
}

.history-content {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.history-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.history-user {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.history-time {
  font-size: 0.875rem;
  color: var(--text-secondary);
}

.history-changes {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
}

.change-item {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 0.75rem;
  background: var(--bg-primary);
  border-radius: var(--border-radius);
  border-left: 3px solid var(--warning-color);
}

.change-field {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  min-width: 8rem;
}

.change-icon {
  color: var(--warning-color);
}

.field-name {
  font-weight: 500;
  color: var(--text-primary);
}

.change-values {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  flex: 1;
}

.old-value {
  color: var(--error-color);
  text-decoration: line-through;
}

.new-value {
  color: var(--success-color);
  font-weight: 500;
}



[data-theme="dark"] .change-item {
  background: #2d3748 !important;
  border-left-color: #fbbf24 !important;
}

[data-theme="dark"] .history-item {
  background: #1a202c !important;
  border: 1px solid #4a5568 !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –≤—Å–µ—Ö span –≤ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö –∏—Å—Ç–æ—Ä–∏–∏ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
[data-theme="dark"] .history-item span,
[data-theme="dark"] .change-item span {
  color: #ffffff !important;
}



.change-arrow {
  color: var(--text-muted);
  font-size: 0.75rem;
}

.change-description {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.95rem;
  line-height: 1.5;
  padding: 0.5rem 0;
}

.change-description .change-icon {
  color: var(--primary-color);
  font-size: 0.85rem;
  flex-shrink: 0;
}

.change-description b {
  font-weight: 600;
  color: var(--text-primary);
}

.history-comment {
  padding: 1rem;
  background: #ffffff;
  border-radius: 8px;
  border-left: 3px solid #3b82f6;
  position: relative !important;
  margin-bottom: 1rem;
}

.comment-content {
  line-height: 1.6;
  color: var(--text-primary);
  word-wrap: break-word;
  word-break: break-all;
  overflow-wrap: break-word;
  white-space: pre-wrap;
  max-width: 100%;
  hyphens: auto;
}

/* Comment Form */
.comment-section {
  margin-bottom: 2rem !important;
  padding: 1.5rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–µ—Ä—Ü–∞–Ω–∏—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö */
  pointer-events: auto !important;
  transition: none !important;
  animation: none !important;
  will-change: auto !important;
  backface-visibility: visible !important;
  isolation: auto !important;
  contain: none !important;
}

.comment-button {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  background: var(--primary-color);
  color: white;
  border: none;
  border-radius: var(--border-radius);
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: none !important;
  will-change: auto !important;
  backface-visibility: visible !important;
}

.comment-button:hover {
  background: var(--primary-color) !important;
  transform: none !important;
  box-shadow: none !important;
}

.comment-form {
  display: none;
  margin-top: 1rem;
}

.comment-form .form-group {
  margin-bottom: 1rem;
}

.comment-form .form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: var(--text-primary);
}

.comment-form .form-control {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  font-size: 0.875rem;
  background: var(--bg-primary);
  color: var(--text-primary);
  transition: var(--transition);
  resize: vertical;
  min-height: 100px;
}

.comment-form .form-control:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.form-actions {
  display: flex;
  gap: 1rem;
  justify-content: flex-end;
}

.cancel-button,
.submit-button {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: var(--border-radius);
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.cancel-button {
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border-color);
}

.cancel-button:hover {
  background: var(--bg-tertiary) !important;
  color: var(--text-secondary) !important;
}

.submit-button {
  background: var(--success-color);
}

/* Email Form */
.email-section {
  margin-bottom: 2rem !important;
  padding: 1.5rem;
  background: var(--bg-secondary);
  border-radius: var(--border-radius);
  border: 1px solid var(--border-color);
  /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–µ—Ä—Ü–∞–Ω–∏—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö */
  pointer-events: auto !important;
  transition: none !important;
  animation: none !important;
  will-change: auto !important;
  backface-visibility: visible !important;
  isolation: auto !important;
  contain: none !important;
}

.email-button {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  background: var(--info-color);
  color: white;
  border: none;
  border-radius: var(--border-radius);
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
}

.email-button:hover {
  background: var(--info-color) !important;
  transform: none !important;
  box-shadow: none !important;
}

.email-form {
  display: none;
  margin-top: 1rem;
}

.email-form-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1rem;
}

.email-form .form-group {
  margin-bottom: 1rem;
}

.email-form .form-group.full-width {
  grid-column: 1 / -1;
}

.email-form .form-group.checkbox-group {
  grid-column: 1 / -1;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.email-form .form-label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 600;
  color: var(--text-primary);
}

.email-form .form-control {
  width: 100%;
  padding: 0.75rem;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  font-size: 0.875rem;
  background: var(--bg-primary);
  color: var(--text-primary);
  transition: var(--transition);
  resize: vertical;
}

.email-form .form-control:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
}

.email-form .form-check-input {
  margin-right: 0.5rem;
}

.email-form .form-check-label {
  font-weight: 500;
  color: var(--text-primary);
}

  .email-form .form-text {
  font-size: 0.75rem;
  color: var(--text-secondary);
  margin-top: 0.25rem;
}

.submit-button:hover {
  background: var(--success-color) !important;
  transform: none !important;
  box-shadow: none !important;
}

.submit-button:disabled {
  background: var(--text-muted);
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.ajax-button {
  background: var(--accent-color) !important;
  position: relative;
  overflow: hidden;
}

.ajax-button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.5s;
}

.ajax-button:hover::before {
  left: -100% !important;
}

.ajax-button:hover {
  background: var(--accent-color) !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è */
.comment-actions {
  position: absolute !important;
  top: 8px !important;
  right: 8px !important;
  opacity: 0 !important;
  transition: opacity 0.3s ease, visibility 0.3s ease !important;
  z-index: 999 !important;
  visibility: hidden !important;
}

/* –ü–æ–∫–∞–∑ –∫–Ω–æ–ø–∫–∏ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π */
.history-comment:hover .comment-actions {
  opacity: 1 !important;
  visibility: visible !important;
}

/* –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ */
.comment-actions.show {
  opacity: 1 !important;
  visibility: visible !important;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã */
@media (max-width: 768px) {
  .comment-actions {
    opacity: 1 !important;
    visibility: visible !important;
  }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ–Ω—Å–æ—Ä–Ω—ã—Ö —ç–∫—Ä–∞–Ω–æ–≤ - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã */
@media (hover: none) {
  .comment-actions {
    opacity: 1 !important;
    visibility: visible !important;
  }
}

/* –í–†–ï–ú–ï–ù–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –û–¢–õ–ê–î–ö–ò - –£–î–ê–õ–ò–¢–¨ –ü–û–°–õ–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø */
.comment-actions.debug-visible {
  opacity: 1 !important;
  visibility: visible !important;
  background: rgba(255, 0, 0, 0.1) !important;
  border: 1px solid red !important;
}

/* –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –ø–æ–∫–∞–∑–∞ –ø—Ä–∏ hover */
.history-comment:hover .comment-actions,
.history-comment:focus .comment-actions,
.history-comment:focus-within .comment-actions {
  opacity: 1 !important;
  visibility: visible !important;
}

.delete-comment-btn {
  background: rgba(239, 68, 68, 0.1) !important;
  border: 1px solid rgba(239, 68, 68, 0.2) !important;
  color: var(--error-color) !important;
  padding: 4px 6px !important;
  border-radius: 6px !important;
  font-size: 12px !important;
  cursor: pointer !important;
  transition: all 0.3s ease !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  width: 24px !important;
  height: 24px !important;
  backdrop-filter: blur(8px) !important;
}

.delete-comment-btn:hover {
  background: rgba(239, 68, 68, 0.1) !important;
  color: var(--error-color) !important;
  border-color: rgba(239, 68, 68, 0.2) !important;
  transform: none !important;
  box-shadow: none !important;
}

.delete-comment-btn:active {
  transform: translateY(0) scale(1) !important;
}

.delete-comment-btn i {
  font-size: 10px !important;
}

/* Responsive */
@media (max-width: 768px) {
  .hero-section {
    padding: 2rem 1rem;
  }

  .hero-main {
    flex-direction: column;
    text-align: center;
    gap: 1rem;
  }

  .hero-title {
    font-size: 2rem;
  }

  .hero-actions {
    flex-direction: row !important;
    flex-wrap: wrap !important;
    justify-content: flex-start !important;
    gap: 1rem !important;
  }

  .button-group {
    flex-direction: row !important;
    justify-content: flex-start !important;
    width: auto !important;
    flex-wrap: nowrap !important;
  }

  .action-btn {
    width: auto !important;
    flex: 0 0 auto !important;
  }

  .content-grid {
    padding: 0 1rem 2rem;
  }

  .card-content {
    padding: 1.5rem;
  }

  .details-grid {
    gap: 2rem;
  }

  .detail-item {
    flex-direction: column;
    gap: 0.75rem;
    text-align: center;
  }

  .timeline-item {
    flex-direction: column;
    gap: 0.75rem;
    text-align: center;
  }

  .history-item {
    padding: 1rem;
  }

  .filter-chips {
    justify-content: center;
  }
}

@media (max-width: 480px) {
  .hero-actions {
    flex-direction: column !important;
    align-items: stretch !important;
  }

  .button-group {
    flex-direction: column !important;
    width: 100% !important;
    align-items: stretch !important;
  }

  .action-btn {
    width: 100% !important;
  }
}

/* Animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.8;
    transform: scale(1.05);
  }
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% {
    transform: translateY(0);
  }
  40% {
    transform: translateY(-5px);
  }
  60% {
    transform: translateY(-3px);
  }
}

.card {
  animation: fadeInUp 0.5s ease-out;
}

.card:nth-child(1) { animation-delay: 0.1s; }
.card:nth-child(2) { animation-delay: 0.2s; }
.card:nth-child(3) { animation-delay: 0.3s; }
.card:nth-child(4) { animation-delay: 0.4s; }

/* ========================================
   COMPACT MODE - Reduced vertical spacing
   ======================================== */
.modern-task-detail.compact-mode .hero-section {
  padding: 1.5rem 2rem !important;
  margin-bottom: 1rem !important;
}

.modern-task-detail.compact-mode .breadcrumb {
  margin-bottom: 1rem !important;
  font-size: 0.8rem !important;
}

.modern-task-detail.compact-mode .hero-title {
  font-size: 1.75rem !important;
  margin-bottom: 0.25rem !important;
}

.modern-task-detail.compact-mode .hero-subtitle {
  font-size: 0.875rem !important;
}

.modern-task-detail.compact-mode .task-status-large {
  width: 48px !important;
  height: 48px !important;
}

.modern-task-detail.compact-mode .task-status-large .status-indicator {
  width: 48px !important;
  height: 48px !important;
}

.modern-task-detail.compact-mode .task-status-large i {
  font-size: 1.5rem !important;
}

.modern-task-detail.compact-mode .hero-actions {
  gap: 0.5rem !important;
}

.modern-task-detail.compact-mode .action-btn {
  padding: 0.5rem 1rem !important;
  font-size: 0.875rem !important;
}

.modern-task-detail.compact-mode .action-btn i {
  font-size: 0.875rem !important;
}

/* Compact Cards */
.modern-task-detail.compact-mode .card {
  margin-bottom: 1rem !important;
}

.modern-task-detail.compact-mode .card-header {
  padding: 1rem 1.5rem !important;
}

.modern-task-detail.compact-mode .card-title h2 {
  font-size: 1rem !important;
}

.modern-task-detail.compact-mode .card-title i {
  font-size: 1rem !important;
}

.modern-task-detail.compact-mode .card-content {
  padding: 1rem 1.5rem !important;
}

/* Compact Detail Sections */
.modern-task-detail.compact-mode .details-grid {
  gap: 1rem !important;
}

.modern-task-detail.compact-mode .detail-section {
  gap: 0.75rem !important;
}

.modern-task-detail.compact-mode .section-title {
  font-size: 0.95rem !important;
  padding-bottom: 0.5rem !important;
  margin-bottom: 0.5rem !important;
}

.modern-task-detail.compact-mode .detail-items {
  gap: 0.5rem !important;
}

.modern-task-detail.compact-mode .detail-item {
  padding: 0.75rem !important;
}

.modern-task-detail.compact-mode .detail-icon {
  width: 32px !important;
  height: 32px !important;
  font-size: 0.875rem !important;
}

.modern-task-detail.compact-mode .detail-label {
  font-size: 0.75rem !important;
}

.modern-task-detail.compact-mode .detail-value {
  font-size: 0.875rem !important;
}

/* Compact Timeline */
.modern-task-detail.compact-mode .timeline-items {
  gap: 0.5rem !important;
}

.modern-task-detail.compact-mode .timeline-item {
  padding: 0.5rem !important;
}

.modern-task-detail.compact-mode .timeline-dot {
  width: 10px !important;
  height: 10px !important;
}

.modern-task-detail.compact-mode .timeline-label {
  font-size: 0.75rem !important;
}

.modern-task-detail.compact-mode .date-main {
  font-size: 0.875rem !important;
}

.modern-task-detail.compact-mode .date-time {
  font-size: 0.75rem !important;
}

/* Compact Badges */
.modern-task-detail.compact-mode .status-badge,
.modern-task-detail.compact-mode .priority-badge .badge {
  padding: 4px 10px !important;
  font-size: 0.75rem !important;
}

/* Compact History */
.modern-task-detail.compact-mode .history-item {
  padding: 0.75rem !important;
  margin-bottom: 0.5rem !important;
}

.modern-task-detail.compact-mode .history-header {
  margin-bottom: 0.5rem !important;
}

.modern-task-detail.compact-mode .history-user {
  font-size: 0.875rem !important;
}

.modern-task-detail.compact-mode .history-date {
  font-size: 0.75rem !important;
}

.modern-task-detail.compact-mode .history-content {
  font-size: 0.875rem !important;
}

/* Compact Comment Section */
.modern-task-detail.compact-mode .comment-section {
  margin-bottom: 1rem !important;
}

.modern-task-detail.compact-mode .comment-button,
.modern-task-detail.compact-mode .email-button {
  padding: 0.5rem 1rem !important;
  font-size: 0.875rem !important;
}

.modern-task-detail.compact-mode .form-group {
  margin-bottom: 0.75rem !important;
}

.modern-task-detail.compact-mode .form-label {
  font-size: 0.875rem !important;
  margin-bottom: 0.25rem !important;
}

/* Compact Attachments */
.modern-task-detail.compact-mode .attachment-item {
  padding: 0.5rem !important;
}

.modern-task-detail.compact-mode .attachment-icon {
  width: 32px !important;
  height: 32px !important;
  font-size: 1rem !important;
}

.modern-task-detail.compact-mode .attachment-name {
  font-size: 0.875rem !important;
}

.modern-task-detail.compact-mode .attachment-size {
  font-size: 0.75rem !important;
}

/* Compact Status/Priority Management */
.modern-task-detail.compact-mode .task-status-changer,
.modern-task-detail.compact-mode .task-priority-changer,
.modern-task-detail.compact-mode .task-assignee-changer {
  padding: 0.75rem !important;
}

.modern-task-detail.compact-mode .loading-placeholder {
  font-size: 0.75rem !important;
}

/* Toggle Button for Compact Mode */
.compact-mode-toggle {
  position: fixed;
  top: 80px;
  right: 2rem;
  z-index: 999;
  background: var(--bg-primary);
  border: 1px solid var(--border-color);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: var(--shadow-md);
  transition: all 0.3s ease;
  color: var(--text-primary);
}

.compact-mode-toggle:hover {
  background: var(--primary-color);
  color: white;
  transform: scale(1.05);
}

.compact-mode-toggle i {
  font-size: 1rem;
}

@media (max-width: 768px) {
  .compact-mode-toggle {
    top: 70px;
    right: 1rem;
    width: 36px;
    height: 36px;
  }
}

/* Print Styles */
@media print {
  .fab-container,
  .hero-actions,
  .filter-btn,
  .history-filters,
  .compact-mode-toggle {
    display: none !important;
  }

  .hero-section {
    background: none !important;
    color: black !important;
  }

  .card {
    box-shadow: none !important;
    border: 1px solid #ccc !important;
    margin-bottom: 1rem !important;
  }
}

/* –ö–Ω–æ–ø–∫–∞ ¬´–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É¬ª ‚Äì –≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º–∞ –Ω–∞ –ª—é–±–æ–º —Ñ–æ–Ω–µ */
.action-btn.back-btn {
  background: rgba(255, 255, 255, 0.9) !important; /* —Å–≤–µ—Ç–ª—ã–π –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π */
  color: var(--primary-color) !important;
  border: 1px solid rgba(255, 255, 255, 0.6) !important;
  backdrop-filter: blur(6px) !important;
}

.action-btn.back-btn:hover {
  background: var(--primary-color) !important;
  color: #ffffff !important;
}

[data-theme="dark"] .action-btn.back-btn {
  background: rgba(17, 24, 39, 0.9) !important; /* —Ç—ë–º–Ω—ã–π —Å—Ç–µ–∫–ª—è–Ω–Ω—ã–π —Ñ–æ–Ω */
  color: var(--primary-color) !important;
  border: 1px solid rgba(255, 255, 255, 0.2) !important;
}

/* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –∏ –º–µ–Ω—é */
.action-button-container {
  position: relative;
  display: inline-block;
  margin-left: auto;
}

.action-btn {
  width: 24px;
  height: 24px;
  border: none;
  background: rgba(0, 0, 0, 0.08);
  border-radius: 4px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 12px;
  color: #666;
  transition: all 0.2s ease;
}

.action-btn:hover {
  background: rgba(0, 0, 0, 0.1);
  color: #333;
}

.action-menu {
  position: absolute;
  top: 100%;
  left: 0;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  min-width: 110px;
  opacity: 0;
  visibility: hidden;
  transform: translateY(-5px);
  transition: all 0.2s ease;
  z-index: 1000;
  margin-top: 2px;
}

.action-menu.show {
  opacity: 1;
  visibility: visible;
  transform: translateY(0);
}

.menu-item {
  display: flex !important;
  align-items: center !important;
  gap: 3px !important;
  padding: 2px 6px !important;
  cursor: pointer !important;
  font-size: 10px !important;
  color: #374151 !important;
  border-bottom: 1px solid #f3f4f6 !important;
  transition: background-color 0.2s ease !important;
  min-height: 16px !important;
  line-height: 1 !important;
}

.menu-item:last-child {
  border-bottom: none;
}

.menu-item:hover {
  background: #f9fafb;
}

.menu-item.edit-btn:hover {
  background: rgba(59, 130, 246, 0.1);
  color: #2563eb;
}

.menu-item.delete-btn:hover {
  background: rgba(239, 68, 68, 0.1);
  color: #dc2626;
}

.menu-item i {
  font-size: 9px !important;
  width: 10px !important;
  text-align: center !important;
}

.menu-item.edit-btn i {
  color: #2563eb;
}

.menu-item.delete-btn i {
  color: #dc2626;
}


.custom-menu-item.delete-item i {
  color: #dc2626 !important;
}

/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–æ–∫ */
.custom-menu-item i.fa-edit {
  color: #2563eb !important;
}

.custom-menu-item i.fa-trash {
  color: #dc2626 !important;
}
@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-5px) scale(0.98);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}
.custom-context-menu.show {
  opacity: 1 !important;
  visibility: visible !important;
  transform: translateY(0) scale(1) !important;
  animation: slideIn 0.2s ease;
}
@media (max-width: 768px) {
  .comment-actions-trigger {
    width: 16px !important;
    height: 16px !important;
  }

  .custom-context-menu {
    min-width: 110px !important;
    max-width: 130px !important;
  }

  .custom-menu-item {
    padding: 1px 4px !important;
    font-size: 0.6rem !important;
    min-height: 14px !important;
  }
}

/* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é */
[data-theme="dark"] .comment-actions-menu {
  background: var(--bg-primary);
  border-color: var(--border-color);
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3), 0 4px 10px rgba(0, 0, 0, 0.2);
}

[data-theme="dark"] .comment-action-item {
  border-bottom-color: rgba(255, 255, 255, 0.1);
}

[data-theme="dark"] .comment-action-item:hover {
  background: var(--bg-secondary) !important;
}

[data-theme="dark"] .comment-action-item.delete-action:hover {
  background: rgba(239, 68, 68, 0.2) !important;
}

[data-theme="dark"] .comment-action-item[data-action="edit"]:hover {
  background: rgba(59, 130, 246, 0.2) !important;
}

[data-theme="dark"] .history-comment {
  background: #23272f !important;
  color: #f3f4f6 !important;
}
[data-theme="dark"] .history-comment .comment-content {
  color: #f3f4f6 !important;
  word-wrap: break-word;
  word-break: break-all;
  overflow-wrap: break-word;
  white-space: pre-wrap;
  max-width: 100%;
  hyphens: auto;
}
</style>
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
const currentUserData = {
    username: '{{ current_user.username }}',
    fullName: '{{ current_user.full_name or current_user.username }}',
    firstLetter: '{{ (current_user.full_name or current_user.username)[0]|upper }}'
};

// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–ª–µ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é
document.addEventListener('DOMContentLoaded', function() {
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
    const triggers = document.querySelectorAll('.comment-actions-trigger');
    triggers.forEach(trigger => {
        trigger.style.opacity = '0.5';
        trigger.style.visibility = 'visible';
        trigger.style.display = 'flex';
        trigger.style.transform = 'scale(1)';
    });
    // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–º—É –º–µ–Ω—é
    const menus = document.querySelectorAll('.custom-context-menu');
    menus.forEach(menu => {
        menu.style.position = 'absolute';
        menu.style.top = '100%';
        menu.style.left = '0';
        menu.style.minWidth = '120px';
        menu.style.maxWidth = '140px';
        menu.style.borderRadius = '6px';
        menu.style.zIndex = '1000';
        menu.style.background = '#ffffff';
        menu.style.border = '1px solid #e5e7eb';
        menu.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
        menu.style.marginTop = '2px';
    });

    const items = document.querySelectorAll('.custom-menu-item');
    items.forEach(item => {
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.gap = '6px';
        item.style.padding = '4px 8px';
        item.style.fontSize = '0.75rem';
        item.style.lineHeight = '1.2';
        item.style.minHeight = '24px';
        item.style.cursor = 'pointer';
        item.style.color = '#374151';
        item.style.borderBottom = '1px solid rgba(0, 0, 0, 0.05)';
    });

    const icons = document.querySelectorAll('.custom-menu-item i');
    icons.forEach(icon => {
        icon.style.fontSize = '0.7rem';
        icon.style.width = '12px';
        icon.style.display = 'inline-block';
        icon.style.flexShrink = '0';
        icon.style.textAlign = 'center';
    });
});

// Email —Ñ—É–Ω–∫—Ü–∏–∏
function toggleEmailInput() {
    const emailForm = document.getElementById('emailForm');
    const emailButton = document.querySelector('.email-button');

    if (emailForm.style.display === 'none' || emailForm.style.display === '') {
        emailForm.style.display = 'block';
        emailButton.style.display = 'none';

        // –í—Å—Ç–∞–≤–ª—è–µ–º HTML –ø–æ–¥–ø–∏—Å—å –≤ –ø–æ–ª–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        insertEmailSignature();

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–º—É –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ñ–∞–π–ª–æ–≤
        if (typeof updateEmailFormTheme === 'function') {
            updateEmailFormTheme();
        }

        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        const recipientField = emailForm.querySelector('input[name="recipient"]');
        if (recipientField) {
            recipientField.focus();
        }
    } else {
        emailForm.style.display = 'none';
        emailButton.style.display = 'block';
        // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
        emailForm.reset();
    }
}

function insertEmailSignature() {
    // –ü–æ–¥–ø–∏—Å—å –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ email
    // –§—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    if (typeof window.quillEditor !== 'undefined' && window.quillEditor && typeof window.quillEditor.setText === 'function') {
        // –û—á–∏—â–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–æ—Ä–º—ã
        window.quillEditor.setText('');
    }
}

function disableEmailSubmitButton() {
    const submitBtn = document.getElementById('submitEmailBtn');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>–û—Ç–ø—Ä–∞–≤–∫–∞...</span>';
    }
}

async function submitEmailAjax(event) {
    event.preventDefault();

    const form = document.getElementById('emailForm');
    const formData = new FormData(form);

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ä–º—ã
    const recipient = formData.get('recipient')?.trim();
    const subject = formData.get('subject')?.trim();

    // –ü–æ–ª—É—á–∞–µ–º HTML-–∫–æ–Ω—Ç–µ–Ω—Ç –∏–∑ Quill.js
    const message = (typeof window.quillEditor !== 'undefined' && window.quillEditor && typeof window.quillEditor.root !== 'undefined') ? window.quillEditor.root.innerHTML : formData.get('message')?.trim();

    const cc = formData.get('cc')?.trim();
    const sendEmail = formData.get('send_email') === 'y';

    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (!recipient) {
        showNotification('Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω', 'error');
        return;
    }
    if (!subject) {
        showNotification('–¢–µ–º–∞ –ø–∏—Å—å–º–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞', 'error');
        return;
    }
    if (!message) {
        showNotification('–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω', 'error');
        return;
    }

    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
    disableEmailSubmitButton();

    try {
        const taskId = getTaskIdFromUrl();

        // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω –∏–∑ —Ñ–æ—Ä–º—ã
        const csrfToken = form.querySelector('input[name="csrf_token"]')?.value;

        // –°–æ–∑–¥–∞–µ–º FormData –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–æ–≤
        const formDataToSend = new FormData();
        const sender = formData.get('sender')?.trim();

        // –î–æ–±–∞–≤–ª—è–µ–º HTML –ø–æ–¥–ø–∏—Å—å –∫ —Å–æ–æ–±—â–µ–Ω–∏—é
        const signatureHtml = `{{ email_signature_html|safe }}`;
        const messageWithSignature = message + '\n\n' + signatureHtml;

        formDataToSend.append('sender', sender || '');
        formDataToSend.append('recipient', recipient);
        formDataToSend.append('subject', subject);
        formDataToSend.append('message', messageWithSignature);
        formDataToSend.append('cc', cc || '');
        formDataToSend.append('send_email', sendEmail ? 'y' : 'n');

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –∏–∑ —Ñ–æ—Ä–º—ã
        const fileInput = document.getElementById('fileInput');
        if (fileInput && fileInput.files) {
            for (let i = 0; i < fileInput.files.length; i++) {
                formDataToSend.append('attachments', fileInput.files[i]);
            }
        }

        const headers = {
            'X-Requested-With': 'XMLHttpRequest'
        };

        // –î–æ–±–∞–≤–ª—è–µ–º CSRF —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }

        const response = await fetch(`/tasks/api/task/${taskId}/send-email`, {
            method: 'POST',
            headers: headers,
            body: formDataToSend
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();

        if (data.success) {
            showNotification(data.message, 'success');

            // –ù–û–í–´–ô –ö–û–î: –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ –∏—Å—Ç–æ—Ä–∏—é
            try {
                const attachmentCount = document.getElementById('fileInput')?.files?.length || 0;
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—É—é –≤–µ—Ä—Å–∏—é —Å–æ–æ–±—â–µ–Ω–∏—è (–±–µ–∑ HTML —Ç–µ–≥–æ–≤)
                const plainTextMessage = message.replace(/<[^>]+>/g, '').trim();
                addEmailCommentToHistory(recipient, subject, plainTextMessage, cc, attachmentCount);
            } catch (commentError) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é:', commentError);
            }

            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –∏ —Å–∫—Ä—ã–≤–∞–µ–º –µ—ë
            form.reset();
            toggleEmailInput();
        } else {
            showNotification(data.error, 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ email:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ email: ' + error.message, 'error');
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
        const submitBtn = document.getElementById('submitEmailBtn');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-envelope"></i> <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å email</span>';
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ email –≤ DOM
function addEmailCommentToHistory(recipient, subject, message, cc = null, attachments = null) {
    const historyTimeline = document.querySelector('.history-timeline');
    if (!historyTimeline) {
        console.error('–ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞—á–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return;
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è (–≤—Ä–µ–º–µ–Ω–Ω—ã–π)
    const tempJournalId = 'temp_' + Date.now();

    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ dd.mm.yyyy HH:MM
    const now = new Date();
    const timeString = now.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è (—Ç–∞–∫–æ–π –∂–µ –∫–∞–∫ –≤ Python –∫–æ–¥–µ)
    let commentLines = [`–ü–æ–ª—É—á–∞—Ç–µ–ª—å: ${recipient}`];

    if (cc) {
        commentLines.push(`–ö–æ–ø–∏—è: ${cc}`);
    }

    if (attachments && attachments > 0) {
        commentLines.push(`–ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è: ${attachments} —Ñ–∞–π–ª(–æ–≤)`);
    }

    // –î–æ–±–∞–≤–ª—è–µ–º —Å–∞–º–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
    commentLines.push('', message);

    const commentText = commentLines.join('\n');

    // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    const newCommentHTML = `
        <div class="history-item" data-type="comments">
            <div class="history-avatar">
                <div class="avatar-circle history">
                    ${currentUserData.firstLetter}
                </div>
            </div>

            <div class="history-content">
                <div class="history-header">
                    <div class="history-user">
                        <span class="user-name">${currentUserData.fullName}</span>
                        <span class="history-time">${timeString}</span>
                    </div>
                </div>

                <div class="history-comment" data-journal-id="${tempJournalId}">
                    <div class="comment-content">
                        ${commentText.replace(/\n/g, '<br>')}
                    </div>
                </div>
            </div>
        </div>
    `;

    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –∏—Å—Ç–æ—Ä–∏–∏ (—á—Ç–æ–±—ã –±—ã–ª —Å–≤–µ—Ä—Ö—É)
    historyTimeline.insertAdjacentHTML('afterbegin', newCommentHTML);

    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∞–Ω–∏–º–∞—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è
    const newComment = historyTimeline.querySelector('.history-item[data-type="comments"]');
    if (newComment) {
        newComment.style.opacity = '0.5';
        newComment.style.transform = 'translateY(-10px)';
        setTimeout(() => {
            newComment.style.transition = 'all 0.3s ease';
            newComment.style.opacity = '1';
            newComment.style.transform = 'translateY(0)';
        }, 100);
    }

    console.log('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–± –æ—Ç–ø—Ä–∞–≤–∫–µ email –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏—Å—Ç–æ—Ä–∏—é');
}

// –ù–æ–≤–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –∏ –º–µ–Ω—é
function toggleActionMenu(journalId) {
  console.log('toggleActionMenu called with journalId:', journalId);
  const menu = document.getElementById(`menu-${journalId}`);
  console.log('Found menu:', menu);

  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –º–µ–Ω—é
  const allMenus = document.querySelectorAll('.action-menu');
  console.log('All menus found:', allMenus.length);
  allMenus.forEach(m => {
    if (m !== menu) {
      m.classList.remove('show');
    }
  });

  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–µ–Ω—é
  if (menu) {
    menu.classList.toggle('show');
    console.log('Menu toggled, show class:', menu.classList.contains('show'));

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫ –ø—É–Ω–∫—Ç–∞–º –º–µ–Ω—é
    if (menu.classList.contains('show')) {
      console.log('–ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫ –º–µ–Ω—é:', menu.id);
      const menuItems = menu.querySelectorAll('.menu-item');
      console.log('–ù–∞–π–¥–µ–Ω–æ –ø—É–Ω–∫—Ç–æ–≤ –º–µ–Ω—é:', menuItems.length);

      menuItems.forEach((item, index) => {
        console.log(`–ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ –ø—É–Ω–∫—Ç—É ${index + 1}:`, item);
        item.style.display = 'flex';
        item.style.alignItems = 'center';
        item.style.gap = '3px';
        item.style.padding = '2px 6px';
        item.style.fontSize = '10px';
        item.style.lineHeight = '1';
        item.style.minHeight = '16px';
        item.style.cursor = 'pointer';
        item.style.color = '#374151';
        item.style.borderBottom = '1px solid #f3f4f6';

        // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏
        item.offsetHeight;
      });

      const icons = menu.querySelectorAll('.menu-item i');
      console.log('–ù–∞–π–¥–µ–Ω–æ –∏–∫–æ–Ω–æ–∫:', icons.length);
      icons.forEach((icon, index) => {
        console.log(`–ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ –∏–∫–æ–Ω–∫–µ ${index + 1}:`, icon);
        icon.style.fontSize = '9px';
        icon.style.width = '10px';
        icon.style.textAlign = 'center';
      });

      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ç–∏–ª–∏ –≤—Å–µ–≥–æ –º–µ–Ω—é
      menu.offsetHeight;
      console.log('–°—Ç–∏–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫ –º–µ–Ω—é:', menu.id);
    }
  }
}

// –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–æ –≤—Å–µ–º –º–µ–Ω—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
  console.log('DOMContentLoaded: –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –∫–æ –≤—Å–µ–º –º–µ–Ω—é');
  const allMenus = document.querySelectorAll('.action-menu');
  console.log('–ù–∞–π–¥–µ–Ω–æ –º–µ–Ω—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ:', allMenus.length);

  allMenus.forEach((menu, menuIndex) => {
    console.log(`–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–µ–Ω—é ${menuIndex + 1}:`, menu.id);
    const menuItems = menu.querySelectorAll('.menu-item');
    console.log(`–í –º–µ–Ω—é ${menuIndex + 1} –Ω–∞–π–¥–µ–Ω–æ –ø—É–Ω–∫—Ç–æ–≤:`, menuItems.length);

    menuItems.forEach((item, itemIndex) => {
      console.log(`–ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ –ø—É–Ω–∫—Ç—É ${itemIndex + 1} –≤ –º–µ–Ω—é ${menuIndex + 1}`);
      item.style.display = 'flex';
      item.style.alignItems = 'center';
              item.style.gap = '3px';
        item.style.padding = '2px 6px';
      item.style.fontSize = '10px';
      item.style.lineHeight = '1';
      item.style.minHeight = '16px';
      item.style.cursor = 'pointer';
      item.style.color = '#374151';
      item.style.borderBottom = '1px solid #f3f4f6';
    });

    const icons = menu.querySelectorAll('.menu-item i');
    console.log(`–í –º–µ–Ω—é ${menuIndex + 1} –Ω–∞–π–¥–µ–Ω–æ –∏–∫–æ–Ω–æ–∫:`, icons.length);
    icons.forEach((icon, iconIndex) => {
      console.log(`–ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ –∏–∫–æ–Ω–∫–µ ${iconIndex + 1} –≤ –º–µ–Ω—é ${menuIndex + 1}`);
      icon.style.fontSize = '9px';
      icon.style.width = '10px';
      icon.style.textAlign = 'center';
    });
  });

  console.log('DOMContentLoaded: –°—Ç–∏–ª–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫–æ –≤—Å–µ–º –º–µ–Ω—é');
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∫–æ–º–ø–∞–∫—Ç–Ω—ã—Ö —Å—Ç–∏–ª–µ–π (–º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –∏–∑ –∫–æ–Ω—Å–æ–ª–∏)
function forceCompactMenuStyles() {
  console.log('üîß –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã—Ö —Å—Ç–∏–ª–µ–π –º–µ–Ω—é...');
  const allMenus = document.querySelectorAll('.action-menu');
  console.log('–ù–∞–π–¥–µ–Ω–æ –º–µ–Ω—é:', allMenus.length);

  allMenus.forEach((menu, menuIndex) => {
    console.log(`–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–µ–Ω—é ${menuIndex + 1}:`, menu.id);
    const menuItems = menu.querySelectorAll('.menu-item');
    console.log(`–í –º–µ–Ω—é ${menuIndex + 1} –Ω–∞–π–¥–µ–Ω–æ –ø—É–Ω–∫—Ç–æ–≤:`, menuItems.length);

    menuItems.forEach((item, itemIndex) => {
      console.log(`–ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ –ø—É–Ω–∫—Ç—É ${itemIndex + 1} –≤ –º–µ–Ω—é ${menuIndex + 1}`);
      item.style.setProperty('display', 'flex', 'important');
      item.style.setProperty('align-items', 'center', 'important');
      item.style.setProperty('gap', '3px', 'important');
      item.style.setProperty('padding', '2px 6px', 'important');
      item.style.setProperty('font-size', '10px', 'important');
      item.style.setProperty('line-height', '1', 'important');
      item.style.setProperty('min-height', '16px', 'important');
      item.style.setProperty('cursor', 'pointer', 'important');
      item.style.setProperty('color', '#374151', 'important');
      item.style.setProperty('border-bottom', '1px solid #f3f4f6', 'important');
    });

    const icons = menu.querySelectorAll('.menu-item i');
    console.log(`–í –º–µ–Ω—é ${menuIndex + 1} –Ω–∞–π–¥–µ–Ω–æ –∏–∫–æ–Ω–æ–∫:`, icons.length);
    icons.forEach((icon, iconIndex) => {
      console.log(`–ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –∫ –∏–∫–æ–Ω–∫–µ ${iconIndex + 1} –≤ –º–µ–Ω—é ${menuIndex + 1}`);
      icon.style.setProperty('font-size', '9px', 'important');
      icon.style.setProperty('width', '10px', 'important');
      icon.style.setProperty('text-align', 'center', 'important');
    });
  });

  console.log('‚úÖ –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ —Å—Ç–∏–ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã');
}

// –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ
window.forceCompactMenuStyles = forceCompactMenuStyles;

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç—É
document.addEventListener('click', function(e) {
  // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
  const actionContainers = document.querySelectorAll('.action-button-container');
  actionContainers.forEach(container => {
    if (!container.contains(e.target)) {
      const menu = container.querySelector('.action-menu');
      if (menu) {
        menu.classList.remove('show');
      }
    }
  });

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ –¥–µ–π—Å—Ç–≤–∏–π
  const actionBtn = e.target.closest('.action-btn');
  if (actionBtn) {
    console.log('Action button clicked');
    e.stopPropagation();
    const journalId = actionBtn.dataset.journalId;
    console.log('Journal ID:', journalId);
    toggleActionMenu(journalId);
    return;
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ –ø—É–Ω–∫—Ç–∞–º –º–µ–Ω—é
  const menuItem = e.target.closest('.menu-item');
  if (menuItem) {
    e.stopPropagation();
    const journalId = menuItem.dataset.journalId;
    const action = menuItem.dataset.action;

    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é
    const menu = menuItem.closest('.action-menu');
    if (menu) {
      menu.classList.remove('show');
    }

    // –í—ã–ø–æ–ª–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
    if (action === 'edit') {
      openEditCommentModal(journalId);
    } else if (action === 'delete') {
      deleteComment(journalId);
    }
    return;
  }
});
async function deleteComment(journalId) {
  if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')) {
    return;
  }
  try {
    const taskId = getTaskIdFromUrl();
    const response = await fetch(`/tasks/api/task/${taskId}/comment/${journalId}/delete`, {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
        'X-Requested-With': 'XMLHttpRequest',
        ...(() => {
          const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
          return token ? { 'X-CSRFToken': token } : {};
        })()
      }
    });
    if (!response.ok) {
      const errorText = await response.text();
      showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + errorText, 'error');
      return;
    }
    const data = await response.json();
    if (data.success) {
      showNotification(data.message, 'success');
      const commentElement = document.querySelector(`[data-journal-id="${journalId}"]`);
      if (commentElement) {
        commentElement.closest('.history-item').remove();
      }
    } else {
      showNotification(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'error');
    }
  } catch (error) {
    showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è', 'error');
  }
}
</script>

<script>
// –§—É–Ω–∫—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
function applyDarkThemeStyles() {
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';

  if (!isDark) return;

  const allSpans = document.querySelectorAll('span');

  allSpans.forEach(span => {
    const text = span.textContent.trim();

    // –°–±—Ä–æ—Å —Å—Ç–∏–ª–µ–π
    span.style.color = '';
    span.style.backgroundColor = '';
    span.style.padding = '';
    span.style.border = '';
    span.style.borderRadius = '';
    span.style.fontWeight = '';

    // –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–∫—Å—Ç–∞ —Å "–∏–∑–º–µ–Ω–∏–ª—Å—è" - —Ç–æ–ª—å–∫–æ –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    if (span.closest('.change-description') && (text.includes('–∏–∑–º–µ–Ω–∏–ª—Å—è') || text.includes('–ü–∞—Ä–∞–º–µ—Ç—Ä'))) {
      span.style.color = '#fbbf24';
      span.style.fontWeight = 'bold';
      span.style.backgroundColor = 'rgba(251, 191, 36, 0.2)';
      span.style.padding = '2px 4px';
      span.style.borderRadius = '4px';
    }

    // –°—Ç–∏–ª–∏ –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π - —Ç–æ–ª—å–∫–æ –ø–æ CSS –∫–ª–∞—Å—Å–∞–º (–ù–ï –¥–ª—è –∏–º—ë–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
    else if ((!span.classList.contains('user-name')) &&
             (span.classList.contains('old-value') || span.classList.contains('new-value'))) {
      span.style.color = '#51cf66';
      span.style.fontWeight = '600';
      span.style.backgroundColor = 'rgba(81, 207, 102, 0.2)';
      span.style.padding = '2px 6px';
      span.style.borderRadius = '4px';
      span.style.border = '1px solid #51cf66';
    }

    // –û–±—â–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è span –≤ –∏—Å—Ç–æ—Ä–∏–∏ (–∏—Å–∫–ª—é—á–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
    else if ((span.closest('.history-item') || span.closest('.change-item')) &&
             !span.classList.contains('user-name') &&
             !span.closest('.history-user')) {
      span.style.color = '#ffffff';
    }
  });
}

// Theme Toggle
function toggleTheme() {
  const html = document.documentElement;
  const themeIcon = document.getElementById('theme-icon');

  if (html.getAttribute('data-theme') === 'dark') {
    html.removeAttribute('data-theme');
    themeIcon.className = 'fas fa-moon';
    localStorage.setItem('theme', 'light');
  } else {
    html.setAttribute('data-theme', 'dark');
    themeIcon.className = 'fas fa-sun';
    localStorage.setItem('theme', 'dark');
  }

  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –ø–æ—Å–ª–µ —Å–º–µ–Ω—ã —Ç–µ–º—ã
  setTimeout(applyDarkThemeStyles, 100);
}

// Initialize theme
document.addEventListener('DOMContentLoaded', function() {
  const savedTheme = localStorage.getItem('theme');
  const themeIcon = document.getElementById('theme-icon');

  if (savedTheme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    themeIcon.className = 'fas fa-sun';
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã
    setTimeout(applyDarkThemeStyles, 500);
  }

  // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  setTimeout(applyDarkThemeStyles, 500);
});

// Copy Task Link
function copyTaskLink() {
  const url = window.location.href;
  navigator.clipboard.writeText(url).then(() => {
    showNotification('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
  });
}

// Show Notification
function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check' : 'info'}-circle"></i>
    <span>${message}</span>
  `;

  Object.assign(notification.style, {
    position: 'fixed',
    top: '2rem',
    right: '2rem',
    background: type === 'success' ? 'var(--success-color)' : 'var(--primary-color)',
    color: 'white',
    padding: '1rem 1.5rem',
    borderRadius: 'var(--border-radius)',
    boxShadow: 'var(--shadow-lg)',
    zIndex: '1001',
    display: 'flex',
    alignItems: 'center',
    gap: '0.5rem',
    animation: 'slideInRight 0.3s ease-out'
  });

  document.body.appendChild(notification);

  setTimeout(() => {
    notification.style.animation = 'slideOutRight 0.3s ease-out';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// History Filters
function toggleHistoryFilters() {
  const filters = document.getElementById('historyFilters');
  filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
}

// Toggle Card Sections
function toggleCard(cardId) {
  const content = document.getElementById(cardId + '-content');
  const toggle = document.getElementById(cardId + '-toggle');

  if (content.classList.contains('collapsed')) {
    content.classList.remove('collapsed');
    toggle.classList.remove('rotated');
  } else {
    content.classList.add('collapsed');
    toggle.classList.add('rotated');
  }
}

// Filter chips
document.addEventListener('DOMContentLoaded', function() {
  const filterChips = document.querySelectorAll('.filter-chip');
  const historyItems = document.querySelectorAll('.history-item');

  filterChips.forEach(chip => {
    chip.addEventListener('click', function() {
      // Remove active class from all chips
      filterChips.forEach(c => c.classList.remove('active'));
      // Add active class to clicked chip
      this.classList.add('active');

      const filter = this.getAttribute('data-filter');

      historyItems.forEach(item => {
        if (filter === 'all') {
          item.style.display = 'flex';
        } else if (filter === 'status') {
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∏–∑–º–µ–Ω–µ–Ω–∏—è–º–∏ —Å—Ç–∞—Ç—É—Å–∞
          const itemType = item.getAttribute('data-type');
          if (itemType === 'changes') {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –≤ —ç—Ç–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ
            // –í–∞—Ä–∏–∞–Ω—Ç 1: —á–µ—Ä–µ–∑ –∫–ª–∞—Å—Å .field-name (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
            const hasStatusFieldName = item.querySelector('.field-name') &&
                                       item.querySelector('.field-name').textContent.trim() === '–°—Ç–∞—Ç—É—Å';

            // –í–∞—Ä–∏–∞–Ω—Ç 2: —á–µ—Ä–µ–∑ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–∫—Å—Ç–∞ (—Ñ—É–Ω–∫—Ü–∏—è get_property_name)
            const changeDescriptions = item.querySelectorAll('.change-description span');
            let hasStatusInDescription = false;
            changeDescriptions.forEach(span => {
              if (span.textContent.includes('–ü–∞—Ä–∞–º–µ—Ç—Ä') && span.textContent.includes('–°—Ç–∞—Ç—É—Å') && span.textContent.includes('–∏–∑–º–µ–Ω–∏–ª—Å—è')) {
                hasStatusInDescription = true;
              }
            });

            item.style.display = (hasStatusFieldName || hasStatusInDescription) ? 'flex' : 'none';
          } else {
            item.style.display = 'none';
          }
        } else {
          const itemType = item.getAttribute('data-type');
          item.style.display = itemType === filter ? 'flex' : 'none';
        }
      });
    });
  });
});

// Smooth scrolling for internal links
document.addEventListener('DOMContentLoaded', function() {
  const links = document.querySelectorAll('a[href^="#"]');
  links.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      const target = document.querySelector(this.getAttribute('href'));
      if (target) {
        target.scrollIntoView({ behavior: 'smooth' });
      }
    });
  });
});

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }

  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(style);

// Helper function to get task ID from URL
function getTaskIdFromUrl() {
  const pathParts = window.location.pathname.split('/');
  const taskIndex = pathParts.indexOf('my-tasks');
  if (taskIndex !== -1 && taskIndex + 1 < pathParts.length) {
    const taskId = pathParts[taskIndex + 1];
    if (!isNaN(taskId)) {
      return taskId;
    }
  }
  return null;
}

// Attachment download function
async function downloadAttachment(attachmentId) {
  const taskId = getTaskIdFromUrl();

  if (!taskId) {
    showNotification('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –∑–∞–¥–∞—á–∏', 'error');
    return;
  }

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
  const downloadBtn = (event && event.target) ? event.target.closest('.attachment-download') : null;
  const originalContent = downloadBtn ? downloadBtn.innerHTML : '';
  if (downloadBtn) {
    downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    downloadBtn.disabled = true;
  }

  try {
    // –°–æ–∑–¥–∞–µ–º URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
    const downloadUrl = `/tasks/api/task/${taskId}/attachment/${attachmentId}/download`;

    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
    const response = await fetch(downloadUrl, {
      method: 'GET',
      credentials: 'same-origin'
    });

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }

    const data = await response.json();

    if (data.success && data.download_url) {
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ
      window.open(data.download_url, '_blank');
      showNotification(`–û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞: ${data.filename}`, 'success');
    } else {
      throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å URL –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è');
    }

  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞:', error);
    showNotification(`–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞: ${error.message}`, 'error');
  } finally {
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
    setTimeout(() => {
      if (downloadBtn) {
        downloadBtn.innerHTML = originalContent;
        downloadBtn.disabled = false;
      }
    }, 1000);
  }
}

function goBackToTasksList(taskId) {
    // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º 'list' –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    const savedView = sessionStorage.getItem('return_from_task_view') || 'list';

    console.log(`[goBackToTasksList] üîÑ –í–æ–∑–≤—Ä–∞—Ç –∫ —Å–ø–∏—Å–∫—É –∑–∞–¥–∞—á`);
    console.log(`[goBackToTasksList] üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞: ${savedView}`);
    console.log(`[goBackToTasksList] üìã –í—Å–µ sessionStorage:`, Object.fromEntries(Object.entries(sessionStorage)));

    // –û—á–∏—â–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ
    sessionStorage.removeItem('return_from_task_id');
    sessionStorage.removeItem('return_from_task_page');
    sessionStorage.removeItem('return_from_task_view');

    console.log(`[goBackToTasksList] üßπ –û—á–∏—â–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫–∏`);

    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –æ–±—Ä–∞—Ç–Ω–æ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º —Ä–µ–∂–∏–º–∞
    const returnUrl = `/tasks/my-tasks?view=${savedView}&return=1`;
    console.log(`[goBackToTasksList] üöÄ –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ URL: ${returnUrl}`);

    window.location.href = returnUrl;
}

// –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ —Ñ–∞–π–ª–∞ task_status_change.js

// ===== –§–£–ù–ö–¶–ò–û–ù–ê–õ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í =====

/**
 * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Ñ–æ—Ä–º—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
 */
function toggleCommentInput() {
    const commentForm = document.getElementById('commentForm');
    const commentButton = document.querySelector('.comment-button');

    if (commentForm.style.display === 'none' || commentForm.style.display === '') {
        commentForm.style.display = 'block';
        commentButton.style.display = 'none';
        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        const textarea = commentForm.querySelector('textarea');
        if (textarea) {
            textarea.focus();
        }
    } else {
        commentForm.style.display = 'none';
        commentButton.style.display = 'block';
        // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
        const textarea = commentForm.querySelector('textarea');
        if (textarea) {
            textarea.value = '';
        }
    }
}

/**
 * –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥–≤–æ–π–Ω–æ–≥–æ –Ω–∞–∂–∞—Ç–∏—è
 */
function disableSubmitButton() {
    const submitBtn = document.getElementById('submitBtn');
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>–û—Ç–ø—Ä–∞–≤–∫–∞...</span>';
    }
}



/**
 * –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è —á–µ—Ä–µ–∑ AJAX (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±)
 */
async function submitCommentAjax(event) {
    event.preventDefault();

    const form = document.getElementById('commentForm');
    const textarea = form.querySelector('textarea');
    const comment = textarea.value.trim();

    if (!comment) {
        showNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
        return;
    }

    // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
    disableSubmitButton();

    try {
        const taskId = getTaskIdFromUrl();

        // –ü–æ–ª—É—á–∞–µ–º CSRF —Ç–æ–∫–µ–Ω –∏–∑ —Ñ–æ—Ä–º—ã
        const csrfToken = form.querySelector('input[name="csrf_token"]')?.value;

        const headers = {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        };

        // –î–æ–±–∞–≤–ª—è–µ–º CSRF —Ç–æ–∫–µ–Ω –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }

        console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX –∑–∞–ø—Ä–æ—Å:', {
            url: `/tasks/api/task/${taskId}/comment`,
            method: 'POST',
            headers: headers,
            body: { comment: comment }
        });

        const response = await fetch(`/tasks/api/task/${taskId}/comment`, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({
                comment: comment
            })
        });

        console.log('–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç:', response.status, response.statusText);

        if (!response.ok) {
            const errorText = await response.text();
            console.error('–û—à–∏–±–∫–∞ HTTP:', response.status, errorText);
            throw new Error(`HTTP ${response.status}: ${errorText}`);
        }

        const data = await response.json();
        console.log('–î–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç–∞:', data);

        if (data.success) {
            showNotification(data.message, 'success');
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –∏ —Å–∫—Ä—ã–≤–∞–µ–º –µ—ë
            textarea.value = '';
            toggleCommentInput();
            // –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showNotification(data.error, 'error');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è: ' + error.message, 'error');
    } finally {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> <span>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>';
        }
    }
}



/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
 */
function initializeDeleteCommentButtons() {
  console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤');

  // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É –≤—Å–µ—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –µ—Å—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏
  document.querySelectorAll('.history-comment').forEach((comment, index) => {
    console.log(`–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π ${index + 1}:`, comment);

    const actions = comment.querySelector('.comment-actions');
    console.log(`–ù–∞–π–¥–µ–Ω—ã actions –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è ${index + 1}:`, actions);

    if (actions) {
      // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
      actions.style.position = 'absolute';
      actions.style.top = '8px';
      actions.style.right = '8px';
      actions.style.zIndex = '999';
      actions.style.opacity = '0';
      actions.style.visibility = 'hidden';
      actions.style.transition = 'opacity 0.3s ease, visibility 0.3s ease';

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∫–Ω–æ–ø–æ–∫
      comment.addEventListener('mouseenter', function() {
        console.log('–ù–∞–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:', this);
        const actions = this.querySelector('.comment-actions');
        if (actions) {
          actions.style.opacity = '1';
          actions.style.visibility = 'visible';
          actions.classList.add('show');
          console.log('–ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞–Ω–∞');
        }
      });

      comment.addEventListener('mouseleave', function() {
        console.log('–ú—ã—à—å —É—à–ª–∞ —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è:', this);
        const actions = this.querySelector('.comment-actions');
        if (actions) {
          actions.style.opacity = '0';
          actions.style.visibility = 'hidden';
          actions.classList.remove('show');
          console.log('–ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–∫—Ä—ã—Ç–∞');
        }
      });
    }
  });
}



/**
 * –°–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
 */
document.addEventListener('DOMContentLoaded', function() {
    const commentForm = document.getElementById('commentForm');
    if (commentForm) {
        commentForm.style.display = 'none';
    }

    // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ (–±–µ–∑ Jinja –≤ JS)
    const CLEAR_COMMENT = JSON.parse('{{ (clear_comment|default(false))|tojson }}');
    if (CLEAR_COMMENT) {
        const textarea = document.querySelector('#commentForm textarea');
        if (textarea) {
            textarea.value = '';
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    initializeDeleteCommentButtons();

    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è
    console.log('–ù–∞–π–¥–µ–Ω–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', document.querySelectorAll('.history-comment').length);
    console.log('–ù–∞–π–¥–µ–Ω–æ –∫–Ω–æ–ø–æ–∫ —É–¥–∞–ª–µ–Ω–∏—è:', document.querySelectorAll('.comment-actions').length);

    // –í–†–ï–ú–ï–ù–ù–´–ô –û–¢–õ–ê–î–û–ß–ù–´–ô –ö–û–î - –£–î–ê–õ–ò–¢–¨ –ü–û–°–õ–ï –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
    // –î–µ–ª–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –≤–∏–¥–∏–º—ã–º–∏ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    setTimeout(() => {
  document.querySelectorAll('.comment-actions').forEach((actions, index) => {
        console.log(`–î–æ–±–∞–≤–ª—è–µ–º debug-visible –∫ –∫–Ω–æ–ø–∫–µ ${index + 1}:`, actions);
        actions.classList.add('debug-visible');

        // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∞
        const computedStyle = window.getComputedStyle(actions);
        console.log(`–°—Ç–∏–ª–∏ –∫–Ω–æ–ø–∫–∏ ${index + 1}:`, {
          position: computedStyle.position,
          top: computedStyle.top,
          right: computedStyle.right,
          opacity: computedStyle.opacity,
          visibility: computedStyle.visibility,
          zIndex: computedStyle.zIndex
        });
      });
    }, 1000);
});

let editingJournalId = null;

function openEditCommentModal(journalId) {
  editingJournalId = journalId;
  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –∏–∑ DOM
  const commentBlock = document.querySelector(`.history-comment[data-journal-id="${journalId}"] .comment-content`);
  const commentText = commentBlock ? commentBlock.innerText : '';
  document.getElementById('editCommentTextarea').value = commentText;
  document.getElementById('editCommentModal').style.display = 'flex';
}

function closeEditCommentModal() {
  editingJournalId = null;
  document.getElementById('editCommentModal').style.display = 'none';
}


document.addEventListener('DOMContentLoaded', function() {
  // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
  const cancelBtn = document.getElementById('cancelEditCommentBtn');
  const closeBtn = document.getElementById('closeEditCommentModalBtn');
  const saveBtn = document.getElementById('saveEditCommentBtn');

  if (cancelBtn) cancelBtn.onclick = closeEditCommentModal;
  if (closeBtn) closeBtn.onclick = closeEditCommentModal;
  if (saveBtn) saveBtn.onclick = async function() {
    const newText = document.getElementById('editCommentTextarea').value.trim();
    if (!newText) {
      showNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', 'error');
      return;
    }
    try {
      const taskId = getTaskIdFromUrl();
      const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      const response = await fetch(`/tasks/api/task/${taskId}/comment/${editingJournalId}/edit`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'X-Requested-With': 'XMLHttpRequest',
          ...(token ? { 'X-CSRFToken': token } : {})
        },
        body: JSON.stringify({ comment: newText })
      });
      if (!response.ok) {
        const errorText = await response.text();
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + errorText, 'error');
        return;
      }
      const data = await response.json();
      if (data.success) {
        showNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–±–Ω–æ–≤–ª—ë–Ω', 'success');
        closeEditCommentModal();
        setTimeout(() => window.location.reload(), 500);
      } else {
        showNotification(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏', 'error');
      }
    } catch (e) {
      showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + e, 'error');
    }
  };

  // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä—è–º–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É"
  const goBackBtn = document.getElementById('go-back-btn');
  if (goBackBtn) {
    console.log('üîô –ù–∞–π–¥–µ–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É", –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞');
    goBackBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();

      const taskId = this.getAttribute('data-task-id');
      console.log('üîô –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É", ID –∑–∞–¥–∞—á–∏:', taskId);

      if (taskId) {
        goBackToTasksList(taskId);
      } else {
        console.error('‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω ID –∑–∞–¥–∞—á–∏ –≤ –∞—Ç—Ä–∏–±—É—Ç–µ data-task-id');
        // –ï—Å–ª–∏ ID –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –º–µ—Ç–æ–¥
        const taskIdFromUrl = getTaskIdFromUrl();
        if (taskIdFromUrl) {
          goBackToTasksList(taskIdFromUrl);
        } else {
          console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –∑–∞–¥–∞—á–∏');
          showNotification('–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å ID –∑–∞–¥–∞—á–∏', 'error');
        }
      }
    });
  } else {
    console.error('‚ùå –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
  }
});
</script>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
<div id="editCommentModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; align-items:center; justify-content:center; z-index:2000; background:rgba(0,0,0,0.3);">
  <div style="background:#fff; padding:2rem; border-radius:10px; min-width:300px; max-width:90vw; box-shadow:0 8px 32px rgba(0,0,0,0.2); display:flex; flex-direction:column; gap:1rem; position:relative;">
    <button id="closeEditCommentModalBtn" style="position:absolute; top:10px; right:10px; background:none; border:none; font-size:1.5rem; color:#888; cursor:pointer;">√ó</button>
    <h3 style="margin:0 0 1rem 0;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h3>
    <textarea id="editCommentTextarea" style="width:100%; min-height:100px; resize:vertical; border-radius:6px; border:1px solid #ccc; padding:0.5rem;"></textarea>
    <div style="display:flex; gap:1rem; justify-content:flex-end;">
      <button id="cancelEditCommentBtn" type="button" style="background:#eee; border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">–û—Ç–º–µ–Ω–∞</button>
      <button id="saveEditCommentBtn" type="button" style="background:#3b82f6; color:#fff; border:none; border-radius:6px; padding:0.5rem 1.2rem; cursor:pointer;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</div>

            <!-- Quill.js Rich Text Editor -->
            <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
            <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
            <style>
                .ql-editor {
                    min-height: 200px;
                    font-family: Arial, sans-serif;
                    font-size: 14px;
                }
                .ql-toolbar {
                    border-top: 1px solid #ccc;
                    border-left: 1px solid #ccc;
                    border-right: 1px solid #ccc;
                    background: #f8f9fa;
                }
                .ql-container {
                    border-bottom: 1px solid #ccc;
                    border-left: 1px solid #ccc;
                    border-right: 1px solid #ccc;
                }
                .ql-toolbar button {
                    cursor: pointer !important;
                }
                .ql-toolbar button:hover {
                    color: #007bff !important;
                }
                .ql-toolbar .ql-active {
                    color: #007bff !important;
                }
                .ql-toolbar .ql-picker {
                    cursor: pointer !important;
                }
                .ql-toolbar .ql-picker-label {
                    cursor: pointer !important;
                }
                .ql-toolbar .ql-picker-options {
                    background: white;
                    border: 1px solid #ccc;
                    border-radius: 4px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                }

                /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã email */
                .email-form-grid {
                    gap: 15px;
                }
                .email-form .form-group {
                    margin-bottom: 20px;
                }
                .email-form .form-control {
                    margin-bottom: 8px;
                }
                .email-form .form-text {
                    margin-top: 5px;
                    color: #6c757d;
                }
                .email-form input[type="file"] {
                    padding: 8px;
                    border: 1px solid #ced4da;
                    border-radius: 4px;
                    background-color: #fff;
                }
                .email-form input[type="file"]:focus {
                    border-color: #80bdff;
                    outline: 0;
                    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
                }

                /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –æ—Ç—Å—Ç—É–ø–æ–≤ */
                .email-form {
                    padding: 20px;
                    background: #f8f9fa;
                    border-radius: 8px;
                    margin-top: 15px;
                }
                .email-form-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 15px;
                }
                .email-form-grid .full-width {
                    grid-column: 1 / -1;
                }
                .form-actions {
                    margin-top: 20px;
                    padding-top: 15px;
                    border-top: 1px solid #dee2e6;
                }

                /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–µ–º–Ω–æ–π —Ç–µ–º—ã */
                [data-theme="dark"] .email-form .form-label,
                [data-theme="dark"] .email-form label {
                    color: #ffffff !important;
                }
                [data-theme="dark"] .email-form .form-text {
                    color: #adb5bd !important;
                }
                [data-theme="dark"] .file-list {
                    color: #adb5bd !important;
                }
                [data-theme="dark"] .email-form {
                    background: #2d3748;
                    border: 1px solid #4a5568;
                }
                [data-theme="dark"] .email-form .form-control {
                    background-color: #4a5568;
                    border-color: #718096;
                    color: #ffffff;
                }
                [data-theme="dark"] .email-form .form-control:focus {
                    background-color: #4a5568;
                    border-color: #63b3ed;
                    color: #ffffff;
                }
                [data-theme="dark"] .file-input-container button {
                    background-color: #4a5568;
                    border-color: #718096;
                    color: #ffffff;
                }
                [data-theme="dark"] .file-input-container button:hover {
                    background-color: #718096;
                    border-color: #a0aec0;
                }
                [data-theme="dark"] .file-input-container {
                    width: 100%;
                }
                [data-theme="dark"] .file-status-container {
                    width: 100%;
                }
                [data-theme="dark"] .file-list {
                    display: block;
                    word-wrap: break-word;
                    word-break: break-word;
                }

                /* –°—Ç–∏–ª–∏ –¥–ª—è Quill —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
                [data-theme="dark"] .ql-toolbar {
                    background-color: #4a5568;
                    border-color: #718096;
                }
                [data-theme="dark"] .ql-toolbar button {
                    color: #ffffff;
                }
                [data-theme="dark"] .ql-toolbar button:hover {
                    color: #63b3ed !important;
                }
                [data-theme="dark"] .ql-toolbar .ql-active {
                    color: #63b3ed !important;
                }
                [data-theme="dark"] .ql-container {
                    background-color: #4a5568;
                    border-color: #718096;
                }
                [data-theme="dark"] .ql-editor {
                    color: #ffffff;
                }
                [data-theme="dark"] .ql-editor.ql-blank::before {
                    color: #a0aec0;
                }

                /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
                [data-theme="dark"] .form-control::placeholder {
                    color: #a0aec0 !important;
                }
                [data-theme="dark"] .form-control::-webkit-input-placeholder {
                    color: #a0aec0 !important;
                }
                [data-theme="dark"] .form-control::-moz-placeholder {
                    color: #a0aec0 !important;
                }
                [data-theme="dark"] .form-control:-ms-input-placeholder {
                    color: #a0aec0 !important;
                }

                /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤ */
                .file-input-container {
                    display: flex;
                    align-items: center;
                    margin-bottom: 8px;
                    width: 100%;
                }
                .file-status-container {
                    margin-bottom: 10px;
                    width: 100%;
                }
                .file-input-container button {
                    padding: 8px 16px;
                    border: 1px solid #ced4da;
                    border-radius: 4px;
                    background-color: #fff;
                    color: #495057;
                    cursor: pointer;
                    transition: all 0.2s;
                    white-space: nowrap;
                }
                .file-input-container button:hover {
                    background-color: #e9ecef;
                    border-color: #adb5bd;
                }
                .file-list {
                    color: #6c757d;
                    font-size: 14px;
                    display: block;
                    word-wrap: break-word;
                    word-break: break-word;
                }
            </style>
            <script>
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Quill.js –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ DOM
                document.addEventListener('DOMContentLoaded', function() {
                    var quill = new Quill('#quillEditor', {
                    theme: 'snow',
                    modules: {
                        toolbar: {
                            container: [
                                ['bold', 'italic', 'underline'],
                                [{ 'color': [] }, { 'background': [] }],
                                [{ 'align': [] }],
                                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                                ['link', 'image'],
                                ['clean']
                            ],
                            handlers: {
                                'link': function() {
                                    var range = quill.getSelection();
                                    if (range) {
                                        var url = prompt('–í–≤–µ–¥–∏—Ç–µ URL:');
                                        if (url) {
                                            quill.format('link', url);
                                        }
                                    }
                                },
                                'image': function() {
                                    var input = document.createElement('input');
                                    input.setAttribute('type', 'file');
                                    input.setAttribute('accept', 'image/*');
                                    input.click();

                                    input.onchange = function() {
                                        var file = input.files[0];
                                        if (file) {
                                            var formData = new FormData();
                                            formData.append('file', file);

                                            fetch('/upload_image', {
                                                method: 'POST',
                                                body: formData
                                            })
                                            .then(response => response.json())
                                            .then(data => {
                                                if (data.location) {
                                                    var range = quill.getSelection();
                                                    quill.insertEmbed(range.index, 'image', data.location);
                                                }
                                            })
                                            .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error));
                                        }
                                    };
                                }
                            }
                        }
                    },
                    placeholder: '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...'
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å—Ç–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
                quill.on('text-change', function() {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ —Ñ–æ—Ä–º—ã
                    var html = quill.root.innerHTML;
                    var hiddenInput = document.querySelector('#emailMessageField');
                    if (hiddenInput) {
                        hiddenInput.value = html;
                    }
                });

                                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å—Ç–∞–≤–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞
                quill.clipboard.addMatcher('img', function(node, delta) {
                    var img = node.querySelector('img');
                    if (img && img.src.startsWith('data:')) {
                        // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º base64 –≤ —Ñ–∞–π–ª –∏ –∑–∞–≥—Ä—É–∂–∞–µ–º
                        fetch(img.src)
                            .then(res => res.blob())
                            .then(blob => {
                                var formData = new FormData();
                                formData.append('file', blob, 'image.png');

                                fetch('/upload_image', {
                                    method: 'POST',
                                    body: formData
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.location) {
                                        // –ó–∞–º–µ–Ω—è–µ–º base64 –Ω–∞ URL
                                        var range = quill.getSelection();
                                        quill.deleteText(range.index, range.length);
                                        quill.insertEmbed(range.index, 'image', data.location);
                                    }
                                })
                                .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:', error));
                            });
                    }
                    return delta;
                });

                // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ quill
                window.quillEditor = quill;

                // –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                console.log('‚úÖ Quill.js —Ä–µ–¥–∞–∫—Ç–æ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
                console.log('üîß –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–Ω–æ–ø–∫–∏:', document.querySelectorAll('.ql-toolbar button'));

                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
                document.addEventListener('click', function(e) {
                    if (e.target.closest('.ql-toolbar')) {
                        console.log('üñ±Ô∏è –ö–ª–∏–∫ –ø–æ –ø–∞–Ω–µ–ª–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤:', e.target.className);
                    }
                });

                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤
                document.getElementById('fileInput').addEventListener('change', function(e) {
                    var fileList = document.getElementById('fileList');
                    var files = e.target.files;
                    var input = e.target;

                    console.log('üîç –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ input:', {
                        multiple: input.multiple,
                        accept: input.accept,
                        filesCount: files.length,
                        inputHTML: input.outerHTML,
                        hasMultiple: input.hasAttribute('multiple')
                    });

                    if (files.length > 0) {
                        var fileNames = Array.from(files).map(file => file.name).join('<br>');
                        fileList.innerHTML = `<strong>–í—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤: ${files.length}</strong><br>${fileNames}`;
                        fileList.style.color = '#28a745';
                        console.log('‚úÖ –í—ã–±—Ä–∞–Ω–æ —Ñ–∞–π–ª–æ–≤:', files.length);
                        console.log('üìÅ –ò–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤:', Array.from(files).map(f => f.name));
                    } else {
                        fileList.textContent = '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω';
                        fileList.style.color = '#6c757d';
                    }
                });

                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º multiple –∞—Ç—Ä–∏–±—É—Ç
                setTimeout(function() {
                    var input = document.getElementById('fileInput');
                    if (input) {
                        input.setAttribute('multiple', 'multiple');
                        console.log('üîß –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∞—Ç—Ä–∏–±—É—Ç multiple –¥–ª—è input');
                        console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ input:', {
                            multiple: input.multiple,
                            type: input.type,
                            name: input.name,
                            id: input.id,
                            hasMultiple: input.hasAttribute('multiple'),
                            inputHTML: input.outerHTML
                        });
                    }
                }, 500);

                // –ü—Ä–æ—Å—Ç–∞—è –∑–∞—â–∏—Ç–∞ –∫–Ω–æ–ø–∫–∏ –æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∏–ª–µ–π
                var originalButtonStyle = {
                    backgroundColor: '#ff6b35',
                    borderColor: '#ff6b35',
                    color: '#ffffff'
                };

                // –°–æ–∑–¥–∞–µ–º observer –¥–ª—è –∑–∞—â–∏—Ç—ã –∫–Ω–æ–ø–∫–∏
                var buttonObserver = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                            var button = document.getElementById('fileButton');
                            if (button) {
                                button.style.backgroundColor = originalButtonStyle.backgroundColor;
                                button.style.borderColor = originalButtonStyle.borderColor;
                                button.style.color = originalButtonStyle.color;
                            }
                        }
                    });
                });

                // –ó–∞–ø—É—Å–∫–∞–µ–º observer —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(function() {
                    var button = document.getElementById('fileButton');
                    if (button) {
                        buttonObserver.observe(button, {
                            attributes: true,
                            attributeFilter: ['style']
                        });
                        console.log('üîß Observer –¥–ª—è –∑–∞—â–∏—Ç—ã –∫–Ω–æ–ø–∫–∏ –∑–∞–ø—É—â–µ–Ω');
                    }
                }, 1000);

                // –¢–µ—Å—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
                setTimeout(function() {
                    var input = document.getElementById('fileInput');
                    if (input) {
                        console.log('üß™ –¢–µ—Å—Ç –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞:');
                        console.log('- multiple –∞—Ç—Ä–∏–±—É—Ç:', input.multiple);
                        console.log('- hasAttribute multiple:', input.hasAttribute('multiple'));
                        console.log('- HTML —ç–ª–µ–º–µ–Ω—Ç–∞:', input.outerHTML);

                        // –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π input –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
                        var testInput = document.createElement('input');
                        testInput.type = 'file';
                        testInput.multiple = true;
                        console.log('- –¢–µ—Å—Ç–æ–≤—ã–π input multiple:', testInput.multiple);
                        console.log('- –¢–µ—Å—Ç–æ–≤—ã–π input HTML:', testInput.outerHTML);
                    }
                }, 2000);

                // –ü—Ä–æ—Å—Ç–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
                console.log('‚úÖ –°–∫—Ä–∏–ø—Ç —Ñ–∞–π–ª–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω');

                // –ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç –±–µ–∑ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤
                console.log('‚úÖ –°–∫—Ä–∏–ø—Ç —Ñ–∞–π–ª–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω - –º–æ—Ä–≥–∞–Ω–∏–µ –æ—Ç–∫–ª—é—á–µ–Ω–æ');
            });
            </script>

            <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞—á–∏ -->
            <script src="{{ url_for('static', filename='js/task_status_change.js') }}"></script>

            <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞ –∑–∞–¥–∞—á–∏ -->
            <script src="{{ url_for('static', filename='js/task_priority_change.js') }}"></script>

            <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—è –∑–∞–¥–∞—á–∏ -->
            <script src="{{ url_for('static', filename='js/task_assignee_change.js') }}"></script>

                        <!-- –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ -->
            <script>
                console.log('‚úÖ –í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã');
            </script>

            <!-- –°—Ç–∏–ª–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–µ—Ä—Ü–∞–Ω–∏—è -->
            <style>
              /* –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–π –¥–ª—è timeline —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
              .timeline-item,
              .timeline-content,
              .timeline-marker,
              .timeline-header,
              .timeline-user,
              .timeline-date,
              .timeline-changes,
              .timeline-notes,
              .change-item {
                transition: none !important;
                animation: none !important;
                will-change: auto !important;
                backface-visibility: visible !important;
                isolation: auto !important;
                contain: none !important;
                pointer-events: auto !important;
              }

              /* –û—Ç–∫–ª—é—á–µ–Ω–∏–µ hover —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ü–≤–µ—Ç–æ–≤ */
              .timeline-item:hover,
              .timeline-marker:hover,
              .timeline-content:hover {
                transform: none !important;
                box-shadow: inherit !important;
                background-color: inherit !important;
                border-color: inherit !important;
                color: inherit !important;
              }

              /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –¥–ª—è –¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
              .timeline-item *,
              .timeline-content *,
              .timeline-marker * {
                transition: none !important;
                animation: none !important;
              }

              .timeline-item *:hover,
              .timeline-content *:hover,
              .timeline-marker *:hover {
                transform: none !important;
                background-color: inherit !important;
                border-color: inherit !important;
                color: inherit !important;
              }

              /* –ü–æ–¥–¥–µ—Ä–∂–∫–∞ prefers-reduced-motion */
              @media (prefers-reduced-motion: reduce) {
                * {
                  transition: none !important;
                  animation: none !important;
                }
              }

              /* –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –≤—Å–µ—Ö hover —ç—Ñ—Ñ–µ–∫—Ç–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–µ—Ä—Ü–∞–Ω–∏—è */
              *:hover {
                transform: none !important;
                box-shadow: inherit !important;
                background-color: inherit !important;
                border-color: inherit !important;
                color: inherit !important;
                transition: none !important;
                animation: none !important;
              }

              /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –¥–ª—è –≥—Ä–∞–Ω–∏—á–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
              .card,
              .card-header,
              .card-content,
              .history-timeline,
              .history-filters,
              .comment-section,
              .email-section,
              .history-item,
              .history-content,
              .history-comment {
                pointer-events: auto !important;
                transition: none !important;
                animation: none !important;
                will-change: auto !important;
                backface-visibility: visible !important;
                isolation: auto !important;
                contain: none !important;
              }

              /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –º–µ—Ä—Ü–∞–Ω–∏—è –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–∞—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ */
              .card:hover,
              .card-header:hover,
              .card-content:hover,
              .history-timeline:hover,
              .history-filters:hover,
              .comment-section:hover,
              .email-section:hover {
                transform: none !important;
                box-shadow: inherit !important;
                background-color: inherit !important;
                border-color: inherit !important;
                color: inherit !important;
              }

              /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞ –æ—Ç –º–µ—Ä—Ü–∞–Ω–∏—è */
              .history-item,
              .history-content,
              .history-header,
              .history-user,
              .history-time,
              .history-changes,
              .change-item,
              .change-description,
              .history-comment,
              .comment-content {
                transition: none !important;
                animation: none !important;
                will-change: auto !important;
                backface-visibility: visible !important;
                isolation: auto !important;
                contain: none !important;
                word-wrap: break-word !important;
                word-break: break-all !important;
                overflow-wrap: break-word !important;
                white-space: pre-wrap !important;
                max-width: 100% !important;
                hyphens: auto !important;
              }

              .history-item:hover,
              .history-content:hover,
              .history-header:hover,
              .history-user:hover,
              .history-time:hover,
              .history-changes:hover,
              .change-item:hover,
              .change-description:hover,
              .history-comment:hover,
              .comment-content:hover {
                transform: none !important;
                box-shadow: inherit !important;
                background-color: inherit !important;
                border-color: inherit !important;
                color: inherit !important;
                word-wrap: break-word !important;
                word-break: break-all !important;
                overflow-wrap: break-word !important;
                white-space: pre-wrap !important;
                max-width: 100% !important;
                hyphens: auto !important;
              }
            </style>

<script>
// Compact Mode Toggle Functionality
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('compactModeToggle');
    const taskDetail = document.querySelector('.modern-task-detail');
    const toggleIcon = toggleBtn.querySelector('i');

    // Check if user preference is stored in localStorage
    const savedMode = localStorage.getItem('taskDetailCompactMode');

    // Apply saved preference or default to compact mode
    if (savedMode === 'normal') {
        taskDetail.classList.remove('compact-mode');
        toggleIcon.classList.remove('fa-compress-alt');
        toggleIcon.classList.add('fa-expand-alt');
    }

    // Toggle compact mode on button click
    toggleBtn.addEventListener('click', function() {
        const isCompact = taskDetail.classList.contains('compact-mode');

        if (isCompact) {
            // Switch to normal mode
            taskDetail.classList.remove('compact-mode');
            toggleIcon.classList.remove('fa-compress-alt');
            toggleIcon.classList.add('fa-expand-alt');
            toggleBtn.title = '–í–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º';
            localStorage.setItem('taskDetailCompactMode', 'normal');

            // Show notification
            showNotification('–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω', 'info');
        } else {
            // Switch to compact mode
            taskDetail.classList.add('compact-mode');
            toggleIcon.classList.remove('fa-expand-alt');
            toggleIcon.classList.add('fa-compress-alt');
            toggleBtn.title = '–í—ã–∫–ª—é—á–∏—Ç—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º';
            localStorage.setItem('taskDetailCompactMode', 'compact');

            // Show notification
            showNotification('–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º –≤–∫–ª—é—á–µ–Ω', 'success');
        }
    });

    // Helper function to show notifications
    function showNotification(message, type) {
        // Check if there's a notification system in place
        if (typeof window.showToast === 'function') {
            window.showToast(message, type);
        } else {
            // Simple fallback notification
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : '#17a2b8'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 9999;
                animation: slideIn 0.3s ease;
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }
    }

    // Add animation styles if they don't exist
    if (!document.getElementById('compact-mode-animations')) {
        const style = document.createElement('style');
        style.id = 'compact-mode-animations';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }

    console.log('‚úÖ Compact mode toggle initialized');
});
</script>

{% endblock %}
