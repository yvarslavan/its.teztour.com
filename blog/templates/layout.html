<!DOCTYPE html>
<html lang="ru">
    <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">

            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/media_css.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
            <link rel="icon" href="{{ url_for('static', filename='favicon/favicon_tez.ico') }}">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
            <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css">
            <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">

            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js"></script>
            {% block title %}
              <title>
                {{ title if title else 'HelpDesk' }}
              </title>
            {% endblock title %}

            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                <script>

                        // Здесь ваш скрипт
                        $(document).ready(function() {
                            // Функция для отправки AJAX запроса и обновления счетчика уведомлений
                            function updateNotificationCount() {
                                $.ajax({
                                    url: "{{ url_for('main.get_notification_count') }}",
                                    type: 'GET',
                                    success: function(data) {
                                        if (data.count > 0) {
                                            $('#notification-badge').text(data.count).show();
                                        } else {
                                            $('#notification-badge').hide();
                                        }
                                    },
                                    error: function(xhr, status, error) {
                                        console.error('Ошибка при получении количества уведомлений:', error);
                                        $('#notification-badge').hide();
                                        if (xhr.status === 401) {
                                            // Если пользователь не авторизован, можно перенаправить на страницу входа
                                            window.location.href = "{{ url_for('users.login') }}";
                                        }
                                    }
                                });
                            }

                            // Вызываем функцию обновления количества уведомлений с интервалом
                            setInterval(updateNotificationCount, 30000); // Например, каждые 30 секунд

                            // Начальное обновление счетчика уведомлений
                            updateNotificationCount();
                        });




                                                    $(document).ready(function() {
                                // Удаляем все стандартные flash-сообщения
                                $('.alert').remove();

                                var flashMessages = JSON.parse('{{ get_flashed_messages(with_categories=true) | tojson | safe }}');
                                if (flashMessages.length > 0) {
                                    flashMessages.forEach(function(flash) {
                                        var category = flash[0];
                                        var message = flash[1];

                                        var icon = 'info';
                                        if (category === 'success') icon = 'success';
                                        if (category === 'error') icon = 'error';
                                        if (category === 'warning') icon = 'warning';

                                        Swal.fire({
                                            icon: icon,
                                            title: category.charAt(0).toUpperCase() + category.slice(1),
                                            text: message,
                                            timer: 5000,
                                            showConfirmButton: false,
                                            toast: true,
                                            position: 'top-end',
                                            timerProgressBar: true
                                        });
                                    });
                                }
                            });

                </script>

                <style>
                    .sidebar {
                        position: fixed;
                        top: 0;
                        right: -400px;
                        width: 400px;
                        height: 100vh;
                        background: #fff;
                        box-shadow: -2px 0 5px rgba(0,0,0,0.2);
                        transition: right 0.3s ease;
                        z-index: 10001 !important;
                        overflow-y: auto;
                        padding: 20px;
                    }

                    .sidebar.active {
                        right: 0;
                    }

                    .sidebar-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                    }

                    .close-sidebar {
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        padding: 5px 10px;
                    }

                    .close-sidebar:hover {
                        color: #dc3545;
                    }

                    .notification-item {
                        border-bottom: 1px solid #eee;
                        padding: 10px 0;
                    }

                    .notification-header {
                        margin-bottom: 10px;
                    }

                    .notification-title {
                        font-weight: bold;
                    }

                    .notification-date {
                        color: #666;
                        font-size: 0.9em;
                    }

                    .notification-content {
                        color: #333;
                    }

                    .sidebar .sidebar-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 15px 20px;
                        border-bottom: 1px solid #e9ecef;
                        background: #f8f9fa;
                    }

                    .sidebar .header-content {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }

                    .sidebar .header-content i {
                        color: #007bff;
                        font-size: 1.2em;
                    }

                    .sidebar .header-content h3 {
                        margin: 0;
                        font-size: 1.2em;
                        font-weight: 500;
                        color: #2c3e50;
                    }

                    .sidebar .close-sidebar {
                        background: none;
                        border: none;
                        font-size: 1.5em;
                        color: #6c757d;
                        cursor: pointer;
                        padding: 0;
                        transition: color 0.2s;
                    }

                    .sidebar .close-sidebar:hover {
                        color: #dc3545;
                    }

                    .no-notifications {
                        text-align: center;
                        padding: 20px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 10px;
                    }

                    .no-notifications img {
                        width: 50px;
                        height: 50px;
                        margin-bottom: 15px;
                    }

                    .no-notifications h4 {
                        color: #333;
                        margin-bottom: 10px;
                    }

                    .no-notifications p {
                        color: #666;
                        margin: 0;
                    }

                    /* Стили для пункта меню Уведомления в хедере */
                    .nav-notification-link .notification-icon {
                        display: flex;
                        align-items: center; /* Для выравнивания иконки, текста и бейджа по центру */
                    }

                    .nav-notification-link .notification-counter {
                        font-size: 1.1rem; /* Немного увеличим шрифт текста "Уведомления" */
                        font-weight: 500;  /* Сделаем чуть жирнее */
                        margin-left: 5px;  /* Небольшой отступ от иконки */
                        color: #ffffff; /* Сделаем текст белым для лучшего контраста на темном фоне хедера */
                        transition: color 0.2s ease-in-out;
                    }

                    .nav-notification-link:hover .notification-counter {
                        color: #f0f0f0; /* Легкое изменение цвета при наведении */
                    }

                    .nav-notification-badge {
                        font-size: 0.8rem !important;    /* Увеличим шрифт в бейдже, !important если нужно перебить стиль Bootstrap */
                        padding: 0.3em 0.6em !important; /* Увеличим padding для размера самого бейджа */
                        background-color: #ff4136 !important; /* Ярко-красный, более насыщенный */
                        color: white !important;
                        border-radius: 10px !important; /* Более скругленный */
                        margin-left: 8px !important;   /* Чуть больше отступ слева */
                        font-weight: bold;
                        box-shadow: 0 0 5px rgba(255, 65, 54, 0.7); /* Легкое свечение для акцента */
                    }

                    .nav-item.active .nav-notification-link .notification-counter,
                    .nav-item .nav-notification-link.active .notification-counter { /* Пример для активной ссылки */
                        font-weight: bold; /* Еще жирнее, если ссылка активна */
                    }
                    /* Конец стилей для пункта меню Уведомления */

                </style>

    </head>
        <body class="{% if current_user.is_authenticated %}logged-in{% endif %}">
            <div class="wrapper">
                {% block menu %}
                <header class="header">
                    <div class="logo">
                        <a href="/">
                            <img src="{{ url_for('static', filename='img/logo.png') }}" alt="logo" style="width: 190px; height: 55px;">
                        </a>
                    </div>
                    <ul class="main_menu">
                        {% if current_user.is_authenticated %}
                            <li class="nav-item">
                                <a class="nav-link nav-notification-link" href="{{ url_for('main.my_notifications') }}">
                                    <div class="notification-icon">
                                        <img src="{{ url_for('static', filename='img/notification-bell.png') }}" alt="Notification Icon" style="width: 25px; height: 25px;">
                                        <span id="notification-counter" class="notification-counter">Уведомления</span>
                                        <span class="badge badge-pill badge-danger ml-2 nav-notification-badge" id="notification-badge" style="display: none;">0</span>
                                    </div>
                                </a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="wikiMenuDropdown" role="button"
                                    data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="fas fa-book-open" style="font-size: 16px; color:#28a745;"></i> Wiki
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="wikiMenuDropdown">
                                    <li><a class="dropdown-item" href="{{ url_for('main.home') }}">
                                        <i class="fas fa-question-circle" style="font-size: 16px; color: #28a745;"></i> FAQ
                                    </a></li>
                                    <li><a class="dropdown-item" href="{{ url_for('main.blog') }}">
                                        <i class="fas fa-newspaper" style="color: #28a745;"></i> Статьи
                                    </a></li>
                                    <li><a class="dropdown-item" href="{{ url_for('post.new_post') }}">
                                        <i class="fas fa-pencil-alt" style="color: #28a745;"></i> Новая статья
                                    </a></li>
                                </ul>
                            </li>

                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="tasksDropdown" role="button"
                                    data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="fas fa-clock" style="font-size: 16px; color: #007bff;"></i> Заявки
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="tasksDropdown">
                                    <li><a class="dropdown-item" href="{{ url_for('main.my_issues') }}">
                                        <i class="fas fa-tasks" style="color: #007bff;"></i> Мои заявки
                                    </a></li>
                                    <li><a class="dropdown-item" href="{{ url_for('main.new_issue') }}">
                                        <i class="fas fa-pen" style="color: #007bff;"></i> Новая заявка
                                    </a></li>
                                </ul>
                            </li>

                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="otherDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <i class="fas fa-ellipsis-v" style="color: orange;"></i> Прочее
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="otherDropdown">
                                    <li><a class="dropdown-item" href="{{ url_for('users.all_users') }}">
                                        <i class="fas fa-users" style="color: #007bff;"></i> Контакты
                                    </a></li>
                                    <!-- <li><a class="dropdown-item" href="{{ url_for('netmonitor.network_monitor') }}">
                                        <i class="fas fa-network-wired" style="color: #17a2b8;"></i> Мониторинг Finesse
                                    </a></li> -->
                                    <li class="dropdown-submenu">
                                        <a class="dropdown-item dropdown-toggle" href="#" id="reportsDropdown" role="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-chart-pie" style="color: #007bff;"></i> Отчеты
                                        </a>
                                        <ul class="dropdown-menu" aria-labelledby="reportsDropdown">
                                            <li><a class="dropdown-item" href="{{ url_for('main.reports') }}">
                                                <i class="fas fa-chart-bar" style="color: #007bff;"></i> Общая статистика
                                            </a></li>
                                            {% if current_user.can_access_quality_control %}
                                            <li><a class="dropdown-item" href="{{ url_for('main.quality_control') }}">
                                                <i class="fas fa-clipboard-check" style="color: #28a745;"></i> Контроль качества
                                            </a></li>
                                            {% endif %}
                                        </ul>
                                    </li>
                                    <li class="nav-item" style="display: none;">
                                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#chatModal">
                                            <i class="fas fa-comments" style="color: #007bff;"></i> Чат
                                        </a>
                                    </li>
                                </ul>
                            </li>

                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button"
                                    data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                    <img src="{{ url_for('static', filename='profile_pics/' + current_user.username + '/account_img/' + current_user.image_file) }}"
                                            alt="user_avatar" class="avatar-img" style="max-width: 35px; max-height: 40px; border-radius: 50%;">
                                    <span style="font-size: 14px; color: #fff;">
                                        {% set names = current_user.full_name.split() %}
                                        {{ names[0] }} {{ names[1][:1] }}.{{ names[-1][:1] }}.
                                    </span>
                                </a>
                                <ul class="dropdown-menu" aria-labelledby="userDropdown">
                                    <li><a class="dropdown-item" href="{{ url_for('users.account') }}">
                                        <i class="fas fa-user" style="color: #28a745;"></i> Профиль
                                    </a></li>
                                    <li><a class="dropdown-item" href="{{ url_for('users.logout') }}">
                                        <i class="fas fa-sign-out-alt" style="color: #dc3545;"></i> Выйти
                                    </a></li>
                                </ul>
                            </li>

                            {% if current_user.is_authenticated and current_user.can_access_quality_control %}
                            {% endif %}
                        {% else %}
                            <li class="nav-item"><a class="nav-link" href="{{ url_for('main.home') }}">Wiki</a></li>
                            <li class="nav-item"><a class="nav-link bg-primary rounded" href="{{ url_for('users.login') }}">Вход</a></li>
                            <li class="nav-item"><a class="nav-link" href="{{ url_for('users.register') }}">Регистрация</a></li>
                        {% endif %}
                    </ul>

                    <style>
                        .main_menu li a {
                            font-size: 16px; /* Размер шрифта для пунктв меню */
                            color: #fafafa; /* Цвет текста по умолчанию */
                        }

                        .main_menu li a:hover {
                            color: #333; /* Цвет текста при наведении мыши */
                        }
                            .dropdown-menu a.dropdown-item {
                            color: #333; /* Цвет текста элементов списка */
                        }

                        .dropdown-menu a.dropdown-item:hover {
                            background-color: #ddd; /* Цвет фона элемента списка при наведении */
                        }
                    </style>
                </header>
                {% endblock menu %}
                <div class="content">
                        <main role="main" class="main-section">
                            <div class="row">
                                <div class="col">

                                    {% block content %}{% endblock content %}
                                </div>
                            </div>
                                <!-- Блок для вывода содержимого страницы -->
                            {% block main_page %}{% endblock %}

                        </main>

                </div>
            </div>
                <!-- Option 1: Bootstrap Bundle with Popper -->
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

                <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.js"></script>
                <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap5.js"></script>

                {% block scripts %}{% endblock %}
                {% block styles %}{% endblock %}

                <!-- Блок футера -->
            {% if request.path == '/' %}
                <div class="footer-bottom-panel">
                    <div class="left-logo-side">
                        <img src="https://r.tez-tour.com/portal/images/main/logo-white.png" title="TEZ TOUR" class="footer-logo">
                        <br>
                        2024 - 2025 © TEZ TOUR
                        <br>
                        <a href="mailto:help@tez-tour.com">help@tez-tour.com</a>
                        <br>
                    </div>
                </div>
            {% endif %}

            <script src="{{ url_for('static', filename='js/dropdown.js') }}"></script>

            {% include '_new_issues_sidebar.html' %}
            {% if current_user.is_authenticated and current_user.can_access_quality_control and request.endpoint == 'main.quality_control' %}
                {% include '_comment_notifications.html' %}
            {% endif %}

            <script>
                function checkConnection() {
                    // Проверяем, авторизован ли пользователь
                    if (document.body.classList.contains('logged-in')) {
                        $.ajax({
                            url: "{{ url_for('main.check_connection') }}",
                            type: 'GET',
                            success: function(response) {
                                if (!response.connected) {
                                    Swal.fire({
                                        icon: 'warning',
                                        title: 'Потеряно соединение',
                                        text: 'Потеряно соединение с базой данных. Проверьте активность VPN-подключения через Cisco AnyConnect и убедитесь, что оно работает корректно. Если проблема сохраняется, перезапустите VPN-клиент или приложение и проверьте настройки сети.',
                                        position: 'top',
                                        showConfirmButton: false,
                                        timer: 10000,
                                        timerProgressBar: true,
                                        toast: true,
                                        didOpen: (toast) => {
                                            toast.addEventListener('mouseenter', Swal.stopTimer)
                                            toast.addEventListener('mouseleave', Swal.resumeTimer)
                                        }
                                    });
                                }
                            }
                        });
                    }
                }

                // Проверяем соединение каждые 30 секунд
                setInterval(checkConnection, 30000);

                // Начальная проверка при загрузке страницы
                checkConnection();
            </script>

        </body>
</html>
