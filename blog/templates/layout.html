<!DOCTYPE html>
<html lang="ru">
    <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <meta name="csrf-token" content="{{ csrf_token() }}">

            {# CRITICAL: Theme initialization BEFORE any stylesheets to prevent FOUC #}
            {% include 'partials/theme-init.html' %}

            {# Theme CSS - must be loaded first #}
            <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-toggle-integration.css') }}">

            <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –≤–º–µ—Å—Ç–æ CDN -->
            <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/dataTables.bootstrap5.min.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/media_css.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/tez_hero_modern.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/notifications_polling_redesign.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/redmine_widget.css') }}">
            <link rel="icon" href="{{ url_for('static', filename='favicon/favicon.ico') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/all.min.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/roboto-font.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/sweetalert2.min.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-menu.css') }}">

            <!-- Modern Splash Screen CSS -->
            <link rel="stylesheet" href="{{ url_for('static', filename='css/modern_splash_screen.css') }}">

            <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ JS —Ñ–∞–π–ª—ã -->
                    <script src="{{ url_for('static', filename='js/sweetalert2.all.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery-3.5.1.min.js') }}"></script>
            {% block title %}
              <title>
                {% if title %}
                  {{ title }} - TEZ Navigator
                {% else %}
                  TEZ Navigator ‚Äî –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä –ø–æ –∑–∞—è–≤–∫–∞–º –∏ –∑–∞–¥–∞—á–∞–º
                {% endif %}
              </title>
            {% endblock title %}

            <!-- jQuery —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω –≤—ã—à–µ -->
            <script>
                /* === –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–π–¥–∂–∞ === */
                function refreshNotificationBadge(count) {
                    const badgeSel = '#notification-badge';
                    if (count > 0) {
                        if ($(badgeSel).length === 0) {
                            $('.notification-link .nav-icon-wrapper').append('<span class="notification-badge" id="notification-badge">' + count + '</span>');
                        } else {
                            $(badgeSel).text(count).show();
                        }
                    } else {
                        $(badgeSel).remove();
                    }
                }

                window.refreshNotificationBadge = refreshNotificationBadge; // –ø—É–±–ª–∏—á–Ω–æ –¥–ª—è WebPush

                // –£–õ–£–ß–®–ï–ù–ù–´–ô AJAX-–ø—É–ª–ª–∏–Ω–≥ —Å —á–∞—Å—Ç—ã–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
                function updateNotificationCount() {
                    console.log('[NotificationBadge] üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...');

                    $.ajax({
                        url: "{{ url_for('main.get_notification_count') }}",
                        type: 'GET',
                        success: function(data) {
                            const currentCount = parseInt($('#notification-badge').text() || '0', 10);
                            const newCount = data.count || 0;

                            console.log(`[NotificationBadge] –ü–æ–ª—É—á–µ–Ω —Å—á–µ—Ç—á–∏–∫: ${newCount} (–±—ã–ª–æ: ${currentCount})`);

                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤—Å–µ–≥–¥–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                            refreshNotificationBadge(newCount);

                            // –ï—Å–ª–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                            if (newCount > currentCount && currentCount >= 0) {
                                console.log(`[NotificationBadge] üîî –ù–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: +${newCount - currentCount}`);

                                // Dispatch event –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                                window.dispatchEvent(new CustomEvent('newNotification', {
                                    detail: { count: newCount, difference: newCount - currentCount }
                                }));
                            }
                        },
                        error: function(xhr) {
                            console.error('[NotificationBadge] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', xhr);
                            // –ù–µ —É–¥–∞–ª—è–µ–º badge –ø—Ä–∏ –æ—à–∏–±–∫–µ, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
                        }
                    });
                }

                // –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–º–µ–Ω—å—à–∏–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
                setInterval(updateNotificationCount, 10000);
                updateNotificationCount();

                /* === –õ–∏—Å—Ç–µ–Ω–µ—Ä –¥–ª—è –ø—É—à-–≤–∏–¥–∂–µ—Ç–∞ === */
                window.addEventListener('newNotification', function(e) {
                    // e.detail.count –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–æ–≤—ã–π total, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äì –ø—Ä–∏–±–∞–≤–ª—è–µ–º 1
                    const current = parseInt($('#notification-badge').text() || '0', 10);
                    const newCount = e.detail && e.detail.count !== undefined ? e.detail.count : current + 1;
                    refreshNotificationBadge(newCount);
                });

                /* === –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã /notifications === */
                if (window.location.pathname === '/notifications') {
                    // –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–≤–∫–ª—é—á–∞—è –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ)
                    const pageCount = JSON.parse('{{ (count_notifications_page | default(0)) | tojson }}');
                    refreshNotificationBadge(pageCount);
                }

                /* ==== Tasks Notification badge (—É–¥–∞–ª–µ–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π) ==== */
            </script>

            <script>
                // Sticky header shadow + scroll progress for header bar
                (function(){
                  const onScroll = () => {
                    const max = (document.documentElement.scrollHeight - window.innerHeight) || 1;
                    const p = Math.max(0, Math.min(1, window.scrollY / max));
                    document.documentElement.style.setProperty('--scroll-progress', (p*100).toFixed(1) + '%');
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ document.body –ø–µ—Ä–µ–¥ –æ–±—Ä–∞—â–µ–Ω–∏–µ–º –∫ classList
                    if (document.body && document.body.classList) {
                      document.body.classList.toggle('scrolled', window.scrollY > 4);
                    }
                  };
                  window.addEventListener('scroll', onScroll, { passive: true });
                  // –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –≤—ã–∑–æ–≤–æ–º
                  if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', onScroll);
                  } else {
                    onScroll();
                  }
                })();
            </script>

            <script>
                // Fallback –¥–ª—è –ª–æ–≥–æ—Ç–∏–ø–æ–≤: –µ—Å–ª–∏ CDN –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
                document.addEventListener('DOMContentLoaded', function () {
                    const fallbackSrc = JSON.parse('{{ url_for("static", filename="img/tez-tour-logo-30.jpg") | tojson }}');
                    document.querySelectorAll('.splash-company-logo, .footer-logo').forEach(function(img){
                        img.addEventListener('error', function onLogoError(){
                            if (img.dataset.fallbackApplied === '1') return;
                            img.dataset.fallbackApplied = '1';
                            img.src = fallbackSrc;
                        }, { once: true });
                    });
                });
            </script>

            <script>
                                                    $(document).ready(function() {
                                // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ flash-—Å–æ–æ–±—â–µ–Ω–∏—è
                                $('.alert').remove();

                                var flashMessages = JSON.parse('{{ get_flashed_messages(with_categories=true) | tojson | safe }}');
                                if (flashMessages.length > 0) {
                                    flashMessages.forEach(function(flash) {
                                        var category = flash[0];
                                        var message = flash[1];

                                        var icon = 'info';
                                        if (category === 'success') icon = 'success';
                                        if (category === 'error') icon = 'error';
                                        if (category === 'warning') icon = 'warning';

                                        Swal.fire({
                                            icon: icon,
                                            title: category.charAt(0).toUpperCase() + category.slice(1),
                                            text: message,
                                            timer: 5000,
                                            showConfirmButton: false,
                                            toast: true,
                                            position: 'top-end',
                                            timerProgressBar: true
                                        });
                                    });
                                }
                            });

                </script>

                <!-- Layout Styles - External CSS -->
                <link rel="stylesheet" href="{{ url_for('static', filename='css/layout_styles.css') }}">
                    </style>

    </head>
        <body class="{% if current_user.is_authenticated %}logged-in{% endif %}"
              {% if request.endpoint == 'users.login' or request.endpoint == 'users.register' %}
              data-splash-time="3500"
              data-splash-once="false"
              data-splash-debug="false"
              data-show-splash="true"
              {% else %}
              data-show-splash="false"
              {% endif %}>

            {% if request.endpoint == 'users.login' or request.endpoint == 'users.register' %}
            <!-- ================================
                 MODERN SPLASH SCREEN - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ login/register
                 ================================ -->
            <div class="modern-splash-screen">
                <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω -->
                <div class="splash-background">
                    <!-- –ß–∞—Å—Ç–∏—Ü—ã –∏ –≥–µ–æ–º–µ—Ç—Ä–∏—è –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
                </div>

                <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
                <div class="splash-content">
                    <div class="splash-glass-card">
                                                <!-- –õ–æ–≥–æ—Ç–∏–ø –∏ –±—Ä–µ–Ω–¥–∏–Ω–≥ -->
                        <div class="splash-logo-container">
                            <div class="splash-logo-icon">
                                <!-- –ù–∞—Å—Ç–æ—è—â–∏–π –ª–æ–≥–æ—Ç–∏–ø TEZ TOUR —Å fallback -->
                                     <img src="https://s.tez-tour.com/article/7025866/TEZ_TOUR_logo_horizontal_cmyk_7505.png"
                                      alt="TEZ TOUR"
                                      class="splash-company-logo">
                                <!-- Fallback –∏–∫–æ–Ω–∫–∞ –µ—Å–ª–∏ –Ω–∏ –æ–¥–∏–Ω –ª–æ–≥–æ—Ç–∏–ø –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è -->
                                <i class="fas fa-tasks splash-fallback-icon" style="display: none;"></i>

                                <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã -->
                                <div class="splash-logo-glow"></div>
                                <div class="splash-logo-pulse"></div>
                            </div>
                        </div>

                        <!-- –ó–∞–≥–æ–ª–æ–≤–∫–∏ -->
                        <h1 class="splash-title">
                            <span class="title-word" data-delay="1.2">TEZ</span>
                            <span class="title-word" data-delay="1.4">Navigator</span>
                        </h1>

                        <!-- –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
                        <div class="splash-loading">
                            <!-- –ö—Ä—É–≥–æ–≤–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ -->
                            <div class="splash-progress-ring-container">
                                <div class="splash-progress-ring">
                                    <svg class="progress-ring-svg" viewBox="0 0 120 120">
                                        <circle class="progress-ring-background" cx="60" cy="60" r="50"/>
                                        <circle class="progress-ring-fill" cx="60" cy="60" r="50"/>
                                    </svg>
                                    <div class="progress-percentage">
                                        <span class="percentage-number">0</span>
                                        <span class="percentage-symbol">%</span>
                                    </div>
                                </div>
                            </div>

                            <!-- –õ–∏–Ω–µ–π–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å —ç—Ç–∞–ø–∞–º–∏ -->
                            <div class="splash-progress-container">
                                <div class="splash-progress-bar">
                                    <div class="progress-segments">
                                        <div class="progress-segment" data-stage="1"></div>
                                        <div class="progress-segment" data-stage="2"></div>
                                        <div class="progress-segment" data-stage="3"></div>
                                        <div class="progress-segment" data-stage="4"></div>
                                    </div>
                                </div>
                                <div class="progress-labels">
                                    <span class="progress-label" data-stage="1">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ</span>
                                    <span class="progress-label" data-stage="2">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</span>
                                    <span class="progress-label" data-stage="3">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</span>
                                    <span class="progress-label" data-stage="4">–ì–æ—Ç–æ–≤–æ</span>
                                </div>
                            </div>

                            <!-- –£–ª—É—á—à–µ–Ω–Ω—ã–µ –ø—É–ª—å—Å–∏—Ä—É—é—â–∏–µ —Ç–æ—á–∫–∏ -->
                            <div class="splash-dots">
                                <div class="splash-dot" data-delay="0"></div>
                                <div class="splash-dot" data-delay="0.2"></div>
                                <div class="splash-dot" data-delay="0.4"></div>
                                <div class="splash-dot" data-delay="0.6"></div>
                                <div class="splash-dot" data-delay="0.8"></div>
                            </div>

                            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ç–µ–∫—Å—Ç –∑–∞–≥—Ä—É–∑–∫–∏ -->
                            <div class="splash-loading-text">
                                <span class="loading-main-text">
                                    {% if request.endpoint == 'users.login' %}
                                        –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
                                    {% elif request.endpoint == 'users.register' %}
                                        –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
                                    {% else %}
                                        –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                                    {% endif %}
                                </span>
                                <span class="loading-dots">
                                    <span class="dot-1">.</span>
                                    <span class="dot-2">.</span>
                                    <span class="dot-3">.</span>
                                </span>
                            </div>

                            <!-- –°—Ç–∞—Ç—É—Å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ -->
                            <div class="splash-status-text">
                                –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <div class="wrapper">
                {% block menu %}
                <header class="modern-header">
                    <div class="header-container">
                        <!-- Logo Section -->
                        <div class="logo-section">
                            <a href="/" class="logo-link">
                                <div class="logo-wrapper">
                                    <div class="logo-icon">
                                        <i class="fas fa-tasks"></i>
                                        <div class="logo-icon-glow"></div>
                                    </div>
                                    <div class="logo-text">
                                        <span class="logo-main">TEZ Navigator</span>
                                        <span class="logo-sub">–Ω–∞–≤–∏–≥–∞—Ç–æ—Ä –ø–æ –∑–∞—è–≤–∫–∞–º –∏ –∑–∞–¥–∞—á–∞–º</span>
                                    </div>
                                </div>
                            </a>
                        </div>

                        <!-- Navigation Menu -->
                        <nav class="main-navigation">
                            <ul class="nav-menu">
                        {% if current_user.is_authenticated %}
                        <!-- Search Item -->
                            <li class="nav-item search-item me-3 d-flex align-items-center">
                                <div class="search-wrapper position-relative" style="width: 250px;">
                                    <!-- –ò–∫–æ–Ω–∫–∞ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º position: absolute -->
                                    <i class="fas fa-search text-muted position-absolute" 
                                       style="left: 10px; top: 50%; transform: translateY(-50%); z-index: 10;"></i>
                                    <input type="text" id="nav-search-input" class="form-control form-control-sm ps-4" 
                                           placeholder="–ü–æ–∏—Å–∫..." autocomplete="off" 
                                           style="padding-left: 35px !important; border-radius: 20px;">
                                    
                                    <!-- –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ -->
                                    <div id="search-results" class="dropdown-menu w-100 shadow-sm mt-1" 
                                         style="display: none; max-height: 400px; overflow-y: auto; border-radius: 12px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.15) !important;"></div>
                                </div>
                            </li>

                                    <!-- Notifications -->
                            <li class="nav-item">
                                <a class="nav-link notification-link" href="{{ url_for('main.my_notifications') }}">
                                    <div class="nav-icon-wrapper">
                                        <i class="fas fa-bell nav-icon notification-icon"></i>
                                        <span class="nav-text">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                                        {% if count_notifications > 0 %}
                                        <span class="notification-badge" id="notification-badge">{{ count_notifications }}</span>
                                        {% endif %}
                                    </div>
                                </a>
                            </li>

                                    <!-- Wiki Dropdown -->
                            <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" href="#" id="wikiDropdown" role="button" data-bs-toggle="dropdown">
                                            <div class="nav-icon-wrapper">
                                                <i class="fas fa-book-open nav-icon wiki-icon"></i>
                                                <span class="nav-text">Wiki</span>
                                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                                            </div>
                                        </a>
                                        <ul class="dropdown-menu modern-dropdown" aria-labelledby="wikiDropdown">
                                            <li class="dropdown-header">
                                                <i class="fas fa-book-open"></i>
                                                <span>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</span>
                                            </li>
                                    <li><a class="dropdown-item" href="{{ url_for('main.home') }}">
                                                <i class="fas fa-question-circle"></i>
                                                <span>FAQ</span>
                                    </a></li>
                                    <li><a class="dropdown-item" href="{{ url_for('main.blog') }}">
                                                <i class="fas fa-newspaper"></i>
                                                <span>–°—Ç–∞—Ç—å–∏</span>
                                    </a></li>
                                            <li class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{{ url_for('post.new_post') }}">
                                                <i class="fas fa-plus-circle"></i>
                                                <span>–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è</span>
                                    </a></li>
                                </ul>
                            </li>

                                    <!-- Tasks Dropdown -->
                            <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" href="#" id="tasksDropdown" role="button" data-bs-toggle="dropdown">
                                            <div class="nav-icon-wrapper">
                                                <i class="fas fa-ticket-alt nav-icon tasks-icon"></i>
                                                <span class="nav-text">–ó–∞—è–≤–∫–∏</span>
                                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                                            </div>
                                        </a>
                                        <ul class="dropdown-menu modern-dropdown" aria-labelledby="tasksDropdown">
                                            <li class="dropdown-header">
                                                <i class="fas fa-ticket-alt"></i>
                                                <span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</span>
                                            </li>
                                    <li><a class="dropdown-item" href="{{ url_for('main.my_issues') }}">
                                                <i class="fas fa-tasks"></i>
                                                <span>–ú–æ–∏ –∑–∞—è–≤–∫–∏</span>
                                    </a></li>
                                            <li class="dropdown-divider"></li>
                                            <li><a class="dropdown-item new-task" href="{{ url_for('main.new_issue') }}">
                                                <i class="fas fa-plus-circle"></i>
                                                <span>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</span>
                                    </a></li>
                                </ul>
                            </li>

                        {% if current_user.is_authenticated and current_user.is_redmine_user %}
                            <!-- New Tasks (–ó–∞–¥–∞—á–∏) Dropdown -->
                            <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" href="#" id="issuesDropdownMenu" role="button" data-bs-toggle="dropdown">
                                            <div class="nav-icon-wrapper">
                                                <i class="fas fa-clipboard-list nav-icon issues-icon"></i>
                                                <span class="nav-text">–ó–∞–¥–∞—á–∏</span>
                                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                                            </div>
                                        </a>
                                        <ul class="dropdown-menu modern-dropdown" aria-labelledby="issuesDropdownMenu">
                                            <li class="dropdown-header">
                                                <i class="fas fa-clipboard-list"></i>
                                                <span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</span>
                                            </li>
                                    <li><a class="dropdown-item" href="{{ url_for('tasks.my_tasks_page') }}">
                                                <i class="fas fa-clipboard-list"></i>
                                                <span>–ú–æ–∏ –∑–∞–¥–∞—á–∏</span>
                                    </a></li>
                                            <li class="dropdown-divider"></li>
                                            <li><a class="dropdown-item new-issue" href="#"> {# –ó–ê–ú–ï–ù–ò–¢–¨ # –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π url_for –¥–ª—è "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞" #}
                                                <i class="fas fa-plus-circle"></i>
                                                <span>–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</span>
                                    </a></li>
                                </ul>
                            </li>
                        {% endif %}

                                    <!-- Other Dropdown -->
                            <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" href="#" id="otherDropdown" role="button" data-bs-toggle="dropdown">
                                            <div class="nav-icon-wrapper">
                                                <i class="fas fa-th nav-icon other-icon"></i>
                                                <span class="nav-text">–ü—Ä–æ—á–µ–µ</span>
                                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                                            </div>
                                        </a>
                                        <ul class="dropdown-menu modern-dropdown" aria-labelledby="otherDropdown">
                                            <li class="dropdown-header">
                                                <i class="fas fa-th"></i>
                                                <span>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</span>
                                            </li>
                                            <li><a class="dropdown-item" href="{{ url_for('users.all_users') }}">
                                                <i class="fas fa-users"></i>
                                                <span>–ö–æ–Ω—Ç–∞–∫—Ç—ã</span>
                                            </a></li>
                                            {% if current_user.can_access_contact_center_moscow %}
                                            <li><a class="dropdown-item" href="{{ url_for('calls.contact_center_moscow') }}">
                                                <i class="fas fa-phone-alt"></i>
                                                <span>–ö–æ–Ω—Ç–∞–∫—Ç-—Ü–µ–Ω—Ç—Ä –ú–æ—Å–∫–≤–∞</span>
                                            </a></li>
                                            {% endif %}
                                            <li class="dropdown-submenu">
                                                <a class="dropdown-item submenu-toggle" href="#" id="reportsDropdown">
                                                    <i class="fas fa-chart-line"></i>
                                                    <span>–û—Ç—á–µ—Ç—ã</span>
                                                    <i class="fas fa-chevron-right submenu-arrow"></i>
                                                </a>
                                                <ul class="dropdown-menu submenu-dropdown">
                                                    <li><a class="dropdown-item" href="{{ url_for('main.reports') }}">
                                                        <i class="fas fa-chart-bar"></i>
                                                        <span>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                                            </a></li>
                                            {% if current_user.can_access_quality_control %}
                                            <li><a class="dropdown-item" href="{{ url_for('main.quality_control') }}">
                                                        <i class="fas fa-clipboard-check"></i>
                                                        <span>–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞</span>
                                            </a></li>
                                            {% endif %}
                                        </ul>
                                    </li>
                                        </ul>
                            </li>

                                    <!-- User Profile Dropdown -->
                                    <li class="nav-item dropdown user-dropdown">
                                        <a class="nav-link dropdown-toggle user-link" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                            <div class="user-profile">
                                                <div class="user-avatar">
                                    <img src="{{ url_for('static', filename='profile_pics/' + current_user.username + '/account_img/' + current_user.image_file) }}"
                                                         alt="user_avatar" class="avatar-img">
                                                    <div class="online-indicator"></div>
                                                </div>
                                                <div class="user-info">
                                                    <span class="user-name">
                                        {% set names = current_user.full_name.split() %}
                                        {{ names[0] }} {{ names[1][:1] }}.{{ names[-1][:1] }}.
                                    </span>
                                                    <span class="user-role">{{ current_user.position[:20] + '...' if current_user.position and current_user.position|length > 20 else current_user.position or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}</span>
                                                </div>
                                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                                            </div>
                                        </a>
                                        <ul class="dropdown-menu modern-dropdown user-dropdown-menu" aria-labelledby="userDropdown">
                                            <li class="dropdown-header user-header">
                                                <div class="user-avatar-large">
                                                    <img src="{{ url_for('static', filename='profile_pics/' + current_user.username + '/account_img/' + current_user.image_file) }}"
                                                         alt="user_avatar">
                                                </div>
                                                <div class="user-details">
                                                    <span class="user-full-name">{{ current_user.full_name or current_user.username }}</span>
                                                    <span class="user-email">{{ current_user.email }}</span>
                                                </div>
                                            </li>
                                            <li class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{{ url_for('users.account') }}">
                                                <i class="fas fa-user-cog"></i>
                                                <span>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</span>
                                    </a></li>
                                            <li class="dropdown-divider"></li>
                                            <li><a class="dropdown-item logout-item" href="{{ url_for('users.logout') }}">
                                                <i class="fas fa-sign-out-alt"></i>
                                                <span>–í—ã–π—Ç–∏</span>
                                    </a></li>
                                </ul>
                            </li>
                        {% else %}
                                    <!-- Guest Menu -->
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('main.home') }}">
                                            <div class="nav-icon-wrapper">
                                                <i class="fas fa-book-open nav-icon"></i>
                                                <span class="nav-text">Wiki</span>
                                            </div>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link login-btn" href="{{ url_for('users.login') }}">
                                            <div class="nav-icon-wrapper">
                                                <i class="fas fa-sign-in-alt nav-icon"></i>
                                                <span class="nav-text">–í—Ö–æ–¥</span>
                                            </div>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link register-btn" href="{{ url_for('users.register') }}">
                                            <div class="nav-icon-wrapper">
                                                <i class="fas fa-user-plus nav-icon"></i>
                                                <span class="nav-text">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
                                            </div>
                                        </a>
                                    </li>
                        {% endif %}

                                    <!-- Theme Toggle Button -->
                                    <li class="nav-item theme-toggle-item">
                                        {% include 'partials/theme-toggle-button.html' %}
                                    </li>
                    </ul>
                        </nav>

                        <!-- Mobile Menu Toggle -->
                        <div class="mobile-menu-toggle">
                            <span class="hamburger-line"></span>
                            <span class="hamburger-line"></span>
                            <span class="hamburger-line"></span>
                        </div>
                    </div>
                </header>

                <!-- Mobile Menu Panel -->
                <div class="mobile-menu-overlay"></div>
                <nav class="mobile-menu-panel" id="mobile-menu-panel" aria-hidden="true" role="dialog">
                    <div class="mobile-menu-header">
                        <h2 class="mobile-menu-title">–ú–µ–Ω—é</h2>
                        <button class="mobile-menu-close" id="mobile-menu-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é">&times;</button>
                    </div>
                    <ul class="mobile-menu-links">
                        <!-- –°—Å—ã–ª–∫–∏ –±—É–¥—É—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã —Å—é–¥–∞ —Å –ø–æ–º–æ—â—å—é JavaScript -->
                    </ul>
                </nav>

                <!-- Modern Header Styles - External CSS -->
                <link rel="stylesheet" href="{{ url_for('static', filename='css/layout_header_styles.css') }}">
                {% endblock menu %}
                <div class="content">
                        <main role="main" class="main-section">
                            <div class="row">
                                <div class="col">

                                    {% block content %}{% endblock content %}
                                </div>
                            </div>
                                <!-- –ë–ª–æ–∫ –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
                            {% block main_page %}{% endblock %}

                        </main>

                </div>
            </div>
                <!-- jQuery first, then Bootstrap, then DataTables -->
                <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
                <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
                <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

                {% block scripts %}{% endblock %}
                {% block styles %}{% endblock %}

                <!-- –ë–ª–æ–∫ —Ñ—É—Ç–µ—Ä–∞ -->
            {% if request.path == '/' and request.endpoint != 'users.register' %}
                <div class="footer-bottom-panel">
                    <div class="left-logo-side">
                        <img src="https://s.tez-tour.com/article/7025866/TEZ_TOUR_logo_horizontal_cmyk_7505.png" title="TEZ TOUR" class="footer-logo">
                        <br>
                        2024 - 2025 ¬© TEZ Navigator
                        <br>
                        <a href="mailto:help@tez-tour.com">help@tez-tour.com</a>
                        <br>
                    </div>
                </div>
            {% endif %}

            <script src="{{ url_for('static', filename='js/dropdown.js') }}"></script>

            <!-- Dropdown State Cleanup Script -->
            <script>
                // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è dropdown –º–µ–Ω—é –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–∞—Ö –º–µ–∂–¥—É —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏
                function cleanupDropdownState() {
                    try {
                        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ dropdown –º–µ–Ω—é Bootstrap
                        const dropdowns = document.querySelectorAll('.dropdown-menu.show');
                        if (dropdowns.length > 0) {
                            dropdowns.forEach(dropdown => {
                                dropdown.classList.remove('show');
                            });

                            // –£–¥–∞–ª—è–µ–º –∫–ª–∞—Å—Å show —Å dropdown toggle —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                            const toggles = document.querySelectorAll('.dropdown-toggle[aria-expanded="true"]');
                            toggles.forEach(toggle => {
                                toggle.setAttribute('aria-expanded', 'false');
                                toggle.classList.remove('show');
                            });

                            console.log('[DropdownCleanup] ‚úÖ –û—á–∏—â–µ–Ω–æ ' + dropdowns.length + ' –æ—Ç–∫—Ä—ã—Ç—ã—Ö dropdown –º–µ–Ω—é');
                        }
                    } catch (error) {
                        console.error('[DropdownCleanup] ‚ùå –û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ dropdown:', error);
                    }
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π URL –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å–º–µ–Ω—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                let currentUrl = window.location.href;

                // –û—á–∏—â–∞–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–º–µ–Ω–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                window.addEventListener('pageshow', function(event) {
                    // –ï—Å–ª–∏ URL –∏–∑–º–µ–Ω–∏–ª—Å—è –∏–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –∫—ç—à–∞
                    if (event.persisted || window.location.href !== currentUrl) {
                        setTimeout(cleanupDropdownState, 50);
                        currentUrl = window.location.href;
                    }
                });

                // –û—á–∏—â–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–æ–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                document.addEventListener('DOMContentLoaded', function() {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ dropdown –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    setTimeout(() => {
                        const openDropdowns = document.querySelectorAll('.dropdown-menu.show');
                        if (openDropdowns.length > 0) {
                            console.log('[DropdownCleanup] üîß –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—Ç–∫—Ä—ã—Ç—ã–µ dropdown –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã, –æ—á–∏—â–∞–µ–º...');
                            cleanupDropdownState();
                        }
                    }, 200);
                });

                // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—á–∏—Å—Ç–∫–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
                window.forceCleanupDropdowns = cleanupDropdownState;
            </script>


            <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
            <!-- –ú–æ–¥—É–ª—å statistics_interactive.js —É–¥–∞–ª–µ–Ω, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ —à–∞–±–ª–æ–Ω—ã -->

            <!-- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Service Worker -->
            <script>
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Service Worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.addEventListener('message', function(event) {
                        console.log('[Main] –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Service Worker:', event.data);

                        const data = event.data;

                        if (data.type === 'PLAY_SOUND') {
                            try {
                                console.log('[Main] –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', data.soundUrl);

                                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç Audio
                                const audio = new Audio(data.soundUrl);

                                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                                audio.volume = 0.7;
                                audio.preload = 'auto';

                                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                                audio.addEventListener('play', () => {
                                    console.log('[Main] –ó–≤—É–∫ –Ω–∞—á–∞–ª –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è');
                                });

                                audio.addEventListener('ended', () => {
                                    console.log('[Main] –ó–≤—É–∫ –∑–∞–∫–æ–Ω—á–∏–ª –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è');
                                });

                                audio.addEventListener('error', (error) => {
                                    console.error('[Main] –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', error);
                                });

                                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
                                audio.play().catch(error => {
                                    console.warn('[Main] –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫:', error);
                                    // –ü—Ä–æ–±—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫ –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                    document.addEventListener('click', function playOnClick() {
                                        audio.play().catch(console.error);
                                        document.removeEventListener('click', playOnClick);
                                    }, { once: true });
                                });
                            } catch (error) {
                                console.error('[Main] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–∞:', error);
                            }
                        }
                    });
                }
            </script>

            {% include '_new_issues_sidebar.html' %}
            {% if current_user.is_authenticated and current_user.can_access_quality_control and request.endpoint == 'main.quality_control' %}
                {% include '_comment_notifications.html' %}
            {% endif %}

            <script>
                // üì° Polling —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ FCM)
                let lastPollingTimestamp = null;
                let lastNotificationCount = 0;
                let lastNotificationIds = new Set();

                function pollNotifications() {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    if (!document.body.classList.contains('logged-in')) {
                        return;
                    }

                    $.ajax({
                        url: "{{ url_for('main.poll_notifications') }}",
                        type: 'GET',
                        success: function(response) {
                            if (response.success) {
                                const notifications = response.notifications;
                                const currentTimestamp = response.timestamp;
                                const currentTotalCount = response.total_count;

                                // –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–∏–µ ID —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                                const currentNotificationIds = new Set();
                                notifications.status_notifications.forEach(n => currentNotificationIds.add('status_' + n.id));
                                notifications.comment_notifications.forEach(n => currentNotificationIds.add('comment_' + n.id));

                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–∏—á–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                                if (lastPollingTimestamp === null) {
                                    // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ - –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–µ–∑ –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                                    lastNotificationCount = currentTotalCount;
                                    lastNotificationIds = new Set(currentNotificationIds);
                                    console.log(`[Polling] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: ${currentTotalCount} —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π`);
                                } else {
                                    // –ò—â–µ–º –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –±—ã–ª–æ –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑)
                                    const newNotifications = {
                                        status_notifications: notifications.status_notifications.filter(n =>
                                            !lastNotificationIds.has('status_' + n.id)
                                        ),
                                        comment_notifications: notifications.comment_notifications.filter(n =>
                                            !lastNotificationIds.has('comment_' + n.id)
                                        )
                                    };

                                    const newCount = newNotifications.status_notifications.length +
                                                   newNotifications.comment_notifications.length;

                                    if (newCount > 0) {
                                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
                                        showPollingNotification(newNotifications);
                                        console.log(`[Polling] –ù–∞–π–¥–µ–Ω–æ ${newCount} –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π`);
                                    } else {
                                        console.log(`[Polling] –ù–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç (–≤—Å–µ–≥–æ: ${currentTotalCount})`);
                                    }

                                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                                    lastNotificationIds = new Set(currentNotificationIds);
                                }

                                lastPollingTimestamp = currentTimestamp;
                                lastNotificationCount = currentTotalCount;
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('[Polling] –û—à–∏–±–∫–∞:', error);
                        }
                    });
                }

                function showPollingNotification(notifications) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–∫—Ä—ã—Ç –ª–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç
                    const isModernWidgetClosed = localStorage.getItem('notificationsWidgetClosed') === 'true';

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    const hasNewNotifications = (notifications.status_notifications && notifications.status_notifications.length > 0) ||
                                              (notifications.comment_notifications && notifications.comment_notifications.length > 0) ||
                                              (notifications.redmine_notifications && notifications.redmine_notifications.length > 0);

                    // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ï—Å–ª–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω, –ø–µ—Ä–µ–¥–∞–µ–º –µ–º—É –ø–æ–ª–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                    if (!isModernWidgetClosed) {
                        console.log('[Polling] ‚úÖ –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω - –ø–µ—Ä–µ–¥–∞–µ–º –µ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏');

                        // –í–ê–ñ–ù–û: –ù–ï –≤—ã–∑—ã–≤–∞–µ–º –∑–≤—É–∫ –∑–¥–µ—Å—å - –ø—É—Å—Ç—å ModernWidget —Å–∞–º —Ä–µ—à–∏—Ç
                        // –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç –∏–º–µ–µ—Ç —É–ª—É—á—à–µ–Ω–Ω—É—é –ª–æ–≥–∏–∫—É –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                        // –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å —á–∞—Å—Ç–æ—Ç—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç
                        if (typeof window.modernNotificationsWidget !== 'undefined' &&
                            typeof window.modernNotificationsWidget.refreshNotifications === 'function') {
                            window.modernNotificationsWidget.refreshNotifications();
                            return; // –í–ê–ñ–ù–û: ModernWidget –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–∞—è –∑–≤—É–∫
                        } else {
                            console.warn('[Polling] ‚ö†Ô∏è ModernWidget –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ–º fallback –ª–æ–≥–∏–∫—É –¥–ª—è –∑–≤—É–∫–∞');

                            // FALLBACK: –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ ModernWidget –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                            if (hasNewNotifications && typeof window.playNotificationSound === 'function') {
                                console.log('[Polling] üîä Fallback: –≤—ã–∑—ã–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∑–≤—É–∫–∞');
                                window.playNotificationSound();
                            } else if (hasNewNotifications) {
                                console.log('[Polling] üîä Fallback: –∏—Å–ø–æ–ª—å–∑—É–µ–º –±–∞–∑–æ–≤–æ–µ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–≤—É–∫–∞');
                                const soundDisabled = localStorage.getItem('notificationSoundDisabled') === 'true';
                                if (!soundDisabled) {
                                    try {
                                        const audio = new Audio("{{ url_for('static', filename='sounds/notification.mp3') }}");
                                        audio.volume = 0.5;
                                        audio.play().then(() => {
                                            console.log('[Polling] ‚úÖ –ë–∞–∑–æ–≤—ã–π fallback –∑–≤—É–∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω');
                                        }).catch(e => {
                                            console.log('[Polling] üîá –ë–∞–∑–æ–≤—ã–π fallback –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω:', e.name);
                                        });
                                    } catch (audioError) {
                                        console.error('[Polling] ‚ùå –û—à–∏–±–∫–∞ –±–∞–∑–æ–≤–æ–≥–æ fallback:', audioError);
                                    }
                                }
                            }
                            return;
                        }

                    } // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ó–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞ –¥–ª—è if (!isModernWidgetClosed)

                    // –ï—Å–ª–∏ –≤–∏–¥–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    if (hasNewNotifications) {
                        console.log('[Polling] –í–∏–¥–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç, –Ω–æ –µ—Å—Ç—å –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º');
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç –ø—Ä–∏ –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö
                        if (typeof window.modernNotificationsWidget !== 'undefined' &&
                            typeof window.modernNotificationsWidget.showWidget === 'function') {
                            window.modernNotificationsWidget.showWidget();
                        }
                    }
                }

                // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–æ—Ç–µ—Ä–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                let connectionLost = false;
                let lastConnectionCheck = 0;

                function checkConnection() {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    if (!document.body.classList.contains('logged-in')) {
                        return;
                    }

                    const now = Date.now();
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–æ —Ä–∞–∑–∞ –≤ 10 —Å–µ–∫—É–Ω–¥
                    if (now - lastConnectionCheck < 10000) {
                        return;
                    }
                    lastConnectionCheck = now;

                    $.ajax({
                        url: "{{ url_for('main.check_connection') }}",
                        type: 'GET',
                        timeout: 8000, // 8 —Å–µ–∫—É–Ω–¥ timeout
                        success: function(response) {
                            // –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
                            if (connectionLost) {
                                connectionLost = false;
                                console.log('[VPN_CHECK] ‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');

                                Swal.fire({
                                    icon: 'success',
                                    title: '‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ',
                                    text: '–î–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ.',
                                    position: 'top-end',
                                    showConfirmButton: false,
                                    timer: 4000,
                                    timerProgressBar: true,
                                    toast: true
                                });
                            }

                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                            if (!response.connected) {
                                // –ü—Ä–æ–±–ª–µ–º–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö, –Ω–æ VPN —Ä–∞–±–æ—Ç–∞–µ—Ç
                                if (!connectionLost) {
                                    connectionLost = true;
                                    console.log('[VPN_CHECK] ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö');

                                    Swal.fire({
                                        icon: 'warning',
                                        title: '‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö',
                                        text: '–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å VPN-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ Cisco AnyConnect.',
                                        position: 'top',
                                        showConfirmButton: true,
                                        confirmButtonText: 'üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É',
                                        allowOutsideClick: false,
                                        allowEscapeKey: false,
                                        timer: 15000,
                                        timerProgressBar: true
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            window.location.reload();
                                        }
                                    });
                                }
                            }
                        },
                        error: function(xhr, status, error) {
                            // –ü–æ–ª–Ω–∞—è –ø–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (VPN –æ—Ç–∫–ª—é—á–µ–Ω)
                            if (!connectionLost) {
                                connectionLost = true;
                                console.log('[VPN_CHECK] üö® VPN —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ');

                                let errorMessage = '';
                                let errorTitle = '';

                                if (status === 'timeout') {
                                    errorTitle = 'üö® –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è';
                                    errorMessage = '–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ VPN —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ Cisco AnyConnect.';
                                } else if (xhr.status === 0) {
                                    errorTitle = 'üö® VPN —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ';
                                    errorMessage = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É. Cisco AnyConnect VPN –æ—Ç–∫–ª—é—á–µ–Ω –∏–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ VPN –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                                } else {
                                    errorTitle = 'üö® –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                                    errorMessage = `–û—à–∏–±–∫–∞ ${xhr.status}: ${error}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ VPN —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.`;
                                }

                                Swal.fire({
                                    icon: 'error',
                                    title: errorTitle,
                                    html: `<div style="text-align: left;">${errorMessage}<br><br>
                                          <strong>–ß—Ç–æ –¥–µ–ª–∞—Ç—å:</strong><br>
                                          1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å Cisco AnyConnect<br>
                                          2. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç–µ VPN –µ—Å–ª–∏ –Ω—É–∂–Ω–æ<br>
                                          3. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>`,
                                    position: 'center',
                                    showConfirmButton: true,
                                    confirmButtonText: 'üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É',
                                    showCancelButton: true,
                                    cancelButtonText: '‚ùå –ó–∞–∫—Ä—ã—Ç—å',
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    customClass: {
                                        popup: 'connection-error-popup'
                                    }
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.location.reload();
                                    }
                                });
                            }
                        }
                    });
                }

                // –ó–∞–ø—É—Å–∫–∞–µ–º polling —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                setInterval(pollNotifications, 30000);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥ (–±—ã—Å—Ç—Ä–µ–µ –¥–ª—è VPN)
                setInterval(checkConnection, 15000);

                // –ù–∞—á–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                pollNotifications();
                checkConnection();

                console.log('[Polling] üì° –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞–ø—É—â–µ–Ω–∞ (–∏–Ω—Ç–µ—Ä–≤–∞–ª: 30 —Å–µ–∫)');
            </script>

            <!-- Modern Notifications Widget -->
            {% if current_user.is_authenticated %}
                {% if current_user.notifications_widget_enabled %}
                    {% include '_modern_notifications_widget.html' %}
                {% endif %}
            {% endif %}

            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    // --- –≠–ª–µ–º–µ–Ω—Ç—ã DOM ---
                    const menuToggle = document.querySelector('.mobile-menu-toggle');
                    const menuPanel = document.querySelector('.mobile-menu-panel');
                    const menuOverlay = document.querySelector('.mobile-menu-overlay');
                    const closeButton = document.querySelector('.mobile-menu-close');

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    if (!menuToggle || !menuPanel || !menuOverlay || !closeButton) {
                        console.error('Mobile menu components are missing. The menu will not be initialized.');
                        return;
                    }

                    const mainNav = document.querySelector('.main-navigation .nav-menu');
                    const mobileLinksContainer = menuPanel.querySelector('.mobile-menu-links');

                    /**
                     * –ö–æ–ø–∏—Ä—É–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –∏–∑ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–≥–æ –º–µ–Ω—é –≤ –º–æ–±–∏–ª—å–Ω–æ–µ.
                     */
                    function cloneNavLinks() {
                        if (!mainNav || !mobileLinksContainer) {
                            console.warn('Mobile menu: mainNav or mobileLinksContainer not found');
                            return;
                        }

                        mobileLinksContainer.innerHTML = '';

                        const navItems = mainNav.querySelectorAll(':scope > .nav-item');
                        let themeToggleBtn = null;

                        // –°–Ω–∞—á–∞–ª–∞ –∫–æ–ø–∏—Ä—É–µ–º –≤—Å–µ –æ–±—ã—á–Ω—ã–µ —Å—Å—ã–ª–∫–∏
                        navItems.forEach(item => {
                            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã - –¥–æ–±–∞–≤–∏–º –µ–≥–æ –≤ –∫–æ–Ω—Ü–µ
                            if (item.classList.contains('theme-toggle-item')) {
                                themeToggleBtn = item.querySelector('.theme-toggle-btn');
                                console.log('Theme toggle found in nav:', themeToggleBtn);
                                return;
                            }

                            const link = item.querySelector(':scope > .nav-link:not(.dropdown-toggle)');
                            const dropdown = item.querySelector('.dropdown-menu');

                            if (link) {
                                const newLi = document.createElement('li');
                                const newLink = document.createElement('a');
                                newLink.href = link.href;
                                // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –∏–∫–æ–Ω–∫–∏, –∏ —Ç–µ–∫—Å—Ç
                                const iconWrapper = link.querySelector('.nav-icon-wrapper');
                                if (iconWrapper) {
                                    newLink.innerHTML = iconWrapper.innerHTML;
                                } else {
                                    newLink.innerHTML = link.innerHTML;
                                }

                                if (link.classList.contains('logout-item')) newLink.classList.add('logout-link');

                                newLi.appendChild(newLink);
                                mobileLinksContainer.appendChild(newLi);
                            }

                            if (dropdown) {
                                const dropdownLinks = dropdown.querySelectorAll('.dropdown-item');
                                dropdownLinks.forEach(dLink => {
                                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
                                    if (dLink.classList.contains('dropdown-divider')) return;

                                    const newLi = document.createElement('li');
                                    const newLink = document.createElement('a');
                                    newLink.href = dLink.href;
                                    newLink.innerHTML = dLink.innerHTML;

                                    if (dLink.classList.contains('new-task')) newLink.classList.add('new-task-link');
                                    if (dLink.classList.contains('logout-item')) newLink.classList.add('logout-link');

                                    newLi.appendChild(newLink);
                                    mobileLinksContainer.appendChild(newLi);
                                });
                            }
                        });

                        // –ï—Å–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏, –∏—â–µ–º –µ–≥–æ –≥–ª–æ–±–∞–ª—å–Ω–æ
                        if (!themeToggleBtn) {
                            themeToggleBtn = document.querySelector('#theme-toggle, .theme-toggle-btn');
                            console.log('Theme toggle searched globally:', themeToggleBtn);
                        }

                        // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã –≤ –∫–æ–Ω–µ—Ü –º–µ–Ω—é (–¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–¥–∏–º –µ–≥–æ)
                        const separatorLi = document.createElement('li');
                        separatorLi.className = 'mobile-menu-separator';
                        separatorLi.style.height = '1px';
                        separatorLi.style.backgroundColor = '#e9ecef';
                        separatorLi.style.margin = '0.5rem 1.5rem';
                        mobileLinksContainer.appendChild(separatorLi);

                        const newLi = document.createElement('li');
                        newLi.className = 'mobile-theme-toggle-item';

                        // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É —Å —Ç–µ–∫—Å—Ç–æ–º –∏ –∏–∫–æ–Ω–∫–æ–π
                        const newToggleBtn = document.createElement('button');
                        newToggleBtn.type = 'button';
                        newToggleBtn.id = 'mobile-theme-toggle';
                        newToggleBtn.className = 'mobile-theme-toggle-btn';
                        newToggleBtn.setAttribute('aria-label', '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É');
                        newToggleBtn.setAttribute('title', '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Å–≤–µ—Ç–ª—É—é/—Ç–µ–º–Ω—É—é —Ç–µ–º—É');

                        // –ö–ª–æ–Ω–∏—Ä—É–µ–º SVG –∏–∫–æ–Ω–∫–∏ –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –∫–Ω–æ–ø–∫–∏, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–∞–π–¥–µ–Ω–∞
                        if (themeToggleBtn) {
                            const lightIcon = themeToggleBtn.querySelector('.theme-icon-light');
                            const darkIcon = themeToggleBtn.querySelector('.theme-icon-dark');
                            if (lightIcon) {
                                newToggleBtn.appendChild(lightIcon.cloneNode(true));
                            }
                            if (darkIcon) {
                                newToggleBtn.appendChild(darkIcon.cloneNode(true));
                            }
                        } else {
                            // –°–æ–∑–¥–∞–µ–º –∏–∫–æ–Ω–∫–∏ –≤—Ä—É—á–Ω—É—é, –µ—Å–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
                            const lightIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                            lightIcon.setAttribute('class', 'theme-icon theme-icon-light');
                            lightIcon.setAttribute('width', '20');
                            lightIcon.setAttribute('height', '20');
                            lightIcon.setAttribute('viewBox', '0 0 24 24');
                            lightIcon.setAttribute('fill', 'none');
                            lightIcon.setAttribute('stroke', 'currentColor');
                            lightIcon.setAttribute('stroke-width', '2');
                            lightIcon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
                            newToggleBtn.appendChild(lightIcon);

                            const darkIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                            darkIcon.setAttribute('class', 'theme-icon theme-icon-dark');
                            darkIcon.setAttribute('width', '20');
                            darkIcon.setAttribute('height', '20');
                            darkIcon.setAttribute('viewBox', '0 0 24 24');
                            darkIcon.setAttribute('fill', 'none');
                            darkIcon.setAttribute('stroke', 'currentColor');
                            darkIcon.setAttribute('stroke-width', '2');
                            darkIcon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
                            newToggleBtn.appendChild(darkIcon);
                        }

                        // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç
                        const textSpan = document.createElement('span');
                        textSpan.className = 'mobile-theme-toggle-text';
                        textSpan.textContent = '–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É';
                        newToggleBtn.appendChild(textSpan);

                        newLi.appendChild(newToggleBtn);
                        mobileLinksContainer.appendChild(newLi);

                        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è
                        newToggleBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('Mobile theme toggle clicked');
                            if (window.themeManager && typeof window.themeManager.toggleTheme === 'function') {
                                window.themeManager.toggleTheme();
                            } else if (document.getElementById('theme-toggle')) {
                                // Fallback: –∫–ª–∏–∫–∞–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–Ω–æ–π –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å
                                document.getElementById('theme-toggle').click();
                            }
                        });

                        console.log('Mobile theme toggle added to menu');
                    }

                    function openMenu() {
                        menuPanel.classList.add('open');
                        menuOverlay.classList.add('open');
                        menuToggle.classList.add('active');
                        document.body.classList.add('mobile-menu-active');
                        menuToggle.setAttribute('aria-expanded', 'true');
                        menuPanel.setAttribute('aria-hidden', 'false');
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
                        closeButton.focus();
                    }

                    function closeMenu() {
                        menuPanel.classList.remove('open');
                        menuOverlay.classList.remove('open');
                        menuToggle.classList.remove('active');
                        document.body.classList.remove('mobile-menu-active');
                        menuToggle.setAttribute('aria-expanded', 'false');
                        menuPanel.setAttribute('aria-hidden', 'true');
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –∫–Ω–æ–ø–∫—É-–≥–∞–º–±—É—Ä–≥–µ—Ä
                        menuToggle.focus();
                    }

                    menuToggle.addEventListener('click', () => {
                        if (menuPanel.classList.contains('open')) {
                            closeMenu();
                        } else {
                            // –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —Å—Å—ã–ª–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã
                            cloneNavLinks();
                            openMenu();
                        }
                    });

                    closeButton.addEventListener('click', closeMenu);
                    menuOverlay.addEventListener('click', closeMenu);

                    document.addEventListener('keydown', (event) => {
                        if (event.key === 'Escape' && menuPanel.classList.contains('open')) {
                            closeMenu();
                        }
                    });

                    console.log('Mobile menu initialized successfully.');
                });
            </script>

            <!-- Modern Splash Screen JavaScript -->
            <script src="{{ url_for('static', filename='js/modern_splash_screen.js') }}"></script>

            <!-- Theme Toggle System - Load with server sync -->
            <script src="{{ url_for('static', filename='js/theme-toggle-with-sync.js') }}"></script>
            <!-- Search Functionality -->
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    const searchInput = document.getElementById('nav-search-input');
                    const searchResults = document.getElementById('search-results');
                    let searchTimeout;
                    let currentQueryId = 0; // –°—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions

                    if (searchInput) {
                        searchInput.addEventListener('input', function() {
                            const query = this.value.trim();
                            clearTimeout(searchTimeout);
                            
                            // –û—á–∏—â–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ù–ï–ú–ï–î–õ–ï–ù–ù–û –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–≤–æ–¥–∞
                            // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç —Å–º–µ—à–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –∏ –Ω–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
                            if (query.length < 2) {
                                searchResults.style.display = 'none';
                                searchResults.innerHTML = '';
                                return;
                            }

                            // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–∞
                            const thisQueryId = ++currentQueryId;

                            searchTimeout = setTimeout(() => {
                                fetch(`/search?q=${encodeURIComponent(query)}`)
                                    .then(response => response.json())
                                    .then(data => {
                                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ—Ç –æ—Ç–≤–µ—Ç –æ—Ç–≤–µ—Ç–æ–º –Ω–∞ –ü–û–°–õ–ï–î–ù–ò–ô –∑–∞–ø—Ä–æ—Å
                                        if (thisQueryId !== currentQueryId) {
                                            console.log(`[Search] Ignoring stale result for query ID ${thisQueryId}`);
                                            return;
                                        }

                                        // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –µ—â–µ —Ä–∞–∑)
                                        searchResults.innerHTML = '';

                                        if (data.length > 0) {
                                            let html = '';
                                            data.forEach(item => {
                                                let icon = 'fa-file-alt';
                                                if (item.type === 'page') icon = 'fa-desktop';
                                                
                                                html += `
                                                    <a href="${item.url}" class="dropdown-item py-2 border-bottom">
                                                        <div class="d-flex align-items-center">
                                                            <div class="me-3 text-primary bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                                <i class="fas ${icon}"></i>
                                                            </div>
                                                            <div>
                                                                <div class="fw-bold text-dark" style="font-size: 0.9rem;">${item.title}</div>
                                                            </div>
                                                        </div>
                                                    </a>
                                                `;
                                            });
                                            searchResults.innerHTML = html;
                                            searchResults.style.display = 'block';
                                        } else {
                                            searchResults.innerHTML = '<div class="dropdown-item text-muted small py-2">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
                                            searchResults.style.display = 'block';
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Search error:', error);
                                    });
                            }, 200); // –£–º–µ–Ω—å—à–∏–ª–∏ –∑–∞–¥–µ—Ä–∂–∫—É —Å 300–º—Å –¥–æ 200–º—Å –¥–ª—è –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
                        });

                        // Hide results when clicking outside
                        document.addEventListener('click', function(e) {
                            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                                searchResults.style.display = 'none';
                            }
                        });
                        
                        // Show results on focus if there's text
                        searchInput.addEventListener('focus', function() {
                            if (this.value.trim().length >= 2 && searchResults.innerHTML.trim() !== '') {
                                searchResults.style.display = 'block';
                            }
                        });
                    }
                });
            </script>
        </body>
</html>
