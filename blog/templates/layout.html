<!DOCTYPE html>
<html lang="ru">
    <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <meta name="csrf-token" content="{{ csrf_token() }}">

            <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –≤–º–µ—Å—Ç–æ CDN -->
            <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/dataTables.bootstrap5.min.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/media_css.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/tez_hero_modern.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/notifications_polling_redesign.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/redmine_widget.css') }}">
            <link rel="icon" href="{{ url_for('static', filename='favicon/favicon.ico') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/all.min.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/roboto-font.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/sweetalert2.min.css') }}">
            <link rel="stylesheet" href="{{ url_for('static', filename='css/mobile-menu.css') }}">

            <!-- –õ–æ–∫–∞–ª—å–Ω—ã–µ JS —Ñ–∞–π–ª—ã -->
                    <script src="{{ url_for('static', filename='js/sweetalert2.all.min.js') }}"></script>
<script src="{{ url_for('static', filename='js/jquery-3.5.1.min.js') }}"></script>
            {% block title %}
              <title>
                {% if title %}
                  {{ title }} - TEZ Navigator
                {% else %}
                  TEZ Navigator ‚Äî –Ω–∞–≤–∏–≥–∞—Ç–æ—Ä –ø–æ –∑–∞—è–≤–∫–∞–º –∏ –∑–∞–¥–∞—á–∞–º
                {% endif %}
              </title>
            {% endblock title %}

            <!-- jQuery —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω –≤—ã—à–µ -->
            <script>
                /* === –û–±—â–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–µ–π–¥–∂–∞ === */
                function refreshNotificationBadge(count) {
                    const badgeSel = '#notification-badge';
                    if (count > 0) {
                        if ($(badgeSel).length === 0) {
                            $('.notification-link .nav-icon-wrapper').append('<span class="notification-badge" id="notification-badge">' + count + '</span>');
                        } else {
                            $(badgeSel).text(count).show();
                        }
                    } else {
                        $(badgeSel).remove();
                    }
                }

                window.refreshNotificationBadge = refreshNotificationBadge; // –ø—É–±–ª–∏—á–Ω–æ –¥–ª—è WebPush

                // –£–õ–£–ß–®–ï–ù–ù–´–ô AJAX-–ø—É–ª–ª–∏–Ω–≥ —Å —á–∞—Å—Ç—ã–º–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏
                function updateNotificationCount() {
                    console.log('[NotificationBadge] üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...');

                    $.ajax({
                        url: "{{ url_for('main.get_notification_count') }}",
                        type: 'GET',
                        success: function(data) {
                            const currentCount = parseInt($('#notification-badge').text() || '0', 10);
                            const newCount = data.count || 0;

                            console.log(`[NotificationBadge] –ü–æ–ª—É—á–µ–Ω —Å—á–µ—Ç—á–∏–∫: ${newCount} (–±—ã–ª–æ: ${currentCount})`);

                            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –≤—Å–µ–≥–¥–∞, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                            refreshNotificationBadge(newCount);

                            // –ï—Å–ª–∏ –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                            if (newCount > currentCount && currentCount >= 0) {
                                console.log(`[NotificationBadge] üîî –ù–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: +${newCount - currentCount}`);

                                // Dispatch event –¥–ª—è –¥—Ä—É–≥–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
                                window.dispatchEvent(new CustomEvent('newNotification', {
                                    detail: { count: newCount, difference: newCount - currentCount }
                                }));
                            }
                        },
                        error: function(xhr) {
                            console.error('[NotificationBadge] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', xhr);
                            // –ù–µ —É–¥–∞–ª—è–µ–º badge –ø—Ä–∏ –æ—à–∏–±–∫–µ, –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º
                        }
                    });
                }

                // –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–º–µ–Ω—å—à–∏–ª–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª –¥–æ 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
                setInterval(updateNotificationCount, 10000);
                updateNotificationCount();

                /* === –õ–∏—Å—Ç–µ–Ω–µ—Ä –¥–ª—è –ø—É—à-–≤–∏–¥–∂–µ—Ç–∞ === */
                window.addEventListener('newNotification', function(e) {
                    // e.detail.count –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –Ω–æ–≤—ã–π total, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äì –ø—Ä–∏–±–∞–≤–ª—è–µ–º 1
                    const current = parseInt($('#notification-badge').text() || '0', 10);
                    const newCount = e.detail && e.detail.count !== undefined ? e.detail.count : current + 1;
                    refreshNotificationBadge(newCount);
                });

                /* === –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã /notifications === */
                if (window.location.pathname === '/notifications') {
                    // –ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–≤–∫–ª—é—á–∞—è –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ)
                    const pageCount = {{ count_notifications_page if count_notifications_page is defined and count_notifications_page is not none and count_notifications_page else 0 | int }};
                    refreshNotificationBadge(pageCount);
                }

                /* ==== Tasks Notification badge (—É–¥–∞–ª–µ–Ω–æ: –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π) ==== */
            </script>

            <script>
                                                    $(document).ready(function() {
                                // –£–¥–∞–ª—è–µ–º –≤—Å–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ flash-—Å–æ–æ–±—â–µ–Ω–∏—è
                                $('.alert').remove();

                                var flashMessages = JSON.parse('{{ get_flashed_messages(with_categories=true) | tojson | safe }}');
                                if (flashMessages.length > 0) {
                                    flashMessages.forEach(function(flash) {
                                        var category = flash[0];
                                        var message = flash[1];

                                        var icon = 'info';
                                        if (category === 'success') icon = 'success';
                                        if (category === 'error') icon = 'error';
                                        if (category === 'warning') icon = 'warning';

                                        Swal.fire({
                                            icon: icon,
                                            title: category.charAt(0).toUpperCase() + category.slice(1),
                                            text: message,
                                            timer: 5000,
                                            showConfirmButton: false,
                                            toast: true,
                                            position: 'top-end',
                                            timerProgressBar: true
                                        });
                                    });
                                }
                            });

                </script>

                <style>
                    /* –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Ö–µ–¥–µ—Ä–æ–º */
                    .content-with-header-offset {
                        margin-top: 100px !important;
                        padding-top: 20px;
                    }

                    @media (max-width: 768px) {
                        .content-with-header-offset {
                            margin-top: 90px !important;
                        }
                    }

                    @media (max-width: 480px) {
                        .content-with-header-offset {
                            margin-top: 80px !important;
                        }
                    }

                    @media (min-width: 1200px) {
                        .content-with-header-offset {
                            margin-top: 110px !important;
                        }
                    }

                    .sidebar {
                        position: fixed;
                        top: 0;
                        right: -400px;
                        width: 400px;
                        height: 100vh;
                        background: #fff;
                        box-shadow: -2px 0 5px rgba(0,0,0,0.2);
                        transition: right 0.3s ease;
                        z-index: 1000 !important;
                        overflow-y: auto;
                        padding: 20px;
                    }

                    .sidebar.active {
                        right: 0;
                    }

                    .sidebar-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                    }

                    .close-sidebar {
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        padding: 5px 10px;
                    }

                    .close-sidebar:hover {
                        color: #dc3545;
                    }

                    .notification-item {
                        border-bottom: 1px solid #eee;
                        padding: 10px 0;
                    }

                    .notification-header {
                        margin-bottom: 10px;
                    }

                    .notification-title {
                        font-weight: bold;
                    }

                    .notification-date {
                        color: #666;
                        font-size: 0.9em;
                    }

                    .notification-content {
                        color: #333;
                    }

                    .sidebar .sidebar-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 15px 20px;
                        border-bottom: 1px solid #e9ecef;
                        background: #f8f9fa;
                    }

                    .sidebar .header-content {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }

                    .sidebar .header-content i {
                        color: #007bff;
                        font-size: 1.2em;
                    }

                    .sidebar .header-content h3 {
                        margin: 0;
                        font-size: 1.2em;
                        font-weight: 500;
                        color: #2c3e50;
                    }

                    .sidebar .close-sidebar {
                        background: none;
                        border: none;
                        font-size: 1.5em;
                        color: #6c757d;
                        cursor: pointer;
                        padding: 0;
                        transition: color 0.2s;
                    }

                    .sidebar .close-sidebar:hover {
                        color: #dc3545;
                    }

                    .no-notifications {
                        text-align: center;
                        padding: 20px;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 10px;
                    }

                    .no-notifications img {
                        width: 50px;
                        height: 50px;
                        margin-bottom: 15px;
                    }

                    .no-notifications h4 {
                        color: #333;
                        margin-bottom: 10px;
                    }

                    .no-notifications p {
                        color: #666;
                        margin: 0;
                    }

                    /* –°—Ç–∏–ª–∏ –¥–ª—è –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —Ö–µ–¥–µ—Ä–µ */
                    .nav-notification-link .notification-icon {
                        display: flex;
                        align-items: center; /* –î–ª—è –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è –∏–∫–æ–Ω–∫–∏, —Ç–µ–∫—Å—Ç–∞ –∏ –±–µ–π–¥–∂–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
                    }

                    .nav-notification-link .notification-counter {
                        font-size: 1.1rem; /* –ù–µ–º–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–∏–º —à—Ä–∏—Ñ—Ç —Ç–µ–∫—Å—Ç–∞ "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è" */
                        font-weight: 500;  /* –°–¥–µ–ª–∞–µ–º —á—É—Ç—å –∂–∏—Ä–Ω–µ–µ */
                        margin-left: 5px;  /* –ù–µ–±–æ–ª—å—à–æ–π –æ—Ç—Å—Ç—É–ø –æ—Ç –∏–∫–æ–Ω–∫–∏ */
                        color: #ffffff; /* –°–¥–µ–ª–∞–µ–º —Ç–µ–∫—Å—Ç –±–µ–ª—ã–º –¥–ª—è –ª—É—á—à–µ–≥–æ –∫–æ–Ω—Ç—Ä–∞—Å—Ç–∞ –Ω–∞ —Ç–µ–º–Ω–æ–º —Ñ–æ–Ω–µ —Ö–µ–¥–µ—Ä–∞ */
                        transition: color 0.2s ease-in-out;
                    }

                    .nav-notification-link:hover .notification-counter {
                        color: #f0f0f0; /* –õ–µ–≥–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
                    }

                    .nav-notification-badge {
                        font-size: 0.8rem !important;    /* –£–≤–µ–ª–∏—á–∏–º —à—Ä–∏—Ñ—Ç –≤ –±–µ–π–¥–∂–µ, !important –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–±–∏—Ç—å —Å—Ç–∏–ª—å Bootstrap */
                        padding: 0.3em 0.6em !important; /* –£–≤–µ–ª–∏—á–∏–º padding –¥–ª—è —Ä–∞–∑–º–µ—Ä–∞ —Å–∞–º–æ–≥–æ –±–µ–π–¥–∂–∞ */
                        background-color: #ff4136 !important; /* –Ø—Ä–∫–æ-–∫—Ä–∞—Å–Ω—ã–π, –±–æ–ª–µ–µ –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π */
                        color: white !important;
                        border-radius: 10px !important; /* –ë–æ–ª–µ–µ —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–π */
                        margin-left: 8px !important;   /* –ß—É—Ç—å –±–æ–ª—å—à–µ –æ—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ */
                        font-weight: bold;
                        box-shadow: 0 0 5px rgba(255, 65, 54, 0.7); /* –õ–µ–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–∞ */
                    }

                    .nav-item.active .nav-notification-link .notification-counter,
                    .nav-item .nav-notification-link.active .notification-counter { /* –ü—Ä–∏–º–µ—Ä –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Å—ã–ª–∫–∏ */
                        font-weight: bold; /* –ï—â–µ –∂–∏—Ä–Ω–µ–µ, –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ */
                    }
                    /* –ö–æ–Ω–µ—Ü —Å—Ç–∏–ª–µ–π –¥–ª—è –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */

                    /* –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
                    .notification-link .nav-icon-wrapper {
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        flex-wrap: nowrap;
                        justify-content: flex-start;
                    }

                    /* –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π */
                    .nav-item .notification-link {
                        display: flex !important;
                        align-items: center !important;
                        white-space: nowrap !important;
                    }

                    .nav-item .notification-link .nav-icon-wrapper {
                        display: flex !important;
                        align-items: center !important;
                        gap: 0.5rem !important;
                        flex-direction: row !important;
                        flex-wrap: nowrap !important;
                    }

                    .nav-item .notification-link .nav-text {
                        display: inline-block !important;
                        margin: 0 !important;
                        padding: 0 !important;
                    }

                    .nav-item .notification-link .notification-badge {
                        display: inline-flex !important;
                        margin-left: 0.5rem !important;
                        vertical-align: middle !important;
                    }

                    .nav-icon-wrapper {
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        position: relative;
                        z-index: 2;
                    }

                    /* Style for SVG icons in nav */
                    .nav-icon-wrapper svg {
                        width: 20px; /* Adjust as needed */
                        height: 20px; /* Adjust as needed */
                        vertical-align: middle;
                        flex-shrink: 0; /* Prevent shrinking if text is long */
                    }

                    /* Icon Colors for Font Awesome (will be gradually replaced) */
                    /* FIX: Increased specificity and added !important to ensure colors are applied */
                    .nav-link .wiki-icon { color: #10b981 !important; }
                    .nav-link .tasks-icon { color: #3b82f6 !important; }
                    .nav-link .issues-icon { color: #8b5cf6 !important; }
                    .nav-link .other-icon { color: #f59e0b !important; }
                    .nav-link .notification-icon { color: #fbbf24 !important; }

                    /* Styles for SVG icons in nav - to be used when Font Awesome is replaced */
                    .nav-icon-wrapper .nav-icon-svg { /* New class for SVG elements */
                        width: 20px;  /* Default width */
                        height: 20px; /* Default height */
                        vertical-align: middle;
                        flex-shrink: 0;
                        display: inline-block; /* Ensure it behaves like an icon */
                    }

                    /* Ensure Font Awesome icons still have their space if not replaced yet */
                    .nav-icon-wrapper .nav-icon {
                         width: 20px; /* Consistent width with SVG */
                         text-align: center; /* Center icon if it's narrower */
                    }

                    /* Notification Badge - –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–æ–≤—ã–π —Å—Ç–∏–ª—å –¥–ª—è —Ö–µ–¥–µ—Ä–∞ */
                    .nav-icon-wrapper .notification-badge,
                    #notification-badge {
                        background: #ef4444 !important;
                        color: white !important;
                        font-size: 0.75rem !important;
                        font-weight: 700 !important;
                        padding: 0.2rem 0.5rem !important;
                        border-radius: 12px !important;
                        min-width: 20px !important;
                        height: 20px !important;
                        display: inline-flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4) !important;
                        margin-left: 0.5rem !important;
                        flex-shrink: 0 !important;
                        animation: notificationPulse 2s infinite !important;
                        border: 2px solid white !important;
                        position: relative !important;
                        z-index: 9999 !important;
                    }

                    @keyframes notificationPulse {
                        0%, 100% {
                            transform: scale(1);
                            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
                        }
                        50% {
                            transform: scale(1.05);
                            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.6);
                        }
                    }

                    /* Modern Dropdown Styles */
                    .modern-dropdown {
                        background: rgba(255, 255, 255, 0.95);
                        backdrop-filter: blur(20px);
                        -webkit-backdrop-filter: blur(20px);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: var(--header-radius);
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                        padding: 0.5rem 0;
                        margin-top: 0.5rem;
                        min-width: 250px;
                        animation: dropdownSlideIn 0.3s ease-out;
                    }

                    @keyframes dropdownSlideIn {
                        from {
                            opacity: 0;
                            transform: translateY(-10px) scale(0.95);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0) scale(1);
                        }
                    }

                    .dropdown-header {
                        padding: 0.75rem 1rem;
                        background: linear-gradient(135deg, var(--header-primary), var(--header-primary-light));
                        color: white;
                        font-weight: 600;
                        font-size: 0.875rem;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        margin: -0.5rem -0rem 0.5rem 0;
                        border-radius: var(--header-radius) var(--header-radius) 0 0;
                    }

                    .dropdown-item {
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                        padding: 0.75rem 1rem;
                        color: var(--header-text);
                        text-decoration: none;
                        font-weight: 500;
                        font-size: 0.875rem;
                        transition: var(--header-transition);
                        border: none;
                        background: none;
                        width: 100%;
                    }

                    .dropdown-item:hover {
                        background: linear-gradient(135deg, var(--header-primary), var(--header-primary-light));
                        color: white;
                        transform: translateX(4px);
                    }

                    .dropdown-item i {
                        width: 16px;
                        text-align: center;
                        opacity: 0.8;
                    }

                    .dropdown-item .nav-icon-svg {
                        width: 16px;
                        height: 16px;
                    }

                    .dropdown-divider {
                        height: 1px;
                        background: linear-gradient(90deg, transparent, rgba(0, 121, 140, 0.2), transparent);
                        margin: 0.5rem 1rem;
                        border: none;
                    }

                    /* User Profile Dropdown */
                    .modern-header .user-profile {
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                        padding: 0.25rem;
                    }

                    .modern-header .user-avatar {
                        position: relative;
                        width: 40px !important;
                        height: 40px !important;
                    }

                    .modern-header .avatar-img {
                        width: 100% !important;
                        height: 100% !important;
                        border-radius: 50% !important;
                        object-fit: cover !important;
                        border: 2px solid rgba(255, 255, 255, 0.3) !important;
                        transition: var(--header-transition) !important;
                    }

                    .modern-header .user-link:hover .avatar-img {
                        border-color: white !important;
                        transform: scale(1.05) !important;
                    }

                    .modern-header .online-indicator {
                        position: absolute;
                        bottom: 2px;
                        right: 2px;
                        width: 12px;
                        height: 12px;
                        background: var(--header-success);
                        border: 2px solid white;
                        border-radius: 50%;
                        animation: pulseOnline 2s infinite;
                    }

                    @keyframes pulseOnline {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.2); }
                    }

                    .modern-header .user-info {
                        display: flex;
                        flex-direction: column;
                        align-items: flex-start;
                        line-height: 1.2;
                    }

                    .modern-header .user-name {
                        font-weight: 600;
                        font-size: 0.875rem;
                        color: white;
                    }

                    .modern-header .user-role {
                        font-size: 0.75rem;
                        color: rgba(255, 255, 255, 0.7);
                        font-weight: 400;
                    }

                    /* User Dropdown Menu */
                    .modern-header .user-dropdown-menu {
                        min-width: 300px;
                        right: 0;
                        left: auto;
                    }

                    .modern-header .user-header {
                        padding: 1rem;
                        background: linear-gradient(135deg, var(--header-primary), var(--header-primary-light));
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                        margin: -0.5rem 0 0.5rem 0;
                    }

                    .modern-header .user-avatar-large {
                        width: 50px;
                        height: 50px;
                        border-radius: 50%;
                        overflow: hidden;
                        border: 3px solid rgba(255, 255, 255, 0.3);
                    }

                    .modern-header .user-avatar-large img {
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                    }

                    .modern-header .user-details {
                        display: flex;
                        flex-direction: column;
                        gap: 0.25rem;
                    }

                    .modern-header .user-full-name {
                        font-weight: 600;
                        font-size: 0.95rem;
                        color: white;
                    }

                    .modern-header .user-email {
                        font-size: 0.8rem;
                        color: rgba(255, 255, 255, 0.8);
                        opacity: 0.9;
                    }

                    /* Special Button Styles */
                    .nav-link.login-btn {
                        background: linear-gradient(135deg, var(--header-success), #059669);
                        border-radius: 12px;
                        font-weight: 600;
                    }

                    .nav-link.login-btn:hover {
                        background: linear-gradient(135deg, #059669, #047857);
                        transform: translateY(-2px);
                    }

                    .nav-link.register-btn {
                        background: linear-gradient(135deg, var(--header-accent), #ea580c);
                        border-radius: 12px;
                        font-weight: 600;
                    }

                    .nav-link.register-btn:hover {
                        background: linear-gradient(135deg, #ea580c, #dc2626);
                        transform: translateY(-2px);
                    }

                    .new-task {
                        background: linear-gradient(135deg, var(--header-success), #059669);
                        color: white !important;
                        margin: 0.25rem 0.5rem;
                        border-radius: 8px;
                    }

                    .logout-item {
                        color: var(--header-error) !important;
                    }

                    .logout-item:hover {
                        background: linear-gradient(135deg, var(--header-error), #dc2626) !important;
                        color: white !important;
                    }

                    /* Mobile Menu Toggle */
                    .mobile-menu-toggle {
                        display: none;
                        flex-direction: column;
                        cursor: pointer;
                        padding: 0.5rem;
                        gap: 0.25rem;
                        z-index: 10;
                    }

                    .hamburger-line {
                        width: 25px;
                        height: 3px;
                        background: white;
                        border-radius: 2px;
                        transition: var(--header-transition);
                    }

                    /* Responsive Design */
                    @media (max-width: 1200px) {
                        .header-container {
                            padding: 0 1.5rem;
                        }

                        .nav-text {
                            display: none;
                        }

                        .nav-icon-wrapper {
                            gap: 0;
                        }

                        .user-info {
                            display: none;
                        }
                    }

                    @media (max-width: 968px) {
                        .main-navigation {
                            display: none;
                        }

                        .mobile-menu-toggle {
                            display: flex;
                        }

                        .header-container {
                            padding: 0 1rem;
                        }
                    }

                    @media (max-width: 576px) {
                        .logo-wrapper {
                            gap: 0.5rem;
                        }

                        .logo-icon {
                            width: 40px;
                            height: 40px;
                            font-size: 1.2rem;
                            border-radius: 10px;
                        }

                        .logo-text {
                            display: none;
                        }

                        .header-container {
                            padding: 0 0.75rem;
                        }
                    }

                    @media (max-width: 480px) {
                        .logo-icon {
                            width: 36px;
                            height: 36px;
                            font-size: 1rem;
                            border-radius: 8px;
                        }
                    }

                    /* Content Offset */
                    .content {
                        padding-top: 70px;
                    }

                    /* Remove old styles */
                    .header {
                        display: none;
                        }
                    </style>

    </head>
        <body class="{% if current_user.is_authenticated %}logged-in{% endif %}">
            <div class="wrapper">
                {% block menu %}
                <header class="modern-header">
                    <div class="header-container">
                        <!-- Logo Section -->
                        <div class="logo-section">
                            <a href="/" class="logo-link">
                                <div class="logo-wrapper">
                                    <div class="logo-icon">
                                        <i class="fas fa-tasks"></i>
                                        <div class="logo-icon-glow"></div>
                                    </div>
                                    <div class="logo-text">
                                        <span class="logo-main">TEZ Navigator</span>
                                        <span class="logo-sub">–Ω–∞–≤–∏–≥–∞—Ç–æ—Ä –ø–æ –∑–∞—è–≤–∫–∞–º –∏ –∑–∞–¥–∞—á–∞–º</span>
                                    </div>
                                </div>
                            </a>
                        </div>

                        <!-- Navigation Menu -->
                        <nav class="main-navigation">
                            <ul class="nav-menu">
                        {% if current_user.is_authenticated %}
                                    <!-- Notifications -->
                            <li class="nav-item">
                                <a class="nav-link notification-link" href="{{ url_for('main.my_notifications') }}">
                                    <div class="nav-icon-wrapper">
                                        <i class="fas fa-bell nav-icon notification-icon"></i>
                                        <span class="nav-text">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
                                        {% if count_notifications > 0 %}
                                        <span class="notification-badge" id="notification-badge">{{ count_notifications }}</span>
                                        {% endif %}
                                    </div>
                                </a>
                            </li>

                                    <!-- Wiki Dropdown -->
                            <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" href="#" id="wikiDropdown" role="button" data-bs-toggle="dropdown">
                                            <div class="nav-icon-wrapper">
                                                <i class="fas fa-book-open nav-icon wiki-icon"></i>
                                                <span class="nav-text">Wiki</span>
                                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                                            </div>
                                        </a>
                                        <ul class="dropdown-menu modern-dropdown" aria-labelledby="wikiDropdown">
                                            <li class="dropdown-header">
                                                <i class="fas fa-book-open"></i>
                                                <span>–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</span>
                                            </li>
                                    <li><a class="dropdown-item" href="{{ url_for('main.home') }}">
                                                <i class="fas fa-question-circle"></i>
                                                <span>FAQ</span>
                                    </a></li>
                                    <li><a class="dropdown-item" href="{{ url_for('main.blog') }}">
                                                <i class="fas fa-newspaper"></i>
                                                <span>–°—Ç–∞—Ç—å–∏</span>
                                    </a></li>
                                            <li class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{{ url_for('post.new_post') }}">
                                                <i class="fas fa-plus-circle"></i>
                                                <span>–ù–æ–≤–∞—è —Å—Ç–∞—Ç—å—è</span>
                                    </a></li>
                                </ul>
                            </li>

                                    <!-- Tasks Dropdown -->
                            <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" href="#" id="tasksDropdown" role="button" data-bs-toggle="dropdown">
                                            <div class="nav-icon-wrapper">
                                                <i class="fas fa-ticket-alt nav-icon tasks-icon"></i>
                                                <span class="nav-text">–ó–∞—è–≤–∫–∏</span>
                                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                                            </div>
                                        </a>
                                        <ul class="dropdown-menu modern-dropdown" aria-labelledby="tasksDropdown">
                                            <li class="dropdown-header">
                                                <i class="fas fa-ticket-alt"></i>
                                                <span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∞–º–∏</span>
                                            </li>
                                    <li><a class="dropdown-item" href="{{ url_for('main.my_issues') }}">
                                                <i class="fas fa-tasks"></i>
                                                <span>–ú–æ–∏ –∑–∞—è–≤–∫–∏</span>
                                    </a></li>
                                            <li class="dropdown-divider"></li>
                                            <li><a class="dropdown-item new-task" href="{{ url_for('main.new_issue') }}">
                                                <i class="fas fa-plus-circle"></i>
                                                <span>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</span>
                                    </a></li>
                                </ul>
                            </li>

                        {% if current_user.is_authenticated and current_user.is_redmine_user %}
                            <!-- New Tasks (–ó–∞–¥–∞—á–∏) Dropdown -->
                            <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" href="#" id="issuesDropdownMenu" role="button" data-bs-toggle="dropdown">
                                            <div class="nav-icon-wrapper">
                                                <i class="fas fa-clipboard-list nav-icon issues-icon"></i>
                                                <span class="nav-text">–ó–∞–¥–∞—á–∏</span>
                                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                                            </div>
                                        </a>
                                        <ul class="dropdown-menu modern-dropdown" aria-labelledby="issuesDropdownMenu">
                                            <li class="dropdown-header">
                                                <i class="fas fa-clipboard-list"></i>
                                                <span>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∞–º–∏</span>
                                            </li>
                                    <li><a class="dropdown-item" href="{{ url_for('tasks.my_tasks_page') }}">
                                                <i class="fas fa-clipboard-list"></i>
                                                <span>–ú–æ–∏ –∑–∞–¥–∞—á–∏</span>
                                    </a></li>
                                            <li class="dropdown-divider"></li>
                                            <li><a class="dropdown-item new-issue" href="#"> {# –ó–ê–ú–ï–ù–ò–¢–¨ # –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π url_for –¥–ª—è "–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞" #}
                                                <i class="fas fa-plus-circle"></i>
                                                <span>–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</span>
                                    </a></li>
                                </ul>
                            </li>
                        {% endif %}

                                    <!-- Other Dropdown -->
                            <li class="nav-item dropdown">
                                        <a class="nav-link dropdown-toggle" href="#" id="otherDropdown" role="button" data-bs-toggle="dropdown">
                                            <div class="nav-icon-wrapper">
                                                <i class="fas fa-th nav-icon other-icon"></i>
                                                <span class="nav-text">–ü—Ä–æ—á–µ–µ</span>
                                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                                            </div>
                                        </a>
                                        <ul class="dropdown-menu modern-dropdown" aria-labelledby="otherDropdown">
                                            <li class="dropdown-header">
                                                <i class="fas fa-th"></i>
                                                <span>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</span>
                                            </li>
                                            <li><a class="dropdown-item" href="{{ url_for('users.all_users') }}">
                                                <i class="fas fa-users"></i>
                                                <span>–ö–æ–Ω—Ç–∞–∫—Ç—ã</span>
                                            </a></li>
                                            {% if current_user.can_access_contact_center_moscow %}
                                            <li><a class="dropdown-item" href="{{ url_for('calls.contact_center_moscow') }}">
                                                <i class="fas fa-phone-alt"></i>
                                                <span>–ö–æ–Ω—Ç–∞–∫—Ç-—Ü–µ–Ω—Ç—Ä –ú–æ—Å–∫–≤–∞</span>
                                            </a></li>
                                            {% endif %}
                                            <li class="dropdown-submenu">
                                                <a class="dropdown-item submenu-toggle" href="#" id="reportsDropdown">
                                                    <i class="fas fa-chart-line"></i>
                                                    <span>–û—Ç—á–µ—Ç—ã</span>
                                                    <i class="fas fa-chevron-right submenu-arrow"></i>
                                                </a>
                                                <ul class="dropdown-menu submenu-dropdown">
                                                    <li><a class="dropdown-item" href="{{ url_for('main.reports') }}">
                                                        <i class="fas fa-chart-bar"></i>
                                                        <span>–û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                                            </a></li>
                                            {% if current_user.can_access_quality_control %}
                                            <li><a class="dropdown-item" href="{{ url_for('main.quality_control') }}">
                                                        <i class="fas fa-clipboard-check"></i>
                                                        <span>–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞</span>
                                            </a></li>
                                            {% endif %}
                                        </ul>
                                    </li>
                                        </ul>
                            </li>

                                    <!-- User Profile Dropdown -->
                                    <li class="nav-item dropdown user-dropdown">
                                        <a class="nav-link dropdown-toggle user-link" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                            <div class="user-profile">
                                                <div class="user-avatar">
                                    <img src="{{ url_for('static', filename='profile_pics/' + current_user.username + '/account_img/' + current_user.image_file) }}"
                                                         alt="user_avatar" class="avatar-img">
                                                    <div class="online-indicator"></div>
                                                </div>
                                                <div class="user-info">
                                                    <span class="user-name">
                                        {% set names = current_user.full_name.split() %}
                                        {{ names[0] }} {{ names[1][:1] }}.{{ names[-1][:1] }}.
                                    </span>
                                                    <span class="user-role">{{ current_user.position[:20] + '...' if current_user.position and current_user.position|length > 20 else current_user.position or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}</span>
                                                </div>
                                                <i class="fas fa-chevron-down dropdown-arrow"></i>
                                            </div>
                                        </a>
                                        <ul class="dropdown-menu modern-dropdown user-dropdown-menu" aria-labelledby="userDropdown">
                                            <li class="dropdown-header user-header">
                                                <div class="user-avatar-large">
                                                    <img src="{{ url_for('static', filename='profile_pics/' + current_user.username + '/account_img/' + current_user.image_file) }}"
                                                         alt="user_avatar">
                                                </div>
                                                <div class="user-details">
                                                    <span class="user-full-name">{{ current_user.full_name or current_user.username }}</span>
                                                    <span class="user-email">{{ current_user.email }}</span>
                                                </div>
                                            </li>
                                            <li class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="{{ url_for('users.account') }}">
                                                <i class="fas fa-user-cog"></i>
                                                <span>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</span>
                                    </a></li>
                                            <li class="dropdown-divider"></li>
                                            <li><a class="dropdown-item logout-item" href="{{ url_for('users.logout') }}">
                                                <i class="fas fa-sign-out-alt"></i>
                                                <span>–í—ã–π—Ç–∏</span>
                                    </a></li>
                                </ul>
                            </li>
                        {% else %}
                                    <!-- Guest Menu -->
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('main.home') }}">
                                            <div class="nav-icon-wrapper">
                                                <i class="fas fa-book-open nav-icon"></i>
                                                <span class="nav-text">Wiki</span>
                                            </div>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link login-btn" href="{{ url_for('users.login') }}">
                                            <div class="nav-icon-wrapper">
                                                <i class="fas fa-sign-in-alt nav-icon"></i>
                                                <span class="nav-text">–í—Ö–æ–¥</span>
                                            </div>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link register-btn" href="{{ url_for('users.register') }}">
                                            <div class="nav-icon-wrapper">
                                                <i class="fas fa-user-plus nav-icon"></i>
                                                <span class="nav-text">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</span>
                                            </div>
                                        </a>
                                    </li>
                        {% endif %}
                    </ul>
                        </nav>

                        <!-- Mobile Menu Toggle -->
                        <div class="mobile-menu-toggle">
                            <span class="hamburger-line"></span>
                            <span class="hamburger-line"></span>
                            <span class="hamburger-line"></span>
                        </div>
                    </div>
                </header>

                <!-- Mobile Menu Panel -->
                <div class="mobile-menu-overlay"></div>
                <nav class="mobile-menu-panel" id="mobile-menu-panel" aria-hidden="true" role="dialog">
                    <div class="mobile-menu-header">
                        <h2 class="mobile-menu-title">–ú–µ–Ω—é</h2>
                        <button class="mobile-menu-close" id="mobile-menu-close" aria-label="–ó–∞–∫—Ä—ã—Ç—å –º–µ–Ω—é">&times;</button>
                    </div>
                    <ul class="mobile-menu-links">
                        <!-- –°—Å—ã–ª–∫–∏ –±—É–¥—É—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã —Å—é–¥–∞ —Å –ø–æ–º–æ—â—å—é JavaScript -->
                    </ul>
                </nav>

                <!-- Modern Header Styles -->
                    <style>
                    /* Import Modern Fonts */
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

                    /* Header CSS Variables */
                    :root {
                        --header-primary: #00798C;
                        --header-primary-dark: #005f73;
                        --header-primary-light: #26c6da;
                        --header-accent: #ff6b35;
                        --header-success: #10b981;
                        --header-warning: #f59e0b;
                        --header-error: #ef4444;
                        --header-bg: rgba(255, 255, 255, 0.95);
                        --header-glass: rgba(255, 255, 255, 0.1);
                        --header-text: #1f2937;
                        --header-text-light: #6b7280;
                        --header-border: rgba(255, 255, 255, 0.2);
                        --header-shadow: 0 8px 32px rgba(0, 121, 140, 0.1);
                        --header-blur: 20px;
                        --header-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                        --header-radius: 16px;
                    }

                    /* Modern Header Base */
                    .modern-header {
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        z-index: 1000;
                        background: linear-gradient(135deg, var(--header-primary) 0%, var(--header-primary-dark) 100%);
                        backdrop-filter: blur(var(--header-blur));
                        -webkit-backdrop-filter: blur(var(--header-blur));
                        box-shadow: var(--header-shadow);
                        border-bottom: 1px solid var(--header-border);
                        padding: 0;
                        height: auto;
                        min-height: 70px;
                        animation: slideDownHeader 0.6s ease-out;
                    }

                    @keyframes slideDownHeader {
                        from {
                            opacity: 0;
                            transform: translateY(-100%);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }

                    .header-container {
                        width: 100%;
                        margin: 0;
                        display: flex;
                        align-items: center;
                        justify-content: space-between;
                        padding: 0 2rem;
                        height: 70px;
                        position: relative;
                    }

                    /* Logo Section */
                    .logo-section {
                        display: flex;
                        align-items: center;
                        z-index: 10;
                        margin-right: auto;
                    }

                    .logo-link {
                        text-decoration: none;
                        transition: var(--header-transition);
                    }

                    .logo-link:hover {
                        transform: scale(1.02);
                    }

                    .logo-wrapper {
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                    }

                    .logo-icon {
                        position: relative;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        width: 50px;
                        height: 50px;
                        background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
                        border: 2px solid rgba(255, 255, 255, 0.3);
                        border-radius: 14px;
                        color: white;
                        font-size: 1.5rem;
                        transition: var(--header-transition);
                        backdrop-filter: blur(10px);
                        -webkit-backdrop-filter: blur(10px);
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                    }

                    .logo-icon-glow {
                        position: absolute;
                        top: 50%;
                        left: 50%;
                        width: 120%;
                        height: 120%;
                        background: radial-gradient(circle, rgba(255, 255, 255, 0.3) 0%, transparent 70%);
                        border-radius: 50%;
                        transform: translate(-50%, -50%);
                        opacity: 0;
                        transition: var(--header-transition);
                        animation: logoGlow 3s ease-in-out infinite;
                    }

                    @keyframes logoGlow {
                        0%, 100% {
                            transform: translate(-50%, -50%) scale(1);
                            opacity: 0.3;
                        }
                        50% {
                            transform: translate(-50%, -50%) scale(1.1);
                            opacity: 0.6;
                        }
                    }

                    .logo-link:hover .logo-icon {
                        transform: scale(1.05) rotate(5deg);
                        background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
                        border-color: rgba(255, 255, 255, 0.5);
                        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
                    }

                    .logo-link:hover .logo-icon-glow {
                        opacity: 0.8;
                        transform: translate(-50%, -50%) scale(1.2);
                    }

                    .logo-text {
                        display: flex;
                        flex-direction: column;
                        line-height: 1.2;
                    }

                    .logo-main {
                        font-family: 'Inter', sans-serif;
                        font-size: 1.4rem;
                        font-weight: 800;
                        color: white;
                        letter-spacing: -0.025em;
                        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                        transition: var(--header-transition);
                    }

                    .logo-sub {
                        font-family: 'Inter', sans-serif;
                        font-size: 0.72rem;
                        font-weight: 500;
                        color: rgba(255, 255, 255, 0.85);
                        letter-spacing: 0.05em;
                        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
                        transition: var(--header-transition);
                        margin-top: 2px;
                    }

                    .logo-link:hover .logo-main {
                        color: rgba(255, 255, 255, 1);
                        text-shadow: 0 3px 6px rgba(0, 0, 0, 0.2);
                    }

                    .logo-link:hover .logo-sub {
                        color: rgba(255, 255, 255, 1);
                        letter-spacing: 0.2em;
                    }

                    /* Navigation Menu */
                    .main-navigation {
                        display: flex;
                        justify-content: flex-end;
                        margin-left: auto;
                    }

                    .nav-menu {
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        list-style: none;
                        margin: 0;
                        padding: 0;
                    }

                    .nav-item {
                        position: relative;
                    }

                    .nav-link {
                        display: flex;
                        align-items: center;
                        padding: 0.75rem 1rem;
                        text-decoration: none;
                        color: white;
                        font-weight: 500;
                        font-size: 0.9rem;
                        border-radius: 12px;
                        transition: var(--header-transition);
                        position: relative;
                        overflow: hidden;
                    }

                    .nav-link::before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: 0;
                        right: 0;
                        bottom: 0;
                        background: rgba(255, 255, 255, 0.1);
                        border-radius: 12px;
                        opacity: 0;
                        transition: var(--header-transition);
                    }

                    .nav-link:hover::before {
                        opacity: 1;
                    }

                    .nav-link:hover {
                        color: white;
                        transform: translateY(-2px);
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    }

                    .nav-icon-wrapper {
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        position: relative;
                        z-index: 2;
                    }

                    /* === CORRECTED ICON STYLES === */
                    .nav-icon-wrapper svg {
                        width: 20px;
                        height: 20px;
                        vertical-align: middle;
                        flex-shrink: 0;
                    }

                    /* Increased specificity to ensure colors are applied */
                    .nav-link .wiki-icon { color: #10b981 !important; }
                    .nav-link .tasks-icon { color: #3b82f6 !important; }
                    .nav-link .issues-icon { color: #8b5cf6 !important; }
                    .nav-link .other-icon { color: #f59e0b !important; }
                    .nav-link .notification-icon { color: #fbbf24 !important; }

                    .nav-icon-wrapper .nav-icon-svg {
                        width: 20px;
                        height: 20px;
                        vertical-align: middle;
                        flex-shrink: 0;
                        display: inline-block;
                    }

                    .nav-icon-wrapper .nav-icon {
                         width: 20px;
                         text-align: center;
                         font-size: 16px !important;
                         display: inline-block !important;
                    }

                    /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –∏–∫–æ–Ω–æ–∫ –≤ header */
                    .modern-header .nav-icon-wrapper i {
                        font-size: 16px !important;
                        display: inline-block !important;
                        width: 20px !important;
                        height: 20px !important;
                        text-align: center !important;
                        line-height: 20px !important;
                    }

                    /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –ª–æ–≥–æ—Ç–∏–ø–∞ */
                    .logo-icon i {
                        font-size: 1.5rem !important;
                        display: block !important;
                        width: 100% !important;
                        height: 100% !important;
                        text-align: center !important;
                        line-height: 50px !important;
                    }

                    /* Notification Badge */
                    .nav-icon-wrapper .notification-badge,
                    #notification-badge {
                        background: #ef4444 !important;
                        color: white !important;
                        font-size: 0.75rem !important;
                        font-weight: 700 !important;
                        padding: 0.2rem 0.5rem !important;
                        border-radius: 12px !important;
                        min-width: 20px !important;
                        height: 20px !important;
                        display: inline-flex !important;
                        align-items: center !important;
                        justify-content: center !important;
                        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4) !important;
                        margin-left: 0.5rem !important;
                        flex-shrink: 0 !important;
                        animation: notificationPulse 2s infinite !important;
                        border: 2px solid white !important;
                        position: relative !important;
                        z-index: 9999 !important;
                    }

                    @keyframes notificationPulse {
                        0%, 100% {
                            transform: scale(1);
                            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
                        }
                        50% {
                            transform: scale(1.05);
                            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.6);
                        }
                    }

                    /* Modern Dropdown Styles */
                    .modern-dropdown {
                        background: rgba(255, 255, 255, 0.95);
                        backdrop-filter: blur(20px);
                        -webkit-backdrop-filter: blur(20px);
                        border: 1px solid rgba(255, 255, 255, 0.2);
                        border-radius: var(--header-radius);
                        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
                        padding: 0.5rem 0;
                        margin-top: 0.5rem;
                        min-width: 250px;
                        animation: dropdownSlideIn 0.3s ease-out;
                    }

                    @keyframes dropdownSlideIn {
                        from {
                            opacity: 0;
                            transform: translateY(-10px) scale(0.95);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0) scale(1);
                        }
                    }

                    .dropdown-header {
                        padding: 0.75rem 1rem;
                        background: linear-gradient(135deg, var(--header-primary), var(--header-primary-light));
                        color: white;
                        font-weight: 600;
                        font-size: 0.875rem;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        margin: -0.5rem -0rem 0.5rem 0;
                        border-radius: var(--header-radius) var(--header-radius) 0 0;
                    }

                    .dropdown-item {
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                        padding: 0.75rem 1rem;
                        color: var(--header-text);
                        text-decoration: none;
                        font-weight: 500;
                        font-size: 0.875rem;
                        transition: var(--header-transition);
                        border: none;
                        background: none;
                        width: 100%;
                    }

                    .dropdown-item:hover {
                        background: linear-gradient(135deg, var(--header-primary), var(--header-primary-light));
                        color: white;
                        transform: translateX(4px);
                    }

                    .dropdown-item i {
                        width: 16px;
                        text-align: center;
                        opacity: 0.8;
                    }

                    .dropdown-item .nav-icon-svg {
                        width: 16px;
                        height: 16px;
                    }

                    .dropdown-divider {
                        height: 1px;
                        background: linear-gradient(90deg, transparent, rgba(0, 121, 140, 0.2), transparent);
                        margin: 0.5rem 1rem;
                        border: none;
                    }

                    /* User Profile Dropdown */
                    .modern-header .user-profile {
                        display: flex;
                        align-items: center;
                        gap: 0.75rem;
                        padding: 0.25rem;
                    }

                    .modern-header .user-avatar {
                        position: relative;
                        width: 40px !important;
                        height: 40px !important;
                    }

                    .modern-header .avatar-img {
                        width: 100% !important;
                        height: 100% !important;
                        border-radius: 50% !important;
                        object-fit: cover !important;
                        border: 2px solid rgba(255, 255, 255, 0.3) !important;
                        transition: var(--header-transition) !important;
                    }

                    .modern-header .user-link:hover .avatar-img {
                        border-color: white !important;
                        transform: scale(1.05) !important;
                    }

                    .modern-header .online-indicator {
                        position: absolute;
                        bottom: 2px;
                        right: 2px;
                        width: 12px;
                        height: 12px;
                        background: var(--header-success);
                        border: 2px solid white;
                        border-radius: 50%;
                        animation: pulseOnline 2s infinite;
                    }

                    @keyframes pulseOnline {
                        0%, 100% { transform: scale(1); }
                        50% { transform: scale(1.2); }
                    }

                    .modern-header .user-info {
                        display: flex;
                        flex-direction: column;
                        align-items: flex-start;
                        line-height: 1.2;
                    }

                    .modern-header .user-name {
                        font-weight: 600;
                        font-size: 0.875rem;
                        color: white;
                    }

                    .modern-header .user-role {
                        font-size: 0.75rem;
                        color: rgba(255, 255, 255, 0.7);
                        font-weight: 400;
                    }

                    /* User Dropdown Menu */
                    .modern-header .user-dropdown-menu {
                        min-width: 300px;
                        right: 0;
                        left: auto;
                    }

                    .modern-header .user-header {
                        padding: 1rem;
                        background: linear-gradient(135deg, var(--header-primary), var(--header-primary-light));
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                        margin: -0.5rem 0 0.5rem 0;
                    }

                    .modern-header .user-avatar-large {
                        width: 50px;
                        height: 50px;
                        border-radius: 50%;
                        overflow: hidden;
                        border: 3px solid rgba(255, 255, 255, 0.3);
                    }

                    .modern-header .user-avatar-large img {
                        width: 100%;
                        height: 100%;
                        object-fit: cover;
                    }

                    .modern-header .user-details {
                        display: flex;
                        flex-direction: column;
                        gap: 0.25rem;
                    }

                    .modern-header .user-full-name {
                        font-weight: 600;
                        font-size: 0.95rem;
                        color: white;
                    }

                    .modern-header .user-email {
                        font-size: 0.8rem;
                        color: rgba(255, 255, 255, 0.8);
                        opacity: 0.9;
                    }

                    /* Special Button Styles */
                    .nav-link.login-btn {
                        background: linear-gradient(135deg, var(--header-success), #059669);
                        border-radius: 12px;
                        font-weight: 600;
                    }

                    .nav-link.login-btn:hover {
                        background: linear-gradient(135deg, #059669, #047857);
                        transform: translateY(-2px);
                    }

                    .nav-link.register-btn {
                        background: linear-gradient(135deg, var(--header-accent), #ea580c);
                        border-radius: 12px;
                        font-weight: 600;
                    }

                    .nav-link.register-btn:hover {
                        background: linear-gradient(135deg, #ea580c, #dc2626);
                        transform: translateY(-2px);
                    }

                    .new-task {
                        background: linear-gradient(135deg, var(--header-success), #059669);
                        color: white !important;
                        margin: 0.25rem 0.5rem;
                        border-radius: 8px;
                    }

                    .logout-item {
                        color: var(--header-error) !important;
                    }

                    .logout-item:hover {
                        background: linear-gradient(135deg, var(--header-error), #dc2626) !important;
                        color: white !important;
                    }

                    /* Mobile Menu Toggle */
                    .mobile-menu-toggle {
                        display: none;
                        flex-direction: column;
                        cursor: pointer;
                        padding: 0.5rem;
                        gap: 0.25rem;
                        z-index: 10;
                    }

                    .hamburger-line {
                        width: 25px;
                        height: 3px;
                        background: white;
                        border-radius: 2px;
                        transition: var(--header-transition);
                    }

                    /* Responsive Design */
                    @media (max-width: 1200px) {
                        .header-container {
                            padding: 0 1.5rem;
                        }

                        .nav-text {
                            display: none;
                        }

                        .nav-icon-wrapper {
                            gap: 0;
                        }

                        .user-info {
                            display: none;
                        }
                    }

                    @media (max-width: 968px) {
                        .main-navigation {
                            display: none;
                        }

                        .mobile-menu-toggle {
                            display: flex;
                        }

                        .header-container {
                            padding: 0 1rem;
                        }
                    }

                    @media (max-width: 576px) {
                        .logo-wrapper {
                            gap: 0.5rem;
                        }

                        .logo-icon {
                            width: 40px;
                            height: 40px;
                            font-size: 1.2rem;
                            border-radius: 10px;
                        }

                        .logo-text {
                            display: none;
                        }

                        .header-container {
                            padding: 0 0.75rem;
                        }
                    }

                    @media (max-width: 480px) {
                        .logo-icon {
                            width: 36px;
                            height: 36px;
                            font-size: 1rem;
                            border-radius: 8px;
                        }
                    }

                    /* Content Offset */
                    .content {
                        padding-top: 70px;
                    }

                    /* Remove old styles */
                    .header {
                        display: none;
                        }
                    </style>
                {% endblock menu %}
                <div class="content">
                        <main role="main" class="main-section">
                            <div class="row">
                                <div class="col">

                                    {% block content %}{% endblock content %}
                                </div>
                            </div>
                                <!-- –ë–ª–æ–∫ –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
                            {% block main_page %}{% endblock %}

                        </main>

                </div>
            </div>
                <!-- Option 1: Bootstrap Bundle with Popper -->
                <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

                                <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
                <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>

                {% block scripts %}{% endblock %}
                {% block styles %}{% endblock %}

                <!-- –ë–ª–æ–∫ —Ñ—É—Ç–µ—Ä–∞ -->
            {% if request.path == '/' and request.endpoint != 'users.register' %}
                <div class="footer-bottom-panel">
                    <div class="left-logo-side">
                        <img src="https://r.tez-tour.com/portal/images/main/logo-white.png" title="TEZ TOUR" class="footer-logo">
                        <br>
                        2024 - 2025 ¬© TEZ Navigator
                        <br>
                        <a href="mailto:help@tez-tour.com">help@tez-tour.com</a>
                        <br>
                    </div>
                </div>
            {% endif %}

            <!-- <script src="{{ url_for('static', filename='js/dropdown.js') }}"></script> -->

            <!-- –û–¢–ö–õ–Æ–ß–ï–ù–û: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è –ø—É—à-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
            <!-- –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ polling —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –±—Ä–∞—É–∑–µ—Ä–Ω—ã–µ push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –Ω—É–∂–Ω—ã -->
            <!--
                            <script type="module" src="{{ url_for('static', filename='js/push-notifications.js') }}"></script>
            -->

            <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
            <!-- –ú–æ–¥—É–ª—å statistics_interactive.js —É–¥–∞–ª–µ–Ω, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω –≤ —à–∞–±–ª–æ–Ω—ã -->

            <!-- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Service Worker -->
            <script>
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç Service Worker
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.addEventListener('message', function(event) {
                        console.log('[Main] –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç Service Worker:', event.data);

                        const data = event.data;

                        if (data.type === 'PLAY_SOUND') {
                            try {
                                console.log('[Main] –ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', data.soundUrl);

                                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç Audio
                                const audio = new Audio(data.soundUrl);

                                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                                audio.volume = 0.7;
                                audio.preload = 'auto';

                                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                                audio.addEventListener('play', () => {
                                    console.log('[Main] –ó–≤—É–∫ –Ω–∞—á–∞–ª –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è');
                                });

                                audio.addEventListener('ended', () => {
                                    console.log('[Main] –ó–≤—É–∫ –∑–∞–∫–æ–Ω—á–∏–ª –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å—Å—è');
                                });

                                audio.addEventListener('error', (error) => {
                                    console.error('[Main] –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', error);
                                });

                                // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫
                                audio.play().catch(error => {
                                    console.warn('[Main] –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫:', error);
                                    // –ü—Ä–æ–±—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫ –ø–æ—Å–ª–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                    document.addEventListener('click', function playOnClick() {
                                        audio.play().catch(console.error);
                                        document.removeEventListener('click', playOnClick);
                                    }, { once: true });
                                });
                            } catch (error) {
                                console.error('[Main] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–∞:', error);
                            }
                        }
                    });
                }
            </script>

            {% include '_new_issues_sidebar.html' %}
            {% if current_user.is_authenticated and current_user.can_access_quality_control and request.endpoint == 'main.quality_control' %}
                {% include '_comment_notifications.html' %}
            {% endif %}

            <script>
                // üì° Polling —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ FCM)
                let lastPollingTimestamp = null;
                let lastNotificationCount = 0;
                let lastNotificationIds = new Set();

                function pollNotifications() {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    if (!document.body.classList.contains('logged-in')) {
                        return;
                    }

                    $.ajax({
                        url: "{{ url_for('main.poll_notifications') }}",
                        type: 'GET',
                        success: function(response) {
                            if (response.success) {
                                const notifications = response.notifications;
                                const currentTimestamp = response.timestamp;
                                const currentTotalCount = response.total_count;

                                // –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—É—â–∏–µ ID —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                                const currentNotificationIds = new Set();
                                notifications.status_notifications.forEach(n => currentNotificationIds.add('status_' + n.id));
                                notifications.comment_notifications.forEach(n => currentNotificationIds.add('comment_' + n.id));

                                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –ø–µ—Ä–≤–∏—á–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
                                if (lastPollingTimestamp === null) {
                                    // –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ - –∑–∞–ø–æ–º–∏–Ω–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–µ–∑ –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                                    lastNotificationCount = currentTotalCount;
                                    lastNotificationIds = new Set(currentNotificationIds);
                                    console.log(`[Polling] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: ${currentTotalCount} —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π`);
                                } else {
                                    // –ò—â–µ–º –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (–∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ –±—ã–ª–æ –≤ –ø—Ä–æ—à–ª—ã–π —Ä–∞–∑)
                                    const newNotifications = {
                                        status_notifications: notifications.status_notifications.filter(n =>
                                            !lastNotificationIds.has('status_' + n.id)
                                        ),
                                        comment_notifications: notifications.comment_notifications.filter(n =>
                                            !lastNotificationIds.has('comment_' + n.id)
                                        )
                                    };

                                    const newCount = newNotifications.status_notifications.length +
                                                   newNotifications.comment_notifications.length;

                                    if (newCount > 0) {
                                        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
                                        showPollingNotification(newNotifications);
                                        console.log(`[Polling] –ù–∞–π–¥–µ–Ω–æ ${newCount} –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π`);
                                    } else {
                                        console.log(`[Polling] –ù–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç (–≤—Å–µ–≥–æ: ${currentTotalCount})`);
                                    }

                                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                                    lastNotificationIds = new Set(currentNotificationIds);
                                }

                                lastPollingTimestamp = currentTimestamp;
                                lastNotificationCount = currentTotalCount;
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('[Polling] –û—à–∏–±–∫–∞:', error);
                        }
                    });
                }

                function showPollingNotification(notifications) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∑–∞–∫—Ä—ã—Ç –ª–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç
                    const isModernWidgetClosed = localStorage.getItem('notificationsWidgetClosed') === 'true';

                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    const hasNewNotifications = (notifications.status_notifications && notifications.status_notifications.length > 0) ||
                                              (notifications.comment_notifications && notifications.comment_notifications.length > 0) ||
                                              (notifications.redmine_notifications && notifications.redmine_notifications.length > 0);

                    // –ï—Å–ª–∏ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω (–Ω–µ –∑–∞–∫—Ä—ã—Ç), –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∂–µ—Ç
                    if (!isModernWidgetClosed) {
                        console.log('[Polling] –°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∂–µ—Ç');

                        // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ –¥–ª—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–∂–µ—Ç–∞
                        if (typeof window.playNotificationSound === 'function') {
                            window.playNotificationSound();
                        }

                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç
                        if (typeof window.modernNotificationsWidget !== 'undefined' &&
                            typeof window.modernNotificationsWidget.refreshNotifications === 'function') {
                            window.modernNotificationsWidget.refreshNotifications();
                        }

                        return;
                    }

                    // –ï—Å–ª–∏ –≤–∏–¥–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                    if (hasNewNotifications) {
                        console.log('[Polling] –í–∏–¥–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç, –Ω–æ –µ—Å—Ç—å –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º');
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç –ø—Ä–∏ –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö
                        if (typeof window.modernNotificationsWidget !== 'undefined' &&
                            typeof window.modernNotificationsWidget.showWidget === 'function') {
                            window.modernNotificationsWidget.showWidget();
                        }
                    }
                }

                // –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–æ—Ç–µ—Ä–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
                let connectionLost = false;
                let lastConnectionCheck = 0;

                function checkConnection() {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                    if (!document.body.classList.contains('logged-in')) {
                        return;
                    }

                    const now = Date.now();
                    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —á–∞—Å—Ç–æ—Ç—É –ø—Ä–æ–≤–µ—Ä–æ–∫ –¥–æ —Ä–∞–∑–∞ –≤ 10 —Å–µ–∫—É–Ω–¥
                    if (now - lastConnectionCheck < 10000) {
                        return;
                    }
                    lastConnectionCheck = now;

                    $.ajax({
                        url: "{{ url_for('main.check_connection') }}",
                        type: 'GET',
                        timeout: 8000, // 8 —Å–µ–∫—É–Ω–¥ timeout
                        success: function(response) {
                            // –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
                            if (connectionLost) {
                                connectionLost = false;
                                console.log('[VPN_CHECK] ‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');

                                Swal.fire({
                                    icon: 'success',
                                    title: '‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ',
                                    text: '–î–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–æ—Ä–º–∞–ª—å–Ω–æ.',
                                    position: 'top-end',
                                    showConfirmButton: false,
                                    timer: 4000,
                                    timerProgressBar: true,
                                    toast: true
                                });
                            }

                            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
                            if (!response.connected) {
                                // –ü—Ä–æ–±–ª–µ–º–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö, –Ω–æ VPN —Ä–∞–±–æ—Ç–∞–µ—Ç
                                if (!connectionLost) {
                                    connectionLost = true;
                                    console.log('[VPN_CHECK] ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö');

                                    Swal.fire({
                                        icon: 'warning',
                                        title: '‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö',
                                        text: '–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å VPN-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ Cisco AnyConnect.',
                                        position: 'top',
                                        showConfirmButton: true,
                                        confirmButtonText: 'üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É',
                                        allowOutsideClick: false,
                                        allowEscapeKey: false,
                                        timer: 15000,
                                        timerProgressBar: true
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            window.location.reload();
                                        }
                                    });
                                }
                            }
                        },
                        error: function(xhr, status, error) {
                            // –ü–æ–ª–Ω–∞—è –ø–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (VPN –æ—Ç–∫–ª—é—á–µ–Ω)
                            if (!connectionLost) {
                                connectionLost = true;
                                console.log('[VPN_CHECK] üö® VPN —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ');

                                let errorMessage = '';
                                let errorTitle = '';

                                if (status === 'timeout') {
                                    errorTitle = 'üö® –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è';
                                    errorMessage = '–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ VPN —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ Cisco AnyConnect.';
                                } else if (xhr.status === 0) {
                                    errorTitle = 'üö® VPN —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø–æ—Ç–µ—Ä—è–Ω–æ';
                                    errorMessage = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É. Cisco AnyConnect VPN –æ—Ç–∫–ª—é—á–µ–Ω –∏–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ VPN –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                                } else {
                                    errorTitle = 'üö® –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
                                    errorMessage = `–û—à–∏–±–∫–∞ ${xhr.status}: ${error}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ VPN —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.`;
                                }

                                Swal.fire({
                                    icon: 'error',
                                    title: errorTitle,
                                    html: `<div style="text-align: left;">${errorMessage}<br><br>
                                          <strong>–ß—Ç–æ –¥–µ–ª–∞—Ç—å:</strong><br>
                                          1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å Cisco AnyConnect<br>
                                          2. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç–µ VPN –µ—Å–ª–∏ –Ω—É–∂–Ω–æ<br>
                                          3. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</div>`,
                                    position: 'center',
                                    showConfirmButton: true,
                                    confirmButtonText: 'üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É',
                                    showCancelButton: true,
                                    cancelButtonText: '‚ùå –ó–∞–∫—Ä—ã—Ç—å',
                                    allowOutsideClick: false,
                                    allowEscapeKey: false,
                                    customClass: {
                                        popup: 'connection-error-popup'
                                    }
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.location.reload();
                                    }
                                });
                            }
                        }
                    });
                }

                // –ó–∞–ø—É—Å–∫–∞–µ–º polling —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
                setInterval(pollNotifications, 30000);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥ (–±—ã—Å—Ç—Ä–µ–µ –¥–ª—è VPN)
                setInterval(checkConnection, 15000);

                // –ù–∞—á–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                pollNotifications();
                checkConnection();

                console.log('[Polling] üì° –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∑–∞–ø—É—â–µ–Ω–∞ (–∏–Ω—Ç–µ—Ä–≤–∞–ª: 30 —Å–µ–∫)');
            </script>

            <!-- Modern Notifications Widget -->
            {% if current_user.is_authenticated %}
                {% include '_modern_notifications_widget.html' %}
            {% endif %}

            <script>
                document.addEventListener('DOMContentLoaded', () => {
                    // --- –≠–ª–µ–º–µ–Ω—Ç—ã DOM ---
                    const menuToggle = document.querySelector('.mobile-menu-toggle');
                    const menuPanel = document.querySelector('.mobile-menu-panel');
                    const menuOverlay = document.querySelector('.mobile-menu-overlay');
                    const closeButton = document.querySelector('.mobile-menu-close');

                    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤—Å–µ—Ö –∫–ª—é—á–µ–≤—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
                    if (!menuToggle || !menuPanel || !menuOverlay || !closeButton) {
                        console.error('Mobile menu components are missing. The menu will not be initialized.');
                        return;
                    }

                    const mainNav = document.querySelector('.main-navigation .nav-menu');
                    const mobileLinksContainer = menuPanel.querySelector('.mobile-menu-links');

                    /**
                     * –ö–æ–ø–∏—Ä—É–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å—Å—ã–ª–∫–∏ –∏–∑ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–≥–æ –º–µ–Ω—é –≤ –º–æ–±–∏–ª—å–Ω–æ–µ.
                     */
                    function cloneNavLinks() {
                        if (!mainNav || !mobileLinksContainer) return;

                        mobileLinksContainer.innerHTML = '';

                        const navItems = mainNav.querySelectorAll(':scope > .nav-item');

                        navItems.forEach(item => {
                            const link = item.querySelector(':scope > .nav-link:not(.dropdown-toggle)');
                            const dropdown = item.querySelector('.dropdown-menu');

                            if (link) {
                                const newLi = document.createElement('li');
                                const newLink = document.createElement('a');
                                newLink.href = link.href;
                                // –ò—Å–ø–æ–ª—å–∑—É–µ–º innerHTML, —á—Ç–æ–±—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –∏–∫–æ–Ω–∫–∏, –∏ —Ç–µ–∫—Å—Ç
                                newLink.innerHTML = link.querySelector('.nav-icon-wrapper').innerHTML;

                                if (link.classList.contains('logout-item')) newLink.classList.add('logout-link');

                                newLi.appendChild(newLink);
                                mobileLinksContainer.appendChild(newLi);
                            }

                            if (dropdown) {
                                const dropdownLinks = dropdown.querySelectorAll('.dropdown-item');
                                dropdownLinks.forEach(dLink => {
                                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏
                                    if (dLink.classList.contains('dropdown-divider')) return;

                                    const newLi = document.createElement('li');
                                    const newLink = document.createElement('a');
                                    newLink.href = dLink.href;
                                    newLink.innerHTML = dLink.innerHTML;

                                    if (dLink.classList.contains('new-task')) newLink.classList.add('new-task-link');
                                    if (dLink.classList.contains('logout-item')) newLink.classList.add('logout-link');

                                    newLi.appendChild(newLink);
                                    mobileLinksContainer.appendChild(newLi);
                                });
                            }
                        });
                    }

                    function openMenu() {
                        menuPanel.classList.add('open');
                        menuOverlay.classList.add('open');
                        menuToggle.classList.add('active');
                        document.body.classList.add('mobile-menu-active');
                        menuToggle.setAttribute('aria-expanded', 'true');
                        menuPanel.setAttribute('aria-hidden', 'false');
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –∫–Ω–æ–ø–∫—É –∑–∞–∫—Ä—ã—Ç–∏—è –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
                        closeButton.focus();
                    }

                    function closeMenu() {
                        menuPanel.classList.remove('open');
                        menuOverlay.classList.remove('open');
                        menuToggle.classList.remove('active');
                        document.body.classList.remove('mobile-menu-active');
                        menuToggle.setAttribute('aria-expanded', 'false');
                        menuPanel.setAttribute('aria-hidden', 'true');
                        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ –∫–Ω–æ–ø–∫—É-–≥–∞–º–±—É—Ä–≥–µ—Ä
                        menuToggle.focus();
                    }

                    menuToggle.addEventListener('click', () => {
                        if (menuPanel.classList.contains('open')) {
                            closeMenu();
                        } else {
                            // –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º —Å—Å—ã–ª–∫–∏ –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º, —á—Ç–æ–±—ã –æ–Ω–∏ –±—ã–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã
                            cloneNavLinks();
                            openMenu();
                        }
                    });

                    closeButton.addEventListener('click', closeMenu);
                    menuOverlay.addEventListener('click', closeMenu);

                    document.addEventListener('keydown', (event) => {
                        if (event.key === 'Escape' && menuPanel.classList.contains('open')) {
                            closeMenu();
                        }
                    });

                    console.log('Mobile menu initialized successfully.');
                });
            </script>
        </body>
</html>
