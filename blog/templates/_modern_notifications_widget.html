<!-- Modern Notifications Widget -->
<!-- –≠–ö–°–¢–†–ï–ù–ù–û–ï –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï: —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å—Ç—Ä–æ–∫—É –Ω–∏–∂–µ –µ—Å–ª–∏ –≤–∏–¥–∂–µ—Ç –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–∞–π—Ç -->
<!-- <script>console.log('üö® –í–ò–î–ñ–ï–¢ –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –≠–ö–°–¢–†–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù'); if(true) throw new Error('Widget disabled');</script> -->

<div id="modern-notifications-widget" class="modern-notifications-widget initial-hidden">
    <div class="notifications-header">
        <div class="header-content">
            <div class="header-icon">
                <i class="fas fa-bell" id="notification-bell-icon"></i>
                <span class="notification-badge" id="notification-count-badge">0</span>
            </div>
            <div class="header-text">
                <h3 class="header-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                <p class="header-subtitle" id="notification-subtitle">–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
            </div>
        </div>
        <div class="header-actions">
            <button class="action-btn minimize-btn" id="minimize-notifications" title="–°–≤–µ—Ä–Ω—É—Ç—å">
                <i class="fas fa-chevron-up"></i>
            </button>
            <button class="action-btn settings-btn" id="notification-settings" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
                <i class="fas fa-cog"></i>
            </button>
            <button class="action-btn close-btn" id="close-notifications" title="–ó–∞–∫—Ä—ã—Ç—å –≤–∏–¥–∂–µ—Ç">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div class="notifications-body" id="notifications-body">
        <div class="notifications-list" id="notifications-list">
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
            <div class="empty-state" id="empty-state">
                <div class="empty-icon">
                    <i class="fas fa-inbox"></i>
                </div>
                <p class="empty-text">–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ—á–∏—Ç–∞–Ω—ã</p>
                <small class="empty-subtitle">–ù–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</small>
            </div>
        </div>

        <div class="notifications-footer">
            <button class="footer-btn view-all-btn" id="view-all-notifications">
                <i class="fas fa-list"></i>
                <span>–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ</span>
            </button>
            <button class="footer-btn clear-btn" id="clear-notifications-modern">
                <i class="fas fa-check-double"></i>
                <span>–û—á–∏—Å—Ç–∏—Ç—å</span>
            </button>
        </div>
    </div>
</div>

<!-- Floating button to restore widget when closed -->
<div id="notifications-restore-btn" class="notifications-restore-btn" style="display: none;">
    <button onclick="showNotificationsWidget()" title="–ü–æ–∫–∞–∑–∞—Ç—å –≤–∏–¥–∂–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π">
        <i class="fas fa-bell"></i>
    </button>
</div>

<style>
/* Modern Notifications Widget Styles */
.modern-notifications-widget {
    position: fixed !important;
    top: 120px !important; /* –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É */
    right: 20px !important;
    width: 420px; /* –ò–ó–ú–ï–ù–ï–ù–û: –®–∏—Ä–∏–Ω–∞ –≤–∏–¥–∂–µ—Ç–∞ —É–≤–µ–ª–∏—á–µ–Ω–∞ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ */
    max-height: 600px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 20px;
    box-shadow:
        0 20px 40px rgba(0, 0, 0, 0.1),
        0 8px 16px rgba(0, 0, 0, 0.05),
        inset 0 1px 0 rgba(255, 255, 255, 0.5);
    z-index: 999999 !important; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π z-index —Å !important */
    display: flex;
    flex-direction: column;
    pointer-events: auto; /* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å */
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    animation: slideInFromRight 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

/* –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è —Å–∫—Ä—ã—Ç–∏—è –≤–∏–¥–∂–µ—Ç–∞ –ø—Ä–∏ –ø–µ—Ä–≤–∏—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ */
.modern-notifications-widget.initial-hidden {
    display: none !important;
}

@keyframes slideInFromRight {
    from {
        transform: translateX(100%) scale(0.9);
        opacity: 0;
    }
    50% {
        transform: translateX(20%) scale(1.02);
        opacity: 0.8;
    }
    to {
        transform: translateX(0) scale(1);
        opacity: 1;
    }
}

.modern-notifications-widget.minimized {
    max-height: 80px;
    overflow: hidden;
}

.modern-notifications-widget.minimized .notifications-body {
    opacity: 0;
    transform: translateY(-10px);
    pointer-events: none;
}

.modern-notifications-widget.hidden {
    transform: translateX(100%);
    opacity: 0;
    pointer-events: none;
}

.modern-notifications-widget.closed {
    display: none;
}

/* Header */
.notifications-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 20px 24px 16px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.08);
    background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
    border-radius: 20px 20px 0 0;
}

.header-content {
    display: flex;
    align-items: center;
    gap: 16px;
}

.header-icon {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #6366f1, #a855f7);
    border-radius: 14px;
    color: white;
    font-size: 20px;
    box-shadow: 0 8px 16px rgba(99, 102, 241, 0.3);
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { box-shadow: 0 8px 16px rgba(99, 102, 241, 0.3); }
    50% { box-shadow: 0 8px 24px rgba(99, 102, 241, 0.5); }
}

.notification-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    min-width: 20px;
    height: 20px;
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid white;
    animation: bounce 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

@keyframes bounce {
    0% { transform: scale(0); }
    50% { transform: scale(1.2); }
    100% { transform: scale(1); }
}

.header-text {
    flex: 1;
}

.header-title {
    font-size: 18px;
    font-weight: 700;
    margin: 0 0 4px 0;
    background: linear-gradient(135deg, #1f2937, #4f46e5);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.header-subtitle {
    font-size: 13px;
    color: #6b7280;
    margin: 0;
    font-weight: 500;
}

.header-actions {
    display: flex;
    gap: 8px;
}

.action-btn {
    width: 36px;
    height: 36px;
    border: none;
    border-radius: 10px;
    background: rgba(0, 0, 0, 0.05);
    color: #6b7280;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    font-size: 14px;
}

.action-btn:hover {
    background: rgba(99, 102, 241, 0.1);
    color: #6366f1;
    transform: translateY(-1px);
}

.close-btn:hover {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

/* Body */
.notifications-body {
    display: flex;
    flex-direction: column;
    max-height: 500px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.notifications-list {
    flex: 1;
    overflow-y: auto;
    padding: 8px;
    scrollbar-width: thin;
    scrollbar-color: rgba(99, 102, 241, 0.3) transparent;
}

.notifications-list::-webkit-scrollbar {
    width: 6px;
}

.notifications-list::-webkit-scrollbar-thumb {
    background: rgba(99, 102, 241, 0.3);
    border-radius: 3px;
}

/* Notification Item */
.notification-item {
    padding: 16px;
    margin-bottom: 8px;
    background: rgba(255, 255, 255, 0.7);
    border: 1px solid rgba(0, 0, 0, 0.06);
    border-radius: 14px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    animation: slideInFromBottom 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes slideInFromBottom {
    from {
        transform: translateY(20px);
        opacity: 0;
    }
    to {
        transform: translateY(0);
        opacity: 1;
    }
}

.notification-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
    background: rgba(255, 255, 255, 0.9);
}

.notification-item.status-change {
    border-left: 4px solid #10b981;
}

.notification-item.comment-added {
    border-left: 4px solid #3b82f6;
}

.notification-item.redmine-task {
    border-left: 4px solid #f97316;
}

.notification-item.redmine-task:hover {
    background: rgba(249, 115, 22, 0.05);
}

.notification-content {
    display: flex;
    align-items: flex-start;
    gap: 12px;
}

.notification-icon {
    width: 36px;
    height: 36px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
}

.notification-icon.status-change {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
}

.notification-icon.comment-added {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
}

.notification-icon.redmine-task {
    background: linear-gradient(135deg, #f97316, #ea580c);
    color: white;
}

.notification-text {
    flex: 1;
}

.notification-title {
    font-size: 14px;
    font-weight: 600;
    color: #1f2937;
    margin: 0 0 4px 0;
    line-height: 1.4;
}

.notification-description {
    font-size: 12px;
    color: #6b7280;
    margin: 0 0 6px 0;
    line-height: 1.4;
}

.notification-time {
    font-size: 11px;
    color: #9ca3af;
    font-weight: 500;
}

/* –£–õ–£–ß–®–ï–ù–û: –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ */
.notification-actions {
    display: flex;
    /* –ò–ó–ú–ï–ù–ï–ù–û: flex-wrap —É–±—Ä–∞–Ω, —á—Ç–æ–±—ã –∫–Ω–æ–ø–∫–∏ –±—ã–ª–∏ –≤ –æ–¥–Ω—É –ª–∏–Ω–∏—é */
    gap: 8px;
    margin-top: 12px;
    padding-top: 12px;
    border-top: 1px solid rgba(0, 0, 0, 0.05);
}

.notification-action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 7px 12px;
    border: 1px solid transparent;
    border-radius: 10px;
    font-size: 11px;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    white-space: nowrap;
}

.notification-action-btn:hover {
    transform: translateY(-2px); /* –ë–æ–ª–µ–µ –∑–∞–º–µ—Ç–Ω—ã–π —Å–¥–≤–∏–≥ */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç–µ–Ω—å –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
}

.notification-action-btn i {
    margin-right: 6px; /* –£–≤–µ–ª–∏—á–µ–Ω –æ—Ç—Å—Ç—É–ø */
}

/* –ò–ó–ú–ï–ù–ï–ù–û: –ö–Ω–æ–ø–∫–∞ "–û—Ç–∫—Ä—ã—Ç—å –≤ Redmine" —Ç–µ–ø–µ—Ä—å —Å–∏–Ω—è—è, –≤ —Å—Ç–∏–ª–µ Redmine */
.redmine-link-btn {
    background: linear-gradient(135deg, #3b82f6, #2563eb); /* –°–∏–Ω–∏–π –≥—Ä–∞–¥–∏–µ–Ω—Ç */
    color: white !important;
    border-color: #1d4ed8;
    box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
}
.redmine-link-btn:hover {
    background: linear-gradient(135deg, #60a5fa, #3b82f6);
    color: white !important;
    border-color: #2563eb;
}

/* –ö–Ω–æ–ø–∫–∞ "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ" - –≤—Ç–æ—Ä–∏—á–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ */
.mark-read-btn {
    background-color: #f3f4f6; /* –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π —Ñ–æ–Ω */
    color: #4b5563; /* –¢–µ–º–Ω–æ-—Å–µ—Ä—ã–π —Ç–µ–∫—Å—Ç */
    border: 1px solid #e5e7eb; /* –¢–æ–Ω–∫–∞—è —Å–µ—Ä–∞—è —Ä–∞–º–∫–∞ */
}
.mark-read-btn:hover {
    background-color: #e5e7eb; /* –ë–æ–ª–µ–µ —Ç–µ–º–Ω—ã–π —Ñ–æ–Ω –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ */
    border-color: #d1d5db;
    color: #1f2937;
}

.mark-read-btn i {
    color: #3b82f6; /* –°–∏–Ω—è—è –∏–∫–æ–Ω–∫–∞ –¥–ª—è –∞–∫—Ü–µ–Ω—Ç–∞ */
}


/* Empty State */
.empty-state {
    text-align: center;
    padding: 40px 20px;
    color: #9ca3af;
}

.empty-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.5;
}

.empty-text {
    font-size: 16px;
    font-weight: 600;
    margin: 0 0 8px 0;
}

.empty-subtitle {
    font-size: 13px;
    margin: 0;
}

/* Footer */
.notifications-footer {
    display: flex;
    flex-direction: row; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫ */
    justify-content: center; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
    align-items: center; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
    padding: 8px 20px; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π padding –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */
    border-top: 1px solid rgba(0, 0, 0, 0.06);
    gap: 12px; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–≤–µ–ª–∏—á–µ–Ω gap –º–µ–∂–¥—É –∫–Ω–æ–ø–∫–∞–º–∏ */
    background: rgba(248, 250, 252, 0.8); /* –î–û–ë–ê–í–õ–ï–ù–û: —Ñ–æ–Ω –¥–ª—è footer */
    border-radius: 0 0 20px 20px; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: —Å–∫—Ä—É–≥–ª–µ–Ω–Ω—ã–µ —É–≥–ª—ã —Å–Ω–∏–∑—É */
    backdrop-filter: blur(10px); /* –î–û–ë–ê–í–õ–ï–ù–û: —Ä–∞–∑–º—ã—Ç–∏–µ —Ñ–æ–Ω–∞ */
    margin: 0; /* –î–û–ë–ê–í–õ–ï–ù–û: —É–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ –æ—Ç—Å—Ç—É–ø—ã */
    box-sizing: border-box; /* –î–û–ë–ê–í–õ–ï–ù–û: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–æ–≤ */
    min-height: 72px; /* –î–û–ë–ê–í–õ–ï–ù–û: –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ footer –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ */
}

.footer-btn {
    flex: 1;
    padding: 10px 12px; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–º–µ–Ω—å—à–µ–Ω padding –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è */
    border: none;
    border-radius: 10px; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–º–µ–Ω—å—à–µ–Ω border-radius */
    font-size: 12px; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–º–µ–Ω—å—à–µ–Ω —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: —É–º–µ–Ω—å—à–µ–Ω gap –º–µ–∂–¥—É –∏–∫–æ–Ω–∫–æ–π –∏ —Ç–µ–∫—Å—Ç–æ–º */
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    min-height: 36px; /* –î–û–ë–ê–í–õ–ï–ù–û: –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–Ω–æ–ø–∫–∏ */
    max-width: 100%; /* –î–û–ë–ê–í–õ–ï–ù–û: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã */
    box-sizing: border-box; /* –î–û–ë–ê–í–õ–ï–ù–û: –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Ä–∞–∑–º–µ—Ä–æ–≤ */
    white-space: nowrap; /* –î–û–ë–ê–í–õ–ï–ù–û: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Ç–µ–∫—Å—Ç–∞ */
    overflow: hidden; /* –î–û–ë–ê–í–õ–ï–ù–û: —Å–∫—Ä—ã—Ç–∏–µ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏—è */
    text-overflow: ellipsis; /* –î–û–ë–ê–í–õ–ï–ù–û: –º–Ω–æ–≥–æ—Ç–æ—á–∏–µ –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–∏ */
}
.footer-btn span {
    opacity: 1 !important;
    visibility: visible !important;
    color: inherit; /* –ù–∞—Å–ª–µ–¥—É–µ–º —Ü–≤–µ—Ç (—Å–∏–Ω–∏–π –∏–ª–∏ –∫—Ä–∞—Å–Ω—ã–π) –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–π –∫–Ω–æ–ø–∫–∏ */
}

.view-all-btn {
    background: rgba(99, 102, 241, 0.1);
    color: #6366f1;
}

.view-all-btn:hover {
    background: rgba(99, 102, 241, 0.2);
    transform: translateY(-1px);
}

.clear-btn {
    background: rgba(239, 68, 68, 0.1);
    color: #ef4444;
}

.clear-btn:hover {
    background: rgba(239, 68, 68, 0.2);
    transform: translateY(-1px);
}

/* Responsive */
@media (max-width: 480px) {
    .modern-notifications-widget {
        width: calc(100vw - 40px) !important;
        right: 20px !important;
        left: 20px !important;
        top: 110px !important; /* –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–π –æ—Ç—Å—Ç—É–ø –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        max-height: calc(100vh - 130px) !important; /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }

    /* –î–û–ë–ê–í–õ–ï–ù–û: –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è footer –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    .notifications-footer {
        padding: 6px 16px; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π padding –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        gap: 8px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π gap –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        min-height: 60px; /* –î–û–ë–ê–í–õ–ï–ù–û: —É–º–µ–Ω—å—à–µ–Ω–Ω–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
    }

    .footer-btn {
        padding: 8px 10px; /* –ï—â–µ –±–æ–ª–µ–µ –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π padding */
        font-size: 11px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π —à—Ä–∏—Ñ—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
        min-height: 32px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–Ω–æ–ø–∫–∏ */
        gap: 4px; /* –£–º–µ–Ω—å—à–µ–Ω–Ω—ã–π gap –º–µ–∂–¥—É –∏–∫–æ–Ω–∫–æ–π –∏ —Ç–µ–∫—Å—Ç–æ–º */
    }

    .footer-btn span {
        display: none; /* –î–û–ë–ê–í–õ–ï–ù–û: —Å–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö, –æ—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫–∏ */
    }

    .footer-btn i {
        font-size: 14px; /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∏–∫–æ–Ω–∫–∏ –∫–æ–≥–¥–∞ —Ç–µ–∫—Å—Ç —Å–∫—Ä—ã—Ç */
    }
}

@media (max-width: 768px) {
    .modern-notifications-widget {
        top: 115px !important; /* –£–≤–µ–ª–∏—á–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ */
        max-height: calc(100vh - 135px) !important;
    }

    /* –î–û–ë–ê–í–õ–ï–ù–û: –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è footer –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö */
    .notifications-footer {
        padding: 7px 18px; /* –ò–°–ü–†–ê–í–õ–ï–ù–û: –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π padding –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö */
        gap: 10px; /* –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π gap –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ */
        min-height: 66px; /* –î–û–ë–ê–í–õ–ï–ù–û: –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ */
    }

    .footer-btn {
        padding: 9px 11px; /* –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π padding –¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ */
        font-size: 12px; /* –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
        min-height: 34px; /* –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –∫–Ω–æ–ø–∫–∏ */
        gap: 5px; /* –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π gap */
    }
}

/* –î–ª—è –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ –º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –æ—Ç—Å—Ç—É–ø */
@media (min-width: 1200px) {
    .modern-notifications-widget {
        top: 130px !important; /* –ë–æ–ª—å—à–∏–π –æ—Ç—Å—Ç—É–ø –Ω–∞ –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–∞—Ö */
    }
}

/* Dark theme */
@media (prefers-color-scheme: dark) {
    .modern-notifications-widget {
        background: rgba(30, 30, 30, 0.95);
        border-color: rgba(255, 255, 255, 0.1);
        color: #ffffff;
    }

    .notification-item {
        background: rgba(45, 45, 45, 0.7);
        border-color: rgba(255, 255, 255, 0.1);
    }

    /* –î–û–ë–ê–í–õ–ï–ù–û: –°—Ç–∏–ª–∏ –¥–ª—è footer –≤ —Ç–µ–º–Ω–æ–π —Ç–µ–º–µ */
    .notifications-footer {
        background: rgba(20, 20, 20, 0.8);
        border-top-color: rgba(255, 255, 255, 0.1);
    }

    .footer-btn {
        color: #ffffff;
    }

    .view-all-btn {
        background: rgba(99, 102, 241, 0.2);
        color: #a5b4fc;
    }

    .view-all-btn:hover {
        background: rgba(99, 102, 241, 0.3);
    }

    .clear-btn {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
    }

    .clear-btn:hover {
        background: rgba(239, 68, 68, 0.3);
    }
}

/* Floating Restore Button */
.notifications-restore-btn {
    position: fixed !important;
    bottom: 20px !important;
    right: 20px !important;
    z-index: 999998 !important; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π z-index –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è */
}

.notifications-restore-btn button {
    width: 56px;
    height: 56px;
    border: none;
    border-radius: 50%;
    background: linear-gradient(135deg, #6366f1, #a855f7);
    color: white;
    font-size: 20px;
    cursor: pointer;
    box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    align-items: center;
    justify-content: center;
}

.notifications-restore-btn button:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(99, 102, 241, 0.6);
}

.notifications-restore-btn button:active {
    transform: translateY(0);
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–∞ –ø—Ä–∏ –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö */
@keyframes bellShake {
    0%, 100% { transform: rotate(0deg); }
    10%, 30%, 50%, 70%, 90% { transform: rotate(-10deg); }
    20%, 40%, 60%, 80% { transform: rotate(10deg); }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–ª–æ–∫–æ–ª—å—á–∏–∫–∞ —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ */
.header-icon .fas.fa-bell.has-notifications {
    color: #ff6b6b;
    filter: drop-shadow(0 0 8px rgba(255, 107, 107, 0.6));
}

/* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è badge */
.notification-badge {
    animation: badgePulse 2s ease-in-out infinite;
}

@keyframes badgePulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}
</style>

<script>
// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π try-catch –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ UI
try {
    console.log('[ModernWidget] üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...');

    class ModernNotificationsWidget {
        constructor() {
            try {
                this.widget = document.getElementById('modern-notifications-widget');
                this.list = document.getElementById('notifications-list');
                this.badge = document.getElementById('notification-count-badge');
                this.subtitle = document.getElementById('notification-subtitle');
                this.notifications = [];
                this.isMinimized = false;

                const missingElements = [];
                if (!this.widget) missingElements.push('modern-notifications-widget');
                if (!this.list) missingElements.push('notifications-list');
                if (!this.badge) missingElements.push('notification-count-badge');
                if (!this.subtitle) missingElements.push('notification-subtitle');

                if (missingElements.length > 0) {
                    console.warn('[ModernWidget] ‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω—ã —ç–ª–µ–º–µ–Ω—Ç—ã:', missingElements.join(', '));
                    console.warn('[ModernWidget] ‚ö†Ô∏è –í–∏–¥–∂–µ—Ç –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');

                    if (!this.widget) {
                        console.error('[ModernWidget] ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –æ—Å–Ω–æ–≤–Ω–æ–π —ç–ª–µ–º–µ–Ω—Ç –≤–∏–¥–∂–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω');
                        return;
                    }
                }

                this.loadWidgetState();
                this.bindEvents();
                this.startPolling();

                console.log('[ModernWidget] ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ:', error);
                if (this.widget) {
                    this.widget.style.display = 'none';
                }
            }
        }

        bindEvents() {
            try {
                document.addEventListener('click', (e) => {
                    if (e.target.closest('#close-notifications')) {
                        console.log('[ModernWidget] üîò –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –∑–∞–∫—Ä—ã—Ç–∏—è –≤–∏–¥–∂–µ—Ç–∞');
                        this.closeWidget();
                        return;
                    }

                    if (e.target.closest('#minimize-notifications')) {
                        console.log('[ModernWidget] üìè –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏');
                        this.toggleMinimize();
                        return;
                    }

                    if (e.target.closest('#clear-notifications-modern')) {
                        console.log('[ModernWidget] üßπ –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ –æ—á–∏—Å—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π');
                        this.clearNotifications();
                        return;
                    }

                    const markReadButton = e.target.closest('.mark-read-btn');
                    if (markReadButton) {
                        e.preventDefault();
                        const notificationId = markReadButton.getAttribute('data-id');
                        if (notificationId && notificationId.startsWith('redmine_')) {
                            const redmineId = notificationId.replace('redmine_', '');
                            console.log(`[ModernWidget] ‚úÖ –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ "–ü—Ä–æ—á–∏—Ç–∞–Ω–æ" –¥–ª—è Redmine ID: ${redmineId}`);
                            this.markRedmineNotificationAsRead(redmineId);
                        }
                        return;
                    }

                    if (e.target.closest('#view-all-notifications')) {
                        console.log('[ModernWidget] üìã –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π');
                        window.location.href = '/notifications';
                        return;
                    }

                    if (e.target.closest('#notification-settings')) {
                        console.log('[ModernWidget] ‚öôÔ∏è –ü–µ—Ä–µ—Ö–æ–¥ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π');
                        this.openNotificationSettings();
                        return;
                    }
                });

                document.addEventListener('dblclick', (e) => {
                    if (e.target.closest('.header-icon')) {
                        console.log('[ModernWidget] üîä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–≤—É–∫–∞ –ø–æ –¥–≤–æ–π–Ω–æ–º—É –∫–ª–∏–∫—É');
                        this.playNotificationSound();
                    }
                });

                console.log('[ModernWidget] ‚úÖ –°–æ–±—ã—Ç–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω—ã —á–µ—Ä–µ–∑ –¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ');
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π:', error);
            }
        }

        toggleMinimize() {
            try {
                this.isMinimized = !this.isMinimized;
                this.widget.classList.toggle('minimized', this.isMinimized);

                const icon = document.querySelector('#minimize-notifications i');
                if (icon) {
                    icon.className = this.isMinimized ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
                }

                localStorage.setItem('notificationsMinimized', this.isMinimized);
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –≤ toggleMinimize:', error);
            }
        }

        closeWidget() {
            try {
                console.log('[ModernWidget] üîò –ó–∞–∫—Ä—ã—Ç–∏–µ –≤–∏–¥–∂–µ—Ç–∞...');
                this.widget.classList.add('hidden');
                this.widget.style.transform = 'translateX(100%)';
                this.widget.style.opacity = '0';

                setTimeout(() => {
                    this.widget.classList.add('closed');
                    this.widget.style.display = 'none';
                    localStorage.setItem('notificationsWidgetClosed', 'true');
                    this.showRestoreButton();
                    console.log('[ModernWidget] ‚úÖ –í–∏–¥–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç, –ø–æ–∫–∞–∑–∞–Ω–∞ –∫–Ω–æ–ø–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
                }, 300);
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –≤ closeWidget:', error);
            }
        }

        showWidget() {
            try {
                console.log('[ModernWidget] üîî –ü–æ–∫–∞–∑ –≤–∏–¥–∂–µ—Ç–∞...');

                this.widget.classList.remove('closed', 'hidden', 'initial-hidden');
                this.widget.style.display = 'flex';
                this.widget.style.visibility = 'visible';
                this.widget.style.opacity = '1';
                this.widget.style.transform = 'translateX(0)';

                localStorage.setItem('notificationsWidgetClosed', 'false');
                this.hideRestoreButton();

                this.widget.style.animation = 'slideInFromRight 0.6s cubic-bezier(0.4, 0, 0.2, 1)';

                setTimeout(() => {
                    this.widget.style.animation = '';
                }, 600);

                this.updateNotifications();

                console.log('[ModernWidget] ‚úÖ –í–∏–¥–∂–µ—Ç —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –∏ –æ–±–Ω–æ–≤–ª–µ–Ω');
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –≤ showWidget:', error);
            }
        }

        showRestoreButton() {
            try {
                const restoreBtn = document.getElementById('notifications-restore-btn');
                if (restoreBtn) {
                    restoreBtn.style.display = 'block';
                }
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –≤ showRestoreButton:', error);
            }
        }

        hideRestoreButton() {
            try {
                const restoreBtn = document.getElementById('notifications-restore-btn');
                if (restoreBtn) {
                    restoreBtn.style.display = 'none';
                }
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –≤ hideRestoreButton:', error);
            }
        }

        loadWidgetState() {
            try {
                const isClosed = localStorage.getItem('notificationsWidgetClosed') === 'true';
                const isMinimized = localStorage.getItem('notificationsMinimized') === 'true';
                const isDisabled = localStorage.getItem('notificationsWidgetDisabled') === 'true';

                console.log('[ModernWidget] üîß –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞:', { isClosed, isMinimized, isDisabled });

                if (isDisabled) {
                    console.log('[ModernWidget] üîï –í–∏–¥–∂–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω, —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–∫–ª—é—á–∞—è –∫–Ω–æ–ø–∫—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
                    this.widget.style.display = 'none';
                    this.widget.classList.add('closed', 'initial-hidden');
                    this.hideRestoreButton();
                    return;
                }

                this.widget.classList.remove('initial-hidden');
                this.adjustWidgetPosition();

                if (isClosed) {
                    this.widget.classList.add('closed');
                    this.widget.style.display = 'none';
                    this.widget.style.visibility = 'hidden';
                    this.widget.style.opacity = '0';
                    this.showRestoreButton();
                    console.log('[ModernWidget] –í–∏–¥–∂–µ—Ç –∑–∞–∫—Ä—ã—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è');
                    return;
                }

                this.widget.style.display = 'flex';
                this.widget.style.visibility = 'visible';
                this.widget.style.opacity = '1';
                this.widget.classList.remove('hidden', 'closed');
                this.hideRestoreButton();

                if (isMinimized) {
                    this.isMinimized = true;
                    this.widget.classList.add('minimized');
                    const icon = document.querySelector('#minimize-notifications i');
                    if (icon) icon.className = 'fas fa-chevron-down';
                }

                console.log('[ModernWidget] ‚úÖ –í–∏–¥–∂–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∏ –ø–æ–∫–∞–∑–∞–Ω');
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ loadWidgetState:', error);

                const isDisabled = localStorage.getItem('notificationsWidgetDisabled') === 'true';
                if (isDisabled) {
                    console.log('[ModernWidget] üîï –í–∏–¥–∂–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ');
                    this.widget.style.display = 'none';
                    this.hideRestoreButton();
                    return;
                }

                this.widget.classList.remove('initial-hidden');
                this.widget.style.display = 'flex';
                this.widget.style.visibility = 'visible';
                this.widget.style.opacity = '1';
            }
        }

        adjustWidgetPosition() {
            try {
                const header = document.querySelector('nav, header, .navbar, .nav, .header');
                if (header) {
                    const headerHeight = header.offsetHeight;
                    const topOffset = Math.max(headerHeight + 40, 120);
                    this.widget.style.setProperty('top', `${topOffset}px`, 'important');
                    console.log(`[ModernWidget] Adjusted position: ${topOffset}px (header height: ${headerHeight}px)`);
                } else {
                    this.widget.style.setProperty('top', '120px', 'important');
                    console.log(`[ModernWidget] Header not found, using safe offset: 120px`);
                }
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –≤ adjustWidgetPosition:', error);
                this.widget.style.setProperty('top', '120px', 'important');
            }
        }

        forcePosition() {
            try {
                this.widget.style.setProperty('position', 'fixed', 'important');
                this.widget.style.setProperty('z-index', '999999', 'important');
                this.widget.style.setProperty('right', '20px', 'important');

                const rect = this.widget.getBoundingClientRect();
                console.log(`[ModernWidget] Position check:`, {
                    top: rect.top,
                    right: rect.right,
                    bottom: rect.bottom,
                    left: rect.left,
                    visible: rect.top >= 0 && rect.left >= 0
                });

                if (rect.top < 60) {
                    this.widget.style.setProperty('top', '120px', 'important');
                    console.log(`[ModernWidget] Widget was hidden, forced to 120px`);
                }
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –≤ forcePosition:', error);
            }
        }

        async startPolling() {
            try {
                setInterval(() => this.updateNotifications(), 30000);
                this.updateNotifications();
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –≤ startPolling:', error);
            }
        }

        async updateNotifications() {
            try {
                const isWidgetDisabled = localStorage.getItem('notificationsWidgetDisabled') === 'true';
                if (isWidgetDisabled) {
                    console.log('[ModernWidget] üîï –í–∏–¥–∂–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π');
                    return;
                }

                console.log('[ModernWidget] üîÑ –ó–∞–ø—Ä–æ—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...');
                const response = await fetch('/api/notifications/poll');
                const data = await response.json();

                if (data.success) {
                    console.log(`[ModernWidget] üì° –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞:`, data);

                    this.processNotifications(data.notifications);
                    const localCount = this.notifications.length;
                    const serverCount = data.total_count || 0;
                    const displayCount = Math.max(localCount, serverCount);

                    console.log(`[ModernWidget] üî¢ –°—á–µ—Ç—á–∏–∫–∏: –ª–æ–∫–∞–ª—å–Ω—ã–π=${localCount}, —Å–µ—Ä–≤–µ—Ä=${serverCount}, –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º=${displayCount}`);
                    this.updateBadge(displayCount);
                } else {
                    console.warn('[ModernWidget] ‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É:', data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
            }
        }

        processNotifications(notifications) {
            try {
                this.notifications = [];
                const hasNewNotifications = (notifications.status_notifications && notifications.status_notifications.length > 0) ||
                                          (notifications.comment_notifications && notifications.comment_notifications.length > 0) ||
                                          (notifications.redmine_notifications && notifications.redmine_notifications.length > 0);

                const isWidgetClosed = localStorage.getItem('notificationsWidgetClosed') === 'true';
                const isWidgetDisabled = localStorage.getItem('notificationsWidgetDisabled') === 'true';

                if (hasNewNotifications && !isWidgetDisabled) {
                    if (isWidgetClosed || this.widget.classList.contains('initial-hidden')) {
                        console.log('[ModernWidget] üîî –ï—Å—Ç—å –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–∏–¥–∂–µ—Ç');
                        this.showWidget();
                    }
                } else if (!hasNewNotifications) {
                    console.log('[ModernWidget] üì≠ –ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞');
                }

                if (notifications.status_notifications) {
                    notifications.status_notifications.forEach(n => {
                        this.notifications.push({
                            id: `status_${n.id}`,
                            type: 'status-change',
                            title: `–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω: #${n.issue_id}`,
                            description: `–°—Ç–∞—Ä—ã–π —Å—Ç–∞—Ç—É—Å: ${n.old_status}, –ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å: ${n.new_status}`,
                            time: this.formatTime(n.date_created),
                            icon: 'fas fa-exchange-alt'
                        });
                    });
                }

                if (notifications.comment_notifications) {
                    notifications.comment_notifications.forEach(n => {
                        this.notifications.push({
                            id: `comment_${n.id}`,
                            type: 'new-comment',
                            title: `–ù–æ–≤—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: #${n.issue_id}`,
                            description: this.truncate(n.notes, 100),
                            time: this.formatTime(n.date_created),
                            icon: 'fas fa-comment',
                            raw: n
                        });
                    });
                }

                if (notifications.redmine_notifications) {
                    notifications.redmine_notifications.forEach(n => {
                        const descriptionDetails = n.issue_description ? ` ‚Äî ${this.truncate(n.issue_description.replace(/<.*?>/g, ''), 70)}` : '';
                        const isGroupNotification = !!n.is_group_notification;
                        const title = isGroupNotification ? `‚úÖ –ó–∞–¥–∞—á–∞ –¥–ª—è –≥—Ä—É–ø–ø—ã: ${n.group_name || '–ë–µ–∑ –∏–º–µ–Ω–∏'}` : `üî• –í–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∞ –∑–∞–¥–∞—á–∞`;

                        this.notifications.push({
                            id: `redmine_${n.id}`,
                            type: 'redmine-task',
                            title: title,
                            description: `<b>#${n.redmine_issue_id}</b>: ${n.issue_subject}${descriptionDetails}`,
                            time: this.formatTime(n.created_at),
                            icon: 'fas fa-tasks',
                            url: n.issue_url,
                            group_name: n.group_name
                        });
                    });
                }

                const incomingIds = this.notifications.map(n => n.id);
                const seenIds = JSON.parse(localStorage.getItem('seenNotificationIds')) || [];
                const newNotificationIds = incomingIds.filter(id => !seenIds.includes(id));

                if (newNotificationIds.length > 0) {
                    console.log('[ModernWidget] üé∂ –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –Ω–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫. ID:', newNotificationIds);
                    this.playNotificationSound();
                    const updatedSeenIds = [...seenIds, ...newNotificationIds];
                    localStorage.setItem('seenNotificationIds', JSON.stringify(updatedSeenIds));
                }

                this.renderNotifications();
                this.updateBadge(this.notifications.length);
                console.log(`[ModernWidget] üìä –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: ${this.notifications.length}`);
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
            }
        }

        renderNotifications() {
            try {
                if (this.notifications.length === 0) {
                    this.list.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon"><i class="fas fa-inbox"></i></div>
                            <p class="empty-text">–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ—á–∏—Ç–∞–Ω—ã</p>
                            <small class="empty-subtitle">–ù–æ–≤—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</small>
                        </div>
                    `;
                    return;
                }
                this.list.innerHTML = this.notifications.map(notification => {
                    console.log('[ModernWidget] Notification data:', notification); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    return `
                    <div class="notification-item ${notification.type}" data-id="${notification.id}">
                        <div class="notification-content">
                            <div class="notification-icon ${notification.type}"><i class="${notification.icon}"></i></div>
                            <div class="notification-text">
                                <div class="notification-title">${notification.title}</div>
                                <div class="notification-description">${notification.description}</div>
                                <div class="notification-time">${notification.time}</div>
                                ${notification.type === 'redmine-task' ? `
                                <div class="notification-actions">
                                    <button class="notification-action-btn mark-read-btn" data-id="${notification.id}">
                                        <i class="fas fa-check-circle"></i>–ü—Ä–æ—á–∏—Ç–∞–Ω–æ
                                    </button>
                                    <a href="${notification.url}" target="_blank" class="notification-action-btn redmine-link-btn">
                                        <i class="fas fa-external-link-alt"></i>–û—Ç–∫—Ä—ã—Ç—å –≤ Redmine
                                    </a>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `}).join('');
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
                if (this.list) {
                    this.list.innerHTML = '<div class="error-state">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>';
                }
            }
        }

        updateBadge(count) {
            try {
                console.log(`[ModernWidget] üî¢ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞: ${count}`);

                if (!this.badge) this.badge = document.getElementById('notification-count-badge');
                if (!this.subtitle) this.subtitle = document.getElementById('notification-subtitle');

                if (this.badge) {
                    this.badge.textContent = count;
                    this.badge.style.display = count > 0 ? 'flex' : 'none';
                    console.log(`[ModernWidget] ‚úÖ Badge –æ–±–Ω–æ–≤–ª–µ–Ω: ${count}, –≤–∏–¥–∏–º–æ—Å—Ç—å: ${count > 0 ? '–ø–æ–∫–∞–∑–∞–Ω' : '—Å–∫—Ä—ã—Ç'}`);
                } else {
                    console.warn('[ModernWidget] ‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç badge (notification-count-badge) –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }

                if (this.subtitle) {
                    const text = count > 0 ? `${count} –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π` : '–ù–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π';
                    this.subtitle.textContent = text;
                    console.log(`[ModernWidget] ‚úÖ Subtitle –æ–±–Ω–æ–≤–ª–µ–Ω: "${text}"`);
                } else {
                    console.warn('[ModernWidget] ‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç subtitle (notification-subtitle) –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }

                const bellIcon = document.getElementById('notification-bell-icon');
                if (bellIcon) {
                    if (count > 0) {
                        bellIcon.classList.add('has-notifications');
                        bellIcon.style.animation = 'bellShake 0.5s ease-in-out';
                        setTimeout(() => {
                            bellIcon.style.animation = '';
                        }, 500);
                    } else {
                        bellIcon.classList.remove('has-notifications');
                    }
                }

            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è badge:', error);
            }
        }

        formatTime(dateString) {
            try {
                if (!dateString) return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;

                if (diff < 60000) return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
                if (diff < 3600000) return `${Math.floor(diff / 60000)} –º–∏–Ω –Ω–∞–∑–∞–¥`;
                if (diff < 86400000) return `${Math.floor(diff / 3600000)} —á –Ω–∞–∑–∞–¥`;

                return date.toLocaleDateString('ru-RU');
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏:', error);
                return '–¢–æ–ª—å–∫–æ —á—Ç–æ';
            }
        }

        truncate(text, length) {
            if (!text || typeof text !== 'string') {
                return '';
            }
            if (text.length <= length) {
                return text;
            }
            return text.substring(0, length).trim() + '...';
        }

        playNotificationSound() {
            try {
                const soundDisabled = localStorage.getItem('notificationSoundDisabled') === 'true';
                if (soundDisabled) {
                    console.log('[ModernWidget] üîá –ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç–∫–ª—é—á–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ');
                    return;
                }

                const audio = new Audio("{{ url_for('static', filename='sounds/notification.mp3') }}");
                audio.volume = 0.5;
                audio.play().catch(e => {
                    console.warn('[ModernWidget] –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –∑–≤—É–∫:', e);
                    if (e.name === 'NotAllowedError') {
                        console.log('[ModernWidget] –ó–≤—É–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –±—Ä–∞—É–∑–µ—Ä–æ–º. –û–∂–∏–¥–∞–Ω–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
                        const playOnClick = () => {
                            audio.play().catch(console.warn);
                            document.removeEventListener('click', playOnClick);
                        };
                        document.addEventListener('click', playOnClick, { once: true });
                    }
                });
                console.log('[ModernWidget] üîä –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è');
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç–∞:', error);
            }
        }

        openNotificationSettings() {
            try {
                console.log('[ModernWidget] ‚öôÔ∏è –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞—Å—Ç—Ä–æ–µ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...');
                const settingsUrl = '/notifications-polling';
                const settingsBtn = document.getElementById('notification-settings');
                if (settingsBtn) {
                    settingsBtn.style.transform = 'scale(0.95)';
                    settingsBtn.style.opacity = '0.7';
                    setTimeout(() => {
                        settingsBtn.style.transform = 'scale(1)';
                        settingsBtn.style.opacity = '1';
                    }, 150);
                }
                window.location.href = settingsUrl;
                console.log('[ModernWidget] ‚úÖ –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω');
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–µ–∫. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –ø–æ —Å—Å—ã–ª–∫–µ /notifications-polling –≤—Ä—É—á–Ω—É—é.');
            }
        }

        async clearNotifications() {
            try {
                if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, –≤–∫–ª—é—á–∞—è –∑–∞–¥–∞—á–∏ Redmine? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

                console.log('[ModernWidget] üßπ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—á–∏—Å—Ç–∫—É –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–∏–∑ –≤–∏–¥–∂–µ—Ç–∞)...');
                const response = await fetch('/api/notifications/widget/clear', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.content || ''
                    }
                });
                const data = await response.json();

                if (data.success) {
                    console.log('[ModernWidget] ‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.');
                    this.notifications = [];
                    this.renderNotifications();
                    this.updateBadge(0);
                    localStorage.removeItem('seenNotificationIds');
                    console.log('[ModernWidget] üóëÔ∏è –°–ø–∏—Å–æ–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—á–∏—â–µ–Ω.');
                    this.widget.style.transform = 'scale(1.02)';
                    setTimeout(() => {
                        this.widget.style.transform = 'scale(1)';
                    }, 200);
                } else {
                    console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', data.error);
                    alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—á–∏—Å—Ç–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.');
            }
        }

        async markRedmineNotificationAsRead(notificationId) {
            try {
                const response = await fetch('/api/notifications/redmine/mark-read', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name=csrf-token]')?.content || ''
                    },
                    body: JSON.stringify({ notification_id: notificationId })
                });
                const data = await response.json();

                if (data.success) {
                    console.log(`[ModernWidget] ‚úÖ Redmine —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ${notificationId} –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ`);
                    const itemToRemove = this.list.querySelector(`.notification-item[data-id="redmine_${notificationId}"]`);
                    if (itemToRemove) {
                        itemToRemove.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
                        itemToRemove.style.opacity = '0';
                        itemToRemove.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            this.notifications = this.notifications.filter(n => n.id !== `redmine_${notificationId}`);
                            this.renderNotifications();
                            this.updateBadge(this.notifications.length);
                        }, 400);
                    } else {
                        this.notifications = this.notifications.filter(n => n.id !== `redmine_${notificationId}`);
                        this.renderNotifications();
                        this.updateBadge(this.notifications.length);
                    }
                } else {
                    console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ Redmine —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ:', data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                    alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ—Ç–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ: ${data.error || '–°–µ—Ä–≤–µ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
                }
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ Redmine —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ:', error);
                alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–≥–æ.');
            }
        }
    }

    let notificationsWidget = null;

    document.addEventListener('DOMContentLoaded', () => {
        try {
            if (document.body.classList.contains('logged-in')) {
                initializeWidgetWithUserPreferences();
            }
        } catch (error) {
            console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –≤ DOMContentLoaded:', error);
        }
    });

    async function initializeWidgetWithUserPreferences() {
        try {
            const localWidgetDisabled = localStorage.getItem('notificationsWidgetDisabled') === 'true';
            console.log('[ModernWidget] üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ localStorage –Ω–∞—Å—Ç—Ä–æ–µ–∫:', { widgetDisabled: localWidgetDisabled });

            if (localWidgetDisabled) {
                console.log('[ModernWidget] üîï –í–∏–¥–∂–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω –≤ localStorage, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é');
                const widget = document.getElementById('modern-notifications-widget');
                if (widget) {
                    widget.style.display = 'none';
                    widget.classList.add('closed');
                }
                const restoreBtn = document.getElementById('notifications-restore-btn');
                if (restoreBtn) {
                    restoreBtn.style.display = 'none';
                    console.log('[ModernWidget] üîï –ö–Ω–æ–ø–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∫—Ä—ã—Ç–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–Ω–æ–º –≤–∏–¥–∂–µ—Ç–µ');
                }
                return;
            }

            const response = await fetch('/api/notifications/widget/status');
            const data = await response.json();

            if (data.success && !data.enabled) {
                console.log('[ModernWidget] –í–∏–¥–∂–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é');
                localStorage.setItem('notificationsWidgetDisabled', 'true');
                const widget = document.getElementById('modern-notifications-widget');
                if (widget) {
                    widget.style.display = 'none';
                    widget.classList.add('closed');
                }
                return;
            }

            localStorage.setItem('notificationsWidgetDisabled', 'false');
            initializeWidget();

        } catch (error) {
            console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            const localWidgetDisabled = localStorage.getItem('notificationsWidgetDisabled') === 'true';
            if (localWidgetDisabled) {
                console.log('[ModernWidget] üîï –í–∏–¥–∂–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—Ä–∏ –æ—à–∏–±–∫–µ —Å–µ—Ä–≤–µ—Ä–∞');
                const widget = document.getElementById('modern-notifications-widget');
                if (widget) widget.style.display = 'none';
                const restoreBtn = document.getElementById('notifications-restore-btn');
                if (restoreBtn) {
                    restoreBtn.style.display = 'none';
                    console.log('[ModernWidget] üîï –ö–Ω–æ–ø–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–∫—Ä—ã—Ç–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ (–≤–∏–¥–∂–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω)');
                }
                return;
            }

            localStorage.setItem('notificationsWidgetDisabled', 'false');
            initializeWidget();
        }
    }

    function initializeWidget() {
        try {
            setTimeout(() => {
                try {
                    const widget = document.getElementById('modern-notifications-widget');
                    const list = document.getElementById('notifications-list');
                    const badge = document.getElementById('notification-count-badge');

                    if (!widget || !list || !badge) {
                        console.warn('[ModernWidget] ‚ö†Ô∏è –ù–µ –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞–π–¥–µ–Ω—ã –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏, –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É');
                        if (widget) {
                            widget.classList.remove('initial-hidden');
                            widget.style.display = 'flex';
                        }
                        setTimeout(initializeWidget, 1000);
                        return;
                    }

                    notificationsWidget = new ModernNotificationsWidget();
                    window.notificationsWidget = notificationsWidget;
                    window.testNotificationSound = () => {
                        console.log('üîä –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–≤—É–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è...');
                        notificationsWidget.playNotificationSound();
                    };

                    console.log('üéµ –î–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–≤—É–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: testNotificationSound() –∏–ª–∏ –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –ø–æ –∏–∫–æ–Ω–∫–µ –≤–∏–¥–∂–µ—Ç–∞');
                    console.log('[ModernWidget] ‚úÖ –í–∏–¥–∂–µ—Ç —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π');

                } catch (error) {
                    console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
                    const widget = document.getElementById('modern-notifications-widget');
                    if (widget) {
                        widget.classList.remove('initial-hidden');
                        widget.style.display = 'flex';
                    }
                }
            }, 100);

        } catch (error) {
            console.error('[ModernWidget] ‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∏–¥–∂–µ—Ç–∞:', error);
            const widget = document.getElementById('modern-notifications-widget');
            if (widget) {
                widget.classList.remove('initial-hidden');
                widget.style.display = 'flex';
            }
        }
    }

    window.showNotificationsWidget = () => {
        try {
            if (notificationsWidget) notificationsWidget.showWidget();
        } catch (error) {
            console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –≤ showNotificationsWidget:', error);
        }
    };

    window.hideNotificationsWidget = () => {
        try {
            if (notificationsWidget) notificationsWidget.closeWidget();
        } catch (error) {
            console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –≤ hideNotificationsWidget:', error);
        }
    };

    window.playNotificationSound = () => {
        try {
            const soundDisabled = localStorage.getItem('notificationSoundDisabled') === 'true';
            if (soundDisabled) {
                console.log('[Global] üîá –ó–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç–∫–ª—é—á–µ–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ');
                return;
            }
            if (notificationsWidget) {
                notificationsWidget.playNotificationSound();
            } else {
                try {
                    const audio = new Audio("{{ url_for('static', filename='sounds/notification.mp3') }}");
                    audio.volume = 0.5;
                    audio.play().catch(console.warn);
                    console.log('[Global] üîä –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (fallback)');
                } catch (error) {
                    console.error('[Global] –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', error);
                }
            }
        } catch (error) {
            console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –≤ playNotificationSound:', error);
        }
    };

    window.modernNotificationsWidget = {
        refreshNotifications: () => {
            try {
                if (notificationsWidget) notificationsWidget.updateNotifications();
            } catch (error) {
                console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ –≤ refreshNotifications:', error);
            }
        }
    };

    window.emergencyShowWidget = () => {
        try {
            console.log('[ModernWidget] üö® –≠–∫—Å—Ç—Ä–µ–Ω–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞...');
            const widget = document.getElementById('modern-notifications-widget');
            if (widget) {
                widget.classList.remove('initial-hidden', 'hidden', 'closed');
                widget.style.display = 'flex';
                widget.style.visibility = 'visible';
                widget.style.opacity = '1';
                widget.style.position = 'fixed';
                widget.style.top = '120px';
                widget.style.right = '20px';
                widget.style.zIndex = '999999';

                localStorage.setItem('notificationsWidgetClosed', 'false');
                localStorage.setItem('notificationsWidgetDisabled', 'false');

                console.log('[ModernWidget] ‚úÖ –í–∏–¥–∂–µ—Ç —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');

                if (!window.notificationsWidget) {
                    console.log('[ModernWidget] üîÑ –ü–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–∞...');
                    initializeWidget();
                }
            } else {
                console.error('[ModernWidget] ‚ùå –≠–ª–µ–º–µ–Ω—Ç –≤–∏–¥–∂–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM');
            }
        } catch (error) {
            console.error('[ModernWidget] ‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
        }
    };

    console.log('[ModernWidget] üõ†Ô∏è –î–ª—è —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ: emergencyShowWidget()');

} catch (globalError) {
    console.error('[ModernWidget] üö® –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –í–ò–î–ñ–ï–¢–ê –£–í–ï–î–û–ú–õ–ï–ù–ò–ô:', globalError);

    const widget = document.getElementById('modern-notifications-widget');
    if (widget) {
        widget.classList.remove('initial-hidden');
        widget.style.display = 'none';
    }

    console.log('[ModernWidget] ‚ö†Ô∏è –í–∏–¥–∂–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç–∫–ª—é—á–µ–Ω –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏. –û—Å—Ç–∞–ª—å–Ω–æ–π —Å–∞–π—Ç –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–æ—Ä–º–∞–ª—å–Ω–æ.');
}
</script>
