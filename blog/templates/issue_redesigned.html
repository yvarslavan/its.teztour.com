{% extends 'layout.html' %}

{% block head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block main_page %}
<div class="issue-detail-container">
  <!-- Breadcrumb Navigation -->
  <nav class="breadcrumb-nav" aria-label="Breadcrumb">
    <ol class="breadcrumb-list">
      <li class="breadcrumb-item">
        <a href="{{ url_for('main.my_issues') }}" class="breadcrumb-link">
          <i class="fas fa-list"></i>
          <span>Мои заявки</span>
        </a>
      </li>
      <li class="breadcrumb-separator">
        <i class="fas fa-chevron-right"></i>
      </li>
      <li class="breadcrumb-item active">
        <span>Заявка #{{issue_detail.id}}</span>
      </li>
    </ol>
  </nav>

  <!-- Header Card -->
  <div class="card header-card">
    <div class="card-header">
      <div class="header-content-wrapper">
        <div class="header-main-content">
          <!-- Status Indicator -->
          {% set status_class = 'default' %}
          {% set status_icon = 'circle' %}
          {% if issue_detail.status_name in ['Закрыта', 'Closed', 'Resolved'] %}
            {% set status_class = 'success' %}
            {% set status_icon = 'check-circle' %}
          {% elif issue_detail.status_name in ['Новая', 'Открыта', 'Open', 'New'] %}
            {% set status_class = 'info' %}
            {% set status_icon = 'info-circle' %}
          {% elif issue_detail.status_name in ['В работе', 'In Progress'] %}
            {% set status_class = 'warning' %}
            {% set status_icon = 'clock' %}
          {% elif issue_detail.status_name in ['Отклонена', 'Rejected'] %}
            {% set status_class = 'destructive' %}
            {% set status_icon = 'times-circle' %}
          {% endif %}

          <div class="issue-status-badge-large">
            <i class="fas fa-{{ status_icon }} status-icon-lg"></i>
          </div>

          <div class="header-text-content">
            <div class="issue-number-badge">
              <span class="issue-hash">#</span>{{issue_detail.id}}
            </div>
            <h1 class="issue-title-main">{{issue_detail.subject}}</h1>
            <div class="header-meta-info">
              <span class="badge badge-{{ status_class }}">
                <i class="fas fa-{{ status_icon }}"></i>
                {{ issue_detail.status_name }}
              </span>
              {% if issue_detail.priority_name in ['Высокий', 'Срочный', 'Неотложный'] %}
                <span class="badge badge-destructive">
                  <i class="fas fa-exclamation-triangle"></i>
                  {{ issue_detail.priority_name }}
                </span>
              {% else %}
                <span class="badge badge-outline">
                  <i class="fas fa-flag"></i>
                  {{ issue_detail.priority_name }}
                </span>
              {% endif %}
            </div>
          </div>
        </div>

        <div class="header-actions-group">
          <button onclick="goBackToListOptimized(); return false;" class="btn btn-outline btn-sm">
            <i class="fas fa-arrow-left"></i>
            <span class="btn-text">Назад</span>
          </button>
          <button onclick="window.print()" class="btn btn-ghost btn-sm">
            <i class="fas fa-print"></i>
            <span class="btn-text">Печать</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="content-grid">

    <!-- Main Column -->
    <div class="main-column">

      <!-- Description Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-file-alt card-icon"></i>
            <h2>Описание</h2>
          </div>
        </div>
        <div class="card-content">
          {% if issue_detail.description %}
            <div class="prose" id="descriptionText">
              {{ issue_detail.description | safe }}
            </div>
            {% if issue_detail.description and issue_detail.description | length > 500 %}
              <button id="toggleDescriptionBtn" class="btn btn-link btn-sm" onclick="toggleDescription()">
                <i class="fas fa-chevron-down btn-icon"></i>
                <span class="btn-text">Показать полностью</span>
              </button>
            {% endif %}
          {% else %}
            <div class="empty-state">
              <div class="empty-state-icon">
                <i class="fas fa-file-alt"></i>
              </div>
              <div class="empty-state-content">
                <h3 class="empty-state-title">Описание отсутствует</h3>
                <p class="empty-state-description">К этой заявке не добавлено подробное описание</p>
              </div>
            </div>
          {% endif %}
        </div>
      </div>

      <!-- Attachments Card -->
      {% if attachment_list %}
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-paperclip card-icon"></i>
            <h2>Вложения</h2>
            <span class="badge badge-secondary">{{ attachment_list | length }}</span>
          </div>
        </div>
        <div class="card-content">
          <div class="attachments-grid">
            {% for attachment in attachment_list %}
              {% set filename_lower = attachment.filename.lower() %}
              {% set file_type = 'default' %}
              {% set icon_class = 'file-alt' %}
              {% set icon_color = 'default' %}
              {% if '.pdf' in filename_lower %}
                {% set icon_class = 'file-pdf' %}
                {% set icon_color = 'red' %}
              {% elif '.doc' in filename_lower or '.docx' in filename_lower %}
                {% set icon_class = 'file-word' %}
                {% set icon_color = 'blue' %}
              {% elif '.xls' in filename_lower or '.xlsx' in filename_lower %}
                {% set icon_class = 'file-excel' %}
                {% set icon_color = 'green' %}
              {% elif '.png' in filename_lower or '.jpg' in filename_lower or '.jpeg' in filename_lower or '.gif' in filename_lower %}
                {% set icon_class = 'file-image' %}
                {% set icon_color = 'purple' %}
              {% elif '.zip' in filename_lower or '.rar' in filename_lower or '.7z' in filename_lower %}
                {% set icon_class = 'file-archive' %}
                {% set icon_color = 'orange' %}
              {% endif %}

              <div class="attachment-item">
                <div class="attachment-icon icon-{{ icon_color }}">
                  <i class="fas fa-{{ icon_class }}"></i>
                </div>
                <div class="attachment-details">
                  <div class="attachment-name" title="{{ attachment.filename }}">
                    {{ attachment.filename }}
                  </div>
                  <div class="attachment-meta">
                    {% if attachment.author %}
                      <span class="meta-item">
                        <i class="fas fa-user"></i>
                        {{ attachment.author }}
                      </span>
                    {% endif %}
                    <span class="meta-item">
                      <i class="fas fa-clock"></i>
                      {{ convert_datetime_msk_format(attachment.created_on) }}
                    </span>
                  </div>
                </div>
                <button onclick="downloadIssueAttachment('{{ attachment.id }}')" class="btn btn-primary btn-icon" title="Скачать">
                  <i class="fas fa-download"></i>
                </button>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endif %}

      <!-- History & Comments Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-history card-icon"></i>
            <h2>История и комментарии</h2>
            {% if issue_history %}
              <span class="badge badge-secondary">{{ issue_history | length }}</span>
            {% endif %}
          </div>
        </div>
        <div class="card-content">

          <!-- Add Comment Section -->
          <div class="comment-section">
            <button class="btn btn-primary btn-sm" onclick="toggleCommentInput()">
              <i class="fas fa-plus"></i>
              <span>Добавить комментарий</span>
            </button>

            <form id="commentForm" action="" method="POST" enctype="multipart/form-data" class="comment-form" style="display: none;">
              {{ form.hidden_tag() }}
              <div class="form-group">
                <label class="form-label">{{ form.comment.label.text }}</label>
                {{ form.comment(class="form-textarea", rows="4", placeholder="Введите ваш комментарий...") }}
              </div>
              <div class="form-actions">
                <button type="button" onclick="toggleCommentInput()" class="btn btn-ghost btn-sm">
                  <i class="fas fa-times"></i>
                  Отмена
                </button>
                <button type="submit" class="btn btn-primary btn-sm" id="submitBtn" onclick="disableSubmitButton(); this.form.submit();">
                  <i class="fas fa-paper-plane"></i>
                  Отправить
                </button>
              </div>
            </form>
          </div>

          <div class="separator"></div>

          <!-- Timeline -->
          {% if issue_history %}
            <div class="timeline">
              {% for journal_entry in issue_history %}
                <div class="timeline-item">
                  {% set marker_class = 'default' %}
                  {% set event_icon = 'edit' %}
                  {% if journal_entry.notes and journal_entry.private_notes %}
                    {% set event_icon = 'lock' %}
                    {% set marker_class = 'destructive' %}
                  {% elif journal_entry.notes %}
                    {% set event_icon = 'comment' %}
                    {% set marker_class = 'info' %}
                  {% elif journal_entry.details and journal_entry.details | selectattr('name', 'equalto', 'status_id') | list | length > 0 %}
                    {% set event_icon = 'flag' %}
                    {% set marker_class = 'warning' %}
                  {% elif journal_entry.details and journal_entry.details | selectattr('name', 'equalto', 'assigned_to_id') | list | length > 0 %}
                    {% set event_icon = 'user-cog' %}
                    {% set marker_class = 'success' %}
                  {% endif %}

                  <div class="timeline-marker timeline-marker-{{ marker_class }}">
                    <i class="fas fa-{{ event_icon }}"></i>
                  </div>

                  <div class="timeline-content-card">
                    <div class="timeline-header">
                      <div class="timeline-user-info">
                        <div class="user-avatar">
                          {{ (journal_entry.user or 'Система')[0] }}
                        </div>
                        <div>
                          <div class="timeline-user-name">{{ journal_entry.user or 'Система' }}</div>
                          <div class="timeline-timestamp">{{ convert_datetime_msk_format(journal_entry.created_on) }}</div>
                        </div>
                      </div>
                    </div>

                    {% if journal_entry.details %}
                      <div class="timeline-changes">
                        {% for detail in journal_entry.details %}
                          {% set old_value = detail.get('old_value') %}
                          {% set new_value = detail.get('new_value') %}
                          {% set cache_key = detail['property'] + ':' + detail['name'] + ':' + (old_value|string if old_value else '') + ':' + (new_value|string if new_value else '') %}
                          {% set property_name_html = property_descriptions.get(cache_key) %}

                          {% if property_name_html %}
                            <div class="change-item">
                              <i class="fas fa-arrow-right change-icon"></i>
                              <div class="change-description">{{ property_name_html | safe }}</div>
                            </div>
                          {% endif %}
                        {% endfor %}
                      </div>
                    {% endif %}

                    {% if journal_entry.notes %}
                      <div class="timeline-notes {% if journal_entry.private_notes %}private{% endif %}">
                        {% if journal_entry.private_notes %}
                          <div class="private-badge">
                            <i class="fas fa-lock"></i>
                            <span>Приватный комментарий</span>
                          </div>
                        {% else %}
                          <div class="note-content">{{ journal_entry.notes | safe }}</div>
                        {% endif %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-state">
              <div class="empty-state-icon">
                <i class="fas fa-history"></i>
              </div>
              <div class="empty-state-content">
                <h3 class="empty-state-title">История изменений пуста</h3>
                <p class="empty-state-description">Пока не было внесено изменений в эту заявку</p>
              </div>
            </div>
          {% endif %}
        </div>
      </div>

    </div>

    <!-- Sidebar Column -->
    <div class="sidebar-column">

      <!-- Issue Details Card -->
      <div class="card card-sticky">
        <div class="card-header">
          <div class="card-title">
            <i class="fas fa-info-circle card-icon"></i>
            <h2>Детали</h2>
          </div>
        </div>
        <div class="card-content">
          <div class="detail-list">

            <!-- Author -->
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-user detail-icon"></i>
                <span>Автор</span>
              </div>
              <div class="detail-value">
                {% if issue_detail.author_lastname is defined and issue_detail.author_lastname is not none %}
                  {{ issue_detail.author_lastname }} {{ issue_detail.author_firstname }}
                {% else %}
                  <span class="text-muted">Не указан</span>
                {% endif %}
              </div>
            </div>

            <div class="separator-sm"></div>

            <!-- Assignee -->
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-user-cog detail-icon"></i>
                <span>Исполнитель</span>
              </div>
              <div class="detail-value">
                {% if issue_detail.assigned_to_lastname is defined and issue_detail.assigned_to_lastname is not none %}
                  {{ issue_detail.assigned_to_lastname }} {{ issue_detail.assigned_to_firstname }}
                {% else %}
                  <span class="text-muted">Не назначен</span>
                {% endif %}
              </div>
            </div>

            <div class="separator-sm"></div>

            <!-- Created -->
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-calendar-plus detail-icon"></i>
                <span>Создана</span>
              </div>
              <div class="detail-value">
                <div class="date-display">
                  <span class="date-primary">{{issue_detail.created_on.strftime('%d.%m.%Y')}}</span>
                  <span class="date-time">{{issue_detail.created_on.strftime('%H:%M')}}</span>
                </div>
              </div>
            </div>

            {% if issue_detail.start_date %}
            <div class="separator-sm"></div>
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-calendar-alt detail-icon"></i>
                <span>Начало</span>
              </div>
              <div class="detail-value">
                <span class="date-primary">{{ issue_detail.start_date.strftime('%d.%m.%Y') }}</span>
              </div>
            </div>
            {% endif %}

            {% if issue_detail.due_date %}
            <div class="separator-sm"></div>
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-calendar-times detail-icon"></i>
                <span>Срок</span>
              </div>
              <div class="detail-value">
                <span class="date-primary">{{ issue_detail.due_date.strftime('%d.%m.%Y') }}</span>
              </div>
            </div>
            {% endif %}

            {% if issue_detail.closed_on %}
            <div class="separator-sm"></div>
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-calendar-check detail-icon"></i>
                <span>Закрыта</span>
              </div>
              <div class="detail-value">
                <div class="date-display">
                  <span class="date-primary">{{ issue_detail.closed_on.strftime('%d.%m.%Y') }}</span>
                  <span class="date-time">{{ issue_detail.closed_on.strftime('%H:%M') }}</span>
                </div>
              </div>
            </div>
            {% endif %}

            {% if not issue_detail.closed_on %}
            <div class="separator-sm"></div>
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-history detail-icon"></i>
                <span>Обновлено</span>
              </div>
              <div class="detail-value">
                <div class="date-display">
                  <span class="date-primary">{{issue_detail.updated_on.strftime('%d.%m.%Y')}}</span>
                  <span class="date-time">{{issue_detail.updated_on.strftime('%H:%M')}}</span>
                </div>
                {% if issue_detail.last_updated_by_lastname is defined and issue_detail.last_updated_by_lastname is not none %}
                  <div class="updated-by">{{ issue_detail.last_updated_by_lastname }} {{ issue_detail.last_updated_by_firstname }}</div>
                {% endif %}
              </div>
            </div>
            {% endif %}

            {% if issue_detail.easy_email_to or issue_detail.easy_email_cc %}
            <div class="separator"></div>

            {% if issue_detail.easy_email_to %}
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-envelope detail-icon"></i>
                <span>Email</span>
              </div>
              <div class="detail-value">
                <a href="mailto:{{ issue_detail.easy_email_to }}" class="email-link">
                  {{ issue_detail.easy_email_to }}
                </a>
              </div>
            </div>
            {% endif %}

            {% if issue_detail.easy_email_cc %}
            <div class="separator-sm"></div>
            <div class="detail-item">
              <div class="detail-label">
                <i class="fas fa-envelope-square detail-icon"></i>
                <span>CC</span>
              </div>
              <div class="detail-value">
                <span class="text-muted">{{ issue_detail.easy_email_cc }}</span>
              </div>
            </div>
            {% endif %}
            {% endif %}

          </div>
        </div>
      </div>

    </div>

  </div>
</div>
{% endblock main_page %}

{% block styles %}
<style>
  /* Import Modern Fonts */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

  /* ========================================
     SHADCN-INSPIRED DESIGN SYSTEM
     ======================================== */

  /* CSS Custom Properties - Light Theme */
  :root {
    /* Colors - shadcn inspired */
    --background: 0 0% 100%;
    --foreground: 222.2 84% 4.9%;
    --card: 0 0% 100%;
    --card-foreground: 222.2 84% 4.9%;
    --popover: 0 0% 100%;
    --popover-foreground: 222.2 84% 4.9%;
    --primary: 221.2 83.2% 53.3%;
    --primary-foreground: 210 40% 98%;
    --secondary: 210 40% 96.1%;
    --secondary-foreground: 222.2 47.4% 11.2%;
    --muted: 210 40% 96.1%;
    --muted-foreground: 215.4 16.3% 46.9%;
    --accent: 210 40% 96.1%;
    --accent-foreground: 222.2 47.4% 11.2%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 210 40% 98%;
    --border: 214.3 31.8% 91.4%;
    --input: 214.3 31.8% 91.4%;
    --ring: 221.2 83.2% 53.3%;
    --radius: 0.5rem;

    /* Semantic colors */
    --success: 142.1 76.2% 36.3%;
    --success-foreground: 138.5 76.5% 96.7%;
    --warning: 38 92% 50%;
    --warning-foreground: 48 96% 89%;
    --info: 199 89% 48%;
    --info-foreground: 204 94% 94%;

    /* Spacing */
    --spacing-xs: 0.25rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
    --spacing-2xl: 2.5rem;
    --spacing-3xl: 3rem;

    /* Typography */
    --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    --font-size-xs: 0.75rem;
    --font-size-sm: 0.875rem;
    --font-size-base: 1rem;
    --font-size-lg: 1.125rem;
    --font-size-xl: 1.25rem;
    --font-size-2xl: 1.5rem;
    --font-size-3xl: 1.875rem;
    --font-size-4xl: 2.25rem;

    /* Shadows */
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
    --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);

    /* Transitions */
    --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Base Styles */
  .issue-detail-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: var(--spacing-lg);
    font-family: var(--font-sans);
    background: hsl(var(--background));
    color: hsl(var(--foreground));
    min-height: 100vh;
  }

  /* ========================================
     BREADCRUMB NAVIGATION
     ======================================== */
  .breadcrumb-nav {
    margin-bottom: var(--spacing-lg);
  }

  .breadcrumb-list {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    list-style: none;
    padding: 0;
    margin: 0;
    flex-wrap: wrap;
  }

  .breadcrumb-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
  }

  .breadcrumb-link {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    color: hsl(var(--muted-foreground));
    text-decoration: none;
    font-size: var(--font-size-sm);
    transition: color var(--transition-fast);
  }

  .breadcrumb-link:hover {
    color: hsl(var(--foreground));
  }

  .breadcrumb-item.active {
    color: hsl(var(--foreground));
    font-size: var(--font-size-sm);
    font-weight: 500;
  }

  .breadcrumb-separator {
    color: hsl(var(--muted-foreground));
    font-size: var(--font-size-xs);
  }

  /* ========================================
     CARD COMPONENT
     ======================================== */
  .card {
    background: hsl(var(--card));
    border: 1px solid hsl(var(--border));
    border-radius: var(--radius);
    box-shadow: var(--shadow-sm);
    overflow: hidden;
    transition: box-shadow var(--transition-base);
  }

  .card:hover {
    box-shadow: var(--shadow);
  }

  .card-header {
    padding: var(--spacing-lg);
    border-bottom: 1px solid hsl(var(--border));
    background: hsl(var(--muted) / 0.3);
  }

  .card-title {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: hsl(var(--foreground));
    margin: 0;
  }

  .card-title h2 {
    font-size: var(--font-size-lg);
    font-weight: 600;
    margin: 0;
  }

  .card-icon {
    width: 1.25rem;
    height: 1.25rem;
    color: hsl(var(--primary));
  }

  .card-content {
    padding: var(--spacing-lg);
  }

  .card-sticky {
    position: sticky;
    top: var(--spacing-lg);
  }

  /* Header Card Specific Styles */
  .header-card .card-header {
    background: linear-gradient(135deg, hsl(var(--primary) / 0.05) 0%, hsl(var(--accent)) 100%);
    border-bottom: 2px solid hsl(var(--primary));
  }

  .header-content-wrapper {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--spacing-lg);
  }

  .header-main-content {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-md);
    flex: 1;
  }

  .issue-status-badge-large {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 3.5rem;
    height: 3.5rem;
    background: hsl(var(--primary) / 0.1);
    border-radius: var(--radius);
    flex-shrink: 0;
  }

  .status-icon-lg {
    font-size: 1.75rem;
    color: hsl(var(--primary));
  }

  .header-text-content {
    flex: 1;
  }

  .issue-number-badge {
    display: inline-flex;
    align-items: center;
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: hsl(var(--muted-foreground));
    margin-bottom: var(--spacing-xs);
  }

  .issue-hash {
    opacity: 0.5;
  }

  .issue-title-main {
    font-size: var(--font-size-2xl);
    font-weight: 700;
    color: hsl(var(--foreground));
    margin: 0 0 var(--spacing-sm) 0;
    line-height: 1.3;
  }

  .header-meta-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    flex-wrap: wrap;
  }

  .header-actions-group {
    display: flex;
    gap: var(--spacing-sm);
    flex-shrink: 0;
  }

  /* ========================================
     BADGE COMPONENT
     ======================================== */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: 0.25rem 0.75rem;
    border-radius: calc(var(--radius) - 2px);
    font-size: var(--font-size-xs);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    white-space: nowrap;
    transition: background-color var(--transition-fast);
  }

  .badge-default {
    background: hsl(var(--secondary));
    color: hsl(var(--secondary-foreground));
  }

  .badge-primary {
    background: hsl(var(--primary));
    color: hsl(var(--primary-foreground));
  }

  .badge-secondary {
    background: hsl(var(--muted));
    color: hsl(var(--muted-foreground));
  }

  .badge-success {
    background: hsl(var(--success) / 0.15);
    color: hsl(var(--success));
  }

  .badge-warning {
    background: hsl(var(--warning) / 0.15);
    color: hsl(var(--warning));
  }

  .badge-info {
    background: hsl(var(--info) / 0.15);
    color: hsl(var(--info));
  }

  .badge-destructive {
    background: hsl(var(--destructive) / 0.15);
    color: hsl(var(--destructive));
  }

  .badge-outline {
    background: transparent;
    border: 1px solid hsl(var(--border));
    color: hsl(var(--foreground));
  }

  /* ========================================
     BUTTON COMPONENT
     ======================================== */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-sm);
    padding: 0.5rem 1rem;
    border-radius: var(--radius);
    font-size: var(--font-size-sm);
    font-weight: 500;
    line-height: 1;
    white-space: nowrap;
    border: none;
    cursor: pointer;
    transition: all var(--transition-fast);
    text-decoration: none;
  }

  .btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: var(--font-size-xs);
  }

  .btn-icon {
    padding: 0.5rem;
    width: 2.5rem;
    height: 2.5rem;
  }

  .btn-primary {
    background: hsl(var(--primary));
    color: hsl(var(--primary-foreground));
  }

  .btn-primary:hover:not(:disabled) {
    background: hsl(var(--primary) / 0.9);
  }

  .btn-outline {
    background: transparent;
    border: 1px solid hsl(var(--border));
    color: hsl(var(--foreground));
  }

  .btn-outline:hover:not(:disabled) {
    background: hsl(var(--accent));
  }

  .btn-ghost {
    background: transparent;
    color: hsl(var(--foreground));
  }

  .btn-ghost:hover:not(:disabled) {
    background: hsl(var(--accent));
  }

  .btn-link {
    background: transparent;
    color: hsl(var(--primary));
    padding: 0;
    text-decoration: none;
  }

  .btn-link:hover:not(:disabled) {
    text-decoration: underline;
  }

  /* ========================================
     SEPARATOR COMPONENT
     ======================================== */
  .separator {
    height: 1px;
    background: hsl(var(--border));
    margin: var(--spacing-lg) 0;
  }

  .separator-sm {
    height: 1px;
    background: hsl(var(--border));
    margin: var(--spacing-sm) 0;
  }

  /* ========================================
     LAYOUT GRID
     ======================================== */
  .content-grid {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: var(--spacing-lg);
    margin-top: var(--spacing-lg);
  }

  .main-column {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
  }

  .sidebar-column {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-lg);
  }

  /* ========================================
     PROSE (Description Content)
     ======================================== */
  .prose {
    max-width: 100%;
    line-height: 1.75;
    color: hsl(var(--foreground));
    font-size: var(--font-size-sm);
    max-height: 300px;
    overflow: hidden;
    transition: max-height var(--transition-slow);
  }

  .prose.expanded {
    max-height: none;
  }

  .prose p {
    margin-bottom: var(--spacing-md);
  }

  .prose a {
    color: hsl(var(--primary));
    text-decoration: underline;
  }

  .prose pre {
    background: hsl(var(--muted));
    padding: var(--spacing-md);
    border-radius: var(--radius);
    overflow-x: auto;
  }

  /* ========================================
     ATTACHMENTS
     ======================================== */
  .attachments-grid {
    display: grid;
    gap: var(--spacing-sm);
  }

  .attachment-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    padding: var(--spacing-md);
    background: hsl(var(--muted) / 0.3);
    border: 1px solid hsl(var(--border));
    border-radius: var(--radius);
    transition: all var(--transition-fast);
  }

  .attachment-item:hover {
    background: hsl(var(--muted) / 0.5);
    box-shadow: var(--shadow-sm);
  }

  .attachment-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    border-radius: var(--radius);
    font-size: 1.25rem;
    flex-shrink: 0;
  }

  .attachment-icon.icon-red {
    background: hsl(0 84.2% 60.2% / 0.1);
    color: hsl(0 84.2% 60.2%);
  }

  .attachment-icon.icon-blue {
    background: hsl(221.2 83.2% 53.3% / 0.1);
    color: hsl(221.2 83.2% 53.3%);
  }

  .attachment-icon.icon-green {
    background: hsl(142.1 76.2% 36.3% / 0.1);
    color: hsl(142.1 76.2% 36.3%);
  }

  .attachment-icon.icon-purple {
    background: hsl(262.1 83.3% 57.8% / 0.1);
    color: hsl(262.1 83.3% 57.8%);
  }

  .attachment-icon.icon-orange {
    background: hsl(38 92% 50% / 0.1);
    color: hsl(38 92% 50%);
  }

  .attachment-icon.icon-default {
    background: hsl(var(--muted));
    color: hsl(var(--muted-foreground));
  }

  .attachment-details {
    flex: 1;
    min-width: 0;
  }

  .attachment-name {
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: hsl(var(--foreground));
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 0.25rem;
  }

  .attachment-meta {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    flex-wrap: wrap;
  }

  .meta-item {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: var(--font-size-xs);
    color: hsl(var(--muted-foreground));
  }

  /* ========================================
     TIMELINE
     ======================================== */
  .comment-section {
    margin-bottom: var(--spacing-lg);
  }

  .comment-form {
    margin-top: var(--spacing-md);
    padding: var(--spacing-md);
    background: hsl(var(--muted) / 0.3);
    border: 1px solid hsl(var(--border));
    border-radius: var(--radius);
  }

  .form-group {
    margin-bottom: var(--spacing-md);
  }

  .form-label {
    display: block;
    font-size: var(--font-size-sm);
    font-weight: 500;
    color: hsl(var(--foreground));
    margin-bottom: var(--spacing-sm);
  }

  .form-textarea {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid hsl(var(--border));
    border-radius: var(--radius);
    background: hsl(var(--background));
    color: hsl(var(--foreground));
    font-family: var(--font-sans);
    font-size: var(--font-size-sm);
    resize: vertical;
    transition: border-color var(--transition-fast);
  }

  .form-textarea:focus {
    outline: none;
    border-color: hsl(var(--ring));
    box-shadow: 0 0 0 2px hsl(var(--ring) / 0.2);
  }

  .form-actions {
    display: flex;
    justify-content: flex-end;
    gap: var(--spacing-sm);
  }

  .timeline {
    position: relative;
    padding-left: 2rem;
  }

  .timeline::before {
    content: '';
    position: absolute;
    left: 0.875rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: hsl(var(--border));
  }

  .timeline-item {
    position: relative;
    margin-bottom: var(--spacing-xl);
  }

  .timeline-item:last-child {
    margin-bottom: 0;
  }

  .timeline-marker {
    position: absolute;
    left: -2rem;
    top: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 1.75rem;
    height: 1.75rem;
    border-radius: 50%;
    background: hsl(var(--background));
    border: 2px solid hsl(var(--primary));
    z-index: 1;
  }

  .timeline-marker i {
    font-size: 0.75rem;
    color: hsl(var(--primary));
  }

  .timeline-marker-default {
    border-color: hsl(var(--muted-foreground));
  }

  .timeline-marker-default i {
    color: hsl(var(--muted-foreground));
  }

  .timeline-marker-info {
    border-color: hsl(var(--info));
  }

  .timeline-marker-info i {
    color: hsl(var(--info));
  }

  .timeline-marker-success {
    border-color: hsl(var(--success));
  }

  .timeline-marker-success i {
    color: hsl(var(--success));
  }

  .timeline-marker-warning {
    border-color: hsl(var(--warning));
  }

  .timeline-marker-warning i {
    color: hsl(var(--warning));
  }

  .timeline-marker-destructive {
    border-color: hsl(var(--destructive));
  }

  .timeline-marker-destructive i {
    color: hsl(var(--destructive));
  }

  .timeline-content-card {
    background: hsl(var(--card));
    border: 1px solid hsl(var(--border));
    border-radius: var(--radius);
    padding: var(--spacing-md);
    box-shadow: var(--shadow-sm);
  }

  .timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-sm);
    padding-bottom: var(--spacing-sm);
    border-bottom: 1px solid hsl(var(--border));
  }

  .timeline-user-info {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
  }

  .user-avatar {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    background: hsl(var(--primary) / 0.1);
    color: hsl(var(--primary));
    font-size: var(--font-size-xs);
    font-weight: 600;
    text-transform: uppercase;
  }

  .timeline-user-name {
    font-size: var(--font-size-sm);
    font-weight: 600;
    color: hsl(var(--foreground));
  }

  .timeline-timestamp {
    font-size: var(--font-size-xs);
    color: hsl(var(--muted-foreground));
  }

  .timeline-changes {
    margin-bottom: var(--spacing-sm);
  }

  .change-item {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-sm);
    padding: var(--spacing-xs) 0;
    font-size: var(--font-size-sm);
  }

  .change-icon {
    color: hsl(var(--primary));
    margin-top: 0.25rem;
    flex-shrink: 0;
  }

  .change-description {
    flex: 1;
    color: hsl(var(--foreground));
  }

  .timeline-notes {
    padding: var(--spacing-sm);
    background: hsl(var(--muted) / 0.3);
    border-radius: var(--radius);
    margin-top: var(--spacing-sm);
  }

  .timeline-notes.private {
    background: hsl(var(--destructive) / 0.1);
    border: 1px solid hsl(var(--destructive) / 0.3);
  }

  .private-badge {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    color: hsl(var(--destructive));
    font-size: var(--font-size-sm);
    font-weight: 500;
  }

  .note-content {
    font-size: var(--font-size-sm);
    color: hsl(var(--foreground));
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  /* ========================================
     DETAIL LIST (Sidebar)
     ======================================== */
  .detail-list {
    display: flex;
    flex-direction: column;
  }

  .detail-item {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
  }

  .detail-label {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    font-size: var(--font-size-xs);
    font-weight: 500;
    color: hsl(var(--muted-foreground));
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .detail-icon {
    width: 0.875rem;
    opacity: 0.7;
  }

  .detail-value {
    font-size: var(--font-size-sm);
    color: hsl(var(--foreground));
    font-weight: 500;
  }

  .date-display {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
  }

  .date-primary {
    font-weight: 500;
  }

  .date-time {
    font-size: var(--font-size-xs);
    color: hsl(var(--muted-foreground));
  }

  .updated-by {
    font-size: var(--font-size-xs);
    color: hsl(var(--muted-foreground));
    margin-top: 0.125rem;
  }

  .text-muted {
    color: hsl(var(--muted-foreground));
    font-style: italic;
  }

  .email-link {
    color: hsl(var(--primary));
    text-decoration: none;
    font-size: var(--font-size-sm);
    transition: color var(--transition-fast);
  }

  .email-link:hover {
    text-decoration: underline;
  }

  /* ========================================
     EMPTY STATE
     ======================================== */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-3xl);
    text-align: center;
  }

  .empty-state-icon {
    font-size: 3rem;
    color: hsl(var(--muted-foreground));
    opacity: 0.4;
    margin-bottom: var(--spacing-md);
  }

  .empty-state-title {
    font-size: var(--font-size-lg);
    font-weight: 600;
    color: hsl(var(--foreground));
    margin: 0 0 var(--spacing-xs) 0;
  }

  .empty-state-description {
    font-size: var(--font-size-sm);
    color: hsl(var(--muted-foreground));
    margin: 0;
  }

  /* ========================================
     RESPONSIVE DESIGN
     ======================================== */
  @media (max-width: 1024px) {
    .content-grid {
      grid-template-columns: 1fr;
    }

    .card-sticky {
      position: static;
    }

    .sidebar-column {
      order: -1;
    }
  }

  @media (max-width: 768px) {
    .issue-detail-container {
      padding: var(--spacing-md);
    }

    .header-content-wrapper {
      flex-direction: column;
    }

    .header-actions-group {
      width: 100%;
      justify-content: stretch;
    }

    .header-actions-group .btn {
      flex: 1;
    }

    .issue-title-main {
      font-size: var(--font-size-xl);
    }

    .breadcrumb-link span,
    .btn-text {
      display: none;
    }

    .timeline {
      padding-left: 1.5rem;
    }

    .timeline::before {
      left: 0.625rem;
    }

    .timeline-marker {
      left: -1.5rem;
      width: 1.25rem;
      height: 1.25rem;
    }

    .timeline-marker i {
      font-size: 0.625rem;
    }
  }

  /* ========================================
     PRINT STYLES
     ======================================== */
  @media print {
    .header-actions-group,
    .comment-section,
    .btn {
      display: none !important;
    }

    .issue-detail-container {
      padding: 0;
    }

    .card {
      box-shadow: none;
      page-break-inside: avoid;
    }

    .prose {
      max-height: none !important;
    }
  }

  /* ========================================
     ACCESSIBILITY
     ======================================== */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  // Toggle description expand/collapse
  function toggleDescription() {
    const descriptionText = document.getElementById('descriptionText');
    const toggleButton = document.getElementById('toggleDescriptionBtn');
    const buttonIcon = toggleButton.querySelector('.btn-icon');
    const buttonText = toggleButton.querySelector('.btn-text');

    if (descriptionText.classList.contains('expanded')) {
      descriptionText.classList.remove('expanded');
      buttonText.textContent = 'Показать полностью';
      buttonIcon.style.transform = 'rotate(0deg)';
    } else {
      descriptionText.classList.add('expanded');
      buttonText.textContent = 'Скрыть';
      buttonIcon.style.transform = 'rotate(180deg)';
    }
  }

  // Toggle comment form
  function toggleCommentInput() {
    const commentForm = document.getElementById('commentForm');
    if (commentForm.style.display === 'none' || commentForm.style.display === '') {
      commentForm.style.display = 'block';
    } else {
      commentForm.style.display = 'none';
    }
  }

  // Disable submit button on form submission
  function disableSubmitButton() {
    const submitButton = document.getElementById('submitBtn');
    const icon = submitButton.querySelector('i');
    const text = submitButton.textContent;

    submitButton.disabled = true;
    icon.className = 'fas fa-spinner fa-spin';
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Отправка...';
  }

  // Download attachment
  async function downloadIssueAttachment(attachmentId) {
    const issueId = getIssueIdFromUrl();
    if (!issueId) {
      showNotification('Ошибка: не удалось определить ID заявки', 'error');
      return;
    }

    const downloadBtn = event.target.closest('.btn');
    const originalContent = downloadBtn.innerHTML;
    downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    downloadBtn.disabled = true;

    try {
      const downloadUrl = `/api/issue/${issueId}/attachment/${attachmentId}/download?v=${Date.now()}`;
      const response = await fetch(downloadUrl, {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();

      if (data.success && data.download_url) {
        window.open(data.download_url, '_blank');
        showNotification(`Открывается скачивание файла: ${data.filename}`, 'success');
      } else {
        throw new Error('Не удалось получить URL для скачивания');
      }
    } catch (error) {
      console.error('Ошибка скачивания файла:', error);
      showNotification(`Ошибка скачивания файла: ${error.message}`, 'error');
    } finally {
      setTimeout(() => {
        downloadBtn.innerHTML = originalContent;
        downloadBtn.disabled = false;
      }, 1000);
    }
  }

  // Get issue ID from URL
  function getIssueIdFromUrl() {
    const pathParts = window.location.pathname.split('/');
    const issueIndex = pathParts.indexOf('my-issues');
    if (issueIndex !== -1 && issueIndex + 1 < pathParts.length) {
      const issueId = pathParts[issueIndex + 1];
      if (!isNaN(issueId)) {
        return issueId;
      }
    }
    return null;
  }

  // Show notification
  function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
      <div class="notification-content">
        <span class="notification-message">${message}</span>
        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `;

    if (!document.getElementById('notification-styles')) {
      const style = document.createElement('style');
      style.id = 'notification-styles';
      style.textContent = `
        .notification {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 10000;
          max-width: 400px;
          padding: 1rem;
          border-radius: var(--radius);
          box-shadow: var(--shadow-lg);
          animation: slideInRight 0.3s ease-out;
        }
        .notification-success {
          background: hsl(var(--success) / 0.1);
          border: 1px solid hsl(var(--success));
          color: hsl(var(--success));
        }
        .notification-error {
          background: hsl(var(--destructive) / 0.1);
          border: 1px solid hsl(var(--destructive));
          color: hsl(var(--destructive));
        }
        .notification-info {
          background: hsl(var(--info) / 0.1);
          border: 1px solid hsl(var(--info));
          color: hsl(var(--info));
        }
        .notification-content {
          display: flex;
          align-items: center;
          justify-content: space-between;
          gap: 1rem;
        }
        .notification-close {
          background: none;
          border: none;
          color: inherit;
          cursor: pointer;
          padding: 0.25rem;
        }
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
    }

    document.body.appendChild(notification);

    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, 5000);
  }

  // Optimized back to list navigation
  function goBackToListOptimized() {
    const cacheKey = 'my_issues_data_v2';
    const stateKey = 'my_issues_table_state_v2';
    const cacheTimeKey = 'my_issues_cache_time_v2';
    const cacheExpiry = 10 * 60 * 1000;

    try {
      const currentIssueId = window.location.pathname.match(/\/my-issues\/(\d+)/)?.[1];
      if (currentIssueId) {
        sessionStorage.setItem('return_from_issue_id', currentIssueId);
      }

      const cacheTimestamp = sessionStorage.getItem(cacheTimeKey);
      const now = Date.now();

      if (cacheTimestamp && (now - parseInt(cacheTimestamp)) < cacheExpiry) {
        const urlParams = new URLSearchParams();
        urlParams.set('cached', '1');
        urlParams.set('from_issue', currentIssueId || '');
        window.location.href = `/my-issues?${urlParams.toString()}`;
      } else {
        sessionStorage.removeItem(cacheKey);
        sessionStorage.removeItem(stateKey);
        sessionStorage.removeItem(cacheTimeKey);
        window.location.href = '/my-issues';
      }
    } catch (error) {
      console.error('Ошибка при работе с кешем:', error);
      window.location.href = '/my-issues';
    }
  }
</script>
{% endblock %}
