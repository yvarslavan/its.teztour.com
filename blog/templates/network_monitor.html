{% extends "layout.html" %}
{% block content %}
<style>
    .monitoring-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }

    .status-panel {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
    }

    .status-title {
        font-size: 24px;
        margin-bottom: 20px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .status-cards {
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }

    .status-card {
        flex: 1;
        min-width: 200px;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }

    .status-card.excellent {
        background-color: #d4edda;
        border-left: 4px solid #28a745;
    }

    .status-card.good {
        background-color: #d1ecf1;
        border-left: 4px solid #17a2b8;
    }

    .status-card.average {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
    }

    .status-card.poor {
        background-color: #f8d7da;
        border-left: 4px solid #dc3545;
    }

    .status-card.disconnected {
        background-color: #f5f5f5;
        border-left: 4px solid #6c757d;
    }

    .status-card h3 {
        font-size: 18px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
    }

    .status-indicator.excellent { background-color: #28a745; }
    .status-indicator.good { background-color: #17a2b8; }
    .status-indicator.average { background-color: #ffc107; }
    .status-indicator.poor { background-color: #dc3545; }
    .status-indicator.disconnected { background-color: #6c757d; }

    .status-details {
        font-size: 14px;
        color: #555;
    }

    .ping-time {
        font-size: 24px;
        font-weight: bold;
        margin: 10px 0;
    }

    .status-timestamp {
        font-size: 12px;
        color: #777;
        margin-top: 10px;
    }

    .chart-container {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 20px;
        margin-bottom: 20px;
        height: 400px;
    }

    .chart-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .refresh-button {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 15px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .refresh-button:hover {
        background-color: #0069d9;
    }

    .refresh-button.loading {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .refresh-button i.fa-spin {
        animation: fa-spin 2s infinite linear;
    }

    @keyframes fa-spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .target-selector {
        display: flex;
        gap: 10px;
    }

    .target-button {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 6px 12px;
        cursor: pointer;
    }

    .target-button.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }

    .connection-tips {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 20px;
    }

    .connection-tips h3 {
        margin-bottom: 15px;
        color: #333;
    }

    .tips-list {
        list-style-type: none;
        padding-left: 0;
    }

    .tips-list li {
        padding: 8px 0;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: flex-start;
        gap: 10px;
    }

    .tips-list li:last-child {
        border-bottom: none;
    }

    .tips-list i {
        color: #007bff;
        margin-top: 3px;
    }

    /* Анимация для индикатора пинга */
    @keyframes pulse {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.7; }
        100% { transform: scale(1); opacity: 1; }
    }

    .pulse {
        animation: pulse 1.5s infinite;
    }
</style>

<div class="monitoring-container">
    <div class="status-panel">
        <div class="status-title">
            <i class="fas fa-network-wired"></i>
            <span>Мониторинг соединения с Finesse</span>
        </div>

        <div class="status-cards" id="statusCards">
            <!-- Карточка серверного пинга -->
            <div class="status-card loading" id="serverStatusCard">
                <h3>
                    <i class="fas fa-server"></i> Сервер Helpdesk &rarr; Finesse
                </h3>
                <div class="status-details">
                    <div class="ping-time">Загрузка...</div>
                    <div>Статус: Определение...</div>
                </div>
                <div class="status-timestamp"></div>
            </div>

            <!-- НОВАЯ Карточка клиентского теста -->
            <div class="status-card loading" id="clientStatusCard">
                 <h3>
                     <i class="fas fa-desktop"></i> Ваш браузер &rarr; Finesse
                 </h3>
                 <div class="status-details">
                     <div class="ping-time" id="clientPingTime">Тестирование...</div>
                     <div id="clientStatusText">Статус: Определение...</div>
                 </div>
                 <div class="status-timestamp" id="clientTimestamp"></div>
             </div>

            <!-- НОВАЯ Карточка теста общего интернет-соединения -->
            <div class="status-card loading" id="internetStatusCard">
                <h3>
                    <i class="fas fa-globe"></i> Ваш браузер &rarr; Интернет (Общий доступ)
                </h3>
                <div class="status-details">
                    <div class="ping-time" id="internetPingTime">Тестирование...</div>
                    <div id="internetStatusText">Статус: Определение...</div>
                </div>
                <div class="status-timestamp" id="internetTimestamp"></div>
            </div>
        </div>
    </div>

    <div class="chart-container">
        <div class="chart-controls">
            <div class="target-selector" id="targetSelector">
                {% for target_id, target_name in ping_targets.items() %}
                <button class="target-button {% if target_id == 'finesse' %}active{% endif %}" data-target="{{ target_id }}">
                    {{ target_id|capitalize }}
                </button>
                {% endfor %}
            </div>

            <button id="refreshButton" class="refresh-button">
                <i class="fas fa-sync-alt"></i> Обновить
            </button>
        </div>

        <canvas id="pingChart"></canvas>
    </div>

    <div class="connection-tips">
        <h3><i class="fas fa-lightbulb"></i> Советы по улучшению соединения с Finesse</h3>

        <ul class="tips-list">
            <li>
                <i class="fas fa-wifi"></i>
                <div>
                    <strong>Проверьте Wi-Fi соединение</strong>
                    <p>Убедитесь, что у вас стабильное Wi-Fi соединение. По возможности используйте проводное подключение для большей стабильности.</p>
                </div>
            </li>
            <li>
                <i class="fas fa-lock"></i>
                <div>
                    <strong>Проблемы с активным VPN-соединением</strong>
                    <p>Если VPN Cisco AnyConnect подключен, но вы наблюдаете высокие задержки или периодическую потерю соединения с Finesse, попробуйте переподключить VPN. Это может помочь восстановить стабильность туннеля.</p>
                </div>
            </li>
            <li>
                <i class="fas fa-sync-alt"></i>
                <div>
                    <strong>Перезагрузите сетевое оборудование</strong>
                    <p>Иногда простая перезагрузка роутера или модема может решить проблемы с соединением.</p>
                </div>
            </li>
            <li>
                <i class="fas fa-desktop"></i>
                <div>
                    <strong>Проверьте другие программы</strong>
                    <p>Убедитесь, что у вас нет программ, потребляющих большую часть интернет-трафика, например, загрузок или обновлений.</p>
                </div>
            </li>
            <li>
                <i class="fas fa-shield-alt"></i>
                <div>
                    <strong>Проблемы с SSL-сертификатом</strong>
                    <p>Если вы видите ошибки, связанные с сертификатом (часто отображаются как <code>NET::ERR_CERT_...</code> в консоли браузера), убедитесь, что на вашем компьютере установлены необходимые корпоративные корневые сертификаты. Обратитесь в IT-поддержку для их установки. Иногда проблема может быть в неверной конфигурации сертификата на самом сервере Finesse.</p>
                </div>
            </li>
            <li>
                <i class="fas fa-eraser"></i>
                <div>
                    <strong>Очистка кэша и данных сайта</strong>
                    <p>Попробуйте очистить кэш и файлы cookie для сайта Finesse в настройках вашего браузера. Иногда устаревшие данные могут вызывать проблемы.</p>
                </div>
            </li>
            <li>
                <i class="fas fa-user-secret"></i>
                <div>
                    <strong>Проверка антивируса/файрвола</strong>
                    <p>Временно отключите (с осторожностью!) или настройте ваш антивирус или локальный файрвол, так как они могут блокировать соединение с Finesse.</p>
                </div>
            </li>
            <li>
                <i class="fab fa-chrome"></i> <!-- или fas fa-window-maximize для более общего -->
                <div>
                    <strong>Попробовать другой браузер/режим инкогнито</strong>
                    <p>Проверьте, сохраняется ли проблема в другом браузере или в режиме инкогнито (приватном окне). Это поможет исключить влияние расширений или специфичных настроек браузера.</p>
                </div>
            </li>
        </ul>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Глобальные переменные
    let currentTarget = 'finesse';
    let pingChart = null;
    let updateInterval = null;

    // Функция для получения текущего статуса
    async function fetchStatus() {
        try {
            const response = await fetch('/api/status');
            const data = await response.json();

            if (data.status === 'ok') {
                updateServerStatusCard(data.targets);
            } else {
                console.error('Error fetching status:', data);
            }
        } catch (error) {
            console.error('Failed to fetch status:', error);
            // Отображаем ошибку на карточке серверного пинга, если нужно
            updateServerStatusCard({
                'finesse': { status: 'disconnected', time_ms: -1, timestamp: new Date().toLocaleString(), success: false, error: 'Failed to fetch API' }
            });
        }
    }

    // Функция для получения истории пингов
    async function fetchPingHistory(target = currentTarget) {
        try {
            const response = await fetch(`/api/ping-history?target=${target}&limit=50`);
            const data = await response.json();

            if (data.history) {
                updateChart(data.history);
            } else {
                console.error('Error fetching ping history:', data);
            }
        } catch (error) {
            console.error('Failed to fetch ping history:', error);
        }
    }

    // Функция для обновления статус-карточек
    function updateServerStatusCard(targets) {
        const container = document.getElementById('statusCards');
        // Находим или создаем серверную карточку (на всякий случай)
        let serverCard = document.getElementById('serverStatusCard');
        if (!serverCard) {
            // Пересоздаем структуру, если вдруг ее нет (маловероятно)
            container.innerHTML = `
                <div class="status-card loading" id="serverStatusCard">
                    <h3><i class="fas fa-server"></i> Сервер Helpdesk &rarr; Finesse</h3>
                    <div class="status-details">
                        <div class="ping-time">Загрузка...</div>
                        <div>Статус: Определение...</div>
                    </div>
                    <div class="status-timestamp"></div>
                </div>
                <div class="status-card loading" id="clientStatusCard">...</div>
            `;
             serverCard = document.getElementById('serverStatusCard');
        }

        const serverPingTimeEl = serverCard.querySelector('.ping-time');
        const serverStatusTextEl = serverCard.querySelector('.status-details div:last-child');
        const serverTimestampEl = serverCard.querySelector('.status-timestamp');

        // Используем только данные для 'finesse'
        const targetData = targets['finesse'];
        if (!targetData) {
             console.error("Данные для Finesse не найдены в /api/status");
             serverCard.className = 'status-card disconnected';
             serverPingTimeEl.textContent = 'Ошибка';
             serverStatusTextEl.textContent = 'Статус: Не найдены данные';
             serverTimestampEl.textContent = `Обновлено: ${new Date().toLocaleString()}`;
             return;
         }

        const statusClass = targetData.status;
        const pingTime = targetData.time_ms;

        let statusText = '';
        switch (statusClass) {
            case 'excellent': statusText = 'Отличное'; break;
            case 'good': statusText = 'Хорошее'; break;
            case 'average': statusText = 'Среднее'; break;
            case 'poor': statusText = 'Плохое'; break;
            case 'disconnected': statusText = 'Соединение потеряно'; break;
            default: statusText = 'Неизвестно';
        }

        serverCard.className = `status-card ${statusClass}`;
        serverPingTimeEl.textContent = `${pingTime > 0 ? pingTime + ' мс' : 'Нет связи'}`;
        serverStatusTextEl.textContent = `Статус: ${statusText}`;
        serverTimestampEl.textContent = `Обновлено: ${targetData.timestamp}`;

        // Добавляем пульсацию индикатору при успехе
        const icon = serverCard.querySelector('h3 i');
        if(icon) {
            if (targetData.success) {
                icon.classList.add('pulse');
            } else {
                icon.classList.remove('pulse');
            }
        }
    }

    // Функция для обновления графика
    function updateChart(historyData) {
        const ctx = document.getElementById('pingChart');

        // Подготавливаем данные
        const labels = historyData.map(item => {
            const date = new Date(item.timestamp.replace(' ', 'T'));
            return date.toLocaleTimeString();
        });

        const pingData = historyData.map(item => item.success ? item.time_ms : null);

        // Создаем или обновляем график
        if (pingChart) {
            pingChart.data.labels = labels;
            pingChart.data.datasets[0].data = pingData;
            pingChart.update();
        } else {
            pingChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Время отклика (мс)',
                        data: pingData,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: function(context) {
                            const value = context.dataset.data[context.dataIndex];
                            if (value === null) return '#6c757d';
                            if (value < 100) return '#28a745';
                            if (value < 200) return '#17a2b8';
                            if (value < 500) return '#ffc107';
                            return '#dc3545';
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    return value !== null ? `Пинг: ${value} мс` : 'Соединение потеряно';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Время (мс)'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    }
                }
            });
        }
    }

    // Функция для выполнения клиентского теста (браузер -> Finesse)
    async function performClientTest() {
        const finesseHost = "uccx1.teztour.com"; // Хост Finesse
        const finesseUrl = `https://${finesseHost}`; // URL для теста (используйте https:// если нужно)
        const timeoutMs = 3000; // Таймаут для запроса в мс

        const clientCard = document.getElementById('clientStatusCard');
        const clientPingTimeEl = document.getElementById('clientPingTime');
        const clientStatusTextEl = document.getElementById('clientStatusText');
        const clientTimestampEl = document.getElementById('clientTimestamp');

        // Ставим статус "Тестирование..."
        clientCard.className = 'status-card loading';
        clientPingTimeEl.textContent = 'Тестирование...';
        clientStatusTextEl.textContent = 'Статус: Определение...';
        clientTimestampEl.textContent = '';

        const startTime = performance.now();
        let status = 'disconnected';
        let timeMs = -1;
        let errorMsg = '';
        let cardClass = 'disconnected';
        let statusText = 'Соединение потеряно';

        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

            const response = await fetch(finesseUrl, {
                method: 'HEAD', // Используем HEAD-запрос, чтобы не скачивать тело ответа
                mode: 'no-cors', // 'no-cors' чтобы избежать блокировки CORS, но мы не сможем прочитать ответ
                cache: 'no-cache',
                signal: controller.signal
            });

            clearTimeout(timeoutId);
            const endTime = performance.now();
            timeMs = Math.round(endTime - startTime);

            // При 'no-cors' мы НЕ можем проверить response.ok или response.status
            // Сам факт отсутствия ошибки сети уже говорит о какой-то доступности
            // Это НЕ равноценно успешному HTTP-ответу, но лучше чем ничего при CORS
            status = 'average'; // Осторожно присваиваем 'average', т.к. реальный статус неизвестен
            statusText = 'Доступен (приблизительно)';
            cardClass = 'average';

        } catch (error) {
            const endTime = performance.now();
            timeMs = Math.round(endTime - startTime);
            if (error.name === 'AbortError') {
                errorMsg = `Таймаут (${timeoutMs} мс)`;
                statusText = 'Нет ответа (Таймаут)';
            } else {
                errorMsg = `Ошибка сети или CORS`;
                if (finesseUrl.startsWith('https://') && error instanceof TypeError) {
                    errorMsg += `. Вероятно, проблема с SSL-сертификатом (NET::ERR_CERT_...) или сетевая блокировка. Проверьте консоль браузера (F12).`;
                }
                statusText = 'Нет связи / Ошибка';
                console.error('Client test error:', error);
            }
            status = 'disconnected';
            cardClass = 'disconnected';
        }

        // Обновляем карточку клиента
        clientCard.className = `status-card ${cardClass}`;
        clientPingTimeEl.textContent = `${timeMs} мс (прибл.)`;
        clientStatusTextEl.textContent = `Статус: ${statusText}${errorMsg ? ' - ' + errorMsg : ''}`;
        clientTimestampEl.textContent = `Проверено: ${new Date().toLocaleString()}`;
    }

    // Функция для выполнения теста общего интернет-соединения
    async function performInternetConnectivityTest() {
        const targetHost = "www.cloudflare.com"; // Высокодоступный публичный ресурс
        const targetUrl = `https://${targetHost}`;
        const timeoutMs = 3000;

        const internetCard = document.getElementById('internetStatusCard');
        const internetPingTimeEl = document.getElementById('internetPingTime');
        const internetStatusTextEl = document.getElementById('internetStatusText');
        const internetTimestampEl = document.getElementById('internetTimestamp');

        internetCard.className = 'status-card loading';
        internetPingTimeEl.textContent = 'Тестирование...';
        internetStatusTextEl.textContent = 'Статус: Определение...';
        internetTimestampEl.textContent = '';

        const startTime = performance.now();
        let status = 'disconnected';
        let timeMs = -1;
        let errorMsg = '';
        let cardClass = 'disconnected';
        let statusText = 'Нет интернет-соединения';

        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

            // Используем HEAD запрос, чтобы не скачивать тело, no-cors чтобы избежать CORS блокировки на простом тесте
            await fetch(targetUrl, {
                method: 'HEAD',
                mode: 'no-cors',
                cache: 'no-cache',
                signal: controller.signal
            });

            clearTimeout(timeoutId);
            const endTime = performance.now();
            timeMs = Math.round(endTime - startTime);

            status = 'excellent'; // Если дошли сюда без ошибок, значит есть доступ
            statusText = 'Доступен';
            cardClass = 'excellent';

        } catch (error) {
            const endTime = performance.now();
            timeMs = Math.round(endTime - startTime);
            if (error.name === 'AbortError') {
                errorMsg = `Таймаут (${timeoutMs} мс)`;
            } else {
                errorMsg = `Ошибка сети`;
                console.error('Internet connectivity test error:', error);
            }
            status = 'disconnected';
            cardClass = 'disconnected';
        }

        internetCard.className = `status-card ${cardClass}`;
        internetPingTimeEl.textContent = `${timeMs > 0 ? timeMs + ' мс (прибл.)' : 'N/A'}`;
        internetStatusTextEl.textContent = `Статус: ${statusText}${errorMsg ? ' - ' + errorMsg : ''}`;
        internetTimestampEl.textContent = `Проверено: ${new Date().toLocaleString()}`;
    }

    // Функция для выполнения активного пинга (серверного)
    async function performServerPing() {
        try {
            // Вызываем только API для серверного пинга
            await fetch(`/api/ping?target=${currentTarget}`);
            // Обновляем статус серверной карточки и график
            fetchStatus();
            fetchPingHistory(currentTarget);
        } catch (error) {
            console.error('Failed to perform server ping:', error);
        }
    }

    // Инициализация при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        // Получаем начальные данные для сервера и клиента
        fetchStatus(); // Загрузит статус серверной карточки
        fetchPingHistory(); // Загрузит график
        performClientTest(); // Выполняем первый клиентский тест
        performInternetConnectivityTest(); // Выполняем первый тест общего интернета

        // Настраиваем кнопки выбора цели (оставим, хотя цель одна)
        document.querySelectorAll('.target-button').forEach(button => {
            button.addEventListener('click', function() {
                const target = this.dataset.target;

                // Обновляем активную кнопку
                document.querySelectorAll('.target-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');

                // Обновляем цель и загружаем данные
                currentTarget = target;
                fetchPingHistory(target);
            });
        });

        // Настраиваем кнопку обновления
        const refreshButton = document.getElementById('refreshButton');
        refreshButton.addEventListener('click', function() {
            const icon = this.querySelector('i');

            // Добавляем анимацию и блокируем кнопку
            icon.classList.add('fa-spin');
            this.classList.add('loading');
            this.disabled = true;

            // Выполняем ОБА теста по кнопке
            Promise.allSettled([performServerPing(), performClientTest(), performInternetConnectivityTest()]).finally(() => {
                // Убираем анимацию и разблокируем кнопку
                setTimeout(() => {
                    icon.classList.remove('fa-spin');
                    this.classList.remove('loading');
                    this.disabled = false;
                }, 500);
            });
        });

        // Устанавливаем интервал автоматического обновления (каждые 10 секунд)
        // Обновляем оба показателя
        updateInterval = setInterval(() => {
             performServerPing();
             performClientTest();
             performInternetConnectivityTest();
         }, 10000);
    });

    // Очистка при уходе со страницы
    window.addEventListener('beforeunload', function() {
        if (updateInterval) {
            clearInterval(updateInterval);
        }
    });
</script>
{% endblock %}
