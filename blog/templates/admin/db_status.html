{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-database me-2"></i>
                        Состояние базы данных
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Общий статус -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card border-left-primary">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                                Последняя проверка
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                                {{ health.last_check if health.last_check else 'Не проводилась' }}
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-clock fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-left-warning">
                                <div class="card-body">
                                    <div class="row no-gutters align-items-center">
                                        <div class="col mr-2">
                                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                                Всего ошибок
                                            </div>
                                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                                {{ health.error_statistics.total_errors }}
                                            </div>
                                        </div>
                                        <div class="col-auto">
                                            <i class="fas fa-exclamation-triangle fa-2x text-gray-300"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Статус баз данных -->
                    <div class="row">
                        {% for db_name, db_info in health.databases.items() %}
                        <div class="col-md-6 mb-4">
                            <div class="card {% if db_info.status == 'connected' %}border-left-success{% elif db_info.status == 'failed' %}border-left-danger{% else %}border-left-warning{% endif %}">
                                <div class="card-header">
                                    <h6 class="m-0 font-weight-bold">
                                        {% if db_name == 'quality_db' %}
                                            База данных Quality
                                        {% elif db_name == 'main_db' %}
                                            Основная база данных
                                        {% else %}
                                            {{ db_name }}
                                        {% endif %}
                                        <span class="badge {% if db_info.status == 'connected' %}badge-success{% elif db_info.status == 'failed' %}badge-danger{% else %}badge-warning{% endif %} float-right">
                                            {% if db_info.status == 'connected' %}
                                                <i class="fas fa-check"></i> Подключена
                                            {% elif db_info.status == 'failed' %}
                                                <i class="fas fa-times"></i> Ошибка
                                            {% else %}
                                                <i class="fas fa-question"></i> Неизвестно
                                            {% endif %}
                                        </span>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-sm-6">
                                            <strong>Последнее успешное подключение:</strong><br>
                                            <small class="text-muted">
                                                {{ db_info.last_success if db_info.last_success else 'Нет данных' }}
                                            </small>
                                        </div>
                                        <div class="col-sm-6">
                                            <strong>Последняя ошибка:</strong><br>
                                            <small class="text-muted">
                                                {{ db_info.last_error if db_info.last_error else 'Нет ошибок' }}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-12">
                                            <strong>Время работы без ошибок:</strong><br>
                                            <small class="text-muted">
                                                {% if db_info.uptime > 0 %}
                                                    {{ "%.0f"|format(db_info.uptime / 60) }} минут
                                                {% else %}
                                                    Нет данных
                                                {% endif %}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Детальная статистика ошибок -->
                    {% if health.error_statistics.error_details %}
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="m-0 font-weight-bold text-primary">Детальная статистика ошибок</h6>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Операция</th>
                                                    <th>Количество ошибок</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for operation, count in health.error_statistics.error_details.items() %}
                                                <tr>
                                                    <td>{{ operation }}</td>
                                                    <td>
                                                        <span class="badge badge-danger">{{ count }}</span>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Кнопки управления -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <button type="button" class="btn btn-primary" onclick="refreshStatus()">
                                <i class="fas fa-sync-alt"></i> Обновить статус
                            </button>
                            <button type="button" class="btn btn-info" onclick="testConnections()">
                                <i class="fas fa-plug"></i> Тестировать соединения
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function refreshStatus() {
    location.reload();
}

function testConnections() {
    const btn = event.target;
    const originalText = btn.innerHTML;

    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Тестирование...';
    btn.disabled = true;

    fetch('/check-connection')
        .then(response => response.json())
        .then(data => {
            if (data.connected) {
                Swal.fire({
                    icon: 'success',
                    title: 'Соединения работают',
                    text: 'Все базы данных доступны',
                    timer: 3000
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Проблемы с соединением',
                    text: 'Обнаружены проблемы с подключением к базам данных',
                    timer: 5000
                });
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Ошибка тестирования',
                text: 'Не удалось выполнить тест соединений',
                timer: 5000
            });
        })
        .finally(() => {
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
}

// Автообновление каждые 30 секунд
setInterval(function() {
    fetch('/check-connection')
        .then(response => response.json())
        .then(data => {
            // Обновляем индикаторы статуса без перезагрузки страницы
            console.log('Status updated:', data);
        })
        .catch(error => {
            console.error('Error updating status:', error);
        });
}, 30000);
</script>
{% endblock %}

{% block styles %}
<style>
.border-left-primary {
    border-left: 0.25rem solid #4e73df !important;
}

.border-left-success {
    border-left: 0.25rem solid #1cc88a !important;
}

.border-left-danger {
    border-left: 0.25rem solid #e74a3b !important;
}

.border-left-warning {
    border-left: 0.25rem solid #f6c23e !important;
}

.text-xs {
    font-size: 0.7rem;
}

.text-gray-800 {
    color: #5a5c69 !important;
}

.text-gray-300 {
    color: #dddfeb !important;
}

.card {
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15) !important;
    border: 1px solid #e3e6f0 !important;
}

.badge {
    font-size: 0.75em;
}
</style>
{% endblock %}
