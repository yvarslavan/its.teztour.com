{% extends 'layout.html' %}

{% block content %}
<div class="account-page-wrapper">
  <!-- Background Elements -->
  <div class="background-shapes">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
    <div class="shape shape-4"></div>
  </div>

  <div class="container account-container">
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-content">
        <div class="title-section">
          <div class="icon-wrapper">
            <i class="fas fa-user-cog"></i>
            <div class="icon-glow"></div>
          </div>
          <div class="title-content">
            <h1 class="page-title">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h1>
            <p class="page-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ—Ç–Ω–æ–π –∑–∞–ø–∏—Å—å—é –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</p>
          </div>
          <div class="user-status-container">
            <div class="status-badge online">
              <div class="status-dot"></div>
              <span class="status-text">Online</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Account Content -->
    <form
      method="POST"
      action="{{ url_for('users.account') }}"
      enctype="multipart/form-data"
      class="account-form"
    >
      {{ form.hidden_tag() }}

      <div class="account-grid">
        <!-- Profile Sidebar -->
        <div class="profile-sidebar">
          <div class="profile-card">
            <!-- Avatar Section -->
            <div class="avatar-section">
              <div class="avatar-container">
                <img
                  src="{{ image_file }}"
                  alt="–ê–≤–∞—Ç–∞—Ä {{ user.full_name }}"
                  class="profile-avatar"
                  onerror="this.onerror=null;this.src='{{ url_for('static', filename='profile_pics/default.jpg') }}';"
                />
                <div class="avatar-overlay">
                  <i class="fas fa-camera"></i>
                </div>
                <div class="avatar-glow"></div>
              </div>

              <!-- Avatar Upload -->
              <div class="avatar-upload">
                <label for="pictureUpload" class="upload-label">
                  <i class="fas fa-upload"></i>
                  <span>–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</span>
                </label>
                {{ form.picture(class="upload-input", id="pictureUpload") }}
                {% if form.picture.errors %}
                <div class="upload-errors">
                  {% for error in form.picture.errors %}
                  <span class="error-message">{{ error }}</span>
                  {% endfor %}
                </div>
                {% endif %}
              </div>

              {{ form.submit(class='update-btn') }}
            </div>

            <!-- User Info -->
            <div class="user-info">
              <h3 class="user-name">
                {% set names = user.full_name.split() %} {{ names[0] }} {{
                names[1][:1] }}.{{ names[-1][:1] if names|length > 2 else '' }}.
              </h3>
              <p class="user-role">{{ user.position or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}</p>
              <div class="last-seen">
                <i class="fas fa-clock"></i>
                <span
                  >–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥: {{ user.last_seen.strftime('%d.%m.%Y %H:%M')
                  if user.last_seen else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</span
                >
              </div>
            </div>

            <!-- Navigation -->
            <nav class="profile-navigation">
              <a href="{{ url_for('users.account') }}" class="nav-item active">
                <i class="fas fa-user-circle"></i>
                <span>–î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è</span>
              </a>
              <a
                href="{{ url_for('users.user_posts', username=current_user.username) }}"
                class="nav-item"
              >
                <i class="fas fa-newspaper"></i>
                <span>–ú–æ–∏ —Å—Ç–∞—Ç—å–∏</span>
              </a>
              <a href="/my-issues" class="nav-item">
                <i class="fas fa-ticket-alt"></i>
                <span>–ú–æ–∏ –∑–∞—è–≤–∫–∏</span>
              </a>
              {% if current_user.is_redmine_user %}
              <a href="{{ url_for('tasks.my_tasks_page') }}" class="nav-item">
                <i class="fas fa-tasks"></i>
                <span>–ú–æ–∏ –∑–∞–¥–∞—á–∏</span>
              </a>
              {% endif %}
            </nav>
          </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
          <!-- Personal Information Card -->
          <div class="content-card">
            <div class="card-header">
              <div class="header-icon">
                <i class="fas fa-id-card"></i>
              </div>
              <div class="header-content">
                <h3 class="card-title">–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <p class="card-subtitle">–û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞ –≤ TEZ ERP</p>
              </div>
            </div>

            <div class="card-content">
              <div class="info-grid">
                <div class="info-item">
                  <div class="info-icon">
                    <i class="fas fa-user"></i>
                  </div>
                  <div class="info-content">
                    <span class="info-label">–ü–æ–ª–Ω–æ–µ –∏–º—è</span>
                    <span class="info-value">{{ user.full_name }}</span>
                  </div>
                </div>

                <div class="info-item">
                  <div class="info-icon">
                    <i class="fas fa-envelope"></i>
                  </div>
                  <div class="info-content">
                    <span class="info-label">E-mail</span>
                    <a
                      href="mailto:{{ user.email }}"
                      class="info-value email-link"
                      >{{ user.email }}</a
                    >
                  </div>
                </div>

                <div class="info-item">
                  <div class="info-icon">
                    <i class="fas fa-at"></i>
                  </div>
                  <div class="info-content">
                    <span class="info-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
                    {{ form.username(class='info-input readonly-input',
                    readonly=True) }}
                  </div>
                </div>

                <div class="info-item">
                  <div class="info-icon">
                    <i class="fas fa-phone"></i>
                  </div>
                  <div class="info-content">
                    <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω</span>
                    <span class="info-value"
                      >{{ user.phone or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span
                    >
                  </div>
                </div>

                <div class="info-item">
                  <div class="info-icon">
                    <i class="fas fa-map-marker-alt"></i>
                  </div>
                  <div class="info-content">
                    <span class="info-label">–û—Ñ–∏—Å</span>
                    <span class="info-value"
                      >{{ user.office or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span
                    >
                  </div>
                </div>

                <div class="info-item">
                  <div class="info-icon">
                    <i class="fas fa-building"></i>
                  </div>
                  <div class="info-content">
                    <span class="info-label">–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</span>
                    <span class="info-value"
                      >{{ user.department or '–ù–µ —É–∫–∞–∑–∞–Ω' }}</span
                    >
                  </div>
                </div>

                <div class="info-item">
                  <div class="info-icon">
                    <i class="fas fa-briefcase"></i>
                  </div>
                  <div class="info-content">
                    <span class="info-label">–î–æ–ª–∂–Ω–æ—Å—Ç—å</span>
                    <span class="info-value"
                      >{{ user.position or '–ù–µ —É–∫–∞–∑–∞–Ω–∞' }}</span
                    >
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Settings & Access Card -->
          <div class="content-card">
            <div class="card-header">
              <div class="header-icon">
                <i class="fas fa-shield-alt"></i>
              </div>
              <div class="header-content">
                <h3 class="card-title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –¥–æ—Å—Ç—É–ø—ã</h3>
                <p class="card-subtitle">VPN, –ø–∞—Ä–æ–ª–∏ –∏ –ø–æ–¥–ø–∏—Å–∏</p>
              </div>
            </div>

            <div class="card-content">
              <!-- VPN Status -->
              <div class="settings-item">
                <div class="setting-header">
                  <div class="setting-icon">
                    <i class="fas fa-network-wired"></i>
                  </div>
                  <div class="setting-content">
                    <label for="account-vpn-display" class="setting-label">VPN —Å—Ç–∞—Ç—É—Å</label>
                    <div class="vpn-status-container">
                      <input
                        type="text"
                        id="account-vpn-display"
                        class="vpn-input"
                        placeholder="–°—Ç–∞—Ç—É—Å VPN"
                        title="–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å VPN"
                        {% if user.vpn_end_date %}
                        value="–í–∫–ª—é—á–µ–Ω, –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è {{ user.vpn_end_date }}"
                        {% elif user.vpn == 1 and not user.vpn_end_date %}
                        value="–í–∫–ª—é—á–µ–Ω, –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è &lt;–î–∞—Ç–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞&gt;"
                        {% else %}
                        value="–í—ã–∫–ª—é—á–µ–Ω"
                        {% endif %}
                        readonly
                      />
                      <button
                        type="button"
                        id="update-vpn-date"
                        class="vpn-update-btn"
                        title="–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∞—Ç—É—Å–µ VPN –∏ –¥–∞—Ç–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è"
                        data-tooltip="–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∞—Ç—É—Å–µ VPN –∏ –¥–∞—Ç–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è"
                        aria-label="–û–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∞—Ç—É—Å–µ VPN"
                      >
                        <i class="fas fa-sync-alt"></i>
                      </button>
                    </div>
                    <div
                      class="vpn-badge-container"
                      id="vpn-status-badge-container"
                    >
                      {% if user.vpn == 1 and user.vpn_end_date %}
                      <span class="status-badge active">
                        <i class="fas fa-shield-alt"></i>
                        –í–∫–ª—é—á–µ–Ω
                      </span>
                      <span class="status-info"
                        >–¥–æ {{ user.vpn_end_date }}</span
                      >
                      {% elif user.vpn == 1 and not user.vpn_end_date %}
                      <span class="status-badge warning">
                        <i class="fas fa-shield-alt"></i>
                        –í–∫–ª—é—á–µ–Ω
                      </span>
                      <span class="status-info">—Å—Ä–æ–∫ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω</span>
                      {% else %}
                      <span class="status-badge inactive">
                        <i class="fas fa-shield-alt"></i>
                        –í—ã–∫–ª—é—á–µ–Ω
                      </span>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>

              <!-- ERP Password -->
              <div class="settings-item">
                <div class="setting-header">
                  <div class="setting-icon">
                    <i class="fas fa-key"></i>
                  </div>
                  <div class="setting-content">
                    <label for="password-display" class="setting-label">–ü–∞—Ä–æ–ª—å TEZ ERP</label>
                    <div class="password-container">
                      <input
                        type="password"
                        id="password-display"
                        class="password-input"
                        value="{{ user_password_erp if user_password_erp else '' }}"
                        title="–ü–∞—Ä–æ–ª—å TEZ ERP"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                        readonly
                        />
                        <button
                          type="button"
                          id="togglePassword"
                          class="password-toggle-btn"
                          title="–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å"
                          {% if not user_password_erp %}disabled{% endif %}
                        >
                        <i id="eyeIcon" class="fas fa-eye"></i>
                      </button>
                      <button
                        type="button"
                        id="copyPassword"
                        class="password-copy-btn"
                        {% if not user_password_erp %}disabled{% endif %}
                      >
                        <i class="fas fa-copy"></i>
                        <span>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</span>
                      </button>
                    </div>
                    {% if not user_password_erp %}
                    <div class="password-status">
                      <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        –ü–∞—Ä–æ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É.
                      </small>
                      <button
                        type="button"
                        id="refreshPasswordBtn"
                        class="btn btn-sm btn-outline-primary mt-2"
                      >
                        <i class="fas fa-sync-alt"></i>
                        –û–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–æ–ª—å
                      </button>
                    </div>
                    {% endif %}
                  </div>
                </div>
              </div>

              <!-- Email Signature -->
              <div class="settings-item">
                <div class="setting-header">
                  <div class="setting-icon">
                    <i class="fas fa-signature"></i>
                  </div>
                  <div class="setting-content">
                    <span class="setting-label">Email –ø–æ–¥–ø–∏—Å—å</span>
                    <div class="signature-preview">
                      {{ email_signature_html|safe if email_signature_html else
                      "–ü–æ–¥–ø–∏—Å—å –Ω–µ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∞." }}
                    </div>
                    <button
                      type="button"
                      id="copySignatureBtnAccount"
                      class="signature-copy-btn"
                    >
                      <i class="fas fa-copy"></i>
                      <span>–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å—å</span>
                    </button>
                  </div>
                </div>
              </div>

              <!-- Polling Notifications -->
              <div class="settings-item notifications-system">
                <div class="setting-header">
                  <div class="setting-icon pulse-animation">
                    <i class="fas fa-satellite-dish"></i>
                  </div>
                  <div class="setting-content">
                    <span class="setting-label">üì° –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</span>
                    <div class="notification-controls">
                      <div
                        class="notification-status active-status"
                        id="polling-notification-status"
                      >
                        <div
                          class="status-indicator"
                          id="polling-status-indicator"
                        >
                          <div class="status-badge success-badge">
                            <i
                              id="pollingNotificationIcon"
                              class="fas fa-check-circle"
                            ></i>
                            <span id="pollingNotificationStatus"
                              >–ê–∫—Ç–∏–≤–Ω–∞ (Polling)</span
                            >
                          </div>
                          <div class="connection-indicator">
                            <span class="connection-dot"></span>
                            <span class="connection-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
                          </div>
                        </div>
                        <div
                          class="status-description"
                          id="polling-status-description"
                        >
                          <div class="description-main">
                            –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∫–∞–∂–¥—ã–µ 30
                            —Å–µ–∫—É–Ω–¥
                          </div>
                          <div class="status-details">
                            <span class="detail-item">
                              <i class="fas fa-clock"></i>
                              –ò–Ω—Ç–µ—Ä–≤–∞–ª: 30 —Å–µ–∫
                            </span>
                            <span class="detail-item">
                              <i class="fas fa-volume-up"></i>
                              –ó–≤—É–∫ –≤–∫–ª—é—á–µ–Ω
                            </span>
                            <span class="detail-item">
                              <i class="fas fa-bell"></i>
                              <span id="widget-status-text-detail">–í–∏–¥–∂–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω</span>
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∂–µ—Ç–∞ -->
                    <div class="widget-toggle-control" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(226, 232, 240, 0.8);">
                      <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                          <i class="fas fa-bell" style="color: #2563eb; font-size: 1.125rem;"></i>
                          <div>
                            <div style="font-weight: 600; color: #1e293b; font-size: 0.95rem;">–í–∏–¥–∂–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
                            <div style="font-size: 0.85rem; color: #64748b; margin-top: 0.25rem;">
                              –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–∏–¥–∂–µ—Ç —Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ –≤ –ø—Ä–∞–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É
                            </div>
                          </div>
                        </div>
                        <label class="toggle-switch" for="widgetToggle" style="margin: 0;">
                          <input
                            type="checkbox"
                            id="widgetToggle"
                            {% if current_user.notifications_widget_enabled %}checked{% endif %}
                            aria-label="–í–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å –≤–∏–¥–∂–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
                            title="–í–∫–ª—é—á–∏—Ç—å/–æ—Ç–∫–ª—é—á–∏—Ç—å –≤–∏–¥–∂–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π"
                          />
                          <span class="toggle-slider"></span>
                        </label>
                      </div>
                      <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ —Å—Ç–∏–ª–µ detail-item -->
                      <div class="settings-link-wrapper">
                        <a
                          href="/notifications-polling"
                          target="_blank"
                          class="settings-link-item"
                        >
                          <i class="fas fa-cogs"></i>
                          <span>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Actions Card -->
          <div class="content-card">
            <div class="card-header">
              <div class="header-icon">
                <i class="fas fa-bolt"></i>
              </div>
              <div class="header-content">
                <h3 class="card-title">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
                <p class="card-subtitle">–û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</p>
              </div>
            </div>

            <div class="card-content">
              <div class="actions-grid">
                <button
                  type="button"
                  id="downloadButton"
                  class="action-btn download-btn"
                >
                  <div class="btn-icon">
                    <i class="fas fa-download"></i>
                  </div>
                  <div class="btn-content">
                    <span class="btn-title">–°–∫–∞—á–∞—Ç—å TEZ ERP</span>
                    <span class="btn-description">–ü–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è</span>
                  </div>
                  <div class="btn-ripple"></div>
                </button>

                <button
                  type="button"
                  id="sendPasswordButton"
                  class="action-btn password-btn"
                  data-username="{{ current_user.username }}"
                >
                  <div class="btn-icon">
                    <i class="fas fa-envelope-open-text"></i>
                  </div>
                  <div class="btn-content">
                    <span class="btn-title">–í—ã—Å–ª–∞—Ç—å –ø–∞—Ä–æ–ª—å</span>
                    <span class="btn-description">–ü–æ—á—Ç–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</span>
                  </div>
                  <div class="btn-ripple"></div>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </form>

    <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ - –¥–æ—Å—Ç—É–ø–Ω—ã –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º -->
    <div class="interface-settings-panel">
      <div class="interface-card">
        <div class="card-header">
          <div class="header-icon">
            <i class="fas fa-cogs"></i>
          </div>
          <div class="header-content">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</h3>
            <p>–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏ –ø–æ–¥—Å–∫–∞–∑–æ–∫</p>
          </div>
        </div>

        <div class="card-content">
          <div class="settings-section">
            <div class="section-header">
              <span>–ü–æ–¥—Å–∫–∞–∑–∫–∏ –∏ –ø–æ–º–æ—â—å</span>
            </div>
            <div class="notification-settings">
              <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∫–∞–∑–∞ –±–∞–Ω–Ω–µ—Ä–∞ Kanban -->
              <div class="notification-item">
                <div class="notification-info">
                  <div class="notification-icon">
                    <i class="fas fa-lightbulb"></i>
                  </div>
                  <div class="notification-details">
                    <span class="notification-title">–ü–æ–¥—Å–∫–∞–∑–∫–∏ Kanban</span>
                    <span class="notification-description"
                      >–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–∞–Ω–Ω–µ—Ä —Å –ø–æ–ª–µ–∑–Ω—ã–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                      –∑–∞–¥–∞—á</span
                    >
                  </div>
                </div>
                <div class="notification-toggle">
                  <label class="toggle-switch" for="kanbanTipsToggle" title="–í–∫–ª—é—á–∏—Ç—å –∏–ª–∏ –≤—ã–∫–ª—é—á–∏—Ç—å –ø–æ–¥—Å–∫–∞–∑–∫–∏ Kanban">
                    <input
                      type="checkbox"
                      class="notification-toggle"
                      id="kanbanTipsToggle"
                      data-type="kanban_tips"
                      {% if current_user.show_kanban_tips %}checked{% endif %}
                      aria-label="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–∞–Ω–Ω–µ—Ä —Å –ø–æ–ª–µ–∑–Ω—ã–º–∏ —Å–æ–≤–µ—Ç–∞–º–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∑–∞–¥–∞—á"
                    >
                    <span class="toggle-slider"></span>
                  </label>
                </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin Panel - Moved to bottom -->
    {% if current_user.is_admin %}
    <div class="admin-panel-bottom">
      <div class="admin-card-bottom">
        <div class="card-header accordion-header" id="adminPanelHeader" role="button" tabindex="0" aria-expanded="true" aria-controls="adminPanelContent">
          <div class="header-icon">
            <i class="fas fa-user-shield"></i>
          </div>
          <div class="header-content">
            <h3 class="card-title">–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h3>
            <p class="card-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∞–º–∏ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏</p>
          </div>
          <div class="accordion-icon">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>

        <div class="card-content accordion-content" id="adminPanelContent">
          <div class="admin-sections-grid">
            <!-- –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ -->
            <div class="admin-section">
              <div class="section-header">
                <span>–ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞</span>
              </div>
              <div class="users-list">
                {% for u_admin in all_users %}
                <div class="user-item">
                  <div class="user-info">
                    <span class="user-name">{{ u_admin.username }}</span>
                  </div>
                  <div class="user-toggle">
                    <label class="toggle-switch" for="quality_control_toggle_{{ u_admin.id }}">
                      <input
                        type="checkbox"
                        class="permission-toggle"
                        id="quality_control_toggle_{{ u_admin.id }}"
                        name="quality_control_toggle_{{ u_admin.id }}"
                        data-user-id="{{ u_admin.id }}"
                        data-type="quality_control"
                        aria-label="–î–∞—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ u_admin.username }}"
                        title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∫ –∫–æ–Ω—Ç—Ä–æ–ª—é –∫–∞—á–µ—Å—Ç–≤–∞"
                        {% if u_admin.can_access_quality_control %}checked{% endif %}
                      />
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>

            <!-- –ö–æ–Ω—Ç–∞–∫—Ç-—Ü–µ–Ω—Ç—Ä –ú–æ—Å–∫–≤–∞ -->
            <div class="admin-section">
              <div class="section-header">
                <span>–ö–æ–Ω—Ç–∞–∫—Ç-—Ü–µ–Ω—Ç—Ä –ú–æ—Å–∫–≤–∞</span>
              </div>
              <div class="users-list">
                {% for u_admin in all_users %}
                <div class="user-item">
                  <div class="user-info">
                    <span class="user-name">{{ u_admin.username }}</span>
                  </div>
                  <div class="user-toggle">
                    <label class="toggle-switch" for="contact_center_moscow_toggle_{{ u_admin.id }}">
                      <input
                        type="checkbox"
                        class="permission-toggle"
                        id="contact_center_moscow_toggle_{{ u_admin.id }}"
                        name="contact_center_moscow_toggle_{{ u_admin.id }}"
                        data-user-id="{{ u_admin.id }}"
                        data-type="contact_center_moscow"
                        aria-label="–î–∞—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç-—Ü–µ–Ω—Ç—Ä –ú–æ—Å–∫–≤–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ u_admin.username }}"
                        title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∫ –∫–æ–Ω—Ç–∞–∫—Ç-—Ü–µ–Ω—Ç—Ä—É –ú–æ—Å–∫–≤–∞"
                        {% if u_admin.can_access_contact_center_moscow %}checked{% endif %}
                      />
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>

            <!-- –û—Ç—á—ë—Ç—ã Redmine -->
            <div class="admin-section">
              <div class="section-header">
                <span>–û—Ç—á—ë—Ç—ã Redmine</span>
              </div>
              <div class="users-list">
                {% for u_admin in all_users %}
                <div class="user-item">
                  <div class="user-info">
                    <span class="user-name">{{ u_admin.username }}</span>
                  </div>
                  <div class="user-toggle">
                    <label class="toggle-switch" for="redmine_report_toggle_{{ u_admin.id }}">
                      <input
                        type="checkbox"
                        class="permission-toggle"
                        id="redmine_report_toggle_{{ u_admin.id }}"
                        name="redmine_report_toggle_{{ u_admin.id }}"
                        data-user-id="{{ u_admin.id }}"
                        data-type="redmine_report"
                        aria-label="–î–∞—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ –æ—Ç—á—ë—Ç—ã Redmine –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ u_admin.username }}"
                        title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –∫ –æ—Ç—á—ë—Ç–∞–º Redmine"
                        {% if u_admin.can_access_redmine_report %}checked{% endif %}
                      />
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>

            <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
            <div class="admin-section">
              <div class="section-header">
                <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
              </div>
              <div class="notification-settings">
                <div class="notification-item">
                  <div class="notification-info">
                    <div class="notification-icon">
                      <i class="fas fa-bell"></i>
                    </div>
                    <div class="notification-details">
                      <span class="notification-title">–û –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö</span>
                      <span class="notification-description"
                        >–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö –≤ Redmine</span
                      >
                    </div>
                  </div>
                  <div class="notification-toggle">
                    <label class="toggle-switch" for="newIssuesNotifications">
                      <input
                        type="checkbox"
                        class="notification-toggle"
                        id="newIssuesNotifications"
                        name="newIssuesNotifications"
                        data-type="new_issues_notifications"
                        aria-label="–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö"
                        title="–ü–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–∫–∞—Ö"
                      />
                      <span class="toggle-slider"></span>
                    </label>
                  </div>
                </div>

                <!-- –ü–†–ò–ú–ï–ß–ê–ù–ò–ï: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ "–ü–æ–¥—Å–∫–∞–∑–∫–∏ Kanban" –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ –≤ —Ä–∞–∑–¥–µ–ª "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞" –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block styles %}
<!-- Page-specific overrides (extracted from inline styles) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/account/account_page_overrides.css') }}?v={{ cache_buster or '1' }}">
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // === –ü–†–û–°–¢–û–ô –†–ê–ë–û–ß–ò–ô –°–ö–†–ò–ü–¢ –î–õ–Ø –ò–ö–û–ù–ö–ò –ì–õ–ê–ó–ê ===
    const togglePasswordBtn = document.getElementById("togglePassword");
    const passwordField = document.getElementById("password-display");
    const eyeIcon = document.getElementById("eyeIcon");

    if (togglePasswordBtn && passwordField && eyeIcon) {
      togglePasswordBtn.addEventListener("click", function () {
        if (passwordField.type === "password") {
          passwordField.type = "text";
          eyeIcon.classList.remove("fa-eye");
          eyeIcon.classList.add("fa-eye-slash");
        } else {
          passwordField.type = "password";
          eyeIcon.classList.remove("fa-eye-slash");
          eyeIcon.classList.add("fa-eye");
        }
      });
    }

    // === –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –ü–ê–†–û–õ–Ø ===
    const copyPasswordBtn = document.getElementById('copyPassword');
    if (copyPasswordBtn && passwordField) {
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–æ–ª—å
        if (passwordField.value && passwordField.value.trim() !== '') {
            copyPasswordBtn.disabled = false;
            copyPasswordBtn.classList.remove('disabled');
        } else {
            copyPasswordBtn.disabled = true;
            copyPasswordBtn.classList.add('disabled');
        }

        copyPasswordBtn.addEventListener('click', function() {
            if (passwordField.value && passwordField.value.trim() !== '') {
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(passwordField.value).then(function() {
                        Swal.fire('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!', '–ü–∞—Ä–æ–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞', 'success');
                    }).catch(function(err) {
                        fallbackCopyTextToClipboard(passwordField);
                    });
                } else {
                    fallbackCopyTextToClipboard(passwordField);
                }
            }
        });
    }

    // === –ö–û–ü–ò–†–û–í–ê–ù–ò–ï –ü–û–î–ü–ò–°–ò ===
    const copySignatureBtnAccount = document.getElementById('copySignatureBtnAccount');
    if (copySignatureBtnAccount) {
        copySignatureBtnAccount.addEventListener('click', function () {
            const signaturePreview = document.querySelector('.signature-preview');
            if (signaturePreview) {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = signaturePreview.innerHTML;
                const plainText = signaturePreview.innerText || signaturePreview.textContent;

                navigator.clipboard.write([
                    new ClipboardItem({
                        'text/html': new Blob([tempDiv.innerHTML], { type: 'text/html' }),
                        'text/plain': new Blob([plainText], { type: 'text/plain' })
                    })
                ]).then(function () {
                    const originalText = copySignatureBtnAccount.innerHTML;
                    copySignatureBtnAccount.innerHTML = '<i class="fas fa-check me-2"></i>–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                    setTimeout(() => {
                        copySignatureBtnAccount.innerHTML = originalText;
                    }, 2000);
                }).catch(function (error) {
                    console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∏: ', error);
                    Swal.fire('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–ø–∏—Å—å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.', 'error');
                });
            }
        });
    }

    // === –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: –û–ë–†–ê–ë–û–¢–ö–ê –û–®–ò–ë–û–ö –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ô ===
    // const images = document.querySelectorAll('img');
    // images.forEach(img => {
    //     img.addEventListener('error', function() {
    //         if (!this.src.includes('default.jpg')) {
    //             this.src = "{{ url_for('static', filename='profile_pics/default.jpg') }}";
    //             this.classList.add('avatar-error');
    //         }
    //     });
    // });

    // === –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–û: RIPPLE EFFECT ===
    // const actionBtns = document.querySelectorAll('.action-btn');
    // actionBtns.forEach(btn => {
    //     btn.addEventListener('click', function(e) {
    //         createRipple(e, this);
    //     });
    // });

    // === –ü–†–û–°–¢–û–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö–ù–û–ü–ö–ò –£–í–ï–î–û–ú–õ–ï–ù–ò–ô ===
    console.log("=== –ù–ê–ß–ê–õ–û –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ===");

    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö –ö–ù–û–ü–ö–ò "–°–ö–ê–ß–ê–¢–¨ TEZ ERP" ===
    const downloadButton = document.getElementById("downloadButton");
    if (downloadButton) {
      downloadButton.addEventListener("click", function () {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
        const originalContent = this.innerHTML;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>';
        this.disabled = true;

        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        const link = document.createElement("a");
        link.href = "/download_erp";
        link.download = "TEZERP.exe";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
        setTimeout(() => {
          this.innerHTML = originalContent;
          this.disabled = false;
        }, 2000);
      });
    }
    // === –ö–ù–û–ü–ö–ê "–û–¢–ö–õ–Æ–ß–ò–¢–¨ –í–°–Å" –£–î–ê–õ–ï–ù–ê - –§–£–ù–ö–¶–ò–û–ù–ê–õ –î–£–ë–õ–ò–†–û–í–ê–õ –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –í–ò–î–ñ–ï–¢–ê ===

    // === VPN: –∫–Ω–æ–ø–∫–∞ "–û–±–Ω–æ–≤–∏—Ç—å" ===
    const vpnUpdateBtn = document.getElementById("update-vpn-date");
    const vpnDisplay = document.getElementById("account-vpn-display");
    const vpnBadgeContainer = document.getElementById(
      "vpn-status-badge-container"
    );
    const csrfToken =
      document
        .querySelector('meta[name="csrf-token"]')
        ?.getAttribute("content") || "";

    function renderVpnBadges(vpnEndDate, changed) {
      if (!vpnBadgeContainer) return;
      if (vpnEndDate === null) {
        vpnBadgeContainer.innerHTML = `
                <span class="status-badge inactive">
                    <i class="fas fa-shield-alt"></i>
                    –í—ã–∫–ª—é—á–µ–Ω
                </span>`;
        return;
      }
      const isUndefined =
        typeof vpnEndDate === "string" &&
        vpnEndDate.toLowerCase().includes("–Ω–µ –æ–ø—Ä–µ–¥–µ–ª");
      // –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç ‚Äî –Ω–µ —Ç—Ä–æ–≥–∞–µ–º –∫–ª–∞—Å—Å –±–µ–π–¥–∂–∞, –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç —Å–ø—Ä–∞–≤–∞
      const currentHtml = vpnBadgeContainer.innerHTML;
      let baseBadge = currentHtml.match(
        /<span class=\"status-badge[^>]*>.*?<\/span>/s
      );
      baseBadge = baseBadge
        ? baseBadge[0]
        : `
            <span class="status-badge ${isUndefined ? "warning" : "active"}">
                <i class="fas fa-shield-alt"></i>
                –í–∫–ª—é—á–µ–Ω
            </span>`;

      const infoText = isUndefined ? "—Å—Ä–æ–∫ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω" : `–¥–æ ${vpnEndDate}`;
      vpnBadgeContainer.innerHTML = `${baseBadge}\n<span class="status-info">${infoText}</span>`;
    }

    if (vpnUpdateBtn && vpnDisplay) {
      vpnUpdateBtn.addEventListener("click", async () => {
        const original = vpnUpdateBtn.innerHTML;
        vpnUpdateBtn.disabled = true;
        vpnUpdateBtn.innerHTML =
          '<i class="fas fa-spinner fa-spin"></i><span style="margin-left:6px;">–û–±–Ω–æ–≤–ª—è–µ–º‚Ä¶</span>';
        try {
          const resp = await fetch("/update_vpn_date", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Requested-With": "XMLHttpRequest",
              "X-CSRFToken": csrfToken,
            },
            body: "{}",
          });
          const data = await resp.json();
          const vpnEndDate = "vpn_end_date" in data ? data.vpn_end_date : null;
          if (vpnEndDate === null) {
            vpnDisplay.value = "–í—ã–∫–ª—é—á–µ–Ω";
          } else if (
            typeof vpnEndDate === "string" &&
            vpnEndDate.toLowerCase().includes("–Ω–µ –æ–ø—Ä–µ–¥–µ–ª")
          ) {
            vpnDisplay.value = "–í–∫–ª—é—á–µ–Ω, –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è <–î–∞—Ç–∞ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞>";
          } else {
            vpnDisplay.value = `–í–∫–ª—é—á–µ–Ω, –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è ${vpnEndDate}`;
          }
          renderVpnBadges(vpnEndDate, data.message?.includes("–æ–±–Ω–æ–≤–ª–µ–Ω–∞"));
        } catch (e) {
          console.error("VPN update failed:", e);
        } finally {
          vpnUpdateBtn.disabled = false;
          vpnUpdateBtn.innerHTML = original;
        }
      });
    }
  });

  // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
  function fallbackCopyTextToClipboard(inputElement) {
    const M_IOS =
      typeof navigator !== "undefined" &&
      /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (M_IOS) {
      let range = document.createRange();
      range.selectNodeContents(inputElement);
      let selection = window.getSelection();
      selection.removeAllRanges();
      selection.addRange(range);
      inputElement.setSelectionRange(0, 999999);
    } else {
      inputElement.select();
    }
    try {
      var successful = document.execCommand("copy");
      if (successful) {
        Swal.fire(
          "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!",
          "–ü–∞—Ä–æ–ª—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞",
          "success"
        );
      } else {
        Swal.fire("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å", "error");
      }
    } catch (err) {
      Swal.fire("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å", "error");
    }
    if (M_IOS) {
      window.getSelection().removeAllRanges();
    }
  }

  function createRipple(event, element) {
    const btn = element;
    const ripple = btn.querySelector(".btn-ripple");

    if (!ripple) return;

    const rect = btn.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = event.clientX - rect.left - size / 2;
    const y = event.clientY - rect.top - size / 2;

    ripple.style.width = ripple.style.height = size + "px";
    ripple.style.left = x + "px";
    ripple.style.top = y + "px";
    ripple.style.transform = "scale(0)";
    ripple.style.opacity = "1";

    requestAnimationFrame(() => {
      ripple.style.transform = "scale(2)";
      ripple.style.opacity = "0";
    });

    setTimeout(() => {
      ripple.style.transform = "scale(0)";
      ripple.style.opacity = "0";
    }, 600);
  }

  // === –§–£–ù–ö–¶–ò–Ø toggleNotificationsAndSound –£–î–ê–õ–ï–ù–ê - –ë–´–õ–ê –°–í–Ø–ó–ê–ù–ê –° –ö–ù–û–ü–ö–û–ô "–û–¢–ö–õ–Æ–ß–ò–¢–¨ –í–°–Å" ===

  function updateNotificationUI(enabled) {
    const notificationStatus = document.getElementById(
      "polling-notification-status"
    );
    const notificationIcon = document.getElementById("pollingNotificationIcon");
    const notificationStatusText = document.getElementById(
      "pollingNotificationStatus"
    );
    const statusBadge = document.querySelector(
      "#polling-status-indicator .status-badge"
    );
    const connectionDot = document.querySelector(".connection-dot");
    const connectionText = document.querySelector(".connection-text");
    if (enabled) {
      // –í–∫–ª—é—á–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      notificationStatus.className = "notification-status active-status";
      notificationStatus.setAttribute(
        "style",
        `
                background: #ecfdf5 !important;
                border: 2px solid #10b981 !important;
                color: #10b981 !important;
                padding: 10px !important;
                border-radius: 8px !important;
            `
      );

      if (notificationIcon) notificationIcon.className = "fas fa-check-circle";
      if (notificationStatusText)
        notificationStatusText.textContent = "–ê–∫—Ç–∏–≤–Ω–∞ (Polling)";
      if (statusBadge) {
        statusBadge.setAttribute(
          "style",
          `
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
                    color: white !important;
                `
        );
      }
      if (connectionDot)
        connectionDot.setAttribute(
          "style",
          "background-color: #10b981 !important;"
        );
      if (connectionText)
        connectionText.setAttribute("style", "color: #10b981 !important;");
    } else {
      // –û—Ç–∫–ª—é—á–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      notificationStatus.className = "notification-status inactive-status";
      notificationStatus.setAttribute(
        "style",
        `
                background: #fef2f2 !important;
                border: 2px solid #ef4444 !important;
                color: #ef4444 !important;
                padding: 10px !important;
                border-radius: 8px !important;
            `
      );

      if (notificationIcon) notificationIcon.className = "fas fa-bell-slash";
      if (notificationStatusText)
        notificationStatusText.textContent = "–û—Ç–∫–ª—é—á–µ–Ω–∞";
      if (statusBadge) {
        statusBadge.setAttribute(
          "style",
          `
                    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
                    color: white !important;
                `
        );
      }
      if (connectionDot)
        connectionDot.setAttribute(
          "style",
          "background-color: #ef4444 !important;"
        );
      if (connectionText)
        connectionText.setAttribute("style", "color: #ef4444 !important;");
    }
  }

  function showNotificationWidget() {
    const widget = document.querySelector(".modern-notifications-widget");
    if (widget) {
      widget.style.display = "block";
      widget.style.opacity = "1";
      widget.style.visibility = "visible";
    } else {
      // –ï—Å–ª–∏ –≤–∏–¥–∂–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–º–æ–∂–Ω–æ –æ–Ω –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑-–∑–∞ –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      // –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å –≤–∏–¥–∂–µ—Ç
      console.log("–í–∏–¥–∂–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É...");
      window.location.reload();
    }
  }

  function hideNotificationWidget() {
    const widget = document.querySelector(".modern-notifications-widget");
    if (widget) {
      widget.style.display = "none";
      widget.style.opacity = "0";
      widget.style.visibility = "hidden";
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  function toggleWidget(enabled) {
    console.log("–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞:", enabled);

    fetch("/api/notifications/toggle", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": document.querySelector('meta[name="csrf-token"]')?.getAttribute("content") || "",
      },
      body: JSON.stringify({
        enabled: enabled,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          console.log("–í–∏–¥–∂–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω:", data.enabled);

          // –û–±–Ω–æ–≤–ª—è–µ–º localStorage –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –≤–∏–¥–∂–µ—Ç–æ–º
          localStorage.setItem('notificationsWidgetDisabled', (!data.enabled).toString());

          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
          const statusText = document.getElementById("widget-status-text-detail");
          if (statusText) {
            statusText.textContent = data.enabled ? "–í–∏–¥–∂–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω" : "–í–∏–¥–∂–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω";
          }

          // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∂–µ—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
          if (data.enabled) {
            localStorage.removeItem('notificationsWidgetDisabled');
            showNotificationWidget();
          } else {
            localStorage.setItem('notificationsWidgetDisabled', 'true');
            hideNotificationWidget();
            // –£–≤–µ–¥–æ–º–ª—è–µ–º –≤–∏–¥–∂–µ—Ç –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            if (window.notificationsWidget) {
              window.notificationsWidget.widget.style.display = 'none';
              window.notificationsWidget.widget.classList.add('closed', 'initial-hidden');
              window.notificationsWidget.widget.style.visibility = 'hidden';
              window.notificationsWidget.widget.style.opacity = '0';
            }
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã —É–±—Ä–∞—Ç—å –≤–∏–¥–∂–µ—Ç –∏–∑ DOM
            setTimeout(() => {
              window.location.reload();
            }, 500);
          }

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          if (typeof Swal !== "undefined") {
            Swal.fire({
              icon: data.enabled ? "success" : "info",
              title: data.enabled ? "–í–∏–¥–∂–µ—Ç –≤–∫–ª—é—á–µ–Ω" : "–í–∏–¥–∂–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω",
              text: data.message || (data.enabled ? "–í–∏–¥–∂–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Ç–µ–ø–µ—Ä—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è" : "–í–∏–¥–∂–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–∫—Ä—ã—Ç"),
              timer: 2000,
              showConfirmButton: false,
            });
          }
        } else {
          console.error("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞:", data.error);
          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          const widgetToggle = document.getElementById("widgetToggle");
          if (widgetToggle) {
            widgetToggle.checked = !enabled;
          }

          if (typeof Swal !== "undefined") {
            Swal.fire({
              icon: "error",
              title: "–û—à–∏–±–∫–∞",
              text: data.error || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥–∂–µ—Ç",
              timer: 3000,
            });
          }
        }
      })
      .catch((error) => {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–∞:", error);
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        const widgetToggle = document.getElementById("widgetToggle");
        if (widgetToggle) {
          widgetToggle.checked = !enabled;
        }

        if (typeof Swal !== "undefined") {
          Swal.fire({
            icon: "error",
            title: "–û—à–∏–±–∫–∞",
            text: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –≤–∏–¥–∂–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            timer: 3000,
          });
        }
      });
  }

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  function loadNotificationStatus() {
    fetch("/api/notifications/status")
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          console.log("–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:", data.enabled);

          // –û–±–Ω–æ–≤–ª—è–µ–º UI –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∏–∑ –ë–î
          if (data.enabled) {
            updateNotificationUI(true);
            showNotificationWidget();
          } else {
            updateNotificationUI(false);
            hideNotificationWidget();
          }

          // –û–±–Ω–æ–≤–ª—è–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤–∏–¥–∂–µ—Ç–∞
          const widgetToggle = document.getElementById("widgetToggle");
          if (widgetToggle) {
            widgetToggle.checked = data.enabled;
          }

          // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
          const statusText = document.getElementById("widget-status-text-detail");
          if (statusText) {
            statusText.textContent = data.enabled ? "–í–∏–¥–∂–µ—Ç –∞–∫—Ç–∏–≤–µ–Ω" : "–í–∏–¥–∂–µ—Ç –æ—Ç–∫–ª—é—á–µ–Ω";
          }

        } else {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:", data.error);
        }
      })
      .catch((error) => {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:", error);
      });
  }

  // === –ö–ù–û–ü–ö–ê "–û–¢–ö–õ–Æ–ß–ò–¢–¨ –í–°–Å" –£–î–ê–õ–ï–ù–ê - –§–£–ù–ö–¶–ò–û–ù–ê–õ –î–£–ë–õ–ò–†–û–í–ê–õ –ü–ï–†–ï–ö–õ–Æ–ß–ê–¢–ï–õ–¨ –í–ò–î–ñ–ï–¢–ê ===
  document.addEventListener("DOMContentLoaded", function () {

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è –≤–∏–¥–∂–µ—Ç–∞
    const widgetToggle = document.getElementById("widgetToggle");
    if (widgetToggle) {
      widgetToggle.addEventListener("change", function (e) {
        const enabled = e.target.checked;
        toggleWidget(enabled);
      });
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    loadNotificationStatus();

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ThemeManager –¥–ª—è account —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.accountThemeManager = new AccountThemeManager();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (admin-section –∫–∞—Ä—Ç–æ—á–∫–∏)
    const permissionToggles = document.querySelectorAll('.permission-toggle');
    permissionToggles.forEach(function(toggle) {
      toggle.addEventListener('change', function(e) {
        const userId = this.getAttribute('data-user-id');
        const permissionType = this.getAttribute('data-type');
        const isEnabled = this.checked;

        // –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        const formData = new FormData();
        formData.append('userId', userId);
        formData.append('permissionType', permissionType);
        formData.append('value', isEnabled.toString());

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch('/update_user_permissions', {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '',
          },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('‚úÖ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ:', permissionType, isEnabled);
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            if (typeof Swal !== 'undefined') {
              Swal.fire({
                icon: 'success',
                title: '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ',
                text: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞',
                timer: 1500,
                showConfirmButton: false,
                toast: true,
                position: 'top-end',
              });
            }
          } else {
            console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:', data.message);
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            this.checked = !isEnabled;
            if (typeof Swal !== 'undefined') {
              Swal.fire({
                icon: 'error',
                title: '–û—à–∏–±–∫–∞',
                text: data.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É',
                timer: 3000,
              });
            }
          }
        })
        .catch(error => {
          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error);
          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          this.checked = !isEnabled;
          if (typeof Swal !== 'undefined') {
            Swal.fire({
              icon: 'error',
              title: '–û—à–∏–±–∫–∞',
              text: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.',
              timer: 3000,
            });
          }
        });
      });
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—è Kanban –ø–æ–¥—Å–∫–∞–∑–æ–∫
    const kanbanTipsToggle = document.getElementById("kanbanTipsToggle");
    if (kanbanTipsToggle) {
      kanbanTipsToggle.addEventListener("change", function (e) {
        const isEnabled = e.target.checked;

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        fetch("/api/user/kanban-tips-preference", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": document
              .querySelector("meta[name=csrf-token]")
              ?.getAttribute("content"),
          },
          body: JSON.stringify({
            show_kanban_tips: isEnabled,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log(
                "‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Kanban –ø–æ–¥—Å–∫–∞–∑–æ–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∞:",
                isEnabled
              );

              // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
              window.showKanbanTips = isEnabled;

              // –£–ø—Ä–∞–≤–ª—è–µ–º tooltips –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
              if (isEnabled) {
                // –í–∫–ª—é—á–∞–µ–º tooltips –µ—Å–ª–∏ –æ–Ω–∏ –±—ã–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã
                if (typeof window.enableAllKanbanTooltips === "function") {
                  window.enableAllKanbanTooltips();
                }
              } else {
                // –û—Ç–∫–ª—é—á–∞–µ–º tooltips
                if (typeof window.disableAllKanbanTooltips === "function") {
                  window.disableAllKanbanTooltips();
                }
              }

              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
              const message = isEnabled
                ? "–ë–∞–Ω–Ω–µ—Ä —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∑–∞–¥–∞—á"
                : "–ë–∞–Ω–Ω–µ—Ä —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏ –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è";

              // –ò—Å–ø–æ–ª—å–∑—É–µ–º SweetAlert –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω, –∏–Ω–∞—á–µ –æ–±—ã—á–Ω—ã–π alert
              if (typeof Swal !== "undefined") {
                Swal.fire({
                  icon: "success",
                  title: "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞",
                  text: message,
                  timer: 3000,
                  showConfirmButton: false,
                  toast: true,
                  position: "top-end",
                });
              } else {
                alert(message);
              }
            } else {
              console.error("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:", data.error);
              // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
              e.target.checked = !isEnabled;
              alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
            }
          })
          .catch((error) => {
            console.error("‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:", error);
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            e.target.checked = !isEnabled;
            alert(
              "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É."
            );
          });
      });
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const interfacePanel = document.querySelector(".interface-settings-panel");
    if (interfacePanel) {
      console.log("‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π");
    }

    // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    const pictureUpload = document.getElementById("pictureUpload");
    const profileAvatar = document.querySelector(".profile-avatar");

    if (pictureUpload && profileAvatar) {
      pictureUpload.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Ñ–∞–π–ª–∞
          if (!file.type.startsWith("image/")) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPG –∏–ª–∏ PNG)");
            return;
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (–º–∞–∫—Å–∏–º—É–º 5MB)
          if (file.size > 5 * 1024 * 1024) {
            alert("–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5MB");
            return;
          }

          // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
          const reader = new FileReader();
          reader.onload = function (e) {
            profileAvatar.src = e.target.result;

            // –î–æ–±–∞–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å
            const avatarContainer = document.querySelector(".avatar-container");
            if (avatarContainer) {
              avatarContainer.style.transform = "scale(1.05)";
              setTimeout(() => {
                avatarContainer.style.transform = "scale(1)";
              }, 300);
            }
          };
          reader.readAsDataURL(file);
        }
      });
    }

    // [DEBUG] –û—Ç–ª–∞–¥–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫—Ä–∏–ø—Ç–∞
    console.log("[AccountScript] –°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∂–µ–Ω! –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é...");

    // Admin Panel Accordion Functionality
    const adminPanelHeader = document.getElementById("adminPanelHeader");
    const adminPanelContent = document.getElementById("adminPanelContent");

    if (adminPanelHeader && adminPanelContent) {
      // Toggle accordion on click
      adminPanelHeader.addEventListener("click", function() {
        const isExpanded = adminPanelHeader.getAttribute("aria-expanded") === "true";
        adminPanelHeader.setAttribute("aria-expanded", !isExpanded);
      });

      // Toggle accordion on Enter/Space key press
      adminPanelHeader.addEventListener("keydown", function(e) {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          const isExpanded = adminPanelHeader.getAttribute("aria-expanded") === "true";
          adminPanelHeader.setAttribute("aria-expanded", !isExpanded);
        }
      });
    }
  });

  // === THEME MANAGER –î–õ–Ø ACCOUNT –°–¢–†–ê–ù–ò–¶–´ ===
  class AccountThemeManager {
    constructor() {
      this.themeToggle = document.getElementById("theme-switcher");
      this.handleThemeChange = this.handleThemeChange.bind(this);
      this.init();
    }

    init() {
      const initialTheme = this.getCurrentTheme();
      this.handleThemeChange(initialTheme);

      if (this.themeToggle) {
        this.themeToggle.addEventListener("click", (event) => {
          event.preventDefault();
          if (window.themeManager && typeof window.themeManager.toggleTheme === "function") {
            window.themeManager.toggleTheme();
          } else {
            this.toggleThemeFallback();
          }
        });
      }

      window.addEventListener("themeChanged", (event) => {
        this.handleThemeChange(event.detail.theme);
      });
    }

    getCurrentTheme() {
      if (window.themeManager && typeof window.themeManager.getStoredTheme === "function") {
        return window.themeManager.getStoredTheme();
      }
      return document.documentElement.getAttribute("data-theme") ||
        (document.body.classList.contains("dark-theme") ? "dark" : "light");
    }

    handleThemeChange(theme) {
      this.updateToggleIcon(theme);
    }

    toggleThemeFallback() {
      const html = document.documentElement;
      const nextTheme = html.getAttribute("data-theme") === "dark" ? "light" : "dark";
      html.setAttribute("data-theme", nextTheme);
      document.body.classList.toggle("dark-theme", nextTheme === "dark");
      document.body.classList.toggle("light-theme", nextTheme === "light");
      localStorage.setItem("site-theme", nextTheme);
      this.handleThemeChange(nextTheme);
    }

    updateToggleIcon(theme) {
      if (!this.themeToggle) {
        return;
      }

      this.themeToggle.title =
        theme === "dark" ? "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É" : "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç–µ–º–Ω—É—é —Ç–µ–º—É";
      this.themeToggle.setAttribute(
        "aria-label",
        theme === "dark" ? "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Å–≤–µ—Ç–ª—É—é —Ç–µ–º—É" : "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ —Ç–µ–º–Ω—É—é —Ç–µ–º—É"
      );
    }
  }
</script>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–Ω–æ–ø–∫–∏ "–í—ã—Å–ª–∞—Ç—å –ø–∞—Ä–æ–ª—å" -->
<script src="{{ url_for('static', filename='js/send_password.js') }}"></script>
{% endblock %}

