{% extends 'layout.html' %}

{% block head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block main_page %}
<div class="issue-detail-container">
  <!-- Header Section -->
  <header class="issue-header">
    <div class="header-content">
      <div class="header-main">
        <div class="issue-status-indicator">
          {% set status_class = 'status-default' %}
          {% set status_icon = 'fas fa-question-circle' %}
          {% if issue_detail.status_name in ['Закрыта', 'Closed', 'Resolved'] %}
            {% set status_class = 'status-closed' %}
            {% set status_icon = 'fas fa-check-circle' %}
          {% elif issue_detail.status_name in ['Новая', 'Открыта', 'Open', 'New'] %}
            {% set status_class = 'status-open' %}
            {% set status_icon = 'fas fa-folder-open' %}
          {% elif issue_detail.status_name in ['В работе', 'In Progress'] %}
            {% set status_class = 'status-progress' %}
            {% set status_icon = 'fas fa-clock' %}
          {% elif issue_detail.status_name in ['Отклонена', 'Rejected'] %}
            {% set status_class = 'status-rejected' %}
            {% set status_icon = 'fas fa-times-circle' %}
          {% endif %}
          <i class="{{ status_icon }} status-icon {{ status_class }}"></i>
        </div>
        <div class="header-text">
          <h1 class="issue-title">#{{issue_detail.id}} - {{issue_detail.subject}}</h1>
          <p class="issue-subtitle">Детальная информация о заявке в техническую поддержку</p>
        </div>
      </div>
      <div class="header-actions">
        <a href="#" onclick="goBackToListOptimized(); return false;" class="action-button secondary">
          <i class="fas fa-arrow-left"></i>
          <span>Назад к списку</span>
        </a>
        <button onclick="window.print()" class="action-button secondary">
          <i class="fas fa-print"></i>
          <span>Печать</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="issue-content">

    <!-- Issue Details Section -->
    <section class="content-section">
      <div class="section-header expanded" onclick="toggleSection('details')">
        <div class="section-title">
          <i class="fas fa-info-circle section-icon"></i>
          <h2>Сведения о задаче</h2>
        </div>
        <i class="fas fa-chevron-up toggle-icon" id="details-toggle"></i>
      </div>
      <div class="section-content" id="details-content">
        <div class="details-grid">
          <div class="detail-group">
            <h3 class="group-title">Основная информация</h3>
            <div class="detail-items">
              <div class="detail-item">
                <div class="detail-label">
                  <i class="fas fa-tag detail-icon"></i>
                  <span>Статус</span>
                </div>
                <div class="detail-value">
                  <div class="status-badge {{ status_class }}">
                    <i class="{{ status_icon }}"></i>
                    <span>{{ issue_detail.status_name }}</span>
                  </div>
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-label">
                  <i class="fas fa-exclamation-triangle detail-icon"></i>
                  <span>Приоритет</span>
                </div>
                <div class="detail-value">
                  {% if issue_detail.priority_name in ['Высокий', 'Срочный', 'Неотложный'] %}
                    <div class="priority-badge high">{{ issue_detail.priority_name }}</div>
                  {% else %}
                    <div class="priority-badge normal">{{ issue_detail.priority_name }}</div>
                  {% endif %}
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-label">
                  <i class="fas fa-user detail-icon"></i>
                  <span>Автор</span>
                </div>
                <div class="detail-value">
                  {% if issue_detail.author_lastname is defined and issue_detail.author_lastname is not none %}
                    <div class="user-info">
                      <span class="user-name">{{ issue_detail.author_lastname }} {{ issue_detail.author_firstname }}</span>
                    </div>
                  {% else %}
                    <span class="no-data">Нет данных</span>
                  {% endif %}
                </div>
              </div>

              <div class="detail-item">
                <div class="detail-label">
                  <i class="fas fa-user-cog detail-icon"></i>
                  <span>Исполнитель</span>
                </div>
                <div class="detail-value">
                  {% if issue_detail.assigned_to_lastname is defined and issue_detail.assigned_to_lastname is not none %}
                    <div class="user-info">
                      <span class="user-name">{{ issue_detail.assigned_to_lastname }} {{ issue_detail.assigned_to_firstname }}</span>
                    </div>
                  {% else %}
                    <span class="no-data">Нет данных</span>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <div class="detail-group">
            <h3 class="group-title">Временные рамки</h3>
            <div class="detail-items">
              <div class="detail-item">
                <div class="detail-label">
                  <i class="fas fa-calendar-plus detail-icon"></i>
                  <span>Создана</span>
                </div>
                <div class="detail-value">
                  <div class="date-info">
                    <span class="date-primary">{{issue_detail.created_on.strftime('%d.%m.%Y')}}</span>
                    <span class="date-time">{{issue_detail.created_on.strftime('%H:%M')}}</span>
                  </div>
                </div>
              </div>

              {% if issue_detail.start_date %}
              <div class="detail-item">
                <div class="detail-label">
                  <i class="fas fa-calendar-alt detail-icon"></i>
                  <span>Дата начала</span>
                </div>
                <div class="detail-value">
                  <div class="date-info">
                    <span class="date-primary">{{ issue_detail.start_date.strftime('%d.%m.%Y') }}</span>
                  </div>
                </div>
              </div>
              {% endif %}

              {% if issue_detail.due_date %}
              <div class="detail-item">
                <div class="detail-label">
                  <i class="fas fa-calendar-times detail-icon"></i>
                  <span>Дата окончания</span>
                </div>
                <div class="detail-value">
                  <div class="date-info">
                    <span class="date-primary">{{ issue_detail.due_date.strftime('%d.%m.%Y') }}</span>
                  </div>
                </div>
              </div>
              {% endif %}

              {% if issue_detail.closed_on %}
              <div class="detail-item">
                <div class="detail-label">
                  <i class="fas fa-calendar-check detail-icon"></i>
                  <span>Закрыта</span>
                </div>
                <div class="detail-value">
                  <div class="date-info">
                    <span class="date-primary">{{ issue_detail.closed_on.strftime('%d.%m.%Y') }}</span>
                    <span class="date-time">{{ issue_detail.closed_on.strftime('%H:%M') }}</span>
                  </div>
                </div>
              </div>
              {% endif %}

              {% if not issue_detail.closed_on %}
              <div class="detail-item">
                <div class="detail-label">
                  <i class="fas fa-history detail-icon"></i>
                  <span>Обновлено</span>
                </div>
                <div class="detail-value">
                  <div class="date-info">
                    <span class="date-primary">{{issue_detail.updated_on.strftime('%d.%m.%Y')}}</span>
                    <span class="date-time">{{issue_detail.updated_on.strftime('%H:%M')}}</span>
                  </div>
                  {% if issue_detail.last_updated_by_lastname is defined and issue_detail.last_updated_by_lastname is not none %}
                    <div class="updated-by">{{ issue_detail.last_updated_by_lastname }} {{ issue_detail.last_updated_by_firstname }}</div>
                  {% endif %}
                </div>
              </div>
              {% endif %}
            </div>
          </div>

          {% if issue_detail.easy_email_to or issue_detail.easy_email_cc %}
          <div class="detail-group">
            <h3 class="group-title">Контактная информация</h3>
            <div class="detail-items">
              {% if issue_detail.easy_email_to %}
              <div class="detail-item">
                <div class="detail-label">
                  <i class="fas fa-envelope detail-icon"></i>
                  <span>Отправитель</span>
                </div>
                <div class="detail-value">
                  <a href="mailto:{{ issue_detail.easy_email_to }}" class="email-link">{{ issue_detail.easy_email_to }}</a>
                </div>
              </div>
              {% endif %}

              {% if issue_detail.easy_email_cc %}
              <div class="detail-item">
                <div class="detail-label">
                  <i class="fas fa-envelope-square detail-icon"></i>
                  <span>Копия письма</span>
                </div>
                <div class="detail-value">
                  <span class="email-cc">{{ issue_detail.easy_email_cc }}</span>
                </div>
              </div>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Description Section -->
    <section class="content-section">
      <div class="section-header expanded" onclick="toggleSection('description')">
        <div class="section-title">
          <i class="fas fa-file-alt section-icon"></i>
          <h2>Описание заявки</h2>
        </div>
        <i class="fas fa-chevron-up toggle-icon" id="description-toggle"></i>
      </div>
      <div class="section-content" id="description-content">
        {% if issue_detail.description %}
          <div class="description-content">
            <div class="description-text" id="descriptionText">
              {{ issue_detail.description | safe }}
            </div>
            {% if issue_detail.description and issue_detail.description | length > 300 %}
              <button id="toggleDescriptionBtn" class="read-more-button" onclick="toggleDescription()">
                <i class="fas fa-chevron-down btn-icon"></i>
                <span class="btn-text">Читать далее</span>
              </button>
            {% endif %}
          </div>
        {% else %}
          <div class="empty-state">
            <i class="fas fa-file-alt"></i>
            <h3>Описание отсутствует</h3>
            <p>К этой заявке не добавлено подробное описание</p>
          </div>
        {% endif %}
      </div>
    </section>

    <!-- Attachments Section -->
    <section class="content-section">
      <div class="section-header collapsed" onclick="toggleSection('attachments')">
        <div class="section-title">
          <i class="fas fa-paperclip section-icon"></i>
          <h2>Вложения</h2>
          {% if attachment_list %}
            <span class="section-count">({{ attachment_list | length }})</span>
          {% endif %}
        </div>
        <i class="fas fa-chevron-down toggle-icon" id="attachments-toggle"></i>
      </div>
      <div class="section-content collapsed" id="attachments-content">
        {% if attachment_list %}
          <div class="attachments-grid">
            {% for attachment in attachment_list %}
              {% set filename_lower = attachment.filename.lower() %}
              {% set file_type = 'default' %}
              {% set icon_class = 'fas fa-file-alt' %}
              {% if '.pdf' in filename_lower %}
                {% set file_type = 'pdf' %}
                {% set icon_class = 'fas fa-file-pdf' %}
              {% elif '.doc' in filename_lower or '.docx' in filename_lower %}
                {% set file_type = 'word' %}
                {% set icon_class = 'fas fa-file-word' %}
              {% elif '.xls' in filename_lower or '.xlsx' in filename_lower %}
                {% set file_type = 'excel' %}
                {% set icon_class = 'fas fa-file-excel' %}
              {% elif '.ppt' in filename_lower or '.pptx' in filename_lower %}
                {% set file_type = 'powerpoint' %}
                {% set icon_class = 'fas fa-file-powerpoint' %}
              {% elif '.png' in filename_lower or '.jpg' in filename_lower or '.jpeg' in filename_lower or '.gif' in filename_lower or '.bmp' in filename_lower or '.svg' in filename_lower %}
                {% set file_type = 'image' %}
                {% set icon_class = 'fas fa-file-image' %}
              {% elif '.zip' in filename_lower or '.rar' in filename_lower or '.7z' in filename_lower %}
                {% set file_type = 'archive' %}
                {% set icon_class = 'fas fa-file-archive' %}
              {% elif '.mp3' in filename_lower or '.wav' in filename_lower %}
                {% set file_type = 'audio' %}
                {% set icon_class = 'fas fa-file-audio' %}
              {% elif '.mp4' in filename_lower or '.mov' in filename_lower or '.avi' in filename_lower %}
                {% set file_type = 'video' %}
                {% set icon_class = 'fas fa-file-video' %}
              {% elif '.py' in filename_lower or '.js' in filename_lower or '.html' in filename_lower or '.css' in filename_lower %}
                {% set file_type = 'code' %}
                {% set icon_class = 'fas fa-file-code' %}
              {% endif %}

              <div class="attachment-card {{ file_type }}">
                <div class="attachment-icon">
                  <i class="{{ icon_class }}"></i>
                </div>
                <div class="attachment-info">
                  <h4 class="attachment-name" title="{{ attachment.filename }}">{{ attachment.filename }}</h4>
                  <div class="attachment-meta">
                    <span class="attachment-author">{{ attachment.author if attachment.author else 'Не указан' }}</span>
                    <span class="attachment-date">{{ convert_datetime_msk_format(attachment.created_on) }}</span>
                  </div>
                </div>
                <div class="attachment-actions">
                  <button onclick="downloadIssueAttachment('{{ attachment.id }}')" class="download-button" title="Скачать {{ attachment.filename }}">
                    <i class="fas fa-download"></i>
                  </button>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">
            <i class="fas fa-paperclip"></i>
            <h3>Нет прикрепленных файлов</h3>
            <p>К этой заявке не прикреплены документы</p>
          </div>
        {% endif %}
      </div>
    </section>

    <!-- History Section -->
    <section class="content-section">
      <div class="section-header collapsed" onclick="toggleSection('history')">
        <div class="section-title">
          <i class="fas fa-history section-icon"></i>
          <h2>История задачи</h2>
          {% if issue_history %}
            <span class="section-count">({{ issue_history | length }})</span>
          {% endif %}
        </div>
        <i class="fas fa-chevron-down toggle-icon" id="history-toggle"></i>
      </div>
      <div class="section-content collapsed" id="history-content">
        <div class="comment-section">
          <button class="comment-button" onclick="toggleCommentInput()">
            <i class="fas fa-plus-circle"></i>
            <span>Добавить комментарий</span>
          </button>
          <form id="commentForm" action="" method="POST" enctype="multipart/form-data" class="comment-form">
            {{ form.hidden_tag() }}
            <div class="form-group">
              {{ form.comment.label(class="form-label") }}
              {{ form.comment(class="form-control", rows="4", placeholder="Введите ваш комментарий...") }}
            </div>
            <div class="form-actions">
              <button type="button" onclick="toggleCommentInput()" class="cancel-button">
                <i class="fas fa-times"></i>
                <span>Отмена</span>
              </button>
              <button type="submit" class="submit-button" id="submitBtn" onclick="disableSubmitButton(); this.form.submit();">
                <i class="fas fa-paper-plane"></i>
                <span>Отправить</span>
              </button>
            </div>
          </form>
        </div>

        {% if issue_history %}
          <div class="history-timeline">
            {% for journal_entry in issue_history %}
              <div class="timeline-item">
                {% set marker_class = 'timeline-marker-default' %}
                {% set event_icon = 'fas fa-edit' %}
                {% if journal_entry.notes and journal_entry.private_notes %}
                  {% set event_icon = 'fas fa-lock' %}
                  {% set marker_class = 'timeline-marker-private' %}
                {% elif journal_entry.notes %}
                  {% set event_icon = 'fas fa-comment' %}
                  {% set marker_class = 'timeline-marker-comment' %}
                {% elif journal_entry.details and journal_entry.details | selectattr('name', 'equalto', 'status_id') | list | length > 0 %}
                  {% set event_icon = 'fas fa-flag' %}
                  {% set marker_class = 'timeline-marker-status' %}
                {% elif journal_entry.details and journal_entry.details | selectattr('name', 'equalto', 'assigned_to_id') | list | length > 0 %}
                  {% set event_icon = 'fas fa-user-cog' %}
                  {% set marker_class = 'timeline-marker-assign' %}
                {% elif journal_entry.details and journal_entry.details | selectattr('name', 'equalto', 'priority_id') | list | length > 0 %}
                  {% set event_icon = 'fas fa-exclamation-triangle' %}
                  {% set marker_class = 'timeline-marker-priority' %}
                {% elif journal_entry.details %}
                  {% set event_icon = 'fas fa-edit' %}
                  {% set marker_class = 'timeline-marker-edit' %}
                {% endif %}
                <div class="timeline-marker {{ marker_class }}">
                  <i class="{{ event_icon }}"></i>
                </div>
                <div class="timeline-content">
                  <div class="timeline-header">
                    <div class="timeline-user">{{ journal_entry.user if journal_entry.user else 'Система' }}</div>
                    <div class="timeline-date">{{ convert_datetime_msk_format(journal_entry.created_on) }}</div>
                  </div>

                  {% if journal_entry.details %}
                    <div class="timeline-changes">
                      {% for detail in journal_entry.details %}
                        {% set old_value = detail.get('old_value') %}
                        {% set new_value = detail.get('new_value') %}

                        {# Создаем ключ для поиска предзагруженного описания #}
                        {% set cache_key = detail['property'] + ':' + detail['name'] + ':' + (old_value|string if old_value else '') + ':' + (new_value|string if new_value else '') %}

                        {# Получаем предзагруженное описание #}
                        {% set property_name_html = property_descriptions.get(cache_key) %}

                        {% if property_name_html %}
                          <div class="change-item">
                            <i class="fas fa-arrow-right"></i>
                            <span>{{ property_name_html | safe }}</span>
                          </div>
                        {% endif %}
                      {% endfor %}
                    </div>
                  {% endif %}

                  {% if journal_entry.notes %}
                    <div class="timeline-notes {% if journal_entry.private_notes %}private{% endif %}">
                      {% if journal_entry.private_notes %}
                        <div class="private-note">
                          <i class="fas fa-lock"></i>
                          <span>Комментарий закрыт исполнителем</span>
                        </div>
                      {% else %}
                        <div class="note-content">{{ journal_entry.notes | safe }}</div>
                      {% endif %}
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="empty-state">
            <i class="fas fa-history"></i>
            <h3>История изменений пуста</h3>
            <p>Пока не было внесено изменений в эту заявку</p>
          </div>
        {% endif %}
      </div>
    </section>

  </main>
</div>
{% endblock main_page %}

{% block styles %}
<style>
  /* Import Modern Fonts */
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Roboto:wght@300;400;500;700&display=swap');

  /* CSS Custom Properties */
  :root {
    /* Primary Color Palette */
    --primary-50: #e3f2fd;
    --primary-100: #bbdefb;
    --primary-200: #90caf9;
    --primary-300: #64b5f6;
    --primary-400: #42a5f5;
    --primary-500: #2196f3;
    --primary-600: #1e88e5;
    --primary-700: #1976d2;
    --primary-800: #1565c0;
    --primary-900: #0d47a1;

    /* Secondary Color Palette */
    --secondary-50: #e8f5e8;
    --secondary-100: #c8e6c9;
    --secondary-200: #a5d6a7;
    --secondary-300: #81c784;
    --secondary-400: #66bb6a;
    --secondary-500: #4caf50;
    --secondary-600: #43a047;
    --secondary-700: #388e3c;
    --secondary-800: #2e7d32;
    --secondary-900: #1b5e20;

    /* Status Colors */
    --status-open: #2196f3;
    --status-open-bg: #e3f2fd;
    --status-progress: #ff9800;
    --status-progress-bg: #fff3e0;
    --status-closed: #4caf50;
    --status-closed-bg: #e8f5e8;
    --status-clarification: #9c27b0;
    --status-clarification-bg: #f3e5f5;
    --status-approval: #607d8b;
    --status-approval-bg: #eceff1;
    --status-rejected: #f44336;
    --status-rejected-bg: #ffebee;

    /* Surface Colors */
    --surface-0: #ffffff;
    --surface-1: #f8f9fa;
    --surface-2: #e9ecef;
    --surface-3: #dee2e6;
    --surface-4: #ced4da;
    --surface-5: #adb5bd;

    /* Text Colors */
    --text-primary: #212529;
    --text-secondary: #6c757d;
    --text-muted: #868e96;
    --text-disabled: #adb5bd;
    --text-on-primary: #ffffff;
    --text-on-surface: #212529;

    /* Border & Divider */
    --border-light: #e9ecef;
    --border-medium: #dee2e6;
    --border-dark: #adb5bd;
    --divider: #e9ecef;

    /* Shadows */
    --shadow-1: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
    --shadow-2: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23);
    --shadow-3: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
    --shadow-4: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
    --shadow-5: 0 19px 38px rgba(0,0,0,0.30), 0 15px 12px rgba(0,0,0,0.22);

    /* Spacing System */
    --spacing-xs: 0.25rem;    /* 4px */
    --spacing-sm: 0.5rem;     /* 8px */
    --spacing-md: 1rem;       /* 16px */
    --spacing-lg: 1.5rem;     /* 24px */
    --spacing-xl: 2rem;       /* 32px */
    --spacing-xxl: 3rem;      /* 48px */
    --spacing-xxxl: 4rem;     /* 64px */

    /* Border Radius */
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
    --radius-xxl: 24px;

    /* Transitions */
    --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);

    /* Typography */

    /* ПРИНУДИТЕЛЬНЫЕ СТИЛИ ДЛЯ СВЕТЛОЙ ТЕМЫ - применяются сразу */
    .timeline-content {
      background: #ffffff !important;
      border-color: #e2e8f0 !important;
      color: #1a202c !important;
    }

    .timeline-marker {
      background: #ffffff !important;
      border-color: #3b82f6 !important;
      color: #3b82f6 !important;
    }

    .timeline-user {
      color: #1a202c !important;
      font-weight: 600 !important;
    }

    .timeline-date {
      color: #718096 !important;
    }

    .timeline-changes {
      color: #1a202c !important;
    }

    .change-item {
      color: #4a5568 !important;
    }

    .change-item i {
      color: #3b82f6 !important;
    }

    .timeline-notes {
      background: #f7fafc !important;
      border-color: #e2e8f0 !important;
      color: #1a202c !important;
    }

    .timeline-notes.private {
      background: #fed7d7 !important;
      border-color: #f56565 !important;
    }

    .note-content {
      color: #1a202c !important;
    }

    /* Отключение всех hover эффектов */
    .timeline-content:hover,
    .timeline-marker:hover,
    .timeline-notes:hover,
    .change-item:hover {
      background-color: inherit !important;
      color: inherit !important;
      border-color: inherit !important;
    }
    --font-family-primary: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    --font-family-secondary: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;

    /* Container Widths */
    --container-max-width: 1200px;
    --container-padding: var(--spacing-md);
  }

  /* Base Styles */
  .issue-detail-page-container {
    width: 100%;
    max-width: none;
    margin: 0;
    padding: var(--spacing-md);
    font-family: var(--font-family-primary);
    line-height: 1.6;
    color: var(--text-primary);
    background-color: #f5f7fa;
    min-height: 100vh;
  }

  /* Issue Header */
  .issue-header {
    background: var(--surface-0);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-1);
    margin-bottom: var(--spacing-lg);
    border: 1px solid var(--border-light);
    width: 100%;
  }

  .header-content {
    padding: var(--spacing-lg);
        display: flex;
    justify-content: space-between;
        align-items: center;
    gap: var(--spacing-lg);
  }

  .header-main {
    display: flex;
    align-items: center;
    gap: var(--spacing-md);
    flex: 1;
  }

  .issue-status-indicator {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    border-radius: var(--radius-lg);
    font-size: 1.5rem;
    flex-shrink: 0;
  }

  .status-icon.status-open {
    background: var(--status-open-bg);
    color: var(--status-open);
  }

  .status-icon.status-progress {
    background: var(--status-progress-bg);
    color: var(--status-progress);
  }

  .status-icon.status-closed {
    background: var(--status-closed-bg);
    color: var(--status-closed);
  }

  .status-icon.status-rejected {
    background: var(--status-rejected-bg);
    color: var(--status-rejected);
  }

  .status-icon.status-default {
    background: var(--surface-2);
    color: var(--text-secondary);
  }

  .header-text {
    flex: 1;
  }

  .issue-title {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0 0 var(--spacing-xs) 0;
    color: var(--text-primary);
    line-height: 1.3;
  }

  .issue-subtitle {
    font-size: 0.875rem;
    color: var(--text-secondary);
        margin: 0;
    font-weight: 400;
  }

  .header-actions {
    display: flex;
    gap: var(--spacing-sm);
    align-items: center;
    flex-shrink: 0;
  }

  .action-button {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-md);
    text-decoration: none;
    font-weight: 500;
    font-size: 0.875rem;
    transition: all var(--transition-normal);
    border: 1px solid var(--border-medium);
    cursor: pointer;
    white-space: nowrap;
    /* Добавляем оптимизации для предотвращения мерцания */
    will-change: transform, background-color;
    backface-visibility: hidden;
    transform: translateZ(0);
  }

  .action-button.secondary {
    background: var(--surface-1);
    color: var(--text-primary);
  }

  .action-button.secondary:hover {
    background: var(--surface-2);
    color: var(--text-primary);
    text-decoration: none;
  }

  /* Content Sections */
  .issue-content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
    width: 100%;
  }

  .content-section {
    background: var(--surface-0);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-light);
    box-shadow: var(--shadow-1);
    overflow: hidden;
    width: 100%;
    max-width: none;
  }

  /* Section Headers */
  .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    padding: var(--spacing-md) var(--spacing-lg);
        cursor: pointer;
    border-bottom: 1px solid var(--border-light);
    transition: background-color var(--transition-fast), border-bottom-color var(--transition-fast);
    -webkit-user-select: none;
    user-select: none;
    background: var(--surface-1);
    /* Убираем общий transition: all для предотвращения конфликтов */
  }

  .section-header:hover {
    background: var(--surface-2);
  }

  .section-header.expanded {
    background: var(--primary-50);
    border-bottom-color: var(--primary-200);
  }

  .section-title {
        display: flex;
        align-items: center;
    gap: var(--spacing-sm);
  }

  .section-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: var(--primary-500);
    color: var(--text-on-primary);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
  }

  .section-title h2 {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
    color: var(--text-primary);
  }

  .section-count {
    background: var(--primary-100);
    color: var(--primary-700);
    padding: 2px var(--spacing-xs);
    border-radius: var(--radius-sm);
    font-size: 0.75rem;
    font-weight: 600;
    margin-left: var(--spacing-xs);
  }

  .toggle-icon {
    color: var(--text-secondary);
    transition: transform var(--transition-normal);
    font-size: 0.875rem;
    /* Добавляем will-change для оптимизации производительности */
    will-change: transform;
    /* Предотвращаем мерцание при быстрых изменениях */
    backface-visibility: hidden;
    transform-style: preserve-3d;
  }

  .section-header.expanded .toggle-icon {
        transform: rotate(180deg);
    }

  /* Section Content */
  .section-content {
    padding: var(--spacing-lg);
    transition: all var(--transition-normal);
    width: 100%;
    box-sizing: border-box;
    /* Добавляем оптимизации для предотвращения мерцания */
    will-change: opacity, height;
    backface-visibility: hidden;
    transform: translateZ(0); /* Включаем аппаратное ускорение */
  }

  .section-content.collapsed {
    display: none;
  }

  /* Details Grid */
  .details-grid {
        display: flex;
    flex-direction: column;
    gap: var(--spacing-md);
    width: 100%;
  }

  .detail-group {
    background: var(--surface-1);
    border-radius: var(--radius-md);
    padding: var(--spacing-md);
    border: 1px solid var(--border-light);
    width: 100%;
    box-sizing: border-box;
  }

  .group-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 var(--spacing-md) 0;
    padding-bottom: var(--spacing-xs);
    border-bottom: 2px solid var(--primary-500);
    display: inline-block;
  }

  .detail-items {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--spacing-sm) var(--spacing-lg);
  }

  .detail-item {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: var(--spacing-sm);
    padding: var(--spacing-xs) 0;
  }

  .detail-label {
    display: flex;
    align-items: center;
    gap: var(--spacing-xs);
    min-width: 100px;
    font-weight: 500;
    color: var(--text-secondary);
    font-size: 0.8rem;
  }

  .detail-icon {
    width: 14px;
    text-align: center;
    opacity: 0.7;
    font-size: 0.75rem;
  }

  .detail-value {
    flex: 1;
    text-align: right;
  }

  /* Status Badge */
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-sm);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    white-space: nowrap;
  }

  .status-badge.status-open {
    background: var(--status-open-bg);
    color: var(--status-open);
  }

  .status-badge.status-progress {
    background: var(--status-progress-bg);
    color: var(--status-progress);
  }

  .status-badge.status-closed {
    background: var(--status-closed-bg);
    color: var(--status-closed);
  }

  .status-badge.status-rejected {
    background: var(--status-rejected-bg);
    color: var(--status-rejected);
  }

  .status-badge.status-default {
    background: var(--surface-2);
    color: var(--text-secondary);
  }

  /* Priority Badge */
  .priority-badge {
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-sm);
    font-size: 0.7rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .priority-badge.high {
    background: var(--status-rejected-bg);
    color: var(--status-rejected);
  }

  .priority-badge.normal {
    background: var(--surface-2);
    color: var(--text-secondary);
  }

  /* User Info */
  .user-info {
    text-align: right;
  }

  .user-name {
    font-weight: 500;
    color: var(--text-primary);
    font-size: 0.875rem;
  }

  .no-data {
    color: var(--text-muted);
    font-style: italic;
    font-size: 0.875rem;
  }

  /* Date Info */
  .date-info {
        display: flex;
        flex-direction: column;
    align-items: flex-end;
    gap: 2px;
    }

  .date-primary {
        font-weight: 500;
    color: var(--text-primary);
    font-size: 0.875rem;
  }

  .date-time {
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .updated-by {
    font-size: 0.7rem;
    color: var(--text-muted);
    margin-top: 2px;
  }

  /* Email Link */
  .email-link {
    color: var(--primary-600);
        text-decoration: none;
    font-weight: 500;
    transition: color var(--transition-fast);
    font-size: 0.875rem;
  }

  .email-link:hover {
    color: var(--primary-700);
        text-decoration: underline;
  }

  .email-cc {
    color: var(--text-secondary);
    font-size: 0.875rem;
  }

  /* Attachments Grid */
  .attachments-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: var(--spacing-md);
    width: 100%;
  }

  .attachment-card {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm);
    background: var(--surface-1);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    transition: all var(--transition-normal);
  }

  .attachment-card:hover {
    box-shadow: var(--shadow-2);
    transform: translateY(-1px);
  }

  .attachment-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    border-radius: var(--radius-md);
    font-size: 1rem;
    flex-shrink: 0;
  }

  .attachment-card.pdf .attachment-icon {
    background: rgba(231, 76, 60, 0.1);
    color: #e74c3c;
  }

  .attachment-card.word .attachment-icon {
    background: rgba(52, 152, 219, 0.1);
    color: #3498db;
  }

  .attachment-card.excel .attachment-icon {
    background: rgba(39, 174, 96, 0.1);
    color: #27ae60;
  }

  .attachment-card.image .attachment-icon {
    background: rgba(155, 89, 182, 0.1);
    color: #9b59b6;
  }

  .attachment-card.default .attachment-icon {
    background: var(--surface-2);
    color: var(--text-secondary);
  }

  .attachment-info {
    flex: 1;
    min-width: 0;
  }

  .attachment-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
    margin: 0 0 2px 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    }

    .attachment-meta {
    font-size: 0.7rem;
    color: var(--text-muted);
    display: flex;
    flex-direction: column;
    gap: 1px;
    }

    .attachment-actions {
    flex-shrink: 0;
  }

  .download-button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 32px;
    height: 32px;
    background: var(--primary-500);
    color: var(--text-on-primary);
    border-radius: var(--radius-sm);
        text-decoration: none;
    transition: all var(--transition-fast);
    font-size: 0.875rem;
  }

  .download-button:hover {
    background: var(--primary-600);
    color: var(--text-on-primary);
    text-decoration: none;
  }

  /* Comment Section */
  .comment-section {
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-md);
    border-bottom: 1px solid var(--border-light);
    width: 100%;
  }

  .comment-button {
    display: inline-flex;
        align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    background: var(--primary-500);
    color: var(--text-on-primary);
    border: none;
    border-radius: var(--radius-md);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-normal);
    font-size: 0.875rem;
    /* Добавляем оптимизации для предотвращения мерцания */
    will-change: transform, background-color;
    backface-visibility: hidden;
    transform: translateZ(0);
  }

  .comment-button:hover {
    background: var(--primary-600);
  }

  .comment-form {
    display: none;
    margin-top: var(--spacing-md);
    background: var(--surface-1);
    padding: var(--spacing-md);
    border-radius: var(--radius-md);
    border: 1px solid var(--border-light);
    width: 100%;
    box-sizing: border-box;
    /* Добавляем оптимизации для предотвращения мерцания */
    will-change: opacity, transform;
    backface-visibility: hidden;
    transform: translateZ(0);
  }

  .form-group {
    margin-bottom: var(--spacing-md);
  }

  .form-label {
    display: block;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: var(--spacing-sm);
    font-size: 0.875rem;
  }

  .form-control {
    width: 100%;
    padding: var(--spacing-sm);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-sm);
    background: var(--surface-0);
    color: var(--text-primary);
    font-family: var(--font-family-primary);
    font-size: 0.875rem;
    transition: all var(--transition-fast);
    resize: vertical;
  }

  .form-control:focus {
    outline: none;
    border-color: var(--primary-500);
    box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.1);
  }

  .form-actions {
    display: flex;
    gap: var(--spacing-sm);
    justify-content: flex-end;
  }

  .cancel-button, .submit-button {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    border: none;
    border-radius: var(--radius-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-normal);
    font-size: 0.875rem;
    /* Добавляем оптимизации для предотвращения мерцания */
    will-change: transform, background-color;
    backface-visibility: hidden;
    transform: translateZ(0);
  }

  .cancel-button {
    background: var(--surface-2);
    color: var(--text-secondary);
  }

  .cancel-button:hover {
    background: var(--surface-3);
  }

  .submit-button {
    background: var(--secondary-500);
    color: var(--text-on-primary);
  }

  .submit-button:hover {
    background: var(--secondary-600);
  }

  /* History Timeline */
  .history-timeline {
    position: relative;
    width: 100%;
  }

  .history-timeline::before {
        content: '';
        position: absolute;
    left: 20px;
    top: 0;
    bottom: 0;
        width: 2px;
    background: var(--border-light);
  }

  /* БОЛЕЕ СПЕЦИФИЧНЫЕ СТИЛИ ДЛЯ ПРЕДОТВРАЩЕНИЯ МЕРЦАНИЯ */
  .issue-detail-page-container .timeline-item,
  .issue-detail-page-container .timeline-marker,
  .issue-detail-page-container .timeline-content,
  .issue-detail-page-container .timeline-header,
  .issue-detail-page-container .timeline-user,
  .issue-detail-page-container .timeline-date,
  .issue-detail-page-container .timeline-changes,
  .issue-detail-page-container .timeline-notes,
  .issue-detail-page-container .change-item {
    transition: none !important;
    animation: none !important;
    will-change: auto !important;
    backface-visibility: visible !important;
    isolation: auto !important;
    contain: none !important;
    /* Предотвращаем любые изменения при hover */
    pointer-events: auto !important;
  }

  /* Отключаем hover эффекты для всех timeline элементов */
  .issue-detail-page-container .timeline-item:hover,
  .issue-detail-page-container .timeline-marker:hover,
  .issue-detail-page-container .timeline-content:hover,
  .issue-detail-page-container .timeline-header:hover,
  .issue-detail-page-container .timeline-user:hover,
  .issue-detail-page-container .timeline-date:hover,
  .issue-detail-page-container .timeline-changes:hover,
  .issue-detail-page-container .timeline-notes:hover,
  .issue-detail-page-container .change-item:hover {
    transform: none !important;
    box-shadow: inherit !important;
    background-color: inherit !important;
    border-color: inherit !important;
    color: inherit !important;
  }

  /* Отключаем transition для всех элементов внутри timeline */
  .issue-detail-page-container .timeline-item *,
  .issue-detail-page-container .timeline-content *,
  .issue-detail-page-container .timeline-marker * {
    transition: none !important;
    animation: none !important;
  }

  /* Дополнительная защита от мерцания */
  .issue-detail-page-container .timeline-item *:hover,
  .issue-detail-page-container .timeline-content *:hover,
  .issue-detail-page-container .timeline-marker *:hover {
    transform: none !important;
    background-color: inherit !important;
    border-color: inherit !important;
    color: inherit !important;
  }

  .timeline-item {
    position: relative;
    padding-left: 60px;
    margin-bottom: var(--spacing-xl);
    width: 100%;
    /* Убираем все оптимизации, которые могут вызывать мерцание */
  }

  .timeline-marker {
        position: absolute;
    left: 12px;
    top: 0;
    width: 28px;
    height: 28px;
    background: #ffffff !important;
    border: 3px solid #3b82f6 !important;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    font-size: 0.875rem;
    color: #3b82f6 !important;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    z-index: 1;
    /* Убираем все оптимизации, которые могут вызывать мерцание */
  }

  /* Timeline Marker Colors - простые стили без анимаций */
  .timeline-marker-default {
    border-color: #64b5f6;
    color: #1976d2;
    background: #e3f2fd;
  }

  .timeline-marker-comment {
    border-color: #81c784;
    color: #388e3c;
    background: #e8f5e8;
  }

  .timeline-marker-private {
    border-color: #e57373;
    color: #d32f2f;
    background: #ffebee;
  }

  .timeline-marker-status {
    border-color: #ffb74d;
    color: #f57c00;
    background: #fff3e0;
  }

  .timeline-marker-assign {
    border-color: #ba68c8;
    color: #7b1fa2;
    background: #f3e5f5;
  }

  .timeline-marker-priority {
    border-color: #ff8a65;
    color: #e64a19;
    background: #fbe9e7;
  }

  .timeline-marker-edit {
    border-color: #90a4ae;
    color: #546e7a;
    background: #eceff1;
  }

  .timeline-content {
    background: #ffffff !important;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e2e8f0 !important;
    width: 100%;
    box-sizing: border-box;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    /* Убираем все оптимизации, которые могут вызывать мерцание */
  }

  .timeline-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    border-bottom: 1px solid #e2e8f0 !important;
    padding-bottom: 0.25rem;
  }

  .timeline-user {
        font-weight: 600;
    color: #1a202c !important;
    font-size: 0.875rem;
  }

  .timeline-date {
    font-size: 0.75rem;
    color: #718096 !important;
  }

  .timeline-changes {
    margin-bottom: 0.5rem;
  }

  .change-item {
        display: flex;
        align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0;
    font-size: 0.875rem;
    color: #4a5568 !important;
  }

  .change-item i {
    color: #3b82f6 !important;
    font-size: 0.75rem;
  }

  .timeline-notes {
    background: #f7fafc !important;
    border: 1px solid #e2e8f0 !important;
    border-radius: 6px;
    padding: 0.5rem;
    margin-top: 0.5rem;
  }

  .timeline-notes.private {
    background: #fed7d7 !important;
    border-color: #f56565 !important;
  }

  .private-note {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #e53e3e !important;
    font-weight: 500;
    font-size: 0.875rem;
  }

  .note-content {
    color: #1a202c !important;
    white-space: pre-wrap;
        word-wrap: break-word;
    font-size: 0.875rem;
    line-height: 1.5;
  }

  /* Description Content */
  .description-content {
    background: #f7fafc !important;
    border-radius: 6px;
    padding: 1rem;
    border: 1px solid #e2e8f0 !important;
    width: 100%;
    box-sizing: border-box;
  }

  .description-text {
    color: #1a202c !important;
    line-height: 1.6;
    white-space: pre-wrap;
    word-wrap: break-word;
    max-height: 180px;
    overflow: hidden;
    transition: none !important;
    width: 100%;
  }

  .description-text.expanded {
    max-height: none;
  }

  .read-more-button {
        display: inline-flex;
        align-items: center;
    gap: 0.25rem;
    margin-top: 0.5rem;
    padding: 0.25rem 0.5rem;
    background: transparent;
    border: 1px solid #3b82f6;
    color: #2563eb;
    border-radius: 4px;
    cursor: pointer;
    transition: none !important;
    font-weight: 500;
    font-size: 0.8rem;
    /* Добавляем оптимизации для предотвращения мерцания */
    will-change: auto !important;
    backface-visibility: visible !important;
    transform: none !important;
  }

  .read-more-button:hover {
    background: #eff6ff;
  }

  .btn-icon {
    transition: none !important;
    font-size: 0.7rem;
    /* Добавляем оптимизации для иконки */
    will-change: auto !important;
    backface-visibility: visible !important;
  }

  .read-more-button.expanded .btn-icon {
    transform: rotate(180deg);
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 3rem;
    color: #718096 !important;
    width: 100%;
  }

  .empty-state i {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    opacity: 0.5;
  }

  .empty-state h3 {
    font-size: 1.125rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: #1a202c !important;
  }

  .empty-state p {
    font-size: 0.875rem;
    margin: 0;
  }

  /* Responsive Design */
  @media (max-width: 1024px) {
    .issue-detail-page-container {
      padding: var(--spacing-sm);
    }

    .header-content {
      flex-direction: column;
      text-align: center;
      gap: var(--spacing-md);
    }

    .detail-items {
      grid-template-columns: 1fr;
      gap: var(--spacing-sm);
    }

    .detail-item {
      flex-direction: column;
      align-items: flex-start;
      gap: var(--spacing-xs);
    }

    .detail-value {
      text-align: left;
    }

    .date-info {
      align-items: flex-start;
    }
  }

  @media (max-width: 768px) {
    .issue-title {
      font-size: 1.25rem;
    }

    .attachments-grid {
      grid-template-columns: 1fr;
    }

    .header-actions {
      flex-direction: column;
      width: 100%;
    }

    .action-button {
      justify-content: center;
      width: 100%;
    }

    .form-actions {
      flex-direction: column-reverse;
    }

    .cancel-button, .submit-button {
      width: 100%;
      justify-content: center;
    }

    .timeline-item {
      padding-left: 50px;
    }

    .timeline-marker {
      left: 10px;
      width: 24px;
      height: 24px;
      font-size: 0.75rem;
    }

    .history-timeline::before {
      left: 17px;
    }

    .section-header {
      padding: var(--spacing-sm) var(--spacing-md);
    }

    .section-content {
      padding: var(--spacing-md);
    }

    .detail-items {
      grid-template-columns: 1fr;
    }
  }

  /* Оптимизации для устройств с низкой производительностью */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
  }

  /* Оптимизации для устройств с высоким DPI */
  @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .toggle-icon,
    .btn-icon {
      transform: translateZ(0) scale(1);
    }
  }

  /* Специальные стили для темной темы - предотвращение белых вспышек */
  @media (prefers-color-scheme: dark) {
    .timeline-item {
      background: transparent !important;
    }

    .timeline-content {
      background: #1a202c !important;
      border-color: #4a5568 !important;
      color: #ffffff !important;
    }

    .timeline-marker {
      background: #2d3748 !important;
      border-color: #4a5568 !important;
      color: #ffffff !important;
    }

    .timeline-marker-default {
      background: #2d3748 !important;
      border-color: #4299e1 !important;
      color: #4299e1 !important;
    }

    .timeline-marker-comment {
      background: #2d3748 !important;
      border-color: #48bb78 !important;
      color: #48bb78 !important;
    }

    .timeline-marker-private {
      background: #2d3748 !important;
      border-color: #f56565 !important;
      color: #f56565 !important;
    }

    .timeline-marker-status {
      background: #2d3748 !important;
      border-color: #ed8936 !important;
      color: #ed8936 !important;
    }

    .timeline-marker-assign {
      background: #2d3748 !important;
      border-color: #9f7aea !important;
      color: #9f7aea !important;
    }

    .timeline-marker-priority {
      background: #2d3748 !important;
      border-color: #ed8936 !important;
      color: #ed8936 !important;
    }

    .timeline-marker-edit {
      background: #2d3748 !important;
      border-color: #a0aec0 !important;
      color: #a0aec0 !important;
    }

    .timeline-header {
      border-bottom-color: #4a5568 !important;
    }

    .timeline-user {
      color: #ffffff !important;
      font-weight: 600 !important;
    }

    .timeline-date {
      color: #a0aec0 !important;
    }

    .timeline-changes {
      color: #e2e8f0 !important;
    }

    .timeline-notes {
      background: #2d3748 !important;
      border-color: #4a5568 !important;
      color: #e2e8f0 !important;
    }

    .timeline-notes.private {
      background: #742a2a !important;
      border-color: #f56565 !important;
    }

    .note-content {
      color: #ffffff !important;
    }
  }

  /* ПРИНУДИТЕЛЬНЫЕ СТИЛИ ДЛЯ СВЕТЛОЙ ТЕМЫ - переопределяют темные стили */
  @media (prefers-color-scheme: light) {
    .timeline-content {
      background: #ffffff !important;
      border-color: #e2e8f0 !important;
      color: #1a202c !important;
    }

    .timeline-marker {
      background: #ffffff !important;
      border-color: #3b82f6 !important;
      color: #3b82f6 !important;
    }

    .timeline-marker-default {
      background: #e3f2fd !important;
      border-color: #64b5f6 !important;
      color: #1976d2 !important;
    }

    .timeline-marker-comment {
      background: #e8f5e8 !important;
      border-color: #81c784 !important;
      color: #388e3c !important;
    }

    .timeline-marker-private {
      background: #ffebee !important;
      border-color: #e57373 !important;
      color: #d32f2f !important;
    }

    .timeline-marker-status {
      background: #fff3e0 !important;
      border-color: #ffb74d !important;
      color: #f57c00 !important;
    }

    .timeline-marker-assign {
      background: #f3e5f5 !important;
      border-color: #ba68c8 !important;
      color: #7b1fa2 !important;
    }

    .timeline-marker-priority {
      background: #fbe9e7 !important;
      border-color: #ff8a65 !important;
      color: #e64a19 !important;
    }

    .timeline-marker-edit {
      background: #eceff1 !important;
      border-color: #90a4ae !important;
      color: #546e7a !important;
    }

    .timeline-header {
      border-bottom-color: #e2e8f0 !important;
    }

    .timeline-user {
      color: #1a202c !important;
      font-weight: 600 !important;
    }

    .timeline-date {
      color: #718096 !important;
    }

    .timeline-changes {
      color: #1a202c !important;
    }

    .timeline-notes {
      background: #f7fafc !important;
      border-color: #e2e8f0 !important;
      color: #1a202c !important;
    }

    .timeline-notes.private {
      background: #fed7d7 !important;
      border-color: #f56565 !important;
    }

    .note-content {
      color: #1a202c !important;
    }
  }

  /* ПРИНУДИТЕЛЬНЫЕ СТИЛИ БЕЗ МЕДИА-ЗАПРОСОВ - всегда применяются */
  .timeline-content {
    background: #ffffff !important;
    border-color: #e2e8f0 !important;
    color: #1a202c !important;
  }

  .timeline-marker {
    background: #ffffff !important;
    border-color: #3b82f6 !important;
    color: #3b82f6 !important;
  }

  .timeline-user {
    color: #1a202c !important;
    font-weight: 600 !important;
  }

  .timeline-date {
    color: #718096 !important;
  }

  .timeline-changes {
    color: #1a202c !important;
  }

  .change-item {
    color: #4a5568 !important;
  }

  .change-item i {
    color: #3b82f6 !important;
  }

  .timeline-notes {
    background: #f7fafc !important;
    border-color: #e2e8f0 !important;
    color: #1a202c !important;
  }

  .timeline-notes.private {
    background: #fed7d7 !important;
    border-color: #f56565 !important;
  }

  .note-content {
    color: #1a202c !important;
  }

  /* Дополнительные стили для принудительной темной темы */
  [data-theme="dark"] .timeline-item {
    background: transparent !important;
  }

  [data-theme="dark"] .timeline-content {
    background: #1a202c !important;
    border-color: #4a5568 !important;
    color: #ffffff !important;
  }

  [data-theme="dark"] .timeline-marker {
    background: #2d3748 !important;
    border-color: #4a5568 !important;
    color: #ffffff !important;
  }

  [data-theme="dark"] .timeline-marker-default {
    background: #2d3748 !important;
    border-color: #4299e1 !important;
    color: #4299e1 !important;
  }

  [data-theme="dark"] .timeline-marker-comment {
    background: #2d3748 !important;
    border-color: #48bb78 !important;
    color: #48bb78 !important;
  }

  [data-theme="dark"] .timeline-marker-private {
    background: #2d3748 !important;
    border-color: #f56565 !important;
    color: #f56565 !important;
  }

  [data-theme="dark"] .timeline-marker-status {
    background: #2d3748 !important;
    border-color: #ed8936 !important;
    color: #ed8936 !important;
  }

  [data-theme="dark"] .timeline-marker-assign {
    background: #2d3748 !important;
    border-color: #9f7aea !important;
    color: #9f7aea !important;
  }

  [data-theme="dark"] .timeline-marker-priority {
    background: #2d3748 !important;
    border-color: #ed8936 !important;
    color: #ed8936 !important;
  }

  [data-theme="dark"] .timeline-marker-edit {
    background: #2d3748 !important;
    border-color: #a0aec0 !important;
    color: #a0aec0 !important;
  }

  /* Стили для светлой темы - исправление черных контейнеров */
  .timeline-content {
    background: var(--surface-0) !important;
    border-color: var(--border-light) !important;
    color: var(--text-primary) !important;
  }

  .timeline-marker {
    background: var(--surface-0) !important;
    border-color: var(--primary-500) !important;
    color: var(--primary-500) !important;
  }

  .timeline-marker-default {
    background: #e3f2fd !important;
    border-color: #64b5f6 !important;
    color: #1976d2 !important;
  }

  .timeline-marker-comment {
    background: #e8f5e8 !important;
    border-color: #81c784 !important;
    color: #388e3c !important;
  }

  .timeline-marker-private {
    background: #ffebee !important;
    border-color: #e57373 !important;
    color: #d32f2f !important;
  }

  .timeline-marker-status {
    background: #fff3e0 !important;
    border-color: #ffb74d !important;
    color: #f57c00 !important;
  }

  .timeline-marker-assign {
    background: #f3e5f5 !important;
    border-color: #ba68c8 !important;
    color: #7b1fa2 !important;
  }

  .timeline-marker-priority {
    background: #fbe9e7 !important;
    border-color: #ff8a65 !important;
    color: #e64a19 !important;
  }

  .timeline-marker-edit {
    background: #eceff1 !important;
    border-color: #90a4ae !important;
    color: #546e7a !important;
  }

  /* ИСПРАВЛЕНИЕ КОНТРАСТНОСТИ ТЕКСТА */
  .timeline-user {
    color: var(--text-primary) !important;
    font-weight: 600 !important;
  }

  .timeline-date {
    color: var(--text-secondary) !important;
  }

  .timeline-changes {
    color: var(--text-primary) !important;
  }

  .change-item {
    color: var(--text-primary) !important;
  }

  .change-item i {
    color: var(--primary-500) !important;
  }

  .timeline-notes {
    color: var(--text-primary) !important;
  }

  .note-content {
    color: var(--text-primary) !important;
  }

  /* Print Styles */
  @media print {
    .header-actions,
    .comment-section,
    .read-more-button {
      display: none !important;
    }

    .issue-detail-page-container {
      background: white !important;
    }

    .content-section {
      box-shadow: none !important;
      border: 1px solid #ddd;
      page-break-inside: avoid;
    }

    .section-content.collapsed {
      display: block !important;
    }

    .description-text {
      max-height: none !important;
    }
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  // Добавляем debounce функцию для предотвращения множественных вызовов
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Оптимизированная функция переключения секций
  const toggleSection = debounce(function(sectionId) {
    const content = document.getElementById(sectionId + '-content');
    const header = content.previousElementSibling;
    const toggleIcon = document.getElementById(sectionId + '-toggle');

    if (!content || !header || !toggleIcon) {
      console.warn('Элементы для переключения секции не найдены:', sectionId);
      return;
    }

    // Используем requestAnimationFrame для плавной анимации
    requestAnimationFrame(() => {
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        header.classList.add('expanded');
        header.classList.remove('collapsed');
        toggleIcon.style.transform = 'rotate(180deg)';
      } else {
        content.classList.add('collapsed');
        header.classList.remove('expanded');
        header.classList.add('collapsed');
        toggleIcon.style.transform = 'rotate(0deg)';
      }
    });
  }, 50); // 50ms debounce

  // Оптимизированная функция переключения комментариев
  const toggleCommentInput = debounce(function() {
    const commentForm = document.getElementById("commentForm");
    const commentButton = document.querySelector(".comment-button");

    if (!commentForm || !commentButton) {
      console.warn('Элементы формы комментария не найдены');
      return;
    }

    requestAnimationFrame(() => {
      if (commentForm.style.display === "none" || commentForm.style.display === "") {
        commentForm.style.display = "block";
        commentButton.style.display = "none";
      } else {
        commentForm.style.display = "none";
        commentButton.style.display = "inline-flex";
      }
    });
  }, 50);

  function disableSubmitButton() {
    const submitButton = document.getElementById("submitBtn");
    const icon = submitButton.querySelector('i');
    const text = submitButton.querySelector('span');

    submitButton.disabled = true;
    icon.className = 'fas fa-spinner fa-spin';
    text.textContent = 'Отправка...';
  }

  // Оптимизированная функция переключения описания
  const toggleDescription = debounce(function() {
    const descriptionText = document.getElementById('descriptionText');
    const toggleButton = document.getElementById('toggleDescriptionBtn');

    if (!descriptionText || !toggleButton) {
      console.warn('Элементы описания не найдены');
      return;
    }

    const buttonIcon = toggleButton.querySelector('.btn-icon');
    const buttonText = toggleButton.querySelector('.btn-text');

    requestAnimationFrame(() => {
      if (descriptionText.classList.contains('expanded')) {
        descriptionText.classList.remove('expanded');
        buttonText.textContent = 'Читать далее';
        buttonIcon.style.transform = 'rotate(0deg)';
        toggleButton.classList.remove('expanded');
      } else {
        descriptionText.classList.add('expanded');
        buttonText.textContent = 'Скрыть';
        buttonIcon.style.transform = 'rotate(180deg)';
        toggleButton.classList.add('expanded');
      }
    });
  }, 50);

  // Initialize page
  document.addEventListener('DOMContentLoaded', function() {
    // Auto-expand first and last sections
    const detailsSection = document.getElementById('details-content');
    const descriptionSection = document.getElementById('description-content');

    if (detailsSection) {
      detailsSection.classList.remove('collapsed');
      detailsSection.previousElementSibling.classList.add('expanded');
    }

    if (descriptionSection) {
      descriptionSection.classList.remove('collapsed');
      descriptionSection.previousElementSibling.classList.add('expanded');
    }

    // Добавляем обработчики событий для предотвращения множественных кликов
    const sectionHeaders = document.querySelectorAll('.section-header');
    sectionHeaders.forEach(header => {
      header.addEventListener('click', function(e) {
        // Предотвращаем множественные клики
        if (this.dataset.processing === 'true') {
          e.preventDefault();
          return;
        }

        this.dataset.processing = 'true';
        setTimeout(() => {
          this.dataset.processing = 'false';
        }, 300);
      });
    });

    // Оптимизация для предотвращения мерцания при быстрых кликах
    let isProcessing = false;
    const preventRapidClicks = (e) => {
      if (isProcessing) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      isProcessing = true;
      setTimeout(() => {
        isProcessing = false;
      }, 100);
    };

    // Применяем защиту от быстрых кликов к интерактивным элементам
    const interactiveElements = document.querySelectorAll('.section-header, .comment-button, .read-more-button, .download-button');
    interactiveElements.forEach(element => {
      element.addEventListener('click', preventRapidClicks, { passive: false });
    });

    // Оптимизация для устройств с низкой производительностью
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if (prefersReducedMotion) {
      // Отключаем анимации для пользователей с предпочтением уменьшенного движения
      const style = document.createElement('style');
      style.textContent = `
        * {
          transition-duration: 0.01ms !important;
          animation-duration: 0.01ms !important;
        }
      `;
      document.head.appendChild(style);
    }

    // УБИРАЕМ все обработчики событий для timeline элементов
    // Они могут вызывать мерцание

    // Оптимизация для темной темы - упрощенная версия
    const isDarkTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ||
                       document.documentElement.getAttribute('data-theme') === 'dark';

    if (isDarkTheme) {
      // Принудительно устанавливаем темные стили для timeline элементов
      const darkStyle = document.createElement('style');
      darkStyle.textContent = `
        .timeline-item {
          background: transparent !important;
        }
        .timeline-content {
          background: #1a202c !important;
          border-color: #4a5568 !important;
          color: #ffffff !important;
        }
        .timeline-marker {
          background: #2d3748 !important;
          border-color: #4a5568 !important;
          color: #ffffff !important;
        }
        .timeline-user {
          color: #ffffff !important;
          font-weight: 600 !important;
        }
        .timeline-date {
          color: #a0aec0 !important;
        }
        .timeline-changes {
          color: #e2e8f0 !important;
        }
        .change-item {
          color: #e2e8f0 !important;
        }
        .change-item i {
          color: #4299e1 !important;
        }
        .timeline-notes {
          background: #2d3748 !important;
          border-color: #4a5568 !important;
          color: #e2e8f0 !important;
        }
        .timeline-notes.private {
          background: #742a2a !important;
          border-color: #f56565 !important;
        }
        .note-content {
          color: #ffffff !important;
        }
      `;
      document.head.appendChild(darkStyle);
    } else {
      // Принудительно устанавливаем светлые стили для timeline элементов
      const lightStyle = document.createElement('style');
      lightStyle.textContent = `
        /* ПРИНУДИТЕЛЬНЫЕ СВЕТЛЫЕ СТИЛИ - переопределяют все темные стили */
        .timeline-content {
          background: #ffffff !important;
          border-color: #e2e8f0 !important;
          color: #1a202c !important;
        }
        .timeline-marker {
          background: #ffffff !important;
          border-color: #3b82f6 !important;
          color: #3b82f6 !important;
        }
        .timeline-marker-default {
          background: #e3f2fd !important;
          border-color: #64b5f6 !important;
          color: #1976d2 !important;
        }
        .timeline-marker-comment {
          background: #e8f5e8 !important;
          border-color: #81c784 !important;
          color: #388e3c !important;
        }
        .timeline-marker-private {
          background: #ffebee !important;
          border-color: #e57373 !important;
          color: #d32f2f !important;
        }
        .timeline-marker-status {
          background: #fff3e0 !important;
          border-color: #ffb74d !important;
          color: #f57c00 !important;
        }
        .timeline-marker-assign {
          background: #f3e5f5 !important;
          border-color: #ba68c8 !important;
          color: #7b1fa2 !important;
        }
        .timeline-marker-priority {
          background: #fbe9e7 !important;
          border-color: #ff8a65 !important;
          color: #e64a19 !important;
        }
        .timeline-marker-edit {
          background: #eceff1 !important;
          border-color: #90a4ae !important;
          color: #546e7a !important;
        }
        .timeline-user {
          color: #1a202c !important;
          font-weight: 600 !important;
        }
        .timeline-date {
          color: #718096 !important;
        }
        .timeline-changes {
          color: #1a202c !important;
        }
        .change-item {
          color: #4a5568 !important;
        }
        .change-item i {
          color: #3b82f6 !important;
        }
        .timeline-notes {
          background: #f7fafc !important;
          border-color: #e2e8f0 !important;
          color: #1a202c !important;
        }
        .timeline-notes.private {
          background: #fed7d7 !important;
          border-color: #f56565 !important;
        }
        .note-content {
          color: #1a202c !important;
        }
        /* Отключение всех hover эффектов, которые могут менять цвета */
        .timeline-content:hover,
        .timeline-marker:hover,
        .timeline-notes:hover,
        .change-item:hover {
          background-color: inherit !important;
          color: inherit !important;
          border-color: inherit !important;
        }
      `;
      document.head.appendChild(lightStyle);
    }
  });

    /**
   * Функция скачивания вложения заявки
   */
  async function downloadIssueAttachment(attachmentId) {
    console.log('🚀 [DEBUG] downloadIssueAttachment вызвана с attachmentId:', attachmentId);

    const issueId = getIssueIdFromUrl();
    console.log('🔍 [DEBUG] Полученный issueId:', issueId);

    if (!issueId) {
      showNotification('Ошибка: не удалось определить ID заявки', 'error');
      return;
    }

    // Показываем индикатор загрузки
    const downloadBtn = event.target.closest('.download-button');
    const originalContent = downloadBtn.innerHTML;
    downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    downloadBtn.disabled = true;

    try {
      // Создаем URL для скачивания с версией для избежания кеширования
      const downloadUrl = `/api/issue/${issueId}/attachment/${attachmentId}/download?v=${Date.now()}`;
      console.log('🌐 [DEBUG] URL для запроса:', downloadUrl);

      // Получаем информацию о файле
      const response = await fetch(downloadUrl, {
        method: 'GET',
        credentials: 'same-origin',
        headers: {
          'Cache-Control': 'no-cache, no-store, must-revalidate',
          'Pragma': 'no-cache',
          'Expires': '0'
        }
      });

      console.log('📡 [DEBUG] Ответ сервера:', response.status, response.statusText);

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

                  const data = await response.json();
      console.log('📄 [DEBUG] Данные ответа:', data);

      if (data.success && data.download_url) {
        console.log('🔗 [DEBUG] Получен URL для скачивания:', data.download_url);
        console.log('📄 [DEBUG] Имя файла:', data.filename);

        // Открываем URL для скачивания в новом окне
        console.log('🪟 [DEBUG] Открываем URL в новом окне');
        window.open(data.download_url, '_blank');
        showNotification(`Открывается скачивание файла: ${data.filename}`, 'success');
      } else {
        throw new Error('Не удалось получить URL для скачивания');
      }

    } catch (error) {
      console.error('Ошибка скачивания файла:', error);
      showNotification(`Ошибка скачивания файла: ${error.message}`, 'error');
    } finally {
      // Восстанавливаем кнопку
      setTimeout(() => {
        downloadBtn.innerHTML = originalContent;
        downloadBtn.disabled = false;
      }, 1000);
    }
  }

  /**
   * Вспомогательная функция для получения ID заявки из URL
   */
  function getIssueIdFromUrl() {
    const pathParts = window.location.pathname.split('/');
    const issueIndex = pathParts.indexOf('my-issues');
    if (issueIndex !== -1 && issueIndex + 1 < pathParts.length) {
      const issueId = pathParts[issueIndex + 1];
      if (!isNaN(issueId)) {
        return issueId;
      }
    }
    return null;
  }

  /**
   * Функция для отображения уведомлений
   */
  function showNotification(message, type = 'info') {
    // Создаем элемент уведомления
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
      <div class="notification-content">
        <span class="notification-message">${message}</span>
        <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `;

    // Добавляем стили для уведомлений
    if (!document.getElementById('notification-styles')) {
      const style = document.createElement('style');
      style.id = 'notification-styles';
      style.textContent = `
        .notification {
          position: fixed;
          top: 20px;
          right: 20px;
          z-index: 10000;
          max-width: 400px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          animation: slideInRight 0.3s ease-out;
        }
        .notification-success {
          background: #d4edda;
          border: 1px solid #c3e6cb;
          color: #155724;
        }
        .notification-error {
          background: #f8d7da;
          border: 1px solid #f5c6cb;
          color: #721c24;
        }
        .notification-info {
          background: #d1ecf1;
          border: 1px solid #bee5eb;
          color: #0c5460;
        }
        .notification-content {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 12px 16px;
        }
        .notification-close {
          background: none;
          border: none;
          color: inherit;
          cursor: pointer;
          margin-left: 12px;
          padding: 4px;
        }
        @keyframes slideInRight {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
    }

    // Добавляем уведомление на страницу
    document.body.appendChild(notification);

    // Автоматически удаляем через 5 секунд
    setTimeout(() => {
      if (notification.parentElement) {
        notification.remove();
      }
    }, 5000);
  }

  /**
   * Оптимизированный переход назад к списку заявок
   * Использует sessionStorage для кеширования данных и состояния таблицы
   */
  function goBackToListOptimized() {
    const cacheKey = 'my_issues_data_v2';
    const stateKey = 'my_issues_table_state_v2';
    const cacheTimeKey = 'my_issues_cache_time_v2';
    const cacheExpiry = 10 * 60 * 1000; // 10 минут в миллисекундах

    try {
      // Сохраняем информацию о текущей заявке для восстановления позиции
      const currentIssueId = window.location.pathname.match(/\/my-issues\/(\d+)/)?.[1];
      if (currentIssueId) {
        sessionStorage.setItem('return_from_issue_id', currentIssueId);
      }

      const cacheTimestamp = sessionStorage.getItem(cacheTimeKey);
      const now = Date.now();

      if (cacheTimestamp && (now - parseInt(cacheTimestamp)) < cacheExpiry) {
        // Кеш актуален - быстрый переход с сохранением состояния
        console.log('🚀 Быстрый переход: используем кешированные данные');

        // Добавляем параметр для указания использования кеша
        const urlParams = new URLSearchParams();
        urlParams.set('cached', '1');
        urlParams.set('from_issue', currentIssueId || '');

        window.location.href = `/my-issues?${urlParams.toString()}`;
      } else {
        // Кеш устарел - обычный переход с очисткой старого состояния
        console.log('🔄 Кеш истек, загружаем свежие данные');
        sessionStorage.removeItem(cacheKey);
        sessionStorage.removeItem(stateKey);
        sessionStorage.removeItem(cacheTimeKey);

        window.location.href = '/my-issues';
      }
    } catch (error) {
      console.error('❌ Ошибка при работе с кешем:', error);
      // Fallback - обычный переход
      window.location.href = '/my-issues';
    }
  }
</script>
{% endblock %}
