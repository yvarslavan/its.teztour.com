{% extends "layout.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <h1>üîß –û—Ç–ª–∞–¥–∫–∞ API –º–æ–¥—É–ª—è "–ú–æ–∏ –∑–∞–¥–∞—á–∏"</h1>
            <p>–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–ª–∞–¥–∫–∏ —Ñ—É–Ω–∫—Ü–∏–π –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–¥–∞—á</p>

            <div class="test-section">
                <h2>1. –¢–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤</h2>
                <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API:</p>
                <button onclick="testOptimizedFilters()" style="background-color: #28a745;">üîç –¢–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤</button>
                <div id="optimized-filters-result" class="test-result"></div>
            </div>

            <div class="test-section">
                <h2>2. –¢–µ—Å—Ç —Å—Ç–∞—Ä—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤</h2>
                <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ —Å—Ç–∞—Ä—ã–π API –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:</p>
                <button onclick="testOldFilters()" style="background-color: #ffc107;">üîç –¢–µ—Å—Ç —Å—Ç–∞—Ä—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤</button>
                <div id="old-filters-result" class="test-result"></div>
            </div>

            <div class="test-section">
                <h2>3. –¢–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h2>
                <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ –Ω–æ–≤—ã–π –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API:</p>
                <button onclick="testOptimizedStatistics()" style="background-color: #17a2b8;">üìä –¢–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</button>
                <div id="optimized-statistics-result" class="test-result"></div>
            </div>

            <div class="test-section">
                <h2>4. –¢–µ—Å—Ç —Å—Ç–∞—Ä–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h2>
                <p>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ —Å—Ç–∞—Ä—ã–π API –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:</p>
                <button onclick="testOldStatistics()" style="background-color: #fd7e14;">üìä –¢–µ—Å—Ç —Å—Ç–∞—Ä–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</button>
                <div id="old-statistics-result" class="test-result"></div>
            </div>

            <div class="test-section">
                <h2>5. –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</h2>
                <p>–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏:</p>
                <button onclick="getOptimizationConfig()" style="background-color: #6f42c1;">‚öôÔ∏è –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                <div id="config-result" class="test-result"></div>
            </div>

            <div class="test-section">
                <h2>6. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–ª–Ω–æ—Ç—ã –¥–∞–Ω–Ω—ã—Ö</h2>
                <p>–ê–Ω–∞–ª–∏–∑ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –º–µ—Ç–æ–¥–æ–≤ –ø–æ–ª—É—á–µ–Ω–∏—è –∑–∞–¥–∞—á –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º —Å—Ç–∞—Ç—É—Å–æ–≤ –∏ –ø—Ä–æ–µ–∫—Ç–æ–≤:</p>
                <button onclick="runTasksDiagnostics()" style="background-color: #dc3545;">üîç –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
                <div id="diagnostics-result" class="test-result"></div>
            </div>
        </div>
    </div>
</div>

<style>
    .test-section {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
    }

    .test-section h2 {
        color: #495057;
        margin-bottom: 10px;
        font-size: 1.25rem;
    }

    .test-section p {
        color: #6c757d;
        margin-bottom: 15px;
    }

    .test-section button {
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s ease;
        margin-right: 10px;
        margin-bottom: 10px;
    }

    .test-section button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .test-result {
        margin-top: 15px;
        padding: 15px;
        border-radius: 6px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 13px;
        line-height: 1.4;
        white-space: pre-wrap;
        max-height: 400px;
        overflow-y: auto;
    }

    .test-result.success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .test-result.error {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .test-result.info {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        color: #0c5460;
    }

    .data-display {
        background: #ffffff;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 12px;
        margin-top: 10px;
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 12px;
        line-height: 1.5;
        color: #495057;
        overflow-x: auto;
    }

    .config-form {
        background: #ffffff;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        padding: 15px;
        margin-top: 10px;
    }

    .config-form label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #495057;
    }

    .config-form input {
        width: 100px;
        padding: 6px 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        margin-bottom: 10px;
        margin-right: 10px;
    }

    .config-form button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
</style>

<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    function displayResult(elementId, success, data, timing = null) {
        const resultDiv = document.getElementById(elementId);

        if (success) {
            resultDiv.className = 'test-result success';
            resultDiv.innerHTML = `<strong>‚úÖ –£—Å–ø–µ—à–Ω–æ</strong>${timing ? ` (${timing}ms)` : ''}\n\n${JSON.stringify(data, null, 2)}`;
        } else {
            resultDiv.className = 'test-result error';
            resultDiv.innerHTML = `<strong>‚ùå –û—à–∏–±–∫–∞</strong>${timing ? ` (${timing}ms)` : ''}\n\n${typeof data === 'string' ? data : JSON.stringify(data, null, 2)}`;
        }
    }

    // 1. –¢–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function testOptimizedFilters() {
        const resultDiv = document.getElementById('optimized-filters-result');
        resultDiv.innerHTML = '<em>–ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤...</em>';

        const startTime = performance.now();
        fetch('/get-my-tasks-filters-optimized')
            .then(response => response.json())
            .then(data => {
                const endTime = performance.now();
                const loadTime = Math.round(endTime - startTime);
                displayResult('optimized-filters-result', data.success, data, loadTime);
            })
            .catch(error => {
                const endTime = performance.now();
                const loadTime = Math.round(endTime - startTime);
                displayResult('optimized-filters-result', false, error.message, loadTime);
            });
    }

    // 2. –¢–µ—Å—Ç —Å—Ç–∞—Ä—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function testOldFilters() {
        const resultDiv = document.getElementById('old-filters-result');
        resultDiv.innerHTML = '<em>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤...</em>';

        const startTime = performance.now();
        fetch('/get-my-tasks-filters')
            .then(response => response.json())
            .then(data => {
                const endTime = performance.now();
                const loadTime = Math.round(endTime - startTime);
                displayResult('old-filters-result', data.success, data, loadTime);
            })
            .catch(error => {
                const endTime = performance.now();
                const loadTime = Math.round(endTime - startTime);
                displayResult('old-filters-result', false, error.message, loadTime);
            });
    }

    // 3. –¢–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function testOptimizedStatistics() {
        const resultDiv = document.getElementById('optimized-statistics-result');
        resultDiv.innerHTML = '<em>–ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</em>';

        const startTime = performance.now();
        fetch('/get-my-tasks-statistics-optimized')
            .then(response => response.json())
            .then(data => {
                const endTime = performance.now();
                const loadTime = Math.round(endTime - startTime);
                displayResult('optimized-statistics-result', data.success, data, loadTime);
            })
            .catch(error => {
                const endTime = performance.now();
                const loadTime = Math.round(endTime - startTime);
                displayResult('optimized-statistics-result', false, error.message, loadTime);
            });
    }

    // 4. –¢–µ—Å—Ç —Å—Ç–∞—Ä–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function testOldStatistics() {
        const resultDiv = document.getElementById('old-statistics-result');
        resultDiv.innerHTML = '<em>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ä–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</em>';

        const startTime = performance.now();
        fetch('/get-my-tasks-statistics')
            .then(response => response.json())
            .then(data => {
                const endTime = performance.now();
                const loadTime = Math.round(endTime - startTime);
                displayResult('old-statistics-result', data.success, data, loadTime);
            })
            .catch(error => {
                const endTime = performance.now();
                const loadTime = Math.round(endTime - startTime);
                displayResult('old-statistics-result', false, error.message, loadTime);
            });
    }

    // 5. –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    function getOptimizationConfig() {
        const resultDiv = document.getElementById('config-result');
        resultDiv.innerHTML = '<em>–ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏...</em>';

        const startTime = performance.now();
        fetch('/api/tasks/optimization-config')
            .then(response => response.json())
            .then(data => {
                const endTime = performance.now();
                const loadTime = Math.round(endTime - startTime);

                resultDiv.className = 'test-result success';
                resultDiv.innerHTML = `
                    <strong>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏</strong> (${loadTime}ms)<br>
                    <div class="data-display">
                        <strong>üìä –¢–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:</strong><br>
                        ‚Ä¢ –†–∞–∑–º–µ—Ä –ø–æ—Ä—Ü–∏–π: ${data.batch_size}<br>
                        ‚Ä¢ –ú–∞–∫—Å–∏–º—É–º –∑–∞–¥–∞—á: ${data.max_issues}<br>
                        ‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ: ${data.description}<br><br>
                        <strong>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong><br>
                        ‚Ä¢ ${data.recommendations.batch_size}<br>
                        ‚Ä¢ ${data.recommendations.max_issues}
                    </div>
                    <div class="config-form">
                        <label>–†–∞–∑–º–µ—Ä –ø–æ—Ä—Ü–∏–π (100-2000):</label>
                        <input type="number" id="batch-size" value="${data.batch_size}" min="100" max="2000">
                        <label>–ú–∞–∫—Å–∏–º—É–º –∑–∞–¥–∞—á (1000-20000):</label>
                        <input type="number" id="max-issues" value="${data.max_issues}" min="1000" max="20000">
                        <button onclick="updateOptimizationConfig()">üíæ –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
                    </div>
                `;
            })
            .catch(error => {
                const endTime = performance.now();
                const loadTime = Math.round(endTime - startTime);
                displayResult('config-result', false, error.message, loadTime);
            });
    }

    function updateOptimizationConfig() {
        const batchSize = parseInt(document.getElementById('batch-size').value);
        const maxIssues = parseInt(document.getElementById('max-issues').value);

        fetch('/api/tasks/optimization-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                batch_size: batchSize,
                max_issues: maxIssues
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
                getOptimizationConfig(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            } else {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
            }
        })
        .catch(error => {
            alert('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message);
        });
    }

    function runTasksDiagnostics() {
        const resultDiv = document.getElementById('diagnostics-result');
        resultDiv.innerHTML = '<em>–ó–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.</em>';

        const startTime = performance.now();
        fetch('/api/tasks/diagnostics')
            .then(response => response.json())
            .then(data => {
                const endTime = performance.now();
                const loadTime = Math.round(endTime - startTime);

                if (data.success) {
                    resultDiv.className = 'test-result success';

                    // –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç –ø–æ –∫–∞–∂–¥–æ–º—É –º–µ—Ç–æ–¥—É
                    let methodsReport = '';
                    const diagnostics = data.diagnostics;

                    Object.keys(diagnostics).forEach(methodKey => {
                        if (methodKey !== 'user_info') {
                            const method = diagnostics[methodKey];
                            if (method.error) {
                                methodsReport += `<div style="margin: 10px 0; padding: 10px; background: #f8d7da; border-radius: 5px;">
                                    <strong>‚ùå ${method.description || methodKey}:</strong> –û—à–∏–±–∫–∞ - ${method.error}
                                </div>`;
                            } else {
                                // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –º–∞—Å—Å–∏–≤–æ–≤ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –Ω–∞ undefined
                                const statusesList = method.statuses_list && Array.isArray(method.statuses_list) ? method.statuses_list.join(', ') : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                                const projectsList = method.projects_list && Array.isArray(method.projects_list) ? method.projects_list.join(', ') : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                                const prioritiesList = method.priorities_list && Array.isArray(method.priorities_list) ? method.priorities_list.join(', ') : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                                const trackersList = method.trackers_list && Array.isArray(method.trackers_list) ? method.trackers_list.join(', ') : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';

                                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è REST API –º–µ—Ç–æ–¥–∞
                                let specialInfo = '';
                                if (methodKey === 'method_8_rest_api') {
                                    if (method.queue_status_found) {
                                        specialInfo = `<br>üéØ <strong style="color: green;">–°—Ç–∞—Ç—É—Å "–í –æ—á–µ—Ä–µ–¥–∏" –ù–ê–ô–î–ï–ù!</strong> –î–µ—Ç–∞–ª–∏: ${JSON.stringify(method.queue_status_details)}`;
                                    } else {
                                        specialInfo = `<br>‚ùå <strong style="color: red;">–°—Ç–∞—Ç—É—Å "–í –æ—á–µ—Ä–µ–¥–∏" –ù–ï –ù–ê–ô–î–ï–ù</strong>`;
                                    }
                                    specialInfo += `<br>üì° HTTP Status: ${method.response_status || 'N/A'}`;
                                }

                                // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –¥–ª—è –º–µ—Ç–æ–¥–∞ –ø–æ–∏—Å–∫–∞ –æ—á–µ—Ä–µ–¥–∏
                                if (methodKey === 'method_6_queue_search') {
                                    if (method.queue_status_found) {
                                        specialInfo = `<br>üéØ <strong style="color: green;">–°—Ç–∞—Ç—É—Å "–í –æ—á–µ—Ä–µ–¥–∏" –Ω–∞–π–¥–µ–Ω –≤ –∑–∞–¥–∞—á–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!</strong>`;
                                    } else {
                                        specialInfo = `<br>‚ùå <strong style="color: orange;">–°—Ç–∞—Ç—É—Å "–í –æ—á–µ—Ä–µ–¥–∏" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∑–∞–¥–∞—á–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</strong>`;
                                    }
                                }

                                methodsReport += `<div style="margin: 10px 0; padding: 10px; background: #d4edda; border-radius: 5px;">
                                    <strong>‚úÖ ${method.description}:</strong><br>
                                    üìä –í—Å–µ–≥–æ –∑–∞–¥–∞—á: ${method.total_issues || 0}<br>
                                    üéØ –°—Ç–∞—Ç—É—Å–æ–≤: ${method.unique_statuses || 0} (${statusesList})<br>
                                    üìÅ –ü—Ä–æ–µ–∫—Ç–æ–≤: ${method.unique_projects || 0} (${projectsList})<br>
                                    ‚≠ê –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤: ${method.unique_priorities || 0} (${prioritiesList})<br>
                                    üìã –¢—Ä–µ–∫–µ—Ä–æ–≤: ${method.unique_trackers || 0} (${trackersList})${specialInfo}
                                </div>`;
                            }
                        }
                    });

                    // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
                    const recommendations = data.recommendations && Array.isArray(data.recommendations)
                        ? data.recommendations.map(rec => `‚Ä¢ ${rec}`).join('<br>')
                        : '‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã';

                    resultDiv.innerHTML = `
                        <strong>üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á –∑–∞–≤–µ—Ä—à–µ–Ω–∞</strong><br>
                        <div class="data-display">
                            <strong>‚ö° –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ${loadTime}ms</strong><br>
                            <strong>üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Redmine ID: ${diagnostics.user_info?.redmine_user_id || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong><br><br>

                            <strong>üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –º–µ—Ç–æ–¥–æ–≤:</strong><br>
                            ${methodsReport}

                            <strong>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong><br>
                            ${recommendations}

                            <br><strong>üìÑ –ü–æ–¥—Ä–æ–±–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞</strong>
                        </div>
                    `;

                    console.log('üîç –ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:', data);
                } else {
                    resultDiv.className = 'test-result error';
                    resultDiv.innerHTML = `<strong>‚ùå –û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:</strong> ${data.error}`;
                }
            })
            .catch(error => {
                const endTime = performance.now();
                const loadTime = Math.round(endTime - startTime);
                resultDiv.className = 'test-result error';
                resultDiv.innerHTML = `<strong>‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏:</strong> ${error.message} (${loadTime}ms)`;
                console.error('–û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:', error);
            });
    }

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üîß –û—Ç–ª–∞–¥–æ—á–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        console.log('üí° –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ—Å—Ç—ã:');
        console.log('1. testOptimizedFilters() - —Ç–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤');
        console.log('2. testOldFilters() - —Ç–µ—Å—Ç —Å—Ç–∞—Ä—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤');
        console.log('3. testOptimizedStatistics() - —Ç–µ—Å—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
        console.log('4. testOldStatistics() - —Ç–µ—Å—Ç —Å—Ç–∞—Ä–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
        console.log('5. getOptimizationConfig() - –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫');
        console.log('6. runTasksDiagnostics() - –∑–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏');
    });
</script>
{% endblock %}
