{% extends 'layout.html' %}

<!-- Preload critical resources -->
<link rel="preload"
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap"
  as="style" onload="this.onload=null;this.rel='stylesheet'" />
<noscript>
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" />
</noscript>

{% block main_page %}
<div class="issues-page-container">
  <!-- Background Shapes - Lazy loaded -->
  <div class="background-shapes" style="opacity: 0; transition: opacity 0.5s ease">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
  </div>

  <!-- Loading Spinner -->
  <div id="loading-spinner" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner-icon">
        <i class="fas fa-cog fa-spin"></i>
      </div>
      <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...</h3>
      <p>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–∏—Å—Ç–µ–º–µ HelpDesk</p>
    </div>
  </div>

  <!-- Header Section -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-main">
        <div class="header-icon">
          <i class="fas fa-ticket-alt"></i>
        </div>
        <div class="header-text">
          <h1 class="page-title">–ú–æ–∏ –∑–∞—è–≤–∫–∏ –≤ –ò–¢-–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</h1>
          <p class="page-subtitle">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤–∞—à–∏—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É
          </p>
        </div>
      </div>
      <div class="header-actions">
        <a href="{{ url_for('main.new_issue') }}" class="action-button primary">
          <i class="fas fa-plus"></i>
          <span>–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</span>
        </a>
      </div>
    </div>
  </header>

  <!-- Statistics Dashboard -->
  <section class="stats-dashboard">
    <div class="stats-grid">
      <div class="stat-card total expandable" data-category="total">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-chart-pie"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="totalIssues">-</span>
            <span class="stat-label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</span>
          </div>
          <div class="expand-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="stat-details" id="totalDetails">
          <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
        </div>
      </div>
      <div class="stat-card open expandable" data-category="open">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-rocket"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="openIssues">-</span>
            <span class="stat-label">–û—Ç–∫—Ä—ã—Ç—ã—Ö</span>
            <div class="stat-status-list">
              <span class="status-hint">–ù–æ–≤–∞—è ‚Ä¢ –û—Ç–∫—Ä—ã—Ç–∞ ‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–∞</span>
            </div>
          </div>
          <div class="expand-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="stat-details" id="openDetails">
          <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
        </div>
      </div>
      <div class="stat-card progress expandable" data-category="progress">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-cogs"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="inProgressIssues">-</span>
            <span class="stat-label">–í —Ä–∞–±–æ—Ç–µ</span>
            <div class="stat-status-list">
              <span class="status-hint">–í —Ä–∞–±–æ—Ç–µ ‚Ä¢ –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞<br>–ù–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ ‚Ä¢ –í –æ—á–µ—Ä–µ–¥–∏</span>
            </div>
          </div>
          <div class="expand-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="stat-details" id="progressDetails">
          <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
        </div>
      </div>
      <div class="stat-card awaiting expandable" data-category="awaiting">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="awaitingResponseIssues">-</span>
            <span class="stat-label">–û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞</span>
            <div class="stat-status-list">
              <span class="status-hint">–ó–∞–ø—Ä–æ—à–µ–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ ‚Ä¢ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ ‚Ä¢ –ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</span>
            </div>
          </div>
          <div class="expand-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="stat-details" id="awaitingResponseDetails">
          <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
        </div>
      </div>
      <div class="stat-card closed expandable" data-category="closed">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-check-double"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="closedIssues">-</span>
            <span class="stat-label">–ó–∞–∫—Ä—ã—Ç—ã—Ö</span>
            <div class="stat-status-list">
              <span class="status-hint">–ó–∞–∫—Ä—ã—Ç–∞ ‚Ä¢ –û—Ç–∫–ª–æ–Ω–µ–Ω–∞ ‚Ä¢ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞</span>
            </div>
          </div>
          <div class="expand-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="stat-details" id="closedDetails">
          <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
        </div>
      </div>
    </div>
  </section>

  <!-- –ë–ª–æ–∫ "–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏" - –ê–∫–∫–æ—Ä–¥–µ–æ–Ω -->
  <section class="recent-activity-section">
    <div class="activity-accordion">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π) -->
      <div class="activity-accordion-header" id="activity-accordion-toggle">
        <div class="activity-header-content">
          <div class="activity-title">
            <i class="fas fa-history activity-icon"></i>
            <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏</h2>
            <span class="activity-badge" id="activity-count-badge" style="display: none;">0</span>
          </div>
          <div class="activity-subtitle">
            <span>–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≤–∞—à–∏—Ö –∑–∞—è–≤–∫–∞—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –¥–Ω–µ–π</span>
          </div>
        </div>
        <div class="activity-toggle-icon">
          <i class="fas fa-chevron-down"></i>
        </div>
      </div>

      <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ (—Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–µ–µ—Å—è) -->
      <div class="activity-accordion-content" id="activity-accordion-content">
        <div class="activity-container" id="recent-activity-container">
          <!-- –°–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
          <div class="activity-loading" id="activity-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <span>–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...</span>
          </div>

          <!-- –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript) -->
          <div class="activity-list" id="activity-list" style="display: none;">
            <!-- –≠–ª–µ–º–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
          </div>

          <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö -->
          <div class="activity-empty" id="activity-empty" style="display: none;">
            <i class="far fa-calendar-times"></i>
            <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫</p>
           <span class="activity-empty-hint">–ó–∞—è–≤–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</span>
          </div>

          <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
          <div class="activity-error" id="activity-error" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
            <button class="retry-btn" onclick="loadRecentActivity()">
              <i class="fas fa-redo"></i> –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
           </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Controls Panel -->
  <section class="controls-panel">
    <div class="controls-content">
      <div class="filters-section">
        <div class="filter-group">
          <div class="filter-item">
            <label class="filter-label">
              <i class="fas fa-filter"></i>
              –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
            </label>
            <div id="statusFilterContainer" class="filter-container">
              <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
            </div>
          </div>
        </div>
        <div class="search-section">
          <label class="search-label">
            <i class="fas fa-search"></i>
            –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫
          </label>
          <div id="searchBoxContainer" class="search-container">
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
          </div>
        </div>
      </div>
      <div class="display-options">
        <div class="display-item">
          <label class="display-label">–ü–æ–∫–∞–∑–∞—Ç—å:</label>
          <div id="lengthContainer" class="length-container">
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Issues Table -->
  <section class="issues-section">
    <div class="table-container">
      <div class="table-wrapper">
        <table id="issue" class="issues-table">
          <thead>
            <tr>
              <th class="column-id">
                <div class="column-header">
                  <i class="fas fa-hashtag"></i>
                  <span>ID</span>
                </div>
              </th>
              <th class="column-date">
                <div class="column-header">
                  <i class="fas fa-calendar-alt"></i>
                  <span>–û–±–Ω–æ–≤–ª–µ–Ω–æ</span>
                </div>
              </th>
              <th class="column-subject">
                <div class="column-header">
                  <i class="fas fa-envelope"></i>
                  <span>–¢–µ–º–∞ –∑–∞—è–≤–∫–∏</span>
                </div>
              </th>
              <th class="column-status">
                <div class="column-header">
                  <i class="fas fa-info-circle"></i>
                  <span>–°—Ç–∞—Ç—É—Å</span>
                </div>
              </th>
              <th style="display:none;">Status ID</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Table Footer with Info and Pagination -->
    <div class="table-footer">
      <div class="table-info">
        <div id="infoContainer">
          <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
        </div>
      </div>
      <div class="table-pagination">
        <div id="paginationContainer">
          <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
        </div>
      </div>
    </div>
  </section>
</div>
{% endblock main_page %} {% block styles %}

<!-- Theme-aware styles for Issues page -->
<link rel="stylesheet"
  href="{{ url_for('static', filename='css/issues_theme_fix.css') }}?v={{ cache_buster or '1' }}&force={{ range(1, 999999) | random }}">

<!-- –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ "–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏" -->
<link rel="stylesheet"
  href="{{ url_for('static', filename='css/my_issues_activity.css') }}?v={{ cache_buster or '1' }}&force={{ range(1, 999999) | random }}">

<!-- Base Styles (Always Active) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/issues_styles.css') }}?v={{ cache_buster or '1' }}&force={{ range(1, 999999) | random }}">
{% endblock %}{% block scripts %}
<script>
  // DataStateManager - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
  class DataStateManager {
    constructor() {
      this.tableState = {};
      this.statsState = {};
      this.storageKey = "issuesPageState";
    }

    getDataTable() {
      try {
        return window.issuesTable || window.table || null;
      } catch (e) {
        console.warn("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è DataTable:", e);
        return null;
      }
    }

    saveTableState() {
      this.saveCurrentState();
    }

    saveCurrentState() {
      try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã DataTables
        const dt = this.getDataTable();
        if (dt && $.fn.DataTable.isDataTable("#issue")) {
          const tableInfo = dt.page.info();
          const searchValue = dt.search();
          const orderInfo = dt.order();

          this.tableState = {
            page: tableInfo.page,
            length: tableInfo.length,
            search: searchValue,
            order: orderInfo,
            timestamp: Date.now(),
          };
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
        this.saveStatsState();

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
        this.persistState();
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:", error);
      }
    }

    saveStatsState() {
      try {
        const statsCards = document.querySelectorAll(".stat-card");
        this.statsState = {};

        statsCards.forEach((card, index) => {
          const isExpanded = card.classList.contains("expanded");
          const cardId = card.id || `stat-card-${index}`;

          this.statsState[cardId] = {
            expanded: isExpanded,
            visible: !card.classList.contains("hidden"),
          };
        });
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", error);
      }
    }

    restoreState() {
      try {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã
        this.restoreTableState();

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        this.restoreStatsState();
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è:", error);
      }
    }

    restoreTableState() {
      try {
        const dt = this.getDataTable();
        if (this.tableState && dt && $.fn.DataTable.isDataTable("#issue")) {
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∏—Å–∫
          if (this.tableState.search) {
            dt.search(this.tableState.search);
          }

          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É
          if (this.tableState.order) {
            dt.order(this.tableState.order);
          }

          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
          if (this.tableState.length) {
            dt.page.len(this.tableState.length);
          }

          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
          if (this.tableState.page !== undefined) {
            dt.page(this.tableState.page);
          }

          // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
          dt.draw(false);
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã:", error);
      }
    }

    restoreStatsState() {
      try {
        if (this.statsState) {
          Object.keys(this.statsState).forEach((cardId) => {
            const card = document.getElementById(cardId);
            if (card) {
              const state = this.statsState[cardId];

              // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è
              if (state.expanded) {
                card.classList.add("expanded");
              } else {
                card.classList.remove("expanded");
              }

              // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å
              if (state.visible) {
                card.classList.remove("hidden");
              } else {
                card.classList.add("hidden");
              }
            }
          });
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:", error);
      }
    }

    persistState() {
      try {
        const stateData = {
          table: this.tableState,
          stats: this.statsState,
          timestamp: Date.now(),
        };

        localStorage.setItem(this.storageKey, JSON.stringify(stateData));
      } catch (error) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage:", error);
      }
    }

    loadPersistedState() {
      try {
        const savedData = localStorage.getItem(this.storageKey);
        if (savedData) {
          const stateData = JSON.parse(savedData);

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —É—Å—Ç–∞—Ä–µ–ª–∏ –ª–∏ –¥–∞–Ω–Ω—ã–µ (—Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞)
          const oneHour = 60 * 60 * 1000;
          if (Date.now() - stateData.timestamp < oneHour) {
            this.tableState = stateData.table || {};
            this.statsState = stateData.stats || {};
          }
        }
      } catch (error) {
        console.warn("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ localStorage:", error);
      }
    }

    clearState() {
      try {
        this.tableState = {};
        this.statsState = {};
        localStorage.removeItem(this.storageKey);
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:", error);
      }
    }
  }

  // Optimized DOM Ready with performance improvements
  $(document).ready(function () {
    // Performance optimization: Use requestAnimationFrame for smooth initialization
    requestAnimationFrame(() => {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä—ã
      // ThemeManager —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ –≤ layout.html
      window.dataStateManager = new DataStateManager();

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      window.dataStateManager.loadPersistedState();

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞
      $("#loading-spinner").show();

      // Defer heavy operations
      setTimeout(() => {
        initializeTableData();
      }, 0);
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∏–ª—è —Å—Ç–∞—Ç—É—Å–∞
    function getStatusStyle(statusName) {
      let style = {
        trClass: "status-default",
        iconClass: "fas fa-question-circle",
        tooltip: statusName,
        statusTextClass: "",
      };
      const normalizedStatus = String(statusName).toLowerCase();

      if (
        normalizedStatus.includes("–∑–∞–∫—Ä—ã—Ç–∞") ||
        normalizedStatus.includes("–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞") ||
        normalizedStatus.includes("–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞") ||
        normalizedStatus.includes("closed") ||
        normalizedStatus.includes("rejected") ||
        normalizedStatus.includes("redirected")
      ) {
        style.trClass = "status-closed";
        style.iconClass = "fas fa-times-circle";
        style.tooltip = "–ó–∞—è–≤–∫–∞ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞";
      } else if (
        normalizedStatus.includes("–≤—ã–ø–æ–ª–Ω–µ–Ω–∞") ||
        normalizedStatus.includes("resolved")
      ) {
        style.trClass = "status-open";
        style.iconClass = "fas fa-check-circle";
        style.tooltip = "–ó–∞—è–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –æ–∂–∏–¥–∞–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏—è";
      } else if (
        normalizedStatus.includes("–≤ —Ä–∞–±–æ—Ç–µ") ||
        normalizedStatus.includes("–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞") ||
        normalizedStatus.includes("–Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏") ||
        normalizedStatus.includes("–≤ –æ—á–µ—Ä–µ–¥–∏") ||
        normalizedStatus.includes("–∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞") ||
        normalizedStatus.includes("in progress")
      ) {
        style.trClass = "status-progress";
        style.iconClass = "fas fa-clock";
        style.tooltip = "–ó–∞—è–≤–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è";
      } else if (
        normalizedStatus.includes("–∑–∞–ø—Ä–æ—à–µ–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ") ||
        normalizedStatus.includes("clarification")
      ) {
        style.trClass = "status-clarification";
        style.iconClass = "fas fa-exclamation-circle";
        style.tooltip = "–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–∞—à–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã";
      } else if (
        normalizedStatus.includes("–Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏") ||
        normalizedStatus.includes("approval")
      ) {
        style.trClass = "status-approval";
        style.iconClass = "fas fa-user-clock";
        style.tooltip = "–ó–∞—è–≤–∫–∞ –æ–∂–∏–¥–∞–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è";
      } else if (
        normalizedStatus.includes("–æ—Ç–∫—Ä—ã—Ç–∞") ||
        normalizedStatus.includes("new") ||
        normalizedStatus.includes("open") ||
        normalizedStatus.includes("pending") ||
        normalizedStatus.includes("—Å–æ–∑–¥–∞–Ω–∞") ||
        normalizedStatus.includes("–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞")
      ) {
        style.trClass = "status-open";
        style.iconClass = "fas fa-folder-open";
        style.tooltip = "–ó–∞—è–≤–∫–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∏ –æ–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏";
      }
      return style;
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
    function formatDate(dateString) {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) {
        return "–ù–µ—Ç –¥–∞—Ç—ã";
      }
      return date.toLocaleDateString("ru-RU", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });
    }
    // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–µ—à–∞
    function initializeTableData() {
      const cacheKey = "my_issues_data_v2";
      const stateKey = "my_issues_table_state_v2";
      const cacheTimeKey = "my_issues_cache_time_v2";
      const cacheExpiry = 10 * 60 * 1000; // 10 –º–∏–Ω—É—Ç

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
      const urlParams = new URLSearchParams(window.location.search);
      const useCached = urlParams.get("cached") === "1";
      const fromIssueId = urlParams.get("from_issue");

      // –ü–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–µ—à
      if (useCached) {
        const cachedData = sessionStorage.getItem(cacheKey);
        const cacheTimestamp = sessionStorage.getItem(cacheTimeKey);
        const cachedState = sessionStorage.getItem(stateKey);

        if (
          cachedData &&
          cacheTimestamp &&
          Date.now() - parseInt(cacheTimestamp) < cacheExpiry
        ) {
          try {
            const response = JSON.parse(cachedData);
            const tableState = cachedState ? JSON.parse(cachedState) : null;

            console.log("üìö –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
            processTableData(response, tableState, fromIssueId);

            // –û—á–∏—â–∞–µ–º URL –æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–µ—à–∞
            window.history.replaceState({}, "", "/my-issues");
            return;
          } catch (error) {
            console.warn("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∫–µ—à–∞:", error);
          }
        }
      }

      // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
      console.log("üåê –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å —Å–µ—Ä–≤–µ—Ä–∞");
      loadDataFromServer();
    }

    // AJAX –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å —Å–µ—Ä–≤–µ—Ä–∞
    function loadDataFromServer() {
      $.ajax({
        url: "/get-my-issues",
        method: "GET",
        crossDomain: true,
        xhrFields: {
          withCredentials: true,
        },
        success: function (response) {
          // –ö–µ—à–∏—Ä—É–µ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
          const cacheKey = "my_issues_data_v2";
          const cacheTimeKey = "my_issues_cache_time_v2";

          try {
            sessionStorage.setItem(cacheKey, JSON.stringify(response));
            sessionStorage.setItem(cacheTimeKey, Date.now().toString());
            console.log("üíæ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –∫–µ—à");
          } catch (error) {
            console.warn("‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –∫–µ—à:", error);
          }

          // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          processTableData(response);
        },
        error: function (xhr, status, error) {
          console.error("Error:", error);
          $("#table-body").html(`
                      <tr>
                          <td></td>
                          <td></td>
                          <td>
                              <div class="error-state">
                                  <i class="fas fa-exclamation-triangle"></i>
                                  <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h3>
                                  <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–∏—Å—Ç–µ–º–µ HelpDesk</p>
                                  <button onclick="location.reload()" class="action-button primary">
                                      <i class="fas fa-refresh"></i>
                                      <span>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</span>
                                  </button>
                              </div>
                          </td>
                          <td></td>
                      </tr>
                  `);
        },
        complete: function () {
          // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
          $("#loading-spinner").hide();
        },
      });
    }
    // –§—É–Ω–∫—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ —á–∏—Å–µ–ª - Optimized
    function animateNumber(element, finalNumber) {
      if (finalNumber === 0) {
        element.text("0");
        return;
      }

      let currentNumber = 0;
      const steps = Math.min(20, finalNumber); // –ú–µ–Ω—å—à–µ —à–∞–≥–æ–≤ –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      const increment = finalNumber / steps;
      const duration = Math.min(1000, finalNumber * 30); // –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
      const stepTime = duration / steps;

      const timer = setInterval(function () {
        currentNumber += increment;
        if (currentNumber >= finalNumber) {
          currentNumber = finalNumber;
          clearInterval(timer);
        }
        element.text(Math.floor(currentNumber));
      }, stepTime);
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∫–∞—Ä—Ç–æ—á–µ–∫
    function populateCardDetails(stats) {
      console.log("üîç populateCardDetails –≤—ã–∑–≤–∞–Ω–∞ —Å:", stats);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã detailsByCategory
      if (!stats || !stats.detailsByCategory) {
        console.error("‚ùå stats.detailsByCategory –Ω–µ –Ω–∞–π–¥–µ–Ω:", stats);
        return;
      }

      console.log("üìä detailsByCategory:", stats.detailsByCategory);

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
      function buildCategoryBlock(titleEmojiAndText, categoryMap, itemClass) {
        if (!categoryMap || Object.keys(categoryMap).length === 0) return "";
        let html = `<div class="category-group"><div class="category-title">${titleEmojiAndText}</div>`;
        Object.keys(categoryMap).forEach((status) => {
          const count = categoryMap[status];
          html += `
                      <div class="status-item ${itemClass}" data-status="${status}">
                          <span class="status-name">${status}</span>
                          <span class="status-count">${count}</span>
                      </div>
                  `;
        });
        html += "</div>";
        return html;
      }

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫ (total)
      let totalDetailsHTML = "";

      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      // –û—Ç–∫—Ä—ã—Ç—ã–µ —Å—Ç–∞—Ç—É—Å—ã
      totalDetailsHTML += buildCategoryBlock(
        "üìÇ –û—Ç–∫—Ä—ã—Ç—ã–µ",
        stats.detailsByCategory.open,
        "open-status"
      );

      // –°—Ç–∞—Ç—É—Å—ã –≤ —Ä–∞–±–æ—Ç–µ
      totalDetailsHTML += buildCategoryBlock(
        "‚öôÔ∏è –í —Ä–∞–±–æ—Ç–µ",
        stats.detailsByCategory.progress,
        "progress-status"
      );

      // –ó–∞–∫—Ä—ã—Ç—ã–µ —Å—Ç–∞—Ç—É—Å—ã
      totalDetailsHTML += buildCategoryBlock(
        "‚úÖ –ó–∞–∫—Ä—ã—Ç—ã–µ",
        stats.detailsByCategory.closed,
        "closed-status"
      );

      // –û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞
      totalDetailsHTML += buildCategoryBlock(
        "‚è≥ –û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞",
        stats.detailsByCategory.awaiting,
        "awaiting-status"
      );

      if (totalDetailsHTML === "") {
        totalDetailsHTML =
          '<div class="status-item"><span class="status-name">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span></div>';
      }
      $("#totalDetails").html(totalDetailsHTML);

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º –∫–∞—Ä—Ç–æ—á–∫–∞–º
      let openDetailsHTML = buildCategoryBlock(
        "üìÇ –û—Ç–∫—Ä—ã—Ç—ã–µ",
        stats.detailsByCategory.open,
        "open-status"
      );
      if (openDetailsHTML === "")
        openDetailsHTML =
          '<div class="status-item"><span class="status-name">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span></div>';
      $("#openDetails").html(openDetailsHTML);

      let progressDetailsHTML = buildCategoryBlock(
        "‚öôÔ∏è –í —Ä–∞–±–æ—Ç–µ",
        stats.detailsByCategory.progress,
        "progress-status"
      );
      if (progressDetailsHTML === "")
        progressDetailsHTML =
          '<div class="status-item"><span class="status-name">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span></div>';
      $("#progressDetails").html(progressDetailsHTML);

      let closedDetailsHTML = buildCategoryBlock(
        "‚úÖ –ó–∞–∫—Ä—ã—Ç—ã–µ",
        stats.detailsByCategory.closed,
        "closed-status"
      );
      if (closedDetailsHTML === "")
        closedDetailsHTML =
          '<div class="status-item"><span class="status-name">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span></div>';
      $("#closedDetails").html(closedDetailsHTML);

      let awaitingDetailsHTML = buildCategoryBlock(
        "‚è≥ –û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞",
        stats.detailsByCategory.awaiting,
        "awaiting-status"
      );
      if (awaitingDetailsHTML === "")
        awaitingDetailsHTML =
          '<div class="status-item"><span class="status-name">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span></div>';
      $("#awaitingResponseDetails").html(awaitingDetailsHTML);
    } // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü—ã (–æ–±—â–∞—è –¥–ª—è –∫–µ—à–∞ –∏ —Å–µ—Ä–≤–µ—Ä–∞)
    function processTableData(response, savedState, fromIssueId) {
      // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ö–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∏
      window.issuesData = response.issues || [];
      console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∑–∞—è–≤–æ–∫ –¥–ª—è –ö–∞–Ω–±–∞–Ω:', window.issuesData.length);

      // –°–æ–∑–¥–∞–µ–º —Ñ–∏–ª—å—Ç—Ä —Å—Ç–∞—Ç—É—Å–æ–≤
      let statusFilter =
        '<select id="status-filter" class="form-control">' +
        '<option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>';

      response.statuses.forEach(function (status) {
        statusFilter += `<option value="${status.name}">${status.name}</option>`;
      });

      statusFilter += "</select>";
      $("#statusFilterContainer").html(statusFilter);

      // –ü–æ–¥—Å—á–µ—Ç –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      let stats = {
        total: response.issues.length,
        open: 0,
        inProgress: 0,
        closed: 0,
        awaitingResponse: 0,
        detailsByCategory: {
          open: {},
          progress: {},
          closed: {},
          awaiting: {},
          other: {},
        },
      };

      // –û—Ç–ª–∞–¥–∫–∞: –≤—ã–≤–æ–¥–∏–º –≤—Å–µ –∑–∞—è–≤–∫–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
      console.log('üìä –í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞:', response.issues.length);
      console.log('üîç –ò—â–µ–º –∑–∞—è–≤–∫–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ 9, 13, 15...');

      response.issues.forEach(function (issue) {
        const normalizedStatus = String(issue.status_name).toLowerCase();
        const statusName = issue.status_name;
        const statusId = parseInt(issue.status_id); // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —á–∏—Å–ª–æ

        // –û—Ç–ª–∞–¥–∫–∞: –≤—ã–≤–æ–¥–∏–º –∫–∞–∂–¥—É—é –∑–∞—è–≤–∫—É
        // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º statusId –≤ —á–∏—Å–ª–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        const statusIdNum = parseInt(statusId, 10);
        if (statusIdNum === 9 || statusIdNum === 13 || statusIdNum === 15) {
          console.log(`‚è≥ –ù–ê–ô–î–ï–ù–ê! –ó–∞—è–≤–∫–∞ #${issue.id} "${statusName}" (ID: ${statusId}, —Ç–∏–ø: ${typeof statusId}) ‚Üí –û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞`);
          stats.awaitingResponse++;
          stats.detailsByCategory.awaiting[statusName] =
            (stats.detailsByCategory.awaiting[statusName] || 0) + 1;
        } else if (
          normalizedStatus.includes("–∑–∞–∫—Ä—ã—Ç–∞") ||
          normalizedStatus.includes("–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞") ||
          normalizedStatus.includes("–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞") ||
          normalizedStatus.includes("closed") ||
          normalizedStatus.includes("rejected") ||
          normalizedStatus.includes("redirected")
        ) {
          stats.closed++;
          stats.detailsByCategory.closed[statusName] =
            (stats.detailsByCategory.closed[statusName] || 0) + 1;
        } else if (
          normalizedStatus.includes("–≤ —Ä–∞–±–æ—Ç–µ") ||
          normalizedStatus.includes("–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞") ||
          normalizedStatus.includes("–Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏") ||
          normalizedStatus.includes("–≤ –æ—á–µ—Ä–µ–¥–∏") ||
          normalizedStatus.includes("–∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞") ||
          normalizedStatus.includes("in progress")
        ) {
          stats.inProgress++;
          stats.detailsByCategory.progress[statusName] =
            (stats.detailsByCategory.progress[statusName] || 0) + 1;
        } else if (
          normalizedStatus.includes("–æ—Ç–∫—Ä—ã—Ç–∞") ||
          normalizedStatus.includes("–≤—ã–ø–æ–ª–Ω–µ–Ω–∞") ||
          normalizedStatus.includes("new") ||
          normalizedStatus.includes("open") ||
          normalizedStatus.includes("pending") ||
          normalizedStatus.includes("resolved") ||
          normalizedStatus.includes("—Å–æ–∑–¥–∞–Ω–∞") ||
          normalizedStatus.includes("–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞")
        ) {
          stats.open++;
          stats.detailsByCategory.open[statusName] =
            (stats.detailsByCategory.open[statusName] || 0) + 1;
        } else {
          // –î—Ä—É–≥–∏–µ —Å—Ç–∞—Ç—É—Å—ã
          stats.detailsByCategory.other[statusName] =
            (stats.detailsByCategory.other[statusName] || 0) + 1;
        }
      });

      // –û—Ç–ª–∞–¥–∫–∞: –≤—ã–≤–æ–¥–∏–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      console.log('üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:', {
        total: stats.total,
        open: stats.open,
        inProgress: stats.inProgress,
        closed: stats.closed,
        awaitingResponse: stats.awaitingResponse
      });
      console.log('üìã –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è "–û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞":', stats.detailsByCategory.awaiting);

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
      animateNumber($("#totalIssues"), stats.total);
      animateNumber($("#openIssues"), stats.open);
      animateNumber($("#inProgressIssues"), stats.inProgress);
      animateNumber($("#closedIssues"), stats.closed);
      animateNumber($("#awaitingResponseIssues"), stats.awaitingResponse);

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –∫–∞—Ä—Ç–æ—á–µ–∫
      populateCardDetails(stats);
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –ø–æ —Å—Ç–∞—Ç-–∫–∞—Ä—Ç–æ—á–∫–∞–º
      initStatCards();

      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–∞–Ω–Ω—ã–º–∏
      if (response.issues.length === 0) {
        $("#table-body").html(`
                  <tr>
                      <td></td>
                      <td></td>
                      <td>
                          <div class="empty-state">
                              <i class="fas fa-inbox"></i>
                              <h3>–ó–∞—è–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                              <p>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ</p>
                              <a href="${'{{ url_for("main.new_issue") }}'}" class="action-button primary">
                                  <i class="fas fa-plus"></i>
                                  <span>–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É</span>
                              </a>
                          </div>
                      </td>
                      <td></td>
                  </tr>
              `);
      } else {
        let tableBody = "";
        response.issues.forEach(function (issue) {
          let statusInfo = getStatusStyle(issue.status_name);
          tableBody += `
                      <tr class="${statusInfo.trClass}" data-status-id="${issue.status_id || 0}" data-issue-id="${issue.id}" data-status-name="${issue.status_name}">
                          <td>
                              <a href="/my-issues/${issue.id
            }" class="issue-id-link" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏">
                                  <i class="fas fa-external-link-alt"></i>
                                  <span>#${issue.id}</span>
                              </a>
                          </td>
                          <td data-sort="${issue.updated_on}">
                              <span title="${new Date(
              issue.updated_on
            ).toLocaleString("ru-RU")}">${formatDate(
              issue.updated_on
            )}</span>
                          </td>
                          <td>
                              <a href="/my-issues/${issue.id
            }" class="issue-subject-link issue-subject" title="${issue.subject
            }">
                                  <i class="fas fa-external-link-alt"></i>
                                  <span>${issue.subject}</span>
                              </a>
                          </td>
                          <td>
                              <div class="status-cell">
                                  <div class="status-badge" title="${statusInfo.tooltip
            }">
                                      <i class="${statusInfo.iconClass
            } status-icon"></i>
                                      <span>${issue.status_name}</span>
                                  </div>
                              </div>
                          </td>
                          <td style="display:none;">${issue.status_id || 0}</td>
                      </tr>
                  `;
        });
        $("#table-body").html(tableBody);
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º DataTables
      let table;
      try {
        table = window.issuesTable = $("#issue").DataTable({
          language: {
            url: "/static/js/datatables/Russian.json",
          },
          order: [[1, "desc"]],
          pageLength: 10,
          lengthMenu: [
            [5, 10, 25, 50],
            [5, 10, 25, 50],
          ],
          pagingType: "full_numbers",
          dom: '<"top"<"left-col"l><"right-col"f>><"clear">rt<"bottom"<"left-col"i><"right-col"p>>',
          deferRender: true, // Optimize rendering
          processing: false, // Disable processing indicator for better UX
          stateSave: false, // We handle state manually
          initComplete: function () {
            // –ü–µ—Ä–µ–º–µ—â–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            $(".dataTables_filter").detach().appendTo("#searchBoxContainer");
            $("#searchBoxContainer label")
              .contents()
              .filter(function () {
                return this.nodeType === 3;
              })
              .remove();
            $('#searchBoxContainer input[type="search"]').attr(
              "placeholder",
              "–ü–æ–∏—Å–∫ –ø–æ –∑–∞—è–≤–∫–∞–º..."
            );

            $(".dataTables_length").detach().appendTo("#lengthContainer");
            $("#lengthContainer label")
              .contents()
              .filter(function () {
                return this.nodeType === 3;
              })
              .remove();

            $(".dataTables_info").detach().appendTo("#infoContainer");
            $(".dataTables_paginate").detach().appendTo("#paginationContainer");

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–æ–≤ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
            const viewToggleHtml = `
              <div class="view-toggle-wrapper" style="margin: 20px 0; text-align: center;">
                <div class="view-toggle-buttons">
                  <button class="view-toggle-btn active" data-view="list" title="–†–µ–∂–∏–º —Å–ø–∏—Å–∫–∞">
                    <i class="fas fa-list"></i>
                    <span>–°–ø–∏—Å–æ–∫</span>
                  </button>
                  <button class="view-toggle-btn" data-view="kanban" title="–†–µ–∂–∏–º –∫–∞—Ä—Ç–æ—á–µ–∫">
                    <i class="fas fa-th-large"></i>
                    <span>–ö–∞—Ä—Ç–æ—á–∫–∏</span>
                  </button>
                </div>
              </div>
            `;

            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–¥ —Ç–∞–±–ª–∏—Ü–µ–π
            $('.issues-section .table-container').before(viewToggleHtml);

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–ª–∏–∫–æ–≤
            $('.view-toggle-btn').on('click', function () {
              const viewMode = $(this).data('view');

              // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
              $('.view-toggle-btn').removeClass('active');

              // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ
              $(this).addClass('active');

              // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
              localStorage.setItem('issues_view_mode', viewMode);

              // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
              if (viewMode === 'kanban') {
                window.showKanbanView();
              } else {
                window.showListView();
              }

              console.log('üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω —Ä–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞:', viewMode);
            });

            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ä–µ–∂–∏–º
            const savedViewMode = localStorage.getItem('issues_view_mode');
            if (savedViewMode === 'kanban') {
              $('.view-toggle-btn[data-view="kanban"]').trigger('click');
            }
          },
          paging: true,
          info: true,
          searching: true,
          ordering: true,
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–ª—å—Ç—Ä–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
        $("#status-filter").on("change", function () {
          let selectedStatus = $(this).val();
          table.column(3).search(selectedStatus).draw();

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞
          if (window.dataStateManager) {
            setTimeout(() => {
              window.dataStateManager.saveTableState();
            }, 100);
          }
        });

        // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –¥—Ä—É–≥–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
        table.on("page.dt", function () {
          if (window.dataStateManager) {
            setTimeout(() => {
              window.dataStateManager.saveTableState();
            }, 100);
          }
        });

        table.on("length.dt", function () {
          if (window.dataStateManager) {
            setTimeout(() => {
              window.dataStateManager.saveTableState();
            }, 100);
          }
        });

        table.on("order.dt", function () {
          if (window.dataStateManager) {
            setTimeout(() => {
              window.dataStateManager.saveTableState();
            }, 100);
          }
        });

        table.on("search.dt", function () {
          if (window.dataStateManager) {
            setTimeout(() => {
              window.dataStateManager.saveTableState();
            }, 100);
          }
        });
      } catch (error) {
        console.error("‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ DataTables:", error);
      }

      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
      if (window.dataStateManager && savedState) {
        setTimeout(() => {
          window.dataStateManager.restoreTableState();
        }, 100);
      }

      // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
      $("#loading-spinner").hide();

      // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö
      $(document).trigger("dataLoaded");
    }

    // Table initialization moved to requestAnimationFrame above

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è —Å—Ç–∞—Ç-–∫–∞—Ä—Ç–æ—á–µ–∫ - Optimized
    function initStatCards() {
      try {
        $(".stat-card.expandable").each(function () {
          const $card = $(this);
          const $details = $card.find(".stat-details");

          $card.off("click.statToggle").on("click.statToggle", function (e) {
            if (
              $(e.target).is(
                "select, option, input, button, a, .action-button, .status-item"
              )
            )
              return;

            $card.toggleClass("expanded");

            if ($card.hasClass("expanded")) {
              $details
                .css({
                  display: "block",
                  opacity: "0",
                  height: "0",
                  overflow: "hidden",
                })
                .stop(true, true)
                .animate(
                  {
                    opacity: "1",
                    height: $details[0].scrollHeight + "px",
                  },
                  150,
                  function () {
                    $details.css({
                      height: "auto",
                      overflow: "visible",
                    });
                  }
                );
            } else {
              $details.stop(true, true).animate(
                {
                  opacity: "0",
                  height: "0",
                },
                150,
                function () {
                  $details.css("display", "none");
                }
              );
            }
          });
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–∫–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        $(".status-item")
          .off("click.statusFilter")
          .on("click.statusFilter", function (e) {
            e.stopPropagation();
            const $statusItem = $(this);
            const statusText = $statusItem.find(".status-name").text().trim();

            console.log("üîç –ö–ª–∏–∫ –ø–æ —Å—Ç–∞—Ç—É—Å—É:", statusText);

            // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
            $(".status-item").removeClass("active");
            // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É
            $statusItem.addClass("active");

            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ —Å—Ç–∞—Ç—É—Å—É
            filterTableByStatus(statusText);
          });
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç-–∫–∞—Ä—Ç–æ—á–µ–∫:", err);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É
    function filterTableByStatus(statusText) {
      try {
        console.log("üîç filterTableByStatus –≤—ã–∑–≤–∞–Ω–∞ —Å:", statusText);
        const dt = window.dataStateManager
          ? window.dataStateManager.getDataTable()
          : null;
        console.log("üîç DataTable instance:", dt);

        if (dt && $.fn.DataTable.isDataTable("#issue")) {
          console.log("üîç –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É:", statusText);

          // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã
          dt.search("").columns().search("").draw();

          // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É (–∫–æ–ª–æ–Ω–∫–∞ 3 - —Å—Ç–∞—Ç—É—Å)
          if (statusText && statusText !== "–í—Å–µ") {
            dt.column(3).search(statusText, true, false).draw();
            console.log("üîç –§–∏–ª—å—Ç—Ä –ø—Ä–∏–º–µ–Ω–µ–Ω –∫ –∫–æ–ª–æ–Ω–∫–µ 3");
          }

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          if (window.dataStateManager) {
            window.dataStateManager.saveCurrentState();
          }
        } else {
          console.warn("‚ö†Ô∏è DataTable –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞");
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ —Å—Ç–∞—Ç—É—Å—É:", err);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function resetStatusFilter() {
      try {
        const dt = window.dataStateManager
          ? window.dataStateManager.getDataTable()
          : null;
        if (dt && $.fn.DataTable.isDataTable("#issue")) {
          // –û—á–∏—â–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
          dt.search("").columns().search("").draw();

          // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
          $(".status-item").removeClass("active");

          // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
          if (window.dataStateManager) {
            window.dataStateManager.saveCurrentState();
          }
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤:", err);
      }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∂–∏–º–∞ —Å–ø–∏—Å–∫–∞
    window.showListView = function () {
      $('.issues-section .table-container').show();
      $('#kanban-container').hide();

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –≤ —Ä–µ–∂–∏–º–µ —Å–ø–∏—Å–∫–∞
      $('.table-footer').show();

      console.log('üìã –ü–æ–∫–∞–∑–∞–Ω —Ä–µ–∂–∏–º —Å–ø–∏—Å–∫–∞');
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∂–∏–º–∞ –∫–∞–Ω–±–∞–Ω
    window.showKanbanView = function () {
      $('.issues-section .table-container').hide();

      // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∏ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
      if ($('#kanban-container').length === 0) {
        const kanbanHtml = `
          <div id="kanban-container" class="kanban-container">
            <div class="kanban-board">
              <div class="kanban-column column-open" data-status="open">
                <div class="kanban-header header-open">
                  <div class="header-content">
                    <div class="header-icon">
                      <i class="fas fa-folder-open"></i>
                    </div>
                    <h3>–û—Ç–∫—Ä—ã—Ç—ã–µ</h3>
                  </div>
                  <span class="kanban-count count-open">0</span>
                </div>
                <div class="kanban-cards" id="kanban-open"></div>
              </div>
              <div class="kanban-column column-progress" data-status="progress">
                <div class="kanban-header header-progress">
                  <div class="header-content">
                    <div class="header-icon">
                      <i class="fas fa-cogs fa-spin"></i>
                    </div>
                    <h3>–í —Ä–∞–±–æ—Ç–µ</h3>
                  </div>
                  <span class="kanban-count count-progress">0</span>
                </div>
                <div class="kanban-cards" id="kanban-progress"></div>
              </div>
              <div class="kanban-column column-awaiting" data-status="awaiting">
                <div class="kanban-header header-awaiting">
                  <div class="header-content">
                    <div class="header-icon">
                      <i class="fas fa-clock"></i>
                    </div>
                    <h3>–û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞</h3>
                  </div>
                  <span class="kanban-count count-awaiting">0</span>
                </div>
                <div class="kanban-cards" id="kanban-awaiting"></div>
              </div>
              <div class="kanban-column column-closed" data-status="closed">
                <div class="kanban-header header-closed">
                  <div class="header-content">
                    <div class="header-icon">
                      <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>–ó–∞–∫—Ä—ã—Ç—ã–µ</h3>
                  </div>
                  <span class="kanban-count count-closed">0</span>
                </div>
                <div class="kanban-cards" id="kanban-closed"></div>
              </div>
            </div>
          </div>
        `;
        $('.issues-section').append(kanbanHtml);
      }

      $('#kanban-container').show();

      // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –≤ —Ä–µ–∂–∏–º–µ –∫–∞–Ω–±–∞–Ω
      $('.table-footer').hide();

      populateKanbanBoard();
      console.log('üìä –ü–æ–∫–∞–∑–∞–Ω —Ä–µ–∂–∏–º –∫–∞–Ω–±–∞–Ω');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∏
    window.populateKanbanBoard = function () {
      console.log('üìä –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∏...');

      // –û—á–∏—â–∞–µ–º –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏
      $('.kanban-cards').empty();

      // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞!
      const issues = window.issuesData || [];
      console.log('üìä –í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫ –¥–ª—è –ö–∞–Ω–±–∞–Ω:', issues.length);

      if (issues.length === 0) {
        console.warn('‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ö–∞–Ω–±–∞–Ω! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ window.issuesData');
        return;
      }

      // –°—á–µ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      let counters = {
        open: 0,
        progress: 0,
        awaiting: 0,
        closed: 0
      };

      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –∑–∞—è–≤–∫—É
      issues.forEach(function (issue, index) {
        const issueId = issue.id;
        const statusName = issue.status_name;
        const statusId = parseInt(issue.status_id);

        // –û—Ç–ª–∞–¥–∫–∞ –ø–µ—Ä–≤–æ–π –∑–∞—è–≤–∫–∏
        if (index === 0) {
          console.log('üìä –ü–µ—Ä–≤–∞—è –∑–∞—è–≤–∫–∞:', {
            id: issueId,
            subject: issue.subject,
            status: statusName,
            status_id: statusId
          });
        }

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –ø–æ —Å—Ç–∞—Ç—É—Å—É (–¢–û–ß–ù–û –¢–ê –ñ–ï –õ–û–ì–ò–ö–ê, —á—Ç–æ –∏ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ!)
        let columnId = 'kanban-open';
        let category = 'open';
        const normalizedStatus = String(statusName).toLowerCase();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ status_id (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!)
        if (statusId === 9 || statusId === 13 || statusId === 15) {
          columnId = 'kanban-awaiting';
          category = 'awaiting';
        } else if (
          normalizedStatus.includes('–∑–∞–∫—Ä—ã—Ç–∞') ||
          normalizedStatus.includes('–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞') ||
          normalizedStatus.includes('–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞') ||
          normalizedStatus.includes('closed') ||
          normalizedStatus.includes('rejected') ||
          normalizedStatus.includes('redirected')
        ) {
          columnId = 'kanban-closed';
          category = 'closed';
        } else if (
          normalizedStatus.includes('–≤ —Ä–∞–±–æ—Ç–µ') ||
          normalizedStatus.includes('–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞') ||
          normalizedStatus.includes('–Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏') ||
          normalizedStatus.includes('–≤ –æ—á–µ—Ä–µ–¥–∏') ||
          normalizedStatus.includes('–∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞') ||
          normalizedStatus.includes('in progress')
        ) {
          columnId = 'kanban-progress';
          category = 'progress';
        } else if (
          normalizedStatus.includes('–æ—Ç–∫—Ä—ã—Ç–∞') ||
          normalizedStatus.includes('–≤—ã–ø–æ–ª–Ω–µ–Ω–∞') ||
          normalizedStatus.includes('new') ||
          normalizedStatus.includes('open') ||
          normalizedStatus.includes('pending') ||
          normalizedStatus.includes('resolved') ||
          normalizedStatus.includes('—Å–æ–∑–¥–∞–Ω–∞') ||
          normalizedStatus.includes('–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞')
        ) {
          columnId = 'kanban-open';
          category = 'open';
        }

        counters[category]++;

        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏
        const card = createKanbanCardFromData(issue);
        $(`#${columnId}`).append(card);
      });

      console.log('üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –∫–æ–ª–æ–Ω–∫–∞–º:', counters);

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
      $('.kanban-column').each(function () {
        const count = $(this).find('.kanban-card').length;
        $(this).find('.kanban-count').text(count);
      });

      console.log('‚úÖ –ö–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞!');
    }

    // üîß –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏
    window.createKanbanCardFromData = function (issue) {
      const issueId = issue.id;
      const statusId = parseInt(issue.status_id);
      const statusName = issue.status_name;
      const issueDate = issue.created_on || issue.updated_on || '';
      const issueSubject = issue.subject || '–ë–µ–∑ —Ç–µ–º—ã';

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —Å—Ç–∞—Ç—É—Å–∞
      let statusColor = 'status-default';
      let statusIcon = 'fa-circle';

      if (statusId === 9 || statusId === 13 || statusId === 15) {
        statusColor = 'status-awaiting';
        statusIcon = 'fa-clock';
      } else if (statusName.toLowerCase().includes('–∑–∞–∫—Ä—ã—Ç–∞')) {
        statusColor = 'status-closed';
        statusIcon = 'fa-check-circle';
      } else if (statusName.toLowerCase().includes('–≤ —Ä–∞–±–æ—Ç–µ')) {
        statusColor = 'status-progress';
        statusIcon = 'fa-cog fa-spin';
      } else if (statusName.toLowerCase().includes('–æ—Ç–∫—Ä—ã—Ç–∞') || statusName.toLowerCase().includes('–≤—ã–ø–æ–ª–Ω–µ–Ω–∞')) {
        statusColor = 'status-open';
        statusIcon = 'fa-folder-open';
      }

      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
      const $card = $('<div>')
        .addClass('kanban-card modern-card')
        .attr('data-issue-id', issueId)
        .css('cursor', 'pointer')
        .on('click', function () {
          window.location.href = '/my-issues/' + issueId;
        });

      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏
      const $header = $('<div>').addClass('kanban-card-header');
      $header.append(
        $('<div>').addClass('card-id-badge').append(
          $('<i>').addClass('fas fa-hashtag'),
          $('<span>').text(issueId)
        ),
        $('<div>').addClass('card-date').append(
          $('<i>').addClass('far fa-calendar-alt'),
          $('<span>').text(issueDate)
        )
      );

      // –¢–µ–ª–æ –∫–∞—Ä—Ç–æ—á–∫–∏
      const $body = $('<div>').addClass('kanban-card-body');
      $body.append(
        $('<div>').addClass('kanban-card-title').text(issueSubject)
      );

      // –ü–æ–¥–≤–∞–ª –∫–∞—Ä—Ç–æ—á–∫–∏
      const $footer = $('<div>').addClass('kanban-card-footer');
      $footer.append(
        $('<div>').addClass('kanban-card-status ' + statusColor).append(
          $('<i>').addClass('fas ' + statusIcon),
          $('<span>').text(statusName)
        ),
        $('<div>').addClass('card-action-hint').append(
          $('<i>').addClass('fas fa-external-link-alt')
        )
      );

      $card.append($header, $body, $footer);
      return $card;
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞–Ω–±–∞–Ω –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (—Å—Ç–∞—Ä–∞—è, –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    window.createKanbanCard = function ($row) {
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤ —Å—Ç—Ä–æ–∫–∏
      const issueId = $row.data('issue-id');
      const statusId = parseInt($row.data('status-id'));
      const statusName = $row.data('status-name');

      // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —è—á–µ–µ–∫ (—É–∂–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä–æ–º)
      const issueDate = $row.find('td').eq(1).text().trim();
      const issueSubject = $row.find('td').eq(2).text().trim();

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —Å—Ç–∞—Ç—É—Å–∞
      let statusColor = 'status-default';
      let statusIcon = 'fa-circle';

      if (statusId === 9 || statusId === 13 || statusId === 15) {
        statusColor = 'status-awaiting';
        statusIcon = 'fa-clock';
      } else if (statusName.toLowerCase().includes('–∑–∞–∫—Ä—ã—Ç–∞')) {
        statusColor = 'status-closed';
        statusIcon = 'fa-check-circle';
      } else if (statusName.toLowerCase().includes('–≤ —Ä–∞–±–æ—Ç–µ')) {
        statusColor = 'status-progress';
        statusIcon = 'fa-cog fa-spin';
      } else if (statusName.toLowerCase().includes('–æ—Ç–∫—Ä—ã—Ç–∞')) {
        statusColor = 'status-open';
        statusIcon = 'fa-folder-open';
      }

      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å –ø–æ–º–æ—â—å—é jQuery –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
      const $card = $('<div>')
        .addClass('kanban-card modern-card')
        .attr('data-issue-id', issueId)
        .css('cursor', 'pointer')
        .on('click', function () {
          window.location.href = '/my-issues/' + issueId;
        });

      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏
      const $header = $('<div>').addClass('kanban-card-header');
      $header.append(
        $('<div>').addClass('card-id-badge').append(
          $('<i>').addClass('fas fa-hashtag'),
          $('<span>').text(issueId)
        ),
        $('<div>').addClass('card-date').append(
          $('<i>').addClass('far fa-calendar-alt'),
          $('<span>').text(issueDate)
        )
      );

      // –¢–µ–ª–æ –∫–∞—Ä—Ç–æ—á–∫–∏
      const $body = $('<div>').addClass('kanban-card-body');
      $body.append(
        $('<div>').addClass('kanban-card-title').text(issueSubject)
      );

      // –ü–æ–¥–≤–∞–ª –∫–∞—Ä—Ç–æ—á–∫–∏
      const $footer = $('<div>').addClass('kanban-card-footer');
      $footer.append(
        $('<div>').addClass('kanban-card-status ' + statusColor).append(
          $('<i>').addClass('fas ' + statusIcon),
          $('<span>').text(statusName)
        ),
        $('<div>').addClass('card-action-hint').append(
          $('<i>').addClass('fas fa-external-link-alt')
        )
      );

      $card.append($header, $body, $footer);
      return $card;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –≤ DOM
    $(document).ready(function () {
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      if ($("#reset-filter-btn").length === 0) {
        $(".controls-content").append(
          '<div class="reset-filter-container"><button id="reset-filter-btn" class="action-button secondary"><i class="fas fa-times"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button></div>'
        );

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ —Å–±—Ä–æ—Å–∞
        $("#reset-filter-btn").on("click", function () {
          resetStatusFilter();
        });
      }
    });

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü–µ–π –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ç–µ–º—ã
    window.reinitializeTable = function () {
      try {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ–º
        if (window.dataStateManager) {
          window.dataStateManager.saveCurrentState();
        }

        // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É
        if (window.issuesTable && $.fn.DataTable.isDataTable("#issue")) {
          window.issuesTable.destroy();
        }

        // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
        setTimeout(() => {
          initializeTableData();

          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è
          if (window.dataStateManager) {
            setTimeout(() => {
              window.dataStateManager.restoreState();
            }, 200);
          }
        }, 100);
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü—ã:", error);
      }
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
    window.destroyTable = function () {
      try {
        if (window.issuesTable && $.fn.DataTable.isDataTable("#issue")) {
          window.issuesTable.destroy();
          window.issuesTable = null;
        }
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ —Ç–∞–±–ª–∏—Ü—ã:", error);
      }
    };
  });

  // Lazy load background shapes after main content loads
  setTimeout(() => {
    $(".background-shapes").css("opacity", "1");
  }, 500);
</script>

<!-- JavaScript –¥–ª—è –±–ª–æ–∫–∞ "–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏" -->
<script
  src="{{ url_for('static', filename='js/my_issues_activity.js') }}?v={{ cache_buster or '1' }}&force={{ range(1, 999999) | random }}"></script>

<!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Issues Page] üöÄ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –∑–∞–ø—É—Å–∫–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...');
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    setTimeout(function() {
        if (typeof loadRecentActivity === 'function') {
            console.log('[Issues Page] ‚úÖ –§—É–Ω–∫—Ü–∏—è loadRecentActivity –Ω–∞–π–¥–µ–Ω–∞, –≤—ã–∑—ã–≤–∞–µ–º...');
            loadRecentActivity();
        } else {
            console.error('[Issues Page] ‚ùå –§—É–Ω–∫—Ü–∏—è loadRecentActivity –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
        }
    }, 1000);
});
</script>

{% endblock %}
