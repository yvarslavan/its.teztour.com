{% extends 'layout.html' %}

<!-- Preload critical resources -->
<link rel="preload"
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap"
  as="style" onload="this.onload=null;this.rel='stylesheet'" />
<noscript>
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" />
</noscript>

{% block main_page %}
<div class="issues-page-container">
  <!-- Background Shapes - Lazy loaded -->
  <div class="background-shapes" style="opacity: 0; transition: opacity 0.5s ease">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
  </div>

  <!-- Loading Spinner -->
  <div id="loading-spinner" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner-icon">
        <i class="fas fa-cog fa-spin"></i>
      </div>
      <h3>Загрузка заявок...</h3>
      <p>Подключение к системе HelpDesk</p>
    </div>
  </div>

  <!-- Header Section -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-main">
        <div class="header-icon">
          <i class="fas fa-ticket-alt"></i>
        </div>
        <div class="header-text">
          <h1 class="page-title">Мои заявки в ИТ-Департамент</h1>
          <p class="page-subtitle">
            Управление и отслеживание ваших обращений в техническую поддержку
          </p>
        </div>
      </div>
      <div class="header-actions">
        <a href="{{ url_for('main.new_issue') }}" class="action-button primary">
          <i class="fas fa-plus"></i>
          <span>Создать заявку</span>
        </a>
      </div>
    </div>
  </header>

  <!-- Statistics Dashboard -->
  <section class="stats-dashboard">
    <div class="stats-grid">
      <div class="stat-card total expandable" data-category="total">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-chart-pie"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="totalIssues">-</span>
            <span class="stat-label">Всего заявок</span>
          </div>
          <div class="expand-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="stat-details" id="totalDetails">
          <!-- Детализация заполняется JS -->
        </div>
      </div>
      <div class="stat-card open expandable" data-category="open">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-rocket"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="openIssues">-</span>
            <span class="stat-label">Открытых</span>
            <div class="stat-status-list">
              <span class="status-hint">Новая • Открыта • Выполнена</span>
            </div>
          </div>
          <div class="expand-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="stat-details" id="openDetails">
          <!-- Детализация заполняется JS -->
        </div>
      </div>
      <div class="stat-card progress expandable" data-category="progress">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-cogs"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="inProgressIssues">-</span>
            <span class="stat-label">В работе</span>
            <div class="stat-status-list">
              <span class="status-hint">В работе • Приостановлена<br>На тестировании • В очереди</span>
            </div>
          </div>
          <div class="expand-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="stat-details" id="progressDetails">
          <!-- Детализация заполняется JS -->
        </div>
      </div>
      <div class="stat-card awaiting expandable" data-category="awaiting">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="awaitingResponseIssues">-</span>
            <span class="stat-label">Ожидают ответа</span>
            <div class="stat-status-list">
              <span class="status-hint">Запрошено уточнение • Протестирована • На согласовании</span>
            </div>
          </div>
          <div class="expand-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="stat-details" id="awaitingResponseDetails">
          <!-- Детализация заполняется JS -->
        </div>
      </div>
      <div class="stat-card closed expandable" data-category="closed">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-check-double"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="closedIssues">-</span>
            <span class="stat-label">Закрытых</span>
            <div class="stat-status-list">
              <span class="status-hint">Закрыта • Отклонена • Перенаправлена</span>
            </div>
          </div>
          <div class="expand-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="stat-details" id="closedDetails">
          <!-- Детализация заполняется JS -->
        </div>
      </div>
    </div>
  </section>

  <!-- Блок "Активные заявки" - Аккордеон -->
  <section class="recent-activity-section">
    <div class="activity-accordion">
      <!-- Заголовок аккордеона (кликабельный) -->
      <div class="activity-accordion-header" id="activity-accordion-toggle">
        <div class="activity-header-content">
          <div class="activity-title">
            <i class="fas fa-history activity-icon"></i>
            <h2>Активные заявки</h2>
            <span class="activity-badge" id="activity-count-badge" style="display: none;">0</span>
          </div>
          <div class="activity-subtitle">
            <span>Изменения в ваших заявках за последние 10 дней</span>
          </div>
        </div>
        <div class="activity-toggle-icon">
          <i class="fas fa-chevron-down"></i>
        </div>
      </div>

      <!-- Содержимое аккордеона (раскрывающееся) -->
      <div class="activity-accordion-content" id="activity-accordion-content">
        <div class="activity-container" id="recent-activity-container">
          <!-- Спиннер загрузки -->
          <div class="activity-loading" id="activity-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Загрузка активности...</span>
          </div>

          <!-- Список активности (заполняется через JavaScript) -->
          <div class="activity-list" id="activity-list" style="display: none;">
            <!-- Элементы активности будут добавлены через JS -->
          </div>

          <!-- Сообщение об отсутствии данных -->
          <div class="activity-empty" id="activity-empty" style="display: none;">
            <i class="far fa-calendar-times"></i>
            <p>Нет активных заявок</p>
           <span class="activity-empty-hint">Заявки появятся здесь после обновления</span>
          </div>

          <!-- Сообщение об ошибке -->
          <div class="activity-error" id="activity-error" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <p>Ошибка загрузки данных</p>
            <button class="retry-btn" onclick="loadRecentActivity()">
              <i class="fas fa-redo"></i> Повторить
           </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Controls Panel -->
  <section class="controls-panel">
    <div class="controls-content">
      <div class="filters-section">
        <div class="filter-group">
          <div class="filter-item">
            <label class="filter-label">
              <i class="fas fa-filter"></i>
              Статус заявки
            </label>
            <div id="statusFilterContainer" class="filter-container">
              <!-- Динамически заполняется JavaScript -->
            </div>
          </div>
        </div>
        <div class="search-section">
          <label class="search-label">
            <i class="fas fa-search"></i>
            Быстрый поиск
          </label>
          <div id="searchBoxContainer" class="search-container">
            <!-- Динамически заполняется JavaScript -->
          </div>
        </div>
      </div>
      <div class="display-options">
        <div class="display-item">
          <label class="display-label">Показать:</label>
          <div id="lengthContainer" class="length-container">
            <!-- Динамически заполняется JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Issues Table -->
  <section class="issues-section">
    <div class="table-container">
      <div class="table-wrapper">
        <table id="issue" class="issues-table">
          <thead>
            <tr>
              <th class="column-id">
                <div class="column-header">
                  <i class="fas fa-hashtag"></i>
                  <span>ID</span>
                </div>
              </th>
              <th class="column-date">
                <div class="column-header">
                  <i class="fas fa-calendar-alt"></i>
                  <span>Обновлено</span>
                </div>
              </th>
              <th class="column-subject">
                <div class="column-header">
                  <i class="fas fa-envelope"></i>
                  <span>Тема заявки</span>
                </div>
              </th>
              <th class="column-status">
                <div class="column-header">
                  <i class="fas fa-info-circle"></i>
                  <span>Статус</span>
                </div>
              </th>
              <th style="display:none;">Status ID</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <!-- Динамически заполняется JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Table Footer with Info and Pagination -->
    <div class="table-footer">
      <div class="table-info">
        <div id="infoContainer">
          <!-- Динамически заполняется JavaScript -->
        </div>
      </div>
      <div class="table-pagination">
        <div id="paginationContainer">
          <!-- Динамически заполняется JavaScript -->
        </div>
      </div>
    </div>
  </section>
</div>
{% endblock main_page %} {% block styles %}

<!-- Theme-aware styles for Issues page -->
<link rel="stylesheet"
  href="{{ url_for('static', filename='css/issues_theme_fix.css') }}?v={{ cache_buster or '1' }}&force={{ range(1, 999999) | random }}">

<!-- Стили для блока "Активные заявки" -->
<link rel="stylesheet"
  href="{{ url_for('static', filename='css/my_issues_activity.css') }}?v={{ cache_buster or '1' }}&force={{ range(1, 999999) | random }}">

<!-- Base Styles (Always Active) -->
<style id="base-styles">
  /* Fonts will be loaded via preload link in head */

  /* Global Base Styles - Optimized */
  * {
    box-sizing: border-box;
  }

  /* Performance optimizations */
  .stat-card,
  .issues-table,
  .page-header {
    will-change: transform;
    transform: translateZ(0);
  }

  /* Reduce paint operations */
  .stat-details,
  .loading-overlay {
    contain: layout style paint;
  }

  html {
    background: var(--surface-0);
  }

  body {
    background: var(--body-bg);
    color: var(--text-secondary);
    margin: 0;
    padding: 0;
    font-family: var(--font-family-primary);
    overflow-x: hidden;
    transition: background 0.3s ease, color 0.3s ease;
  }

  /* Light Theme Variables (Default) */
  :root {
    /* Spacing System */
    --spacing-xs: 0.25rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
    --spacing-xxl: 3rem;
    --spacing-xxxl: 4rem;

    /* Border Radius */
    --radius-sm: 4px;
    --radius-md: 8px;
    --radius-lg: 12px;
    --radius-xl: 16px;
    --radius-xxl: 24px;

    /* Transitions */
    --transition-fast: 0.15s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 0.5s cubic-bezier(0.4, 0, 0.2, 1);

    /* Typography */
    --font-family-primary: "Inter", -apple-system, BlinkMacSystemFont,
      "Segoe UI", Roboto, sans-serif;
    --font-family-secondary: "Roboto", -apple-system, BlinkMacSystemFont,
      "Segoe UI", sans-serif;

    /* Container Widths */
    --container-max-width: 1400px;
    --container-padding: var(--spacing-lg);

    /* Light Theme Colors */
    --primary-50: #eff6ff;
    --primary-100: #dbeafe;
    --primary-200: #bfdbfe;
    --primary-300: #93c5fd;
    --primary-400: #60a5fa;
    --primary-500: #3b82f6;
    --primary-600: #2563eb;
    --primary-700: #1d4ed8;
    --primary-800: #1e40af;
    --primary-900: #1e3a8a;

    /* Secondary Colors */
    --secondary-50: #f0fdf4;
    --secondary-100: #dcfce7;
    --secondary-200: #bbf7d0;
    --secondary-300: #86efac;
    --secondary-400: #4ade80;
    --secondary-500: #22c55e;
    --secondary-600: #16a34a;
    --secondary-700: #15803d;
    --secondary-800: #166534;
    --secondary-900: #14532d;

    /* Status Colors (Light Theme) */
    --status-open: #0ea5e9;
    --status-open-bg: rgba(14, 165, 233, 0.1);
    --status-progress: #f59e0b;
    --status-progress-bg: rgba(245, 158, 11, 0.1);
    --status-closed: #10b981;
    --status-closed-bg: rgba(16, 185, 129, 0.1);
    --status-clarification: #ec4899;
    --status-clarification-bg: rgba(236, 72, 153, 0.1);
    --status-approval: #8b5cf6;
    --status-approval-bg: rgba(139, 92, 246, 0.1);
    --status-rejected: #ef4444;
    --status-rejected-bg: rgba(239, 68, 68, 0.1);

    /* Surface Colors (Light Theme) */
    --surface-0: #ffffff;
    --surface-1: #f8fafc;
    --surface-2: #f1f5f9;
    --surface-3: #e2e8f0;
    --surface-4: #cbd5e1;
    --surface-5: #94a3b8;
    --surface-glass: rgba(255, 255, 255, 0.8);
    --surface-card: rgba(255, 255, 255, 0.9);

    /* Text Colors (Light Theme) */
    --text-primary: #0f172a;
    --text-secondary: #334155;
    --text-muted: #64748b;
    --text-disabled: #94a3b8;
    --text-on-primary: #ffffff;
    --text-on-surface: #0f172a;

    /* Border & Divider */
    --border-light: #e2e8f0;
    --border-medium: #cbd5e1;
    --border-dark: #94a3b8;
    --divider: #e2e8f0;
    --border-focus: var(--primary-400);

    /* Shadows (Light Theme) */
    --shadow-1: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
    --shadow-2: 0 4px 6px rgba(0, 0, 0, 0.1), 0 2px 4px rgba(0, 0, 0, 0.06);
    --shadow-3: 0 10px 15px rgba(0, 0, 0, 0.1), 0 4px 6px rgba(0, 0, 0, 0.05);
    --shadow-4: 0 20px 25px rgba(0, 0, 0, 0.1), 0 10px 10px rgba(0, 0, 0, 0.04);
    --shadow-5: 0 25px 50px rgba(0, 0, 0, 0.15);
    --shadow-card: 0 4px 6px rgba(0, 0, 0, 0.07);
    --shadow-header: 0 2px 4px rgba(0, 0, 0, 0.06);

    /* Body Background */
    --body-bg: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);

    /* Table Header */
    --table-header-bg: #e9f5ff;
    --table-header-bg-mobile: #d0eaff;
    --table-header-text: #0d47a1;
  }

  /* Dark Theme Variables Override */
  body.dark-theme {
    --body-bg: linear-gradient(135deg, #111827 0%, #1f2937 100%);

    /* Primary Color Palette (Dark Theme) */
    --primary-50: #eef2ff;
    --primary-100: #e0e7ff;
    --primary-200: #c7d2fe;
    --primary-300: #a5b4fc;
    --primary-400: #818cf8;
    --primary-500: #6366f1;
    --primary-600: #4f46e5;
    --primary-700: #4338ca;
    --primary-800: #3730a3;
    --primary-900: #312e81;

    /* Secondary Color Palette */
    --secondary-50: #e8f5e8;
    --secondary-100: #c8e6c9;
    --secondary-200: #a5d6a7;
    --secondary-300: #81c784;
    --secondary-400: #66bb6a;
    --secondary-500: #22c55e;
    --secondary-600: #16a34a;
    --secondary-700: #15803d;
    --secondary-800: #166534;
    --secondary-900: #14532d;

    /* Status Colors (Dark Theme) */
    --status-open: #06b6d4;
    --status-open-bg: rgba(6, 182, 212, 0.15);
    --status-progress: #f97316;
    --status-progress-bg: rgba(249, 115, 22, 0.15);
    --status-closed: #22c55e;
    --status-closed-bg: rgba(34, 197, 94, 0.15);
    --status-clarification: #d946ef;
    --status-clarification-bg: rgba(217, 70, 239, 0.15);
    --status-approval: #8b5cf6;
    --status-approval-bg: rgba(139, 92, 246, 0.15);
    --status-rejected: #ef4444;
    --status-rejected-bg: rgba(239, 68, 68, 0.15);

    /* Surface Colors (Dark Theme) */
    --surface-0: #111827;
    --surface-1: #1f2937;
    --surface-2: #374151;
    --surface-3: #4b5563;
    --surface-4: #6b7280;
    --surface-5: #9ca3af;
    --surface-glass: rgba(31, 41, 55, 0.7);
    --surface-card: rgba(55, 65, 81, 0.6);

    /* Text Colors (Dark Theme) */
    --text-primary: #f9fafb;
    --text-secondary: #e5e7eb;
    --text-muted: #9ca3af;
    --text-disabled: #6b7280;
    --text-on-primary: #ffffff;
    --text-on-surface: #f9fafb;

    /* Border & Divider */
    --border-light: #374151;
    --border-medium: #4b5563;
    --border-dark: #6b7280;
    --divider: #374151;
    --border-focus: var(--primary-400);

    /* Shadows (Dark Theme) */
    --shadow-1: 0 1px 3px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(0, 0, 0, 0.4);
    --shadow-2: 0 3px 6px rgba(0, 0, 0, 0.3), 0 3px 6px rgba(0, 0, 0, 0.4);
    --shadow-3: 0 10px 20px rgba(0, 0, 0, 0.3), 0 6px 6px rgba(0, 0, 0, 0.4);
    --shadow-4: 0 14px 28px rgba(0, 0, 0, 0.4), 0 10px 10px rgba(0, 0, 0, 0.3);
    --shadow-5: 0 19px 38px rgba(0, 0, 0, 0.5), 0 15px 12px rgba(0, 0, 0, 0.4);
    --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.2);
    --shadow-header: 0 4px 20px rgba(0, 0, 0, 0.2);

    /* Table Header */
    --table-header-bg: #374151;
    --table-header-bg-mobile: #4b5563;
    --table-header-text: #f9fafb;
  }

  /* Theme Transition Styles */

  body.theme-switching {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Prevent flickering during theme switch */
  body.theme-switching * {
    transition: background-color 0.3s ease, color 0.3s ease,
      border-color 0.3s ease, box-shadow 0.3s ease !important;
  }

  /* Smooth transitions for all themed elements */
  .stat-card,
  .table-container,
  .page-header,
  .action-button,
  .theme-switcher,
  .loading-content,
  .dataTables_wrapper,
  .dataTables_paginate .paginate_button {
    transition: background-color 0.3s ease, color 0.3s ease,
      border-color 0.3s ease, box-shadow 0.3s ease;
  }

  /* Loading indicator for theme switching */
  body.theme-switching::before {
    content: "";
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.1);
    z-index: 9999;
    pointer-events: none;
    opacity: 0;
    animation: fadeInOut 0.3s ease;
  }

  @keyframes fadeInOut {
    0% {
      opacity: 0;
    }

    50% {
      opacity: 1;
    }

    100% {
      opacity: 0;
    }
  }

  /* Ensure proper contrast in both themes */
  body.light-theme {
    --theme-transition-bg: rgba(255, 255, 255, 0.9);
    --theme-transition-text: #1f2937;
  }

  /* Base S
tyles */
  .issues-page-container {
    max-width: 95vw;
    margin: 0 auto;
    padding: var(--spacing-lg);
    font-family: var(--font-family-primary);
    line-height: 1.6;
    color: var(--text-secondary);
    background: var(--body-bg);
    min-height: 100vh;
    position: relative;
    overflow-x: hidden;
  }

  /* Background Shapes - Optimized */
  .background-shapes {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 0;
    will-change: transform;
  }

  .shape {
    position: absolute;
    background: rgba(99, 102, 241, 0.08);
    border-radius: 50%;
    animation: float 20s ease-in-out infinite;
    will-change: transform;
    transform: translateZ(0);
  }

  .shape-1 {
    width: 350px;
    height: 350px;
    top: 10%;
    left: -10%;
    animation-delay: 0s;
  }

  .shape-2 {
    width: 250px;
    height: 250px;
    top: 60%;
    right: -5%;
    animation-delay: 7s;
  }

  .shape-3 {
    width: 200px;
    height: 200px;
    bottom: 10%;
    left: 20%;
    animation-delay: 14s;
  }

  @keyframes float {

    0%,
    100% {
      transform: translate3d(0, 0, 0) rotate(0deg);
    }

    50% {
      transform: translate3d(-20px, -20px, 0) rotate(3deg);
    }
  }

  /* Loading Overlay - Optimized */
  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(8px);
    z-index: 99999;
    display: none;
    align-items: center;
    justify-content: center;
    will-change: opacity;
  }

  .loading-content {
    text-align: center;
    color: var(--text-primary);
    background: var(--surface-0);
    padding: var(--spacing-xl);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-3);
    border: 1px solid var(--border-light);
  }

  .spinner-icon {
    font-size: 3rem;
    color: var(--primary-600);
    margin-bottom: var(--spacing-lg);
    animation: spin 1.2s linear infinite;
    will-change: transform;
    transform: translateZ(0);
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg) translateZ(0);
    }

    100% {
      transform: rotate(360deg) translateZ(0);
    }
  }

  .loading-content h3 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: var(--spacing-sm);
    color: var(--text-primary);
  }

  .loading-content p {
    font-size: 1rem;
    color: var(--text-secondary);
    margin: 0;
  }

  /* Page Header - Modern Gradient Style */
  .page-header {
    background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #1d4ed8 100%);
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(59, 130, 246, 0.25),
      0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: var(--spacing-xl);
    position: relative;
    z-index: 1;
    animation: slideDown 0.8s ease-out;
    overflow: hidden;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-30px);
    }

    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .page-header::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg,
        rgba(255, 255, 255, 0.1) 0%,
        rgba(255, 255, 255, 0.05) 100%);
    pointer-events: none;
  }

  .header-content {
    padding: 20px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: var(--spacing-lg);
    position: relative;
    z-index: 1;
  }

  .header-main {
    display: flex;
    align-items: center;
    gap: 16px;
    flex: 1;
  }

  .header-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.2);
    color: #ffffff;
    border-radius: 12px;
    font-size: 1.5rem;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    flex-shrink: 0;
    transition: all 0.3s ease;
  }

  .header-icon:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.05);
  }

  .header-text {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .page-title {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0 0 4px 0;
    color: #ffffff;
    letter-spacing: -0.025em;
    line-height: 1.2;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .page-subtitle {
    font-size: 0.95rem;
    color: rgba(255, 255, 255, 0.85);
    margin: 0;
    font-weight: 400;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  .header-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }

  .action-button {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 16px;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.875rem;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
    white-space: nowrap;
    backdrop-filter: blur(10px);
  }

  .action-button.primary {
    background: rgba(255, 255, 255, 0.95);
    color: #1e40af;
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .action-button.primary:hover {
    background: #ffffff;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    color: #1e40af;
    text-decoration: none;
  }

  .action-button.primary:active {
    transform: translateY(0);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .action-button.secondary {
    background: rgba(255, 255, 255, 0.15);
    color: #ffffff;
    border: 1px solid rgba(255, 255, 255, 0.3);
  }

  .action-button.secondary:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    color: #ffffff;
    text-decoration: none;
  }

  /* Theme Switcher */
  .theme-switcher-container {
    margin-left: 8px;
  }

  .theme-switcher {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    color: #ffffff;
    cursor: pointer;
    padding: 10px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    overflow: hidden;
  }

  .theme-switcher:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  /* Улучшенные стили для светлой темы */
  body:not(.dark-theme) .theme-switcher {
    background: rgba(0, 0, 0, 0.08);
    border: 2px solid rgba(0, 0, 0, 0.25);
    color: rgba(0, 0, 0, 0.8);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1),
      inset 0 1px 0 rgba(255, 255, 255, 0.3);
  }

  body:not(.dark-theme) .theme-switcher:hover {
    background: rgba(0, 0, 0, 0.12);
    border-color: rgba(0, 0, 0, 0.4);
    color: rgba(0, 0, 0, 0.95);
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2),
      inset 0 1px 0 rgba(255, 255, 255, 0.4);
    transform: translateY(-2px) scale(1.05);
  }

  /* Дополнительные стили для лучшей видимости в светлой теме */
  body:not(.dark-theme) .theme-switcher::before {
    content: "";
    position: absolute;
    top: -1px;
    left: -1px;
    right: -1px;
    bottom: -1px;
    background: linear-gradient(135deg,
        rgba(0, 0, 0, 0.1),
        rgba(0, 0, 0, 0.05));
    border-radius: 9px;
    z-index: -2;
  }

  /* Улучшенные стили строк таблицы для светлой темы */
  body:not(.dark-theme) .issues-table td {
    background: rgba(0, 0, 0, 0.02);
    border-bottom-color: rgba(0, 0, 0, 0.08);
  }

  body:not(.dark-theme) .issues-table tbody tr:hover {
    background: rgba(102, 126, 234, 0.08);
  }

  body:not(.dark-theme) .issues-table tbody tr:hover td {
    background: rgba(102, 126, 234, 0.06);
    border-bottom-color: rgba(102, 126, 234, 0.2);
  }

  /* Улучшенные стили контейнера таблицы для светлой темы */
  body:not(.dark-theme) .table-container {
    background: rgba(255, 255, 255, 0.9);
    border-color: rgba(0, 0, 0, 0.1);
  }

  /* Улучшенные стили строк таблицы для темной темы */
  body.dark-theme .issues-table td {
    background: rgba(255, 255, 255, 0.05);
    border-bottom-color: rgba(255, 255, 255, 0.1);
  }

  body.dark-theme .issues-table tbody tr:hover td {
    background: rgba(102, 126, 234, 0.12);
    border-bottom-color: rgba(102, 126, 234, 0.3);
  }

  /* Базовые стили иконок theme-switcher */
  .theme-switcher i {
    font-size: 16px;
    transition: all 0.3s ease;
    position: relative;
    z-index: 1;
  }

  /* Логика отображения иконок theme-switcher */
  .theme-switcher .fa-sun {
    display: none !important;
  }

  .theme-switcher .fa-moon {
    display: inline-block !important;
  }

  body.dark-theme .theme-switcher .fa-sun {
    display: inline-block !important;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    font-weight: 900;
  }

  body.dark-theme .theme-switcher .fa-moon {
    display: none !important;
  }

  /* Стили иконок в светлой теме */
  body:not(.dark-theme) .theme-switcher .fa-sun {
    display: none !important;
  }

  body:not(.dark-theme) .theme-switcher .fa-moon {
    display: inline-block !important;
    color: rgba(0, 0, 0, 0.8);
    text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
    font-weight: 900;
  }

  body:not(.dark-theme) .theme-switcher:hover .fa-moon {
    color: rgba(0, 0, 0, 0.95);
    text-shadow: 0 1px 3px rgba(255, 255, 255, 0.7);
    transform: scale(1.1);
  }

  body.dark-theme .theme-switcher:hover .fa-sun {
    color: #fbbf24;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    transform: scale(1.1);
  }

  /* S
tatistics Dashboard */
  .stats-dashboard {
    margin-bottom: var(--spacing-xl);
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: var(--spacing-lg);
    align-items: stretch;
    margin-bottom: var(--spacing-xl);
  }

  .stat-card {
    background: var(--surface-glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-card);
    transition: all var(--transition-normal);
    border-left: 4px solid transparent;
    position: relative;
    overflow: hidden;
    height: 140px;
    display: flex;
    flex-direction: column;
    z-index: 1;
  }

  .stat-card.expandable {
    flex-direction: column;
    cursor: pointer;
  }

  .stat-card.expandable.expanded {
    min-height: 300px;
  }

  .stat-header {
    display: flex;
    align-items: flex-start;
    gap: var(--spacing-md);
    width: 100%;
    padding: var(--spacing-lg);
    flex: 1;
  }

  .expand-arrow {
    margin-left: auto;
    transition: transform var(--transition-normal);
    color: var(--text-tertiary);
    font-size: 0.875rem;
  }

  .stat-card.expanded .expand-arrow {
    transform: rotate(180deg);
  }

  .stat-details {
    display: none;
    width: 100%;
    padding: var(--spacing-lg);
    background: linear-gradient(135deg, var(--surface-1), var(--surface-2));
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid var(--border-light);
    border-radius: 0 0 var(--radius-xl) var(--radius-xl);
    margin-top: 0;
    position: relative;
    z-index: 1;
    overflow: visible;
    min-height: auto;
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  /* Стили для развернутых деталей */
  .stat-card.expanded .stat-details {
    display: block !important;
    opacity: 1;
    visibility: visible;
  }

  /* Стили для категорий */
  .category-group {
    margin-bottom: var(--spacing-lg);
    position: relative;
  }

  .category-group:last-child {
    margin-bottom: 0;
  }

  .category-title {
    font-size: 0.875rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: var(--spacing-md);
    padding: var(--spacing-sm) var(--spacing-md);
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    color: var(--text-on-primary);
    border-radius: var(--radius-lg);
    border: none;
    box-shadow: var(--shadow-1);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    position: relative;
    overflow: hidden;
  }

  .category-title::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg,
        transparent 30%,
        rgba(255, 255, 255, 0.1) 50%,
        transparent 70%);
    transform: translateX(-100%);
    transition: transform 0.6s ease;
  }

  .category-group:hover .category-title::before {
    transform: translateX(100%);
  }

  .status-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md) var(--spacing-lg);
    margin-bottom: var(--spacing-sm);
    background: var(--surface-card);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-normal);
    min-height: 48px;
    position: relative;
    overflow: hidden;
    box-shadow: var(--shadow-1);
  }

  .status-item::before {
    content: "";
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: var(--border-medium);
    transition: all var(--transition-normal);
  }

  .status-item:hover {
    background: var(--surface-2);
    transform: translateY(-2px) translateX(4px);
    box-shadow: var(--shadow-2);
    border-color: var(--primary-300);
  }

  .status-item:hover::before {
    width: 6px;
    background: var(--primary-400);
  }

  .status-item.active {
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    border-color: var(--primary-400);
    box-shadow: var(--shadow-3);
    transform: translateY(-3px) translateX(6px);
    color: var(--text-on-primary);
  }

  .status-item.active::before {
    width: 8px;
    background: var(--text-on-primary);
  }

  .status-item.active .status-name {
    color: var(--text-on-primary);
    font-weight: 600;
  }

  .status-item.active .status-count {
    background: rgba(255, 255, 255, 0.95);
    color: var(--primary-700);
    font-weight: 700;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .reset-filter-container {
    display: flex;
    align-items: flex-end;
  }

  #reset-filter-btn {
    background: linear-gradient(135deg,
        rgba(239, 68, 68, 0.1),
        rgba(239, 68, 68, 0.15));
    border: 1px solid rgba(239, 68, 68, 0.3);
    color: #ef4444;
    transition: all var(--transition-normal);
    padding: var(--spacing-md) var(--spacing-lg);
    border-radius: var(--radius-lg);
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    white-space: nowrap;
    box-shadow: var(--shadow-1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  #reset-filter-btn:hover {
    background: linear-gradient(135deg,
        rgba(239, 68, 68, 0.2),
        rgba(239, 68, 68, 0.25));
    border-color: rgba(239, 68, 68, 0.5);
    transform: translateY(-2px);
    box-shadow: var(--shadow-3);
    color: #dc2626;
  }

  #reset-filter-btn:active {
    transform: translateY(0);
    box-shadow: var(--shadow-1);
  }

  .status-item.open-status::before {
    background: var(--status-open);
  }

  .status-item.open-status:hover::before {
    background: var(--status-open);
    box-shadow: 0 0 8px rgba(14, 165, 233, 0.4);
  }

  .status-item.progress-status::before {
    background: var(--status-progress);
  }

  .status-item.progress-status:hover::before {
    background: var(--status-progress);
    box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
  }

  .status-item.closed-status::before {
    background: var(--status-closed);
  }

  .status-item.closed-status:hover::before {
    background: var(--status-closed);
    box-shadow: 0 0 8px rgba(16, 185, 129, 0.4);
  }

  .status-item.awaiting-status::before {
    background: #f59e0b;
  }

  .status-item.awaiting-status:hover::before {
    background: #f59e0b;
    box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
  }

  .status-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.875rem;
    letter-spacing: 0.025em;
    flex: 1;
  }

  .status-count {
    background: linear-gradient(135deg, var(--surface-3), var(--surface-4));
    color: var(--text-primary);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-xl);
    font-size: 0.75rem;
    font-weight: 700;
    min-width: 32px;
    text-align: center;
    border: 1px solid var(--border-light);
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
    height: 28px;
  }

  .stat-card::before {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: linear-gradient(135deg, currentColor 0%, transparent 70%);
    opacity: 0.05;
    border-radius: 50%;
    transform: translate(30px, -30px);
  }

  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-3);
  }

  .stat-card.total {
    border-left-color: #6366f1;
    color: #6366f1;
    border-left-width: 6px;
  }

  .stat-card.open {
    border-left-color: #10b981;
    color: #10b981;
    border-left-width: 6px;
  }

  .stat-card.progress {
    border-left-color: #f59e0b;
    color: #f59e0b;
    border-left-width: 6px;
  }

  .stat-card.awaiting {
    border-left-color: #8b5cf6;
    color: #8b5cf6;
    border-left-width: 6px;
  }

  .stat-card.closed {
    border-left-color: #06b6d4;
    color: #06b6d4;
    border-left-width: 6px;
  }

  .stat-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 56px;
    height: 56px;
    background: linear-gradient(135deg, currentColor, rgba(255, 255, 255, 0.1));
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    color: var(--text-on-primary);
    font-size: 1.5rem;
    opacity: 0.95;
    flex-shrink: 0;
    transition: all 0.3s ease;
  }

  .stat-content {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-xs);
    flex: 1;
    position: relative;
    z-index: 1;
  }

  .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
  }

  .stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .stat-status-list {
    margin-top: var(--spacing-xs);
  }

  .status-hint {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-weight: 400;
    line-height: 1.3;
    opacity: 0.8;
    font-style: italic;
    display: block;
    max-height: 2.6em;
    overflow: hidden;
    word-wrap: break-word;
  }

  /* C
ontrols Panel */
  .controls-panel {
    background: var(--surface-glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-card);
    margin-bottom: var(--spacing-xl);
    position: relative;
    z-index: 1;
  }

  .controls-content {
    padding: var(--spacing-lg);
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    gap: var(--spacing-lg);
    flex-wrap: wrap;
  }

  .filters-section {
    display: flex;
    gap: var(--spacing-xl);
    align-items: flex-end;
    flex: 1;
  }

  .filter-group {
    display: flex;
    gap: var(--spacing-lg);
    align-items: flex-end;
  }

  .filter-item,
  .search-section,
  .display-item {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .filter-label,
  .search-label,
  .display-label {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: var(--spacing-xs);
  }

  .filter-container select,
  .search-container input,
  .length-container select {
    min-width: 200px;
    padding: var(--spacing-md);
    border: 1px solid var(--border-medium);
    border-radius: var(--radius-md);
    background: var(--surface-2);
    color: var(--text-primary);
    font-size: 0.875rem;
    transition: all var(--transition-fast);
  }

  .f ilter-container select:focus,
  .search-container input:focus,
  .length-container select:focus {
    outline: none;
    border-color: var(--primary-400);
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
  }

  .search-container input {
    min-width: 300px;
  }

  .search-container input::placeholder {
    color: var(--text-muted);
  }

  .display-options {
    display: flex;
    align-items: flex-end;
  }

  .length-container select {
    min-width: 120px;
  }

  /* Issues Section */
  .issues-section {
    background: var(--surface-glass);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-card);
    position: relative;
    z-index: 1;
  }

  /* Table Container */
  .table-container {
    overflow: hidden;
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
    background: rgba(31, 41, 55, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
  }

  .table-wrapper {
    overflow-x: auto;
    position: relative;
    border-radius: 16px;
  }

  /* Issues Table */
  .issues-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    background: transparent;
    font-size: 0.875rem;
  }

  .issues-table thead {
    background: transparent;
  }

  .issues-table th {
    /* Современный градиентный фон с яркими акцентами */
    background: linear-gradient(135deg,
        #667eea 0%,
        #764ba2 25%,
        #6b73ff 50%,
        #9644ff 75%,
        #667eea 100%) !important;

    /* Цвет текста и типографика */
    color: #ffffff !important;
    font-weight: 700 !important;
    font-size: 0.9rem !important;
    letter-spacing: 0.05em !important;
    text-transform: uppercase !important;

    /* Отступы и размеры */
    padding: 1.25rem 1rem !important;

    /* Границы */
    border-bottom: 4px solid #4f46e5 !important;
    border-right: 1px solid rgba(255, 255, 255, 0.2) !important;

    /* Позиционирование */
    position: relative !important;
    vertical-align: middle !important;

    /* Анимации */
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1) !important;

    /* Тени */
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3),
      0 4px 12px rgba(102, 126, 234, 0.25) !important;
  }

  .issues-table th:first-child {
    border-top-left-radius: var(--radius-lg);
  }

  .issues-table th:last-child {
    border-top-right-radius: var(--radius-lg);
    border-right: none !important;
  }

  /* Эффект при наведении на заголовки */
  .issues-table th:hover {
    background: linear-gradient(135deg,
        #5a67d8 0%,
        #6b46c1 25%,
        #5b21b6 50%,
        #7c3aed 75%,
        #5a67d8 100%) !important;

    color: #f8fafc !important;

    /* Легкое поднятие при наведении */
    transform: translateY(-2px) scale(1.02) !important;

    /* Усиленная тень */
    box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4),
      0 8px 24px rgba(102, 126, 234, 0.4), 0 4px 16px rgba(139, 92, 246, 0.3) !important;

    /* Более яркая нижняя граница */
    border-bottom-color: #3730a3 !important;
  }

  /* Стили для содержимого заголовков */
  .column-header {
    display: flex !important;
    align-items: center !important;
    gap: 0.75rem !important;
    white-space: nowrap !important;
    font-weight: inherit !important;
  }

  .column-header i {
    color: #fbbf24 !important;
    font-size: 1rem !important;
    opacity: 0.95 !important;
    transition: all 0.4s ease !important;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
    filter: drop-shadow(0 0 4px rgba(251, 191, 36, 0.5));
  }

  /* Изменение цвета иконок при наведении */
  .issues-table th:hover .column-header i {
    color: #fcd34d !important;
    opacity: 1 !important;
    transform: scale(1.15) rotate(5deg) !important;
    filter: drop-shadow(0 0 8px rgba(252, 211, 77, 0.8));
  }

  /* Текст заголовков */
  .column-header span {
    color: inherit !important;
    font-weight: inherit !important;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3) !important;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
  }

  /* Специфические цвета для разных колонок */
  .issues-table th.column-id .column-header i {
    color: #10b981 !important;
  }

  .issues-table th.column-id:hover .column-header i {
    color: #34d399 !important;
    filter: drop-shadow(0 0 8px rgba(52, 211, 153, 0.8));
  }

  .issues-table th.column-date .column-header i {
    color: #06b6d4 !important;
  }

  .issues-table th.column-date:hover .column-header i {
    color: #22d3ee !important;
    filter: drop-shadow(0 0 8px rgba(34, 211, 238, 0.8));
  }

  .issues-table th.column-subject .column-header i {
    color: #8b5cf6 !important;
  }

  .issues-table th.column-subject:hover .column-header i {
    color: #a78bfa !important;
    filter: drop-shadow(0 0 8px rgba(167, 139, 250, 0.8));
  }

  .issues-table th.column-status .column-header i {
    color: #ef4444 !important;
  }

  .issues-table th.column-status:hover .column-header i {
    color: #f87171 !important;
    filter: drop-shadow(0 0 8px rgba(248, 113, 113, 0.8));
  }

  /* Анимация появления заголовков */
  .issues-table th {
    animation: headerFadeIn 0.6s ease-out forwards;
  }

  @keyframes headerFadeIn {
    0% {
      opacity: 0;
      transform: translateY(-20px);
    }

    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Пульсирующий эффект для активных заголовков при сортировке */
  .issues-table th.sorting_asc,
  .issues-table th.sorting_desc {
    animation: pulseGlow 2s ease-in-out infinite alternate;
  }

  @keyframes pulseGlow {
    0% {
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3),
        0 4px 12px rgba(102, 126, 234, 0.25);
    }

    100% {
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.4),
        0 6px 20px rgba(102, 126, 234, 0.4), 0 0 20px rgba(139, 92, 246, 0.3);
    }
  }

  /* Адаптивные стили для таблицы */
  @media (max-width: 1024px) {
    .issues-table th {
      padding: 1rem 0.875rem !important;
      font-size: 0.8125rem !important;
    }

    .column-header {
      gap: 0.5rem !important;
    }

    .column-header i {
      font-size: 0.875rem !important;
    }
  }

  @media (max-width: 768px) {
    .table-container {
      border-radius: 12px;
    }

    .table-wrapper {
      border-radius: 12px;
    }

    .issues-table th {
      padding: 0.875rem 0.625rem !important;
      font-size: 0.75rem !important;
      letter-spacing: 0.025em !important;
    }

    .column-header {
      gap: 0.375rem !important;
    }

    .column-header i {
      font-size: 0.8125rem !important;
    }

    .issues-table td {
      padding: 0.875rem 0.625rem;
    }

    /* Упрощаем анимации на мобильных для производительности */
    .issues-table th {
      animation: none;
    }

    .issues-table th.sorting_asc,
    .issues-table th.sorting_desc {
      animation: none;
    }

    .issues-table tbody tr:hover {
      transform: translateX(3px) scale(1.005);
    }
  }

  @media (max-width: 480px) {
    .issues-table th {
      padding: 0.75rem 0.5rem !important;
      font-size: 0.6875rem !important;
    }

    .column-header {
      gap: 0.25rem !important;
    }

    .column-header i {
      font-size: 0.75rem !important;
    }

    .issues-table td {
      padding: 0.75rem 0.5rem;
    }

    /* Отключаем сложные эффекты на очень маленьких экранах */
    .issues-table th:hover {
      transform: none !important;
    }

    .issues-table tbody tr:hover {
      transform: translateX(2px);
    }
  }

  .issues-table td {
    padding: var(--spacing-lg);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    vertical-align: middle;
    color: var(--text-primary);
    background: rgba(255, 255, 255, 0.03);
    transition: all 0.3s ease;
  }

  .issues-table tbody tr {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: transparent;
    border-radius: 0;
    position: relative;
  }

  .issues-table tbody tr:hover {
    background: rgba(102, 126, 234, 0.1);
    transform: translateX(6px) scale(1.01);
    box-shadow: inset 4px 0 0 #667eea, 0 4px 20px rgba(102, 126, 234, 0.2),
      0 2px 10px rgba(139, 92, 246, 0.15);
  }

  .issues-table tbody tr:hover td {
    background: rgba(102, 126, 234, 0.08);
    border-bottom-color: rgba(102, 126, 234, 0.3);
  }

  /* Анимация появления строк */
  .issues-table tbody tr {
    animation: rowFadeIn 0.5s ease-out forwards;
  }

  @keyframes rowFadeIn {
    0% {
      opacity: 0;
      transform: translateY(10px);
    }

    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Column Specific Styles */
  .column-id {
    width: 120px;
  }

  .column-date {
    width: 140px;
  }

  .column-subject {
    width: auto;
    min-width: 300px;
  }

  .column-status {
    width: 180px;
  }

  /* Issue ID Link */
  .issue-id-link {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    color: #60a5fa;
    text-decoration: none;
    font-weight: 600;
    transition: all var(--transition-fast);
    padding: var(--spacing-xs) var(--spacing-sm);
    border-radius: var(--radius-sm);
  }

  .issue-id-link:hover {
    color: #93c5fd;
    background: rgba(96, 165, 250, 0.1);
    text-decoration: none;
    transform: translateX(2px);
  }

  .issue-id-link i {
    font-size: 0.75rem;
    opacity: 0.7;
  }

  /* Iss
ue Subject */
  .issue-subject {
    font-weight: 500;
    line-height: 1.4;
    color: var(--text-primary);
    max-width: 400px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .issue-subject-link {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-xs);
    color: #60a5fa;
    text-decoration: none;
    font-weight: 500;
    transition: color 0.2s, background 0.2s;
    border-radius: var(--radius-sm);
    padding: var(--spacing-xs) var(--spacing-sm);
    cursor: pointer;
  }

  .issue-subject-link:hover {
    color: #93c5fd;
    background: rgba(96, 165, 250, 0.1);
    text-decoration: underline;
  }

  .issue-subject-link i {
    font-size: 0.8em;
    opacity: 0.7;
  }

  /* Status Styles */
  .status-cell {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    font-weight: 500;
  }

  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--spacing-sm);
    padding: var(--spacing-sm) var(--spacing-md);
    border-radius: var(--radius-lg);
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    white-space: nowrap;
    border: 1px solid transparent;
  }

  .status-icon {
    font-size: 0.875rem;
  }

  /* Status Color Variants */
  .status-open .status-badge {
    background: var(--status-open-bg);
    color: var(--status-open);
    border-color: var(--status-open);
  }

  .status-progress .status-badge {
    background: var(--status-progress-bg);
    color: var(--status-progress);
    border-color: var(--status-progress);
  }

  .st atus-closed .status-badge {
    background: var(--status-closed-bg);
    color: var(--status-closed);
    border-color: var(--status-closed);
  }

  .status-clarification .status-badge {
    background: var(--status-clarification-bg);
    color: var(--status-clarification);
    border-color: var(--status-clarification);
  }

  .status-approval .status-badge {
    background: var(--status-approval-bg);
    color: var(--status-approval);
    border-color: var(--status-approval);
  }

  .status-rejected .status-badge {
    background: var(--status-rejected-bg);
    color: var(--status-rejected);
    border-color: var(--status-rejected);
  }

  /* Row Status Colors */
  .status-open {
    border-left: 3px solid var(--status-open);
  }

  .status-progress {
    border-left: 3px solid var(--status-progress);
  }

  .status-closed {
    border-left: 3px solid var(--status-closed);
  }

  .status-clarification {
    border-left: 3px solid var(--status-clarification);
  }

  .status-approval {
    border-left: 3px solid var(--status-approval);
  }

  .status-rejected {
    border-left: 3px solid var(--status-rejected);
  }

  /* Table Footer */
  .table-footer {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: var(--spacing-lg);
    background: linear-gradient(135deg,
        rgba(102, 126, 234, 0.1) 0%,
        rgba(139, 92, 246, 0.1) 50%,
        rgba(102, 126, 234, 0.1) 100%);
    border-top: 1px solid rgba(102, 126, 234, 0.3);
    gap: var(--spacing-lg);
    flex-wrap: wrap;
    min-height: 60px;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  .table-info {
    color: var(--text-secondary);
    font-size: 0.875rem;
    flex: 0 0 auto;
    min-width: 200px;
  }

  .table-pagination {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-xs);
    flex: 1 1 auto;
    min-width: 0;
    overflow: hidden;
  }

  /* DataTables Custom Styles */
  .dataTables_wrapper {
    width: 100%;
  }

  .dataTables_wrapper .dataTables_paginate .paginate_button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 36px;
    height: 36px;
    padding: var(--spacing-xs) var(--spacing-md);
    margin: 0 2px;
    border: 1px solid rgba(102, 126, 234, 0.3);
    border-radius: var(--radius-md);
    background: rgba(31, 41, 55, 0.6);
    color: var(--text-primary);
    text-decoration: none;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-color: #667eea;
    color: #ffffff;
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
  }

  .dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background: linear-gradient(135deg, #667eea 0%, #9644ff 100%);
    border-color: #667eea;
    color: #ffffff;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.5);
    transform: scale(1.1);
  }

  .dataTables_wrapper .dataTables_paginate .paginate_button.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .dataTables_wrapper .dataTables_paginate .ellipsis {
    padding: 0 8px;
    color: var(--text-muted, #64748b);
    font-weight: 500;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: var(--spacing-xxxl);
    color: var(--text-secondary);
    width: 100%;
  }

  .empty-state i {
    font-size: 4rem;
    margin-bottom: var(--spacing-lg);
    opacity: 0.5;
  }

  .empty-state h3 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    color: var(--text-primary);
  }

  .empty-state p {
    font-size: 1rem;
    margin-bottom: var(--spacing-xl);
  }

  /* Error
 State */
  .error-state {
    text-align: center;
    padding: var(--spacing-xxxl);
    color: var(--status-rejected);
    width: 100%;
  }

  .error-state i {
    font-size: 4rem;
    margin-bottom: var(--spacing-lg);
    color: var(--status-rejected);
  }

  .error-state h3 {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: var(--spacing-md);
    color: var(--status-rejected);
  }

  .error-state p {
    font-size: 1rem;
    margin-bottom: var(--spacing-xl);
    color: var(--text-secondary);
  }

  /* Responsive Design */
  @media (max-width: 1024px) {
    .issues-page-container {
      padding: var(--spacing-md);
    }

    .header-content {
      flex-direction: column;
      text-align: center;
      gap: var(--spacing-xl);
    }

    .controls-content {
      flex-direction: column;
      align-items: stretch;
      gap: var(--spacing-lg);
    }

    .filters-section {
      flex-direction: column;
      gap: var(--spacing-lg);
    }

    .filter-group {
      flex-direction: column;
      gap: var(--spacing-md);
    }
  }

  @media (max-width: 768px) {
    .header-content {
      flex-direction: column;
      text-align: center;
      gap: 20px;
      padding: 16px 20px;
    }

    .header-main {
      justify-content: center;
      gap: 12px;
    }

    .page-title {
      font-size: 1.5rem;
    }

    .header-icon {
      width: 40px;
      height: 40px;
      font-size: 1.25rem;
    }

    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
      gap: var(--spacing-md);
    }

    .stat-card {
      padding: var(--spacing-md);
    }

    .stat-value {
      font-size: 1.5rem;
    }

    .header-actions {
      flex-direction: row;
      justify-content: center;
      width: 100%;
      gap: 8px;
    }

    .action-button {
      justify-content: center;
      flex: 1;
      max-width: 140px;
      padding: 8px 12px;
      font-size: 0.8rem;
    }

    .theme-switcher {
      width: 36px;
      height: 36px;
      padding: 8px;
    }
  }

  /* Улучшенные переходы между темами */
  .issues-page-container,
  .page-header,
  .stats-dashboard,
  .controls-panel,
  .issues-section {
    transition: all var(--transition-normal);
  }

  /* Предотвращение мерцания при переключении темы */
  .theme-transition {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Сохранение видимости элементов при переключении */
  .preserve-visibility {
    opacity: 1 !important;
    visibility: visible !important;
  }

  /* Плавные переходы для статистических карточек */
  .stat-card .stat-details {
    transition: all var(--transition-normal);
  }

  /* Улучшенные переходы для таблицы */
  .issues-table,
  .issues-table tbody tr {
    transition: background-color var(--transition-fast),
      color var(--transition-fast);
  }

  /* Индикатор переключения темы */
  .theme-switching {
    pointer-events: none;
    opacity: 0.7;
  }

  .theme-switching * {
    transition: none !important;
  }

  /* Стили для кнопок переключения режимов */
  .view-toggle-wrapper {
    display: flex;
    justify-content: center;
    margin: 20px 0;
    padding: 15px;
    background: var(--surface-1);
    border-radius: 12px;
    border: 1px solid var(--border-color);
  }

  .view-toggle-buttons {
    display: flex;
    background: var(--surface-0);
    border-radius: 8px;
    padding: 4px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .view-toggle-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    border: none;
    background: transparent;
    color: var(--text-secondary);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    font-weight: 500;
    min-width: 100px;
    justify-content: center;
  }

  .view-toggle-btn:hover {
    background: var(--surface-2);
    color: var(--text-primary);
    transform: translateY(-1px);
  }

  .view-toggle-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }

  .view-toggle-btn i {
    font-size: 16px;
  }

  /* Стили для канбан-доски */
  .kanban-container {
    margin-top: 20px;
    display: none;
  }

  .kanban-board {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    padding: 20px;
  }

  .kanban-column {
    background: var(--surface-1);
    border-radius: 12px;
    border: 1px solid var(--border-color);
    overflow: hidden;
  }

  .kanban-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px;
    background: var(--surface-2);
    border-bottom: 2px solid var(--border-color);
    position: relative;
    overflow: hidden;
  }

  .kanban-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    transition: opacity 0.3s ease;
  }

  .header-content {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .header-icon {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    font-size: 18px;
    transition: all 0.3s ease;
  }

  .kanban-header h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--text-primary);
  }

  .kanban-count {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 700;
    min-width: 28px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease;
  }

  /* Цветовые схемы для колонок */
  .header-open::before {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  }

  .header-open .header-icon {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
  }

  .count-open {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
  }

  .header-progress::before {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
  }

  .header-progress .header-icon {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: white;
  }

  .count-progress {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: white;
  }

  .header-awaiting::before {
    background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
  }

  .header-awaiting .header-icon {
    background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
    color: white;
  }

  .count-awaiting {
    background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
    color: white;
  }

  .header-closed::before {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
  }

  .header-closed .header-icon {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
  }

  .count-closed {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
  }

  /* Анимация при наведении на колонку */
  .kanban-column:hover .kanban-header::before {
    opacity: 1;
  }

  .kanban-column:hover .header-icon {
    transform: scale(1.1) rotate(5deg);
  }

  .kanban-column:hover .kanban-count {
    transform: scale(1.1);
  }

  .kanban-cards {
    padding: 16px;
    min-height: 200px;
    max-height: 600px;
    overflow-y: auto;
    scroll-behavior: smooth;
  }

  /* Стильный скроллбар для канбан-карточек */
  .kanban-cards::-webkit-scrollbar {
    width: 8px;
  }

  .kanban-cards::-webkit-scrollbar-track {
    background: var(--surface-2);
    border-radius: 10px;
  }

  .kanban-cards::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 10px;
    transition: all 0.3s ease;
  }

  .kanban-cards::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
  }

  /* Современный дизайн карточек */
  .kanban-card {
    background: var(--surface-0);
    border: 2px solid var(--border-color);
    border-radius: 12px;
    padding: 0;
    margin-bottom: 16px;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    overflow: hidden;
    position: relative;
  }

  .kanban-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .kanban-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
    border-color: var(--primary-color);
  }

  .kanban-card:hover::before {
    opacity: 1;
  }

  .kanban-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--surface-1);
    border-bottom: 1px solid var(--border-color);
  }

  .card-id-badge {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 12px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
  }

  .card-id-badge i {
    font-size: 11px;
  }

  .card-date {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    color: var(--text-muted);
    padding: 4px 8px;
    background: var(--surface-2);
    border-radius: 6px;
  }

  .card-date i {
    font-size: 11px;
  }

  .kanban-card-body {
    padding: 16px;
  }

  .kanban-card-title {
    font-size: 14px;
    font-weight: 500;
    color: var(--text-primary);
    line-height: 1.5;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    min-height: 42px;
  }

  .kanban-card-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    background: var(--surface-1);
    border-top: 1px solid var(--border-color);
  }

  .kanban-card-status {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 12px;
    font-weight: 500;
    padding: 6px 12px;
    border-radius: 20px;
    transition: all 0.3s ease;
  }

  .card-action-hint {
    color: var(--text-muted);
    font-size: 12px;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .kanban-card:hover .card-action-hint {
    opacity: 1;
  }

  /* Цветовая индикация статусов */
  .status-open {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: white;
  }

  .status-progress {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: white;
  }

  .status-awaiting {
    background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);
    color: #5a67d8;
  }

  .status-closed {
    background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
    color: #48bb78;
  }

  .status-default {
    background: var(--surface-2);
    color: var(--text-secondary);
  }

  /* Темная тема */
  [data-theme="dark"] .view-toggle-wrapper {
    background: var(--surface-1);
    border-color: var(--border-color);
  }

  [data-theme="dark"] .view-toggle-buttons {
    background: var(--surface-0);
  }

  [data-theme="dark"] .kanban-column {
    background: var(--surface-1);
    border-color: var(--border-color);
  }

  [data-theme="dark"] .kanban-header {
    background: var(--surface-2);
    border-color: var(--border-color);
  }

  [data-theme="dark"] .kanban-card {
    background: var(--surface-0);
    border-color: var(--border-color);
  }

  /* Адаптивность для канбан-доски */
  @media (max-width: 768px) {
    .kanban-board {
      grid-template-columns: 1fr;
      padding: 10px;
      gap: 15px;
    }

    .view-toggle-wrapper {
      margin: 15px 0;
      padding: 10px;
    }

    .view-toggle-btn {
      padding: 10px 16px;
      min-width: 80px;
      font-size: 13px;
    }

    .kanban-cards {
      max-height: 400px;
    }
  }
</style>
{% endblock %}{% block scripts %}
<script>
  // DataStateManager - компонент для сохранения состояния данных
  class DataStateManager {
    constructor() {
      this.tableState = {};
      this.statsState = {};
      this.storageKey = "issuesPageState";
    }

    getDataTable() {
      try {
        return window.issuesTable || window.table || null;
      } catch (e) {
        console.warn("Ошибка получения DataTable:", e);
        return null;
      }
    }

    saveTableState() {
      this.saveCurrentState();
    }

    saveCurrentState() {
      try {
        // Сохраняем состояние таблицы DataTables
        const dt = this.getDataTable();
        if (dt && $.fn.DataTable.isDataTable("#issue")) {
          const tableInfo = dt.page.info();
          const searchValue = dt.search();
          const orderInfo = dt.order();

          this.tableState = {
            page: tableInfo.page,
            length: tableInfo.length,
            search: searchValue,
            order: orderInfo,
            timestamp: Date.now(),
          };
        }

        // Сохраняем состояние статистических карточек
        this.saveStatsState();

        // Сохраняем в localStorage
        this.persistState();
      } catch (error) {
        console.error("Ошибка при сохранении состояния:", error);
      }
    }

    saveStatsState() {
      try {
        const statsCards = document.querySelectorAll(".stat-card");
        this.statsState = {};

        statsCards.forEach((card, index) => {
          const isExpanded = card.classList.contains("expanded");
          const cardId = card.id || `stat-card-${index}`;

          this.statsState[cardId] = {
            expanded: isExpanded,
            visible: !card.classList.contains("hidden"),
          };
        });
      } catch (error) {
        console.error("Ошибка при сохранении состояния статистики:", error);
      }
    }

    restoreState() {
      try {
        // Восстанавливаем состояние таблицы
        this.restoreTableState();

        // Восстанавливаем состояние статистики
        this.restoreStatsState();
      } catch (error) {
        console.error("Ошибка при восстановлении состояния:", error);
      }
    }

    restoreTableState() {
      try {
        const dt = this.getDataTable();
        if (this.tableState && dt && $.fn.DataTable.isDataTable("#issue")) {
          // Восстанавливаем поиск
          if (this.tableState.search) {
            dt.search(this.tableState.search);
          }

          // Восстанавливаем сортировку
          if (this.tableState.order) {
            dt.order(this.tableState.order);
          }

          // Восстанавливаем размер страницы
          if (this.tableState.length) {
            dt.page.len(this.tableState.length);
          }

          // Восстанавливаем текущую страницу
          if (this.tableState.page !== undefined) {
            dt.page(this.tableState.page);
          }

          // Перерисовываем таблицу
          dt.draw(false);
        }
      } catch (error) {
        console.error("Ошибка при восстановлении состояния таблицы:", error);
      }
    }

    restoreStatsState() {
      try {
        if (this.statsState) {
          Object.keys(this.statsState).forEach((cardId) => {
            const card = document.getElementById(cardId);
            if (card) {
              const state = this.statsState[cardId];

              // Восстанавливаем состояние раскрытия
              if (state.expanded) {
                card.classList.add("expanded");
              } else {
                card.classList.remove("expanded");
              }

              // Восстанавливаем видимость
              if (state.visible) {
                card.classList.remove("hidden");
              } else {
                card.classList.add("hidden");
              }
            }
          });
        }
      } catch (error) {
        console.error("Ошибка при восстановлении состояния статистики:", error);
      }
    }

    persistState() {
      try {
        const stateData = {
          table: this.tableState,
          stats: this.statsState,
          timestamp: Date.now(),
        };

        localStorage.setItem(this.storageKey, JSON.stringify(stateData));
      } catch (error) {
        console.warn("Не удалось сохранить состояние в localStorage:", error);
      }
    }

    loadPersistedState() {
      try {
        const savedData = localStorage.getItem(this.storageKey);
        if (savedData) {
          const stateData = JSON.parse(savedData);

          // Проверяем, не устарели ли данные (старше 1 часа)
          const oneHour = 60 * 60 * 1000;
          if (Date.now() - stateData.timestamp < oneHour) {
            this.tableState = stateData.table || {};
            this.statsState = stateData.stats || {};
          }
        }
      } catch (error) {
        console.warn("Не удалось загрузить состояние из localStorage:", error);
      }
    }

    clearState() {
      try {
        this.tableState = {};
        this.statsState = {};
        localStorage.removeItem(this.storageKey);
      } catch (error) {
        console.error("Ошибка при очистке состояния:", error);
      }
    }
  }

  // Optimized DOM Ready with performance improvements
  $(document).ready(function () {
    // Performance optimization: Use requestAnimationFrame for smooth initialization
    requestAnimationFrame(() => {
      // Инициализируем менеджеры
      // ThemeManager уже инициализирован глобально в layout.html
      window.dataStateManager = new DataStateManager();

      // Загружаем сохраненное состояние
      window.dataStateManager.loadPersistedState();

      // Показываем спиннер перед отправкой запроса
      $("#loading-spinner").show();

      // Defer heavy operations
      setTimeout(() => {
        initializeTableData();
      }, 0);
    });

    // Функция для определения стиля статуса
    function getStatusStyle(statusName) {
      let style = {
        trClass: "status-default",
        iconClass: "fas fa-question-circle",
        tooltip: statusName,
        statusTextClass: "",
      };
      const normalizedStatus = String(statusName).toLowerCase();

      if (
        normalizedStatus.includes("закрыта") ||
        normalizedStatus.includes("отклонена") ||
        normalizedStatus.includes("перенаправлена") ||
        normalizedStatus.includes("closed") ||
        normalizedStatus.includes("rejected") ||
        normalizedStatus.includes("redirected")
      ) {
        style.trClass = "status-closed";
        style.iconClass = "fas fa-times-circle";
        style.tooltip = "Заявка окончательно закрыта";
      } else if (
        normalizedStatus.includes("выполнена") ||
        normalizedStatus.includes("resolved")
      ) {
        style.trClass = "status-open";
        style.iconClass = "fas fa-check-circle";
        style.tooltip = "Заявка выполнена, ожидает закрытия";
      } else if (
        normalizedStatus.includes("в работе") ||
        normalizedStatus.includes("приостановлена") ||
        normalizedStatus.includes("на тестировании") ||
        normalizedStatus.includes("в очереди") ||
        normalizedStatus.includes("заморожена") ||
        normalizedStatus.includes("in progress")
      ) {
        style.trClass = "status-progress";
        style.iconClass = "fas fa-clock";
        style.tooltip = "Заявка находится в процессе выполнения";
      } else if (
        normalizedStatus.includes("запрошено уточнение") ||
        normalizedStatus.includes("clarification")
      ) {
        style.trClass = "status-clarification";
        style.iconClass = "fas fa-exclamation-circle";
        style.tooltip = "Требуется ваше уточнение для продолжения работы";
      } else if (
        normalizedStatus.includes("на согласовании") ||
        normalizedStatus.includes("approval")
      ) {
        style.trClass = "status-approval";
        style.iconClass = "fas fa-user-clock";
        style.tooltip = "Заявка ожидает согласования";
      } else if (
        normalizedStatus.includes("открыта") ||
        normalizedStatus.includes("new") ||
        normalizedStatus.includes("open") ||
        normalizedStatus.includes("pending") ||
        normalizedStatus.includes("создана") ||
        normalizedStatus.includes("зарегистрирована")
      ) {
        style.trClass = "status-open";
        style.iconClass = "fas fa-folder-open";
        style.tooltip = "Заявка зарегистрирована и ожидает обработки";
      }
      return style;
    }

    // Функция форматирования даты
    function formatDate(dateString) {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) {
        return "Нет даты";
      }
      return date.toLocaleDateString("ru-RU", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });
    }
    // Функция инициализации данных таблицы с поддержкой кеша
    function initializeTableData() {
      const cacheKey = "my_issues_data_v2";
      const stateKey = "my_issues_table_state_v2";
      const cacheTimeKey = "my_issues_cache_time_v2";
      const cacheExpiry = 10 * 60 * 1000; // 10 минут

      // Проверяем URL параметры
      const urlParams = new URLSearchParams(window.location.search);
      const useCached = urlParams.get("cached") === "1";
      const fromIssueId = urlParams.get("from_issue");

      // Попытка использовать кеш
      if (useCached) {
        const cachedData = sessionStorage.getItem(cacheKey);
        const cacheTimestamp = sessionStorage.getItem(cacheTimeKey);
        const cachedState = sessionStorage.getItem(stateKey);

        if (
          cachedData &&
          cacheTimestamp &&
          Date.now() - parseInt(cacheTimestamp) < cacheExpiry
        ) {
          try {
            const response = JSON.parse(cachedData);
            const tableState = cachedState ? JSON.parse(cachedState) : null;

            console.log("📚 Используем кешированные данные");
            processTableData(response, tableState, fromIssueId);

            // Очищаем URL от параметров кеша
            window.history.replaceState({}, "", "/my-issues");
            return;
          } catch (error) {
            console.warn("⚠️ Ошибка при использовании кеша:", error);
          }
        }
      }

      // Загрузка данных с сервера
      console.log("🌐 Загружаем данные с сервера");
      loadDataFromServer();
    }

    // AJAX запрос для получения данных с сервера
    function loadDataFromServer() {
      $.ajax({
        url: "/get-my-issues",
        method: "GET",
        crossDomain: true,
        xhrFields: {
          withCredentials: true,
        },
        success: function (response) {
          // Кешируем полученные данные
          const cacheKey = "my_issues_data_v2";
          const cacheTimeKey = "my_issues_cache_time_v2";

          try {
            sessionStorage.setItem(cacheKey, JSON.stringify(response));
            sessionStorage.setItem(cacheTimeKey, Date.now().toString());
            console.log("💾 Данные сохранены в кеш");
          } catch (error) {
            console.warn("⚠️ Не удалось сохранить в кеш:", error);
          }

          // Обрабатываем данные
          processTableData(response);
        },
        error: function (xhr, status, error) {
          console.error("Error:", error);
          $("#table-body").html(`
                      <tr>
                          <td></td>
                          <td></td>
                          <td>
                              <div class="error-state">
                                  <i class="fas fa-exclamation-triangle"></i>
                                  <h3>Ошибка загрузки данных</h3>
                                  <p>Не удалось подключиться к системе HelpDesk</p>
                                  <button onclick="location.reload()" class="action-button primary">
                                      <i class="fas fa-refresh"></i>
                                      <span>Попробовать снова</span>
                                  </button>
                              </div>
                          </td>
                          <td></td>
                      </tr>
                  `);
        },
        complete: function () {
          // Скрываем спиннер после завершения запроса
          $("#loading-spinner").hide();
        },
      });
    }
    // Функция анимации чисел - Optimized
    function animateNumber(element, finalNumber) {
      if (finalNumber === 0) {
        element.text("0");
        return;
      }

      let currentNumber = 0;
      const steps = Math.min(20, finalNumber); // Меньше шагов для лучшей производительности
      const increment = finalNumber / steps;
      const duration = Math.min(1000, finalNumber * 30); // Адаптивная длительность
      const stepTime = duration / steps;

      const timer = setInterval(function () {
        currentNumber += increment;
        if (currentNumber >= finalNumber) {
          currentNumber = finalNumber;
          clearInterval(timer);
        }
        element.text(Math.floor(currentNumber));
      }, stepTime);
    }

    // Функция заполнения деталей карточек
    function populateCardDetails(stats) {
      console.log("🔍 populateCardDetails вызвана с:", stats);

      // Проверяем наличие структуры detailsByCategory
      if (!stats || !stats.detailsByCategory) {
        console.error("❌ stats.detailsByCategory не найден:", stats);
        return;
      }

      console.log("📊 detailsByCategory:", stats.detailsByCategory);

      // Вспомогательная функция генерации блока статусов
      function buildCategoryBlock(titleEmojiAndText, categoryMap, itemClass) {
        if (!categoryMap || Object.keys(categoryMap).length === 0) return "";
        let html = `<div class="category-group"><div class="category-title">${titleEmojiAndText}</div>`;
        Object.keys(categoryMap).forEach((status) => {
          const count = categoryMap[status];
          html += `
                      <div class="status-item ${itemClass}" data-status="${status}">
                          <span class="status-name">${status}</span>
                          <span class="status-count">${count}</span>
                      </div>
                  `;
        });
        html += "</div>";
        return html;
      }

      // Заполняем детализацию для всех заявок (total)
      let totalDetailsHTML = "";

      // Группируем по категориям для лучшего отображения
      // Открытые статусы
      totalDetailsHTML += buildCategoryBlock(
        "📂 Открытые",
        stats.detailsByCategory.open,
        "open-status"
      );

      // Статусы в работе
      totalDetailsHTML += buildCategoryBlock(
        "⚙️ В работе",
        stats.detailsByCategory.progress,
        "progress-status"
      );

      // Закрытые статусы
      totalDetailsHTML += buildCategoryBlock(
        "✅ Закрытые",
        stats.detailsByCategory.closed,
        "closed-status"
      );

      // Ожидают ответа
      totalDetailsHTML += buildCategoryBlock(
        "⏳ Ожидают ответа",
        stats.detailsByCategory.awaiting,
        "awaiting-status"
      );

      if (totalDetailsHTML === "") {
        totalDetailsHTML =
          '<div class="status-item"><span class="status-name">Нет данных</span></div>';
      }
      $("#totalDetails").html(totalDetailsHTML);

      // Заполняем детализацию по отдельным карточкам
      let openDetailsHTML = buildCategoryBlock(
        "📂 Открытые",
        stats.detailsByCategory.open,
        "open-status"
      );
      if (openDetailsHTML === "")
        openDetailsHTML =
          '<div class="status-item"><span class="status-name">Нет данных</span></div>';
      $("#openDetails").html(openDetailsHTML);

      let progressDetailsHTML = buildCategoryBlock(
        "⚙️ В работе",
        stats.detailsByCategory.progress,
        "progress-status"
      );
      if (progressDetailsHTML === "")
        progressDetailsHTML =
          '<div class="status-item"><span class="status-name">Нет данных</span></div>';
      $("#progressDetails").html(progressDetailsHTML);

      let closedDetailsHTML = buildCategoryBlock(
        "✅ Закрытые",
        stats.detailsByCategory.closed,
        "closed-status"
      );
      if (closedDetailsHTML === "")
        closedDetailsHTML =
          '<div class="status-item"><span class="status-name">Нет данных</span></div>';
      $("#closedDetails").html(closedDetailsHTML);

      let awaitingDetailsHTML = buildCategoryBlock(
        "⏳ Ожидают ответа",
        stats.detailsByCategory.awaiting,
        "awaiting-status"
      );
      if (awaitingDetailsHTML === "")
        awaitingDetailsHTML =
          '<div class="status-item"><span class="status-name">Нет данных</span></div>';
      $("#awaitingResponseDetails").html(awaitingDetailsHTML);
    } // Функция обработки данных таблицы (общая для кеша и сервера)
    function processTableData(response, savedState, fromIssueId) {
      // 🔧 ИСПРАВЛЕНИЕ: Сохраняем данные для Канбан-доски
      window.issuesData = response.issues || [];
      console.log('💾 Сохранено заявок для Канбан:', window.issuesData.length);

      // Создаем фильтр статусов
      let statusFilter =
        '<select id="status-filter" class="form-control">' +
        '<option value="">Все статусы</option>';

      response.statuses.forEach(function (status) {
        statusFilter += `<option value="${status.name}">${status.name}</option>`;
      });

      statusFilter += "</select>";
      $("#statusFilterContainer").html(statusFilter);

      // Подсчет и отображение статистики
      let stats = {
        total: response.issues.length,
        open: 0,
        inProgress: 0,
        closed: 0,
        awaitingResponse: 0,
        detailsByCategory: {
          open: {},
          progress: {},
          closed: {},
          awaiting: {},
          other: {},
        },
      };

      // Отладка: выводим все заявки для проверки
      console.log('📊 Всего заявок для анализа:', response.issues.length);
      console.log('🔍 Ищем заявки со статусами 9, 13, 15...');

      response.issues.forEach(function (issue) {
        const normalizedStatus = String(issue.status_name).toLowerCase();
        const statusName = issue.status_name;
        const statusId = parseInt(issue.status_id); // Преобразуем в число

        // Отладка: выводим каждую заявку
        // Преобразуем statusId в число для корректного сравнения
        const statusIdNum = parseInt(statusId, 10);
        if (statusIdNum === 9 || statusIdNum === 13 || statusIdNum === 15) {
          console.log(`⏳ НАЙДЕНА! Заявка #${issue.id} "${statusName}" (ID: ${statusId}, тип: ${typeof statusId}) → Ожидают ответа`);
          stats.awaitingResponse++;
          stats.detailsByCategory.awaiting[statusName] =
            (stats.detailsByCategory.awaiting[statusName] || 0) + 1;
        } else if (
          normalizedStatus.includes("закрыта") ||
          normalizedStatus.includes("отклонена") ||
          normalizedStatus.includes("перенаправлена") ||
          normalizedStatus.includes("closed") ||
          normalizedStatus.includes("rejected") ||
          normalizedStatus.includes("redirected")
        ) {
          stats.closed++;
          stats.detailsByCategory.closed[statusName] =
            (stats.detailsByCategory.closed[statusName] || 0) + 1;
        } else if (
          normalizedStatus.includes("в работе") ||
          normalizedStatus.includes("приостановлена") ||
          normalizedStatus.includes("на тестировании") ||
          normalizedStatus.includes("в очереди") ||
          normalizedStatus.includes("заморожена") ||
          normalizedStatus.includes("in progress")
        ) {
          stats.inProgress++;
          stats.detailsByCategory.progress[statusName] =
            (stats.detailsByCategory.progress[statusName] || 0) + 1;
        } else if (
          normalizedStatus.includes("открыта") ||
          normalizedStatus.includes("выполнена") ||
          normalizedStatus.includes("new") ||
          normalizedStatus.includes("open") ||
          normalizedStatus.includes("pending") ||
          normalizedStatus.includes("resolved") ||
          normalizedStatus.includes("создана") ||
          normalizedStatus.includes("зарегистрирована")
        ) {
          stats.open++;
          stats.detailsByCategory.open[statusName] =
            (stats.detailsByCategory.open[statusName] || 0) + 1;
        } else {
          // Другие статусы
          stats.detailsByCategory.other[statusName] =
            (stats.detailsByCategory.other[statusName] || 0) + 1;
        }
      });

      // Отладка: выводим итоговую статистику
      console.log('📊 Итоговая статистика:', {
        total: stats.total,
        open: stats.open,
        inProgress: stats.inProgress,
        closed: stats.closed,
        awaitingResponse: stats.awaitingResponse
      });
      console.log('📋 Детализация "Ожидают ответа":', stats.detailsByCategory.awaiting);

      // Обновляем статистику с анимацией
      animateNumber($("#totalIssues"), stats.total);
      animateNumber($("#openIssues"), stats.open);
      animateNumber($("#inProgressIssues"), stats.inProgress);
      animateNumber($("#closedIssues"), stats.closed);
      animateNumber($("#awaitingResponseIssues"), stats.awaitingResponse);

      // Заполняем детализацию карточек
      populateCardDetails(stats);
      // Инициализируем клики по стат-карточкам
      initStatCards();

      // Заполняем таблицу данными
      if (response.issues.length === 0) {
        $("#table-body").html(`
                  <tr>
                      <td></td>
                      <td></td>
                      <td>
                          <div class="empty-state">
                              <i class="fas fa-inbox"></i>
                              <h3>Заявки не найдены</h3>
                              <p>У вас пока нет заявок в системе</p>
                              <a href="${'{{ url_for("main.new_issue") }}'}" class="action-button primary">
                                  <i class="fas fa-plus"></i>
                                  <span>Создать первую заявку</span>
                              </a>
                          </div>
                      </td>
                      <td></td>
                  </tr>
              `);
      } else {
        let tableBody = "";
        response.issues.forEach(function (issue) {
          let statusInfo = getStatusStyle(issue.status_name);
          tableBody += `
                      <tr class="${statusInfo.trClass}" data-status-id="${issue.status_id || 0}" data-issue-id="${issue.id}" data-status-name="${issue.status_name}">
                          <td>
                              <a href="/my-issues/${issue.id
            }" class="issue-id-link" title="Посмотреть детали заявки">
                                  <i class="fas fa-external-link-alt"></i>
                                  <span>#${issue.id}</span>
                              </a>
                          </td>
                          <td data-sort="${issue.updated_on}">
                              <span title="${new Date(
              issue.updated_on
            ).toLocaleString("ru-RU")}">${formatDate(
              issue.updated_on
            )}</span>
                          </td>
                          <td>
                              <a href="/my-issues/${issue.id
            }" class="issue-subject-link issue-subject" title="${issue.subject
            }">
                                  <i class="fas fa-external-link-alt"></i>
                                  <span>${issue.subject}</span>
                              </a>
                          </td>
                          <td>
                              <div class="status-cell">
                                  <div class="status-badge" title="${statusInfo.tooltip
            }">
                                      <i class="${statusInfo.iconClass
            } status-icon"></i>
                                      <span>${issue.status_name}</span>
                                  </div>
                              </div>
                          </td>
                          <td style="display:none;">${issue.status_id || 0}</td>
                      </tr>
                  `;
        });
        $("#table-body").html(tableBody);
      }

      // Инициализируем DataTables
      let table;
      try {
        table = window.issuesTable = $("#issue").DataTable({
          language: {
            url: "/static/js/datatables/Russian.json",
          },
          order: [[1, "desc"]],
          pageLength: 10,
          lengthMenu: [
            [5, 10, 25, 50],
            [5, 10, 25, 50],
          ],
          pagingType: "full_numbers",
          dom: '<"top"<"left-col"l><"right-col"f>><"clear">rt<"bottom"<"left-col"i><"right-col"p>>',
          deferRender: true, // Optimize rendering
          processing: false, // Disable processing indicator for better UX
          stateSave: false, // We handle state manually
          initComplete: function () {
            // Перемещаем элементы управления
            $(".dataTables_filter").detach().appendTo("#searchBoxContainer");
            $("#searchBoxContainer label")
              .contents()
              .filter(function () {
                return this.nodeType === 3;
              })
              .remove();
            $('#searchBoxContainer input[type="search"]').attr(
              "placeholder",
              "Поиск по заявкам..."
            );

            $(".dataTables_length").detach().appendTo("#lengthContainer");
            $("#lengthContainer label")
              .contents()
              .filter(function () {
                return this.nodeType === 3;
              })
              .remove();

            $(".dataTables_info").detach().appendTo("#infoContainer");
            $(".dataTables_paginate").detach().appendTo("#paginationContainer");

            // Добавляем кнопки переключения режимов просмотра
            const viewToggleHtml = `
              <div class="view-toggle-wrapper" style="margin: 20px 0; text-align: center;">
                <div class="view-toggle-buttons">
                  <button class="view-toggle-btn active" data-view="list" title="Режим списка">
                    <i class="fas fa-list"></i>
                    <span>Список</span>
                  </button>
                  <button class="view-toggle-btn" data-view="kanban" title="Режим карточек">
                    <i class="fas fa-th-large"></i>
                    <span>Карточки</span>
                  </button>
                </div>
              </div>
            `;

            // Добавляем кнопки перед таблицей
            $('.issues-section .table-container').before(viewToggleHtml);

            // Добавляем обработчики кликов
            $('.view-toggle-btn').on('click', function () {
              const viewMode = $(this).data('view');

              // Убираем активный класс со всех кнопок
              $('.view-toggle-btn').removeClass('active');

              // Добавляем активный класс к нажатой кнопке
              $(this).addClass('active');

              // Сохраняем выбранный режим
              localStorage.setItem('issues_view_mode', viewMode);

              // Переключаем режим отображения
              if (viewMode === 'kanban') {
                window.showKanbanView();
              } else {
                window.showListView();
              }

              console.log('🔄 Переключен режим просмотра:', viewMode);
            });

            // Восстанавливаем сохраненный режим
            const savedViewMode = localStorage.getItem('issues_view_mode');
            if (savedViewMode === 'kanban') {
              $('.view-toggle-btn[data-view="kanban"]').trigger('click');
            }
          },
          paging: true,
          info: true,
          searching: true,
          ordering: true,
        });

        // Добавляем обработчик изменения фильтра статусов
        $("#status-filter").on("change", function () {
          let selectedStatus = $(this).val();
          table.column(3).search(selectedStatus).draw();

          // Сохраняем состояние при изменении фильтра
          if (window.dataStateManager) {
            setTimeout(() => {
              window.dataStateManager.saveTableState();
            }, 100);
          }
        });

        // Добавляем обработчики для сохранения состояния при других изменениях
        table.on("page.dt", function () {
          if (window.dataStateManager) {
            setTimeout(() => {
              window.dataStateManager.saveTableState();
            }, 100);
          }
        });

        table.on("length.dt", function () {
          if (window.dataStateManager) {
            setTimeout(() => {
              window.dataStateManager.saveTableState();
            }, 100);
          }
        });

        table.on("order.dt", function () {
          if (window.dataStateManager) {
            setTimeout(() => {
              window.dataStateManager.saveTableState();
            }, 100);
          }
        });

        table.on("search.dt", function () {
          if (window.dataStateManager) {
            setTimeout(() => {
              window.dataStateManager.saveTableState();
            }, 100);
          }
        });
      } catch (error) {
        console.error("❌ Ошибка инициализации DataTables:", error);
      }

      // Восстанавливаем состояние таблицы после инициализации
      if (window.dataStateManager && savedState) {
        setTimeout(() => {
          window.dataStateManager.restoreTableState();
        }, 100);
      }

      // Скрываем спиннер после успешной обработки данных
      $("#loading-spinner").hide();

      // Уведомляем о загрузке данных
      $(document).trigger("dataLoaded");
    }

    // Table initialization moved to requestAnimationFrame above

    // Инициализация поведения стат-карточек - Optimized
    function initStatCards() {
      try {
        $(".stat-card.expandable").each(function () {
          const $card = $(this);
          const $details = $card.find(".stat-details");

          $card.off("click.statToggle").on("click.statToggle", function (e) {
            if (
              $(e.target).is(
                "select, option, input, button, a, .action-button, .status-item"
              )
            )
              return;

            $card.toggleClass("expanded");

            if ($card.hasClass("expanded")) {
              $details
                .css({
                  display: "block",
                  opacity: "0",
                  height: "0",
                  overflow: "hidden",
                })
                .stop(true, true)
                .animate(
                  {
                    opacity: "1",
                    height: $details[0].scrollHeight + "px",
                  },
                  150,
                  function () {
                    $details.css({
                      height: "auto",
                      overflow: "visible",
                    });
                  }
                );
            } else {
              $details.stop(true, true).animate(
                {
                  opacity: "0",
                  height: "0",
                },
                150,
                function () {
                  $details.css("display", "none");
                }
              );
            }
          });
        });

        // Инициализация кликов по статусам для фильтрации
        $(".status-item")
          .off("click.statusFilter")
          .on("click.statusFilter", function (e) {
            e.stopPropagation();
            const $statusItem = $(this);
            const statusText = $statusItem.find(".status-name").text().trim();

            console.log("🔍 Клик по статусу:", statusText);

            // Убираем активный класс со всех статусов
            $(".status-item").removeClass("active");
            // Добавляем активный класс к выбранному статусу
            $statusItem.addClass("active");

            // Фильтруем таблицу по статусу
            filterTableByStatus(statusText);
          });
      } catch (err) {
        console.error("Ошибка инициализации стат-карточек:", err);
      }
    }

    // Функция фильтрации таблицы по статусу
    function filterTableByStatus(statusText) {
      try {
        console.log("🔍 filterTableByStatus вызвана с:", statusText);
        const dt = window.dataStateManager
          ? window.dataStateManager.getDataTable()
          : null;
        console.log("🔍 DataTable instance:", dt);

        if (dt && $.fn.DataTable.isDataTable("#issue")) {
          console.log("🔍 Применяем фильтр по статусу:", statusText);

          // Очищаем предыдущие фильтры
          dt.search("").columns().search("").draw();

          // Применяем фильтр по статусу (колонка 3 - статус)
          if (statusText && statusText !== "Все") {
            dt.column(3).search(statusText, true, false).draw();
            console.log("🔍 Фильтр применен к колонке 3");
          }

          // Сохраняем состояние
          if (window.dataStateManager) {
            window.dataStateManager.saveCurrentState();
          }
        } else {
          console.warn("⚠️ DataTable не найдена или не инициализирована");
        }
      } catch (err) {
        console.error("Ошибка фильтрации по статусу:", err);
      }
    }

    // Функция сброса фильтров
    function resetStatusFilter() {
      try {
        const dt = window.dataStateManager
          ? window.dataStateManager.getDataTable()
          : null;
        if (dt && $.fn.DataTable.isDataTable("#issue")) {
          // Очищаем все фильтры
          dt.search("").columns().search("").draw();

          // Убираем активный класс со всех статусов
          $(".status-item").removeClass("active");

          // Сохраняем состояние
          if (window.dataStateManager) {
            window.dataStateManager.saveCurrentState();
          }
        }
      } catch (err) {
        console.error("Ошибка сброса фильтров:", err);
      }
    }

    // Функция показа режима списка
    window.showListView = function () {
      $('.issues-section .table-container').show();
      $('#kanban-container').hide();

      // Показываем пагинацию в режиме списка
      $('.table-footer').show();

      console.log('📋 Показан режим списка');
    }

    // Функция показа режима канбан
    window.showKanbanView = function () {
      $('.issues-section .table-container').hide();

      // Создаем контейнер для канбан-доски если его нет
      if ($('#kanban-container').length === 0) {
        const kanbanHtml = `
          <div id="kanban-container" class="kanban-container">
            <div class="kanban-board">
              <div class="kanban-column column-open" data-status="open">
                <div class="kanban-header header-open">
                  <div class="header-content">
                    <div class="header-icon">
                      <i class="fas fa-folder-open"></i>
                    </div>
                    <h3>Открытые</h3>
                  </div>
                  <span class="kanban-count count-open">0</span>
                </div>
                <div class="kanban-cards" id="kanban-open"></div>
              </div>
              <div class="kanban-column column-progress" data-status="progress">
                <div class="kanban-header header-progress">
                  <div class="header-content">
                    <div class="header-icon">
                      <i class="fas fa-cogs fa-spin"></i>
                    </div>
                    <h3>В работе</h3>
                  </div>
                  <span class="kanban-count count-progress">0</span>
                </div>
                <div class="kanban-cards" id="kanban-progress"></div>
              </div>
              <div class="kanban-column column-awaiting" data-status="awaiting">
                <div class="kanban-header header-awaiting">
                  <div class="header-content">
                    <div class="header-icon">
                      <i class="fas fa-clock"></i>
                    </div>
                    <h3>Ожидают ответа</h3>
                  </div>
                  <span class="kanban-count count-awaiting">0</span>
                </div>
                <div class="kanban-cards" id="kanban-awaiting"></div>
              </div>
              <div class="kanban-column column-closed" data-status="closed">
                <div class="kanban-header header-closed">
                  <div class="header-content">
                    <div class="header-icon">
                      <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>Закрытые</h3>
                  </div>
                  <span class="kanban-count count-closed">0</span>
                </div>
                <div class="kanban-cards" id="kanban-closed"></div>
              </div>
            </div>
          </div>
        `;
        $('.issues-section').append(kanbanHtml);
      }

      $('#kanban-container').show();

      // Скрываем пагинацию в режиме канбан
      $('.table-footer').hide();

      populateKanbanBoard();
      console.log('📊 Показан режим канбан');
    }

    // Функция заполнения канбан-доски
    window.populateKanbanBoard = function () {
      console.log('📊 Начинаем заполнение канбан-доски...');

      // Очищаем все колонки
      $('.kanban-cards').empty();

      // 🔧 ИСПРАВЛЕНИЕ: Используем те же данные, что и статистика!
      const issues = window.issuesData || [];
      console.log('📊 Всего заявок для Канбан:', issues.length);

      if (issues.length === 0) {
        console.warn('⚠️ Нет данных для Канбан! Проверьте window.issuesData');
        return;
      }

      // Счетчики для отладки
      let counters = {
        open: 0,
        progress: 0,
        awaiting: 0,
        closed: 0
      };

      // Обрабатываем каждую заявку
      issues.forEach(function (issue, index) {
        const issueId = issue.id;
        const statusName = issue.status_name;
        const statusId = parseInt(issue.status_id);

        // Отладка первой заявки
        if (index === 0) {
          console.log('📊 Первая заявка:', {
            id: issueId,
            subject: issue.subject,
            status: statusName,
            status_id: statusId
          });
        }

        // Определяем колонку по статусу (ТОЧНО ТА ЖЕ ЛОГИКА, что и в статистике!)
        let columnId = 'kanban-open';
        let category = 'open';
        const normalizedStatus = String(statusName).toLowerCase();

        // Проверяем по status_id (приоритет!)
        if (statusId === 9 || statusId === 13 || statusId === 15) {
          columnId = 'kanban-awaiting';
          category = 'awaiting';
        } else if (
          normalizedStatus.includes('закрыта') ||
          normalizedStatus.includes('отклонена') ||
          normalizedStatus.includes('перенаправлена') ||
          normalizedStatus.includes('closed') ||
          normalizedStatus.includes('rejected') ||
          normalizedStatus.includes('redirected')
        ) {
          columnId = 'kanban-closed';
          category = 'closed';
        } else if (
          normalizedStatus.includes('в работе') ||
          normalizedStatus.includes('приостановлена') ||
          normalizedStatus.includes('на тестировании') ||
          normalizedStatus.includes('в очереди') ||
          normalizedStatus.includes('заморожена') ||
          normalizedStatus.includes('in progress')
        ) {
          columnId = 'kanban-progress';
          category = 'progress';
        } else if (
          normalizedStatus.includes('открыта') ||
          normalizedStatus.includes('выполнена') ||
          normalizedStatus.includes('new') ||
          normalizedStatus.includes('open') ||
          normalizedStatus.includes('pending') ||
          normalizedStatus.includes('resolved') ||
          normalizedStatus.includes('создана') ||
          normalizedStatus.includes('зарегистрирована')
        ) {
          columnId = 'kanban-open';
          category = 'open';
        }

        counters[category]++;

        // Создаем карточку напрямую из данных заявки
        const card = createKanbanCardFromData(issue);
        $(`#${columnId}`).append(card);
      });

      console.log('📊 Распределение по колонкам:', counters);

      // Обновляем счетчики
      $('.kanban-column').each(function () {
        const count = $(this).find('.kanban-card').length;
        $(this).find('.kanban-count').text(count);
      });

      console.log('✅ Канбан-доска заполнена!');
    }

    // 🔧 НОВАЯ ФУНКЦИЯ: Создание карточки напрямую из данных заявки
    window.createKanbanCardFromData = function (issue) {
      const issueId = issue.id;
      const statusId = parseInt(issue.status_id);
      const statusName = issue.status_name;
      const issueDate = issue.created_on || issue.updated_on || '';
      const issueSubject = issue.subject || 'Без темы';

      // Определяем цвет статуса
      let statusColor = 'status-default';
      let statusIcon = 'fa-circle';

      if (statusId === 9 || statusId === 13 || statusId === 15) {
        statusColor = 'status-awaiting';
        statusIcon = 'fa-clock';
      } else if (statusName.toLowerCase().includes('закрыта')) {
        statusColor = 'status-closed';
        statusIcon = 'fa-check-circle';
      } else if (statusName.toLowerCase().includes('в работе')) {
        statusColor = 'status-progress';
        statusIcon = 'fa-cog fa-spin';
      } else if (statusName.toLowerCase().includes('открыта') || statusName.toLowerCase().includes('выполнена')) {
        statusColor = 'status-open';
        statusIcon = 'fa-folder-open';
      }

      // Создаем карточку
      const $card = $('<div>')
        .addClass('kanban-card modern-card')
        .attr('data-issue-id', issueId)
        .css('cursor', 'pointer')
        .on('click', function () {
          window.location.href = '/my-issues/' + issueId;
        });

      // Заголовок карточки
      const $header = $('<div>').addClass('kanban-card-header');
      $header.append(
        $('<div>').addClass('card-id-badge').append(
          $('<i>').addClass('fas fa-hashtag'),
          $('<span>').text(issueId)
        ),
        $('<div>').addClass('card-date').append(
          $('<i>').addClass('far fa-calendar-alt'),
          $('<span>').text(issueDate)
        )
      );

      // Тело карточки
      const $body = $('<div>').addClass('kanban-card-body');
      $body.append(
        $('<div>').addClass('kanban-card-title').text(issueSubject)
      );

      // Подвал карточки
      const $footer = $('<div>').addClass('kanban-card-footer');
      $footer.append(
        $('<div>').addClass('kanban-card-status ' + statusColor).append(
          $('<i>').addClass('fas ' + statusIcon),
          $('<span>').text(statusName)
        ),
        $('<div>').addClass('card-action-hint').append(
          $('<i>').addClass('fas fa-external-link-alt')
        )
      );

      $card.append($header, $body, $footer);
      return $card;
    }

    // Функция создания карточки канбан из строки таблицы (старая, оставляем для совместимости)
    window.createKanbanCard = function ($row) {
      // Получаем данные из data-атрибутов строки
      const issueId = $row.data('issue-id');
      const statusId = parseInt($row.data('status-id'));
      const statusName = $row.data('status-name');

      // Получаем текст из ячеек (уже экранированный браузером)
      const issueDate = $row.find('td').eq(1).text().trim();
      const issueSubject = $row.find('td').eq(2).text().trim();

      // Определяем цвет статуса
      let statusColor = 'status-default';
      let statusIcon = 'fa-circle';

      if (statusId === 9 || statusId === 13 || statusId === 15) {
        statusColor = 'status-awaiting';
        statusIcon = 'fa-clock';
      } else if (statusName.toLowerCase().includes('закрыта')) {
        statusColor = 'status-closed';
        statusIcon = 'fa-check-circle';
      } else if (statusName.toLowerCase().includes('в работе')) {
        statusColor = 'status-progress';
        statusIcon = 'fa-cog fa-spin';
      } else if (statusName.toLowerCase().includes('открыта')) {
        statusColor = 'status-open';
        statusIcon = 'fa-folder-open';
      }

      // Создаем карточку с помощью jQuery для безопасного экранирования
      const $card = $('<div>')
        .addClass('kanban-card modern-card')
        .attr('data-issue-id', issueId)
        .css('cursor', 'pointer')
        .on('click', function () {
          window.location.href = '/my-issues/' + issueId;
        });

      // Заголовок карточки
      const $header = $('<div>').addClass('kanban-card-header');
      $header.append(
        $('<div>').addClass('card-id-badge').append(
          $('<i>').addClass('fas fa-hashtag'),
          $('<span>').text(issueId)
        ),
        $('<div>').addClass('card-date').append(
          $('<i>').addClass('far fa-calendar-alt'),
          $('<span>').text(issueDate)
        )
      );

      // Тело карточки
      const $body = $('<div>').addClass('kanban-card-body');
      $body.append(
        $('<div>').addClass('kanban-card-title').text(issueSubject)
      );

      // Подвал карточки
      const $footer = $('<div>').addClass('kanban-card-footer');
      $footer.append(
        $('<div>').addClass('kanban-card-status ' + statusColor).append(
          $('<i>').addClass('fas ' + statusIcon),
          $('<span>').text(statusName)
        ),
        $('<div>').addClass('card-action-hint').append(
          $('<i>').addClass('fas fa-external-link-alt')
        )
      );

      $card.append($header, $body, $footer);
      return $card;
    }

    // Добавляем кнопку сброса фильтра в DOM
    $(document).ready(function () {
      // Добавляем кнопку сброса фильтра в панель управления
      if ($("#reset-filter-btn").length === 0) {
        $(".controls-content").append(
          '<div class="reset-filter-container"><button id="reset-filter-btn" class="action-button secondary"><i class="fas fa-times"></i> Сбросить фильтр</button></div>'
        );

        // Обработчик клика по кнопке сброса
        $("#reset-filter-btn").on("click", function () {
          resetStatusFilter();
        });
      }
    });

    // Функции для управления таблицей при переключении темы
    window.reinitializeTable = function () {
      try {
        // Сохраняем текущее состояние перед уничтожением
        if (window.dataStateManager) {
          window.dataStateManager.saveCurrentState();
        }

        // Уничтожаем существующую таблицу
        if (window.issuesTable && $.fn.DataTable.isDataTable("#issue")) {
          window.issuesTable.destroy();
        }

        // Пересоздаем таблицу
        setTimeout(() => {
          initializeTableData();

          // Восстанавливаем состояние после пересоздания
          if (window.dataStateManager) {
            setTimeout(() => {
              window.dataStateManager.restoreState();
            }, 200);
          }
        }, 100);
      } catch (error) {
        console.error("Ошибка при переинициализации таблицы:", error);
      }
    };

    // Функция для безопасного уничтожения таблицы
    window.destroyTable = function () {
      try {
        if (window.issuesTable && $.fn.DataTable.isDataTable("#issue")) {
          window.issuesTable.destroy();
          window.issuesTable = null;
        }
      } catch (error) {
        console.error("Ошибка при уничтожении таблицы:", error);
      }
    };
  });

  // Lazy load background shapes after main content loads
  setTimeout(() => {
    $(".background-shapes").css("opacity", "1");
  }, 500);
</script>

<!-- JavaScript для блока "Активные заявки" -->
<script
  src="{{ url_for('static', filename='js/my_issues_activity.js') }}?v={{ cache_buster or '1' }}&force={{ range(1, 999999) | random }}"></script>

<!-- Автоматическая загрузка активности при готовности страницы -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('[Issues Page] 🚀 Страница загружена, запускаем загрузку активности...');
    // Небольшая задержка для полной загрузки всех элементов
    setTimeout(function() {
        if (typeof loadRecentActivity === 'function') {
            console.log('[Issues Page] ✅ Функция loadRecentActivity найдена, вызываем...');
            loadRecentActivity();
        } else {
            console.error('[Issues Page] ❌ Функция loadRecentActivity не найдена!');
        }
    }, 1000);
});
</script>

{% endblock %}
