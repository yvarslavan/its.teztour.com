{% extends 'layout.html' %}

<!-- Preload critical resources -->
<link rel="preload"
  href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap"
  as="style" onload="this.onload=null;this.rel='stylesheet'" />
<noscript>
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&display=swap" />
</noscript>

{% block main_page %}
<div class="issues-page-container">
  <!-- Background Shapes - Lazy loaded -->
  <div class="background-shapes" style="opacity: 0; transition: opacity 0.5s ease">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
    <div class="shape shape-3"></div>
  </div>

  <!-- Loading Spinner -->
  <div id="loading-spinner" class="loading-overlay">
    <div class="loading-content">
      <div class="spinner-icon">
        <i class="fas fa-cog fa-spin"></i>
      </div>
      <h3>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...</h3>
      <p>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–∏—Å—Ç–µ–º–µ HelpDesk</p>
    </div>
  </div>

  <!-- Header Section -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-main">
        <div class="header-icon">
          <i class="fas fa-ticket-alt"></i>
        </div>
        <div class="header-text">
          <h1 class="page-title">–ú–æ–∏ –∑–∞—è–≤–∫–∏ –≤ –ò–¢-–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç</h1>
          <p class="page-subtitle">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤–∞—à–∏—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π –≤ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É
          </p>
        </div>
      </div>
      <div class="header-actions">
        <a href="{{ url_for('main.new_issue') }}" class="action-button primary">
          <i class="fas fa-plus"></i>
          <span>–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</span>
        </a>
      </div>
    </div>
  </header>

  <!-- Statistics Dashboard -->
  <section class="stats-dashboard">
    <div class="stats-grid">
      <div class="stat-card total expandable" data-category="total">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-chart-pie"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="totalIssues">-</span>
            <span class="stat-label">–í—Å–µ–≥–æ –∑–∞—è–≤–æ–∫</span>
          </div>
          <div class="expand-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="stat-details" id="totalDetails">
          <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
        </div>
      </div>
      <div class="stat-card open expandable" data-category="open">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-rocket"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="openIssues">-</span>
            <span class="stat-label">–û—Ç–∫—Ä—ã—Ç—ã—Ö</span>
            <div class="stat-status-list">
              <span class="status-hint">–ù–æ–≤–∞—è ‚Ä¢ –û—Ç–∫—Ä—ã—Ç–∞ ‚Ä¢ –í—ã–ø–æ–ª–Ω–µ–Ω–∞</span>
            </div>
          </div>
          <div class="expand-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="stat-details" id="openDetails">
          <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
        </div>
      </div>
      <div class="stat-card progress expandable" data-category="progress">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-cogs"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="inProgressIssues">-</span>
            <span class="stat-label">–í —Ä–∞–±–æ—Ç–µ</span>
            <div class="stat-status-list">
              <span class="status-hint">–í —Ä–∞–±–æ—Ç–µ ‚Ä¢ –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞<br>–ù–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ ‚Ä¢ –í –æ—á–µ—Ä–µ–¥–∏</span>
            </div>
          </div>
          <div class="expand-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="stat-details" id="progressDetails">
          <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
        </div>
      </div>
      <div class="stat-card awaiting expandable" data-category="awaiting">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-clock"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="awaitingResponseIssues">-</span>
            <span class="stat-label">–û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞</span>
            <div class="stat-status-list">
              <span class="status-hint">–ó–∞–ø—Ä–æ—à–µ–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ ‚Ä¢ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∞ ‚Ä¢ –ù–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏</span>
            </div>
          </div>
          <div class="expand-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="stat-details" id="awaitingResponseDetails">
          <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
        </div>
      </div>
      <div class="stat-card closed expandable" data-category="closed">
        <div class="stat-header">
          <div class="stat-icon">
            <i class="fas fa-check-double"></i>
          </div>
          <div class="stat-content">
            <span class="stat-value" id="closedIssues">-</span>
            <span class="stat-label">–ó–∞–∫—Ä—ã—Ç—ã—Ö</span>
            <div class="stat-status-list">
              <span class="status-hint">–ó–∞–∫—Ä—ã—Ç–∞ ‚Ä¢ –û—Ç–∫–ª–æ–Ω–µ–Ω–∞ ‚Ä¢ –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞</span>
            </div>
          </div>
          <div class="expand-arrow">
            <i class="fas fa-chevron-down"></i>
          </div>
        </div>
        <div class="stat-details" id="closedDetails">
          <!-- –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JS -->
        </div>
      </div>
    </div>
  </section>

  <!-- –ë–ª–æ–∫ "–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏" - –ê–∫–∫–æ—Ä–¥–µ–æ–Ω -->
  <section class="recent-activity-section">
    <div class="activity-accordion">
      <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω—ã–π) -->
      <div class="activity-accordion-header" id="activity-accordion-toggle">
        <div class="activity-header-content">
          <div class="activity-title">
            <i class="fas fa-history activity-icon"></i>
            <h2>–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏</h2>
            <span class="activity-badge" id="activity-count-badge" style="display: none;">0</span>
          </div>
          <div class="activity-subtitle">
            <span>–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≤–∞—à–∏—Ö –∑–∞—è–≤–∫–∞—Ö –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –¥–Ω–µ–π</span>
          </div>
        </div>
        <div class="activity-toggle-icon">
          <i class="fas fa-chevron-down"></i>
        </div>
      </div>

      <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ (—Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–µ–µ—Å—è) -->
      <div class="activity-accordion-content" id="activity-accordion-content">
        <div class="activity-container" id="recent-activity-container">
          <!-- –°–ø–∏–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
          <div class="activity-loading" id="activity-loading">
            <i class="fas fa-spinner fa-spin"></i>
            <span>–ó–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏...</span>
          </div>

          <!-- –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (–∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript) -->
          <div class="activity-list" id="activity-list" style="display: none;">
            <!-- –≠–ª–µ–º–µ–Ω—Ç—ã –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JS -->
          </div>

          <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö -->
          <div class="activity-empty" id="activity-empty" style="display: none;">
            <i class="far fa-calendar-times"></i>
            <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫</p>
           <span class="activity-empty-hint">–ó–∞—è–≤–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</span>
          </div>

          <!-- –°–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ -->
          <div class="activity-error" id="activity-error" style="display: none;">
            <i class="fas fa-exclamation-circle"></i>
            <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>
            <button class="retry-btn" onclick="loadRecentActivity()">
              <i class="fas fa-redo"></i> –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
           </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Controls Panel -->
  <section class="controls-panel">
    <div class="controls-content">
      <div class="filters-section">
        <div class="filter-group">
          <div class="filter-item">
            <label class="filter-label">
              <i class="fas fa-filter"></i>
              –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
            </label>
            <div id="statusFilterContainer" class="filter-container">
              <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
            </div>
          </div>
        </div>
        <div class="search-section">
          <label class="search-label">
            <i class="fas fa-search"></i>
            –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫
          </label>
          <div id="searchBoxContainer" class="search-container">
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
          </div>
        </div>
      </div>
      <div class="display-options">
        <div class="display-item">
          <label class="display-label">–ü–æ–∫–∞–∑–∞—Ç—å:</label>
          <div id="lengthContainer" class="length-container">
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Issues Table -->
  <section class="issues-section">
    <div class="table-container">
      <div class="table-wrapper">
        <table id="issue" class="issues-table">
          <thead>
            <tr>
              <th class="column-id">
                <div class="column-header">
                  <i class="fas fa-hashtag"></i>
                  <span>ID</span>
                </div>
              </th>
              <th class="column-date">
                <div class="column-header">
                  <i class="fas fa-calendar-alt"></i>
                  <span>–û–±–Ω–æ–≤–ª–µ–Ω–æ</span>
                </div>
              </th>
              <th class="column-subject">
                <div class="column-header">
                  <i class="fas fa-envelope"></i>
                  <span>–¢–µ–º–∞ –∑–∞—è–≤–∫–∏</span>
                </div>
              </th>
              <th class="column-status">
                <div class="column-header">
                  <i class="fas fa-info-circle"></i>
                  <span>–°—Ç–∞—Ç—É—Å</span>
                </div>
              </th>
              <th style="display:none;">Status ID</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Table Footer with Info and Pagination -->
    <div class="table-footer">
      <div class="table-info">
        <div id="infoContainer">
          <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
        </div>
      </div>
      <div class="table-pagination">
        <div id="paginationContainer">
          <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è JavaScript -->
        </div>
      </div>
    </div>
  </section>
</div>
{% endblock main_page %} {% block styles %}

<!-- Theme-aware styles for Issues page -->
<link rel="stylesheet"
  href="{{ url_for('static', filename='css/issues_theme_fix.css') }}?v={{ cache_buster or '1' }}&force={{ range(1, 999999) | random }}">

<!-- –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∞ "–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏" -->
<link rel="stylesheet"
  href="{{ url_for('static', filename='css/my_issues_activity.css') }}?v={{ cache_buster or '1' }}&force={{ range(1, 999999) | random }}">

<!-- Base Styles (Always Active) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/issues_styles.css') }}?v={{ cache_buster or '1' }}&force={{ range(1, 999999) | random }}">
{% endblock %}{% block scripts %}
<script>
  // DataStateManager - –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
  class DataStateManager {
    constructor() {
      this.tableState = {};
      this.statsState = {};
      this.storageKey = "issuesPageState";
      this.maxAgeMs = 60 * 60 * 1000;
    }

    getDataTable() {
      return window.issuesTable || window.table || null;
    }

    isTableReady(dt = this.getDataTable()) {
      return Boolean(dt && $.fn.DataTable.isDataTable("#issue"));
    }

    saveTableState() {
      this.saveCurrentState();
    }

    saveCurrentState() {
      const dt = this.getDataTable();
      if (this.isTableReady(dt)) {
        const info = dt.page.info();

        this.tableState = {
          page: info.page,
          length: info.length,
          search: dt.search(),
          order: dt.order(),
          timestamp: Date.now(),
        };
      }

      this.statsState = this.collectStatsState();
      this.persistState();
    }

    collectStatsState() {
      const state = {};

      document.querySelectorAll(".stat-card").forEach((card, index) => {
        const isExpanded = card.classList.contains("expanded");
        const cardId = card.id || `stat-card-${index}`;

        state[cardId] = {
          expanded: isExpanded,
          visible: !card.classList.contains("hidden"),
        };
      });

      return state;
    }

    restoreState() {
      this.restoreTableState();
      this.restoreStatsState();
    }

    restoreTableState() {
      const dt = this.getDataTable();
      if (!this.isTableReady(dt) || !this.tableState) {
        return;
      }

      const { search, order, length, page } = this.tableState;
      if (search) {
        dt.search(search);
      }
      if (order) {
        dt.order(order);
      }
      if (length) {
        dt.page.len(length);
      }
      if (page !== undefined) {
        dt.page(page);
      }

      dt.draw(false);
    }

    restoreStatsState() {
      if (!this.statsState) {
        return;
      }

      Object.entries(this.statsState).forEach(([cardId, state]) => {
        const card = document.getElementById(cardId);
        if (!card) {
          return;
        }

        card.classList.toggle("expanded", Boolean(state.expanded));
        card.classList.toggle("hidden", !state.visible);
      });
    }

    persistState() {
      try {
        const payload = {
          table: this.tableState,
          stats: this.statsState,
          timestamp: Date.now(),
        };

        localStorage.setItem(this.storageKey, JSON.stringify(payload));
      } catch (error) {
        localStorage.removeItem(this.storageKey);
      }
    }

    loadPersistedState() {
      try {
        const raw = localStorage.getItem(this.storageKey);
        if (!raw) {
          return;
        }

        const parsed = JSON.parse(raw);
        if (Date.now() - (parsed.timestamp || 0) < this.maxAgeMs) {
          this.tableState = parsed.table || {};
          this.statsState = parsed.stats || {};
        } else {
          this.clearState();
        }
      } catch (error) {
        this.clearState();
      }
    }

    resetState() {
      this.tableState = {};
      this.statsState = {};
    }

    clearState() {
      this.resetState();
      localStorage.removeItem(this.storageKey);
    }
  }

  // Optimized DOM Ready with performance improvements
  $(document).ready(function () {
    // Performance optimization: Use requestAnimationFrame for smooth initialization
    requestAnimationFrame(() => {
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä—ã
      // ThemeManager —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≥–ª–æ–±–∞–ª—å–Ω–æ –≤ layout.html
      window.dataStateManager = new DataStateManager();

      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      window.dataStateManager.loadPersistedState();

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞
      $("#loading-spinner").show();

      // Defer heavy operations
      setTimeout(() => {
        initializeTableData();
      }, 0);
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Å—Ç–∏–ª—è —Å—Ç–∞—Ç—É—Å–∞
    function getStatusStyle(statusName) {
      let style = {
        trClass: "status-default",
        iconClass: "fas fa-question-circle",
        tooltip: statusName,
        statusTextClass: "",
      };
      const normalizedStatus = String(statusName).toLowerCase();

      if (
        normalizedStatus.includes("–∑–∞–∫—Ä—ã—Ç–∞") ||
        normalizedStatus.includes("–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞") ||
        normalizedStatus.includes("–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞") ||
        normalizedStatus.includes("closed") ||
        normalizedStatus.includes("rejected") ||
        normalizedStatus.includes("redirected")
      ) {
        style.trClass = "status-closed";
        style.iconClass = "fas fa-times-circle";
        style.tooltip = "–ó–∞—è–≤–∫–∞ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã—Ç–∞";
      } else if (
        normalizedStatus.includes("–≤—ã–ø–æ–ª–Ω–µ–Ω–∞") ||
        normalizedStatus.includes("resolved")
      ) {
        style.trClass = "status-open";
        style.iconClass = "fas fa-check-circle";
        style.tooltip = "–ó–∞—è–≤–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –æ–∂–∏–¥–∞–µ—Ç –∑–∞–∫—Ä—ã—Ç–∏—è";
      } else if (
        normalizedStatus.includes("–≤ —Ä–∞–±–æ—Ç–µ") ||
        normalizedStatus.includes("–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞") ||
        normalizedStatus.includes("–Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏") ||
        normalizedStatus.includes("–≤ –æ—á–µ—Ä–µ–¥–∏") ||
        normalizedStatus.includes("–∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞") ||
        normalizedStatus.includes("in progress")
      ) {
        style.trClass = "status-progress";
        style.iconClass = "fas fa-clock";
        style.tooltip = "–ó–∞—è–≤–∫–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è";
      } else if (
        normalizedStatus.includes("–∑–∞–ø—Ä–æ—à–µ–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ") ||
        normalizedStatus.includes("clarification")
      ) {
        style.trClass = "status-clarification";
        style.iconClass = "fas fa-exclamation-circle";
        style.tooltip = "–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–∞—à–µ —É—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã";
      } else if (
        normalizedStatus.includes("–Ω–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–∏") ||
        normalizedStatus.includes("approval")
      ) {
        style.trClass = "status-approval";
        style.iconClass = "fas fa-user-clock";
        style.tooltip = "–ó–∞—è–≤–∫–∞ –æ–∂–∏–¥–∞–µ—Ç —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è";
      } else if (
        normalizedStatus.includes("–æ—Ç–∫—Ä—ã—Ç–∞") ||
        normalizedStatus.includes("new") ||
        normalizedStatus.includes("open") ||
        normalizedStatus.includes("pending") ||
        normalizedStatus.includes("—Å–æ–∑–¥–∞–Ω–∞") ||
        normalizedStatus.includes("–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞")
      ) {
        style.trClass = "status-open";
        style.iconClass = "fas fa-folder-open";
        style.tooltip = "–ó–∞—è–≤–∫–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∏ –æ–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏";
      }
      return style;
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
    function formatDate(dateString) {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) {
        return "–ù–µ—Ç –¥–∞—Ç—ã";
      }
      return date.toLocaleDateString("ru-RU", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
      });
    }

    const ISSUE_TABLE_COLUMNS = $("#issue thead th").length || 5;

    function buildStateTableRow(contentHtml) {
      const contentCellIndex = Math.floor(ISSUE_TABLE_COLUMNS / 2);
      let cells = "";

      for (let i = 0; i < ISSUE_TABLE_COLUMNS; i += 1) {
        if (i === contentCellIndex) {
          cells += `<td>${contentHtml}</td>`;
        } else {
          cells += "<td></td>";
        }
      }

      return `<tr>${cells}</tr>`;
    }
    function escapeHtml(value) {
      return $("<div>").text(value || "").html();
    }

    function parseJsonSafe(raw) {
      if (!raw) {
        return null;
      }

      try {
        return JSON.parse(raw);
      } catch (error) {
        return null;
      }
    }

    function setSessionValueSafe(key, value) {
      try {
        sessionStorage.setItem(key, value);
        return true;
      } catch (error) {
        sessionStorage.removeItem(key);
        return false;
      }
    }

    function setSessionJsonSafe(key, payload) {
      return setSessionValueSafe(key, JSON.stringify(payload));
    }

    function debounce(fn, delay = 120) {
      let timerId = null;
      const debounced = function (...args) {
        if (timerId) {
          clearTimeout(timerId);
        }
        timerId = setTimeout(() => {
          timerId = null;
          fn.apply(this, args);
        }, delay);
      };
      debounced.cancel = function () {
        if (timerId) {
          clearTimeout(timerId);
          timerId = null;
        }
      };
      return debounced;
    }

    let scheduleTableStateSave = null;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è summary + server-side DataTable
    function initializeTableData() {
      const stateKey = "my_issues_table_state_v2";
      const summaryCacheKey = "my_issues_summary_v1";
      const summaryCacheTimeKey = "my_issues_summary_time_v1";
      const summaryCacheExpiry = 2 * 60 * 1000; // 2 –º–∏–Ω—É—Ç—ã
      const urlParams = new URLSearchParams(window.location.search);
      const fromIssueId = urlParams.get("from_issue");
      const cachedState = sessionStorage.getItem(stateKey);
      const tableState = parseJsonSafe(cachedState);

      const cachedSummary = sessionStorage.getItem(summaryCacheKey);
      const summaryTimestamp = sessionStorage.getItem(summaryCacheTimeKey);

      if (
        cachedSummary &&
        summaryTimestamp &&
        Date.now() - parseInt(summaryTimestamp, 10) < summaryCacheExpiry
      ) {
        const summaryData = parseJsonSafe(cachedSummary);
        if (summaryData) {
          processSummaryData(summaryData, tableState, fromIssueId);
          window.history.replaceState({}, "", "/my-issues");
          return;
        }
        sessionStorage.removeItem(summaryCacheKey);
        sessionStorage.removeItem(summaryCacheTimeKey);
      }

      loadSummaryFromServer(tableState, fromIssueId);
    }

    function loadSummaryFromServer(savedState, fromIssueId) {
      $.ajax({
        url: "/get-my-issues-summary",
        method: "GET",
        crossDomain: true,
        xhrFields: {
          withCredentials: true,
        },
        success: function (response) {
          setSessionJsonSafe("my_issues_summary_v1", response);
          setSessionValueSafe("my_issues_summary_time_v1", Date.now().toString());
          processSummaryData(response, savedState, fromIssueId);
        },
        error: function (xhr, status, error) {
          $("#table-body").html(
            buildStateTableRow(`
              <div class="error-state">
                <i class="fas fa-exclamation-triangle"></i>
                <h3>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</h3>
                <p>–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–∏—Å—Ç–µ–º–µ HelpDesk</p>
                <button onclick="location.reload()" class="action-button primary">
                  <i class="fas fa-refresh"></i>
                  <span>–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</span>
                </button>
              </div>
            `)
          );
          initializeServerSideDataTable(savedState, fromIssueId);
        },
      });
    }

    function buildStatsFromStatusCounts(statusCounts) {
      const stats = {
        total: 0,
        open: 0,
        inProgress: 0,
        closed: 0,
        awaitingResponse: 0,
        detailsByCategory: {
          open: {},
          progress: {},
          closed: {},
          awaiting: {},
          other: {},
        },
      };

      (statusCounts || []).forEach((statusItem) => {
        const count = parseInt(statusItem.count || 0, 10) || 0;
        if (count <= 0) return;

        const statusName = String(statusItem.name || "");
        const normalizedStatus = statusName.toLowerCase();
        const statusId = parseInt(statusItem.id || 0, 10);
        stats.total += count;

        if (statusId === 9 || statusId === 13 || statusId === 15) {
          stats.awaitingResponse += count;
          stats.detailsByCategory.awaiting[statusName] =
            (stats.detailsByCategory.awaiting[statusName] || 0) + count;
        } else if (
          normalizedStatus.includes("–∑–∞–∫—Ä—ã—Ç–∞") ||
          normalizedStatus.includes("–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞") ||
          normalizedStatus.includes("–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞") ||
          normalizedStatus.includes("closed") ||
          normalizedStatus.includes("rejected") ||
          normalizedStatus.includes("redirected")
        ) {
          stats.closed += count;
          stats.detailsByCategory.closed[statusName] =
            (stats.detailsByCategory.closed[statusName] || 0) + count;
        } else if (
          normalizedStatus.includes("–≤ —Ä–∞–±–æ—Ç–µ") ||
          normalizedStatus.includes("–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞") ||
          normalizedStatus.includes("–Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏") ||
          normalizedStatus.includes("–≤ –æ—á–µ—Ä–µ–¥–∏") ||
          normalizedStatus.includes("–∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞") ||
          normalizedStatus.includes("in progress")
        ) {
          stats.inProgress += count;
          stats.detailsByCategory.progress[statusName] =
            (stats.detailsByCategory.progress[statusName] || 0) + count;
        } else if (
          normalizedStatus.includes("–æ—Ç–∫—Ä—ã—Ç–∞") ||
          normalizedStatus.includes("–≤—ã–ø–æ–ª–Ω–µ–Ω–∞") ||
          normalizedStatus.includes("new") ||
          normalizedStatus.includes("open") ||
          normalizedStatus.includes("pending") ||
          normalizedStatus.includes("resolved") ||
          normalizedStatus.includes("—Å–æ–∑–¥–∞–Ω–∞") ||
          normalizedStatus.includes("–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞")
        ) {
          stats.open += count;
          stats.detailsByCategory.open[statusName] =
            (stats.detailsByCategory.open[statusName] || 0) + count;
        } else {
          stats.detailsByCategory.other[statusName] =
            (stats.detailsByCategory.other[statusName] || 0) + count;
        }
      });

      return stats;
    }

    function ensureViewToggleControls() {
      if ($(".view-toggle-wrapper").length === 0) {
        const viewToggleHtml = `
          <div class="view-toggle-wrapper" style="margin: 20px 0; text-align: center;">
            <div class="view-toggle-buttons">
              <button class="view-toggle-btn active" data-view="list" title="–†–µ–∂–∏–º —Å–ø–∏—Å–∫–∞">
                <i class="fas fa-list"></i>
                <span>–°–ø–∏—Å–æ–∫</span>
              </button>
              <button class="view-toggle-btn" data-view="kanban" title="–†–µ–∂–∏–º –∫–∞—Ä—Ç–æ—á–µ–∫">
                <i class="fas fa-th-large"></i>
                <span>–ö–∞—Ä—Ç–æ—á–∫–∏</span>
              </button>
            </div>
          </div>
        `;
        $(".issues-section .table-container").before(viewToggleHtml);
      }

      $(".view-toggle-btn")
        .off("click.viewToggle")
        .on("click.viewToggle", function () {
          const viewMode = $(this).data("view");
          $(".view-toggle-btn").removeClass("active");
          $(this).addClass("active");
          localStorage.setItem("issues_view_mode", viewMode);
          if (viewMode === "kanban") {
            window.showKanbanView();
          } else {
            window.showListView();
          }
        });

      const savedViewMode = localStorage.getItem("issues_view_mode");
      if (savedViewMode === "kanban") {
        $(".view-toggle-btn[data-view='kanban']").addClass("active");
        $(".view-toggle-btn[data-view='list']").removeClass("active");
      } else {
        $(".view-toggle-btn[data-view='list']").addClass("active");
        $(".view-toggle-btn[data-view='kanban']").removeClass("active");
      }
    }

    function processSummaryData(response, savedState, fromIssueId) {
      const statuses = Array.isArray(response.statuses) ? response.statuses : [];
      let statusFilter =
        '<select id="status-filter" class="form-control">' +
        '<option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>';

      statuses.forEach(function (status) {
        statusFilter += `<option value="${escapeHtml(status.name)}">${escapeHtml(
          status.name
        )}</option>`;
      });

      statusFilter += "</select>";
      $("#statusFilterContainer").html(statusFilter);

      const stats = buildStatsFromStatusCounts(response.status_counts || []);
      animateNumber($("#totalIssues"), stats.total);
      animateNumber($("#openIssues"), stats.open);
      animateNumber($("#inProgressIssues"), stats.inProgress);
      animateNumber($("#closedIssues"), stats.closed);
      animateNumber($("#awaitingResponseIssues"), stats.awaitingResponse);
      populateCardDetails(stats);
      initStatCards();

      initializeServerSideDataTable(savedState, fromIssueId);
    }

    function initializeServerSideDataTable(savedState, fromIssueId) {
      if (window.issuesTable && $.fn.DataTable.isDataTable("#issue")) {
        window.issuesTable.destroy();
      }
      $("#table-body").empty();
      if (scheduleTableStateSave && typeof scheduleTableStateSave.cancel === "function") {
        scheduleTableStateSave.cancel();
      }
      scheduleTableStateSave = debounce(() => {
        if (window.dataStateManager) {
          window.dataStateManager.saveTableState();
        }
      }, 120);

      let table;
      try {
        table = window.issuesTable = $("#issue").DataTable({
          language: {
            url: "/static/js/datatables/Russian.json",
            emptyTable: "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ",
            zeroRecords: "–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ",
            processing: "–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞—è–≤–æ–∫...",
          },
          processing: true,
          serverSide: true,
          order: [[1, "desc"]],
          pageLength: 10,
          lengthMenu: [
            [5, 10, 25, 50],
            [5, 10, 25, 50],
          ],
          pagingType: "full_numbers",
          dom: '<"top"<"left-col"l><"right-col"f>><"clear">rt<"bottom"<"left-col"i><"right-col"p>>',
          deferRender: true,
          stateSave: false,
          ajax: {
            url: "/get-my-issues-datatable",
            type: "GET",
            dataSrc: function (json) {
              window.currentIssuesPage = Array.isArray(json.data) ? json.data : [];
              return window.currentIssuesPage;
            },
          },
          columns: [
            {
              data: "id",
              render: function (data, type, row) {
                if (type === "sort" || type === "type") {
                  return Number(data) || 0;
                }
                return `
                  <a href="/my-issues/${row.id}" class="issue-id-link" title="–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏">
                    <i class="fas fa-external-link-alt"></i>
                    <span>#${escapeHtml(String(row.id || ""))}</span>
                  </a>
                `;
              },
            },
            {
              data: "updated_on",
              render: function (data, type) {
                if (type === "sort" || type === "type") {
                  return data || "";
                }
                const titleText = data
                  ? new Date(data).toLocaleString("ru-RU")
                  : "–ù–µ—Ç –¥–∞—Ç—ã";
                return `<span title="${escapeHtml(titleText)}">${escapeHtml(
                  formatDate(data)
                )}</span>`;
              },
            },
            {
              data: "subject",
              render: function (data, type, row) {
                if (type === "sort" || type === "type" || type === "filter") {
                  return data || "";
                }
                const safeSubject = escapeHtml(data || "");
                return `
                  <a href="/my-issues/${row.id}" class="issue-subject-link issue-subject" title="${safeSubject}">
                    <i class="fas fa-external-link-alt"></i>
                    <span>${safeSubject}</span>
                  </a>
                `;
              },
            },
            {
              data: "status_name",
              render: function (data, type, row) {
                if (type === "sort" || type === "type" || type === "filter") {
                  return data || "";
                }
                const statusInfo = getStatusStyle(data || "");
                const safeStatus = escapeHtml(data || "");
                const safeTooltip = escapeHtml(statusInfo.tooltip || "");
                return `
                  <div class="status-cell">
                    <div class="status-badge" title="${safeTooltip}">
                      <i class="${statusInfo.iconClass} status-icon"></i>
                      <span>${safeStatus}</span>
                    </div>
                  </div>
                `;
              },
            },
            {
              data: "status_id",
              visible: false,
              searchable: false,
            },
          ],
          createdRow: function (row, data) {
            const statusInfo = getStatusStyle(data.status_name || "");
            $(row)
              .addClass(statusInfo.trClass)
              .attr("data-status-id", data.status_id || 0)
              .attr("data-issue-id", data.id || "")
              .attr("data-status-name", data.status_name || "");
          },
          initComplete: function () {
            $(".dataTables_filter").detach().appendTo("#searchBoxContainer");
            $("#searchBoxContainer label")
              .contents()
              .filter(function () {
                return this.nodeType === 3;
              })
              .remove();
            $('#searchBoxContainer input[type="search"]').attr(
              "placeholder",
              "–ü–æ–∏—Å–∫ –ø–æ –∑–∞—è–≤–∫–∞–º..."
            );

            $(".dataTables_length").detach().appendTo("#lengthContainer");
            $("#lengthContainer label")
              .contents()
              .filter(function () {
                return this.nodeType === 3;
              })
              .remove();

            $(".dataTables_info").detach().appendTo("#infoContainer");
            $(".dataTables_paginate").detach().appendTo("#paginationContainer");
            ensureViewToggleControls();

            const savedViewMode = localStorage.getItem("issues_view_mode");
            if (savedViewMode === "kanban") {
              window.showKanbanView();
            } else {
              window.showListView();
            }
          },
          paging: true,
          info: true,
          searching: true,
          ordering: true,
        });

        $("#status-filter")
          .off("change")
          .on("change", function () {
            let selectedStatus = $(this).val();
            table.column(3).search(selectedStatus).draw();

            if (scheduleTableStateSave) {
              scheduleTableStateSave();
            }
          });

        table.on("page.dt length.dt order.dt search.dt", function () {
          if (scheduleTableStateSave) {
            scheduleTableStateSave();
          }
        });

        if (window.dataStateManager && savedState) {
          setTimeout(() => {
            window.dataStateManager.restoreTableState();
          }, 100);
        }

        if (fromIssueId) {
          table.one("draw", function () {
            const rowToHighlight = $(
              `#issue tbody tr[data-issue-id="${fromIssueId}"]`
            );
            if (rowToHighlight.length) {
              rowToHighlight.addClass("issue-highlight");
              setTimeout(() => rowToHighlight.removeClass("issue-highlight"), 1600);
            }
          });
        }
      } catch (error) {
        $("#table-body").html(
          buildStateTableRow(`
            <div class="error-state">
              <i class="fas fa-exclamation-triangle"></i>
              <h3>–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü—ã</h3>
              <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</p>
              <button onclick="location.reload()" class="action-button primary">
                <i class="fas fa-refresh"></i>
                <span>–û–±–Ω–æ–≤–∏—Ç—å</span>
              </button>
            </div>
          `)
        );
      } finally {
        $("#loading-spinner").hide();
        $(document).trigger("dataLoaded");
      }
    }
    // –§—É–Ω–∫—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–∏ —á–∏—Å–µ–ª - Optimized
    function animateNumber(element, finalNumber) {
      if (finalNumber === 0) {
        element.text("0");
        return;
      }

      let currentNumber = 0;
      const steps = Math.min(20, finalNumber); // –ú–µ–Ω—å—à–µ —à–∞–≥–æ–≤ –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      const increment = finalNumber / steps;
      const duration = Math.min(1000, finalNumber * 30); // –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
      const stepTime = duration / steps;

      const timer = setInterval(function () {
        currentNumber += increment;
        if (currentNumber >= finalNumber) {
          currentNumber = finalNumber;
          clearInterval(timer);
        }
        element.text(Math.floor(currentNumber));
      }, stepTime);
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∫–∞—Ä—Ç–æ—á–µ–∫
    function populateCardDetails(stats) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã detailsByCategory
      if (!stats || !stats.detailsByCategory) {
        return;
      }

      // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–∞ —Å—Ç–∞—Ç—É—Å–æ–≤
      function buildCategoryBlock(titleEmojiAndText, categoryMap, itemClass) {
        if (!categoryMap || Object.keys(categoryMap).length === 0) return "";
        let html = `<div class="category-group"><div class="category-title">${titleEmojiAndText}</div>`;
        Object.keys(categoryMap).forEach((status) => {
          const count = categoryMap[status];
          html += `
                      <div class="status-item ${itemClass}" data-status="${status}">
                          <span class="status-name">${status}</span>
                          <span class="status-count">${count}</span>
                      </div>
                  `;
        });
        html += "</div>";
        return html;
      }

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫ (total)
      let totalDetailsHTML = "";

      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –¥–ª—è –ª—É—á—à–µ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
      // –û—Ç–∫—Ä—ã—Ç—ã–µ —Å—Ç–∞—Ç—É—Å—ã
      totalDetailsHTML += buildCategoryBlock(
        "üìÇ –û—Ç–∫—Ä—ã—Ç—ã–µ",
        stats.detailsByCategory.open,
        "open-status"
      );

      // –°—Ç–∞—Ç—É—Å—ã –≤ —Ä–∞–±–æ—Ç–µ
      totalDetailsHTML += buildCategoryBlock(
        "‚öôÔ∏è –í —Ä–∞–±–æ—Ç–µ",
        stats.detailsByCategory.progress,
        "progress-status"
      );

      // –ó–∞–∫—Ä—ã—Ç—ã–µ —Å—Ç–∞—Ç—É—Å—ã
      totalDetailsHTML += buildCategoryBlock(
        "‚úÖ –ó–∞–∫—Ä—ã—Ç—ã–µ",
        stats.detailsByCategory.closed,
        "closed-status"
      );

      // –û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞
      totalDetailsHTML += buildCategoryBlock(
        "‚è≥ –û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞",
        stats.detailsByCategory.awaiting,
        "awaiting-status"
      );

      if (totalDetailsHTML === "") {
        totalDetailsHTML =
          '<div class="status-item"><span class="status-name">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span></div>';
      }
      $("#totalDetails").html(totalDetailsHTML);

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ –æ—Ç–¥–µ–ª—å–Ω—ã–º –∫–∞—Ä—Ç–æ—á–∫–∞–º
      let openDetailsHTML = buildCategoryBlock(
        "üìÇ –û—Ç–∫—Ä—ã—Ç—ã–µ",
        stats.detailsByCategory.open,
        "open-status"
      );
      if (openDetailsHTML === "")
        openDetailsHTML =
          '<div class="status-item"><span class="status-name">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span></div>';
      $("#openDetails").html(openDetailsHTML);

      let progressDetailsHTML = buildCategoryBlock(
        "‚öôÔ∏è –í —Ä–∞–±–æ—Ç–µ",
        stats.detailsByCategory.progress,
        "progress-status"
      );
      if (progressDetailsHTML === "")
        progressDetailsHTML =
          '<div class="status-item"><span class="status-name">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span></div>';
      $("#progressDetails").html(progressDetailsHTML);

      let closedDetailsHTML = buildCategoryBlock(
        "‚úÖ –ó–∞–∫—Ä—ã—Ç—ã–µ",
        stats.detailsByCategory.closed,
        "closed-status"
      );
      if (closedDetailsHTML === "")
        closedDetailsHTML =
          '<div class="status-item"><span class="status-name">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span></div>';
      $("#closedDetails").html(closedDetailsHTML);

      let awaitingDetailsHTML = buildCategoryBlock(
        "‚è≥ –û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞",
        stats.detailsByCategory.awaiting,
        "awaiting-status"
      );
      if (awaitingDetailsHTML === "")
        awaitingDetailsHTML =
          '<div class="status-item"><span class="status-name">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span></div>';
      $("#awaitingResponseDetails").html(awaitingDetailsHTML);
    }

    // Table initialization moved to requestAnimationFrame above

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–≤–µ–¥–µ–Ω–∏—è —Å—Ç–∞—Ç-–∫–∞—Ä—Ç–æ—á–µ–∫ - Optimized
    function initStatCards() {
      $(".stat-card.expandable").each(function () {
        const $card = $(this);
        const $details = $card.find(".stat-details");

        $card.off("click.statToggle").on("click.statToggle", function (e) {
          if (
            $(e.target).is(
              "select, option, input, button, a, .action-button, .status-item"
            )
          )
            return;

          $card.toggleClass("expanded");

          if ($card.hasClass("expanded")) {
            $details
              .css({
                display: "block",
                opacity: "0",
                height: "0",
                overflow: "hidden",
              })
              .stop(true, true)
              .animate(
                {
                  opacity: "1",
                  height: $details[0].scrollHeight + "px",
                },
                150,
                function () {
                  $details.css({
                    height: "auto",
                    overflow: "visible",
                  });
                }
              );
          } else {
            $details.stop(true, true).animate(
              {
                opacity: "0",
                height: "0",
              },
              150,
              function () {
                $details.css("display", "none");
              }
            );
          }
        });
      });

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–∫–æ–≤ –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
      $(".status-item")
        .off("click.statusFilter")
        .on("click.statusFilter", function (e) {
          e.stopPropagation();
          const $statusItem = $(this);
          const statusText = $statusItem.find(".status-name").text().trim();

          // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
          $(".status-item").removeClass("active");
          // –î–æ–±–∞–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å –∫ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Å—Ç–∞—Ç—É—Å—É
          $statusItem.addClass("active");

          // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É –ø–æ —Å—Ç–∞—Ç—É—Å—É
          filterTableByStatus(statusText);
        });
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —Ç–∞–±–ª–∏—Ü—ã –ø–æ —Å—Ç–∞—Ç—É—Å—É
    function filterTableByStatus(statusText) {
      const dt = window.dataStateManager
        ? window.dataStateManager.getDataTable()
        : null;

      if (dt && $.fn.DataTable.isDataTable("#issue")) {
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã
        dt.search("").columns().search("").draw();

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É (–∫–æ–ª–æ–Ω–∫–∞ 3 - —Å—Ç–∞—Ç—É—Å)
        if (statusText && statusText !== "–í—Å–µ") {
          dt.column(3).search(statusText).draw();
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        if (scheduleTableStateSave) {
          scheduleTableStateSave();
        } else if (window.dataStateManager) {
          window.dataStateManager.saveTableState();
        }
      }
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function resetStatusFilter() {
      const dt = window.dataStateManager
        ? window.dataStateManager.getDataTable()
        : null;
      if (dt && $.fn.DataTable.isDataTable("#issue")) {
        // –û—á–∏—â–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
        dt.search("").columns().search("").draw();

        // –£–±–∏—Ä–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª–∞—Å—Å —Å–æ –≤—Å–µ—Ö —Å—Ç–∞—Ç—É—Å–æ–≤
        $(".status-item").removeClass("active");

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        if (scheduleTableStateSave) {
          scheduleTableStateSave();
        } else if (window.dataStateManager) {
          window.dataStateManager.saveTableState();
        }
      }
    }

    let kanbanLoadPromise = null;
    async function loadIssuesForKanban(forceReload = false) {
      const cacheKey = "my_issues_kanban_data_v1";
      const cacheTimeKey = "my_issues_kanban_time_v1";
      const cacheTtl = 5 * 60 * 1000;

      if (
        !forceReload &&
        Array.isArray(window.issuesData) &&
        window.issuesData.length > 0
      ) {
        return window.issuesData;
      }

      if (!forceReload) {
        const cachedData = sessionStorage.getItem(cacheKey);
        const cachedTime = sessionStorage.getItem(cacheTimeKey);
        if (
          cachedData &&
          cachedTime &&
          Date.now() - parseInt(cachedTime, 10) < cacheTtl
        ) {
          const parsedCachedData = parseJsonSafe(cachedData);
          if (Array.isArray(parsedCachedData)) {
            window.issuesData = parsedCachedData;
            return window.issuesData;
          }
          sessionStorage.removeItem(cacheKey);
          sessionStorage.removeItem(cacheTimeKey);
        }
      }

      if (kanbanLoadPromise) {
        return kanbanLoadPromise;
      }

      kanbanLoadPromise = fetch("/get-my-issues", {
        method: "GET",
        credentials: "include",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
        },
      })
        .then((response) => {
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          return response.json();
        })
        .then((payload) => {
          window.issuesData = Array.isArray(payload.issues) ? payload.issues : [];
          setSessionJsonSafe(cacheKey, window.issuesData);
          setSessionValueSafe(cacheTimeKey, Date.now().toString());
          return window.issuesData;
        })
        .finally(() => {
          kanbanLoadPromise = null;
        });

      return kanbanLoadPromise;
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∂–∏–º–∞ —Å–ø–∏—Å–∫–∞
    window.showListView = function () {
      $('.issues-section .table-container').show();
      $('#kanban-container').hide();

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –≤ —Ä–µ–∂–∏–º–µ —Å–ø–∏—Å–∫–∞
      $('.table-footer').show();

    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ä–µ–∂–∏–º–∞ –∫–∞–Ω–±–∞–Ω
    window.showKanbanView = function () {
      $('.issues-section .table-container').hide();

      // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∏ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
      if ($('#kanban-container').length === 0) {
        const kanbanHtml = `
          <div id="kanban-container" class="kanban-container">
            <div class="kanban-board">
              <div class="kanban-column column-open" data-status="open">
                <div class="kanban-header header-open">
                  <div class="header-content">
                    <div class="header-icon">
                      <i class="fas fa-folder-open"></i>
                    </div>
                    <h3>–û—Ç–∫—Ä—ã—Ç—ã–µ</h3>
                  </div>
                  <span class="kanban-count count-open">0</span>
                </div>
                <div class="kanban-cards" id="kanban-open"></div>
              </div>
              <div class="kanban-column column-progress" data-status="progress">
                <div class="kanban-header header-progress">
                  <div class="header-content">
                    <div class="header-icon">
                      <i class="fas fa-cogs fa-spin"></i>
                    </div>
                    <h3>–í —Ä–∞–±–æ—Ç–µ</h3>
                  </div>
                  <span class="kanban-count count-progress">0</span>
                </div>
                <div class="kanban-cards" id="kanban-progress"></div>
              </div>
              <div class="kanban-column column-awaiting" data-status="awaiting">
                <div class="kanban-header header-awaiting">
                  <div class="header-content">
                    <div class="header-icon">
                      <i class="fas fa-clock"></i>
                    </div>
                    <h3>–û–∂–∏–¥–∞—é—Ç –æ—Ç–≤–µ—Ç–∞</h3>
                  </div>
                  <span class="kanban-count count-awaiting">0</span>
                </div>
                <div class="kanban-cards" id="kanban-awaiting"></div>
              </div>
              <div class="kanban-column column-closed" data-status="closed">
                <div class="kanban-header header-closed">
                  <div class="header-content">
                    <div class="header-icon">
                      <i class="fas fa-check-circle"></i>
                    </div>
                    <h3>–ó–∞–∫—Ä—ã—Ç—ã–µ</h3>
                  </div>
                  <span class="kanban-count count-closed">0</span>
                </div>
                <div class="kanban-cards" id="kanban-closed"></div>
              </div>
            </div>
          </div>
        `;
        $('.issues-section').append(kanbanHtml);
      }

      $('#kanban-container').show();

      // –°–∫—Ä—ã–≤–∞–µ–º –ø–∞–≥–∏–Ω–∞—Ü–∏—é –≤ —Ä–µ–∂–∏–º–µ –∫–∞–Ω–±–∞–Ω
      $('.table-footer').hide();

      $('.kanban-cards').html(`
        <div class="empty-kanban-state">
          <i class="fas fa-spinner fa-spin"></i>
          <span>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫...</span>
        </div>
      `);

      loadIssuesForKanban()
        .then(() => {
          populateKanbanBoard();
        })
        .catch((error) => {
          $("#kanban-open").html(`
            <div class="empty-kanban-state">
              <i class="fas fa-exclamation-triangle"></i>
              <span>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞–Ω–±–∞–Ω–∞</span>
            </div>
          `);
          $("#kanban-progress, #kanban-awaiting, #kanban-closed").empty();
        });
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∫–∞–Ω–±–∞–Ω-–¥–æ—Å–∫–∏
    window.populateKanbanBoard = function () {
      // –û—á–∏—â–∞–µ–º –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏
      $('.kanban-cards').empty();

      // üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ –∂–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞!
      const issues = window.issuesData || [];

      if (issues.length === 0) {
        return;
      }

      // –°—á–µ—Ç—á–∏–∫–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      let counters = {
        open: 0,
        progress: 0,
        awaiting: 0,
        closed: 0
      };

      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –∑–∞—è–≤–∫—É
      issues.forEach(function (issue) {
        const issueId = issue.id;
        const statusName = issue.status_name;
        const statusId = parseInt(issue.status_id);

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É –ø–æ —Å—Ç–∞—Ç—É—Å—É (–¢–û–ß–ù–û –¢–ê –ñ–ï –õ–û–ì–ò–ö–ê, —á—Ç–æ –∏ –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ!)
        let columnId = 'kanban-open';
        let category = 'open';
        const normalizedStatus = String(statusName).toLowerCase();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ status_id (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç!)
        if (statusId === 9 || statusId === 13 || statusId === 15) {
          columnId = 'kanban-awaiting';
          category = 'awaiting';
        } else if (
          normalizedStatus.includes('–∑–∞–∫—Ä—ã—Ç–∞') ||
          normalizedStatus.includes('–æ—Ç–∫–ª–æ–Ω–µ–Ω–∞') ||
          normalizedStatus.includes('–ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∞') ||
          normalizedStatus.includes('closed') ||
          normalizedStatus.includes('rejected') ||
          normalizedStatus.includes('redirected')
        ) {
          columnId = 'kanban-closed';
          category = 'closed';
        } else if (
          normalizedStatus.includes('–≤ —Ä–∞–±–æ—Ç–µ') ||
          normalizedStatus.includes('–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞') ||
          normalizedStatus.includes('–Ω–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏') ||
          normalizedStatus.includes('–≤ –æ—á–µ—Ä–µ–¥–∏') ||
          normalizedStatus.includes('–∑–∞–º–æ—Ä–æ–∂–µ–Ω–∞') ||
          normalizedStatus.includes('in progress')
        ) {
          columnId = 'kanban-progress';
          category = 'progress';
        } else if (
          normalizedStatus.includes('–æ—Ç–∫—Ä—ã—Ç–∞') ||
          normalizedStatus.includes('–≤—ã–ø–æ–ª–Ω–µ–Ω–∞') ||
          normalizedStatus.includes('new') ||
          normalizedStatus.includes('open') ||
          normalizedStatus.includes('pending') ||
          normalizedStatus.includes('resolved') ||
          normalizedStatus.includes('—Å–æ–∑–¥–∞–Ω–∞') ||
          normalizedStatus.includes('–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞')
        ) {
          columnId = 'kanban-open';
          category = 'open';
        }

        counters[category]++;

        // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏
        const card = createKanbanCardFromData(issue);
        $(`#${columnId}`).append(card);
      });

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
      $('.kanban-column').each(function () {
        const count = $(this).find('.kanban-card').length;
        $(this).find('.kanban-count').text(count);
      });
    }

    // üîß –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏
    window.createKanbanCardFromData = function (issue) {
      const issueId = issue.id;
      const statusId = parseInt(issue.status_id);
      const statusName = issue.status_name;
      const issueDate = issue.created_on || issue.updated_on || '';
      const issueSubject = issue.subject || '–ë–µ–∑ —Ç–µ–º—ã';

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —Å—Ç–∞—Ç—É—Å–∞
      let statusColor = 'status-default';
      let statusIcon = 'fa-circle';

      if (statusId === 9 || statusId === 13 || statusId === 15) {
        statusColor = 'status-awaiting';
        statusIcon = 'fa-clock';
      } else if (statusName.toLowerCase().includes('–∑–∞–∫—Ä—ã—Ç–∞')) {
        statusColor = 'status-closed';
        statusIcon = 'fa-check-circle';
      } else if (statusName.toLowerCase().includes('–≤ —Ä–∞–±–æ—Ç–µ')) {
        statusColor = 'status-progress';
        statusIcon = 'fa-cog fa-spin';
      } else if (statusName.toLowerCase().includes('–æ—Ç–∫—Ä—ã—Ç–∞') || statusName.toLowerCase().includes('–≤—ã–ø–æ–ª–Ω–µ–Ω–∞')) {
        statusColor = 'status-open';
        statusIcon = 'fa-folder-open';
      }

      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
      const $card = $('<div>')
        .addClass('kanban-card modern-card')
        .attr('data-issue-id', issueId)
        .css('cursor', 'pointer')
        .on('click', function () {
          window.location.href = '/my-issues/' + issueId;
        });

      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏
      const $header = $('<div>').addClass('kanban-card-header');
      $header.append(
        $('<div>').addClass('card-id-badge').append(
          $('<i>').addClass('fas fa-hashtag'),
          $('<span>').text(issueId)
        ),
        $('<div>').addClass('card-date').append(
          $('<i>').addClass('far fa-calendar-alt'),
          $('<span>').text(issueDate)
        )
      );

      // –¢–µ–ª–æ –∫–∞—Ä—Ç–æ—á–∫–∏
      const $body = $('<div>').addClass('kanban-card-body');
      $body.append(
        $('<div>').addClass('kanban-card-title').text(issueSubject)
      );

      // –ü–æ–¥–≤–∞–ª –∫–∞—Ä—Ç–æ—á–∫–∏
      const $footer = $('<div>').addClass('kanban-card-footer');
      $footer.append(
        $('<div>').addClass('kanban-card-status ' + statusColor).append(
          $('<i>').addClass('fas ' + statusIcon),
          $('<span>').text(statusName)
        ),
        $('<div>').addClass('card-action-hint').append(
          $('<i>').addClass('fas fa-external-link-alt')
        )
      );

      $card.append($header, $body, $footer);
      return $card;
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Ä—Ç–æ—á–∫–∏ –∫–∞–Ω–±–∞–Ω –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã (—Å—Ç–∞—Ä–∞—è, –æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    window.createKanbanCard = function ($row) {
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ data-–∞—Ç—Ä–∏–±—É—Ç–æ–≤ —Å—Ç—Ä–æ–∫–∏
      const issueId = $row.data('issue-id');
      const statusId = parseInt($row.data('status-id'));
      const statusName = $row.data('status-name');

      // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∏–∑ —è—á–µ–µ–∫ (—É–∂–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä–æ–º)
      const issueDate = $row.find('td').eq(1).text().trim();
      const issueSubject = $row.find('td').eq(2).text().trim();

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —Å—Ç–∞—Ç—É—Å–∞
      let statusColor = 'status-default';
      let statusIcon = 'fa-circle';

      if (statusId === 9 || statusId === 13 || statusId === 15) {
        statusColor = 'status-awaiting';
        statusIcon = 'fa-clock';
      } else if (statusName.toLowerCase().includes('–∑–∞–∫—Ä—ã—Ç–∞')) {
        statusColor = 'status-closed';
        statusIcon = 'fa-check-circle';
      } else if (statusName.toLowerCase().includes('–≤ —Ä–∞–±–æ—Ç–µ')) {
        statusColor = 'status-progress';
        statusIcon = 'fa-cog fa-spin';
      } else if (statusName.toLowerCase().includes('–æ—Ç–∫—Ä—ã—Ç–∞')) {
        statusColor = 'status-open';
        statusIcon = 'fa-folder-open';
      }

      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É —Å –ø–æ–º–æ—â—å—é jQuery –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
      const $card = $('<div>')
        .addClass('kanban-card modern-card')
        .attr('data-issue-id', issueId)
        .css('cursor', 'pointer')
        .on('click', function () {
          window.location.href = '/my-issues/' + issueId;
        });

      // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∫–∞—Ä—Ç–æ—á–∫–∏
      const $header = $('<div>').addClass('kanban-card-header');
      $header.append(
        $('<div>').addClass('card-id-badge').append(
          $('<i>').addClass('fas fa-hashtag'),
          $('<span>').text(issueId)
        ),
        $('<div>').addClass('card-date').append(
          $('<i>').addClass('far fa-calendar-alt'),
          $('<span>').text(issueDate)
        )
      );

      // –¢–µ–ª–æ –∫–∞—Ä—Ç–æ—á–∫–∏
      const $body = $('<div>').addClass('kanban-card-body');
      $body.append(
        $('<div>').addClass('kanban-card-title').text(issueSubject)
      );

      // –ü–æ–¥–≤–∞–ª –∫–∞—Ä—Ç–æ—á–∫–∏
      const $footer = $('<div>').addClass('kanban-card-footer');
      $footer.append(
        $('<div>').addClass('kanban-card-status ' + statusColor).append(
          $('<i>').addClass('fas ' + statusIcon),
          $('<span>').text(statusName)
        ),
        $('<div>').addClass('card-action-hint').append(
          $('<i>').addClass('fas fa-external-link-alt')
        )
      );

      $card.append($header, $body, $footer);
      return $card;
    }

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –≤ DOM
    $(document).ready(function () {
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      if ($("#reset-filter-btn").length === 0) {
        $(".controls-content").append(
          '<div class="reset-filter-container"><button id="reset-filter-btn" class="action-button secondary"><i class="fas fa-times"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button></div>'
        );

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–Ω–æ–ø–∫–µ —Å–±—Ä–æ—Å–∞
        $("#reset-filter-btn").on("click", function () {
          resetStatusFilter();
        });
      }
    });

    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü–µ–π –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ç–µ–º—ã
    window.reinitializeTable = function () {
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–µ—Ä–µ–¥ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ–º
      if (window.dataStateManager) {
        window.dataStateManager.saveCurrentState();
      }

      // –£–Ω–∏—á—Ç–æ–∂–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É
      if (window.issuesTable && $.fn.DataTable.isDataTable("#issue")) {
        window.issuesTable.destroy();
      }

      // –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
      setTimeout(() => {
        initializeTableData();

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω–∏—è
        if (window.dataStateManager) {
          setTimeout(() => {
            window.dataStateManager.restoreState();
          }, 200);
        }
      }, 100);
    };

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
    window.destroyTable = function () {
      if (window.issuesTable && $.fn.DataTable.isDataTable("#issue")) {
        window.issuesTable.destroy();
        window.issuesTable = null;
      }
      if (scheduleTableStateSave && typeof scheduleTableStateSave.cancel === "function") {
        scheduleTableStateSave.cancel();
      }
      scheduleTableStateSave = null;
    };
  });

  // Lazy load background shapes after main content loads
  setTimeout(() => {
    $(".background-shapes").css("opacity", "1");
  }, 500);
</script>

<!-- JavaScript –¥–ª—è –±–ª–æ–∫–∞ "–ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏" -->
<script
  src="{{ url_for('static', filename='js/my_issues_activity.js') }}?v={{ cache_buster or '1' }}&force={{ range(1, 999999) | random }}"></script>

<!-- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    setTimeout(function() {
        if (typeof loadRecentActivity === 'function') {
            loadRecentActivity();
        }
    }, 1000);
});
</script>

{% endblock %}
