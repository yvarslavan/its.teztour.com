{% extends 'layout.html' %}

{% block head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ú–æ–∏ –∑–∞–¥–∞—á–∏ | Helpdesk (Refactored)</title>

<!-- –ù–æ–≤–∞—è –º–æ–¥—É–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Å—Ç–∏–ª–µ–π -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/tasks-refactored.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<!-- DataTables (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/datatables.min.css') }}">
<script src="{{ url_for('static', filename='js/datatables.min.js') }}"></script>
{% endblock %}

{% block content %}
<div class="tasks-page-container" data-component="tasks-app">

  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
  <header class="page-header" data-component="header">
    <div class="header-content">
      <div class="header-main">
        <div class="header-icon">
          <i class="fas fa-tasks"></i>
        </div>
        <div class="header-text">
          <h1 class="page-title">–ú–æ–∏ –∑–∞–¥–∞—á–∏ –≤ Redmine</h1>
          <p class="page-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤–∞—à–∏—Ö –∑–∞–¥–∞—á –≤ Redmine</p>
        </div>
      </div>
      <div class="header-actions">
        <a href="https://redmine.tez-tour.com"
           class="action-button secondary"
           target="_blank"
           rel="noopener noreferrer">
          <i class="fas fa-external-link-alt"></i>
          <span>–ü–µ—Ä–µ–π—Ç–∏ –≤ Redmine</span>
        </a>
        <a href="{{ url_for('main.issues') }}"
           class="action-button primary">
          <i class="fas fa-ticket-alt"></i>
          <span>–ú–æ–∏ –∑–∞—è–≤–∫–∏</span>
        </a>
      </div>
    </div>
  </header>

  <!-- –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ -->
  <section class="statistics-section" data-component="statistics">
    <div class="status-breakdown-dashboard">
      <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è JavaScript –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º -->
    </div>
  </section>

  <!-- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
  <section class="filters-section" data-component="filters">
    <div class="filters-container">
      <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç —Ä–µ–Ω–¥–µ—Ä–∏—Ç—å—Å—è JavaScript –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–º -->
    </div>
  </section>

  <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á -->
  <section class="table-section" data-component="table">
    <div class="table-container">
      <table id="tasksTable" class="display nowrap" style="width:100%">
        <thead>
          <tr>
            <th>ID</th>
            <th>–¢–µ–º–∞</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</th>
            <th>–ü—Ä–æ–µ–∫—Ç</th>
            <th>–ù–∞–∑–Ω–∞—á–µ–Ω</th>
            <th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
          </tr>
        </thead>
        <tbody>
          <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ AJAX -->
        </tbody>
      </table>
    </div>
  </section>

  <!-- –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Å–ø–∏–Ω–µ—Ä -->
  <div id="loading-spinner" style="display: none;">
    <!-- –ë—É–¥–µ—Ç —É–ø—Ä–∞–≤–ª—è—Ç—å—Å—è LoadingManager -->
  </div>

</div>

<!-- –°–∫—Ä–∏–ø—Ç—ã –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã -->
<script type="module">
  // –ò–º–ø–æ—Ä—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
  import('./{{ url_for("static", filename="js/pages/tasks/core/EventBus.js") }}').then(() => {
    return import('./{{ url_for("static", filename="js/pages/tasks/core/LoadingManager.js") }}');
  }).then(() => {
    return import('./{{ url_for("static", filename="js/pages/tasks/core/TasksApp.js") }}');
  }).then(() => {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    console.log('[TasksRefactored] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');

    // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
    window.tasksApp = new TasksApp({
      debug: {{ 'true' if config.DEBUG else 'false' }},
      autoInit: true,
      preserveTaskNavigation: true // –ö–†–ò–¢–ò–ß–ù–û: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é
    });

    // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
    window.tasksApp.eventBus.on('app:ready', (state) => {
      console.log('[TasksRefactored] ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ', state);

      // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏
      if (window.notificationManager) {
        window.notificationManager.showSuccess('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–¥–∞—á –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
      }
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    window.tasksApp.eventBus.on('app:error', (error) => {
      console.error('[TasksRefactored] ‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', error);

      if (window.notificationManager) {
        window.notificationManager.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∑–∞–¥–∞—á');
      }
    });

  }).catch(error => {
    console.error('[TasksRefactored] ‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π:', error);

    // Fallback –¥–ª—è —Å–ª—É—á–∞—è –æ—à–∏–±–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª–µ–π
    document.querySelector('.tasks-page-container').innerHTML = `
      <div class="error-fallback">
        <h2>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</h2>
        <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>
        <button onclick="location.reload()" class="action-button primary">
          <i class="fas fa-redo"></i>
          –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É
        </button>
      </div>
    `;
  });
</script>

<!-- Fallback –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤ –±–µ–∑ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ ES6 –º–æ–¥—É–ª–µ–π -->
<script nomodule>
  console.warn('[TasksRefactored] ‚ö†Ô∏è –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ES6 –º–æ–¥—É–ª–∏');

  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞
  document.querySelector('.tasks-page-container').innerHTML = `
    <div class="browser-compatibility-warning">
      <h2>–û–±–Ω–æ–≤–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä</h2>
      <p>–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π ES6 –º–æ–¥—É–ª–µ–π.</p>
      <p>–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≤–µ—Ä—Å–∏–∏ Chrome, Firefox, Safari –∏–ª–∏ Edge.</p>
    </div>
  `;
</script>

<!-- –°—Ç–∏–ª–∏ –¥–ª—è fallback —Å–æ–æ–±—â–µ–Ω–∏–π -->
<style>
.error-fallback,
.browser-compatibility-warning {
  text-align: center;
  padding: var(--tasks-spacing-3xl);
  background: var(--tasks-bg-secondary);
  border-radius: var(--tasks-radius-lg);
  border: 1px solid var(--tasks-border-color);
  margin: var(--tasks-spacing-xl) 0;
}

.error-fallback h2,
.browser-compatibility-warning h2 {
  color: var(--tasks-error);
  margin-bottom: var(--tasks-spacing-lg);
}

.error-fallback p,
.browser-compatibility-warning p {
  color: var(--tasks-text-secondary);
  margin-bottom: var(--tasks-spacing-md);
}

.error-fallback .action-button {
  margin-top: var(--tasks-spacing-lg);
}
</style>

{% endblock %}

{% block scripts %}
<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã –µ—Å–ª–∏ –Ω—É–∂–Ω—ã -->
<script>
  // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
  if ({{ 'true' if config.DEBUG else 'false' }}) {
    window.TASKS_DEBUG = true;
    console.log('[TasksRefactored] üîß –†–µ–∂–∏–º –æ—Ç–ª–∞–¥–∫–∏ –≤–∫–ª—é—á–µ–Ω');
  }

  // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏
  document.addEventListener('DOMContentLoaded', function() {
    // –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    const oldHandlers = [
      'LoadingManager',
      'TasksCounterManager',
      'ModernLoadingManager',
      'SpinnerManager'
    ];

    oldHandlers.forEach(handler => {
      if (window[handler]) {
        console.log(`[TasksRefactored] üîÑ –û—Ç–∫–ª—é—á–∞–µ–º —Å—Ç–∞—Ä—ã–π ${handler}`);
        if (window[handler].destroy) {
          window[handler].destroy();
        }
        window[handler] = null;
      }
    });
  });
</script>
{% endblock %}
