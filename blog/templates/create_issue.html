{% extends 'layout.html' %}

{% block content %}
<div class="container-fluid create-issue-wrapper">
    <div class="row min-vh-100">
        <!-- Левая информационная панель -->
        <div class="col-lg-4 d-none d-lg-block info-panel">
            <div class="info-content">
                <div class="info-header">
                    <i class="fas fa-ticket-alt"></i>
                    <h2>Создание заявки</h2>
                    <p class="header-subtitle">Опишите вашу проблему или запрос</p>
                </div>

                <div class="tips-section">
                    <div class="tip-item">
                        <div class="tip-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="tip-content">
                            <h4>Описание проблемы</h4>
                            <p>Опишите проблему максимально подробно для быстрого решения</p>
                        </div>
                    </div>

                    <div class="tip-item">
                        <div class="tip-icon">
                            <i class="fas fa-paperclip"></i>
                        </div>
                        <div class="tip-content">
                            <h4>Прикрепите файлы</h4>
                            <p>Добавьте скриншоты или документы для лучшего понимания</p>
                        </div>
                    </div>

                    <div class="tip-item">
                        <div class="tip-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="tip-content">
                            <h4>Быстрая обработка</h4>
                            <p>Мы ответим на вашу заявку в течение рабочего дня</p>
                        </div>
                    </div>

                    <div class="tip-item">
                        <div class="tip-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="tip-content">
                            <h4>Уведомления</h4>
                            <p>Получайте обновления по статусу заявки на email</p>
                        </div>
                    </div>
                </div>

                <!-- Контактная информация -->
                <div class="contact-info">
                    <div class="contact-item">
                        <i class="fas fa-headset"></i>
                        <div>
                            <h5>Техподдержка</h5>
                            <p>Пн-Пт: 10:00 - 19:00</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Правая панель с формой -->
        <div class="col-lg-8 form-panel">
            <div class="form-container">
                <!-- Хлебные крошки -->
                <nav class="breadcrumb-nav">
                    <a href="{{ url_for('main.my_issues') }}" class="breadcrumb-link">
                        <i class="fas fa-list"></i> Мои заявки
                    </a>
                    <i class="fas fa-chevron-right"></i>
                    <span class="breadcrumb-current">Новая заявка</span>
                </nav>

                <!-- Заголовок секции -->
                <div class="section-header">
                    <div class="header-content">
                        <div class="header-icon">
                            <i class="fas fa-plus-circle"></i>
                        </div>
                        <div class="header-text">
                            <h1>Создать новую заявку</h1>
                            <p class="section-subtitle">Опишите вашу проблему или запрос, и наша команда поможет вам</p>
                        </div>
                    </div>
                </div>

                <!-- Форма создания заявки -->
                <form action="" method="POST" enctype="multipart/form-data" class="modern-issue-form">
                    {{ form.hidden_tag() }}

                    <!-- Поле темы заявки -->
                    <div class="form-group-modern">
                        <label for="{{ form.subject.id }}" class="form-label-modern">
                            <i class="fas fa-heading"></i>
                            {{ form.subject.label.text }}
                            <span class="required">*</span>
                        </label>
                        {{ form.subject(class="form-control-modern", placeholder="Кратко опишите суть проблемы или запроса...", maxlength="200", id="subjectInput") }}
                        <div class="field-feedback">
                            <div class="char-counter">
                                <span id="subject-counter">0</span>/200
                            </div>
                            <div class="field-tips">
                                <i class="fas fa-info-circle"></i>
                                Используйте понятные формулировки
                            </div>
                        </div>
                        {% for error in form.subject.errors %}
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                {{ error }}
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Поле описания -->
                    <div class="form-group-modern">
                        <label for="{{ form.description.id }}" class="form-label-modern">
                            <i class="fas fa-align-left"></i>
                            {{ form.description.label.text }}
                            <span class="required">*</span>
                        </label>
                        {{ form.description(class="form-control-modern description-textarea", placeholder="Подробно опишите проблему: что произошло, какие действия вы выполняли, какого результата ожидали...", rows="8", id="descriptionInput") }}
                        <div class="field-feedback">
                            <div class="char-counter">
                                <span id="description-counter">0</span> символов
                            </div>
                            <div class="field-tips">
                                <i class="fas fa-info-circle"></i>
                                Чем подробнее описание, тем быстрее решение
                            </div>
                        </div>
                        {% for error in form.description.errors %}
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                {{ error }}
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Поле загрузки файлов -->
                    <div class="form-group-modern">
                        <label class="form-label-modern">
                            <i class="fas fa-paperclip"></i>
                            Прикрепить файлы
                            <span class="optional">(необязательно)</span>
                        </label>

                        <div class="file-upload-area" id="fileUploadArea">
                            {{ form.upload_files(class="file-input", id="fileInput", accept=".png,.pdf,.jpg,.jpeg,.doc,.docx,.xls,.xlsx") }}
                            <div class="file-upload-content">
                                <div class="upload-icon">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                                <h4>Перетащите файлы сюда или нажмите для выбора</h4>
                                <p>Добавьте скриншоты, документы или другие файлы</p>
                                <div class="upload-formats">
                                    <span class="format-badge">PNG</span>
                                    <span class="format-badge">JPG</span>
                                    <span class="format-badge">PDF</span>
                                    <span class="format-badge">DOC</span>
                                    <span class="format-badge">XLS</span>
                                </div>
                                <span class="upload-hint">Максимум 10MB на файл</span>
                            </div>
                            <div class="files-preview" id="filesPreview"></div>
                        </div>
                        {% for error in form.upload_files.errors %}
                            <div class="error-message">
                                <i class="fas fa-exclamation-circle"></i>
                                {{ error }}
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Кнопки действий -->
                    <div class="form-actions">
                        <div class="secondary-actions">
                            <a href="{{ url_for('main.my_issues') }}" class="btn-secondary">
                                <i class="fas fa-arrow-left"></i>
                                Назад к заявкам
                            </a>
                        </div>
                        <div class="primary-actions">
                            <button type="submit" class="btn-primary" id="submitBtn">
                                <i class="fas fa-paper-plane"></i>
                                Создать заявку
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<!-- Page-specific overrides (extracted from inline styles) -->
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/create_issue/create_issue_page_overrides.css') }}?v={{ cache_buster or '1' }}">
{% endblock styles %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Элементы
    const subjectInput = document.getElementById('subjectInput');
    const descriptionInput = document.getElementById('descriptionInput');
    const fileInput = document.getElementById('fileInput');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const filesPreview = document.getElementById('filesPreview');
    const submitBtn = document.getElementById('submitBtn');
    const subjectCounter = document.getElementById('subject-counter');
    const descriptionCounter = document.getElementById('description-counter');

    let selectedFiles = [];

    // Инициализация: если есть уже выбранные файлы, добавляем их в selectedFiles
    if (fileInput && fileInput.files && fileInput.files.length > 0) {
        for (let file of fileInput.files) {
            selectedFiles.push(file);
        }
        updateFilesPreview();
    }

    // Счетчики символов
    if (subjectInput && subjectCounter) {
        subjectInput.addEventListener('input', function() {
            subjectCounter.textContent = this.value.length;
        });
    }

    if (descriptionInput && descriptionCounter) {
        descriptionInput.addEventListener('input', function() {
            descriptionCounter.textContent = this.value.length;
        });
    }

    // Функционал загрузки файлов
    if (fileUploadArea && fileInput) {
        // Клик по области загрузки
        fileUploadArea.addEventListener('click', function(e) {
            if (e.target !== fileInput && !e.target.closest('.file-item')) {
                fileInput.click();
            }
        });

        // Drag and drop
        fileUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.classList.add('dragover');
        });

        fileUploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');
        });

        fileUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            this.classList.remove('dragover');

            const files = e.dataTransfer.files;
            handleFileSelection(files);
        });

        // Изменение файла через input
        fileInput.addEventListener('change', function() {
            // При выборе через input заменяем все файлы, а не добавляем
            selectedFiles = [];
            handleFileSelection(this.files);
        });

        function handleFileSelection(files) {
            const allowedExtensions = ['png', 'pdf', 'jpg', 'jpeg', 'doc', 'docx', 'xls', 'xlsx'];

            for (let file of files) {
                const extension = file.name.split('.').pop().toLowerCase();

                if (allowedExtensions.indexOf(extension) === -1) {
                    showNotification(`Недопустимый формат файла: ${file.name}`, 'error');
                    continue;
                }

                if (file.size > 10 * 1024 * 1024) { // 10MB
                    showNotification(`Файл слишком большой: ${file.name}`, 'error');
                    continue;
                }

                selectedFiles.push(file);
            }

            updateFilesPreview();
            updateFileInput();
        }

        function updateFilesPreview() {
            if (selectedFiles.length === 0) {
                filesPreview.style.display = 'none';
                return;
            }

            filesPreview.style.display = 'block';
            filesPreview.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';

                const icon = getFileIcon(file.name);
                const size = formatFileSize(file.size);

                fileItem.innerHTML = `
                    <div class="file-icon">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${size}</div>
                    </div>
                    <div class="remove-file" onclick="removeFile(${index})">
                        <i class="fas fa-times"></i>
                    </div>
                `;

                filesPreview.appendChild(fileItem);
            });
        }

        window.removeFile = function(index) {
            selectedFiles.splice(index, 1);
            updateFilesPreview();
            updateFileInput();
        };

        function updateFileInput() {
            if (selectedFiles.length === 0) {
                fileInput.value = '';
                return;
            }

            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file));
            fileInput.files = dt.files;

            // Отладочная информация
            console.log('Updated fileInput.files:', fileInput.files.length, 'files');
        }

        function getFileIcon(fileName) {
            const extension = fileName.split('.').pop().toLowerCase();
            switch (extension) {
                case 'pdf': return 'fa-file-pdf';
                case 'doc':
                case 'docx': return 'fa-file-word';
                case 'xls':
                case 'xlsx': return 'fa-file-excel';
                case 'jpg':
                case 'jpeg':
                case 'png': return 'fa-file-image';
                default: return 'fa-file';
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    }

    // Валидация формы перед отправкой
    const form = document.querySelector('.modern-issue-form');
    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
            const hasSubject = subjectInput && subjectInput.value.trim().length > 0;
            const hasDescription = descriptionInput && descriptionInput.value.trim().length > 0;

            // Отладочная информация о файлах
            console.log('Form submission - fileInput.files:', fileInput.files.length);
            console.log('Form submission - selectedFiles:', selectedFiles.length);

            if (!hasSubject || !hasDescription) {
                e.preventDefault();

                if (!hasSubject) {
                    subjectInput.focus();
                    subjectInput.style.borderColor = '#ef4444';
                }
                if (!hasDescription) {
                    descriptionInput.style.borderColor = '#ef4444';
                }

                showNotification('Пожалуйста, заполните все обязательные поля', 'error');
                return false;
            }

            // Показываем индикатор загрузки
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Создание заявки...';
            submitBtn.disabled = true;
        });
    }

    // Функция показа уведомлений
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    // Убираем красную рамку при вводе текста
    if (subjectInput) {
        subjectInput.addEventListener('input', function() {
            this.style.borderColor = '';
        });
    }

    if (descriptionInput) {
        descriptionInput.addEventListener('input', function() {
            this.style.borderColor = '';
        });
    }
});
</script>
{% endblock scripts %}

