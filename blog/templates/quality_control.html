{% extends 'layout.html' %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/quality_control.css') }}">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .nav-tabs {
        border-bottom: none;
        gap: 8px;  /* Отступ между вкладками */
    }

    .nav-tabs .nav-link {
        border: none;
        padding: 12px 20px;
        color: #6c757d;
        font-weight: 500;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
        background: rgba(255, 255, 255, 0.8);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .nav-tabs .nav-link i {
        font-size: 1rem;
        opacity: 0.8;
    }

    .nav-tabs .nav-link:hover {
        background: rgba(13, 110, 253, 0.05);
        color: #0d6efd;
        transform: translateY(-1px);
    }



    .nav-tabs .nav-link.active i {
        opacity: 1;
    }

    /* Делаем текст темным для активной вкладки */
    .nav-tabs .nav-link.active {
        color: #2c3e50 !important;  /* Темный цвет для лучшей читаемости */
        border-width: 1px;
        border-bottom: 1px solid;
        box-shadow: 0 -2px 6px rgba(0,0,0,0.1);
    }

    /* Индивидуальные цвета для каждой вкладки */
    .nav-link[aria-controls="classification"] {
        border-bottom: 2px solid #0d6efd;
    }

    .nav-link[aria-controls="resortTypes"] {
        border-bottom: 2px solid #28a745;
    }

    .nav-link[aria-controls="resorts"] {
        border-bottom: 2px solid #fd7e14;
    }

    .nav-link[aria-controls="resortTypesByType"] {
        border-bottom: 2px solid #6f42c1;
    }

    /* Активные состояния с соответствующими цветами */
    .nav-link[aria-controls="classification"].active {
        background: #0d6efd;
    }

    .nav-link[aria-controls="resortTypes"].active {
        background: #28a745;
    }

    .nav-link[aria-controls="resorts"].active {
        background: #fd7e14;
    }

    .nav-link[aria-controls="resortTypesByType"].active {
        background: #6f42c1;
    }

    .tab-content {
        height: calc(100vh - 200px);
        overflow-y: auto;
        padding: 25px;
        border: 2px solid #dee2e6;
        border-top: none;
        background-color: #fff;
        border-radius: 0 0 6px 6px;
    }

    .tab-pane {
        min-height: 100%;
    }

    .quality-control-container {
        margin-bottom: 50px;
        position: relative;
    }

    .unclassified-info {
        background-color: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
    }

    .unclassified-info span {
        font-weight: 500;
    }

    #classificationTable th {
        background-color: #f8f9fa;
        font-weight: 600;
    }

    #classificationTable td {
        vertical-align: middle;
    }

    .table-info td {
        font-weight: 500;
    }

    .progress-wrapper {
        margin-top: 20px;
    }

    /* Стиль для строк GDS */
    .table-bordered > tbody > tr.gds-row {
        background-color: #e8f5e9 !important;
    }

    .table-bordered > tbody > tr.gds-row:hover {
        background-color: #c8e6c9 !important;
    }

    .table-bordered > tbody > tr.gds-row > td {
        background-color: #e8f5e9 !important;
    }

    /* Стиль для строки Неклассифицировано */
    .table-bordered > tbody > tr.unclassified-row {
        background-color: #ffe0b2 !important;  /* Более насыщенный желтый/оранжевый цвет */
    }

    .table-bordered > tbody > tr.unclassified-row:hover {
        background-color: #ffcc80 !important;  /* Еще темнее при наведении */
    }

    .table-bordered > tbody > tr.unclassified-row > td {
        background-color: #ffe0b2 !important;
    }

    /* Стиль для строки Анкеты */
    .table-bordered > tfoot > tr.surveys-row {
        background-color: #ffebee !important;  /* Мягкий красный цвет */
    }

    .table-bordered > tfoot > tr.surveys-row:hover {
        background-color: #ffcdd2 !important;  /* Немного темнее при наведении */
    }

    .table-bordered > tfoot > tr.surveys-row > td {
        background-color: #ffebee !important;
    }

    /* Стили для закрепленного заголовка таблицы */
    .sticky-top {
        position: sticky;
        top: 0;
        background-color: #f8f9fa;
        z-index: 1;
    }

    /* Убедимся, что график не накладывается */
    .container-fluid {
        position: relative;
        z-index: 0;
    }

    .chart-container {
        position: relative;
        margin-top: 100px;
        margin-bottom: 50px;
        padding: 20px;
        clear: both;
        border-top: 1px solid #dee2e6;
        padding-top: 40px;
    }

    .table-responsive {
        position: relative;
        z-index: 1;
        max-height: 500px;
        overflow-y: auto;
    }


    /* Стили для вкладки Классификация */
    .nav-tabs .nav-link[aria-controls="classification"] {
        background-color: #e8f4ff;
        border-color: #cce5ff;
    }
    .nav-tabs .nav-link[aria-controls="classification"].active {
        background-color: #f0f8ff;
    }
    .nav-tabs .nav-link[aria-controls="classification"] i {
        color: #0d6efd;
    }

    /* Стили для вкладки Статистика */
    .nav-tabs .nav-link[aria-controls="report2"] {
        background-color: #e8fff0;
        border-color: #ccf2e3;
    }
    .nav-tabs .nav-link[aria-controls="report2"].active {
        background-color: #f0fff7;
    }
    .nav-tabs .nav-link[aria-controls="report2"] i {
        color: #198754;
    }

    /* Стили для вкладки Курорты */
    .nav-tabs .nav-link[aria-controls="resorts"] {
        background-color: #fff2e8;
        border-color: #ffe5cc;
    }
    .nav-tabs .nav-link[aria-controls="resorts"].active {
        background-color: #fff7f0;
    }
    .nav-tabs .nav-link[aria-controls="resorts"] i {
        color: #fd7e14;
    }

    /* Стили для вкладки По типу обращения */
    .nav-tabs .nav-link[aria-controls="resort-types"] {
        background-color: #f8e8ff;
        border-color: #e5ccff;
    }
    .nav-tabs .nav-link[aria-controls="resort-types"].active {
        background-color: #faf0ff;
    }
    .nav-tabs .nav-link[aria-controls="resort-types"] i {
        color: #6f42c1;
    }



    /* Обновляем подчеркивание */
    .nav-tabs .nav-link:before {
        height: 3px;
        bottom: -1px;
        z-index: 1;
    }


    #resortsTable th:not(:first-child),
    #resortsTable td:not(:first-child) {
        min-width: 100px;  /* Фиксированная минимальная ширина для числовых колонок */
        text-align: right; /* Выравнивание по правому краю */
    }

    #resortsTable th:first-child,
    #resortsTable td:first-child {
        min-width: 150px; /* Более широкая колонка для названий курортов */
        text-align: left; /* Выравнивание по левому краю для названий */
    }

    /* Стиль для ссылок в ячейках */
    .resort-link {
        display: block;
        text-align: right;
    }

    /* Добавляем отступы для значений в ячейках */
    #resortsTable td:not(:first-child) {
        padding-right: 15px;
    }

    /* Стиль для итоговой строки */
    #resortsTable tfoot td:not(:first-child) {
        font-weight: bold;
        text-align: right;
        padding-right: 15px;
    }

    .main-section {
        margin-top: -70px;
    }

    .quality-control-wrapper {
        height: calc(100vh - 180px);
        overflow-y: auto;
    }

    /* Стилизация подзаголовка */
    .subtitle {
        color: #6c757d;
        font-size: 0.95rem;
        font-weight: 400;
        letter-spacing: 0.3px;
        margin-top: -3px;
        margin-bottom: 15px;
        padding-left: 2px;
        border-left: 3px solid #007bff;

    }

    .new-issues-info {
        margin-top: 10px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .new-issues-label {
        font-size: 0.95rem;
        color: #666;
    }

    .new-issues-badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);
        border-radius: 20px;
        color: white;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(255, 107, 107, 0.2);
    }

    .new-issues-badge:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
    }

    .new-issues-badge i {
        margin-right: 6px;
        font-size: 0.9rem;
    }

    .new-issues-badge .count {
        font-weight: 600;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .new-issues-badge.has-new {
        animation: pulse 2s infinite;
    }

    .issues-statistics {
        display: flex;
        flex-direction: row;  /* Изменено с column на row */
        align-items: center;
        gap: 20px;
        margin-left: 20px;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;  /* Предотвращает перенос текста */
    }

    .stat-label {
        font-size: 0.9rem;
        color: #666;
    }

    .stat-badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 20px;
        color: white;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        box-shadow: 0 2px 4px rgba(76, 175, 80, 0.2);
    }

    .stat-badge.new {
        background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);
        box-shadow: 0 2px 4px rgba(255, 107, 107, 0.2);
    }

    .stat-badge:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);
    }

    .stat-badge.new:hover {
        box-shadow: 0 4px 8px rgba(255, 107, 107, 0.3);
    }

    .stat-badge i {
        margin-right: 6px;
        font-size: 0.9rem;
    }

    .stat-badge .count {
        font-weight: 600;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    .stat-badge.new.has-new {
        animation: pulse 2s infinite;
    }

    .header-section {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 15px;
    }

    .header-section h4 {
        margin: 0;
        white-space: nowrap;
    }

    /* Добавим медиа-запрос для адаптивности на маленьких экранах */
    @media (max-width: 768px) {
        .issues-statistics {
            flex-direction: column;
            align-items: flex-start;
        }
    }

    /* Стили для счетчика результатов */
    .results-counter {
        margin: 20px 0;
    }

    .results-badge {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        font-size: 0.95rem;
        color: #495057;
        border: 1px solid #dee2e6;
        transition: all 0.3s ease;
    }

    .results-badge:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px rgba(0,0,0,0.08);
    }

    .results-badge i {
        color: #6c757d;
    }

    .results-badge .count {
        font-weight: 600;
        color: #0d6efd;
        margin: 0 6px;
    }

    .results-text {
        color: #6c757d;
    }

    /* Стили для таблицы */
    .table thead th {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 2px solid #dee2e6;
        padding: 12px 16px;
        font-weight: 600;
        color: #495057;
        font-size: 0.95rem;
        white-space: nowrap;
    }

    .table thead th i {
        opacity: 0.7;
    }

    .table tbody td {
        padding: 12px 16px;
        vertical-align: middle;
    }

    .table tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.04);
    }

    .table tbody td a {
        color: #0d6efd;
        text-decoration: none;
        font-weight: 500;
    }

    .table tbody td a:hover {
        color: #0a58ca;
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block extra_head %}
{{ super() }}
<script src="https://cdn.plot.ly/plotly-2.27.1.min.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="header-section">
        <h4>
            <i class="fas fa-chart-line"></i>
            <a href="https://quality.teztour.com/projects/quality/issues" target="_blank" style="color: #007bff; text-decoration: none;">
                Аналитика обращений quality.teztour.com
                <i class="fas fa-external-link-alt" style="margin-left: 5px;"></i>
            </a>
        </h4>
        <div class="issues-statistics">
            <div class="stat-item">
                <span class="stat-label">Всего обращений:</span>
                <span class="stat-badge" id="totalIssuesCounter">
                    <i class="fas fa-tasks"></i>
                    <span class="count">0</span>
                </span>
            </div>
            <div class="stat-item">
                <span class="stat-badge new" id="newIssuesCounter">
                    <i class="fas fa-bell"></i>
                    <span class="count">0</span>
                </span>
                <!-- Добавляем текст и кнопку -->
                <span class="comments-label">Комментарии:</span>
                <div class="floating-comments-button" id="showCommentSidebar">
                    <i class="fas fa-comments"></i>
                    <span class="badge" id="floating-comment-badge"></span>
                </div>
            </div>
        </div>
    </div>
    <div class="subtitle">
        Статистические отчеты отдела по контролю за качеством
    </div>
    <div class="quality-control-wrapper mt-3">
        <ul class="nav nav-tabs" id="reportTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="classification-tab" data-bs-toggle="tab" data-bs-target="#classification" type="button" role="tab" aria-controls="classification" aria-selected="true">
                    <i class="fas fa-tags"></i> Статистика обращений по объектам
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#report2" type="button" role="tab" aria-controls="report2" aria-selected="false">
                    <i class="fas fa-chart-bar me-2"></i>Статистика обращений по типам и объектам
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="resorts-tab" data-bs-toggle="tab" data-bs-target="#resorts" type="button" role="tab" aria-controls="resorts" aria-selected="false">
                    <i class="fas fa-umbrella-beach me-2"></i>Статистика обращений по курортам
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="resort-types-tab" data-bs-toggle="tab" data-bs-target="#resort-types" type="button" role="tab" aria-controls="resort-types" aria-selected="false">
                    <i class="fas fa-chart-pie me-2"></i>По типу обращения по курортам
                </button>
            </li>
        </ul>

        <!-- Контейнеры вкладок -->
        <div class="tab-content" id="reportTabsContent">
            <!-- Содержимое вкладки Классификация -->
            <div class="tab-pane fade show active" id="classification" role="tabpanel" aria-labelledby="classification-tab" style="height: 100%; overflow-y: auto;">
                <!-- Основной контейнер с таблицей -->
                <div class="quality-control-container">
                    <!-- Секция фильтров -->
                    <div class="filters-container mb-3">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label for="classificationDateFrom" class="form-label">Дата с</label>
                                <input type="date" class="form-control" id="classificationDateFrom">
                            </div>
                            <div class="col-md-3">
                                <label for="classificationDateTo" class="form-label">Дата по</label>
                                <input type="date" class="form-control" id="classificationDateTo">
                            </div>
                            <div class="col-md-3">
                                <button type="button" class="btn btn-primary" id="applyClassificationFilters">
                                    <i class="fas fa-filter"></i> Применить
                                </button>
                                <button type="button" class="btn btn-success" id="exportClassificationExcel">
                                    <i class="fas fa-file-excel"></i> Экспорт в Excel
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Информация о неклассифицированных -->
                    <div class="unclassified-info mb-4">
                        <span id="unclassifiedCount">Неклассифицировано: 0</span>
                        <span id="unclassifiedSurveys" class="ms-3">Из них анкет: 0</span>
                    </div>

                    <!-- Добавляем начальное сообщение вместо таблицы -->
                    <div id="initialMessage" class="text-center my-4">
                        <p class="text-muted">Выберите период и нажмите "Применить" для загрузки данных</p>
                    </div>

                    <!-- Оборачиваем таблицу в div с display: none -->
                    <div id="tableContainer" style="display: none;">
                        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                            <table class="table table-bordered table-hover" id="classificationTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Классификация</th>
                                        <th>Жалоба</th>
                                        <th>Благодарность</th>
                                        <th>Вопрос</th>
                                        <th>Предложение</th>
                                        <th>Всего</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Данные будут добавлены через JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Индикатор загрузки -->
                    <div id="progressWrapper" class="progress-wrapper" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>
                </div>

                <!-- График во вкладке Классификация -->
                <div class="chart-container" id="classificationChartContainer" style="display: none;">
                    <div class="card">
                        <div class="card-body">
                            <div id="classificationChart" style="height: 800px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Содержимое вкладки Отчет 2 -->
            <div class="tab-pane fade" id="report2" role="tabpanel" aria-labelledby="report2-tab">
                <div class="quality-control-container">
                    <!-- Секция фильтров -->
                    <div class="filters-section">
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Период</h5>
                                <div class="d-flex align-items-center gap-3">
                                    <div class="me-2">
                                        <label for="dateFrom" class="form-label">с</label>
                                        <input type="date" class="form-control" id="dateFrom">
                                    </div>
                                    <div>
                                        <label for="dateTo" class="form-label">по</label>
                                        <input type="date" class="form-control" id="dateTo">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="assignedTo" class="form-label">На</label>
                                    <select class="form-select" id="assignedTo">
                                        <option selected>Выберите...</option>
                                    </select>
                                </div>
                                <div class="d-flex flex-column gap-2">
                                    <div>
                                        <label for="requestType" class="form-label">По типу обращения</label>
                                        <select id="requestTypeSelect" class="form-select">
                                            <option value="">Выберите...</option>
                                            {% for type in request_types %}
                                            <option value="{{ type.id }}">{{ type.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div>
                                        <label for="countrySelect" class="form-label">Страна</label>
                                        <select id="countrySelect" class="form-select">
                                            <option value="">Все страны</option>
                                        </select>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button id="applyFilters" class="btn btn-primary" type="button">
                                            <i class="fas fa-filter"></i> Применить
                                        </button>
                                        <button id="exportExcel" class="btn btn-success" type="button">
                                            <i class="fas fa-file-excel"></i> Экспорт в Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Добавляем счетчик записей -->
                    <div id="resultsCounter" class="results-counter" style="display: none;">
                        <div class="results-badge">
                            <i class="fas fa-list-ul me-2"></i>
                            <span class="count">0</span>
                            <span class="results-text">записей найдено</span>
                        </div>
                    </div>

                    <!-- Контейнер для прогресс бара -->
                    <div class="progress-wrapper" id="progressWrapper" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>

                    <!-- Таблица с результатами -->
                    <div class="table-responsive mt-4">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th class="text-start" style="width: 120px;">
                                        <i class="fas fa-hashtag me-2"></i>ID задачи
                                    </th>
                                    <th>
                                        <i class="fas fa-heading me-2"></i>Заголовок задачи
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="resultsTable">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Содержимое вкладки Курорты -->
            <div class="tab-pane fade" id="resorts" role="tabpanel" aria-labelledby="resorts-tab">
                <div class="quality-control-container">
                    <!-- Секция фильтров -->
                    <div class="filters-section mb-4">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label for="resortsDateFrom" class="form-label">Дата с</label>
                                <input type="date" class="form-control" id="resortsDateFrom">
                            </div>
                            <div class="col-md-3">
                                <label for="resortsDateTo" class="form-label">Дата по</label>
                                <input type="date" class="form-control" id="resortsDateTo">
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex gap-2">
                                    <button type="button" class="btn btn-primary" id="applyResortsFilters">
                                        <i class="fas fa-filter"></i> Применить
                                    </button>
                                    <button type="button" class="btn btn-success" id="exportResortsToExcel">
                                        <i class="fas fa-file-excel"></i> Экспорт в Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Индикатор загрузки -->
                    <div id="resortsProgressWrapper" class="progress-wrapper" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                        </div>
                    </div>

                    <!-- Таблица с данными -->
                    <div class="table-responsive">
                        <table class="table table-bordered" id="resortsTable">
                            <thead class="table-light">
                                <tr>
                                    <th>Курорты</th>
                                    <th>Жалоба</th>
                                    <th>Благодарность</th>
                                    <th>Вопрос</th>
                                    <th>Предложение</th>
                                    <th>Всего</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Данные будут добавлены через JavaScript -->
                            </tbody>
                            <tfoot>
                                <tr class="table-primary fw-bold">
                                    <td>ИТОГО</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                    <td>0</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Обновляем контейнер диаграммы с увеличенным отступом -->
            <div id="resortsChartContainer" class="mt-5 pt-4 border-top" style="display: none;">
                <div class="card">
                    <div class="card-body">
                        <div id="resortsChart" style="height: 500px;"></div>
                    </div>
                </div>
            </div>

            <!-- Содержимое новой вкладки По типу обращения по курортам -->
            <div class="tab-pane fade" id="resort-types" role="tabpanel" aria-labelledby="resort-types-tab">
                <div class="quality-control-container">
                    <!-- Секция фильтров -->
                    <div class="filters-section mb-4">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label for="resortTypesDateFrom" class="form-label">Дата с</label>
                                <input type="date" class="form-control" id="resortTypesDateFrom">
                            </div>
                            <div class="col-md-3">
                                <label for="resortTypesDateTo" class="form-label">Дата по</label>
                                <input type="date" class="form-control" id="resortTypesDateTo">
                            </div>
                            <div class="col-md-3">
                                <label for="resortTypesRequestTypeSelect" class="form-label">Тип обращения</label>
                                <select id="resortTypesRequestTypeSelect" class="form-select">
                                    <option value="">Выберите...</option>
                                    {% for type in request_types %}
                                    <option value="{{ type.id }}">{{ type.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-3">
                                <div class="d-flex gap-2">
                                    <button id="applyResortTypesFilters" class="btn btn-primary">
                                        <i class="fas fa-filter"></i> Применить
                                    </button>
                                    <button id="exportResortTypesExcel" class="btn btn-success">
                                        <i class="fas fa-file-excel"></i> Экспорт в Excel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Индикатор загрузки -->
                    <div id="resortTypesProgressWrapper" class="progress-wrapper" style="display: none;">
                        <p class="text-muted fst-italic mb-2">Формируется отчет, пожалуйста подождите...</p>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 style="width: 100%">
                            </div>
                        </div>
                    </div>

                    <!-- Таблица с результатами -->
                    <div class="table-responsive mt-4">
                        <table class="table table-bordered table-hover" id="resortTypesTable">
                            <thead>
                                <tr>
                                    <th>Курорт</th>
                                    <th>Авиакомпанию</th>
                                    <th>Агентство</th>
                                    <th>Агентство ТТР</th>
                                    <th>Водителя</th>
                                    <th>Всё понравилось</th>
                                    <th>Гида на трансфере</th>
                                    <th>Гида отельного</th>
                                    <th>Гида экскурсионного</th>
                                    <th>Другое</th>
                                    <th>Отель</th>
                                    <th>Встреча в порту</th>
                                    <th>Сотрудника отправляющего офиса</th>
                                    <th>Страховая компания</th>
                                    <th>Сотрудника принимающего офиса</th>
                                    <th>Трансфер</th>
                                    <th>Экскурсионный тур</th>
                                    <th>Экскурсия</th>
                                    <th>Трансфер групповой</th>
                                    <th>Трансфер индивидуальный</th>
                                    <th>Трансфер VIP</th>
                                    <th>Колл центр на курорте</th>
                                    <th>Колл центр отправляющего офиса</th>
                                    <th>Всего</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Данные будут добавлены через JavaScript -->
                            </tbody>
                            <tfoot>
                                <tr>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Секция комментариев -->
<div class="comment-sidebar" id="comment-sidebar">
    <div class="sidebar-header">
        <h5>
            <i class="fas fa-comments"></i>
            Комментарии
            <span class="badge badge-light" id="comment-badge">0</span>
        </h5>
        <div class="sidebar-controls">
            <button class="clear-all-btn" id="clearAllComments" title="Очистить все">
                <i class="fas fa-broom"></i>
            </button>
            <button class="close-sidebar">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="sidebar-content" id="comment-notifications">
        <!-- Динамическое содержимое -->
    </div>
</div>

<script>
// Глобальная переменная для отслеживания предыдущего количества комментариев
let previousCommentCount = 0;

// Переместите функцию updateCommentNotifications в глобальную область видимости
function updateCommentNotifications() {
    fetch('/comment-notifications', {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('comment-notifications');
        const badge = document.getElementById('comment-badge');
        const floatingBadge = document.getElementById('floating-comment-badge');

        if (data.count > previousCommentCount) {
            const newCommentsCount = data.count - previousCommentCount;
            notifyNewComments(newCommentsCount);
        }

        previousCommentCount = data.count;

        if (container) {
            container.innerHTML = data.html || '<div class="no-notifications">Нет новых комментариев</div>';

            // Добавляем обработчики для кнопок после обновления содержимого
            setupMarkAsReadHandlers();
        }

        // Всегда отображаем бейджи независимо от количества уведомлений
        if (badge) {
            badge.textContent = data.count;
            badge.style.display = 'inline-block';
        }
        if (floatingBadge) {
            floatingBadge.textContent = data.count;
            floatingBadge.style.display = 'inline-block';
        }
    })
    .catch(error => console.error('Error:', error));
}

// Глобальная переменная для хранения tracker_ids
let trackerIds = {
    gratitude: '',
    complaint: '',
    question: '',
    suggestion: ''
};

// Функция для загрузки tracker_ids
async function loadTrackerIds() {
    try {
        const response = await fetch('/get-tracker-ids');
        trackerIds = await response.json();
        console.log('Loaded tracker IDs:', trackerIds);
    } catch (error) {
        console.error('Ошибка при загрузке tracker IDs:', error);
    }
}

// Добавим переменную для хранения последних загруженных данных
let lastResortsData = null;

// Обновляем функцию updateResortsTable
function updateResortsTable(data) {
    // Сохраняем данные
    lastResortsData = data;

    const tbody = document.querySelector('#resortsTable tbody');
    const tfoot = document.querySelector('#resortsTable tfoot');
    tbody.innerHTML = '';

    if (!data || !Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Нет данных для отображения</td></tr>';
        tfoot.innerHTML = '';
        return;
    }

    // ... остальной код функции ...
}

// Обновляем обработчик переключения вкладок
document.addEventListener('DOMContentLoaded', function() {
    const tabLinks = document.querySelectorAll('.nav-link');
    const resortsTab = document.querySelector('[data-bs-target="#resorts"]');
    const chartContainer = document.getElementById('resortsChartContainer');

    // Сохраняем начальное состояние контейнера
    let isChartVisible = false;

    if (resortsTab) {
        resortsTab.addEventListener('shown.bs.tab', function (e) {
            // Если график был ранее показан, показываем его снова
            if (isChartVisible && chartContainer) {
                chartContainer.style.display = 'block';
                // Обновляем размер графика
                const chartDiv = document.getElementById('resortsChart');
                if (chartDiv && typeof Plotly !== 'undefined') {
                    Plotly.Plots.resize(chartDiv);
                }
            }
        });

        // Обработчик для других вкладок
        tabLinks.forEach(tab => {
            if (tab !== resortsTab) {
                tab.addEventListener('shown.bs.tab', function (e) {
                    if (chartContainer) {
                        // Сохраняем состояние видимости перед скрытием
                        isChartVisible = chartContainer.style.display !== 'none';
                        // Скрываем контейнер
                        chartContainer.style.display = 'none';
                    }
                });
            }
        });
    }
});

// Обновляем функцию loadResortsReport
function loadResortsReport() {
    const dateFrom = document.getElementById('resortsDateFrom').value;
    const dateTo = document.getElementById('resortsDateTo').value;

    if (!dateFrom || !dateTo) {
        alert('Пожалуйста, выберите период');
        return;
    }

    const progressWrapper = document.getElementById('resortsProgressWrapper');
    progressWrapper.style.display = 'block';

    fetch('/get-resorts-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            dateFrom: dateFrom,
            dateTo: dateTo
        })
    })
    .then(response => response.json())
    .then(data => {
        // Обновляем таблицу (и сохраняем данные)
        updateResortsTable(data);
        // Обновляем график
        updateResortsChart(data);
        progressWrapper.style.display = 'none';
    })
    .catch(error => {
        console.error('Ошибка при получении данных:', error);
        progressWrapper.style.display = 'none';
        alert('Произошла ошибка при загрузке данных');
    });
}

// Обновляем функцию updateResortsChart
function updateResortsChart(data) {
    const chartDiv = document.getElementById('resortsChart');
    const chartContainer = document.getElementById('resortsChartContainer');

    if (!chartDiv || !chartContainer || !data || !Array.isArray(data) || data.length === 0) {
        console.error('Chart elements not found or no data available');
        if (chartContainer) {
            chartContainer.style.display = 'none';
        }
        return;
    }

    // Устанавливаем стили контейнера
    chartContainer.style.width = '100%';
    chartContainer.style.maxWidth = '100%';
    chartDiv.style.width = '100%';
    chartDiv.style.height = '500px';

    const traces = [
        {
            name: 'Жалоба',
            type: 'bar',
            x: data.map(row => row.name),
            y: data.map(row => parseInt(row.complaints) || 0),
            marker: {color: '#ff6b6b'}
        },
        {
            name: 'Благодарность',
            type: 'bar',
            x: data.map(row => row.name),
            y: data.map(row => parseInt(row.gratitude) || 0),
            marker: {color: '#4dc9f6'}
        },
        {
            name: 'Вопрос',
            type: 'bar',
            x: data.map(row => row.name),
            y: data.map(row => parseInt(row.questions) || 0),
            marker: {color: '#ffd93d'}
        },
        {
            name: 'Предложение',
            type: 'bar',
            x: data.map(row => row.name),
            y: data.map(row => parseInt(row.suggestions) || 0),
            marker: {color: '#6c757d'}
        }
    ];

    const layout = {
        title: {
            text: 'Распределение обращений по курортам',
            font: { size: 16 }
        },
        barmode: 'group',
        height: 500,
        autosize: true,
        margin: {
            l: 60,
            r: 30,
            t: 40,
            b: 120
        },
        showlegend: true,
        legend: {
            orientation: 'h',
            yanchor: 'bottom',
            y: -0.3,
            xanchor: 'center',
            x: 0.5,
            font: { size: 12 }
        },
        yaxis: {
            title: 'Количество',
            titlefont: { size: 12 },
            tickfont: { size: 11 },
            automargin: true
        },
        xaxis: {
            tickangle: -45,
            tickfont: { size: 11 },
            automargin: true
        },
        bargap: 0.15,
        bargroupgap: 0.1
    };

    const config = {
        responsive: true,
        displayModeBar: false,
        staticPlot: true
    };

    // Показываем контейнер перед созданием графика
    chartContainer.style.display = 'block';

    // Создаем график
    Plotly.newPlot(chartDiv, traces, layout, config)
        .then(() => {
            // Обновляем размер и сохраняем состояние видимости
            window.dispatchEvent(new Event('resize'));
        })
        .catch(error => {
            console.error('Error creating chart:', error);
            chartContainer.style.display = 'none';
        });
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', async function() {
    try {
        // Загружаем tracker IDs перед инициализацией всех отчетов
        await loadTrackerIds();

        // Инициализация вкладок с помощью Bootstrap Tab
        var triggerTabList = [].slice.call(document.querySelectorAll('#reportTabs a'));
        triggerTabList.forEach(function(triggerEl) {
            var tabTrigger = new bootstrap.Tab(triggerEl);
            triggerEl.addEventListener('click', function(event) {
                event.preventDefault();
                tabTrigger.show();
            });
        });

        // Загрузка списков при инициализации страницы
        loadAssignedToList();
        loadRequestTypes();

        // Обработчики событий для кнопок
        const handlers = {
            'applyFilters': applyFilters,
            'exportExcel': exportToExcel,
            'applyResortsFilters': loadResortsReport,
            'exportResortsToExcel': exportResortsToExcel,
            'applyResortTypesFilters': loadResortTypesReport
        };

        // Привязываем обработчики с проверкой на ошибки
        Object.entries(handlers).forEach(([id, handler]) => {
            const element = document.getElementById(id);
            if (element && typeof handler === 'function') {
                element.addEventListener('click', handler);
            } else if (!element) {
                console.warn(`Element with id "${id}" not found`);
            } else {
                console.error(`Handler "${id}" is not a function`);
            }
        });

    } catch (error) {
        console.error('Error during initialization:', error);
    }
});

// Helper function to create cell content
function createCell(value, type, classification) {
    const numValue = parseInt(value) || 0;

    // Return just the number if it's 0
    if (numValue === 0) {
        return '0';
    }

    console.log('Creating cell for:', classification); // Debug log

    // Create clickable link for non-zero values
    return `<a href="#"
              class="classification-link text-decoration-none"
              data-classification="${encodeURIComponent(classification)}"
              data-type="${type}">${numValue}</a>`;
}

// Добавляем обработчик события для кликабельных значений
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('classification-link')) {
        e.preventDefault();
        e.stopPropagation();

        const classification = decodeURIComponent(e.target.dataset.classification);
        const type = e.target.dataset.type;
        const dateFrom = document.getElementById('classificationDateFrom').value;
        const dateTo = document.getElementById('classificationDateTo').value;

        let url = 'https://quality.teztour.com/projects/quality/issues?set_filter=1';

        // Добавляем фильтр по дате
        if (dateFrom && dateTo) {
            url += `&f%5Bcreated_on%5D=${dateFrom}%7C${dateTo}`;
        }

        // Проверяем, является ли это строкой "Анкеты"
        if (classification === 'Анкеты') {
            // Добавляем фильтр для анкет
            url += '&f%5Bcf_36%5D=%3D1';

            // Добавляем фильтр по типу обращения
            if (type === 'all') {
                url += '&f%5Btracker_id%5D=%3D18%7C19%7C20%7C21';
            } else if (type === 'complaint') {
                url += `&f%5Btracker_id%5D=%3D${trackerIds.complaint}`;
            } else if (type === 'gratitude') {
                url += `&f%5Btracker_id%5D=%3D${trackerIds.gratitude}`;
            } else if (type === 'question') {
                url += `&f%5Btracker_id%5D=%3D${trackerIds.question}`;
            } else if (type === 'suggestion') {
                url += `&f%5Btracker_id%5D=%3D${trackerIds.suggestion}`;
            }
        } else {
            // Для остальных классификаций используем старую логику
            if (classification.startsWith('GDS')) {
                url += '&f%5Bcf_41%5D=%3D2';
            } else {
                url += `&f%5Bcf_21%5D=%3D${encodeURIComponent(classification)}`;
            }

            // Добавляем фильтр по типу
            if (type === 'complaint') {
                url += `&f%5Btracker_id%5D=%3D${trackerIds.complaint}`;
            } else if (type === 'gratitude') {
                url += `&f%5Btracker_id%5D=%3D${trackerIds.gratitude}`;
            } else if (type === 'question') {
                url += `&f%5Btracker_id%5D=%3D${trackerIds.question}`;
            } else if (type === 'suggestion') {
                url += `&f%5Btracker_id%5D=%3D${trackerIds.suggestion}`;
            }
        }

        // Добавляем остальные параметры URL
        url += '&%5Bcolumn_names%5D%5B%5D=id' +
               '&%5Bcolumn_names%5D%5B%5D=easy_email_to' +
               '&%5Bcolumn_names%5D%5B%5D=created_on' +
               '&%5Bcolumn_names%5D%5B%5D=subject' +
               '&%5Bcolumn_names%5D%5B%5D=status' +
               '&%5Bcolumn_names%5D%5B%5D=priority' +
               '&%5Bcolumn_names%5D%5B%5D=assigned_to' +
               '&%5Bcolumn_names%5D%5B%5D=easy_closed_by' +
               '&%5Bcolumn_names%5D%5B%5D=closed_on' +
               '&group_by%5B%5D=' +
               '&show_sum_row=0' +
               '&show_sum_row=0' +
               '&load_groups_opened=0' +
               '&show_avatars=0' +
               '&show_avatars=1' +
               '&type=EasyIssueQuery' +
               '&outputs%5B%5D=list' +
               '&&';

        window.open(url, '_blank');
    }
});

// Функция обновления таблицы классификации
function updateClassificationTable(data) {

    const tbody = document.querySelector('#classificationTable tbody');
    tbody.innerHTML = '';

    // Initialize totals
    let totalComplaints = 0;
    let totalGratitude = 0;
    let totalQuestions = 0;
    let totalSuggestions = 0;
    let totalTotal = 0;

    // Add regular rows (except GDS, Unclassified and Surveys)
    data.classifications.forEach(row => {
        if (!row.name.startsWith('GDS') &&
            row.name !== 'Неклассифицировано' &&
            row.name !== 'Анкеты') {

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${row.name}</td>
                <td>${createCell(row.complaints, 'complaint', row.name)}</td>
                <td>${createCell(row.gratitude, 'gratitude', row.name)}</td>
                <td>${createCell(row.questions, 'question', row.name)}</td>
                <td>${createCell(row.suggestions, 'suggestion', row.name)}</td>
                <td>${createCell(row.total, 'all', row.name)}</td>
            `;
            tbody.appendChild(tr);

            // Add to totals
            totalComplaints += parseInt(row.complaints) || 0;
            totalGratitude += parseInt(row.gratitude) || 0;
            totalQuestions += parseInt(row.questions) || 0;
            totalSuggestions += parseInt(row.suggestions) || 0;
            totalTotal += parseInt(row.total) || 0;
        }
    });

    // Add GDS rows
    data.classifications.forEach(row => {
        if (row.name.startsWith('GDS')) {
            const tr = document.createElement('tr');
            tr.className = 'gds-row';
            tr.innerHTML = `
                <td>${row.name}</td>
                <td>${createCell(row.complaints, 'complaint', row.name)}</td>
                <td>${createCell(row.gratitude, 'gratitude', row.name)}</td>
                <td>${createCell(row.questions, 'question', row.name)}</td>
                <td>${createCell(row.suggestions, 'suggestion', row.name)}</td>
                <td>${createCell(row.total, 'all', row.name)}</td>
            `;
            tbody.appendChild(tr);

            // Add to totals
            totalComplaints += parseInt(row.complaints) || 0;
            totalGratitude += parseInt(row.gratitude) || 0;
            totalQuestions += parseInt(row.questions) || 0;
            totalSuggestions += parseInt(row.suggestions) || 0;
            totalTotal += parseInt(row.total) || 0;
        }
    });

    // Add "Unclassified" row (non-clickable)
    const unclassifiedRow = document.createElement('tr');
    unclassifiedRow.className = 'unclassified-row';
    unclassifiedRow.innerHTML = `
        <td>Неклассифицировано</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td>-</td>
        <td><a href="#" class="unclassified-link text-decoration-none">${data.unclassified.total}</a></td>>
    `;
    tbody.appendChild(unclassifiedRow);

    // Add "Surveys" row with clickable links
    const surveysRow = document.createElement('tr');
    surveysRow.className = 'surveys-row';
    surveysRow.innerHTML = `
        <td>Анкеты</td>
        <td>${data.surveys?.complaints > 0 ?
            `<a href="#" data-classification="Анкеты" data-type="complaint" class="classification-link text-decoration-none">${data.surveys.complaints}</a>` :
            '0'}</td>
        <td>${data.surveys?.gratitude > 0 ?
            `<a href="#" data-classification="Анкеты" data-type="gratitude" class="classification-link text-decoration-none">${data.surveys.gratitude}</a>` :
            '0'}</td>
        <td>${data.surveys?.questions > 0 ?
            `<a href="#" data-classification="Анкеты" data-type="question" class="classification-link text-decoration-none">${data.surveys.questions}</a>` :
            '0'}</td>
        <td>${data.surveys?.suggestions > 0 ?
            `<a href="#" data-classification="Анкеты" data-type="suggestion" class="classification-link text-decoration-none">${data.surveys.suggestions}</a>` :
            '0'}</td>
        <td>${data.surveys?.total > 0 ?
            `<a href="#" data-classification="Анкеты" data-type="all" class="classification-link text-decoration-none">${data.surveys.total}</a>` :
            '0'}</td>
    `;
    tbody.appendChild(surveysRow);

    // Add "Total" row (non-clickable)
    const totalRow = document.createElement('tr');
    totalRow.className = 'table-primary fw-bold';
    totalRow.innerHTML = `
        <td>Итого</td>
        <td>${totalComplaints}</td>
        <td>${totalGratitude}</td>
        <td>${totalQuestions}</td>
        <td>${totalSuggestions}</td>
        <td>${totalTotal}</td>
    `;
    tbody.appendChild(totalRow);

    // После успешного обновления таблицы, показываем график
    if (data && Object.keys(data).length > 0) {
        document.getElementById('classificationChartContainer').style.display = 'block';
        // Передаем все данные в функцию построения графика
        updateChart(data);
    }
}

// Заменяем функцию updateChart на новую версию с Plotly
function updateChart(data) {
    const chartDiv = document.getElementById('classificationChart');
    const chartContainer = document.getElementById('classificationChartContainer');

    if (!chartDiv) {
        console.error('Chart div element not found');
        return;
    }

    // Показываем контейнер с графиком
    chartContainer.style.display = 'block';

    // Подготавливаем данные для графика
    const classifications = data.classifications.filter(row =>
        !row.name.startsWith('GDS') &&
        row.name !== 'Неклассифицировано' &&
        row.name !== 'Анкеты'
    );

    // Создаем массивы для каждого типа обращений
    const traces = [
        {
            name: 'Жалоба',
            type: 'bar',
            x: classifications.map(row => row.name),
            y: classifications.map(row => parseInt(row.complaints) || 0),
            marker: {color: '#ff6b6b'}
        },
        {
            name: 'Благодарность',
            type: 'bar',
            x: classifications.map(row => row.name),
            y: classifications.map(row => parseInt(row.gratitude) || 0),
            marker: {color: '#4dc9f6'}
        },
        {
            name: 'Вопрос',
            type: 'bar',
            x: classifications.map(row => row.name),
            y: classifications.map(row => parseInt(row.questions) || 0),
            marker: {color: '#ffd93d'}
        },
        {
            name: 'Предложение',
            type: 'bar',
            x: classifications.map(row => row.name),
            y: classifications.map(row => parseInt(row.suggestions) || 0),
            marker: {color: '#6c757d'}
        }
    ];

    // Настройки макета
    const layout = {
        title: 'Распределение по типам обращений и объектам',
        barmode: 'group',
        height: 600,
        margin: {
            l: 100,
            r: 50,
            t: 50,
            b: 150  // Увеличиваем отступ снизу для легенды
        },
        showlegend: true,
        legend: {
            orientation: 'h',     // горизонтальная ориентация
            yanchor: 'bottom',    // привязка к низу
            y: -0.5,             // увеличиваем отступ снизу (было -0.3)
            xanchor: 'center',    // центрирование по горизонтали
            x: 0.5,
            traceorder: 'normal' // нормальный порядок элементов
        },
        yaxis: {
            title: 'Количество'
        },
        xaxis: {
            tickangle: -45,
            tickfont: { size: 11 },
            automargin: true
        }
    };

    // Настройки конфигурации
    const config = {
        responsive: true,
        displayModeBar: false,    // отключаем панель инструментов
        staticPlot: true         // отключаем все интерактивные функции
    };

    // Создаем график
    Plotly.newPlot(chartDiv, traces, layout, config);
}

// Вспомогательная функция для создания ячейки
function createCell(value, type, classification, isNonClickable) {
    const numValue = parseInt(value) || 0;

    if (numValue === 0 || isNonClickable) {
        return numValue;
    }

    return `<a href="#"
              data-classification="${encodeURIComponent(classification)}"
              data-type="${type}"
              class="classification-link text-decoration-none">${numValue}</a>`;
}

// Функция загрузки списка пользователей
function loadAssignedToList() {
    fetch('/get-assigned-to-values')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('assignedTo');
            select.innerHTML = '<option value="">Выберите...</option>';
            if (data.values && Array.isArray(data.values)) {
                data.values.forEach(value => {
                    const option = new Option(value, value);
                    select.add(option);
                });
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки списка пользователей:', error);
            const select = document.getElementById('assignedTo');
            select.innerHTML = '<option value="">Ошибка загрузки данных</option>';
        });
}

// Функция загрузки типов обращений
async function loadRequestTypes() {
    try {
        const response = await fetch('/get-request-types');
        const data = await response.json();
        const select = document.getElementById('requestTypeSelect');
        select.innerHTML = '<option value="">Выберите тип обращения...</option>';
        data.values.forEach(type => {
            const option = document.createElement('option');
            option.value = type.id;
            option.textContent = type.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Ошибка при загрузке типов обращений:', error);
    }
}

// Вспомогательная функция форматирования даты
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric'
    });
}

function applyFilters() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const assignedTo = document.getElementById('assignedTo').value;
    const requestType = document.getElementById('requestTypeSelect').value;
    const country = document.getElementById('countrySelect').value;

    // Проверяем заполнение всех полей
    let errorMessages = [];
    if (!dateFrom) errorMessages.push('Выберите начальную дату');
    if (!dateTo) errorMessages.push('Выберите конечную дату');
    if (!assignedTo) errorMessages.push('Выберите значение в поле "На"');
    if (!requestType) errorMessages.push('Выберите тип обращения');

    // Если есть ошибки, показываем их и прерываем выполнение
    if (errorMessages.length > 0) {
        alert('Пожалуйста, заполните все обязательные поля:\n' + errorMessages.join('\n'));
        return;
    }

    const progressWrapper = document.getElementById('progressWrapper');
    const progressBar = progressWrapper.querySelector('.progress-bar');
    const tableBody = document.getElementById('resultsTable');
    const resultsCounter = document.getElementById('resultsCounter');

    // Очищаем таблицу и показываем прогресс
    tableBody.innerHTML = '';
    progressWrapper.style.display = 'block';
    progressBar.style.width = '0%';
    resultsCounter.style.display = 'none';

    // Добавляем текст загрузки в таблицу
    tableBody.innerHTML = `
        <tr>
            <td colspan="2" class="text-center text-muted">
                <div class="py-4">
                    <i class="fas fa-spinner fa-spin me-2"></i>
                    Загрузка данных...
                </div>
            </td>
        </tr>
    `;

    // Имитация начала загрузки
    progressBar.style.width = '30%';

    fetch('/get-issues-by-category', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            dateFrom: dateFrom,
            dateTo: dateTo,
            assignedTo: assignedTo,
            requestType: requestType,
            country: country
        })
    })
    .then(response => {
        progressBar.style.width = '60%';
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        progressBar.style.width = '90%';

        if (data.error) {
            throw new Error(data.error);
        }

        if (!data.issues || !Array.isArray(data.issues)) {
            throw new Error('Получены некорректные данные от сервера');
        }

        // Очищаем сообщение о загрузке
        tableBody.innerHTML = '';

        // Заполняем таблицу данными
        if (data.issues.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="2" class="text-center">
                        <div class="py-4">
                            <i class="fas fa-info-circle me-2 text-muted"></i>
                            По заданным параметрам данные не найдены
                        </div>
                    </td>
                </tr>`;
        } else {
            data.issues.forEach(issue => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><a href="https://quality.teztour.com/issues/${issue.id}" target="_blank">${issue.id}</a></td>
                    <td>${issue.subject || 'Нет заголовка'}</td>
                `;
                tableBody.appendChild(row);
            });

            // Обновляем счетчик
            if (resultsCounter) {
                resultsCounter.style.display = 'block';
                const countElement = resultsCounter.querySelector('.count');
                if (countElement) {
                    countElement.textContent = data.issues.length;
                }
            }
        }

        // Включаем кнопку экспорта только если есть данные
        const exportButton = document.getElementById('exportExcel');
        if (exportButton) {
            exportButton.disabled = data.issues.length === 0;
        }

        // Завершение загрузки
        progressBar.style.width = '100%';
        setTimeout(() => {
            progressWrapper.style.display = 'none';
        }, 500);
    })
    .catch(error => {
        console.error('Ошибка при получении данных:', error);
        progressWrapper.style.display = 'none';
        resultsCounter.style.display = 'none';

        tableBody.innerHTML = `
            <tr>
                <td colspan="2" class="text-center text-danger">
                    <div class="py-4">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <div class="mb-2">Произошла ошибка при загрузке данных:</div>
                        <div class="small text-muted">${error.message}</div>
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-primary" onclick="applyFilters()">
                                <i class="fas fa-sync-alt me-1"></i>Повторить попытку
                            </button>
                        </div>
                    </div>
                </td>
            </tr>`;

        // Отключаем кнопку экспорта
        const exportButton = document.getElementById('exportExcel');
        if (exportButton) {
            exportButton.disabled = true;
        }
    });
}

function exportToExcel() {
    // Получаем активную вкладку и её название
    const activeTab = document.querySelector('.nav-tabs .nav-link.active');
    const reportName = activeTab.textContent.trim();

    // Получаем данные из таблицы
    const table = document.getElementById('resultsTable');
    if (!table) {
        console.error('Таблица не найдена');
        return;
    }

    const rows = table.rows;
    if (rows.length === 0) {
        alert('Нет данных для экспорта. Пожалуйста, примените фильтры сначала.');
        return;
    }

    // Создаем новую книгу Excel
    const wb = XLSX.utils.book_new();

    // Получаем значения фильтров
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const assignedTo = document.getElementById('assignedTo').options[document.getElementById('assignedTo').selectedIndex].text;
    const requestType = document.getElementById('requestTypeSelect').options[document.getElementById('requestTypeSelect').selectedIndex].text;

    // Создаем массив с информацией о фильтрах
    const filterInfo = [
        ['Параметры отчета:'],
        ['Период:', `с ${formatDate(dateFrom)} по ${formatDate(dateTo)}`],
        ['На:', assignedTo],
        ['Тип обращения:', requestType],
        ['Количество записей:', rows.length],
        [], // Пустая строка для разделения
    ];

    // Получаем заголовки из thead
    const headers = ['ID задачи', 'Заголовок задачи'];

    // Собираем данные из tbody
    const tableData = [headers];
    Array.from(rows).forEach(row => {
        const rowData = [];
        Array.from(row.cells).forEach(cell => {
            rowData.push(cell.textContent);
        });
        tableData.push(rowData);
    });

    // Объединяем информацию о фильтрах и данные таблицы
    const data = [...filterInfo, ...tableData];

    // Создаем лист с данными
    const ws = XLSX.utils.aoa_to_sheet(data);

    // Устанавливаем ширину столбцов
    const colWidths = [{ wch: 20 }, { wch: 50 }];
    ws['!cols'] = colWidths;

    // Добавляем стили для заголовка параметров
    ws['A1'] = { v: 'Параметры отчета:', s: { font: { bold: true } } };

    // Добавляем лист в книгу
    XLSX.utils.book_append_sheet(wb, ws, "Отчет");

    // Формируем имя файла из названия отчета
    const fileName = `${reportName}.xlsx`;

    // Сохраняем файл
    XLSX.writeFile(wb, fileName);
}

document.getElementById('applyFilters').addEventListener('click', function() {
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    const assignedTo = document.getElementById('assignedTo').value;
    const requestType = document.getElementById('requestTypeSelect').value;
    const country = document.getElementById('countrySelect').value;  // Получаем значение страны

    // Очищаем таблицу перед новым запросом
    const tableBody = document.querySelector('#issuesTable tbody');
    tableBody.innerHTML = '';

    fetch('/get-issues-by-category', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            dateFrom: dateFrom,
            dateTo: dateTo,
            assignedTo: assignedTo,
            requestType: requestType,
            country: country
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error('Error:', data.error);
            return;
        }

        // Проверяем полученные данные
        console.log('Received data:', data);

        // Очищаем таблицу перед заполнением новыми данными
        const tableBody = document.querySelector('#issuesTable tbody');
        tableBody.innerHTML = '';

        // Заполняем таблицу полученными данными
        data.issues.forEach(issue => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${issue.id}</td>
                <td>${issue.subject || ''}</td>
            `;
            tableBody.appendChild(row);
        });
    })
    .catch(error => {
        console.error('Error:', error);
    });
});

// Обработчик для кнопки "Применить" в отчете "Статистика обращений по объектам"
document.getElementById('applyClassificationFilters').addEventListener('click', loadClassificationReport);

function loadClassificationReport() {
    const dateFrom = document.getElementById('classificationDateFrom').value;
    const dateTo = document.getElementById('classificationDateTo').value;

    // Проверяем заполнение обязательных полей
    let errorMessages = [];
    if (!dateFrom) errorMessages.push('Выберите начальную дату');
    if (!dateTo) errorMessages.push('Выберите конечную дату');

    // Если есть ошибки, показываем их и прерываем выполнение
    if (errorMessages.length > 0) {
        alert('Пожалуйста, заполните все обязательные поля:\n' + errorMessages.join('\n'));
        return;
    }

    console.log('Отправка запроса с параметрами:', { dateFrom, dateTo }); // Отладочный вывод

    // Получаем необходимые элементы
    const progressWrapper = document.getElementById('progressWrapper');
    const tableContainer = document.getElementById('tableContainer');
    const initialMessage = document.getElementById('initialMessage');
    const chartContainer = document.getElementById('classificationChartContainer');

    // Показываем индикатор загрузки и скрываем остальные элементы
    progressWrapper.style.display = 'block';
    tableContainer.style.display = 'none';
    initialMessage.style.display = 'none';
    chartContainer.style.display = 'none';

    // Очищаем предыдущие данные
    document.querySelector('#classificationTable tbody').innerHTML = '';
    document.getElementById('unclassifiedCount').textContent = 'Неклассифицировано: 0';
    document.getElementById('unclassifiedSurveys').textContent = 'Из них анкет: 0';

    fetch('/get-classification-report', { // Изменен URL эндпоинта
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'  // Добавляем заголовок для AJAX-запроса
        },
        body: JSON.stringify({
            dateFrom: dateFrom,
            dateTo: dateTo
        })
    })
    .then(response => {
        console.log('Получен ответ от сервера:', response.status); // Отладочный вывод
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Получены данные:', data); // Отладочный вывод

        // Обновляем информацию о неклассифицированных
        document.getElementById('unclassifiedCount').innerHTML = `
            Неклассифицировано: <a href="#" class="unclassified-link text-decoration-none">${data.unclassified.total || 0}</a>
        `;
        document.getElementById('unclassifiedSurveys').innerHTML = `
            Из них анкет: <a href="#" class="unclassified-surveys-link text-decoration-none">${data.unclassified.surveys || 0}</a>
        `;

        // Обновляем таблицу и показываем график
        updateClassificationTable(data);

        // Показываем таблицу и график, скрываем загрузку
        progressWrapper.style.display = 'none';
        tableContainer.style.display = 'block';
        chartContainer.style.display = 'block';
    })
    .catch(error => {
        console.error('Подробная информация об ошибке:', error); // Расширенный вывод ошибки

        // Скрываем индикатор загрузки и показываем сообщение об ошибке
        progressWrapper.style.display = 'none';
        tableContainer.style.display = 'block';
        chartContainer.style.display = 'none';

        // Показываем сообщение об ошибке в таблице с дополнительной информацией
        document.querySelector('#classificationTable tbody').innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Произошла ошибка при загрузке данных: ${error.message}<br>
                    <small class="text-muted">Пожалуйста, проверьте консоль разработчика для получения дополнительной информации.</small>
                </td>
            </tr>`;
    });
}

// Убедимся, что HTML содержит canvas элемент
document.addEventListener('DOMContentLoaded', function() {
    const chartContainer = document.querySelector('.card-body');
    if (!document.getElementById('classificationChart')) {
        console.log('Canvas элемент не найден, создаем новый'); // Отладка
        const canvas = document.createElement('canvas');
        canvas.id = 'classificationChart';
        canvas.style.height = '400px';
        chartContainer.appendChild(canvas);
    }
});

// Добавляем обработчик события для кнопки применения фильтров
document.getElementById('applyClassificationFilters').addEventListener('click', function() {
    loadClassificationReport();
});

// Загружаем данные при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Удаляем вызов loadClassificationReport();
});

// Функция загрузки данных по курортам
function loadResortsReport() {
    const dateFrom = document.getElementById('resortsDateFrom').value;
    const dateTo = document.getElementById('resortsDateTo').value;

    if (!dateFrom || !dateTo) {
        alert('Пожалуйста, выберите период');
        return;
    }

    const progressWrapper = document.getElementById('resortsProgressWrapper');
    const chartContainer = document.getElementById('resortsChartContainer');

    progressWrapper.style.display = 'block';
    // Скрываем график при начале загрузки новых данных
    if (chartContainer) {
        chartContainer.style.display = 'none';
    }

    fetch('/get-resorts-report', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            dateFrom: dateFrom,
            dateTo: dateTo
        })
    })
    .then(response => response.json())
    .then(data => {
        updateResortsTable(data);
        // График будет показан внутри updateResortsChart если есть данные
        updateResortsChart(data);
        progressWrapper.style.display = 'none';
    })
    .catch(error => {
        console.error('Ошибка при получении данных:', error);
        progressWrapper.style.display = 'none';
        if (chartContainer) {
            chartContainer.style.display = 'none';
        }
        alert('Произошла ошибка при загрузке данных');
    });
}

// Обновляем функцию updateResortsTable
function updateResortsTable(data) {
    const tbody = document.querySelector('#resortsTable tbody');
    const tfoot = document.querySelector('#resortsTable tfoot');
    tbody.innerHTML = '';

    // Скрываем контейнер графика перед обновлением данных
    document.getElementById('resortsChartContainer').style.display = 'none';

    if (!data || !Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">Нет данных для отображения</td></tr>';
        tfoot.innerHTML = '';
        return;
    }

    // Инициализируем переменные для подсчета итогов
    let totalComplaints = 0;
    let totalGratitude = 0;
    let totalQuestions = 0;
    let totalSuggestions = 0;
    let grandTotal = 0;

    // Добавляем данные по курортам и считаем итоги
    data.forEach(resort => {
        const complaints = parseInt(resort.complaints) || 0;
        const gratitude = parseInt(resort.gratitude) || 0;
        const questions = parseInt(resort.questions) || 0;
        const suggestions = parseInt(resort.suggestions) || 0;
        const rowTotal = complaints + gratitude + questions + suggestions;

        // Добавляем к итогам
        totalComplaints += complaints;
        totalGratitude += gratitude;
        totalQuestions += questions;
        totalSuggestions += suggestions;
        grandTotal += rowTotal;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${resort.name}</td>
            <td class="text-end">
                ${complaints > 0 ?
                    `<a href="#" data-resort="${resort.name}" data-type="complaint" class="resort-link text-decoration-none">${complaints}</a>` :
                    '0'}
            </td>
            <td class="text-end">
                ${gratitude > 0 ?
                    `<a href="#" data-resort="${resort.name}" data-type="gratitude" class="resort-link text-decoration-none">${gratitude}</a>` :
                    '0'}
            </td>
            <td class="text-end">
                ${questions > 0 ?
                    `<a href="#" data-resort="${resort.name}" data-type="question" class="resort-link text-decoration-none">${questions}</a>` :
                    '0'}
            </td>
            <td class="text-end">
                ${suggestions > 0 ?
                    `<a href="#" data-resort="${resort.name}" data-type="suggestion" class="resort-link text-decoration-none">${suggestions}</a>` :
                    '0'}
            </td>
            <td class="text-end fw-bold">
                ${rowTotal > 0 ?
                    `<a href="#" data-resort="${resort.name}" data-type="all" class="resort-link text-decoration-none">${rowTotal}</a>` :
                    '0'}
            </td>
        `;
        tbody.appendChild(tr);
    });

    // Обновляем итоговую строку с кликабельными значениями
    tfoot.innerHTML = `
        <tr class="table-primary fw-bold">
            <td>ИТОГО</td>
            <td class="text-end">
                ${totalComplaints > 0 ?
                    `<a href="#" data-resort="" data-type="complaint" class="resort-link text-decoration-none">${totalComplaints}</a>` :
                    '0'}
            </td>
            <td class="text-end">
                ${totalGratitude > 0 ?
                    `<a href="#" data-resort="" data-type="gratitude" class="resort-link text-decoration-none">${totalGratitude}</a>` :
                    '0'}
            </td>
            <td class="text-end">
                ${totalQuestions > 0 ?
                    `<a href="#" data-resort="" data-type="question" class="resort-link text-decoration-none">${totalQuestions}</a>` :
                    '0'}
            </td>
            <td class="text-end">
                ${totalSuggestions > 0 ?
                    `<a href="#" data-resort="" data-type="suggestion" class="resort-link text-decoration-none">${totalSuggestions}</a>` :
                    '0'}
            </td>
            <td class="text-end">
                ${grandTotal > 0 ?
                    `<a href="#" data-resort="" data-type="all" class="resort-link text-decoration-none">${grandTotal}</a>` :
                    '0'}
            </td>
        </tr>
    `;

    // Добавляем обработчики событий для всех ссылок
    document.querySelectorAll('.resort-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const resort = this.dataset.resort;
            const type = this.dataset.type;
            const dateFrom = document.getElementById('resortsDateFrom').value;
            const dateTo = document.getElementById('resortsDateTo').value;
            const url = generateRedmineUrl(dateFrom, dateTo, resort, type);
            window.open(url, '_blank');
        });
    });

    // После успешного обновления таблицы, обновляем график
    updateResortsChart(data);
}

// Обновляем функцию updateResortsChart
function updateResortsChart(data) {
    const chartDiv = document.getElementById('resortsChart');
    const chartContainer = document.getElementById('resortsChartContainer');

    if (!chartDiv || !chartContainer || !data || !Array.isArray(data) || data.length === 0) {
        console.error('Chart elements not found or no data available');
        chartContainer.style.display = 'none';
        return;
    }

    // Устанавливаем стили контейнера
    chartContainer.style.width = '100%';
    chartContainer.style.maxWidth = '100%';
    chartDiv.style.width = '100%';
    chartDiv.style.height = '500px';

    const traces = [
        {
            name: 'Жалоба',
            type: 'bar',
            x: data.map(row => row.name),
            y: data.map(row => parseInt(row.complaints) || 0),
            marker: {color: '#ff6b6b'}
        },
        {
            name: 'Благодарность',
            type: 'bar',
            x: data.map(row => row.name),
            y: data.map(row => parseInt(row.gratitude) || 0),
            marker: {color: '#4dc9f6'}
        },
        {
            name: 'Вопрос',
            type: 'bar',
            x: data.map(row => row.name),
            y: data.map(row => parseInt(row.questions) || 0),
            marker: {color: '#ffd93d'}
        },
        {
            name: 'Предложение',
            type: 'bar',
            x: data.map(row => row.name),
            y: data.map(row => parseInt(row.suggestions) || 0),
            marker: {color: '#6c757d'}
        }
    ];

    const layout = {
        title: {
            text: 'Распределение обращений по курортам',
            font: { size: 16 }
        },
        barmode: 'group',
        height: 500,
        autosize: true,
        margin: {
            l: 60,
            r: 30,
            t: 40,
            b: 120
        },
        showlegend: true,
        legend: {
            orientation: 'h',
            yanchor: 'bottom',
            y: -0.3,
            xanchor: 'center',
            x: 0.5,
            font: { size: 12 }
        },
        yaxis: {
            title: 'Количество',
            titlefont: { size: 12 },
            tickfont: { size: 11 },
            automargin: true
        },
        xaxis: {
            tickangle: -45,
            tickfont: { size: 11 },
            automargin: true
        },
        bargap: 0.15,
        bargroupgap: 0.1
    };

    const config = {
        responsive: true,
        displayModeBar: false,
        staticPlot: true
    };

    // Показываем контейнер перед созданием графика
    chartContainer.style.display = 'block';

    // Создаем график
    Plotly.newPlot(chartDiv, traces, layout, config)
        .then(() => {
            // Обновляем размер и сохраняем состояние видимости
            window.dispatchEvent(new Event('resize'));
        })
        .catch(error => {
            console.error('Error creating chart:', error);
            chartContainer.style.display = 'none';
        });
}

// Добавляем обработчик для вкладки с графиком
document.addEventListener('DOMContentLoaded', function() {
    const resortsTab = document.querySelector('a[href="#resorts"]');
    if (resortsTab) {
        resortsTab.addEventListener('shown.bs.tab', function() {
            const chartDiv = document.getElementById('resortsChart');
            if (chartDiv) {
                // Принудительно вызываем обновление размера при показе вкладки
                window.dispatchEvent(new Event('resize'));
            }
        });
    }
});

// Обновляем обработчик переключения вкладок
document.addEventListener('DOMContentLoaded', function() {
    const tabLinks = document.querySelectorAll('.nav-link');
    const resortsChartContainer = document.getElementById('resortsChartContainer');
    const resortsTab = document.querySelector('a[href="#resorts"]');

    if (resortsTab) {
        // Обработчик события показа вкладки с отчетом по курортам
        resortsTab.addEventListener('shown.bs.tab', function() {
            const chartDiv = document.getElementById('resortsChart');
            // Проверяем, есть ли данные в таблице
            const tbody = document.querySelector('#resortsTable tbody');
            const hasData = tbody && tbody.children.length > 0 &&
                           !tbody.querySelector('td[colspan]'); // Проверка на отсутствие сообщения "Нет данных"

            if (hasData && chartDiv) {
                // Показываем контейнер графика
                resortsChartContainer.style.display = 'block';
                // Принудительно обновляем размер графика
                window.dispatchEvent(new Event('resize'));
            }
        });
    }

    tabLinks.forEach(tab => {
        tab.addEventListener('click', function() {
            if (resortsChartContainer) {
                // Скрываем график только при переключении на другую вкладку
                if (this.getAttribute('aria-controls') !== 'resorts') {
                    resortsChartContainer.style.display = 'none';
                }
            }
        });
    });
});

// Обновляем обработчик кнопки "Применить"
document.getElementById('applyResortTypesFilters').addEventListener('click', function() {
    const dateFrom = document.getElementById('resortTypesDateFrom').value;
    const dateTo = document.getElementById('resortTypesDateTo').value;
    const requestType = document.getElementById('resortTypesRequestTypeSelect').value;

    if (!dateFrom || !dateTo) {
        alert('Пожалуйста, выберите период');
        return;
    }

    if (!requestType) {
        alert('Пожалуйста, выберите тип обращения');
        return;
    }

    // Очищаем таблицу перед загрузкой новых данных
    const tbody = document.querySelector('#resortTypesTable tbody');
    const tfoot = document.querySelector('#resortTypesTable tfoot tr');
    tbody.innerHTML = '';
    tfoot.innerHTML = '';

    // Отключаем кнопку экспорта до загрузки новых данных
    document.getElementById('exportResortTypesExcel').disabled = true;

    // Показываем индикатор загрузки
    document.getElementById('resortTypesProgressWrapper').style.display = 'block';

    // Запрос данных с сервера
    fetch('/get-resort-types-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            dateFrom: dateFrom,
            dateTo: dateTo,
            trackerId: requestType
        })
    })
    .then(response => response.json())
    .then(data => {
        updateResortTypesTable(data);
        document.getElementById('resortTypesProgressWrapper').style.display = 'none';
        document.getElementById('exportResortTypesExcel').disabled = false;
    })
    .catch(error => {
        console.error('Ошибка:', error);
        document.getElementById('resortTypesProgressWrapper').style.display = 'none';
        alert('Произошла ошибка при загрузке данных');
    });
});

// Функция загрузки отчета по типам обращений по курортам
function loadResortTypesReport() {
    const dateFrom = document.getElementById('resortTypesDateFrom').value;
    const dateTo = document.getElementById('resortTypesDateTo').value;
    const requestTypeSelect = document.getElementById('resortTypesRequestTypeSelect');
    const progressWrapper = document.getElementById('resortTypesProgressWrapper');
    const tableBody = document.querySelector('#resortTypesTable tbody');
    const selectedTrackerId = requestTypeSelect?.value; // Перемещено сюда

    // Проверяем наличие необходимых элементов
    if (!tableBody) {
        console.error('Элемент таблицы не найден');
        return;
    }

    if (!progressWrapper) {
        console.error('Элемент индикатора загрузки не найден');
        return;
    }

    if (!dateFrom || !dateTo || !selectedTrackerId) {
        alert('Пожалуйста, заполните все поля фильтров');
        return;
    }

    // Очищаем таблицу и показываем индикатор загрузки
    tableBody.innerHTML = '';
    progressWrapper.style.display = 'block';

    fetch('/get-resort-types-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            dateFrom: dateFrom,
            dateTo: dateTo,
            trackerId: selectedTrackerId
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Ошибка сервера: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        updateResortTypesTable(data);
    })
    .catch(error => {
        console.error('Ошибка при загрузке данных:', error);
        if (tableBody) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="24" class="text-center text-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Ошибка при загрузке данных: ${error.message}
                    </td>
                </tr>`;
        }
    })
    .finally(() => {
        // Скрываем индикатор загрузки только если он существует
        if (progressWrapper) {
            progressWrapper.style.display = 'none';
        }
    });
}

// Функция обновления таблицы
function updateResortTypesTable(data) {
    const tbody = document.querySelector('#resortTypesTable tbody');
    const tfoot = document.querySelector('#resortTypesTable tfoot tr');
    tbody.innerHTML = '';

    if (!data || !Array.isArray(data)) {
        console.error('Получены некорректные данные:', data);
        tbody.innerHTML = '<tr><td colspan="24" class="text-center">Нет данных для отображения</td></tr>';
        tfoot.innerHTML = '';
        return;
    }

    const totals = new Array(22).fill(0);

    try {
        data.forEach(row => {
            const tr = document.createElement('tr');

            const values = [
                row.count_issues_avia,
                row.count_issues_agency,
                row.count_issues_agencyTTR,
                row.count_issues_driver,
                row.count_issues_allok,
                row.count_issues_guide_transfer,
                row.count_issues_guide_hotel,
                row.count_issues_guide_excursion,
                row.count_issues_another,
                row.count_issues_hotel,
                row.count_issues_meeting_port,
                row.count_issues_employee_sending,
                row.count_issues_insurance,
                row.count_issues_employee_receiving,
                row.count_issues_transfer,
                row.count_issues_excursion_tour,
                row.count_issues_excursion,
                row.count_issues_transfer_group,
                row.count_issues_transfer_individual,
                row.count_issues_transfer_vip,
                row.count_issues_call_centre_resort,
                row.count_issues_call_centre_sender_office
            ];

            const rowTotal = values.reduce((sum, val) => sum + (parseInt(val) || 0), 0);
            values.forEach((val, idx) => {
                totals[idx] += (parseInt(val) || 0);
            });

            // Создаем кликабельные ячейки
            const cells = values.map((val, index) => {
                const typeInfo = getTypeByIndex(index);
                return val > 0 ?
                    `<td class="text-end">
                        <a href="#"
                           data-resort="${row.resort_name}"
                           data-type="${typeInfo.type}"
                           data-target="${encodeURIComponent(typeInfo.target)}"
                           class="resort-link text-decoration-none">${val}</a>
                    </td>` :
                    `<td class="text-end">0</td>`;
            });

            tr.innerHTML = `
                <td>${row.resort_name || ''}</td>
                ${cells.join('')}
                <td class="text-end fw-bold">
                    ${rowTotal > 0 ?
                        `<a href="#" data-resort="${row.resort_name}" data-type="all" data-target="" class="resort-link text-decoration-none">${rowTotal}</a>` :
                        '0'}
                </td>
            `;
            tbody.appendChild(tr);
        });

        const totalSum = totals.reduce((sum, val) => sum + val, 0);

        // Создаем кликабельные итоговые значения
        const totalCells = totals.map((val, index) => {
            const typeInfo = getTypeByIndex(index);
            return val > 0 ?
                `<td class="table-primary fw-bold text-end">
                    <a href="#" data-resort="" data-type="${typeInfo.type}" data-target="${encodeURIComponent(typeInfo.target)}" class="resort-link text-decoration-none">${val}</a>
                </td>` :
                `<td class="table-primary fw-bold text-end">0</td>`;
        });

        tfoot.innerHTML = `
            <td class="table-primary fw-bold">ИТОГО</td>
            ${totalCells.join('')}
            <td class="table-primary fw-bold text-end">
                ${totalSum > 0 ?
                    `<a href="#" data-resort="" data-type="all" data-target="" class="resort-link text-decoration-none">${totalSum}</a>` :
                    '0'}
            </td>
        `;

        // Добавляем обработчики событий для всех ссылок
        document.querySelectorAll('.resort-link').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const resort = this.dataset.resort;
                const target = decodeURIComponent(this.dataset.target);
                const dateFrom = document.getElementById('resortTypesDateFrom').value;
                const dateTo = document.getElementById('resortTypesDateTo').value;
                // Получаем выбранный тип обращения из селекта
                const selectedTrackerId = document.getElementById('resortTypesRequestTypeSelect').value;

                // Создаем URL с выбранным типом обращения
                const url = generateRedmineUrlForResortTypes(dateFrom, dateTo, resort, selectedTrackerId, target);
                window.open(url, '_blank');
            });
        });

    } catch (error) {
        console.error('Ошибка при обработке данных:', error);
        tbody.innerHTML = '<tr><td colspan="24" class="text-center">Ошибка при обработке данных</td></tr>';
        tfoot.innerHTML = '';
    }
}

// Вспомогательная функция для получения типа обращения по индексу
function getTypeByIndex(index) {
    const types = [
        { type: 'gratitude', target: 'Авиакомпанию' },
        { type: 'gratitude', target: 'Агентство' },
        { type: 'gratitude', target: 'Агентство ТТР' },
        { type: 'gratitude', target: 'Водителя' },
        { type: 'gratitude', target: 'Всё понравилось' },
        { type: 'gratitude', target: 'Гида на трансфере' },
        { type: 'gratitude', target: 'Гида отельного' },
        { type: 'gratitude', target: 'Гида экскурсионного' },
        { type: 'gratitude', target: 'Другое' },
        { type: 'gratitude', target: 'Отель' },
        { type: 'gratitude', target: 'Встреча в порту' },
        { type: 'gratitude', target: 'Сотрудника отправляющего офиса' },
        { type: 'gratitude', target: 'Страховая компания' },
        { type: 'gratitude', target: 'Сотрудника принимающего офиса' },
        { type: 'gratitude', target: 'Трансфер' },
        { type: 'gratitude', target: 'Экскурсионный тур' },
        { type: 'gratitude', target: 'Экскурсия' },
        { type: 'gratitude', target: 'Трансфер групповой' },
        { type: 'gratitude', target: 'Трансфер индивидуальный' },
        { type: 'gratitude', target: 'Трансфер VIP' },
        { type: 'gratitude', target: 'Колл центр на курорте' },
        { type: 'gratitude', target: 'Колл центр отправляющего офиса' }
    ];
    return types[index] || { type: 'all', target: '' };
}

// Обновляем функцию экспорта в Excel
document.getElementById('exportResortTypesExcel').addEventListener('click', async function() {
    const dateFrom = document.getElementById('resortTypesDateFrom').value;
    const dateTo = document.getElementById('resortTypesDateTo').value;
    const requestType = document.getElementById('resortTypesRequestTypeSelect').options[document.getElementById('resortTypesRequestTypeSelect').selectedIndex].text;

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Отчет по курортам');

    // Добавляем параметры фильтрации
    worksheet.addRow(['Параметры фильтрации:']);
    worksheet.addRow(['Период:', `с ${formatDate(dateFrom)} по ${formatDate(dateTo)}`]);
    worksheet.addRow(['Тип обращения:', requestType]);
    worksheet.addRow([]); // Пустая строка для разделения

    // Получаем данные из таблицы
    const table = document.getElementById('resortTypesTable');
    const headerRow = table.querySelector('thead tr');
    const headers = Array.from(headerRow.cells).map(cell => cell.textContent);

    worksheet.addRow(headers);

    // Получаем данные строк
    const rows = Array.from(table.querySelectorAll('tbody tr, tfoot tr'));
    rows.forEach(row => {
        const rowData = Array.from(row.cells).map(cell => {
            // Преобразуем текстовые значения в числа для числовых столбцов
            const value = cell.textContent.trim();
            return isNaN(value) ? value : Number(value);
        });
        worksheet.addRow(rowData);
    });

    // Устанавливаем ширину столбцов и стили
    worksheet.columns = headers.map(() => ({ width: 15 }));
    worksheet.getColumn(1).width = 30; // Делаем первый столбец (Курорт) шире

    // Применяем стили к заголовкам
    const headerExcelRow = worksheet.getRow(5);
    headerExcelRow.font = { bold: true };
    headerExcelRow.fill = {
        type: 'pattern',
        pattern: 'solid',
        fgColor: { argb: 'FFE6E6E6' }
    };

    // Выравнивание для числовых столбцов
    for(let i = 2; i <= worksheet.columnCount; i++) {
        worksheet.getColumn(i).alignment = { horizontal: 'right' };
    }

    // Сохраняем файл
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'resort_types_report.xlsx';
    a.click();
    window.URL.revokeObjectURL(url);
});

async function exportResortsToExcel() {
    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Курорты');

    // Получаем значения фильтров
    const dateFrom = document.getElementById('resortsDateFrom').value;
    const dateTo = document.getElementById('resortsDateTo').value;

    // Добавляем заголовок и информацию о периоде
    worksheet.addRow(['Отчет "Курорты"']);
    worksheet.addRow(['Период:', `с ${formatDate(dateFrom)} по ${formatDate(dateTo)}`]);
    worksheet.addRow([]); // Пустая строка

    // Получаем заголовки из таблицы
    const headers = Array.from(document.querySelectorAll('#resortsTable thead th')).map(th => th.textContent);
    worksheet.addRow(headers);

    // Получаем данные из таблицы
    const tbody = document.querySelector('#resortsTable tbody');
    const tfoot = document.querySelector('#resortsTable tfoot');

    // Добавляем данные из tbody
    Array.from(tbody.querySelectorAll('tr')).forEach(row => {
        const rowData = Array.from(row.children).map((cell, index) => {
            const link = cell.querySelector('a');
            const value = link ? link.textContent : cell.textContent;
            // Преобразуем все числовые значения в числа
            return index === 0 ? value : parseInt(value) || 0;
        });
        worksheet.addRow(rowData);
    });

    // Добавляем итоговую строку
    const footerRow = tfoot.querySelector('tr');
    if (footerRow) {
        const footerData = Array.from(footerRow.children).map((cell, index) => {
            const link = cell.querySelector('a');
            const value = link ? link.textContent : cell.textContent;
            return index === 0 ? value : parseInt(value) || 0;
        });
        worksheet.addRow(footerData);
    }

    // Устанавливаем ширину столбцов
    worksheet.columns = worksheet.columns.map((column, index) => ({
        width: index === 0 ? 30 : 15
    }));

    // Применяем стили
    worksheet.eachRow((row, rowNumber) => {
        row.eachCell((cell, colNumber) => {
            // Границы для всех ячеек
            cell.border = {
                top: { style: 'thin' },
                left: { style: 'thin' },
                bottom: { style: 'thin' },
                right: { style: 'thin' }
            };

            // Выравнивание: первая колонка - по левому краю, остальные - по правому
            if (colNumber === 1) {
                cell.alignment = { horizontal: 'left' };
            } else {
                cell.alignment = { horizontal: 'right' };
            }
        });

        // Жирный шрифт для заголовков и итоговой строки
        if (rowNumber === 1 || rowNumber === 4 || row.getCell(1).value === 'ИТОГО') {
            row.font = { bold: true };
        }

        // Выделение цветом итоговой строки
        if (row.getCell(1).value === 'ИТОГО') {
            row.eachCell((cell) => {
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFE6E6FA' }
                };
            });
        }
    });

    // Сохраняем файл
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Курорты.xlsx';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Добавляем новую функцию для генерации URL специально для отчета "По типу обращения по курортам"
function generateRedmineUrlForResortTypes(dateFrom, dateTo, resort, trackerId, target) {
    const baseUrl = 'https://quality.teztour.com/projects/quality/issues';
    let url = `${baseUrl}?set_filter=1`;

    // Add date filter
    if (dateFrom && dateTo) {
        url += `&f%5Bcreated_on%5D=${dateFrom}%7C${dateTo}`;
    }

    // Add resort filter if specified
    if (resort) {
        url += `&f%5Bcf_20%5D=%3D${encodeURIComponent(resort)}`;
    }

    // Add target filter if specified
    if (target) {
        url += `&f%5Bcf_21%5D=%3D${encodeURIComponent(target)}`;
    }

    // Add tracker filter
    if (trackerId) {
        url += `&f%5Btracker_id%5D=%3D${trackerId}`;
    }

    // Add remaining parameters
    url += '&group_by%5B%5D=&show_sum_row=0&load_groups_opened=0&show_avatars=1' +
           '&type=EasyIssueQuery&outputs%5B%5D=list';

    // Add columns
    const columns = ['id', 'easy_email_to', 'created_on', 'subject', 'status',
                    'priority', 'assigned_to', 'easy_closed_by', 'closed_on'];
    columns.forEach(column => {
        url += `&%5Bcolumn_names%5D%5B%5D=${column}`;
    });

    return url;
}

// Добавляем обработчик для клика по "Неклассифицировано"
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('unclassified-link')) {
        e.preventDefault();
        const dateFrom = document.getElementById('classificationDateFrom').value;
        const dateTo = document.getElementById('classificationDateTo').value;

        let url = 'https://quality.teztour.com/projects/quality/issues?set_filter=1';

        // Добавляем фильтр по дате
        if (dateFrom && dateTo) {
            url += `&f%5Bcreated_on%5D=${dateFrom}%7C${dateTo}`;
        }

        // Добавляем фильтры для неклассифицированных задач
        url += '&f%5Btracker_id%5D=%3D1' +  // тип задачи "Обращение"
               '&f%5Bstatus_id%5D=!21' +    // исключаем определенный статус
               '&%5Bcolumn_names%5D%5B%5D=id' +
               '&%5Bcolumn_names%5D%5B%5D=easy_email_to' +
               '&%5Bcolumn_names%5D%5B%5D=created_on' +
               '&%5Bcolumn_names%5D%5B%5D=subject' +
               '&%5Bcolumn_names%5D%5B%5D=status' +
               '&%5Bcolumn_names%5D%5B%5D=priority' +
               '&%5Bcolumn_names%5D%5B%5D=assigned_to' +
               '&%5Bcolumn_names%5D%5B%5D=easy_closed_by' +
               '&%5Bcolumn_names%5D%5B%5D=closed_on' +
               '&group_by%5B%5D=' +
               '&show_sum_row=0' +
               '&show_sum_row=0' +
               '&load_groups_opened=0' +
               '&show_avatars=0' +
               '&show_avatars=1' +
               '&type=EasyIssueQuery' +
               '&outputs%5B%5D=list' +
               '&&';

        window.open(url, '_blank');
    }
});

// Добавляем обработчик для клика по ссылке анкет
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('unclassified-surveys-link')) {
        e.preventDefault();
        const dateFrom = document.getElementById('classificationDateFrom').value;
        const dateTo = document.getElementById('classificationDateTo').value;

        let url = 'https://quality.teztour.com/projects/quality/issues?set_filter=1';

        // Добавляем фильтр по дате
        if (dateFrom && dateTo) {
            url += `&f%5Bcreated_on%5D=${dateFrom}%7C${dateTo}`;
        }

        // Добавляем фильтры для неклассифицированных анкет
        url += '&f%5Btracker_id%5D=%3D1' +  // тип задачи "Обращение"
               '&f%5Bstatus_id%5D=!21' +    // исключаем определенный статус
               '&f%5Bcf_36%5D=%3D1' +       // дополнительный фильтр для анкет
               '&%5Bcolumn_names%5D%5B%5D=id' +
               '&%5Bcolumn_names%5D%5B%5D=easy_email_to' +
               '&%5Bcolumn_names%5D%5B%5D=created_on' +
               '&%5Bcolumn_names%5D%5B%5D=subject' +
               '&%5Bcolumn_names%5D%5B%5D=status' +
               '&%5Bcolumn_names%5D%5B%5D=priority' +
               '&%5Bcolumn_names%5D%5B%5D=assigned_to' +
               '&%5Bcolumn_names%5D%5B%5D=easy_closed_by' +
               '&%5Bcolumn_names%5D%5B%5D=closed_on' +
               '&group_by%5B%5D=' +
               '&show_sum_row=0' +
               '&show_sum_row=0' +
               '&load_groups_opened=0' +
               '&show_avatars=0' +
               '&show_avatars=1' +
               '&type=EasyIssueQuery' +
               '&outputs%5B%5D=list' +
               '&&';

        window.open(url, '_blank');
    }
});

// Добавляем обработчик для клика по ссылкам в строке "Анкеты"
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('classification-link') && e.target.dataset.classification === 'Анкеты') {
        e.preventDefault();
        const dateFrom = document.getElementById('classificationDateFrom').value;
        const dateTo = document.getElementById('classificationDateTo').value;
        const type = e.target.dataset.type;

        let url = 'https://quality.teztour.com/projects/quality/issues?set_filter=1';

        // Добавляем фильтр по дате
        if (dateFrom && dateTo) {
            url += `&f%5Bcreated_on%5D=${dateFrom}%7C${dateTo}`;
        }

        // Добавляем фильтр для анкет
        url += '&f%5Bcf_36%5D=%3D1';

        // Добавляем фильтр по типу обращения
        if (type === 'all') {
            // Для "Всего" добавляем все типы обращений
            url += '&f%5Btracker_id%5D=%3D18%7C19%7C20%7C21';
        } else if (type === 'complaint') {
            url += `&f%5Btracker_id%5D=%3D${trackerIds.complaint}`;
        } else if (type === 'gratitude') {
            url += `&f%5Btracker_id%5D=%3D${trackerIds.gratitude}`;
        } else if (type === 'question') {
            url += `&f%5Btracker_id%5D=%3D${trackerIds.question}`;
        } else if (type === 'suggestion') {
            url += `&f%5Btracker_id%5D=%3D${trackerIds.suggestion}`;
        }

        // Добавляем остальные параметры URL
        url += '&%5Bcolumn_names%5D%5B%5D=id' +
               '&%5Bcolumn_names%5D%5B%5D=easy_email_to' +
               '&%5Bcolumn_names%5D%5B%5D=created_on' +
               '&%5Bcolumn_names%5D%5B%5D=subject' +
               '&%5Bcolumn_names%5D%5B%5D=status' +
               '&%5Bcolumn_names%5D%5B%5D=priority' +
               '&%5Bcolumn_names%5D%5B%5D=assigned_to' +
               '&%5Bcolumn_names%5D%5B%5D=easy_closed_by' +
               '&%5Bcolumn_names%5D%5B%5D=closed_on' +
               '&group_by%5B%5D=' +
               '&show_sum_row=0' +
               '&show_sum_row=0' +
               '&load_groups_opened=0' +
               '&show_avatars=0' +
               '&show_avatars=1' +
               '&type=EasyIssueQuery' +
               '&outputs%5B%5D=list' +
               '&&';

        window.open(url, '_blank');
    }
});

// Функция экспорта в Excel для отчета "Статистика обращений по объектам"
async function exportClassificationToExcel() {
    const dateFrom = document.getElementById('classificationDateFrom').value;
    const dateTo = document.getElementById('classificationDateTo').value;

    // Получаем значения неклассифицированных обращений и анкет
    const unclassifiedCount = document.getElementById('unclassifiedCount').textContent;
    const unclassifiedSurveys = document.getElementById('unclassifiedSurveys').textContent;

    const workbook = new ExcelJS.Workbook();
    const worksheet = workbook.addWorksheet('Статистика обращений');

    // Добавляем заголовок и информацию
    worksheet.addRow(['Статистика обращений по объектам']);
    worksheet.addRow(['Период:', `с ${formatDate(dateFrom)} по ${formatDate(dateTo)}`]);
    worksheet.addRow([unclassifiedCount]); // Добавляем количество неклассифицированных
    worksheet.addRow([unclassifiedSurveys]); // Добавляем количество анкет
    worksheet.addRow([]); // Пустая строка перед таблицей

    // Получаем заголовки из таблицы
    const headers = Array.from(document.querySelectorAll('#classificationTable thead th')).map(th => th.textContent);
    worksheet.addRow(headers);

    // Получаем данные из таблицы
    const tbody = document.querySelector('#classificationTable tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));

    // Добавляем данные из tbody
    rows.forEach(row => {
        const rowData = Array.from(row.children).map((cell, index) => {
            const link = cell.querySelector('a');
            const value = link ? link.textContent : cell.textContent.trim();

            // Для строки "Неклассифицировано" сохраняем прочерки
            if (row.classList.contains('unclassified-row')) {
                return value;
            }

            // Для остальных строк преобразуем в числа (кроме первой колонки)
            return index === 0 ? value : parseInt(value) || 0;
        });
        worksheet.addRow(rowData);
    });

    // Устанавливаем ширину столбцов
    worksheet.columns = worksheet.columns.map((column, index) => ({
        width: index === 0 ? 30 : 15
    }));

    // Применяем стили
    worksheet.eachRow((row, rowNumber) => {
        row.eachCell((cell, colNumber) => {
            // Границы для ячеек таблицы (начиная с заголовков)
            if (rowNumber > 5) {
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
            }

            // Выравнивание: первая колонка - по левому краю, остальные - по правому
            if (colNumber === 1) {
                cell.alignment = { horizontal: 'left' };
            } else {
                cell.alignment = { horizontal: 'right' };
            }
        });

        // Жирный шрифт для заголовка, периода, неклассифицированных данных и заголовков таблицы
        if (rowNumber <= 4 || rowNumber === 6 || row.getCell(1).value === 'ИТОГО') {
            row.font = { bold: true };
        }

        // Выделение цветом итоговой строки
        if (row.getCell(1).value === 'ИТОГО') {
            row.eachCell((cell) => {
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFE6E6FA' }
                };
            });
        }
    });

    // Сохраняем файл
    const buffer = await workbook.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Статистика_обращений.xlsx';
    a.click();
    window.URL.revokeObjectURL(url);
}

// Добавляем обработчик события для клика по кнопке экспорта
document.getElementById('exportClassificationExcel').addEventListener('click', exportClassificationToExcel);

// Функция для генерации URL для Redmine
function generateRedmineUrl(dateFrom, dateTo, resort, type) {
    const baseUrl = 'https://quality.teztour.com/projects/quality/issues';
    let url = `${baseUrl}?set_filter=1`;

    // Добавляем фильтр по дате
    if (dateFrom && dateTo) {
        url += `&f%5Bcreated_on%5D=${dateFrom}%7C${dateTo}`;
    }

    // Добавляем фильтр по курорту
    if (resort) {
        url += `&f%5Bcf_20%5D=%3D${encodeURIComponent(resort)}`;
    }

    // Добавляем фильтр по типу обращения
    if (type === 'complaint') {
        url += `&f%5Btracker_id%5D=%3D${trackerIds.complaint}`;
    } else if (type === 'gratitude') {
        url += `&f%5Btracker_id%5D=%3D${trackerIds.gratitude}`;
    } else if (type === 'question') {
        url += `&f%5Btracker_id%5D=%3D${trackerIds.question}`;
    } else if (type === 'suggestion') {
        url += `&f%5Btracker_id%5D=%3D${trackerIds.suggestion}`;
    } else if (type === 'all') {
        // Для "Всего" добавляем все типы обращений
        url += `&f%5Btracker_id%5D=%3D${trackerIds.complaint}%7C${trackerIds.gratitude}%7C${trackerIds.question}%7C${trackerIds.suggestion}`;
    }

    // Добавляем остальные параметры URL
    url += '&%5Bcolumn_names%5D%5B%5D=id' +
           '&%5Bcolumn_names%5D%5B%5D=easy_email_to' +
           '&%5Bcolumn_names%5D%5B%5D=created_on' +
           '&%5Bcolumn_names%5D%5B%5D=subject' +
           '&%5Bcolumn_names%5D%5B%5D=status' +
           '&%5Bcolumn_names%5D%5B%5D=priority' +
           '&%5Bcolumn_names%5D%5B%5D=assigned_to' +
           '&%5Bcolumn_names%5D%5B%5D=easy_closed_by' +
           '&%5Bcolumn_names%5D%5B%5D=closed_on' +
           '&group_by%5B%5D=' +
           '&show_sum_row=0' +
           '&load_groups_opened=0' +
           '&show_avatars=1' +
           '&type=EasyIssueQuery' +
           '&outputs%5B%5D=list';

    return url;
}

// Add this to your existing JavaScript code
function loadNewIssuesCount() {
    fetch('/get-new-issues-count')
        .then(response => response.json())
        .then(data => {
            const counter = document.getElementById('newIssuesCounter');
            const countElement = counter.querySelector('.count');

            if (data.count > 0) {
                countElement.textContent = data.count;
                counter.classList.add('has-new');
            } else {
                countElement.textContent = '0';
                counter.classList.remove('has-new');
            }
        })
        .catch(error => console.error('Error fetching new issues count:', error));
}


// Load initial count and set up periodic refresh
document.addEventListener('DOMContentLoaded', function() {
    loadNewIssuesCount();
    // Refresh count every 5 minutes
    setInterval(loadNewIssuesCount, 300000);
});

function loadIssueCounts() {
    // Загрузка общего количества обращений
    fetch('/get-total-issues-count', {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            const counter = document.getElementById('totalIssuesCounter');
            const countElement = counter.querySelector('.count');
            countElement.textContent = data.count || '0';
        })
        .catch(error => {
            console.error('Error fetching total issues count:', error);
            // В случае ошибки показываем 0
            const counter = document.getElementById('totalIssuesCounter');
            const countElement = counter.querySelector('.count');
            countElement.textContent = '0';
        });

    // Загрузка количества новых обращений
    fetch('/get-new-issues-count', {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            const counter = document.getElementById('newIssuesCounter');
            const countElement = counter.querySelector('.count');

            // Обновляем число и состояние бейджа
            countElement.textContent = data.count || '0';
            counter.classList.toggle('has-new', data.count > 0);
        })
        .catch(error => {
            console.error('Error fetching new issues count:', error);
        });
}

// Загрузка начальных данных и установка периодического обновления
document.addEventListener('DOMContentLoaded', function() {
    loadIssueCounts();
    // Обновление каждые 5 минут
    setInterval(loadIssueCounts, 300000);
});



// Обработчик клика для всех обращений
document.getElementById('totalIssuesCounter').addEventListener('click', function() {
    const redmineUrl = 'https://quality.teztour.com/projects/quality/issues?set_filter=1&%5Bcolumn_names%5D%5B%5D=id&%5Bcolumn_names%5D%5B%5D=easy_email_to&%5Bcolumn_names%5D%5B%5D=created_on&%5Bcolumn_names%5D%5B%5D=subject&%5Bcolumn_names%5D%5B%5D=status&%5Bcolumn_names%5D%5B%5D=priority&%5Bcolumn_names%5D%5B%5D=assigned_to&%5Bcolumn_names%5D%5B%5D=easy_closed_by&%5Bcolumn_names%5D%5B%5D=closed_on&group_by%5B%5D=&show_sum_row=0&show_sum_row=0&load_groups_opened=0&show_avatars=0&show_avatars=1&type=EasyIssueQuery&outputs%5B%5D=list&&';
    window.open(redmineUrl, '_blank');
});

// Храним предыдущее значение счетчика
let previousCount = 0;

// Функция для проверки новых обращений
function checkNewIssues() {
    fetch('/get-new-issues-count', {
        method: 'GET',
        headers: {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            const counter = document.getElementById('newIssuesCounter');
            const countElement = counter.querySelector('.count');
            const currentCount = data.count || 0;

            // Обновляем число и состояние бейджа
            countElement.textContent = currentCount;
            counter.classList.toggle('has-new', currentCount > 0);

            // Проверяем, увеличилось ли количество новых обращений для уведомления
            if (currentCount > previousCount) {
                const newIssuesCount = currentCount - previousCount;
                notifyNewIssues(newIssuesCount);
            }

            // Обновляем предыдущее значение
            previousCount = currentCount;
        })
        .catch(error => {
            console.error('Error checking new issues:', error);
        });
}

// Функция для отправки уведомлений
async function notifyNewIssues(count) {
    // Проигрываем звуковое уведомление
    playNotificationSound();

    // Проверяем поддержку и разрешение на уведомления
    if ('Notification' in window) {
        const permission = await Notification.requestPermission();

        if (permission === 'granted') {
            const title = 'Новые обращения';
            const options = {
                body: `Поступило ${pluralize(count, 'новое обращение', 'новых обращения', 'новых обращений')}`,  // Исправлено дублирование
                icon: '/static/img/notification_icon.png',
                tag: 'new-issues',
                renotify: true
            };

            const notification = new Notification(title, options);

            notification.onclick = function() {
                window.focus();
                const redmineUrl = 'https://quality.teztour.com/projects/quality/issues?set_filter=1&f%5Bstatus_id%5D=%3D1';
                window.open(redmineUrl, '_blank');
                notification.close();
            };
        }
    }
}

// Функция для воспроизведения звука
function playNotificationSound() {
    const audio = new Audio('/static/sounds/notification.mp3');
    audio.volume = 0.5; // Устанавливаем громкость на 50%

    // Проигрываем звук только если вкладка не активна
    if (document.visibilityState === 'hidden') {
        audio.play().catch(e => console.log('Audio play failed:', e));
    }
}

// Вспомогательная функция для склонения слов
function pluralize(count, one, two, five) {
    const cases = [2, 0, 1, 1, 1, 2];
    const isSpecialCase = (count % 100 > 4 && count % 100 < 20);
    const tempIndex = (count % 10 < 5) ? count % 10 : 5;
    const caseIndex = isSpecialCase ? 2 : cases[tempIndex];
    return `${count} ${[one, two, five][caseIndex]}`;
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Запрашиваем разрешение на уведомления при загрузке
    if ('Notification' in window) {
        Notification.requestPermission();
    }

    // Первоначальная проверка
    checkNewIssues();

    // Запуск периодической проверки каждые 3 минуты
    const pollInterval = 180000;
    setInterval(checkNewIssues, pollInterval);

    // Проверка при возвращении на вкладку
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'visible') {
            checkNewIssues();
        }
    });
});

// Добавьте эту функцию сразу после функции updateCommentNotifications
function setupMarkAsReadHandlers() {
    document.querySelectorAll('.mark-read-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const journalId = this.dataset.id;
            if (!journalId) {
                console.error('ID уведомления не найден');
                return;
            }

            fetch(`/mark-comment-read/${journalId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Удаляем уведомление из списка
                    const notificationItem = this.closest('.notification-item');
                    if (notificationItem) {
                        notificationItem.remove();
                    }

                    // Обновляем счетчики
                    previousCommentCount = Math.max(0, previousCommentCount - 1);
                    updateCommentNotifications();
                }
            })
            .catch(error => console.error('Ошибка:', error));
        });
    });
}

// Также нужно добавить функцию notifyNewComments, которая используется в updateCommentNotifications
async function notifyNewComments(count) {
    // Проверяем разрешения перед отправкой уведомления
    const hasPermission = await checkNotificationPermission();

    if (!hasPermission) {
        console.log('Нет разрешения на отправку уведомлений');
        return;
    }

    try {
        // Проигрываем звук только если вкладка не активна
        if (document.visibilityState === 'hidden') {
            const audio = new Audio('/static/sounds/notification.mp3');
            audio.volume = 0.5;
            await audio.play().catch(e => console.log('Воспроизведение звука недоступно:', e));
        }

        const notification = new Notification('Новые комментарии', {
            body: `Получено ${pluralize(count, 'новый комментарий', 'новых комментария', 'новых комментариев')}`,
            icon: '/static/img/notification_icon.png',
            tag: 'new-comments',
            renotify: true
        });

        notification.onclick = function() {
            window.focus();
            document.getElementById('comment-sidebar').classList.add('active');
            updateCommentNotifications();
            this.close();
        };
    } catch (error) {
        console.error('Ошибка при отправке уведомления:', error);
    }
}

// И функция для проверки разрешений
async function checkNotificationPermission() {
    if (!('Notification' in window)) {
        console.log('Браузер не поддерживает уведомления');
        return false;
    }

    if (Notification.permission === 'denied') {
        console.log('Уведомления заблокированы пользователем');
        return false;
    }

    if (Notification.permission === 'default') {
        try {
            const permission = await Notification.requestPermission();
            return permission === 'granted';
        } catch (error) {
            console.error('Ошибка при запросе разрешений:', error);
            return false;
        }
    }

    return Notification.permission === 'granted';
}

// Функция для склонения слов
function pluralize(count, one, two, five) {
    const cases = [2, 0, 1, 1, 1, 2];
    const isSpecialCase = (count % 100 > 4 && count % 100 < 20);
    const tempIndex = (count % 10 < 5) ? count % 10 : 5;
    const caseIndex = isSpecialCase ? 2 : cases[tempIndex];
    return `${count} ${[one, two, five][caseIndex]}`;
}

// Обновление функции опроса
function startNotificationsPolling() {
    setInterval(() => {
        fetch('/comment-notifications')
            .then(handleResponse)
            .then(updateNotifications)
            .catch(handlePollingError);
    }, 300000); // 5 минут
}

function updateNotifications(data) {
    if (data.error) {
        showErrorAlert('Ошибка уведомлений', data.error);
        return;
    }

    const container = document.getElementById('comment-notifications');
    const badge = document.getElementById('comment-badge');

    if (container) {
        container.innerHTML = data.html;
        animateNotifications();
    }

    if (badge) {
        badge.textContent = data.count > 0 ? data.count : '';
        badge.classList.toggle('active', data.count > 0);
    }
}

function animateNotifications() {
    document.querySelectorAll('.notification-item').forEach((item, index) => {
        setTimeout(() => {
            item.style.opacity = 1;
            item.style.transform = 'translateY(0)';
        }, index * 100);
    });
}

// Добавить после существующего кода updateCommentNotifications
document.querySelector('.close-sidebar').addEventListener('click', () => {
    document.getElementById('comment-sidebar').classList.remove('active');
});

// Показывать сайдбар при наличии новых комментариев
function showCommentSidebar(count) {
    if (count > 0) {
        document.getElementById('comment-sidebar').classList.add('active');
    }
}



document.getElementById('showCommentSidebar').addEventListener('click', () => {
    document.getElementById('comment-sidebar').classList.add('active');
});

// Добавьте этот код после функции updateCommentNotifications
document.addEventListener('DOMContentLoaded', function() {
    // Инициализация панели комментариев
    updateCommentNotifications();

    // Обработчик для кнопок "отметить как прочитанное"
    document.getElementById('comment-notifications').addEventListener('click', function(e) {
        if (e.target.closest('.mark-read-btn')) {
            const btn = e.target.closest('.mark-read-btn');
            const journalId = btn.dataset.id;

            if (!journalId) {
                console.error('ID уведомления не найден');
                return;
            }

            fetch(`/mark-comment-read/${journalId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Удаляем уведомление из списка
                    btn.closest('.notification-item').remove();

                    // Обновляем счетчики
                    const currentCount = parseInt(document.getElementById('comment-badge').textContent) || 0;
                    const newCount = Math.max(0, currentCount - 1);

                    // Обновляем оба бейджа
                    const badge = document.getElementById('comment-badge');
                    const floatingBadge = document.getElementById('floating-comment-badge');

                    if (newCount > 0) {
                        if (badge) {
                            badge.textContent = newCount;
                            badge.style.display = 'inline-block';
                        }
                        if (floatingBadge) {
                            floatingBadge.textContent = newCount;
                            floatingBadge.style.display = 'inline-block';
                        }
                    } else {
                        // Бейджи должны оставаться видимыми, только обновляем текст на "0"
                        if (badge) {
                            badge.textContent = '0';
                            badge.style.display = 'inline-block';
                        }
                        if (floatingBadge) {
                            floatingBadge.textContent = '0';
                            floatingBadge.style.display = 'inline-block';
                        }
                        // Если уведомлений больше нет, показываем сообщение
                        const container = document.getElementById('comment-notifications');
                        // Сохраняем потенциально важные элементы
                        const importantElements = Array.from(container.querySelectorAll('.important-element'));
                        container.innerHTML = '<div class="no-notifications">Нет новых комментариев</div>';
                        // Возвращаем важные элементы
                        importantElements.forEach(el => container.appendChild(el));
                    }
                }
            })
            .catch(error => console.error('Ошибка:', error));
        }
    });

    // Обработчик кнопки показа сайдбара
    document.getElementById('showCommentSidebar').addEventListener('click', () => {
        document.getElementById('comment-sidebar').classList.add('active');
        updateCommentNotifications();
    });

    // Периодическое обновление
    setInterval(updateCommentNotifications, 30000);
});

// Функция для инициализации уведомлений
async function initializeNotifications() {
    if (!('Notification' in window)) {
        console.log('Браузер не поддерживает уведомления');
        return;
    }

    try {
        const permission = await Notification.requestPermission();
        console.log('Статус разрешения уведомлений:', permission);
    } catch (error) {
        console.error('Ошибка при запросе разрешения на уведомления:', error);
    }
}

// Функция для проигрывания звука
function playCommentNotificationSound() {
    const audio = new Audio('/static/sounds/notification.mp3');
    audio.play().catch(error => {
        console.error('Ошибка воспроизведения звука:', error);
    });
}

// Инициализируем уведомления при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    initializeNotifications();
});

// Функция для проверки и обработки разрешений уведомлений
async function checkNotificationPermission() {
    if (!('Notification' in window)) {
        console.log('Браузер не поддерживает уведомления');
        return false;
    }

    // Если уведомления заблокированы, не пытаемся их запрашивать
    if (Notification.permission === 'denied') {
        console.log('Уведомления заблокированы пользователем');
        return false;
    }

    // Запрашиваем разрешение только если оно не определено
    if (Notification.permission === 'default') {
        try {
            const permission = await Notification.requestPermission();
            return permission === 'granted';
        } catch (error) {
            console.error('Ошибка при запросе разрешений:', error);
            return false;
        }
    }

    return Notification.permission === 'granted';
}

// Добавляем обработчик для кнопки очистки всех комментариев
document.getElementById('clearAllComments').addEventListener('click', function() {
    if (confirm('Вы уверены, что хотите отметить все комментарии как прочитанные?')) {
        fetch('/mark-all-comments-read', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Очищаем контейнер уведомлений
                document.getElementById('comment-notifications').innerHTML =
                    '<div class="no-notifications">Нет новых комментариев</div>';

                // Скрываем бейджи
                const badge = document.getElementById('comment-badge');
                const floatingBadge = document.getElementById('floating-comment-badge');
                if (badge) badge.style.display = 'none';
                if (floatingBadge) floatingBadge.style.display = 'none';

                // Обновляем счетчик
                previousCommentCount = 0;
            }
        })
        .catch(error => console.error('Ошибка:', error));
    }
});

document.addEventListener('DOMContentLoaded', function() {
    // Загружаем список стран для отчета
    fetch('/get-countries')
        .then(response => response.json())
        .then(countries => {
            const countrySelect = document.getElementById('countrySelect');
            countries.forEach(country => {
                const option = new Option(country, country);
                countrySelect.add(option);
            });
        })
        .catch(error => {
            console.error('Ошибка при загрузке стран:', error);
        });
});

// Функция для обновления списка новых обращений
function updateNewIssuesList() {
    fetch('/get-new-issues-list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('new-issues-container');
                if (container) {
                    container.innerHTML = data.html;
                }

                // Обновляем счетчик
                const counter = document.getElementById('newIssuesCounter');
                const countElement = counter.querySelector('.count');
                if (data.count > 0) {
                    countElement.textContent = data.count;
                    counter.classList.add('has-new');
                } else {
                    countElement.textContent = '0';
                    counter.classList.remove('has-new');
                }
            }
        })
        .catch(error => console.error('Ошибка:', error));
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    const newIssuesCounter = document.getElementById('newIssuesCounter');
    const newIssuesSidebar = document.getElementById('new-issues-sidebar');

    if (newIssuesCounter && newIssuesSidebar) {
        // Обработчик клика для новых обращений
        newIssuesCounter.addEventListener('click', function() {
            newIssuesSidebar.classList.add('active');
            updateNewIssuesList();
        });

        // Обработчик закрытия сайдбара
        const closeBtn = newIssuesSidebar.querySelector('.close-sidebar');
        if (closeBtn) {
            closeBtn.addEventListener('click', function() {
                newIssuesSidebar.classList.remove('active');
            });
        }
    }
});

// Периодическое обновление списка каждые 30 секунд
setInterval(updateNewIssuesList, 30000);

</script>

<!-- Добавляем скрипт Plotly в конец файла -->
<script src="https://cdn.plot.ly/plotly-2.27.1.min.js"></script>
{% endblock %}
