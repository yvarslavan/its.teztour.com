{% extends "layout.html" %}
{% block content %}
<div class="container mt-4">
    <h1>Диагностика push-уведомлений</h1>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Шаг 1: Проверка VAPID ключей</h5>
        </div>
        <div class="card-body">
            <button id="checkVapidKey" class="btn btn-primary mb-3">Проверить VAPID ключи</button>
            <div id="vapidKeyResult" class="alert alert-info" style="display: none;">
                <p>Статус: <span id="vapidKeyStatus">Не проверен</span></p>
                <pre id="vapidKeyData" class="mt-2">Нет данных</pre>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Шаг 2: Проверка разрешений браузера</h5>
        </div>
        <div class="card-body">
            <button id="checkPermissions" class="btn btn-primary mb-3">Проверить разрешения</button>
            <div id="permissionsResult" class="alert alert-info" style="display: none;">
                <p>Статус: <span id="permissionsStatus">Не проверен</span></p>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Шаг 3: Подписка на уведомления</h5>
        </div>
        <div class="card-body">
            <button id="subscribe" class="btn btn-primary mb-3">Подписаться</button>
            <button id="unsubscribe" class="btn btn-danger mb-3 ml-2">Отписаться</button>
            <div id="subscriptionResult" class="alert alert-info" style="display: none;">
                <p>Статус: <span id="subscriptionStatus">Не подписан</span></p>
                <pre id="subscriptionData" class="mt-2">Нет данных</pre>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Шаг 4: Текущие подписки</h5>
        </div>
        <div class="card-body">
            <button id="checkSubscriptions" class="btn btn-primary mb-3">Проверить текущие подписки</button>
            <div id="currentSubscriptionsResult" class="alert alert-info" style="display: none;">
                <p>Статус: <span id="currentSubscriptionsStatus">Не проверен</span></p>
                <pre id="currentSubscriptionsData" class="mt-2">Нет данных</pre>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Шаг 5: Тестовое уведомление</h5>
        </div>
        <div class="card-body">
            <button id="testNotification" class="btn btn-success mb-3">Отправить тестовое уведомление</button>
            <div id="testNotificationResult" class="alert alert-info" style="display: none;">
                <p>Статус: <span id="testNotificationStatus">Не отправлено</span></p>
                <pre id="testNotificationData" class="mt-2">Нет данных</pre>
            </div>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Логи</h5>
        </div>
        <div class="card-body">
            <pre id="logs" style="max-height: 300px; overflow-y: auto;"></pre>
            <button id="clearLogs" class="btn btn-secondary">Очистить логи</button>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>Отладка DOM</h5>
        </div>
        <div class="card-body">
            <button id="checkDomElements" class="btn btn-warning mb-3">Проверить DOM-элементы</button>
            <pre id="domDebugInfo" style="max-height: 300px; overflow-y: auto;"></pre>
        </div>
    </div>
</div>

<script>
    // Функция для получения CSRF-токена из мета-тега
    function getCsrfToken() {
        const metaTag = document.querySelector('meta[name="csrf-token"]');
        return metaTag ? metaTag.getAttribute('content') : '';
    }

    // Функция для безопасного получения DOM-элемента
    function safeGetElement(id) {
        const element = document.getElementById(id);
        if (!element) {
            console.error(`DOM-элемент с ID "${id}" не найден!`);
        }
        return element;
    }

    // Функция для добавления лога
    function log(message) {
        const logsElement = safeGetElement('logs');
        if (logsElement) {
            const timestamp = new Date().toLocaleTimeString();
            logsElement.innerHTML += `[${timestamp}] ${message}\n`;
            logsElement.scrollTop = logsElement.scrollHeight;
        } else {
            console.log(`[${new Date().toLocaleTimeString()}] ${message}`);
        }
    }

    // Функция для преобразования base64 в Uint8Array
    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/\-/g, '+')
            .replace(/_/g, '/');

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    // Функция для проверки DOM-элементов
    function checkDomElements() {
        const debugInfo = safeGetElement('domDebugInfo');
        if (!debugInfo) return;

        const elementsToCheck = [
            'checkVapidKey', 'vapidKeyResult', 'vapidKeyStatus', 'vapidKeyData',
            'checkPermissions', 'permissionsResult', 'permissionsStatus',
            'subscribe', 'unsubscribe', 'subscriptionResult', 'subscriptionStatus', 'subscriptionData',
            'checkSubscriptions', 'currentSubscriptionsResult', 'currentSubscriptionsStatus', 'currentSubscriptionsData',
            'testNotification', 'testNotificationResult', 'testNotificationStatus', 'testNotificationData',
            'logs', 'clearLogs', 'domDebugInfo'
        ];

        let output = 'Проверка DOM-элементов:\n\n';

        elementsToCheck.forEach(id => {
            const element = document.getElementById(id);
            output += `${id}: ${element ? 'Найден ✅' : 'НЕ НАЙДЕН ❌'}\n`;
        });

        output += '\nМета-теги:\n';
        const metaTags = document.querySelectorAll('meta');
        metaTags.forEach(tag => {
            output += `${tag.getAttribute('name') || tag.getAttribute('property') || 'без имени'}: ${tag.getAttribute('content') || 'без содержимого'}\n`;
        });

        debugInfo.textContent = output;
        console.log(output);
    }

    // Функция для восстановления отсутствующих DOM-элементов
    function ensureDomElements() {
        const container = document.querySelector('.container.mt-4');
        if (!container) {
            console.error('Контейнер .container.mt-4 не найден!');
            return false;
        }

        console.log('Восстановление DOM-элементов. Найден контейнер:', container);

        // Проверяем и восстанавливаем первый шаг - VAPID ключи
        if (!document.getElementById('vapidKeyResult')) {
            // Пробуем несколько селекторов для повышения надежности
            let card1 = null;

            // Вариант 1: По порядку
            card1 = container.querySelector('.card:first-child .card-body');

            // Вариант 2: По заголовку
            if (!card1) {
                const cardHeaders = container.querySelectorAll('.card-header');
                for (let i = 0; i < cardHeaders.length; i++) {
                    if (cardHeaders[i].textContent.includes('VAPID') ||
                        cardHeaders[i].textContent.includes('Шаг 1')) {
                        card1 = cardHeaders[i].closest('.card').querySelector('.card-body');
                        break;
                    }
                }
            }

            // Вариант 3: По кнопке
            if (!card1) {
                const checkVapidKeyBtn = document.getElementById('checkVapidKey');
                if (checkVapidKeyBtn) {
                    card1 = checkVapidKeyBtn.closest('.card-body');
                }
            }

            console.log('Поиск элемента card1 для VAPID ключей:', card1);

            if (card1) {
                const result = document.createElement('div');
                result.id = 'vapidKeyResult';
                result.className = 'alert alert-info';
                result.style.display = 'none';
                result.innerHTML = `
                    <p>Статус: <span id="vapidKeyStatus">Не проверен</span></p>
                    <pre id="vapidKeyData" class="mt-2">Нет данных</pre>
                `;
                card1.appendChild(result);
                console.log('Восстановлен элемент vapidKeyResult');
            } else {
                console.error('Не удалось найти контейнер для элемента vapidKeyResult');

                // Альтернативный метод - прямая вставка после кнопки
                const checkVapidKeyBtn = document.getElementById('checkVapidKey');
                if (checkVapidKeyBtn) {
                    console.log('Используем альтернативный метод - вставка после кнопки');

                    // Создаем результирующий блок
                    const result = document.createElement('div');
                    result.id = 'vapidKeyResult';
                    result.className = 'alert alert-info mt-3';
                    result.style.display = 'none';
                    result.innerHTML = `
                        <p>Статус: <span id="vapidKeyStatus">Не проверен</span></p>
                        <pre id="vapidKeyData" class="mt-2">Нет данных</pre>
                    `;

                    // Вставляем после кнопки
                    if (checkVapidKeyBtn.nextSibling) {
                        checkVapidKeyBtn.parentNode.insertBefore(result, checkVapidKeyBtn.nextSibling);
                    } else {
                        checkVapidKeyBtn.parentNode.appendChild(result);
                    }

                    console.log('Альтернативным методом восстановлен элемент vapidKeyResult');
                } else {
                    console.error('Не найдена кнопка checkVapidKey для альтернативного метода');
                }
            }
        }

        // Проверяем и восстанавливаем второй шаг - разрешения
        if (!document.getElementById('permissionsResult')) {
            const card2 = container.querySelector('.card:nth-child(2) .card-body');
            if (card2) {
                const result = document.createElement('div');
                result.id = 'permissionsResult';
                result.className = 'alert alert-info';
                result.style.display = 'none';
                result.innerHTML = `
                    <p>Статус: <span id="permissionsStatus">Не проверен</span></p>
                `;
                card2.appendChild(result);
                console.log('Восстановлен элемент permissionsResult');
            }
        }

        // Проверяем и восстанавливаем третий шаг - подписка
        if (!document.getElementById('subscriptionResult')) {
            const card3 = container.querySelector('.card:nth-child(3) .card-body');
            if (card3) {
                const result = document.createElement('div');
                result.id = 'subscriptionResult';
                result.className = 'alert alert-info';
                result.style.display = 'none';
                result.innerHTML = `
                    <p>Статус: <span id="subscriptionStatus">Не подписан</span></p>
                    <pre id="subscriptionData" class="mt-2">Нет данных</pre>
                `;
                card3.appendChild(result);
                console.log('Восстановлен элемент subscriptionResult');
            }
        }

        // Проверяем и восстанавливаем четвертый шаг - текущие подписки
        if (!document.getElementById('currentSubscriptionsResult')) {
            const card4 = container.querySelector('.card:nth-child(4) .card-body');
            if (card4) {
                const result = document.createElement('div');
                result.id = 'currentSubscriptionsResult';
                result.className = 'alert alert-info';
                result.style.display = 'none';
                result.innerHTML = `
                    <p>Статус: <span id="currentSubscriptionsStatus">Не проверен</span></p>
                    <pre id="currentSubscriptionsData" class="mt-2">Нет данных</pre>
                `;
                card4.appendChild(result);
                console.log('Восстановлен элемент currentSubscriptionsResult');
            }
        }

        // Проверяем и восстанавливаем пятый шаг - тестовое уведомление
        if (!document.getElementById('testNotificationResult')) {
            const card5 = container.querySelector('.card:nth-child(5) .card-body');
            if (card5) {
                const result = document.createElement('div');
                result.id = 'testNotificationResult';
                result.className = 'alert alert-info';
                result.style.display = 'none';
                result.innerHTML = `
                    <p>Статус: <span id="testNotificationStatus">Не отправлено</span></p>
                    <pre id="testNotificationData" class="mt-2">Нет данных</pre>
                `;
                card5.appendChild(result);
                console.log('Восстановлен элемент testNotificationResult');
            }
        }

        return true;
    }

    // Инициализация элементов интерфейса
    document.addEventListener('DOMContentLoaded', function() {
        log('Страница диагностики загружена');

        // Проверяем DOM-элементы сразу при загрузке
        try {
            checkDomElements();
            log('✅ Первичная проверка DOM-элементов выполнена');
        } catch (e) {
            log('❌ Ошибка при проверке DOM-элементов: ' + e.message);
            console.error('Ошибка при проверке DOM:', e);
        }

        // Периодически проверяем наличие элементов DOM и восстанавливаем их
        setInterval(function() {
            ensureDomElements();
        }, 1000);

        // Кнопка проверки DOM-элементов
        const checkDomBtn = safeGetElement('checkDomElements');
        if (checkDomBtn) {
            checkDomBtn.addEventListener('click', function() {
                log('Выполняется проверка DOM-элементов...');
                ensureDomElements(); // Восстанавливаем элементы перед проверкой
                setTimeout(function() {
                    checkDomElements();
                    log('✅ Проверка DOM-элементов завершена');
                }, 100);
            });
        }

        // Проверка VAPID ключей
        const checkVapidKeyBtn = safeGetElement('checkVapidKey');
        if (checkVapidKeyBtn) {
            checkVapidKeyBtn.addEventListener('click', async function() {
                try {
                    log('Запрос VAPID ключа...');

                    // Проверяем и восстанавливаем DOM-элементы перед запросом
                    ensureDomElements();

                    // Повторное получение элементов после их возможного восстановления
                    const result = safeGetElement('vapidKeyResult');
                    const status = safeGetElement('vapidKeyStatus');
                    const data = safeGetElement('vapidKeyData');

                    if (!result || !status || !data) {
                        throw new Error('Необходимые DOM-элементы не найдены');
                    }

                    result.style.display = 'block';
                    status.textContent = 'Запрос...';
                    status.className = '';

                    const response = await fetch('/api/vapid-public-key');

                    if (!response.ok) {
                        throw new Error(`Ошибка запроса: ${response.status} ${response.statusText}`);
                    }

                    const responseData = await response.json();

                    if (responseData.vapid_public_key || responseData.publicKey || responseData.key) {
                        status.textContent = 'Ключ получен';
                        status.className = 'text-success';
                        data.textContent = JSON.stringify(responseData, null, 2);
                        log('✅ VAPID ключ успешно получен');
                    } else {
                        status.textContent = 'Ошибка: ключ не найден в ответе';
                        status.className = 'text-danger';
                        data.textContent = JSON.stringify(responseData, null, 2);
                        log('❌ VAPID ключ не найден в ответе');
                    }
                } catch (error) {
                    log(`❌ Ошибка при проверке VAPID ключа: ${error.message}`);

                    const result = safeGetElement('vapidKeyResult');
                    const status = safeGetElement('vapidKeyStatus');
                    const data = safeGetElement('vapidKeyData');

                    if (result) result.style.display = 'block';
                    if (status) {
                        status.textContent = 'Ошибка';
                        status.className = 'text-danger';
                    }
                    if (data) data.textContent = error.message;
                }
            });
        }

        // Проверка разрешений
        const checkPermissionsBtn = safeGetElement('checkPermissions');
        if (checkPermissionsBtn) {
            checkPermissionsBtn.addEventListener('click', async function() {
                try {
                    log('Проверка разрешений браузера...');
                    const result = safeGetElement('permissionsResult');
                    const status = safeGetElement('permissionsStatus');

                    if (!result || !status) {
                        throw new Error('Необходимые DOM-элементы не найдены');
                    }

                    result.style.display = 'block';
                    status.textContent = 'Проверка...';
                    status.className = '';

                    if (!('Notification' in window)) {
                        status.textContent = 'Уведомления не поддерживаются этим браузером';
                        status.className = 'text-danger';
                        log('❌ Браузер не поддерживает уведомления');
                        return;
                    }

                    const permission = Notification.permission;

                    if (permission === 'granted') {
                        status.textContent = 'Разрешено';
                        status.className = 'text-success';
                        log('✅ Разрешения для уведомлений предоставлены');
                    } else if (permission === 'denied') {
                        status.textContent = 'Запрещено';
                        status.className = 'text-danger';
                        log('❌ Разрешения для уведомлений запрещены пользователем');
                    } else {
                        status.textContent = 'Не запрошено';
                        status.className = 'text-warning';
                        log('⚠️ Разрешения для уведомлений не запрошены');

                        // Запрашиваем разрешение
                        const permissionResult = await Notification.requestPermission();

                        if (permissionResult === 'granted') {
                            status.textContent = 'Разрешено (только что получено)';
                            status.className = 'text-success';
                            log('✅ Разрешения для уведомлений получены');
                        } else {
                            status.textContent = `Не получено (${permissionResult})`;
                            status.className = 'text-danger';
                            log(`❌ Не удалось получить разрешения: ${permissionResult}`);
                        }
                    }
                } catch (error) {
                    log(`❌ Ошибка при проверке разрешений: ${error.message}`);

                    const result = safeGetElement('permissionsResult');
                    const status = safeGetElement('permissionsStatus');

                    if (result) result.style.display = 'block';
                    if (status) {
                        status.textContent = `Ошибка: ${error.message}`;
                        status.className = 'text-danger';
                    }
                }
            });
        }

        // Подписка на уведомления
        const subscribeBtn = safeGetElement('subscribe');
        if (subscribeBtn) {
            subscribeBtn.addEventListener('click', async function() {
                try {
                    log('Подписка на push-уведомления...');
                    const result = safeGetElement('subscriptionResult');
                    const status = safeGetElement('subscriptionStatus');
                    const data = safeGetElement('subscriptionData');

                    if (!result || !status || !data) {
                        throw new Error('Необходимые DOM-элементы не найдены');
                    }

                    result.style.display = 'block';
                    status.textContent = 'Подписка...';
                    status.className = '';

                    // Проверяем поддержку service worker
                    if (!('serviceWorker' in navigator)) {
                        throw new Error('Service Workers не поддерживаются');
                    }

                    // Получаем VAPID ключ
                    const vapidResponse = await fetch('/api/vapid-public-key');
                    if (!vapidResponse.ok) {
                        throw new Error('Не удалось получить VAPID ключ');
                    }

                    const vapidData = await vapidResponse.json();
                    const vapidKey = vapidData.vapid_public_key || vapidData.publicKey || vapidData.key;

                    if (!vapidKey) {
                        throw new Error('VAPID ключ пустой или отсутствует в ответе');
                    }

                    log(`VAPID ключ получен: ${vapidKey.substring(0, 10)}...`);

                    // Регистрируем Service Worker
                    const swRegistration = await navigator.serviceWorker.register('/sw.js');
                    log('Service Worker зарегистрирован');

                    // Конвертируем VAPID ключ
                    const convertedVapidKey = urlBase64ToUint8Array(vapidKey);

                    // Запрашиваем подписку
                    const pushSubscription = await swRegistration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: convertedVapidKey
                    });

                    log('Получена подписка от браузера');

                    // Отправляем подписку на сервер
                    const response = await fetch('/api/push/subscribe', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({
                            subscription: pushSubscription.toJSON()
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Ошибка сервера: ${response.status}`);
                    }

                    const responseData = await response.json();

                    status.textContent = 'Подписка активна';
                    status.className = 'text-success';
                    data.textContent = JSON.stringify(pushSubscription, null, 2);
                    log('✅ Подписка успешно создана и отправлена на сервер');
                } catch (error) {
                    log(`❌ Ошибка при подписке: ${error.message}`);

                    const result = safeGetElement('subscriptionResult');
                    const status = safeGetElement('subscriptionStatus');
                    const data = safeGetElement('subscriptionData');

                    if (result) result.style.display = 'block';
                    if (status) {
                        status.textContent = 'Ошибка';
                        status.className = 'text-danger';
                    }
                    if (data) data.textContent = error.message;
                }
            });
        }

        // Отписка от уведомлений
        const unsubscribeBtn = safeGetElement('unsubscribe');
        if (unsubscribeBtn) {
            unsubscribeBtn.addEventListener('click', async function() {
                try {
                    log('Отписка от push-уведомлений...');
                    const result = safeGetElement('subscriptionResult');
                    const status = safeGetElement('subscriptionStatus');
                    const data = safeGetElement('subscriptionData');

                    if (!result || !status || !data) {
                        throw new Error('Необходимые DOM-элементы не найдены');
                    }

                    result.style.display = 'block';
                    status.textContent = 'Отписка...';
                    status.className = '';

                    // Проверяем поддержку service worker
                    if (!('serviceWorker' in navigator)) {
                        throw new Error('Service Workers не поддерживаются');
                    }

                    // Получаем регистрацию Service Worker
                    const swRegistration = await navigator.serviceWorker.getRegistration();

                    if (!swRegistration) {
                        throw new Error('Service Worker не зарегистрирован');
                    }

                    // Получаем текущую подписку
                    const subscription = await swRegistration.pushManager.getSubscription();

                    if (!subscription) {
                        throw new Error('Нет активной подписки');
                    }

                    // Отписываемся на стороне браузера
                    const unsubscribeResult = await subscription.unsubscribe();

                    if (!unsubscribeResult) {
                        throw new Error('Не удалось отписаться на стороне браузера');
                    }

                    log('Отписка на стороне браузера выполнена');

                    // Отправляем запрос на отписку на сервер
                    const endpoint = subscription.endpoint;

                    const response = await fetch('/api/push/unsubscribe', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({
                            endpoint: endpoint
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Ошибка сервера: ${response.status}`);
                    }

                    const responseData = await response.json();

                    status.textContent = 'Успешно отписан';
                    status.className = 'text-success';
                    data.textContent = 'Подписка удалена';
                    log('✅ Успешно отписан от push-уведомлений');
                } catch (error) {
                    log(`❌ Ошибка при отписке: ${error.message}`);

                    const result = safeGetElement('subscriptionResult');
                    const status = safeGetElement('subscriptionStatus');
                    const data = safeGetElement('subscriptionData');

                    if (result) result.style.display = 'block';
                    if (status) {
                        status.textContent = 'Ошибка';
                        status.className = 'text-danger';
                    }
                    if (data) data.textContent = error.message;
                }
            });
        }

        // Проверка текущих подписок на сервере
        const checkSubscriptionsBtn = safeGetElement('checkSubscriptions');
        if (checkSubscriptionsBtn) {
            checkSubscriptionsBtn.addEventListener('click', async function() {
                try {
                    log('Проверка текущих подписок на сервере...');
                    const result = safeGetElement('currentSubscriptionsResult');
                    const status = safeGetElement('currentSubscriptionsStatus');
                    const data = safeGetElement('currentSubscriptionsData');

                    if (!result || !status || !data) {
                        throw new Error('Необходимые DOM-элементы не найдены');
                    }

                    result.style.display = 'block';
                    status.textContent = 'Запрос...';
                    status.className = '';

                    const response = await fetch('/push-debug');

                    if (!response.ok) {
                        throw new Error(`Ошибка запроса: ${response.status} ${response.statusText}`);
                    }

                    const responseData = await response.json();

                    if (responseData.success) {
                        status.textContent = 'Данные получены';
                        status.className = 'text-success';
                        data.textContent = JSON.stringify(responseData, null, 2);

                        const subscriptions = responseData.subscriptions || [];
                        const activeCount = subscriptions.filter(s => s.is_active).length;

                        log(`✅ Получены данные о подписках. Всего: ${subscriptions.length}, активных: ${activeCount}`);
                    } else {
                        status.textContent = 'Ошибка';
                        status.className = 'text-danger';
                        data.textContent = JSON.stringify(responseData, null, 2);
                        log(`❌ Ошибка при получении данных: ${responseData.error || 'Неизвестная ошибка'}`);
                    }
                } catch (error) {
                    log(`❌ Ошибка при проверке подписок: ${error.message}`);

                    const result = safeGetElement('currentSubscriptionsResult');
                    const status = safeGetElement('currentSubscriptionsStatus');
                    const data = safeGetElement('currentSubscriptionsData');

                    if (result) result.style.display = 'block';
                    if (status) {
                        status.textContent = 'Ошибка';
                        status.className = 'text-danger';
                    }
                    if (data) data.textContent = error.message;
                }
            });
        }

        // Отправка тестового уведомления
        const testNotificationBtn = safeGetElement('testNotification');
        if (testNotificationBtn) {
            testNotificationBtn.addEventListener('click', async function() {
                try {
                    log('Отправка тестового push-уведомления...');
                    const result = safeGetElement('testNotificationResult');
                    const status = safeGetElement('testNotificationStatus');
                    const data = safeGetElement('testNotificationData');

                    if (!result || !status || !data) {
                        throw new Error('Необходимые DOM-элементы не найдены');
                    }

                    result.style.display = 'block';
                    status.textContent = 'Отправка...';
                    status.className = '';

                    const response = await fetch('/api/push/test', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        }
                    });

                    const responseData = await response.json();

                    if (response.ok || response.status === 207) {
                        status.textContent = 'Уведомление отправлено';
                        status.className = 'text-success';
                        data.textContent = JSON.stringify(responseData, null, 2);
                        log(`✅ Тестовое уведомление отправлено. Успешно: ${responseData.successful_sends || 0}/${responseData.total_attempts || 0}`);
                    } else {
                        status.textContent = 'Ошибка';
                        status.className = 'text-danger';
                        data.textContent = JSON.stringify(responseData, null, 2);
                        log(`❌ Ошибка при отправке: ${responseData.error || 'Неизвестная ошибка'}`);
                    }
                } catch (error) {
                    log(`❌ Ошибка при отправке тестового уведомления: ${error.message}`);

                    const result = safeGetElement('testNotificationResult');
                    const status = safeGetElement('testNotificationStatus');
                    const data = safeGetElement('testNotificationData');

                    if (result) result.style.display = 'block';
                    if (status) {
                        status.textContent = 'Ошибка';
                        status.className = 'text-danger';
                    }
                    if (data) data.textContent = error.message;
                }
            });
        }

        // Очистка логов
        const clearLogsBtn = safeGetElement('clearLogs');
        if (clearLogsBtn) {
            clearLogsBtn.addEventListener('click', function() {
                const logsElement = safeGetElement('logs');
                if (logsElement) {
                    logsElement.innerHTML = '';
                    log('Логи очищены');
                }
            });
        }
    });
</script>
{% endblock %}
