<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Тест Push-уведомлений</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        #log {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>Тестирование Push-уведомлений</h1>

    <div id="status" class="status info">Инициализация...</div>

    <div>
        <button id="checkPermission" onclick="checkPermission()">Проверить разрешения</button>
        <button id="subscribeBtn" onclick="subscribeToPush()" disabled>Подписаться</button>
        <button id="unsubscribeBtn" onclick="unsubscribeFromPush()" disabled>Отписаться</button>
        <button id="testBtn" onclick="sendTestNotification()" disabled>Отправить тест</button>
    </div>

    <h3>Лог событий:</h3>
    <div id="log"></div>

    <script>
        // Глобальные переменные
        let swRegistration = null;
        let vapidPublicKey = null;

        // Функция логирования
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.innerHTML = `[${timestamp}] <span style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'}">${message}</span>`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // Функция обновления статуса
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        // Проверка поддержки Push API
        function checkPushSupport() {
            if (!('serviceWorker' in navigator)) {
                log('Service Worker не поддерживается браузером', 'error');
                updateStatus('Service Worker не поддерживается', 'error');
                return false;
            }

            if (!('PushManager' in window)) {
                log('Push API не поддерживается браузером', 'error');
                updateStatus('Push API не поддерживается', 'error');
                return false;
            }

            if (!('Notification' in window)) {
                log('Notification API не поддерживается браузером', 'error');
                updateStatus('Notification API не поддерживается', 'error');
                return false;
            }

            log('Все необходимые API поддерживаются', 'success');
            return true;
        }

        // Проверка разрешений
        async function checkPermission() {
            log('Проверка разрешений на уведомления...');

            const permission = Notification.permission;
            log(`Текущий статус разрешений: ${permission}`);

            if (permission === 'default') {
                log('Запрашиваем разрешение у пользователя...');
                const result = await Notification.requestPermission();
                log(`Результат запроса разрешения: ${result}`);

                if (result === 'granted') {
                    updateStatus('Разрешение на уведомления получено', 'success');
                    document.getElementById('subscribeBtn').disabled = false;
                } else {
                    updateStatus('Разрешение на уведомления отклонено', 'error');
                }
            } else if (permission === 'granted') {
                updateStatus('Разрешение на уведомления уже получено', 'success');
                document.getElementById('subscribeBtn').disabled = false;
            } else {
                updateStatus('Уведомления заблокированы', 'error');
            }

            return permission;
        }

        // Получение VAPID ключа
        async function getVapidKey() {
            try {
                log('Получение VAPID публичного ключа...');
                const response = await fetch('/api/vapid-public-key');
                const data = await response.json();

                if (data.publicKey) {
                    vapidPublicKey = data.publicKey;
                    log(`VAPID ключ получен: ${vapidPublicKey.substring(0, 20)}...`, 'success');
                    return vapidPublicKey;
                } else {
                    throw new Error('VAPID ключ не найден в ответе');
                }
            } catch (error) {
                log(`Ошибка получения VAPID ключа: ${error.message}`, 'error');
                throw error;
            }
        }

        // Регистрация Service Worker
        async function registerServiceWorker() {
            try {
                log('Регистрация Service Worker...');
                swRegistration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
                log('Service Worker зарегистрирован', 'success');

                // Ждем активации
                if (swRegistration.active) {
                    log('Service Worker уже активен', 'success');
                } else {
                    log('Ожидание активации Service Worker...');
                    await navigator.serviceWorker.ready;
                    log('Service Worker активирован', 'success');
                }

                return swRegistration;
            } catch (error) {
                log(`Ошибка регистрации Service Worker: ${error.message}`, 'error');
                throw error;
            }
        }

        // Подписка на push-уведомления
        async function subscribeToPush() {
            try {
                log('Начало процесса подписки...');
                updateStatus('Подписка на уведомления...', 'info');

                // Проверяем текущую подписку
                const existingSubscription = await swRegistration.pushManager.getSubscription();
                if (existingSubscription) {
                    log('Найдена существующая подписка, отписываемся...');
                    await existingSubscription.unsubscribe();
                }

                // Создаем новую подписку
                log('Создание новой подписки...');
                const subscription = await swRegistration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                });

                log('Подписка создана, отправка на сервер...');
                log(`Endpoint: ${subscription.endpoint.substring(0, 70)}...`);

                // Отправляем подписку на сервер
                const response = await fetch('/api/push/subscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ subscription: subscription.toJSON() })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    log('Подписка успешно сохранена на сервере', 'success');
                    updateStatus('Подписка активна', 'success');
                    document.getElementById('subscribeBtn').disabled = true;
                    document.getElementById('unsubscribeBtn').disabled = false;
                    document.getElementById('testBtn').disabled = false;
                } else {
                    throw new Error(result.error || 'Ошибка сохранения подписки');
                }

            } catch (error) {
                log(`Ошибка подписки: ${error.message}`, 'error');
                updateStatus('Ошибка подписки', 'error');
            }
        }

        // Отписка от push-уведомлений
        async function unsubscribeFromPush() {
            try {
                log('Начало процесса отписки...');
                updateStatus('Отписка от уведомлений...', 'info');

                const subscription = await swRegistration.pushManager.getSubscription();
                if (!subscription) {
                    log('Подписка не найдена');
                    updateStatus('Подписка не найдена', 'error');
                    return;
                }

                // Отписываемся
                await subscription.unsubscribe();
                log('Отписка выполнена локально');

                // Уведомляем сервер
                const response = await fetch('/api/push/unsubscribe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ endpoint: subscription.endpoint })
                });

                if (response.ok) {
                    log('Отписка подтверждена сервером', 'success');
                    updateStatus('Отписка выполнена', 'success');
                    document.getElementById('subscribeBtn').disabled = false;
                    document.getElementById('unsubscribeBtn').disabled = true;
                    document.getElementById('testBtn').disabled = true;
                } else {
                    throw new Error('Ошибка отписки на сервере');
                }

            } catch (error) {
                log(`Ошибка отписки: ${error.message}`, 'error');
                updateStatus('Ошибка отписки', 'error');
            }
        }

        // Отправка тестового уведомления
        async function sendTestNotification() {
            try {
                log('Отправка запроса на тестовое уведомление...');
                updateStatus('Отправка тестового уведомления...', 'info');

                const response = await fetch('/api/push/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();
                log(`Ответ от сервера: статус ${response.status}, тело: ${JSON.stringify(result)}`);

                // Проверяем статус ответа (200 OK или 207 Multi-Status)
                if (response.ok || response.status === 207) {
                    let message = result.message || 'Тестовое уведомление обработано.';
                    let statusType = 'info';

                    if (result.hasOwnProperty('successful_sends') && result.hasOwnProperty('total_attempts')) {
                        message = `Отправлено: ${result.successful_sends}/${result.total_attempts}. ${result.message || ''}`;
                        if (result.successful_sends === result.total_attempts && result.total_attempts > 0) {
                            statusType = 'success';
                            log('Тестовое уведомление успешно отправлено на все подписки.', 'success');
                            updateStatus('Тестовое уведомление отправлено! (все успешно)', 'success');
                        } else if (result.successful_sends > 0) {
                            statusType = 'success'; // Частичный успех - все равно показываем как успех в UI
                            log(`Тестовое уведомление отправлено частично: ${result.successful_sends}/${result.total_attempts}.`, 'success');
                            updateStatus(`Тестовое уведомление отправлено! (частично: ${result.successful_sends}/${result.total_attempts})`, 'success');
                        } else if (result.total_attempts > 0) {
                            statusType = 'error';
                            log(`Не удалось отправить тестовое уведомление ни на одну из ${result.total_attempts} подписок.`, 'error');
                            updateStatus(`Ошибка: Не удалось отправить ни на одну из ${result.total_attempts} подписок.`, 'error');
                        } else { // total_attempts = 0
                             statusType = 'warning';
                             log('Нет активных подписок для отправки тестового уведомления.', 'warning');
                             updateStatus('Нет активных подписок для теста.', 'warning');
                        }
                    } else if (response.ok && result.success) { // Для старых версий ответа или общих успехов
                        statusType = 'success';
                        log('Тестовое уведомление отправлено (старый формат ответа)', 'success');
                        updateStatus('Тестовое уведомление отправлено!', 'success');
                    } else {
                        // Если successful_sends/total_attempts отсутствуют, но статус 200/207,
                        // и нет result.success, это может быть странный случай.
                        // Используем общее сообщение из result.message или стандартное.
                        log(`Тестовое уведомление обработано сервером: ${message}`, response.ok ? 'success' : 'info');
                        updateStatus(message, response.ok ? 'success' : 'info');
                    }
                } else {
                    // Обработка явных ошибок сервера (не 200 и не 207)
                    const errorMessage = result.error || result.message || 'Неизвестная ошибка отправки';
                    log(`Ошибка отправки тестового уведомления: ${errorMessage} (Статус: ${response.status})`, 'error');
                    updateStatus(`Ошибка: ${errorMessage}`, 'error');
                    // throw new Error(errorMessage); // Можно раскомментировать, если нужно прерывать выполнение
                }

            } catch (error) {
                log(`Ошибка отправки тестового уведомления: ${error.message}`, 'error');
                updateStatus('Ошибка отправки', 'error');
            }
        }

        // Вспомогательная функция для преобразования base64
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        // Инициализация при загрузке страницы
        async function init() {
            log('Инициализация страницы тестирования...');

            // Проверяем поддержку API
            if (!checkPushSupport()) {
                return;
            }

            try {
                // Получаем VAPID ключ
                await getVapidKey();

                // Регистрируем Service Worker
                await registerServiceWorker();

                // Проверяем разрешения
                const permission = await checkPermission();

                // Проверяем текущую подписку
                const subscription = await swRegistration.pushManager.getSubscription();
                if (subscription) {
                    log('Найдена активная подписка', 'success');
                    updateStatus('Подписка активна', 'success');
                    document.getElementById('subscribeBtn').disabled = true;
                    document.getElementById('unsubscribeBtn').disabled = false;
                    document.getElementById('testBtn').disabled = false;
                } else {
                    log('Активная подписка не найдена');
                    if (permission === 'granted') {
                        document.getElementById('subscribeBtn').disabled = false;
                    }
                }

            } catch (error) {
                log(`Ошибка инициализации: ${error.message}`, 'error');
                updateStatus('Ошибка инициализации', 'error');
            }
        }

        // Запуск инициализации
        window.addEventListener('load', init);
    </script>
</body>
</html>
