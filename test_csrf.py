#!/usr/bin/env python3
"""
–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–±–æ—Ç—ã CSRF
–ó–∞–ø—É—Å–∫–∞–π—Ç–µ –∏–∑ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞: /opt/www/its.teztour.com/
"""

import os
import sys
import requests
from pathlib import Path

# –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Ç—å –∫ –ø—Ä–æ–µ–∫—Ç—É
BASE_DIR = Path(__file__).resolve().parent
sys.path.insert(0, str(BASE_DIR))

print("üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CSRF –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≤—Ö–æ–¥–∞...")

try:
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    if os.path.exists('.env.production'):
        from dotenv import load_dotenv
        load_dotenv('.env.production')
        print("‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω .env.production")

    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç Flask
    from blog import create_app
    app = create_app()

    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç
    client = app.test_client()

    with app.app_context():
        # –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞
        print("üìÑ –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞...")
        response = client.get('/login')

        if response.status_code == 200:
            print("‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞")

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è CSRF (generated by form.hidden_tag())
            if b'name="csrf_token"' in response.data:
                print("‚úÖ –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ CSRF —Ç–æ–∫–µ–Ω–∞ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ñ–æ—Ä–º–µ")
            else:
                print("‚ùå –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ CSRF —Ç–æ–∫–µ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ —Ñ–æ—Ä–º–µ")

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–µ–≥–∞ meta —Å CSRF —Ç–æ–∫–µ–Ω–æ–º
            if b'csrf-token' in response.data:
                print("‚úÖ Meta —Ç–µ–≥ —Å CSRF —Ç–æ–∫–µ–Ω–æ–º –Ω–∞–π–¥–µ–Ω")
            else:
                print("‚ùå Meta —Ç–µ–≥ —Å CSRF —Ç–æ–∫–µ–Ω–æ–º –Ω–µ –Ω–∞–π–¥–µ–Ω")

            # –ò–∑–≤–ª–µ–∫–∞–µ–º CSRF —Ç–æ–∫–µ–Ω –∏–∑ —Ñ–æ—Ä–º—ã –¥–ª—è —Ç–µ—Å—Ç–∞
            import re
            from flask_wtf.csrf import generate_csrf

            # –ù–∞—Ö–æ–¥–∏–º CSRF —Ç–æ–∫–µ–Ω –≤ —Ñ–æ—Ä–º–µ (form.hidden_tag() –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ)
            csrf_match = re.search(rb'name="csrf_token" type="hidden" value="([^"]+)"', response.data)
            if csrf_match:
                form_csrf_token = csrf_match.group(1).decode('utf-8')
                print(f"üîç CSRF —Ç–æ–∫–µ–Ω –∏–∑ —Ñ–æ—Ä–º—ã: {form_csrf_token}")
            else:
                # –ü—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞ CSRF —Ç–æ–∫–µ–Ω–∞
                csrf_match = re.search(rb'name="csrf_token" value="([^"]+)"', response.data)
                if csrf_match:
                    form_csrf_token = csrf_match.group(1).decode('utf-8')
                    print(f"üîç CSRF —Ç–æ–∫–µ–Ω –∏–∑ —Ñ–æ—Ä–º—ã (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ–∏—Å–∫): {form_csrf_token}")
                else:
                    print("‚ùå CSRF —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ñ–æ—Ä–º–µ")
                    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ç–æ–∫–µ–Ω –∏ –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–ª—è–µ–º –≤ —Å–µ—Å—Å–∏—é
                    form_csrf_token = generate_csrf()
                    print(f"üîç –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π CSRF —Ç–æ–∫–µ–Ω: {form_csrf_token}")

            # Flask-WTF —Ö—Ä–∞–Ω–∏—Ç —Ç–æ–∫–µ–Ω—ã –≤ —Å–µ—Å—Å–∏–∏ –æ—Å–æ–±—ã–º –æ–±—Ä–∞–∑–æ–º
            with client.session_transaction() as sess:
                # Flask-WTF –æ–∂–∏–¥–∞–µ—Ç —Ç–æ–∫–µ–Ω –≤ —Å–µ—Å—Å–∏–∏ –±–µ–∑ –∫–∞–≤—ã—á–µ–∫
                sess['csrf_token'] = form_csrf_token
                sess.permanent = True

                print(f"üîç CSRF —Ç–æ–∫–µ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ —Å–µ—Å—Å–∏–∏: {sess.get('csrf_token')}")

            # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
            print("\nüì§ –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º CSRF —Ç–æ–∫–µ–Ω–æ–º...")

            # –î–ª—è —Ç–µ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Ç–æ–∫–µ–Ω, —á—Ç–æ –∏ –≤ —Ñ–æ—Ä–º–µ
            response = client.post('/login', data={
                'csrf_token': form_csrf_token,
                'username': 'test',
                'password': 'test',
                'remember': 'y'
            }, follow_redirects=True)

            print(f"üîç –°—Ç–∞—Ç—É—Å POST –∑–∞–ø—Ä–æ—Å–∞: {response.status_code}")
            if b'csrf' in response.data.lower():
                print("‚ùå –§–æ—Ä–º–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ —Å –æ—à–∏–±–∫–æ–π CSRF")
                # –ò—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ CSRF
                error_match = re.search(rb'CSRF.*?(?:<[^>]*>)', response.data)
                if error_match:
                    print(f"üîç –û—à–∏–±–∫–∞ CSRF: {error_match.group(0).decode('utf-8')}")
            else:
                print("‚úÖ –§–æ—Ä–º–∞ –ø—Ä–∏–Ω—è—Ç–∞ –±–µ–∑ –æ—à–∏–±–∫–∏ CSRF")

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
            print(f"üîç –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—Ç–≤–µ—Ç–∞ (–ø–µ—Ä–≤—ã–µ 200 –±–∞–π—Ç): {response.data[:200]}")

            # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ä–º—É —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
            print("\nüì§ –¢–µ—Å—Ç–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º CSRF —Ç–æ–∫–µ–Ω–æ–º...")
            response = client.post('/login', data={
                'csrf_token': 'wrong_token',
                'username': 'test',
                'password': 'test',
                'remember': 'y'
            }, follow_redirects=True)

            if b'csrf' in response.data.lower() or response.status_code == 400:
                print("‚úÖ –§–æ—Ä–º–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞ —Å –æ—à–∏–±–∫–æ–π CSRF")
            else:
                print("‚ùå –§–æ—Ä–º–∞ –ø—Ä–∏–Ω—è—Ç–∞ —Å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º CSRF —Ç–æ–∫–µ–Ω–æ–º")

        else:
            print(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –≤—Ö–æ–¥–∞: {response.status_code}")

    print("\nüéâ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ CSRF –∑–∞–≤–µ—Ä—à–µ–Ω–æ!")

except Exception as e:
    print(f"\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ CSRF: {e}")
    import traceback
    traceback.print_exc()
