# Функционал изменения статуса задачи

## Описание реализации

Реализован полный функционал для изменения статуса задачи прямо на странице детализации задачи (`/tasks/my-tasks/<task_id>`).

### Что реализовано:

1. **API endpoints**:
   - `GET /tasks/api/task/<task_id>/statuses` - получение доступных статусов для задачи
   - `PUT /tasks/api/task/<task_id>/status` - изменение статуса задачи

2. **UI/UX**:
   - Новый раздел "Управление статусом" в аккордеоне "Сведения о задаче"
   - Отображение текущего статуса задачи
   - Выпадающий список для выбора нового статуса
   - Поле для добавления комментария к изменению
   - Кнопка "Изменить статус" с подтверждением
   - Индикаторы загрузки и уведомления

3. **Функциональность**:
   - Динамическая загрузка доступных статусов
   - Валидация выбора статуса
   - Подтверждение изменения через confirm dialog
   - Обработка ошибок и отображение уведомлений
   - Автоматическое обновление страницы после изменения

## Файлы, которые были изменены/созданы:

### 1. API endpoints
- `blog/tasks/api_routes.py` - добавлены новые endpoints для работы со статусами

### 2. Frontend файлы
- `blog/static/css/task_status_change.css` - стили для интерфейса
- `blog/static/js/task_status_change.js` - JavaScript логика
- `blog/templates/task_detail.html` - модифицирован шаблон (встроены CSS и JS)

## Как использовать:

1. **Для пользователя**:
   - Перейдите на страницу детализации любой задачи
   - В аккордеоне "Сведения о задаче" найдите раздел "Управление статусом"
   - Выберите новый статус из выпадающего списка
   - При желании добавьте комментарий
   - Нажмите "Изменить статус" и подтвердите изменение

2. **Для разработчика**:
   - Убедитесь, что все файлы на месте
   - Проверьте, что blueprint `tasks_api` подключен в приложении
   - Убедитесь, что пользователь имеет права на изменение статуса в Redmine

## Технические детали:

### API запросы:
```javascript
// Получение доступных статусов
GET /tasks/api/task/{task_id}/statuses

// Изменение статуса
PUT /tasks/api/task/{task_id}/status
{
  "status_id": 5,
  "comment": "Переводим задачу в выполнение"
}
```

### Структура ответов:
```json
// Успешный ответ получения статусов
{
  "success": true,
  "current_status": {
    "id": 1,
    "name": "Новая"
  },
  "available_statuses": [
    {"id": 2, "name": "В работе"},
    {"id": 5, "name": "Закрыта"}
  ]
}

// Успешный ответ изменения статуса
{
  "success": true,
  "new_status_id": 5,
  "new_status_name": "Закрыта",
  "message": "Статус задачи успешно изменен на 'Закрыта'"
}
```

## Обработка ошибок:

- **403 Forbidden** - пользователь не имеет прав на изменение статуса
- **404 Not Found** - задача не найдена
- **422 Unprocessable Entity** - некорректные данные
- **500 Internal Server Error** - внутренняя ошибка сервера

## Безопасность:

- Проверка авторизации пользователя
- Валидация данных на стороне сервера
- Проверка прав доступа через Redmine API
- Защита от XSS через экранирование данных

## Интеграция с Redmine:

- Использует существующий Redmine REST API
- Поддерживает локализованные названия статусов из таблицы `u_statuses`
- Автоматически добавляет комментарий к изменению в историю задачи
- Совместим с workflow правилами Redmine

## Возможные улучшения:

1. **Workflow-based статусы** - получение только разрешенных переходов статусов
2. **Batch операции** - изменение статуса нескольких задач одновременно
3. **Уведомления** - отправка уведомлений исполнителям при изменении статуса
4. **Аудит** - детальное логирование изменений статусов
5. **Кастомные поля** - поддержка изменения дополнительных полей при смене статуса

## Тестирование:

Для тестирования функционала:
1. Откройте страницу любой задачи
2. Проверьте появление раздела "Управление статусом"
3. Убедитесь, что загружаются доступные статусы
4. Попробуйте изменить статус с комментарием и без
5. Проверьте обработку ошибок (например, при отсутствии прав)

## Troubleshooting:

**Проблема**: Не загружаются доступные статусы
**Решение**: Проверьте подключение к базе данных Redmine и права пользователя

**Проблема**: Ошибка при изменении статуса
**Решение**: Убедитесь, что пользователь имеет права на изменение статуса в Redmine

**Проблема**: Не отображается интерфейс
**Решение**: Проверьте, что JavaScript код выполняется без ошибок в консоли браузера
